rules_version = '2';

/* ─── Firestore ─────────────────────────────────────── */
service cloud.firestore {
  match /databases/{database}/documents {

    // AUTHORIZED USER ACCESS: Check if user email is in the authorized list
    function isAuthorized() {
      return request.auth != null && (
        request.auth.token.email == 'adam@gmail.com' ||
        request.auth.token.email == 'admin@alcowater.com' ||
        request.auth.token.email == 'adamchaabane1234@gmail.com' ||
        request.auth.token.email == 'pos@alcowater.com' ||
        request.auth.token.email == 'supervisor@alcowater.com'
      );
    }
    
    // Legacy admin UID check for backward compatibility
    function isAdmin() {
      return request.auth != null && (
        request.auth.uid == 'fQEVSsWI0DRca4h8K7uJgTwmjfv2' ||
        isAuthorized()
      );
    }
    
    // Customers collection - authorized users only
    match /customers/{customerId} {
      allow read, write: if isAuthorized();
    }

    // Locations collection - authorized users only
    match /locations/{locationId} {
      allow read, write: if isAuthorized();
    }

    // Codes collection - authorized users only
    match /codes/{codeId} {
      allow read, write: if isAuthorized();
    }

    // Settings collection - authorized users only
    match /settings/{settingId} {
      allow read, write: if isAuthorized();
    }

    // Billing cycles collection - authorized users only (for snapshot storage)
    match /billingCycles/{cycleId} {
      allow read, write: if isAuthorized();
    }

    // Payment batches - authorized users only (legacy collection name)
    match /paymentBatches/{batchId} {
      allow read, write: if isAuthorized();
    }

    // Payment processing sessions - authorized users only
    match /paymentProcessingSessions/{sessionId} {
      allow read, write: if isAuthorized();
    }

    // Users collection - authorized users only
    match /users/{userId} {
      allow read, write: if isAuthorized();

      // Allow read/write access to any subcollections
      match /{subCollection=**}/{docId} {
        allow read, write: if isAuthorized();
      }
    }

    // Drawers collection - authorized users only
    match /drawers/{drawerId} {
      allow read, write: if isAuthorized();
    }

    // Forms collection - authorized users can read
    match /forms/{formId} {
      allow read: if isAuthorized();
      allow write: if false; // Only allow writes through Admin Console or server
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

/* ─── Cloud Storage ─────────────────────────────────── */
service firebase.storage {
  match /b/{bucket}/o {

    // Only allow access to files in their own path
    match /users/{userId}/documents/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
