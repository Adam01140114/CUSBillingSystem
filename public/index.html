<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>CUS Billing - Admin Portal</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCxfnleg4jI9C3xPI_UabT81vIsnPjukSY",
      authDomain: "cus-billing-e84eb.firebaseapp.com",
      projectId: "cus-billing-e84eb",
      storageBucket: "cus-billing-e84eb.firebasestorage.app",
      messagingSenderId: "606152504829",
      appId: "1:606152504829:web:6d14518df4a56ecfe81594",
      measurementId: "G-FKLJNHMWHV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Sample admin credentials
    const adminCredentials = {
      email: 'admin@cus.com',
      password: 'admin123'
    };

    // Customer data (starts empty, customers added through admin interface)
    let customers = [];
    
    // Locations data (starts empty, locations added through import or admin interface)
    let locations = [];
    
    // Users data (managed from the Settings module)
    let users = [];
    
    // Tax codes data (starts empty, codes added through admin interface)
    let codes = [];

    // Payment batch tracking
    window.paymentBatches = [];
    window.currentPaymentBatch = null;

    function logBatch(message, data) {
      const payload = data !== undefined ? data : '';
      console.log(`[Payment Batches] ${message}`, payload);
    }

    // Format phone number as (xxx)-xxx-xxxx
    function formatPhoneNumber(phone) {
      // Remove all non-digit characters
      const cleaned = phone.replace(/\D/g, '');
      
      // Format as (xxx)-xxx-xxxx
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0, 3)})-${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
      }
      
      // Return original if not 10 digits
      return phone;
    }

    // Format phone number input as user types
    window.formatPhoneInput = function(input) {
      let value = input.value.replace(/\D/g, ''); // Remove all non-digits
      
      if (value.length >= 6) {
        // Format as (xxx)-xxx-xxxx
        value = `(${value.slice(0, 3)})-${value.slice(3, 6)}-${value.slice(6, 10)}`;
      } else if (value.length >= 3) {
        // Format as (xxx)-xxx
        value = `(${value.slice(0, 3)})-${value.slice(3)}`;
      } else if (value.length > 0) {
        // Format as (xxx
        value = `(${value}`;
      }
      
      input.value = value;
    };

    // Format SSN input as user types (xxx-xx-xxxx)
    window.formatSSNInput = function(input) {
      let value = input.value.replace(/\D/g, ''); // Remove all non-digits
      
      if (value.length >= 5) {
        // Format as xxx-xx-xxxx
        value = `${value.slice(0, 3)}-${value.slice(3, 5)}-${value.slice(5, 9)}`;
      } else if (value.length >= 3) {
        // Format as xxx-xx
        value = `${value.slice(0, 3)}-${value.slice(3)}`;
      }
      
      input.value = value;
    };

    // Format date as mm/dd/yyyy
    function formatDate(dateString) {
      if (!dateString || dateString === 'Never') {
        return 'Never';
      }
      
      // If already in mm/dd/yyyy format, return as is
      if (dateString.includes('/')) {
        return dateString;
      }
      
      // If in yyyy-mm-dd format, convert to mm/dd/yyyy
      if (dateString.includes('-')) {
        const parts = dateString.split('-');
        if (parts.length === 3) {
          return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
      }
      
      return dateString;
    }

    // Firestore functions
    async function saveLocationsToFirestore() {
      try {
        const locationsRef = collection(db, 'locations');
        // Clear existing locations first
        const existingLocations = await getDocs(locationsRef);
        existingLocations.forEach(doc => {
          deleteDoc(doc.ref);
        });
        
        // Add all current locations
        for (const location of locations) {
          await addDoc(locationsRef, location);
        }
        console.log('Locations saved to Firestore');
      } catch (error) {
        console.error('Error saving locations:', error);
      }
    }

    async function loadLocationsFromFirestore() {
      try {
        const locationsRef = collection(db, 'locations');
        const snapshot = await getDocs(locationsRef);
        locations = [];
        snapshot.forEach(doc => {
          locations.push({ id: doc.id, ...doc.data() });
        });
        filteredLocations = [...locations];
        updateLocationsTable();
        console.log('Locations loaded from Firestore');
      } catch (error) {
        console.error('Error loading locations:', error);
      }
    }

    async function saveCustomersToFirestore() {
      try {
        const customersRef = collection(db, 'customers');
        // Clear existing customers first
        const existingCustomers = await getDocs(customersRef);
        existingCustomers.forEach(doc => {
          deleteDoc(doc.ref);
        });
        
        // Add all current customers using their ID as document ID
        for (const customer of customers) {
          const customerRef = doc(customersRef, customer.id);
          await setDoc(customerRef, customer);
        }
        console.log('Customers saved to Firestore');
      } catch (error) {
        console.error('Error saving customers:', error);
      }
    }

    async function loadCustomersFromFirestore() {
      try {
        const customersRef = collection(db, 'customers');
        const snapshot = await getDocs(customersRef);
        customers = [];
        snapshot.forEach(doc => {
          customers.push({ id: doc.id, ...doc.data() });
        });
        filteredCustomers = [...customers];
        updateCustomerTable();
        console.log('Customers loaded from Firestore:', customers.length, 'customers');
        console.log('Customer data:', customers);
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    async function saveCodesToFirestore() {
      try {
        const codesRef = collection(db, 'codes');
        // Clear existing codes first
        const existingCodes = await getDocs(codesRef);
        existingCodes.forEach(doc => {
          deleteDoc(doc.ref);
        });
        
        // Add all current codes
        for (const code of codes) {
          await addDoc(codesRef, code);
        }
        console.log('Codes saved to Firestore');
      } catch (error) {
        console.error('Error saving codes:', error);
      }
    }

    async function loadCodesFromFirestore() {
      try {
        const codesRef = collection(db, 'codes');
        const snapshot = await getDocs(codesRef);
        codes = [];
        snapshot.forEach(doc => {
          codes.push({ id: doc.id, ...doc.data() });
        });
        updateCodesTable();
        console.log('Codes loaded from Firestore');
      } catch (error) {
        console.error('Error loading codes:', error);
      }
    }
    
    async function saveUsersToFirestore() {
      try {
        const usersRef = collection(db, 'users');
        const existingUsers = await getDocs(usersRef);
        existingUsers.forEach(userDoc => {
          deleteDoc(userDoc.ref);
        });
        
        for (const user of users) {
          const userRef = doc(usersRef, user.id);
          await setDoc(userRef, user);
        }
        console.log('Users saved to Firestore');
      } catch (error) {
        console.error('Error saving users:', error);
      }
    }
    
    async function loadUsersFromFirestore() {
      try {
        const usersRef = collection(db, 'users');
        const snapshot = await getDocs(usersRef);
        users = [];
        snapshot.forEach(docSnap => {
          users.push({ id: docSnap.id, ...docSnap.data() });
        });
        filteredUsers = [...users];
        updateSettingsUsersTable();
        populateBatchStartUserSelect();
        console.log('Users loaded from Firestore');
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function saveBatchToFirestore(batch) {
      try {
        const batchesRef = collection(db, 'paymentBatches');
        const batchRef = doc(batchesRef, batch.id);
        await setDoc(batchRef, batch);
        console.log('[Batch][Firestore] Batch saved:', batch.id);
      } catch (error) {
        console.error('[Batch][Firestore] Error saving batch:', error);
      }
    }
    
    async function loadPaymentBatchesFromFirestore() {
      try {
        const batchesRef = collection(db, 'paymentBatches');
        const snapshot = await getDocs(batchesRef);
        window.paymentBatches = [];
        snapshot.forEach(batchDoc => {
          window.paymentBatches.push({ id: batchDoc.id, ...batchDoc.data() });
        });
        console.log('[Batch][Firestore] Batches loaded:', window.paymentBatches.length);
        renderBatchesList();
      } catch (error) {
        console.error('[Batch][Firestore] Error loading batches:', error);
      }
    }
    
    let currentUser = null;
    let filteredCustomers = [...customers];
    let filteredLocations = [...locations];
    let filteredUsers = [...users];
    let currentView = 'accounts'; // 'accounts' or 'locations'

    // Show dashboard immediately (no authentication required)
    function showDashboard() {
      updateDashboard();
    }

    // Reset bills on first of month
    function resetMonthlyBills() {
      const now = new Date();
      const isFirstOfMonth = now.getDate() === 1;
      
      if (isFirstOfMonth) {
        customers.forEach(customer => {
          // Reset current bill to full amount on first of month
          customer.currentBill = 170;
          customer.pastDue = 0;
          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);
        });
        
        // Save updated customers to Firestore
        saveCustomersToFirestore();
        console.log('Monthly bills reset for all customers');
      }
    }

    // MutationObserver to track payment module changes
    let paymentModuleObserver = null;
    function setupPaymentModuleObserver() {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule || paymentModuleObserver) return;
      
      paymentModuleObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {
            console.log('[OBSERVER] Payment module content changed!', {
              type: mutation.type,
              target: mutation.target.id || mutation.target.tagName,
              innerHTMLLength: paymentModule.innerHTML.length,
              hasPreviewSection: !!paymentModule.querySelector('#batchPreviewSection'),
              hasCurrentBatch: !!window.currentPaymentBatch,
              stackTrace: new Error().stack
            });
          }
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            console.log('[OBSERVER] Payment module class changed!', {
              target: mutation.target.id || mutation.target.tagName,
              oldValue: mutation.oldValue,
              newValue: mutation.target.className,
              isHidden: mutation.target.classList.contains('hidden')
            });
          }
        });
      });
      
      paymentModuleObserver.observe(paymentModule, {
        childList: true,
        subtree: true,
        characterData: true,
        attributes: true,
        attributeOldValue: true,
        attributeFilter: ['class']
      });
      
      console.log('[OBSERVER] Payment module observer set up');
    }

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', async function() {
      // Ensure the payment module markup (with batch controls) is in place before data loads
      resetPaymentForm();
      showDashboard();
      // Set up mutation observer after payment module is created
      setTimeout(setupPaymentModuleObserver, 100);
      // Load data from Firestore
      await loadLocationsFromFirestore();
      await loadCustomersFromFirestore();
      await loadCodesFromFirestore();
      await loadUsersFromFirestore();
      await loadPaymentBatchesFromFirestore();
      // Update customer payment statuses based on past due amounts
      updateAllCustomerPaymentStatuses();
      // Reset bills if it's the first of the month
      resetMonthlyBills();
      // Update location statuses based on customers
      updateLocationStatuses();
      // Update stats after data is loaded
      updateStats();
    });

    // Switch between accounts and locations views
    window.switchView = function(view) {
      currentView = view;
      const accountsTab = document.getElementById('accountsTab');
      const locationsTab = document.getElementById('locationsTab');
      const accountsContent = document.getElementById('accountsContent');
      const locationsContent = document.getElementById('locationsContent');
      
      if (view === 'accounts') {
        accountsTab.classList.add('bg-blue-600', 'text-white');
        accountsTab.classList.remove('bg-slate-200', 'text-slate-700');
        locationsTab.classList.add('bg-slate-200', 'text-slate-700');
        locationsTab.classList.remove('bg-blue-600', 'text-white');
        accountsContent.classList.remove('hidden');
        locationsContent.classList.add('hidden');
      } else {
        locationsTab.classList.add('bg-blue-600', 'text-white');
        locationsTab.classList.remove('bg-slate-200', 'text-slate-700');
        accountsTab.classList.add('bg-slate-200', 'text-slate-700');
        accountsTab.classList.remove('bg-blue-600', 'text-white');
        locationsContent.classList.remove('hidden');
        accountsContent.classList.add('hidden');
      }
      updateDashboard();
    };

    // Switch between settings accounts, locations, and codes views
    window.switchSettingsView = function(view) {
      const accountsTab = document.getElementById('settingsAccountsTab');
      const locationsTab = document.getElementById('settingsLocationsTab');
      const codesTab = document.getElementById('settingsCodesTab');
      const usersTab = document.getElementById('settingsUsersTab');
      const accountsContent = document.getElementById('settingsAccountsContent');
      const locationsContent = document.getElementById('settingsLocationsContent');
      const codesContent = document.getElementById('settingsCodesContent');
      const usersContent = document.getElementById('settingsUsersContent');
      
      // Reset all tabs and content
      [accountsTab, locationsTab, codesTab, usersTab].forEach(tab => {
        if (!tab) return;
        tab.classList.remove('bg-blue-600', 'text-white');
        tab.classList.add('bg-slate-200', 'text-slate-700');
      });
      accountsContent.classList.add('hidden');
      locationsContent.classList.add('hidden');
      codesContent.classList.add('hidden');
      usersContent.classList.add('hidden');
      
      if (view === 'accounts') {
        accountsTab.classList.add('bg-blue-600', 'text-white');
        accountsTab.classList.remove('bg-slate-200', 'text-slate-700');
        accountsContent.classList.remove('hidden');
        updateSettingsCustomerTable();
      } else if (view === 'locations') {
        locationsTab.classList.add('bg-blue-600', 'text-white');
        locationsTab.classList.remove('bg-slate-200', 'text-slate-700');
        locationsContent.classList.remove('hidden');
        updateSettingsLocationsTable();
      } else if (view === 'codes') {
        codesTab.classList.add('bg-blue-600', 'text-white');
        codesTab.classList.remove('bg-slate-200', 'text-slate-700');
        codesContent.classList.remove('hidden');
        updateCodesTable();
      } else if (view === 'users') {
        usersTab.classList.add('bg-blue-600', 'text-white');
        usersTab.classList.remove('bg-slate-200', 'text-slate-700');
        usersContent.classList.remove('hidden');
        updateSettingsUsersTable();
      }
    };

    function updateDashboard() {
      console.log('[FLOW][updateDashboard][STEP 1] Function START');
      console.log('[FLOW][updateDashboard][STEP 1.1] Checking payment module state BEFORE updateDashboard...');
      const paymentModuleBefore = document.getElementById('paymentModule');
      console.log('[FLOW][updateDashboard][STEP 1.2] Payment module before:', {
        exists: !!paymentModuleBefore,
        hidden: paymentModuleBefore?.classList.contains('hidden'),
        innerHTMLLength: paymentModuleBefore?.innerHTML?.length || 0,
        hasPreviewSection: !!paymentModuleBefore?.querySelector('#batchPreviewSection'),
        hasCurrentBatch: !!window.currentPaymentBatch
      });
      
      console.log('updateDashboard called, customers array length:', customers.length);
      updateStats();
      updateLocationStatuses(); // Update location statuses based on customers
      if (currentView === 'accounts') {
        updateCustomerTable();
      } else {
        updateLocationsTable();
      }
      
      console.log('[FLOW][updateDashboard][STEP 2] Checking payment module state AFTER updateDashboard...');
      const paymentModuleAfter = document.getElementById('paymentModule');
      console.log('[FLOW][updateDashboard][STEP 2.1] Payment module after:', {
        exists: !!paymentModuleAfter,
        hidden: paymentModuleAfter?.classList.contains('hidden'),
        innerHTMLLength: paymentModuleAfter?.innerHTML?.length || 0,
        hasPreviewSection: !!paymentModuleAfter?.querySelector('#batchPreviewSection'),
        hasCurrentBatch: !!window.currentPaymentBatch,
        innerHTMLChanged: (paymentModuleBefore?.innerHTML?.length || 0) !== (paymentModuleAfter?.innerHTML?.length || 0)
      });
      
      if ((paymentModuleBefore?.innerHTML?.length || 0) !== (paymentModuleAfter?.innerHTML?.length || 0)) {
        console.error('[FLOW][updateDashboard][STEP 2.2] WARNING: Payment module innerHTML changed during updateDashboard!');
        console.error('[FLOW][updateDashboard][STEP 2.3] Before length:', paymentModuleBefore?.innerHTML?.length || 0);
        console.error('[FLOW][updateDashboard][STEP 2.4] After length:', paymentModuleAfter?.innerHTML?.length || 0);
      }
      
      console.log('[FLOW][updateDashboard][STEP 3] Function END');
    }

    // Update customer payment status based on past due amount
    function updateCustomerPaymentStatus(customer) {
      // Don't change status if it's inactive or pending closing (these are manually set)
      if (customer.paymentStatus === 'inactive' || customer.paymentStatus === 'pending closing') {
        return;
      }
      
      if (customer.pastDue > 0) {
        customer.paymentStatus = 'overdue';
      } else {
        customer.paymentStatus = 'current';
      }
    }

    // Update all customer payment statuses
    function updateAllCustomerPaymentStatuses() {
      customers.forEach(customer => {
        updateCustomerPaymentStatus(customer);
      });
    }

    // Update location statuses based on associated customers
    function updateLocationStatuses() {
      locations.forEach(location => {
        // Check if there's a customer associated with this location
        const associatedCustomer = customers.find(customer => 
          customer.address === location.address || 
          customer.name === location.currentResident
        );
        
        if (associatedCustomer) {
          // Location has an active customer
          location.status = 'occupied';
          location.currentResident = associatedCustomer.name;
          location.ownerFullName = associatedCustomer.name;
          // Split name into first and last
          const nameParts = associatedCustomer.name.split(' ');
          location.ownerFirstName = nameParts[0] || '';
          location.ownerLastName = nameParts.slice(1).join(' ') || '';
        } else {
          // No customer associated - set to inactive
          location.status = 'inactive';
          location.currentResident = null;
          location.ownerFullName = '';
          location.ownerFirstName = '';
          location.ownerLastName = '';
        }
      });
      
      // Update filtered locations
      filteredLocations = [...locations];
    }

    function updateStats() {
      console.log('Updating stats with customers:', customers);
      const totalCustomers = customers.length;
      const overdueCustomers = customers.filter(c => c.paymentStatus === 'overdue').length;
      const currentCustomers = customers.filter(c => c.paymentStatus === 'current').length;
      
      // Calculate total revenue from payment history
      let totalRevenue = 0;
      customers.forEach(customer => {
        if (customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0) {
          customer.paymentHistory.forEach(payment => {
            totalRevenue += payment.amountPaid;
          });
        }
      });

      console.log('Stats calculated:', { totalCustomers, overdueCustomers, currentCustomers, totalRevenue });

      // Only update stats if the elements exist (they were removed from the UI)
      const totalCustomersEl = document.getElementById('totalCustomers');
      const overdueCustomersEl = document.getElementById('overdueCustomers');
      const currentCustomersEl = document.getElementById('currentCustomers');
      const totalRevenueEl = document.getElementById('totalRevenue');
      
      if (totalCustomersEl) totalCustomersEl.textContent = totalCustomers;
      if (overdueCustomersEl) overdueCustomersEl.textContent = overdueCustomers;
      if (currentCustomersEl) currentCustomersEl.textContent = currentCustomers;
      if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
    }

    function updateCustomerTable() {
      const tbody = document.getElementById('customerTableBody');
      tbody.innerHTML = '';

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';
        
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';
        
        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();
        
        // Check if customer has paid early (before due date)
        const hasPaidEarly = customer.lastPayment && customer.lastPayment !== 'Never' && 
                            customer.lastPayment.includes('/') && 
                            new Date(customer.lastPayment) < new Date(dueDateStr);
        
        // Calculate actual amount based on breakdown logic
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0; // $20 late fee
        const subtotal = serviceCost + lateFee;
        
        // Calculate code surcharges
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            totalSurcharge += subtotal * (code.percentage / 100);
          });
        }
        
        const totalAmount = hasPaidEarly ? 0 : (subtotal + totalSurcharge);
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'accountNumber', '${customer.accountNumber}')" 
                 title="Double-click to edit">
              ${customer.accountNumber}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'name', '${customer.name}')" 
                 title="Double-click to edit">
              ${customer.name}
            </div>
            <button 
              onclick="showCustomerFullInfo('${customer.id}')" 
              class="mt-2 text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium"
            >
              View Full Info
            </button>
          </td>
          <td class="px-6 py-4 text-center">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'address', '${customer.address}')" 
                 title="Double-click to edit">
              <div class="font-medium whitespace-nowrap">${customer.address.split(',')[0].trim()}</div>
              <div class="text-slate-500 dark:text-slate-400 whitespace-nowrap">${customer.address.split(',').slice(1).join(',').trim()}</div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editCustomerField('${customer.id}', 'paymentStatus', '${customer.paymentStatus}')" 
                  title="Double-click to edit">
              ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-900 dark:text-slate-100">
            <div class="font-medium">$${totalAmount.toFixed(2)}</div>
            <button onclick="showAmountDetails('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
              View Details
            </button>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600 dark:text-slate-400">
            <div class="flex flex-wrap gap-1 justify-center">
              ${customer.codes && customer.codes.length > 0 
                ? customer.codes.map(code => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.name}</span>`).join('')
                : '<span class="text-slate-400 dark:text-slate-500">â€”</span>'
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <div class="flex flex-col space-y-2">
              <button onclick="showPaymentModal('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Mark Paid
              </button>
              <button onclick="showPaymentHistory('${customer.id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                View History
              </button>
              <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Logout function (simply redirects to client page)
    window.logout = function() {
      window.location.href = 'billing.html';
    };

    // Module Management Functions
    window.showPaymentModule = function() {
      hideAllModules();
      // Reset payment module to original form
      resetPaymentForm();
      document.getElementById('paymentModule').classList.remove('hidden');
    };

    window.showBillModule = function() {
      hideAllModules();
      // Reset bill module to original form
      resetBillForm();
      document.getElementById('billModule').classList.remove('hidden');
    };

    window.showAddClientModule = function() {
      hideAllModules();
      // Reset add client module to original form
      resetAddClientForm();
      // Populate codes dropdown after form is reset
      setTimeout(() => {
        populateAddClientCodeSelect();
        window.selectedClientCodes = [];
        updateClientCodesList();
      }, 100);
      document.getElementById('addClientModule').classList.remove('hidden');
    };

    window.showSearchModule = function() {
      hideAllModules();
      // Clear search results and reset form
      document.getElementById('searchByName').value = '';
      document.getElementById('searchByStatus').value = '';
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('searchModule').classList.remove('hidden');
    };

    window.showSettingsModule = function() {
      hideAllModules();
      document.getElementById('settingsModule').classList.remove('hidden');
      // Populate the settings tables
      updateSettingsCustomerTable();
      updateSettingsLocationsTable();
      updateSettingsUsersTable();
    };

    window.hideAllModules = function() {
      document.getElementById('paymentModule').classList.add('hidden');
      document.getElementById('billModule').classList.add('hidden');
      document.getElementById('addClientModule').classList.add('hidden');
      document.getElementById('searchModule').classList.add('hidden');
      document.getElementById('settingsModule').classList.add('hidden');
    };

    // Payment Module Functions
    function populatePaymentCustomerSelect() {
      const select = document.getElementById('paymentCustomerSelect');
      if (!select) {
        console.error('[Batch] populatePaymentCustomerSelect: select element missing.');
        return;
      }
      select.innerHTML = '<option value="">Choose a customer...</option>';
      
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.name} (${customer.accountNumber})`;
        select.appendChild(option);
      });
      
      select.onchange = function() {
        const customerId = this.value;
        console.log('[Batch] Customer selection changed:', customerId);
        if (customerId) {
          showCustomerPaymentInfo(customerId);
        } else {
          hideCustomerPaymentInfo();
        }
      };
      
      console.log('[Batch] populatePaymentCustomerSelect: options loaded =', customers.length);
    }
    
    function populateBatchStartUserSelect() {
      const select = document.getElementById('batchStartUserSelect');
      if (!select) {
        console.warn('[Batch] populateBatchStartUserSelect: select element missing.');
        return;
      }
      
      select.innerHTML = '<option value="">Select a user...</option>';
      users.forEach(user => {
        const option = document.createElement('option');
        const fullName = user.fullName || user.id || 'Unnamed User';
        option.value = fullName;
        option.textContent = fullName;
        select.appendChild(option);
      });
      
      console.log('[Batch] populateBatchStartUserSelect: users loaded =', users.length);
    }
    
    function showCustomerPaymentInfo(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        // Calculate prorated service cost based on when customer was added
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0;
        const subtotal = serviceCost + lateFee;
        
        // Calculate code surcharges
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            totalSurcharge += subtotal * (code.percentage / 100);
          });
        }
        
        const totalAmount = subtotal + totalSurcharge;
        
        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();
        
        // Set up status indicator
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';
        
        document.getElementById('paymentAmountDue').textContent = `$${totalAmount.toFixed(2)}`;
        document.getElementById('paymentPastDue').textContent = `$${customer.pastDue.toFixed(2)}`;
        document.getElementById('paymentDueDate').textContent = dueDateStr;
        document.getElementById('paymentLateFee').textContent = `$${lateFee.toFixed(2)}`;
        document.getElementById('paymentAmount').value = (totalAmount + customer.pastDue).toFixed(2);
        
        // Update status indicator
        const statusIndicator = document.getElementById('paymentStatusIndicator');
        statusIndicator.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
        statusIndicator.textContent = customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1);
        
        // Update property location
        document.getElementById('paymentPropertyLocation').textContent = customer.address;
        
        document.getElementById('customerPaymentInfo').classList.remove('hidden');
      }
    }

    // Calculate prorated service cost based on when customer was added
    function calculateProratedServiceCost(customer) {
      const baseServiceCost = 170;
      
      // If customer was added this month, calculate proration
      const now = new Date();
      const customerAddedDate = new Date(customer.createdDate);
      
      // Check if customer was added in the current month
      if (customerAddedDate.getMonth() === now.getMonth() && 
          customerAddedDate.getFullYear() === now.getFullYear()) {
        
        // Calculate days remaining in the month from when they joined
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const totalDaysInMonth = lastDayOfMonth.getDate();
        
        // Days from when they joined to end of month
        const daysRemaining = lastDayOfMonth.getDate() - customerAddedDate.getDate() + 1;
        
        // Calculate prorated amount
        const proratedAmount = (baseServiceCost * daysRemaining) / totalDaysInMonth;
        
        return Math.round(proratedAmount * 100) / 100; // Round to 2 decimal places
      }
      
      // If customer was added in a previous month, charge full amount
      return baseServiceCost;
    }

    function hideCustomerPaymentInfo() {
      document.getElementById('customerPaymentInfo').classList.add('hidden');
    }

    // Bill Module Functions
    function populateBillCustomerSelect() {
      const select = document.getElementById('billCustomerSelect');
      select.innerHTML = '<option value="">Choose a customer...</option>';
      
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.name} (${customer.accountNumber})`;
        select.appendChild(option);
      });
      
      // Add event listener for customer selection
      select.addEventListener('change', function() {
        const customerId = this.value;
        if (customerId) {
          showCustomerBillInfo(customerId);
        } else {
          hideCustomerBillInfo();
        }
      });
    }

    function showCustomerBillInfo(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        // Calculate prorated service cost based on when customer was added
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0;
        const subtotal = serviceCost + lateFee;
        
        // Calculate code surcharges
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            totalSurcharge += subtotal * (code.percentage / 100);
          });
        }
        
        // Calculate factor adjustment (based on service cost only)
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const factorAdjustment = serviceCost * (factor - 1);
        const totalAmount = serviceCost + lateFee + totalSurcharge + factorAdjustment;
        
        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();
        
        // Set up status indicator
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';
        
        document.getElementById('billAmountDue').textContent = `$${totalAmount.toFixed(2)}`;
        document.getElementById('billPastDue').textContent = `$${customer.pastDue.toFixed(2)}`;
        document.getElementById('billDueDate').textContent = dueDateStr;
        document.getElementById('billLateFee').textContent = `$${lateFee.toFixed(2)}`;
        
        // Update status indicator
        const statusIndicator = document.getElementById('billStatusIndicator');
        statusIndicator.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
        statusIndicator.textContent = customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1);
        
        // Update property location
        document.getElementById('billPropertyLocation').textContent = customer.address;
        
        document.getElementById('customerBillInfo').classList.remove('hidden');
      }
    }

    function hideCustomerBillInfo() {
      document.getElementById('customerBillInfo').classList.add('hidden');
    }

    window.resetBillForm = function() {
      const billModule = document.getElementById('billModule');
      billModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>
          
          <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>
            
            <br>
            <button 
              onclick="produceBill()" 
              class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Bill
            </button>
            
            <!-- PDF Display Container -->
            <div id="billPdfDisplay" class="hidden mt-4">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            </div>
          </div>
        </div>

      `;
      
      // Repopulate the customer dropdown
      populateBillCustomerSelect();
    };

    window.produceBill = async function() {
      const customerId = document.getElementById('billCustomerSelect').value;
      if (!customerId) {
        alert('Please select a customer');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      try {
        // Calculate all the amounts (same logic as showCustomerBillInfo)
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0;
        const subtotal = serviceCost + lateFee;
        
        // Calculate code surcharges
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            totalSurcharge += subtotal * (code.percentage / 100);
          });
        }
        
        // Calculate factor adjustment (based on service cost only)
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const factorAdjustment = serviceCost * (factor - 1);
        const totalAmount = serviceCost + lateFee + totalSurcharge + factorAdjustment;
        
        // Calculate dates
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const statementDate = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getFullYear();
        
        // Calculate billing cycle (first day of month to last day of month)
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayStr = (firstDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           firstDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                           String(firstDayOfMonth.getFullYear()).slice(-2);
        const lastDayStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          String(lastDayOfMonth.getFullYear()).slice(-2);
        const cyclePeriod = `${firstDayStr} to ${lastDayStr}`;
        
        // Due date is the last day of the billing cycle month (same as lastDayOfMonth)
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Create FormData with all the required fields
        const formData = new FormData();
        formData.append('account_no', customer.accountNumber || '');
        formData.append('account_name', customer.name || '');
        formData.append('account_address', customer.address || '');
        formData.append('statement_date', statementDate);
        formData.append('cycle_period', cyclePeriod);
        formData.append('current_charges', `$${serviceCost.toFixed(2)}`);
        formData.append('previous_charges', `$${customer.pastDue.toFixed(2)}`);
        formData.append('taxes_charges', `$${totalSurcharge.toFixed(2)}`);
        formData.append('total_amount', `$${totalAmount.toFixed(2)}`);
        formData.append('due_date', dueDateStr);

        // Send to server
        const response = await fetch('/edit_pdf?pdf=bill', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Failed to generate PDF');
        }

        // Get the PDF blob
        const blob = await response.blob();
        
        // Create blob URL for download
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'bill.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);
        
        // Display the PDF below the button
        const displayUrl = URL.createObjectURL(blob);
        const pdfDisplay = document.getElementById('billPdfDisplay');
        const pdfViewer = document.getElementById('billPdfViewer');
        const billModule = document.getElementById('billModule');
        
        if (pdfDisplay && pdfViewer) {
          // Revoke any previous display URL to prevent memory leaks
          if (pdfViewer.src && pdfViewer.src.startsWith('blob:')) {
            URL.revokeObjectURL(pdfViewer.src);
          }
          
          pdfViewer.src = displayUrl;
          pdfDisplay.classList.remove('hidden');
          
          // Increase bill module height by 25% when PDF is displayed
          if (billModule) {
            // Wait a moment for the PDF display to render, then calculate height
            setTimeout(() => {
              const currentHeight = billModule.offsetHeight;
              billModule.style.minHeight = `${currentHeight * 1.25}px`;
              billModule.style.paddingBottom = '2rem';
            }, 50);
          }
          
          // Scroll to the PDF viewer smoothly
          setTimeout(() => {
            pdfDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 100);
        } else {
          // If elements don't exist, create them dynamically
          const customerBillInfo = document.getElementById('customerBillInfo');
          if (customerBillInfo) {
            const pdfContainer = document.createElement('div');
            pdfContainer.id = 'billPdfDisplay';
            pdfContainer.className = 'mt-4';
            pdfContainer.innerHTML = `
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            `;
            customerBillInfo.appendChild(pdfContainer);
            document.getElementById('billPdfViewer').src = displayUrl;
            
            // Increase bill module height by 25% when PDF is displayed
            if (billModule) {
              // Wait a moment for the PDF display to render, then calculate height
              setTimeout(() => {
                const currentHeight = billModule.offsetHeight;
                billModule.style.minHeight = `${currentHeight * 1.25}px`;
                billModule.style.paddingBottom = '2rem';
              }, 50);
            }
            
            setTimeout(() => {
              pdfContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
          }
        }

        alert('Bill PDF generated successfully!');
      } catch (error) {
        console.error('Error generating bill:', error);
        alert('Failed to generate bill PDF: ' + error.message);
      }
    };

    window.showBillDetailsModal = function() {
      // Placeholder function - can be implemented later if needed
      const customerId = document.getElementById('billCustomerSelect').value;
      if (customerId) {
        showAmountDetails(customerId);
      }
    };

    window.processPaymentFromModule = async function() {
      console.log('[FLOW][STEP 1] processPaymentFromModule START');
      console.log('[FLOW][STEP 1.1] Checking payment module state...');
      const paymentModule = document.getElementById('paymentModule');
      console.log('[FLOW][STEP 1.1.1] Payment module exists:', !!paymentModule);
      console.log('[FLOW][STEP 1.1.2] Payment module hidden:', paymentModule?.classList.contains('hidden'));
      console.log('[FLOW][STEP 1.1.3] Payment module innerHTML length:', paymentModule?.innerHTML?.length || 0);
      console.log('[FLOW][STEP 1.1.4] Current batch exists:', !!window.currentPaymentBatch);
      if (window.currentPaymentBatch) {
        console.log('[FLOW][STEP 1.1.5] Current batch entries:', window.currentPaymentBatch.entries.length);
      }
      
      const customerId = document.getElementById('paymentCustomerSelect')?.value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount')?.value);
      const paymentType = document.getElementById('paymentType')?.value || '';
      console.log('[FLOW][STEP 1.2] Form values:', { customerId, paymentAmount, paymentType, currentBatch: !!window.currentPaymentBatch });
      
      if (!customerId) {
        console.log('[FLOW][STEP 1.3] ERROR: No customer selected');
        alert('Please select a customer');
        return;
      }
      
      if (!paymentAmount || paymentAmount <= 0) {
        console.log('[FLOW][STEP 1.4] ERROR: Invalid payment amount');
        alert('Please enter a valid payment amount');
        return;
      }
      
      if (!paymentType) {
        console.log('[FLOW][STEP 1.5] ERROR: No payment type selected');
        alert('Please select a payment type');
        return;
      }
      
      console.log('[FLOW][STEP 2] Looking up customer...');
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        console.log('[FLOW][STEP 2.1] Customer found:', customer.name);
        // Process payment (same logic as existing processPayment function)
        const today = new Date();
        const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();
        console.log('[FLOW][STEP 2.2] Formatted date:', formattedDate);
        
        // Add to payment history
        if (!customer.paymentHistory) {
          customer.paymentHistory = [];
        }
        customer.paymentHistory.push({
          date: formattedDate,
          amountPaid: paymentAmount,
          amountDue: customer.pastDue + (customer.currentBill || 0)
        });
        console.log('[FLOW][STEP 2.3] Payment history updated');
        
        // Update customer balance
        customer.pastDue = Math.max(0, customer.pastDue - paymentAmount);
        console.log('[FLOW][STEP 2.4] Customer balance updated, pastDue:', customer.pastDue);
        
        // If customer was pending closing and now has no balance, mark as inactive
        if (customer.paymentStatus === 'pending closing' && customer.pastDue === 0 && customer.currentBill === 0) {
          customer.paymentStatus = 'inactive';
        } else {
          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);
        }
        
        // Update last payment
        customer.lastPayment = formattedDate;
        
        console.log('[FLOW][STEP 3] Saving to Firestore...');
        // Save to Firestore
        await saveCustomersToFirestore();
        console.log('[FLOW][STEP 3.1] Firestore save complete');
        
        console.log('[FLOW][STEP 4] Calling updateDashboard...');
        console.log('[FLOW][STEP 4.1] Payment module before updateDashboard:', {
          exists: !!paymentModule,
          hidden: paymentModule?.classList.contains('hidden'),
          innerHTMLLength: paymentModule?.innerHTML?.length || 0,
          hasPreviewSection: !!paymentModule?.querySelector('#batchPreviewSection')
        });
        updateDashboard();
        console.log('[FLOW][STEP 4.2] updateDashboard complete');
        console.log('[FLOW][STEP 4.3] Payment module after updateDashboard:', {
          exists: !!paymentModule,
          hidden: paymentModule?.classList.contains('hidden'),
          innerHTMLLength: paymentModule?.innerHTML?.length || 0,
          hasPreviewSection: !!paymentModule?.querySelector('#batchPreviewSection')
        });
        
        if (window.currentPaymentBatch) {
          console.log('[FLOW][STEP 5] Processing inside batch...');
          console.log('[FLOW][STEP 5.1] Batch details:', { 
            customer: customer.name, 
            paymentAmount, 
            paymentType,
            batchId: window.currentPaymentBatch.id,
            currentEntries: window.currentPaymentBatch.entries.length
          });
          console.log('[FLOW][STEP 5.2] Payment module state before addEntryToCurrentBatch:', {
            exists: !!paymentModule,
            hidden: paymentModule?.classList.contains('hidden'),
            innerHTMLLength: paymentModule?.innerHTML?.length || 0,
            hasPreviewSection: !!paymentModule?.querySelector('#batchPreviewSection'),
            hasEntrySection: !!paymentModule?.querySelector('#batchEntrySection')
          });
          addEntryToCurrentBatch(customer, paymentAmount, paymentType, formattedDate);
          console.log('[FLOW][STEP 5.3] addEntryToCurrentBatch complete');
          console.log('[FLOW][STEP 5.4] Payment module state after addEntryToCurrentBatch:', {
            exists: !!paymentModule,
            hidden: paymentModule?.classList.contains('hidden'),
            innerHTMLLength: paymentModule?.innerHTML?.length || 0,
            hasPreviewSection: !!paymentModule?.querySelector('#batchPreviewSection'),
            previewSectionHidden: paymentModule?.querySelector('#batchPreviewSection')?.classList.contains('hidden'),
            hasEntrySection: !!paymentModule?.querySelector('#batchEntrySection'),
            entrySectionHidden: paymentModule?.querySelector('#batchEntrySection')?.classList.contains('hidden')
          });
        } else {
          console.log('[FLOW][STEP 5] Processing outside batch, showing legacy success screen.');
          showPaymentSuccessScreen(customer.name, paymentAmount);
        }
        console.log('[FLOW][STEP 6] processPaymentFromModule END');
      } else {
        console.log('[FLOW][STEP 2] ERROR: Customer not found');
      }
    };

    // Show payment success screen
    window.showPaymentSuccessScreen = function(customerName, amount) {
      const paymentModule = document.getElementById('paymentModule');
      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Processed Successfully!</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          
          <h4 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Payment Processed Successfully!</h4>
          <p class="text-slate-600 dark:text-slate-400 mb-4">Payment of <span class="font-semibold text-green-600">$${amount.toFixed(2)}</span> has been processed for <span class="font-semibold">${customerName}</span></p>
          <p class="text-sm text-slate-500 dark:text-slate-400 mb-8">The payment has been recorded and the customer's account has been updated.</p>
          
          <div class="flex flex-col gap-4 justify-center">
            <button 
              onclick="resetPaymentForm()" 
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Make Another Payment
            </button>
            <button 
              onclick="hideAllModules()" 
              class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Exit
            </button>
          </div>
        </div>

      `;
    };

    // Reset payment form
    window.resetPaymentForm = function() {
      console.log('[FLOW][resetPaymentForm][STEP 1] Function START - THIS WILL WIPE THE PAYMENT MODULE!');
      console.trace('[FLOW][resetPaymentForm][STEP 1.1] Stack trace to see who called this:');
      const paymentModule = document.getElementById('paymentModule');
      console.log('[FLOW][resetPaymentForm][STEP 1.2] Payment module before reset:', {
        exists: !!paymentModule,
        hidden: paymentModule?.classList.contains('hidden'),
        innerHTMLLength: paymentModule?.innerHTML?.length || 0,
        hasCurrentBatch: !!window.currentPaymentBatch,
        batchId: window.currentPaymentBatch?.id,
        batchEntries: window.currentPaymentBatch?.entries?.length || 0
      });
      
      if (window.currentPaymentBatch) {
        console.warn('[FLOW][resetPaymentForm][STEP 1.3] WARNING: Resetting form while batch is active! This will lose batch data!');
        console.warn('[FLOW][resetPaymentForm][STEP 1.4] Batch details:', {
          id: window.currentPaymentBatch.id,
          username: window.currentPaymentBatch.username,
          entries: window.currentPaymentBatch.entries.length
        });
      }
      
      window.currentPaymentBatch = null;
      console.log('[FLOW][resetPaymentForm][STEP 2] Current batch cleared');
      console.log('[FLOW][resetPaymentForm][STEP 3] Setting payment module innerHTML (this wipes everything)...');
      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Batches</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div id="batchStartSection" class="space-y-6 py-8 px-6 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-center">
          <p class="text-slate-700 dark:text-slate-100 text-base font-semibold">Group multiple payments into a batch, tag it with your username, and submit everything at once.</p>
          <p class="text-sm text-slate-500 dark:text-slate-300">Select your username and click "Start Batch" to begin capturing payments.</p>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center md:text-left">Select User</label>
              <select 
                id="batchStartUserSelect" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-green-500"
              >
                <option value="">Select a user...</option>
              </select>
            </div>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
              <button 
                onclick="startPaymentBatch()" 
                class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow">
                Start Batch
              </button>
              <button 
                onclick="viewPaymentBatches()" 
                class="w-full md:w-auto bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-3 px-6 rounded-xl shadow">
                View Batches
              </button>
            </div>
          </div>
        </div>
        
        <div id="batchEntrySection" class="hidden space-y-6 mt-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <p class="text-sm text-slate-500">Active Batch</p>
              <p class="text-lg font-semibold text-slate-800 dark:text-slate-200" id="activeBatchUser">--</p>
            </div>
            <div class="flex gap-3">
              <button onclick="cancelCurrentBatch()" class="text-sm text-slate-500 hover:text-slate-700">End Batch</button>
            </div>
          </div>
          
          <div class="space-y-6">
            <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="paymentCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>
          
          <div id="customerPaymentInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="paymentAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewDetailsBtn" onclick="showPaymentDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="paymentPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="paymentLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="paymentPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="paymentDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="paymentStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Type</label>
              <select 
                id="paymentType" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              >
                <option value="">Select Payment Type</option>
                <option value="Check">Check</option>
                <option value="Cash">Cash</option>
              </select>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
              <input 
                type="number" 
                id="paymentAmount" 
                step="0.01" 
                min="0" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter payment amount"
              >
            </div>
            
            <button 
              onclick="processPaymentFromModule()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Process Payment
            </button>
          </div>
        </div>

        <div id="batchPreviewSection" data-batch-section="preview" class="hidden mt-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Batch Preview</h4>
            <div class="flex flex-col md:flex-row gap-3">
              <button onclick="addAnotherBatchEntry()" class="bg-white border border-slate-300 text-slate-700 px-5 py-2 rounded-xl hover:bg-slate-50">Add Entry</button>
              <button onclick="submitCurrentBatch()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-xl">Submit Batch</button>
            </div>
          </div>
          <div class="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-inner">
            <table id="batchPreviewTableMain" class="batch-preview-table">
              <thead class="bg-slate-100">
                <tr>
                  <th class="batch-col-date">Date</th>
                  <th class="batch-col-customer">Customer</th>
                  <th class="batch-col-account">Account #</th>
                  <th class="batch-col-property">Property</th>
                  <th class="batch-col-type">Type</th>
                  <th class="batch-col-amount">Amount</th>
                </tr>
              </thead>
              <tbody id="batchPreviewTable" class="bg-white">
                <tr>
                  <td colspan="6" class="batch-empty-message">No payments added yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="batchesListSection" data-batch-section="list" class="hidden mt-8">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Submitted Batches</h4>
            <button onclick="closeBatchList()" class="text-sm text-slate-500 hover:text-slate-700">Close</button>
          </div>
          <div class="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-inner">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Batch ID</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">User</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Entries</th>
                  <th class="px-4 py-2 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Amount</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Submitted</th>
                </tr>
              </thead>
              <tbody id="batchesListTable" class="bg-white divide-y divide-slate-200">
                <tr>
                  <td colspan="5" class="px-4 py-3 text-center text-sm text-slate-500">No batches submitted yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      console.log('[FLOW][resetPaymentForm][STEP 4] Payment module innerHTML set, new length:', paymentModule.innerHTML.length);
      console.log('[FLOW][resetPaymentForm][STEP 5] Payment module after reset:', {
        exists: !!paymentModule,
        hidden: paymentModule?.classList.contains('hidden'),
        innerHTMLLength: paymentModule?.innerHTML?.length || 0,
        hasPreviewSection: !!paymentModule?.querySelector('#batchPreviewSection'),
        hasCurrentBatch: !!window.currentPaymentBatch
      });
      
      // Repopulate dropdowns and ensure sections/logs are in sync
      console.log('[FLOW][resetPaymentForm][STEP 6] Repopulating dropdowns...');
      populatePaymentCustomerSelect();
      populateBatchStartUserSelect();
      console.log('[FLOW][resetPaymentForm][STEP 7] Setting view state to start...');
      setBatchViewState('start');
      console.log('[FLOW][resetPaymentForm][STEP 8] Rendering preview...');
      renderBatchPreview();
      console.log('[FLOW][resetPaymentForm][STEP 9] Rendering batches list...');
      renderBatchesList();
      console.log('[Batch] Payment module reset. Awaiting batch start.');
      debugBatchDom('after-reset');
      console.log('[FLOW][resetPaymentForm][STEP 10] Function END');
    };

    function debugBatchDom(label) {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule) {
        console.error('[Batch][DOM]', label, 'paymentModule missing');
        return;
      }
      const snapshot = {
        hasStart: !!paymentModule.querySelector('#batchStartSection'),
        hasEntry: !!paymentModule.querySelector('#batchEntrySection'),
        hasPreview: !!paymentModule.querySelector('#batchPreviewSection'),
        hasPreviewTable: !!paymentModule.querySelector('#batchPreviewTable'),
        hasList: !!paymentModule.querySelector('#batchesListSection'),
        hasListTable: !!paymentModule.querySelector('#batchesListTable')
      };
      console.log('[Batch][DOM]', label, snapshot);
    }

    function setBatchViewState(view) {
      console.log('[FLOW][setBatchViewState][STEP 1] Function START');
      console.log('[FLOW][setBatchViewState][STEP 1.1] Target view:', view);
      
      // Ensure payment module is visible
      console.log('[FLOW][setBatchViewState][STEP 2] Checking payment module...');
      const paymentModule = document.getElementById('paymentModule');
      console.log('[FLOW][setBatchViewState][STEP 2.1] Payment module:', {
        exists: !!paymentModule,
        hidden: paymentModule?.classList.contains('hidden'),
        innerHTMLLength: paymentModule?.innerHTML?.length || 0
      });
      if (paymentModule) {
        const wasHidden = paymentModule.classList.contains('hidden');
        paymentModule.classList.remove('hidden');
        console.log('[FLOW][setBatchViewState][STEP 2.2] Payment module visibility:', {
          wasHidden,
          nowHidden: paymentModule.classList.contains('hidden')
        });
      } else {
        console.error('[FLOW][setBatchViewState][STEP 2.3] CRITICAL ERROR: Payment module not found!');
      }
      
      console.log('[FLOW][setBatchViewState][STEP 3] Finding all sections...');
      const sections = {
        start: document.getElementById('batchStartSection'),
        entry: document.getElementById('batchEntrySection'),
        preview: document.getElementById('batchPreviewSection'),
        list: document.getElementById('batchesListSection')
      };
      
      console.log('[FLOW][setBatchViewState][STEP 3.1] Section existence check:', {
        start: !!sections.start,
        entry: !!sections.entry,
        preview: !!sections.preview,
        list: !!sections.list
      });
      
      console.log('[FLOW][setBatchViewState][STEP 3.2] Section visibility BEFORE update:', {
        startHidden: sections.start?.classList.contains('hidden'),
        entryHidden: sections.entry?.classList.contains('hidden'),
        previewHidden: sections.preview?.classList.contains('hidden'),
        listHidden: sections.list?.classList.contains('hidden')
      });
      
      console.log('[FLOW][setBatchViewState][STEP 4] Updating section visibility...');
      Object.entries(sections).forEach(([name, el]) => {
        if (!el) {
          if (view === name) {
            console.error('[FLOW][setBatchViewState][STEP 4.' + name + '] CRITICAL ERROR: Target section not found:', name);
            console.error('[Batch] Target section not found:', name);
          } else {
            console.log('[FLOW][setBatchViewState][STEP 4.' + name + '] Section not found (not target):', name);
          }
          return;
        }
        const wasHidden = el.classList.contains('hidden');
        if (view === name) {
          el.classList.remove('hidden');
          console.log('[FLOW][setBatchViewState][STEP 4.' + name + '] Showing section:', {
            name,
            wasHidden,
            nowHidden: el.classList.contains('hidden')
          });
        } else {
          el.classList.add('hidden');
          console.log('[FLOW][setBatchViewState][STEP 4.' + name + '] Hiding section:', {
            name,
            wasHidden,
            nowHidden: el.classList.contains('hidden')
          });
        }
      });
      
      console.log('[FLOW][setBatchViewState][STEP 4.5] Section visibility AFTER update:', {
        startHidden: sections.start?.classList.contains('hidden'),
        entryHidden: sections.entry?.classList.contains('hidden'),
        previewHidden: sections.preview?.classList.contains('hidden'),
        listHidden: sections.list?.classList.contains('hidden')
      });
      
      console.log('[Batch] View switched to:', view);
      debugBatchDom('view-' + view);
      
      console.log('[FLOW][setBatchViewState][STEP 5] Checking target section for scrolling...');
      const target = sections[view];
      if (target) {
        console.log('[FLOW][setBatchViewState][STEP 5.1] Target section found, scheduling scroll');
        requestAnimationFrame(() => {
          console.log('[FLOW][setBatchViewState][STEP 5.2] Executing scroll');
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      } else {
        console.error('[FLOW][setBatchViewState][STEP 5.3] CRITICAL ERROR: Target section not found!');
        console.error('[FLOW][setBatchViewState][STEP 5.4] Payment module innerHTML length:', paymentModule?.innerHTML?.length || 0);
        console.error('[FLOW][setBatchViewState][STEP 5.5] Payment module contains target section:', paymentModule?.innerHTML?.includes(view) || false);
        console.error('[Batch] Target section for view "' + view + '" was not found in DOM.');
      }
      
      console.log('[FLOW][setBatchViewState][STEP 6] Final payment module state:', {
        exists: !!paymentModule,
        hidden: paymentModule?.classList.contains('hidden'),
        innerHTMLLength: paymentModule?.innerHTML?.length || 0,
        targetSectionExists: !!target,
        targetSectionHidden: target?.classList.contains('hidden')
      });
      
      console.log('[FLOW][setBatchViewState][STEP 7] Function END');
    }

    window.startPaymentBatch = function() {
      const userSelect = document.getElementById('batchStartUserSelect');
      const username = userSelect ? userSelect.value.trim() : '';
      
      if (!username) {
        alert('Please select a user before starting a batch.');
        return;
      }
      
      // Calculate day of year (1-365/366)
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);
      
      // Generate batch ID: [username][dayOfYear]
      // Remove spaces from username for the ID
      const usernameForId = username.replace(/\s+/g, '');
      const batchId = `${usernameForId}${dayOfYear}`;
      
      console.log('[Batch] startPaymentBatch() user:', username, 'batchId:', batchId);
      
      window.currentPaymentBatch = {
        id: batchId,
        username: username,
        startedAt: new Date().toISOString(),
        entries: []
      };
      renderBatchPreview();
      
      const activeUserLabel = document.getElementById('activeBatchUser');
      if (activeUserLabel) activeUserLabel.textContent = username;
      
      setBatchViewState('entry');
      addAnotherBatchEntry();
      debugBatchDom('after-start');
    };

    window.cancelCurrentBatch = function() {
      if (!window.currentPaymentBatch) {
        setBatchViewState('start');
        return;
      }
      
      if (!confirm('End the current batch? Unsubmitted entries will be lost.')) {
        return;
      }
      
      window.currentPaymentBatch = null;
      renderBatchPreview();
      setBatchViewState('start');
      console.log('[Batch] Current batch cancelled.');
    };

    window.addAnotherBatchEntry = function() {
      if (!window.currentPaymentBatch) {
        alert('Start a batch before adding entries.');
        return;
      }
      
      setBatchViewState('entry');
      debugBatchDom('add-entry');
      const select = document.getElementById('paymentCustomerSelect');
      if (select) select.value = '';
      hideCustomerPaymentInfo();
      const paymentTypeField = document.getElementById('paymentType');
      if (paymentTypeField) paymentTypeField.value = '';
      const paymentAmountField = document.getElementById('paymentAmount');
      if (paymentAmountField) paymentAmountField.value = '';
      console.log('[Batch] Ready to capture another payment entry.');
    };

    window.viewPaymentBatches = function() {
      renderBatchesList();
      setBatchViewState('list');
      console.log('[Batch] Viewing submitted batches. Count:', window.paymentBatches.length, 'Batches:', window.paymentBatches);
    };

    window.closeBatchList = function() {
      if (window.currentPaymentBatch) {
        setBatchViewState(window.currentPaymentBatch.entries.length ? 'preview' : 'entry');
      } else {
        setBatchViewState('start');
      }
      console.log('[Batch] Closed batch list view.');
    };

    window.submitCurrentBatch = async function() {
      if (!window.currentPaymentBatch) {
        alert('Start a batch before submitting.');
        return;
      }
      
      if (window.currentPaymentBatch.entries.length === 0) {
        alert('Add at least one payment to the batch.');
        return;
      }
      
      const totalAmount = window.currentPaymentBatch.entries.reduce((sum, entry) => sum + entry.amount, 0);
      const submittedBatch = {
        ...window.currentPaymentBatch,
        submittedAt: new Date().toISOString(),
        totalAmount
      };
      
      window.paymentBatches.push(submittedBatch);
      await saveBatchToFirestore(submittedBatch);
      alert('Batch submitted successfully!');
      
      window.currentPaymentBatch = null;
      renderBatchPreview();
      renderBatchesList();
      setBatchViewState('list');
      console.log('[Batch] Batch submitted:', submittedBatch, 'Total submitted:', window.paymentBatches.length);
      viewPaymentBatches();
    };

    function addEntryToCurrentBatch(customer, paymentAmount, paymentType, paymentDate) {
      console.log('[FLOW][addEntryToCurrentBatch][STEP 1] Function START');
      console.log('[FLOW][addEntryToCurrentBatch][STEP 1.1] Checking current batch...');
      if (!window.currentPaymentBatch) {
        console.error('[FLOW][addEntryToCurrentBatch][STEP 1.1] ERROR: No current batch active!');
        console.warn('[Batch] Attempted to add entry, but no current batch is active.');
        return;
      }
      console.log('[FLOW][addEntryToCurrentBatch][STEP 1.2] Current batch exists:', {
        id: window.currentPaymentBatch.id,
        username: window.currentPaymentBatch.username,
        currentEntries: window.currentPaymentBatch.entries.length
      });
      
      console.log('[FLOW][addEntryToCurrentBatch][STEP 2] Checking payment module state...');
      const paymentModule = document.getElementById('paymentModule');
      console.log('[FLOW][addEntryToCurrentBatch][STEP 2.1] Payment module:', {
        exists: !!paymentModule,
        hidden: paymentModule?.classList.contains('hidden'),
        innerHTMLLength: paymentModule?.innerHTML?.length || 0
      });
      
      console.log('[FLOW][addEntryToCurrentBatch][STEP 3] Creating entry object...');
      const entry = {
        id: `ENTRY-${Date.now()}`,
        customerName: customer.name,
        accountNumber: customer.accountNumber || customer.id,
        property: customer.address || 'N/A',
        paymentType,
        amount: paymentAmount,
        date: paymentDate
      };
      console.log('[FLOW][addEntryToCurrentBatch][STEP 3.1] Entry object:', entry);
      
      console.log('[FLOW][addEntryToCurrentBatch][STEP 4] Adding entry to batch...');
      window.currentPaymentBatch.entries.push(entry);
      console.log('[FLOW][addEntryToCurrentBatch][STEP 4.1] Entry added. Total entries:', window.currentPaymentBatch.entries.length);
      
      console.log('[FLOW][addEntryToCurrentBatch][STEP 5] Checking DOM elements before render...');
      const previewSectionBefore = document.getElementById('batchPreviewSection');
      const previewTableBefore = document.getElementById('batchPreviewTable');
      console.log('[FLOW][addEntryToCurrentBatch][STEP 5.1] Preview section exists:', !!previewSectionBefore);
      console.log('[FLOW][addEntryToCurrentBatch][STEP 5.2] Preview table exists:', !!previewTableBefore);
      console.log('[FLOW][addEntryToCurrentBatch][STEP 5.3] Preview section hidden:', previewSectionBefore?.classList.contains('hidden'));
      
      // Render the preview table first
      console.log('[FLOW][addEntryToCurrentBatch][STEP 6] Calling renderBatchPreview...');
      renderBatchPreview();
      console.log('[FLOW][addEntryToCurrentBatch][STEP 6.1] renderBatchPreview complete');
      
      console.log('[FLOW][addEntryToCurrentBatch][STEP 7] Checking DOM elements after render...');
      const previewSectionAfter = document.getElementById('batchPreviewSection');
      const previewTableAfter = document.getElementById('batchPreviewTable');
      console.log('[FLOW][addEntryToCurrentBatch][STEP 7.1] Preview section exists:', !!previewSectionAfter);
      console.log('[FLOW][addEntryToCurrentBatch][STEP 7.2] Preview table exists:', !!previewTableAfter);
      console.log('[FLOW][addEntryToCurrentBatch][STEP 7.3] Preview section hidden:', previewSectionAfter?.classList.contains('hidden'));
      console.log('[FLOW][addEntryToCurrentBatch][STEP 7.4] Preview table innerHTML length:', previewTableAfter?.innerHTML?.length || 0);
      
      // Then switch to preview view - ensure preview section exists and is visible
      console.log('[FLOW][addEntryToCurrentBatch][STEP 8] Verifying preview section exists...');
      const previewSection = document.getElementById('batchPreviewSection');
      if (!previewSection) {
        console.error('[FLOW][addEntryToCurrentBatch][STEP 8.1] CRITICAL ERROR: Preview section not found!');
        console.error('[FLOW][addEntryToCurrentBatch][STEP 8.2] Payment module innerHTML length:', paymentModule?.innerHTML?.length || 0);
        console.error('[FLOW][addEntryToCurrentBatch][STEP 8.3] Payment module contains batchPreviewSection:', paymentModule?.innerHTML?.includes('batchPreviewSection') || false);
        console.error('[Batch] Preview section not found! Cannot show preview.');
        return;
      }
      console.log('[FLOW][addEntryToCurrentBatch][STEP 8.4] Preview section found');
      
      console.log('[FLOW][addEntryToCurrentBatch][STEP 9] Calling setBatchViewState("preview")...');
      console.log('[FLOW][addEntryToCurrentBatch][STEP 9.1] State before setBatchViewState:', {
        startHidden: document.getElementById('batchStartSection')?.classList.contains('hidden'),
        entryHidden: document.getElementById('batchEntrySection')?.classList.contains('hidden'),
        previewHidden: document.getElementById('batchPreviewSection')?.classList.contains('hidden'),
        listHidden: document.getElementById('batchesListSection')?.classList.contains('hidden')
      });
      setBatchViewState('preview');
      console.log('[FLOW][addEntryToCurrentBatch][STEP 9.2] setBatchViewState complete');
      console.log('[FLOW][addEntryToCurrentBatch][STEP 9.3] State after setBatchViewState:', {
        startHidden: document.getElementById('batchStartSection')?.classList.contains('hidden'),
        entryHidden: document.getElementById('batchEntrySection')?.classList.contains('hidden'),
        previewHidden: document.getElementById('batchPreviewSection')?.classList.contains('hidden'),
        listHidden: document.getElementById('batchesListSection')?.classList.contains('hidden')
      });
      
      // IMMEDIATE: Force preview section visible right after setBatchViewState
      const immediatePreviewSection = document.getElementById('batchPreviewSection');
      if (immediatePreviewSection) {
        // Remove hidden class
        immediatePreviewSection.classList.remove('hidden');
        
        // FORCE visibility with inline styles that override everything
        immediatePreviewSection.style.cssText = `
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          position: relative !important;
          width: 100% !important;
        `;
        console.log('[FLOW][addEntryToCurrentBatch][STEP 9.4] Forced preview section visible');
        
        // Check parent containers
        let parent = immediatePreviewSection.parentElement;
        let depth = 0;
        while (parent && depth < 5) {
          const parentStyle = window.getComputedStyle(parent);
          console.log(`[FLOW][addEntryToCurrentBatch][STEP 9.4.${depth}] Parent ${depth} (${parent.tagName}):`, {
            display: parentStyle.display,
            visibility: parentStyle.visibility,
            opacity: parentStyle.opacity,
            width: parentStyle.width,
            height: parentStyle.height,
            hidden: parent.classList.contains('hidden')
          });
          
          // Force parent visible if needed
          if (parent.classList.contains('hidden')) {
            parent.classList.remove('hidden');
            parent.style.display = 'block';
            parent.style.visibility = 'visible';
            parent.style.opacity = '1';
            console.log(`[FLOW][addEntryToCurrentBatch][STEP 9.4.${depth}] Forced parent visible`);
          }
          
          parent = parent.parentElement;
          depth++;
        }
        
        const immediateRect = immediatePreviewSection.getBoundingClientRect();
        console.log('[FLOW][addEntryToCurrentBatch][STEP 9.4] IMMEDIATE preview section check:', {
          exists: true,
          hidden: immediatePreviewSection.classList.contains('hidden'),
          display: window.getComputedStyle(immediatePreviewSection).display,
          visibility: window.getComputedStyle(immediatePreviewSection).visibility,
          opacity: window.getComputedStyle(immediatePreviewSection).opacity,
          width: window.getComputedStyle(immediatePreviewSection).width,
          height: window.getComputedStyle(immediatePreviewSection).height,
          boundingRect: {
            top: immediateRect.top,
            left: immediateRect.left,
            width: immediateRect.width,
            height: immediateRect.height,
            visible: immediateRect.width > 0 && immediateRect.height > 0
          }
        });
        
        // Force scroll into view immediately
        immediatePreviewSection.scrollIntoView({ behavior: 'auto', block: 'start', inline: 'nearest' });
        
        // Also ensure payment module is visible
        if (paymentModule) {
          paymentModule.classList.remove('hidden');
          paymentModule.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          `;
          console.log('[FLOW][addEntryToCurrentBatch][STEP 9.4] Forced payment module visible');
        }
      } else {
        console.error('[FLOW][addEntryToCurrentBatch][STEP 9.4] CRITICAL: Preview section not found immediately after setBatchViewState!');
      }
      
      // Double-check preview section is visible
      console.log('[FLOW][addEntryToCurrentBatch][STEP 10] Final visibility check...');
      
      // Force payment module visible
      if (paymentModule.classList.contains('hidden')) {
        console.warn('[FLOW][addEntryToCurrentBatch][STEP 10.0] WARNING: Payment module was hidden, forcing visible!');
        paymentModule.classList.remove('hidden');
      }
      
      // Force preview section visible
      if (previewSection.classList.contains('hidden')) {
        console.warn('[FLOW][addEntryToCurrentBatch][STEP 10.1] WARNING: Preview section was hidden, forcing it visible.');
        previewSection.classList.remove('hidden');
        console.log('[FLOW][addEntryToCurrentBatch][STEP 10.2] Preview section forced visible');
      } else {
        console.log('[FLOW][addEntryToCurrentBatch][STEP 10.3] Preview section is visible');
      }
      
      // Check computed styles to verify visibility
      const previewSectionStyle = window.getComputedStyle(previewSection);
      const paymentModuleStyle = window.getComputedStyle(paymentModule);
      console.log('[FLOW][addEntryToCurrentBatch][STEP 10.4] Computed styles check:', {
        previewDisplay: previewSectionStyle.display,
        previewVisibility: previewSectionStyle.visibility,
        previewOpacity: previewSectionStyle.opacity,
        previewHeight: previewSectionStyle.height,
        paymentModuleDisplay: paymentModuleStyle.display,
        paymentModuleVisibility: paymentModuleStyle.visibility,
        paymentModuleOpacity: paymentModuleStyle.opacity
      });
      
      // Final verification after a short delay
      setTimeout(() => {
        const finalPreviewSection = document.getElementById('batchPreviewSection');
        const finalPaymentModule = document.getElementById('paymentModule');
        const finalTable = document.getElementById('batchPreviewTable');
        console.log('[FLOW][addEntryToCurrentBatch][STEP 10.5] DELAYED VERIFICATION (100ms later):', {
          paymentModuleExists: !!finalPaymentModule,
          paymentModuleHidden: finalPaymentModule?.classList.contains('hidden'),
          paymentModuleInnerHTMLLength: finalPaymentModule?.innerHTML?.length || 0,
          previewSectionExists: !!finalPreviewSection,
          previewSectionHidden: finalPreviewSection?.classList.contains('hidden'),
          previewTableExists: !!finalTable,
          previewTableInnerHTMLLength: finalTable?.innerHTML?.length || 0,
          hasCurrentBatch: !!window.currentPaymentBatch,
          batchEntries: window.currentPaymentBatch?.entries?.length || 0
        });
        
        // AGGRESSIVE: Force everything visible
        if (finalPaymentModule) {
          finalPaymentModule.classList.remove('hidden');
          finalPaymentModule.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          `;
        }
        
        if (finalPreviewSection) {
          finalPreviewSection.classList.remove('hidden');
          // FORCE visibility without breaking layout
          finalPreviewSection.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
          `;
          
          // Force the table inside to be visible too
          if (finalTable) {
            finalTable.style.cssText = `
              display: table !important;
              visibility: visible !important;
              width: 100% !important;
            `;
          }
          
          // Scroll preview section into view
          finalPreviewSection.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
          
          // Check bounding rect to verify it's actually visible
          const rect = finalPreviewSection.getBoundingClientRect();
          console.log('[FLOW][addEntryToCurrentBatch][STEP 10.6] Preview section bounding rect:', {
            top: rect.top,
            left: rect.left,
            width: rect.width,
            height: rect.height,
            visible: rect.width > 0 && rect.height > 0 && rect.top < window.innerHeight && rect.bottom > 0
          });
          
          // If still zero dimensions, try even more aggressive approach
          if (rect.width === 0 || rect.height === 0) {
            console.error('[FLOW][addEntryToCurrentBatch][STEP 10.6.1] CRITICAL: Preview section still has zero dimensions! Trying nuclear option...');
            // Try appending to body temporarily to see if it's a parent issue
            const originalParent = finalPreviewSection.parentElement;
            document.body.appendChild(finalPreviewSection);
            const bodyRect = finalPreviewSection.getBoundingClientRect();
            console.log('[FLOW][addEntryToCurrentBatch][STEP 10.6.2] When appended to body:', {
              width: bodyRect.width,
              height: bodyRect.height
            });
            // Put it back
            originalParent.appendChild(finalPreviewSection);
          }
        }
        
        if (finalTable) {
          const tableRect = finalTable.getBoundingClientRect();
          console.log('[FLOW][addEntryToCurrentBatch][STEP 10.7] Preview table bounding rect:', {
            top: tableRect.top,
            left: tableRect.left,
            width: tableRect.width,
            height: tableRect.height,
            visible: tableRect.width > 0 && tableRect.height > 0
          });
        }
      }, 100);
      
      console.log('[FLOW][addEntryToCurrentBatch][STEP 11] Final payment module state:', {
        exists: !!paymentModule,
        hidden: paymentModule?.classList.contains('hidden'),
        innerHTMLLength: paymentModule?.innerHTML?.length || 0,
        hasPreviewSection: !!paymentModule?.querySelector('#batchPreviewSection'),
        previewSectionHidden: paymentModule?.querySelector('#batchPreviewSection')?.classList.contains('hidden'),
        previewTableExists: !!paymentModule?.querySelector('#batchPreviewTable'),
        previewTableContent: paymentModule?.querySelector('#batchPreviewTable')?.innerHTML?.substring(0, 100) || 'N/A',
        previewSectionDisplay: window.getComputedStyle(paymentModule?.querySelector('#batchPreviewSection') || {}).display || 'N/A'
      });
      
      console.log('[Batch] Entry added to current batch:', { customer: customer.name, paymentAmount, paymentType, totalEntries: window.currentPaymentBatch.entries.length });
      debugBatchDom('after-add-entry');
      console.log('[FLOW][addEntryToCurrentBatch][STEP 12] Function END');
    }

    function renderBatchPreview() {
      console.log('[FLOW][renderBatchPreview][STEP 1] Function START');
      console.log('[FLOW][renderBatchPreview][STEP 1.1] Checking payment module...');
      const paymentModule = document.getElementById('paymentModule');
      console.log('[FLOW][renderBatchPreview][STEP 1.2] Payment module:', {
        exists: !!paymentModule,
        hidden: paymentModule?.classList.contains('hidden'),
        innerHTMLLength: paymentModule?.innerHTML?.length || 0
      });
      
      console.log('[FLOW][renderBatchPreview][STEP 2] Looking for batchPreviewTable...');
      const tbody = document.getElementById('batchPreviewTable');
      console.log('[FLOW][renderBatchPreview][STEP 2.1] Table body found:', !!tbody);
      if (!tbody) {
        console.error('[FLOW][renderBatchPreview][STEP 2.2] CRITICAL ERROR: Table body not found!');
        console.error('[Batch] renderBatchPreview: table body not found. Payment module may have been reset.');
        debugBatchDom('renderPreview-missing');
        // Try to find the payment module and check if it exists
        const paymentModule = document.getElementById('paymentModule');
        if (!paymentModule) {
          console.error('[FLOW][renderBatchPreview][STEP 2.3] Payment module itself is missing!');
          console.error('[Batch] Payment module itself is missing!');
        } else {
          console.error('[FLOW][renderBatchPreview][STEP 2.4] Payment module exists but table missing:', {
            innerHTMLLength: paymentModule.innerHTML.length,
            containsBatchPreview: paymentModule.innerHTML.includes('batchPreview'),
            containsBatchPreviewTable: paymentModule.innerHTML.includes('batchPreviewTable'),
            containsBatchPreviewSection: paymentModule.innerHTML.includes('batchPreviewSection')
          });
          console.log('[Batch] Payment module exists, but batchPreviewTable is missing. Current innerHTML length:', paymentModule.innerHTML.length);
        }
        return;
      }
      console.log('[FLOW][renderBatchPreview][STEP 2.5] Table body found, checking parent...');
      console.log('[FLOW][renderBatchPreview][STEP 2.6] Table body parent:', {
        tagName: tbody.parentElement?.tagName,
        id: tbody.parentElement?.id,
        hidden: tbody.parentElement?.classList.contains('hidden')
      });
      
      console.log('[FLOW][renderBatchPreview][STEP 3] Checking current batch...');
      const batch = window.currentPaymentBatch;
      console.log('[FLOW][renderBatchPreview][STEP 3.1] Current batch:', {
        exists: !!batch,
        id: batch?.id,
        entriesCount: batch?.entries?.length || 0
      });
      
      if (!batch || batch.entries.length === 0) {
        console.log('[FLOW][renderBatchPreview][STEP 3.2] No entries, showing empty message');
        tbody.innerHTML = `<tr><td colspan="6" class="batch-empty-message">No payments added yet.</td></tr>`;
        console.log('[Batch] renderBatchPreview: no entries to display.');
        console.log('[FLOW][renderBatchPreview][STEP 3.3] Function END (no entries)');
        return;
      }
      
      console.log('[FLOW][renderBatchPreview][STEP 4] Building table rows...');
      let rows = '';
      let total = 0;
      batch.entries.forEach((entry, index) => {
        console.log('[FLOW][renderBatchPreview][STEP 4.' + (index + 1) + '] Processing entry:', {
          index,
          customerName: entry.customerName,
          amount: entry.amount
        });
        total += entry.amount;
        rows += `
          <tr>
            <td class="batch-col-date">${entry.date}</td>
            <td class="batch-col-customer">${entry.customerName}</td>
            <td class="batch-col-account">${entry.accountNumber}</td>
            <td class="batch-col-property">${entry.property}</td>
            <td class="batch-col-type">${entry.paymentType}</td>
            <td class="batch-col-amount">$${entry.amount.toFixed(2)}</td>
          </tr>
        `;
      });
      console.log('[FLOW][renderBatchPreview][STEP 4.' + (batch.entries.length + 1) + '] Total calculated:', total);
      
      console.log('[FLOW][renderBatchPreview][STEP 5] Adding total row...');
      rows += `
        <tr class="batch-total-row">
          <td colspan="5" class="batch-total-label">Total</td>
          <td class="batch-col-amount batch-total-amount">$${total.toFixed(2)}</td>
        </tr>
      `;
      console.log('[FLOW][renderBatchPreview][STEP 5.1] Rows HTML length:', rows.length);
      
      console.log('[FLOW][renderBatchPreview][STEP 6] Setting table body innerHTML...');
      console.log('[FLOW][renderBatchPreview][STEP 6.1] Table body before update:', {
        innerHTMLLength: tbody.innerHTML.length,
        first100Chars: tbody.innerHTML.substring(0, 100)
      });
      tbody.innerHTML = rows;
      console.log('[FLOW][renderBatchPreview][STEP 6.2] Table body after update:', {
        innerHTMLLength: tbody.innerHTML.length,
        first100Chars: tbody.innerHTML.substring(0, 100),
        containsTotal: tbody.innerHTML.includes('Total')
      });
      
      console.log('[Batch] renderBatchPreview: entries rendered =', batch.entries.length, 'Total = $' + total.toFixed(2));
      console.log('[FLOW][renderBatchPreview][STEP 7] Function END');
    }

    function renderBatchesList() {
      const tbody = document.getElementById('batchesListTable');
      if (!tbody) {
        console.warn('[Batch] renderBatchesList: table body not found.');
        debugBatchDom('renderList-missing');
        return;
      }
      
      if (!window.paymentBatches || window.paymentBatches.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-3 text-center text-sm text-slate-500">No batches submitted yet.</td></tr>`;
        console.log('[Batch] renderBatchesList: no submitted batches.');
        return;
      }
      
      let rows = '';
      window.paymentBatches.slice().reverse().forEach(batch => {
        const submitted = batch.submittedAt ? new Date(batch.submittedAt).toLocaleString() : 'â€”';
        rows += `
          <tr>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.id}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.username}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.entries.length}</td>
            <td class="px-4 py-2 text-sm text-slate-700 text-right">$${(batch.totalAmount || 0).toFixed(2)}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${submitted}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = rows;
      console.log('[Batch] renderBatchesList: batches rendered =', window.paymentBatches.length);
    }

    // Add Client Module Functions
    function populateAddClientLocationSelect() {
      const select = document.getElementById('newClientLocation');
      select.innerHTML = '<option value="">Choose a location...</option><option value="add-new">+ Add New Location</option>';
      
      // Show all locations, not just available ones
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = `${location.address} (${location.status})`;
        select.appendChild(option);
      });
      
      // Add event listener for add new location
      select.addEventListener('change', function() {
        if (this.value === 'add-new') {
          showAddLocationModal();
        }
      });
    }

    window.addClientFromModule = async function() {
      const name = document.getElementById('newClientName').value.trim();
      const email = document.getElementById('newClientEmail').value.trim();
      const phone = document.getElementById('newClientPhone').value.replace(/\D/g, '');
      const locationId = document.getElementById('newClientLocation').value;
      
      // Get new fields
      const entityType = document.getElementById('newClientEntityType')?.value || '';
      const ssn = document.getElementById('newClientSSN')?.value.trim() || '';
      const idType = document.getElementById('newClientIDType')?.value || '';
      const idNumber = document.getElementById('newClientIDNumber')?.value.trim() || '';
      const secondaryContactName = document.getElementById('newClientSecondaryContactName')?.value.trim() || '';
      const secondaryContactPhone = document.getElementById('newClientSecondaryContactPhone')?.value.replace(/\D/g, '') || '';
      const mailingStreet = document.getElementById('newClientMailingStreet')?.value.trim() || '';
      const mailingCity = document.getElementById('newClientMailingCity')?.value.trim() || '';
      const mailingState = document.getElementById('newClientMailingState')?.value || '';
      const mailingZip = document.getElementById('newClientMailingZip')?.value.trim() || '';
      
      // Build mailing address
      let mailingAddress = '';
      if (mailingStreet || mailingCity || mailingState || mailingZip) {
        const parts = [];
        if (mailingStreet) parts.push(mailingStreet);
        if (mailingCity || mailingState || mailingZip) {
          const cityStateZip = [mailingCity, mailingState, mailingZip].filter(Boolean).join(', ');
          parts.push(cityStateZip);
        }
        mailingAddress = parts.join(', ');
      }

      // Get selected codes
      const selectedCodes = window.selectedClientCodes.map(code => ({
        id: code.id,
        name: code.name,
        percentage: code.percentage
      }));

      // Get factor
      const factor = document.getElementById('newClientFactor')?.value.trim() || '';
      
      if (!name || !email || !phone || !locationId) {
        alert('Please fill in all required fields');
        return;
      }
      
      if (locationId === 'add-new') {
        alert('Please select a location or add a new one first');
        return;
      }
      
      const selectedLocation = locations.find(l => l.id === locationId);
      if (!selectedLocation) {
        alert('Selected location not found');
        return;
      }
      
      // Check if location is already occupied
      if (selectedLocation.status === 'occupied' && selectedLocation.currentResident) {
        const currentResident = customers.find(c => c.name === selectedLocation.currentResident);
        if (currentResident) {
          showTransferOwnershipModal(selectedLocation, currentResident, { 
            name, 
            email, 
            phone,
            entityType,
            ssn,
            idType,
            idNumber,
            secondaryContactName,
            secondaryContactPhone,
            mailingAddress,
            mailingStreet,
            mailingCity,
            mailingState,
            mailingZip,
            codes: selectedCodes,
            factor: factor
          });
          return;
        }
      }
      
      // Create new customer (same logic as existing addCustomer function)
      const newCustomer = {
        id: 'CUS-' + String(Date.now()).slice(-6), // Use accountNumber as ID
        name: name,
        email: email,
        phone: phone,
        address: selectedLocation.address,
        accountNumber: 'CUS-' + String(Date.now()).slice(-6),
        currentBill: 170,
        pastDue: 0,
        lastPayment: 'Never',
        paymentHistory: [],
        needsPasswordChange: true,
        createdDate: new Date().toISOString(),
        entityType: entityType,
        ssn: ssn,
        idType: idType,
        idNumber: idNumber,
        secondaryContactName: secondaryContactName,
        secondaryContactPhone: secondaryContactPhone,
        mailingAddress: mailingAddress,
        mailingStreet: mailingStreet,
        mailingCity: mailingCity,
        mailingState: mailingState,
        mailingZip: mailingZip,
        codes: selectedCodes,
        factor: factor
      };
      
      // Update payment status based on past due amount
      updateCustomerPaymentStatus(newCustomer);
      
      customers.push(newCustomer);
      filteredCustomers = [...customers];
      
      // Update location
      selectedLocation.currentResident = name;
      selectedLocation.status = 'occupied';
      selectedLocation.ownerFullName = name;
      const nameParts = name.split(' ');
      selectedLocation.ownerFirstName = nameParts[0] || '';
      selectedLocation.ownerLastName = nameParts.slice(1).join(' ') || '';
      
      // Clear selected codes after creation
      window.selectedClientCodes = [];
      updateClientCodesList();
      
      // Save to Firestore
      await saveCustomersToFirestore();
      await saveLocationsToFirestore();
      updateDashboard();
      
      // Show success screen instead of hiding module
      showClientSuccessScreen();
    };

    // Show client success screen
    window.showClientSuccessScreen = function() {
      const addClientModule = document.getElementById('addClientModule');
      addClientModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Client Successfully Added!</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          
          <h4 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Client Added Successfully!</h4>
          <p class="text-slate-600 dark:text-slate-400 mb-8">The client has been added to the system successfully</p>
          
          <div class="flex flex-col gap-4 justify-center">
            <button 
              onclick="resetAddClientForm()" 
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Add Another Client
            </button>
            <button 
              onclick="hideAllModules()" 
              class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Exit
            </button>
          </div>
        </div>
      `;
    };

    // Reset add client form
    window.resetAddClientForm = function() {
      const addClientModule = document.getElementById('addClientModule');
      addClientModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Client</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Account Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              type="text" 
              id="newClientName" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter full name"
              required
            >
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
            <input 
              type="email" 
              id="newClientEmail" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter email address"
              required
            >
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <input 
              type="tel" 
              id="newClientPhone" 
              oninput="formatPhoneInput(this)"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="(xxx)-xxx-xxxx"
              required
            >
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <select id="newClientLocation" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" required>
              <option value="">Choose a location...</option>
              <option value="add-new">+ Add New Location</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <select id="newClientEntityType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Select Entity Type</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Farmer">Farmer</option>
            </select>
          </div>
        </div>
        </div>

        <!-- Identification Info Section -->
        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Identification Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
              <input 
                type="text" 
                id="newClientSSN" 
                oninput="formatSSNInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="xxx-xx-xxxx"
                maxlength="11"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
              <select id="newClientIDType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Select ID Type</option>
                <option value="Drivers License">Drivers License</option>
                <option value="ID">ID</option>
                <option value="Passport">Passport</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
              <input 
                type="text" 
                id="newClientIDNumber" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter ID number"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
              <input 
                type="text" 
                id="newClientSecondaryContactName" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter secondary contact name"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
              <input 
                type="tel" 
                id="newClientSecondaryContactPhone" 
                oninput="formatPhoneInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="(xxx)-xxx-xxxx"
              >
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
              <input 
                type="text" 
                id="newClientMailingStreet" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter street address"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <input 
                type="text" 
                id="newClientMailingCity" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter city"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <select id="newClientMailingState" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Select State</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
              <input 
                type="text" 
                id="newClientMailingZip" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter ZIP code"
                maxlength="10"
              >
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
          <div id="newClientCodesList" class="space-y-2">
            <!-- Selected codes will be displayed here -->
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
            <input 
              type="number" 
              id="newClientFactor" 
              step="any"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter factor"
            >
          </div>
        </div>
        
        <div class="mt-6">
          <button 
            onclick="addClientFromModule()" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
          >
            Create Client Account
          </button>
        </div>
      `;
      
      // Repopulate the location dropdown
      populateAddClientLocationSelect();
      // Populate codes dropdown
      populateAddClientCodeSelect();
      // Clear selected codes
      window.selectedClientCodes = [];
      updateClientCodesList();
      
      // Add event listener to Entity Type dropdown for auto-adding codes
      const entityTypeSelect = document.getElementById('newClientEntityType');
      if (entityTypeSelect) {
        // Remove existing listeners by cloning the element
        const newEntityTypeSelect = entityTypeSelect.cloneNode(true);
        entityTypeSelect.parentNode.replaceChild(newEntityTypeSelect, entityTypeSelect);
        
        newEntityTypeSelect.addEventListener('change', function() {
          const selectedEntityType = this.value;
          // Auto-add matching codes based on Entity Type
          autoAddCodesForEntityType(selectedEntityType);
        });
      }
    };

    // Check if a code matches the selected Entity Type
    function codeMatchesEntityType(code, entityType) {
      if (!entityType || !code.requirements) {
        return false;
      }
      
      // Handle new requirements structure with AND/OR logic
      if (code.requirements && code.requirements.values && Array.isArray(code.requirements.values)) {
        const entityTypeInValues = code.requirements.values.includes(entityType);
        
        if (code.requirements.type === 'OR') {
          // OR logic: Entity Type must be in the values array
          return entityTypeInValues;
        } else if (code.requirements.type === 'AND') {
          // AND logic: For now, we'll check if Entity Type is in values
          // (Full AND logic would require Entity Type to match all values, which isn't possible with single selection)
          return entityTypeInValues;
        }
      }
      
      // Handle old array format (backward compatibility)
      if (Array.isArray(code.requirements)) {
        return code.requirements.includes(entityType);
      }
      
      return false;
    }

    // Automatically add codes based on Entity Type
    function autoAddCodesForEntityType(entityType) {
      if (!entityType) {
        return;
      }
      
      // Check each code to see if it matches the Entity Type
      codes.forEach(code => {
        if (codeMatchesEntityType(code, entityType)) {
          // Check if code is already added
          if (!window.selectedClientCodes.find(c => c.id === code.id)) {
            window.selectedClientCodes.push(code);
          }
        }
      });
      
      updateClientCodesList();
    }

    // Populate codes dropdown for Add Client form
    function populateAddClientCodeSelect() {
      const select = document.getElementById('newClientCodeSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">Select a code...</option>';
      codes.forEach(code => {
        const option = document.createElement('option');
        option.value = code.id;
        option.textContent = `${code.name} (${code.percentage}%)`;
        select.appendChild(option);
      });
    }

    // Initialize selected codes array
    window.selectedClientCodes = [];
    window.selectedCustomerCodes = [];

    // Add code to client
    window.addClientCode = function() {
      const select = document.getElementById('newClientCodeSelect');
      if (!select || !select.value) {
        alert('Please select a code first');
        return;
      }

      const codeId = select.value;
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      // Check if already added
      if (window.selectedClientCodes.find(c => c.id === codeId)) {
        alert('This code has already been added');
        select.value = '';
        return;
      }

      window.selectedClientCodes.push(code);
      select.value = '';
      updateClientCodesList();
    };

    // Remove code from client
    window.removeClientCode = function(codeId) {
      window.selectedClientCodes = window.selectedClientCodes.filter(c => c.id !== codeId);
      updateClientCodesList();
    };

    // Update codes list display
    function updateClientCodesList() {
      const listContainer = document.getElementById('newClientCodesList');
      if (!listContainer) return;

      if (window.selectedClientCodes.length === 0) {
        listContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400">No codes selected</p>';
        return;
      }

      listContainer.innerHTML = window.selectedClientCodes.map(code => `
        <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
          <span class="text-sm text-slate-800 dark:text-slate-200">${code.name} (${code.percentage}%)</span>
          <button 
            type="button"
            onclick="removeClientCode('${code.id}')" 
            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-sm"
          >
            Remove
          </button>
        </div>
      `).join('');
    }

    // Add code to customer (for Add Customer modal)
    window.addCustomerCode = function() {
      const select = document.getElementById('newCustomerCodeSelect');
      if (!select || !select.value) {
        alert('Please select a code first');
        return;
      }

      const codeId = select.value;
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      // Check if already added
      if (window.selectedCustomerCodes.find(c => c.id === codeId)) {
        alert('This code has already been added');
        select.value = '';
        return;
      }

      window.selectedCustomerCodes.push(code);
      select.value = '';
      updateCustomerCodesList();
    };

    // Remove code from customer
    window.removeCustomerCode = function(codeId) {
      window.selectedCustomerCodes = window.selectedCustomerCodes.filter(c => c.id !== codeId);
      updateCustomerCodesList();
    };

    // Update customer codes list display
    function updateCustomerCodesList() {
      const listContainer = document.getElementById('newCustomerCodesList');
      if (!listContainer) return;

      if (window.selectedCustomerCodes.length === 0) {
        listContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400">No codes selected</p>';
        return;
      }

      listContainer.innerHTML = window.selectedCustomerCodes.map(code => `
        <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
          <span class="text-sm text-slate-800 dark:text-slate-200">${code.name} (${code.percentage}%)</span>
          <button 
            type="button"
            onclick="removeCustomerCode('${code.id}')" 
            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-sm"
          >
            Remove
          </button>
        </div>
      `).join('');
    }

    // Search Module Functions
    window.performSearch = function() {
      const nameQuery = document.getElementById('searchByName').value.toLowerCase().trim();
      const statusFilter = document.getElementById('searchByStatus').value;
      
      let results = customers;
      
      // Filter by name
      if (nameQuery) {
        results = results.filter(customer => 
          customer.name.toLowerCase().includes(nameQuery)
        );
      }
      
      // Filter by status
      if (statusFilter) {
        results = results.filter(customer => 
          customer.paymentStatus === statusFilter
        );
      }
      
      displaySearchResults(results);
    };

    window.clearSearch = function() {
      document.getElementById('searchByName').value = '';
      document.getElementById('searchByStatus').value = '';
      document.getElementById('searchResults').innerHTML = '';
    };

    function displaySearchResults(results) {
      const container = document.getElementById('searchResults');
      
      if (results.length === 0) {
        container.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">No customers found matching your search criteria.</p>';
        return;
      }
      
      let html = '<div class="space-y-4">';
      results.forEach(customer => {
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0;
        const totalAmount = serviceCost + lateFee;
        
        const statusClass = customer.paymentStatus === 'overdue' ? 
          'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
          customer.paymentStatus === 'inactive' ?
          'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200' :
          customer.paymentStatus === 'pending closing' ?
          'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
          'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        
        html += `
          <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-semibold text-slate-800 dark:text-slate-200">${customer.name}</h4>
                <p class="text-sm text-slate-600 dark:text-slate-400">${customer.email}</p>
                <p class="text-sm text-slate-600 dark:text-slate-400">${customer.accountNumber}</p>
              </div>
              <div class="text-right">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                  ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
                </span>
                <p class="text-lg font-semibold text-slate-800 dark:text-slate-200 mt-2">$${totalAmount.toFixed(2)}</p>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    // Add new customer
    window.showAddCustomerModal = function() {
      // Populate location dropdown with all locations
      const locationSelect = document.getElementById('newCustomerLocation');
      locationSelect.innerHTML = '<option value="">Select a property location</option>';
      
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = `${location.address} (${location.status})`;
        locationSelect.appendChild(option);
      });

      // Populate codes dropdown
      const codeSelect = document.getElementById('newCustomerCodeSelect');
      if (codeSelect) {
        codeSelect.innerHTML = '<option value="">Select a code...</option>';
        codes.forEach(code => {
          const option = document.createElement('option');
          option.value = code.id;
          option.textContent = `${code.name} (${code.percentage}%)`;
          codeSelect.appendChild(option);
        });
      }

      // Clear selected codes
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();
      
      document.getElementById('addCustomerModal').classList.remove('hidden');
    };

    window.hideAddCustomerModal = function() {
      document.getElementById('addCustomerModal').classList.add('hidden');
      document.getElementById('addCustomerForm').reset();
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();
    };

    window.addCustomer = async function() {
      const name = document.getElementById('newCustomerName').value;
      const email = document.getElementById('newCustomerEmail').value;
      const locationId = document.getElementById('newCustomerLocation').value;
      const phone = document.getElementById('newCustomerPhone').value.replace(/\D/g, ''); // Store as digits only
      
      // Get new fields
      const entityType = document.getElementById('newCustomerEntityType')?.value || '';
      const ssn = document.getElementById('newCustomerSSN')?.value.trim() || '';
      const idType = document.getElementById('newCustomerIDType')?.value || '';
      const idNumber = document.getElementById('newCustomerIDNumber')?.value.trim() || '';
      const secondaryContactName = document.getElementById('newCustomerSecondaryContactName')?.value.trim() || '';
      const secondaryContactPhone = document.getElementById('newCustomerSecondaryContactPhone')?.value.replace(/\D/g, '') || '';
      const mailingStreet = document.getElementById('newCustomerMailingStreet')?.value.trim() || '';
      const mailingCity = document.getElementById('newCustomerMailingCity')?.value.trim() || '';
      const mailingState = document.getElementById('newCustomerMailingState')?.value || '';
      const mailingZip = document.getElementById('newCustomerMailingZip')?.value.trim() || '';
      
      // Build mailing address
      let mailingAddress = '';
      if (mailingStreet || mailingCity || mailingState || mailingZip) {
        const parts = [];
        if (mailingStreet) parts.push(mailingStreet);
        if (mailingCity || mailingState || mailingZip) {
          const cityStateZip = [mailingCity, mailingState, mailingZip].filter(Boolean).join(', ');
          parts.push(cityStateZip);
        }
        mailingAddress = parts.join(', ');
      }

      // Get selected codes
      const selectedCodes = window.selectedCustomerCodes.map(code => ({
        id: code.id,
        name: code.name,
        percentage: code.percentage
      }));

      // Get factor
      const factor = document.getElementById('newCustomerFactor')?.value.trim() || '';
      
      if (!name || !email || !locationId || !phone) {
        alert('Please fill in all required fields');
        return;
      }
      
      // Find the selected location
      const selectedLocation = locations.find(l => l.id === locationId);
      if (!selectedLocation) {
        alert('Selected location not found');
        return;
      }
      
      if (selectedLocation.status === 'occupied') {
        alert('This location is already occupied. Please select an available location.');
        return;
      }
      
      // Calculate current month's bill
      const now = new Date();
      const isNewMonth = now.getDate() === 1; // Check if it's the first of the month
      
      const newCustomer = {
        id: `CUS-${String(customers.length + 1).padStart(6, '0')}`,
        name: name,
        email: email,
        locationId: locationId,
        address: selectedLocation.address,
        accountNumber: `CUS-${String(customers.length + 1).padStart(6, '0')}`,
        currentBill: isNewMonth ? 170 : 0, // New bill on 1st of month, otherwise 0
        pastDue: 0,
        lastPayment: 'Never',
        needsPasswordChange: true,
        createdDate: (() => {
          const today = new Date();
          return (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                 today.getDate().toString().padStart(2, '0') + '/' + 
                 today.getFullYear();
        })(),
        phone: phone,
        paymentHistory: [], // Track payment history
        entityType: entityType,
        ssn: ssn,
        idType: idType,
        idNumber: idNumber,
        secondaryContactName: secondaryContactName,
        secondaryContactPhone: secondaryContactPhone,
        mailingAddress: mailingAddress,
        mailingStreet: mailingStreet,
        mailingCity: mailingCity,
        mailingState: mailingState,
        mailingZip: mailingZip,
        codes: selectedCodes,
        factor: factor
      };
      
      // Update payment status based on past due amount
      updateCustomerPaymentStatus(newCustomer);
      
      // Update location status and owner
      selectedLocation.currentResident = name;
      selectedLocation.status = 'occupied';
      selectedLocation.ownerFirstName = name.split(' ')[0];
      selectedLocation.ownerLastName = name.split(' ').slice(1).join(' ');
      selectedLocation.ownerFullName = name;
      
      customers.push(newCustomer);
      filteredCustomers = [...customers];
      
      // Clear selected codes after creation
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();
      
      updateDashboard();
      await saveCustomersToFirestore();
      hideAddCustomerModal();
      
      alert('Customer added successfully!');
    };

    // Mark customer as paid
    window.markAsPaid = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        const today = new Date();
        const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();
        
        customer.pastDue = 0;
        customer.lastPayment = formattedDate;
        customer.currentBill = 0; // Reset current bill to 0 for early payment
        // Update payment status based on past due amount
        updateCustomerPaymentStatus(customer);
        updateDashboard();
        await saveCustomersToFirestore();
        alert('Payment recorded successfully! Amount due is now $0.00 until next month.');
      }
    };

    // Edit customer
    window.editCustomer = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        const newName = prompt('Enter new name:', customer.name);
        const newAddress = prompt('Enter new address:', customer.address);
        
        if (newName && newAddress) {
          customer.name = newName;
          customer.address = newAddress;
          updateDashboard();
          await saveCustomersToFirestore();
          alert('Customer updated successfully!');
        }
      }
    };

    // Delete customer
    window.deleteCustomer = async function(customerId) {
      if (confirm('Are you sure you want to delete this customer? This will permanently delete their account and all associated data.')) {
        const customer = customers.find(c => c.id === customerId);
        
        if (!customer) {
          alert('Customer not found');
          return;
        }

        try {
          // Delete customer document from Firestore
          const customerRef = doc(db, 'customers', customerId);
          await deleteDoc(customerRef);
          console.log('Customer deleted from Firestore:', customerId);
          
          // Remove from local arrays FIRST
          customers = customers.filter(c => c.id !== customerId);
          filteredCustomers = [...customers];
          console.log('Customer removed from local arrays. Remaining customers:', customers.length);
          
          // Find and update the associated location
          const associatedLocation = locations.find(l => l.currentResident === customer.name);
          if (associatedLocation) {
            associatedLocation.currentResident = null;
            associatedLocation.status = 'available';
            associatedLocation.ownerFirstName = '';
            associatedLocation.ownerLastName = '';
            associatedLocation.ownerFullName = '';
            
            // Update filtered locations if needed
            const filteredLocationIndex = filteredLocations.findIndex(l => l.id === associatedLocation.id);
            if (filteredLocationIndex !== -1) {
              filteredLocations[filteredLocationIndex] = associatedLocation;
            }
            
            // Save location changes to Firestore
            await saveLocationsToFirestore();
          }
          
          // Reload data from Firestore to ensure UI is in sync
          await loadCustomersFromFirestore();
          
          // Update displays
          updateDashboard();
          updateSettingsCustomerTable();
          
          alert('Customer deleted successfully! Password will be reset to "password" on next login and all payment history has been cleared.');
        } catch (error) {
          console.error('Error deleting customer:', error);
          alert('Error deleting customer: ' + error.message);
        }
      }
    };

    // Search customers
    window.searchCustomers = function() {
      const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
      filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) ||
        customer.email.toLowerCase().includes(searchTerm) ||
        customer.accountNumber.toLowerCase().includes(searchTerm) ||
        customer.address.toLowerCase().includes(searchTerm)
      );
      updateCustomerTable();
    };

    // Filter by status
    window.filterByStatus = function(status) {
      if (status === 'all') {
        filteredCustomers = [...customers];
      } else {
        filteredCustomers = customers.filter(c => c.paymentStatus === status);
      }
      updateCustomerTable();
    };

    // Location management functions
    function updateLocationsTable() {
      const tbody = document.getElementById('locationsTableBody');
      tbody.innerHTML = '';

      filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';
        
        const statusClass = location.status === 'occupied' 
          ? 'bg-green-100 text-green-800' 
          : location.status === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : 'bg-blue-100 text-blue-800';
        
        const statusText = location.status === 'occupied' 
          ? 'Occupied' 
          : location.status === 'inactive'
          ? 'Inactive'
          : 'Available';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${location.premiseId || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'address', '${location.address}')" 
                 title="Double-click to edit">
              ${location.address}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${location.currentResident ? `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'currentResident', '${location.currentResident}')" 
                 title="Double-click to edit">
              ${location.currentResident}
            </div>
            ` : `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'ownerFullName', '${location.ownerFullName || 'No Owner'}')" 
                 title="Double-click to edit">
              ${location.ownerFullName || 'No Owner'}
            </div>
            `}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editField('${location.id}', 'status', '${location.status}')" 
                  title="Double-click to edit">
              ${statusText}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteLocation('${location.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Settings module table update functions
    function updateSettingsCustomerTable() {
      const tbody = document.getElementById('settingsCustomerTableBody');
      tbody.innerHTML = '';

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';
        
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';
        
        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();
        
        // Check if customer has paid early (before due date)
        const hasPaidEarly = customer.lastPayment && customer.lastPayment !== 'Never' && 
                            customer.lastPayment.includes('/') && 
                            new Date(customer.lastPayment) < new Date(dueDateStr);
        
        // Calculate actual amount based on breakdown logic
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0; // $20 late fee
        const subtotal = serviceCost + lateFee;
        
        // Calculate code surcharges
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            totalSurcharge += subtotal * (code.percentage / 100);
          });
        }
        
        const totalAmount = hasPaidEarly ? 0 : (subtotal + totalSurcharge);
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'accountNumber', '${customer.accountNumber}')" 
                 title="Double-click to edit">
              ${customer.accountNumber}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'name', '${customer.name}')" 
                 title="Double-click to edit">
              ${customer.name}
            </div>
            <button 
              onclick="showCustomerFullInfo('${customer.id}')" 
              class="mt-2 text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium"
            >
              View Full Info
            </button>
          </td>
          <td class="px-6 py-4 text-center">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'address', '${customer.address}')" 
                 title="Double-click to edit">
              <div class="font-medium whitespace-nowrap">${customer.address.split(',')[0].trim()}</div>
              <div class="text-slate-500 dark:text-slate-400 whitespace-nowrap">${customer.address.split(',').slice(1).join(',').trim()}</div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editCustomerField('${customer.id}', 'paymentStatus', '${customer.paymentStatus}')" 
                  title="Double-click to edit">
              ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-900 dark:text-slate-100">
            <div class="font-medium">$${totalAmount.toFixed(2)}</div>
            <button onclick="showAmountDetails('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
              View Details
            </button>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600 dark:text-slate-400">
            <div class="flex flex-wrap gap-1 justify-center">
              ${customer.codes && customer.codes.length > 0 
                ? customer.codes.map(code => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.name}</span>`).join('')
                : '<span class="text-slate-400 dark:text-slate-500">â€”</span>'
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <div class="flex flex-col space-y-2">
              <button onclick="showPaymentModal('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Mark Paid
              </button>
              <button onclick="showPaymentHistory('${customer.id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                View History
              </button>
              <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function updateCodesTable() {
      const tbody = document.getElementById('settingsCodesTableBody');
      tbody.innerHTML = '';

      if (codes.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              You don't have any codes currently
            </td>
          </tr>
        `;
        return;
      }

      codes.forEach(code => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'name', '${(code.name || '').replace(/'/g, "\\'")}')" 
                 title="Double-click to edit">
              ${code.name || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'percentage', '${code.percentage || 0}')" 
                 title="Double-click to edit">
              ${code.percentage || 0}%
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'description', '${(code.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" 
                 title="Double-click to edit">
              ${code.description || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-900 dark:text-slate-100">
              ${code.requirements && code.requirements.values && code.requirements.values.length > 0 
                ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.requirements.values.join(` ${code.requirements.type} `)}</span>`
                : code.requirements && Array.isArray(code.requirements) && code.requirements.length > 0
                  ? code.requirements.map(req => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 mr-1">${req}</span>`).join('')
                  : '<span class="text-slate-400 dark:text-slate-500">â€”</span>'
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteCode('${code.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function updateSettingsLocationsTable() {
      const tbody = document.getElementById('settingsLocationsTableBody');
      tbody.innerHTML = '';

      filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';
        
        const statusClass = location.status === 'occupied' 
          ? 'bg-green-100 text-green-800' 
          : location.status === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : 'bg-blue-100 text-blue-800';
        
        const statusText = location.status === 'occupied' 
          ? 'Occupied' 
          : location.status === 'inactive'
          ? 'Inactive'
          : 'Available';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${location.premiseId || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'address', '${location.address}')" 
                 title="Double-click to edit">
              ${location.address}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${location.currentResident ? `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'currentResident', '${location.currentResident}')" 
                 title="Double-click to edit">
              ${location.currentResident}
            </div>
            ` : `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'ownerFullName', '${location.ownerFullName || 'No Owner'}')" 
                 title="Double-click to edit">
              ${location.ownerFullName || 'No Owner'}
            </div>
            `}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editField('${location.id}', 'status', '${location.status}')" 
                  title="Double-click to edit">
              ${statusText}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteLocation('${location.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    function updateSettingsUsersTable() {
      const tbody = document.getElementById('settingsUsersTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      
      if (!filteredUsers || filteredUsers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              You don't have any users yet.
            </td>
          </tr>
        `;
        return;
      }
      
      filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';
        
        let createdDate = 'â€”';
        if (user.createdAt) {
          try {
            createdDate = new Date(user.createdAt).toLocaleDateString('en-US');
          } catch (error) {
            createdDate = user.createdAt;
          }
        }
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${user.fullName || 'Unnamed User'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
            ${createdDate}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Search locations
    window.searchLocations = function() {
      const searchTerm = document.getElementById('locationSearch').value.toLowerCase();
      filteredLocations = locations.filter(location => 
        location.address.toLowerCase().includes(searchTerm) ||
        location.propertyType.toLowerCase().includes(searchTerm) ||
        (location.currentResident && location.currentResident.toLowerCase().includes(searchTerm))
      );
      updateLocationsTable();
    };
    
    window.searchUsers = function() {
      const searchInput = document.getElementById('settingsUserSearch');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      if (!searchTerm) {
        filteredUsers = [...users];
      } else {
        filteredUsers = users.filter(user => 
          (user.fullName || '').toLowerCase().includes(searchTerm)
        );
      }
      updateSettingsUsersTable();
    };

    // Filter locations by status
    window.filterLocationsByStatus = function(status) {
      if (status === 'all') {
        filteredLocations = [...locations];
      } else {
        filteredLocations = locations.filter(l => l.status === status);
      }
      updateLocationsTable();
    };

    // Import locations from JSON
    window.importLocations = async function() {
      const fileInput = document.getElementById('locationFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a JSON file');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.locations && Array.isArray(data.locations)) {
            // Add new locations to existing ones
            data.locations.forEach(newLocation => {
              // Check if location already exists
              const exists = locations.find(l => l.id === newLocation.id);
              if (!exists) {
                locations.push({
                  ...newLocation,
                  currentResident: null,
                  status: 'available'
                });
              }
            });
            
            filteredLocations = [...locations];
            updateLocationsTable();
            await saveLocationsToFirestore();
            alert(`Successfully imported ${data.locations.length} locations!`);
            fileInput.value = ''; // Clear the input
          } else {
            alert('Invalid JSON format. Expected "locations" array.');
          }
        } catch (error) {
          alert('Error parsing JSON file: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    // Show transfer ownership modal
    window.showTransferOwnershipModal = function(location, currentResident, newClientData) {
      // Store the data for later use
      window.transferData = {
        location: location,
        currentResident: currentResident,
        newClientData: newClientData
      };
      
      // Calculate actual amount due (same logic as in table)
      const now = new Date();
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getFullYear();
      
      // Check if customer has paid early (before due date)
      const hasPaidEarly = currentResident.lastPayment && currentResident.lastPayment !== 'Never' && 
                          currentResident.lastPayment.includes('/') && 
                          new Date(currentResident.lastPayment) < new Date(dueDateStr);
      
      // Calculate actual amount based on breakdown logic
      const serviceCost = calculateProratedServiceCost(currentResident);
      const lateFee = currentResident.pastDue > 0 ? 20 : 0; // $20 late fee
      const totalAmount = hasPaidEarly ? 0 : (serviceCost + lateFee);
      
      // Populate the modal
      document.getElementById('transferWarningName').textContent = currentResident.name;
      document.getElementById('transferCurrentResident').textContent = currentResident.name;
      document.getElementById('transferNewLocationLabel').textContent = currentResident.name;
      document.getElementById('transferLocation').textContent = location.address;
      document.getElementById('transferNewClient').textContent = newClientData.name;
      document.getElementById('transferCurrentStatus').textContent = currentResident.paymentStatus.charAt(0).toUpperCase() + currentResident.paymentStatus.slice(1);
      document.getElementById('transferBalance').textContent = `$${totalAmount.toFixed(2)}`;
      
      // Show appropriate message based on balance
      const statusMessage = document.getElementById('transferStatusMessage');
      if (totalAmount === 0) {
        statusMessage.innerHTML = 'The current resident has a balance of $0.00 and will be marked as <strong>Inactive</strong> after transfer.';
        statusMessage.className = 'text-green-600 dark:text-green-400';
      } else {
        statusMessage.innerHTML = 'The current resident has an outstanding balance and will be marked as <strong>Pending Closing</strong> until their balance is paid.';
        statusMessage.className = 'text-red-600 dark:text-red-400';
      }
      
      document.getElementById('transferOwnershipModal').classList.remove('hidden');
    };

    // Hide transfer ownership modal
    window.hideTransferOwnershipModal = function() {
      document.getElementById('transferOwnershipModal').classList.add('hidden');
      document.getElementById('transferNewLocation').value = '';
    };

    // Process transfer ownership
    window.processTransferOwnership = async function() {
      const newLocation = document.getElementById('transferNewLocation').value.trim();
      
      if (!newLocation) {
        alert('Please enter the new location for the current resident');
        return;
      }
      
      const { location, currentResident, newClientData } = window.transferData;
      
      try {
        // Update current resident's location and status
        currentResident.address = newLocation;
        
        // Calculate actual balance to determine status
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();
        
        // Check if customer has paid early
        const hasPaidEarly = currentResident.lastPayment && currentResident.lastPayment !== 'Never' && 
                            currentResident.lastPayment.includes('/') && 
                            new Date(currentResident.lastPayment) < new Date(dueDateStr);
        
        // Calculate actual amount due
        const serviceCost = calculateProratedServiceCost(currentResident);
        const lateFee = currentResident.pastDue > 0 ? 20 : 0;
        const totalAmount = hasPaidEarly ? 0 : (serviceCost + lateFee);
        
        // Set status based on balance: inactive if balance is 0, pending closing if they owe money
        if (totalAmount === 0) {
          currentResident.paymentStatus = 'inactive';
        } else {
          currentResident.paymentStatus = 'pending closing';
        }
        
        // Update location to new resident
        location.currentResident = newClientData.name;
        location.ownerFullName = newClientData.name;
        const nameParts = newClientData.name.split(' ');
        location.ownerFirstName = nameParts[0] || '';
        location.ownerLastName = nameParts.slice(1).join(' ') || '';
        
        // Create new customer
        const newCustomer = {
          id: 'CUS-' + String(Date.now()).slice(-6),
          name: newClientData.name,
          email: newClientData.email,
          phone: newClientData.phone,
          address: location.address,
          accountNumber: 'CUS-' + String(Date.now()).slice(-6),
          currentBill: 170,
          pastDue: 0,
          lastPayment: 'Never',
          paymentHistory: [],
          needsPasswordChange: true,
          createdDate: new Date().toISOString(),
          entityType: newClientData.entityType || '',
          ssn: newClientData.ssn || '',
          idType: newClientData.idType || '',
          idNumber: newClientData.idNumber || '',
          secondaryContactName: newClientData.secondaryContactName || '',
          secondaryContactPhone: newClientData.secondaryContactPhone || '',
          mailingAddress: newClientData.mailingAddress || '',
          mailingStreet: newClientData.mailingStreet || '',
          mailingCity: newClientData.mailingCity || '',
          mailingState: newClientData.mailingState || '',
          mailingZip: newClientData.mailingZip || '',
          codes: newClientData.codes || [],
          factor: newClientData.factor || ''
        };
        
        // Update payment status for new customer
        updateCustomerPaymentStatus(newCustomer);
        
        // Add new customer
        customers.push(newCustomer);
        filteredCustomers = [...customers];
        
        // Save to Firestore
        await saveCustomersToFirestore();
        await saveLocationsToFirestore();
        
        // Update displays
        updateDashboard();
        updateSettingsCustomerTable();
        
        // Hide modal and show success
        hideTransferOwnershipModal();
        showClientSuccessScreen();
        
        console.log('Transfer completed successfully');
      } catch (error) {
        console.error('Error processing transfer:', error);
        alert('Error processing transfer: ' + error.message);
      }
    };

    // Show add location modal
    window.showAddLocationModal = function() {
      // Generate a random 6-digit number for Premise ID
      const premiseId = Math.floor(100000 + Math.random() * 900000).toString();
      document.getElementById('newLocationPremiseId').value = premiseId;
      document.getElementById('addLocationModal').classList.remove('hidden');
    };
    
    // User management helpers
    window.showAddUserModal = function() {
      document.getElementById('newUserFullName').value = '';
      document.getElementById('addUserModal').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('newUserFullName').focus();
      }, 50);
    };
    
    window.hideAddUserModal = function() {
      document.getElementById('addUserModal').classList.add('hidden');
      document.getElementById('newUserFullName').value = '';
    };

    // Hide add location modal
    window.hideAddLocationModal = function() {
      document.getElementById('addLocationModal').classList.add('hidden');
      document.getElementById('addLocationForm').reset();
    };

    // Show add code modal
    window.showAddCodeModal = function() {
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
      document.getElementById('addCodeModal').classList.remove('hidden');
    };

    // Hide add code modal
    window.hideAddCodeModal = function() {
      document.getElementById('addCodeModal').classList.add('hidden');
      document.getElementById('addCodeForm').reset();
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
    };

    // Global variable to store selected requirements for new code
    // Structure: { type: "AND" | "OR", values: ["Business", "Individual"] }
    window.selectedCodeRequirements = null;

    // Update requirements list display
    window.updateCodeRequirementsList = function() {
      const listContainer = document.getElementById('newCodeRequirementsList');
      if (!listContainer) return;
      
      listContainer.innerHTML = '';
      
      if (!window.selectedCodeRequirements || window.selectedCodeRequirements.values.length === 0) {
        return;
      }
      
      const requirementDiv = document.createElement('div');
      requirementDiv.className = 'flex items-center justify-between bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg';
      
      const valuesText = window.selectedCodeRequirements.values.join(` ${window.selectedCodeRequirements.type} `);
      requirementDiv.innerHTML = `
        <span class="text-sm text-slate-800 dark:text-slate-200">${valuesText}</span>
        <button 
          type="button"
          onclick="removeCodeRequirement()" 
          class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 ml-2"
        >
          Ã—
        </button>
      `;
      listContainer.appendChild(requirementDiv);
    };

    // Show add requirement modal
    window.showAddRequirementModal = function() {
      document.getElementById('addRequirementModal').classList.remove('hidden');
    };

    // Hide add requirement modal
    window.hideAddRequirementModal = function() {
      document.getElementById('addRequirementModal').classList.add('hidden');
      // Reset checkboxes and radio buttons
      document.getElementById('requirementBusiness').checked = false;
      document.getElementById('requirementIndividual').checked = false;
      document.getElementById('requirementLogicAND').checked = true; // Default to AND
      document.getElementById('requirementLogicOR').checked = false;
    };

    // Add requirement to list
    window.addRequirement = function() {
      const businessChecked = document.getElementById('requirementBusiness').checked;
      const individualChecked = document.getElementById('requirementIndividual').checked;
      const logicType = document.getElementById('requirementLogicAND').checked ? 'AND' : 'OR';
      
      if (!businessChecked && !individualChecked) {
        alert('Please select at least one requirement');
        return;
      }
      
      const selectedValues = [];
      if (businessChecked) {
        selectedValues.push('Business');
      }
      if (individualChecked) {
        selectedValues.push('Individual');
      }
      
      window.selectedCodeRequirements = {
        type: logicType,
        values: selectedValues
      };
      
      updateCodeRequirementsList();
      hideAddRequirementModal();
    };

    // Remove requirement from list
    window.removeCodeRequirement = function() {
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
    };

    // Add new code
    window.addCode = async function() {
      const name = document.getElementById('newCodeName').value.trim();
      const percentage = parseFloat(document.getElementById('newCodePercentage').value);
      const description = document.getElementById('newCodeDescription').value.trim() || '';
      
      if (!name || isNaN(percentage) || percentage < 0 || percentage > 100) {
        alert('Please enter a valid code name and percentage (0-100)');
        return;
      }
      
      const newCode = {
        id: `CODE-${String(Date.now()).slice(-6)}`,
        name: name,
        percentage: percentage,
        description: description,
        requirements: window.selectedCodeRequirements ? { ...window.selectedCodeRequirements } : null
      };
      
      codes.push(newCode);
      await saveCodesToFirestore();
      updateCodesTable();
      hideAddCodeModal();
      
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
      
      alert('Code added successfully!');
    };

    // Delete code
    window.deleteCode = async function(codeId) {
      if (confirm('Are you sure you want to delete this code?')) {
        codes = codes.filter(c => c.id !== codeId);
        await saveCodesToFirestore();
        updateCodesTable();
        alert('Code deleted successfully!');
      }
    };

    // Edit code field
    window.editCodeField = function(codeId, fieldType, currentValue) {
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      let newValue = prompt(`Enter new ${fieldType}:`, currentValue);
      
      if (newValue === null) return; // User cancelled
      
      newValue = newValue.trim();
      
      // Validation
      if (fieldType === 'percentage') {
        const percentage = parseFloat(newValue);
        if (isNaN(percentage) || percentage < 0 || percentage > 100) {
          alert('Please enter a valid percentage between 0 and 100');
          return;
        }
        code.percentage = percentage;
      } else if (fieldType === 'name') {
        if (!newValue) {
          alert('Code name cannot be empty');
          return;
        }
        code.name = newValue;
      } else if (fieldType === 'description') {
        code.description = newValue || '';
      }
      
      // Save to Firestore and update table
      saveCodesToFirestore().then(() => {
        updateCodesTable();
        
        // Update code references in all customers if name changed
        if (fieldType === 'name') {
          customers.forEach(customer => {
            if (customer.codes && customer.codes.length > 0) {
              customer.codes.forEach(c => {
                if (c.id === codeId) {
                  c.name = newValue;
                }
              });
            }
          });
          saveCustomersToFirestore();
          updateCustomerTable();
          updateSettingsCustomerTable();
        }
      });
    };

    // Add new location
    window.addLocation = async function() {
      const street = document.getElementById('newLocationStreet').value;
      const city = document.getElementById('newLocationCity').value;
      const state = document.getElementById('newLocationState').value;
      const zip = document.getElementById('newLocationZip').value;
      const premiseId = document.getElementById('newLocationPremiseId').value;
      
      if (!street || !city || !state || !zip || !premiseId) {
        alert('Please fill in all fields');
        return;
      }
      
      const fullAddress = `${street}, ${city}, ${state} ${zip}`;
      
      const newLocation = {
        id: `LOC-${String(locations.length + 1).padStart(3, '0')}`,
        address: fullAddress,
        street: street,
        city: city,
        state: state,
        zip: zip,
        premiseId: premiseId,
        ownerFirstName: '',
        ownerLastName: '',
        ownerFullName: '',
        currentResident: null,
        status: 'available'
      };
      
      locations.push(newLocation);
      filteredLocations = [...locations];
      updateLocationsTable();
      updateSettingsLocationsTable();
      await saveLocationsToFirestore();
      hideAddLocationModal();
      
      // Update the location dropdowns and select the new location
      updateLocationDropdowns(newLocation.id);
      
      alert('Location added successfully!');
    };
    
    window.addUser = async function() {
      const input = document.getElementById('newUserFullName');
      const fullName = input.value.trim();
      
      if (!fullName) {
        alert('Please enter the user\'s full name.');
        return;
      }
      
      const timestamp = Date.now();
      const newUser = {
        id: `USR-${String(timestamp).slice(-6)}`,
        fullName,
        createdAt: new Date(timestamp).toISOString()
      };
      
      users.push(newUser);
      filteredUsers = [...users];
      updateSettingsUsersTable();
      populateBatchUserSelect(fullName);
      populateBatchStartUserSelect();
      await saveUsersToFirestore();
      hideAddUserModal();
      alert('User added successfully!');
    };
    
    window.deleteUser = async function(userId) {
      if (!confirm('Are you sure you want to delete this user?')) {
        return;
      }
      
      users = users.filter(user => user.id !== userId);
      filteredUsers = [...users];
      updateSettingsUsersTable();
      populateBatchUserSelect();
      populateBatchStartUserSelect();
      await saveUsersToFirestore();
      alert('User deleted successfully!');
    };

    // Update location dropdowns and select the new location
    function updateLocationDropdowns(selectedLocationId) {
      // Update Add Client Module dropdown
      const addClientSelect = document.getElementById('newClientLocation');
      if (addClientSelect) {
        populateAddClientLocationSelect();
        addClientSelect.value = selectedLocationId;
      }
      
      // Update Add Customer Modal dropdown
      const addCustomerSelect = document.getElementById('newCustomerLocation');
      if (addCustomerSelect) {
        // Repopulate the dropdown
        addCustomerSelect.innerHTML = '<option value="">Select a property location</option>';
        locations.forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = `${location.address} (${location.status})`;
          addCustomerSelect.appendChild(option);
        });
        addCustomerSelect.value = selectedLocationId;
      }
    }

    // Show import modal
    window.showImportModal = function() {
      document.getElementById('importModal').classList.remove('hidden');
    };

    // Hide import modal
    window.hideImportModal = function() {
      document.getElementById('importModal').classList.add('hidden');
      document.getElementById('locationFileInput').value = '';
    };

    // Show payment details modal
    window.showPaymentDetailsModal = function() {
      const selectedCustomerId = document.getElementById('paymentCustomerSelect').value;
      const customer = customers.find(c => c.id === selectedCustomerId);
      
      if (customer) {
        // Calculate amounts (same logic as in showCustomerPaymentInfo)
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0;
        const totalAmount = serviceCost + lateFee;
        
        // Populate the modal
        document.getElementById('paymentDetailsCustomer').textContent = customer.name;
        document.getElementById('paymentDetailsService').textContent = `$${serviceCost.toFixed(2)}`;
        document.getElementById('paymentDetailsLateFee').textContent = `$${lateFee.toFixed(2)}`;
        document.getElementById('paymentDetailsTotal').textContent = `$${totalAmount.toFixed(2)}`;
        
        // Show the modal
        document.getElementById('paymentDetailsModal').classList.remove('hidden');
      }
    };

    // Hide payment details modal
    window.hidePaymentDetailsModal = function() {
      document.getElementById('paymentDetailsModal').classList.add('hidden');
    };

    // Edit location
    window.editLocation = function(locationId) {
      const location = locations.find(l => l.id === locationId);
      if (location) {
        const newAddress = prompt('Enter new address:', location.address);
        const newType = prompt('Enter property type:', location.propertyType);
        
        if (newAddress && newType) {
          location.address = newAddress;
          location.propertyType = newType;
          updateLocationsTable();
          alert('Location updated successfully!');
        }
      }
    };

    // Delete location
    window.deleteLocation = async function(locationId) {
      if (confirm('Are you sure you want to delete this location?')) {
        locations = locations.filter(l => l.id !== locationId);
        filteredLocations = [...locations];
        updateLocationsTable();
        updateSettingsLocationsTable(); // Update settings table as well
        await saveLocationsToFirestore();
        alert('Location deleted successfully!');
      }
    };

    // Inline editing functionality
    window.editField = function(locationId, fieldType, currentValue) {
      const location = locations.find(l => l.id === locationId);
      const customer = customers.find(c => c.id === locationId);
      if (!location && !customer) return;

      // Set up the edit modal
      document.getElementById('editFieldType').textContent = fieldType.charAt(0).toUpperCase() + fieldType.slice(1);
      document.getElementById('editFieldLocationId').value = locationId;
      document.getElementById('editFieldFieldType').value = fieldType;
      
      // Check if this is a status field that should use a dropdown
      const container = document.getElementById('editFieldInputContainer');
      if (fieldType === 'paymentStatus') {
        // Create dropdown for payment status
        container.innerHTML = `
          <select 
            id="editFieldValue" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="current" ${currentValue === 'current' ? 'selected' : ''}>Current</option>
            <option value="overdue" ${currentValue === 'overdue' ? 'selected' : ''}>Overdue</option>
            <option value="inactive" ${currentValue === 'inactive' ? 'selected' : ''}>Inactive</option>
            <option value="pending closing" ${currentValue === 'pending closing' ? 'selected' : ''}>Pending Closing</option>
          </select>
        `;
      } else {
        // Use regular input for other fields
        container.innerHTML = `
          <input 
            id="editFieldValue" 
            type="text" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Enter new value"
            value="${currentValue}"
            required
          />
        `;
      }
      
      // Show the modal
      document.getElementById('editFieldModal').classList.remove('hidden');
    };

    // Save field edit
    window.saveFieldEdit = async function() {
      const locationId = document.getElementById('editFieldLocationId').value;
      const fieldType = document.getElementById('editFieldFieldType').value;
      const newValue = document.getElementById('editFieldValue').value.trim();
      
      if (!newValue) {
        alert('Please enter a value');
        return;
      }
      
      // Check if this is a customer or location field
      const customer = customers.find(c => c.id === locationId);
      const location = locations.find(l => l.id === locationId);
      
      if (customer) {
        // Update customer field
        if (fieldType === 'accountNumber') {
          customer.accountNumber = newValue;
        } else if (fieldType === 'name') {
          customer.name = newValue;
        } else if (fieldType === 'email') {
          customer.email = newValue;
        } else if (fieldType === 'phone') {
          customer.phone = newValue;
        } else if (fieldType === 'address') {
          customer.address = newValue;
        } else if (fieldType === 'paymentStatus') {
          customer.paymentStatus = newValue;
          // Note: Status will be automatically updated based on pastDue amount
        } else if (fieldType === 'dueDate') {
          customer.dueDate = newValue;
        } else if (fieldType === 'lastPayment') {
          customer.lastPayment = newValue;
        } else if (fieldType === 'factor') {
          // Validate factor is a valid number
          const factorValue = parseFloat(newValue);
          if (isNaN(factorValue) || factorValue < 0) {
            alert('Please enter a valid factor (must be a positive number)');
            return;
          }
          customer.factor = newValue;
        }
        
        // Update filtered customers
        const filteredIndex = filteredCustomers.findIndex(c => c.id === locationId);
        if (filteredIndex !== -1) {
          filteredCustomers[filteredIndex] = customer;
        }
        
        // Refresh customer table
        updateCustomerTable();
        updateSettingsCustomerTable();
        
        // Refresh Customer Information modal if it's open for this customer
        const customerFullInfoModal = document.getElementById('customerFullInfoModal');
        if (!customerFullInfoModal.classList.contains('hidden')) {
          // Check if the modal is showing this customer
          const content = document.getElementById('customerFullInfoContent');
          if (content && content.innerHTML.includes(customer.id)) {
            showCustomerFullInfo(locationId);
          }
        }
        
        // Refresh Amount Breakdown modal if it's open for this customer
        const amountDetailsModal = document.getElementById('amountDetailsModal');
        if (!amountDetailsModal.classList.contains('hidden')) {
          // Check if the modal is showing this customer
          const customerName = document.getElementById('amountDetailsCustomer');
          if (customerName && customerName.textContent === customer.name) {
            showAmountDetails(locationId);
          }
        }
        
        // Save to Firestore
        await saveCustomersToFirestore();
      } else if (location) {
        // Update location field
        if (fieldType === 'address') {
          location.address = newValue;
        } else if (fieldType === 'ownerFullName') {
          location.ownerFullName = newValue;
          // Split the name into first and last name
          const nameParts = newValue.split(' ');
          location.ownerFirstName = nameParts[0] || '';
          location.ownerLastName = nameParts.slice(1).join(' ') || '';
        } else if (fieldType === 'currentResident') {
          location.currentResident = newValue === 'Available' ? null : newValue;
          location.status = newValue === 'Available' ? 'available' : 'occupied';
        } else if (fieldType === 'status') {
          location.status = newValue;
        }
        
        // Update filtered locations
        const filteredIndex = filteredLocations.findIndex(l => l.id === locationId);
        if (filteredIndex !== -1) {
          filteredLocations[filteredIndex] = location;
        }
        
        // Refresh locations table
        updateLocationsTable();
        
        // Save to Firestore
        await saveLocationsToFirestore();
      }
      
      // Hide the modal
      document.getElementById('editFieldModal').classList.add('hidden');
    };

    // Cancel field edit
    window.cancelFieldEdit = function() {
      document.getElementById('editFieldModal').classList.add('hidden');
    };

    // Customer field editing functionality
    window.editCustomerField = function(customerId, fieldType, currentValue) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      // Set up the edit modal
      document.getElementById('editFieldType').textContent = fieldType.charAt(0).toUpperCase() + fieldType.slice(1);
      document.getElementById('editFieldValue').value = currentValue;
      document.getElementById('editFieldLocationId').value = customerId;
      document.getElementById('editFieldFieldType').value = fieldType;
      
      // Show the modal
      document.getElementById('editFieldModal').classList.remove('hidden');
    };

    // Show amount details modal
    window.showAmountDetails = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const serviceCost = calculateProratedServiceCost(customer);
      const lateFee = customer.pastDue > 0 ? 20 : 0; // $20 late fee
      const subtotal = serviceCost + lateFee;

      // Calculate code surcharges (based on subtotal)
      let totalSurcharge = 0;
      const codesContainer = document.getElementById('amountDetailsCodesContainer');
      codesContainer.innerHTML = '';
      
      if (customer.codes && customer.codes.length > 0) {
        customer.codes.forEach(code => {
          const surchargeAmount = subtotal * (code.percentage / 100);
          totalSurcharge += surchargeAmount;
          
          const codeRow = document.createElement('div');
          codeRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600';
          codeRow.innerHTML = `
            <span class="text-slate-600 dark:text-slate-400">${code.name} (${code.percentage}%)</span>
            <span class="font-medium">$${surchargeAmount.toFixed(2)}</span>
          `;
          codesContainer.appendChild(codeRow);
        });
      }

      // Calculate factor adjustment (based on service cost only)
      const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
      const factorAdjustment = serviceCost * (factor - 1);
      const total = serviceCost + lateFee + totalSurcharge + factorAdjustment;

      // Calculate due date as last day of current month
      const now = new Date();
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getFullYear();

      // Calculate billing cycle (month after due date)
      const billingCycleStart = new Date(lastDayOfMonth.getFullYear(), lastDayOfMonth.getMonth() + 1, 1);
      const billingCycleEnd = new Date(billingCycleStart.getFullYear(), billingCycleStart.getMonth() + 1, 0);
      
      const formatShortDate = (date) => {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const year = date.getFullYear().toString().slice(-2);
        return `${month}/${day}/${year}`;
      };
      
      const billingCycleStr = `${formatShortDate(billingCycleStart)} to ${formatShortDate(billingCycleEnd)}`;

      // Add factor adjustment to display if factor is not 1.0
      const factorContainer = document.getElementById('amountDetailsFactorContainer');
      if (factorContainer) {
        factorContainer.innerHTML = '';
        if (factor !== 1.0 && factorAdjustment > 0) {
          const factorRow = document.createElement('div');
          factorRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600';
          factorRow.innerHTML = `
            <span class="text-slate-600 dark:text-slate-400">Factor (${factor}x)</span>
            <span class="font-medium">$${factorAdjustment.toFixed(2)}</span>
          `;
          factorContainer.appendChild(factorRow);
        }
      }

      document.getElementById('amountDetailsCustomer').textContent = customer.name;
      document.getElementById('amountDetailsService').textContent = `$${serviceCost.toFixed(2)}`;
      document.getElementById('amountDetailsLateFee').textContent = `$${lateFee.toFixed(2)}`;
      document.getElementById('amountDetailsTotal').textContent = `$${total.toFixed(2)}`;
      document.getElementById('amountDetailsDueDate').textContent = dueDateStr;
      document.getElementById('amountDetailsBillingCycle').textContent = billingCycleStr;
      document.getElementById('amountDetailsLastPayment').textContent = formatDate(customer.lastPayment);
      
      document.getElementById('amountDetailsModal').classList.remove('hidden');
    };

    // Hide amount details modal
    window.hideAmountDetails = function() {
      document.getElementById('amountDetailsModal').classList.add('hidden');
    };

    // Show customer full info modal
    window.showCustomerFullInfo = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const content = document.getElementById('customerFullInfoContent');
      content.innerHTML = `
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Personal Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.name || 'N/A'}
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.email || 'N/A'}
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.phone ? formatPhoneNumber(customer.phone) : 'N/A'}
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.address || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.entityType || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.ssn || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.idType || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.idNumber || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.secondaryContactName || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.secondaryContactPhone ? formatPhoneNumber(customer.secondaryContactPhone) : 'N/A'}
            </div>
          </div>
          </div>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-600 my-6"></div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingStreet || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingCity || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingState || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingZip || 'N/A'}
              </div>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-600 my-6"></div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor & Codes</h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <div 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600" 
                ondblclick="editCustomerField('${customer.id}', 'factor', '${customer.factor || ''}')" 
                title="Double-click to edit"
              >
                ${customer.factor || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tax Codes</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.codes && customer.codes.length > 0 
                  ? customer.codes.map(code => `${code.name} (${code.percentage}%)`).join(', ')
                  : 'N/A'}
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('customerFullInfoModal').classList.remove('hidden');
    };

    // Hide customer full info modal
    window.hideCustomerFullInfo = function() {
      document.getElementById('customerFullInfoModal').classList.add('hidden');
    };

    // Show payment modal
    window.showPaymentModal = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const currentAmount = customer.currentBill + customer.pastDue;
      document.getElementById('paymentCustomerName').textContent = customer.name;
      document.getElementById('paymentCurrentAmount').textContent = `$${currentAmount.toFixed(2)}`;
      document.getElementById('paymentAmount').value = '';
      document.getElementById('paymentAmount').max = currentAmount;
      document.getElementById('paymentCustomerId').value = customerId;
      
      document.getElementById('paymentModal').classList.remove('hidden');
    };

    // Hide payment modal
    window.hidePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };

    // Process payment
    window.processPayment = async function() {
      const customerId = document.getElementById('paymentCustomerId').value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
      
      if (!paymentAmount || paymentAmount <= 0) {
        alert('Please enter a valid payment amount');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const currentAmount = customer.currentBill + customer.pastDue;
      if (paymentAmount > currentAmount) {
        alert(`Payment amount cannot exceed current balance of $${currentAmount.toFixed(2)}`);
        return;
      }

      // Record payment in history
      const today = new Date();
      const paymentDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                         today.getDate().toString().padStart(2, '0') + '/' + 
                         today.getFullYear();

      const paymentRecord = {
        date: paymentDate,
        amountDue: currentAmount,
        amountPaid: paymentAmount,
        remainingBalance: currentAmount - paymentAmount
      };

      customer.paymentHistory.push(paymentRecord);

      // Update customer balance
      if (paymentAmount >= customer.currentBill) {
        const remaining = paymentAmount - customer.currentBill;
        customer.currentBill = 0;
        customer.pastDue = Math.max(0, customer.pastDue - remaining);
      } else {
        customer.currentBill -= paymentAmount;
      }

      // Update last payment date
      customer.lastPayment = paymentDate;
      
      // If customer was pending closing and now has no balance, mark as inactive
      if (customer.paymentStatus === 'pending closing' && customer.pastDue === 0 && customer.currentBill === 0) {
        customer.paymentStatus = 'inactive';
      } else {
        // Update payment status based on past due amount
        updateCustomerPaymentStatus(customer);
      }

      // Save to Firestore
      await saveCustomersToFirestore();
      
      // Update display
      updateDashboard();
      hidePaymentModal();
      
      alert(`Payment of $${paymentAmount.toFixed(2)} recorded successfully!`);
    };

    // Show payment history
    window.showPaymentHistory = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      document.getElementById('historyCustomerName').textContent = customer.name;
      
      const historyBody = document.getElementById('paymentHistoryBody');
      historyBody.innerHTML = '';

      // Check if paymentHistory exists and has items
      if (!customer.paymentHistory || customer.paymentHistory.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 dark:text-slate-400 py-4">No payment history available</td></tr>';
      } else {
        customer.paymentHistory.forEach(payment => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">${payment.date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.amountDue.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.amountPaid.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.remainingBalance.toFixed(2)}</td>
          `;
          historyBody.appendChild(row);
        });
      }

      document.getElementById('paymentHistoryModal').classList.remove('hidden');
    };

    // Hide payment history modal
    window.hidePaymentHistory = function() {
      document.getElementById('paymentHistoryModal').classList.add('hidden');
    };

    // Keyboard shortcut to switch to client page
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey) {
        event.preventDefault();
        window.location.href = 'billing.html';
      }
    });
  </script>
  <style>
    :root { color-scheme: light dark; }
    body { background: radial-gradient(1200px 800px at 30% -10%, #e6f0ff 0%, #ffffff 45%) no-repeat; }
    @media (prefers-color-scheme: dark) {
      body { background: radial-gradient(1200px 800px at 30% -10%, #0b1220 0%, #0e1628 45%) no-repeat; }
    }
    .card { backdrop-filter: saturate(1.2) blur(8px); }
    .modal-show { display: flex !important; }
    .safe-pad { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .tap { -webkit-tap-highlight-color: transparent; }
    
    /* CRITICAL: Force batch preview section to always be visible and have dimensions */
    #batchPreviewSection {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: relative !important;
      width: 100% !important;
    }
    
    #batchPreviewSection.hidden {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* BATCH PREVIEW TABLE - COMPREHENSIVE FIX */
    #batchPreviewTableMain {
      width: 100% !important;
      border-collapse: collapse !important;
      table-layout: fixed !important;
      display: table !important;
    }
    
    #batchPreviewTableMain thead {
      display: table-header-group !important;
    }
    
    #batchPreviewTableMain tbody {
      display: table-row-group !important;
    }
    
    #batchPreviewTableMain tr {
      display: table-row !important;
    }
    
    #batchPreviewTableMain th,
    #batchPreviewTableMain td {
      display: table-cell !important;
      vertical-align: middle !important;
      padding: 0.5rem 1rem !important;
      border: none !important;
    }
    
    /* Column widths - explicit and fixed */
    .batch-col-date {
      width: 12% !important;
      min-width: 100px !important;
      max-width: 120px !important;
      text-align: left !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
      color: #64748b !important;
      padding: 0.5rem 1rem !important;
      white-space: nowrap !important;
    }
    
    .batch-col-customer {
      width: 18% !important;
      min-width: 150px !important;
      text-align: left !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
      color: #64748b !important;
      padding: 0.5rem 1rem !important;
    }
    
    .batch-col-account {
      width: 12% !important;
      min-width: 100px !important;
      text-align: left !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
      color: #64748b !important;
      padding: 0.5rem 1rem !important;
      white-space: nowrap !important;
    }
    
    .batch-col-property {
      width: 30% !important;
      min-width: 200px !important;
      text-align: left !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
      color: #64748b !important;
      padding: 0.5rem 1rem !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    
    .batch-col-type {
      width: 10% !important;
      min-width: 80px !important;
      text-align: left !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
      color: #64748b !important;
      padding: 0.5rem 1rem !important;
      white-space: nowrap !important;
    }
    
    .batch-col-amount {
      width: 18% !important;
      min-width: 100px !important;
      text-align: right !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
      color: #64748b !important;
      padding: 0.5rem 1rem !important;
      white-space: nowrap !important;
    }
    
    /* Data cells - match header alignment */
    #batchPreviewTableMain tbody .batch-col-date {
      font-size: 0.875rem !important;
      font-weight: normal !important;
      text-transform: none !important;
      color: #334155 !important;
      white-space: nowrap !important;
    }
    
    #batchPreviewTableMain tbody .batch-col-customer {
      font-size: 0.875rem !important;
      font-weight: normal !important;
      text-transform: none !important;
      color: #334155 !important;
    }
    
    #batchPreviewTableMain tbody .batch-col-account {
      font-size: 0.875rem !important;
      font-weight: normal !important;
      text-transform: none !important;
      color: #334155 !important;
      white-space: nowrap !important;
    }
    
    #batchPreviewTableMain tbody .batch-col-property {
      font-size: 0.875rem !important;
      font-weight: normal !important;
      text-transform: none !important;
      color: #334155 !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    
    #batchPreviewTableMain tbody .batch-col-type {
      font-size: 0.875rem !important;
      font-weight: normal !important;
      text-transform: none !important;
      color: #334155 !important;
      white-space: nowrap !important;
    }
    
    #batchPreviewTableMain tbody .batch-col-amount {
      font-size: 0.875rem !important;
      font-weight: normal !important;
      text-transform: none !important;
      color: #334155 !important;
      text-align: right !important;
      white-space: nowrap !important;
    }
    
    /* Total row */
    .batch-total-row {
      background-color: #f1f5f9 !important;
      font-weight: 600 !important;
    }
    
    .batch-total-label {
      text-align: right !important;
      font-size: 0.875rem !important;
      color: #334155 !important;
      padding: 0.5rem 1rem !important;
      white-space: nowrap !important;
    }
    
    .batch-total-amount {
      text-align: right !important;
      font-size: 0.875rem !important;
      color: #334155 !important;
      font-weight: 600 !important;
      padding: 0.5rem 1rem !important;
      white-space: nowrap !important;
    }
    
    /* Empty message */
    .batch-empty-message {
      text-align: center !important;
      font-size: 0.875rem !important;
      color: #64748b !important;
      padding: 0.75rem 1rem !important;
    }
    
    /* Ensure table body is visible */
    #batchPreviewTable {
      display: table-row-group !important;
      visibility: visible !important;
    }
    
    #paymentModule {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    #paymentModule.hidden {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 tap">
  <div class="mx-auto max-w-7xl px-4 pt-6 pb-24 safe-pad">
    

    <!-- Dashboard Screen -->
    <div id="dashboardScreen">
      <!-- Header -->
      <header class="mb-8">
        <div class="text-center">
          <br><br>
          <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200">CUS Admin Dashboard</h1>
          <p class="text-slate-600 dark:text-slate-400">Manage customer accounts and billing</p>
        </div>
      </header>

      <!-- Action Modules -->
      <div id="actionModules" class="mb-8">
        <!-- Payment Module -->
        <div id="paymentModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Payment</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
              <select id="paymentCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Choose a customer...</option>
              </select>
            </div>
            
            <div id="customerPaymentInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                  <p id="paymentAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                  <button id="viewDetailsBtn" onclick="showPaymentDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                    View Details
                  </button>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                  <p id="paymentPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                  <p id="paymentLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                  <p id="paymentPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                  <p id="paymentDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                  <span id="paymentStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be populated by JavaScript -->
                  </span>
                </div>
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Type</label>
                <select 
                  id="paymentType" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                >
                  <option value="">Select Payment Type</option>
                  <option value="Check">Check</option>
                  <option value="Cash">Cash</option>
                </select>
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
                <input 
                  type="number" 
                  id="paymentAmount" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter payment amount"
                >
              </div>
              
              <button 
                onclick="processPaymentFromModule()" 
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Process Payment
              </button>
            </div>
          </div>
        </div>

        <!-- Bill Module -->
        <div id="billModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
              <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Choose a customer...</option>
              </select>
            </div>
            
            <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                  <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                  <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                    View Details
                  </button>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                  <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                  <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                  <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                  <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                  <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be populated by JavaScript -->
                  </span>
                </div>
              </div>
              
              <!-- Bill Preview -->
              <div id="billPreview" class="mb-4 p-4 bg-white dark:bg-slate-600 rounded-lg border-2 border-slate-300 dark:border-slate-500">
                <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-3">Bill Preview</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Service Cost:</span>
                    <span id="previewServiceCost" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Late Fee:</span>
                    <span id="previewLateFee" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Surcharges:</span>
                    <span id="previewSurcharges" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Factor Adjustment:</span>
                    <span id="previewFactorAdjustment" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between pt-2 border-t border-slate-300 dark:border-slate-500">
                    <span class="font-semibold text-slate-800 dark:text-slate-200">Total Amount:</span>
                    <span id="previewTotalAmount" class="font-bold text-lg text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                </div>
              </div>
              
              <button 
                onclick="produceBill()" 
                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Produce Bill
              </button>
              
              <!-- PDF Display Container -->
              <div id="billPdfDisplay" class="hidden mt-4">
                <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
                <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Client Module -->
        <div id="addClientModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Client</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Account Info</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
              <input 
                type="text" 
                id="newClientName" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter full name"
                required
              >
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
              <input 
                type="email" 
                id="newClientEmail" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter email address"
                required
              >
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
              <input 
                type="tel" 
                id="newClientPhone" 
                oninput="formatPhoneInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="(xxx)-xxx-xxxx"
                required
              >
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
              <select id="newClientLocation" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" required>
                <option value="">Choose a location...</option>
                <option value="add-new">+ Add New Location</option>
              </select>
            </div>
            </div>
          </div>

          <!-- Identification Info Section -->
          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Identification Info</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
                <input 
                  type="text" 
                  id="newClientSSN" 
                  oninput="formatSSNInput(this)"
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="xxx-xx-xxxx"
                  maxlength="11"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
                <select id="newClientIDType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">Select ID Type</option>
                  <option value="Drivers License">Drivers License</option>
                  <option value="ID">ID</option>
                  <option value="Passport">Passport</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
                <input 
                  type="text" 
                  id="newClientIDNumber" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter ID number"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
                <input 
                  type="text" 
                  id="newClientSecondaryContactName" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter secondary contact name"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
                <input 
                  type="tel" 
                  id="newClientSecondaryContactPhone" 
                  oninput="formatPhoneInput(this)"
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="(xxx)-xxx-xxxx"
                >
              </div>
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
                <input 
                  type="text" 
                  id="newClientMailingStreet" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter street address"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
                <input 
                  type="text" 
                  id="newClientMailingCity" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter city"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
                <select id="newClientMailingState" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">Select State</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                <input 
                  type="text" 
                  id="newClientMailingZip" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter ZIP code"
                  maxlength="10"
                >
              </div>
            </div>
          </div>

            <div class="mt-6">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
              <div id="newClientCodesList" class="space-y-2">
                <!-- Selected codes will be displayed here -->
              </div>
            </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <input 
                type="number" 
                id="newClientFactor" 
                step="any"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter factor"
              >
            </div>
          </div>
          
          <div class="mt-6">
            <button 
              onclick="addClientFromModule()" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Create Client Account
            </button>
          </div>
        </div>

        <!-- Search Module -->
        <div id="searchModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Search Accounts</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Search by Name</label>
                <input 
                  type="text" 
                  id="searchByName" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter customer name..."
                >
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Filter by Status</label>
                <select id="searchByStatus" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">All Status</option>
                  <option value="current">Current</option>
                  <option value="overdue">Overdue</option>
                </select>
              </div>
            </div>
            
            <div class="flex space-x-4">
              <button 
                onclick="performSearch()" 
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Search
              </button>
              <button 
                onclick="clearSearch()" 
                class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Clear
              </button>
            </div>
            
            <div id="searchResults" class="mt-6">
              <!-- Search results will be displayed here -->
            </div>
          </div>
        </div>

        <!-- Settings Module -->
        <div id="settingsModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Settings & Management</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex space-x-1 mb-6">
            <button 
              id="settingsAccountsTab"
              onclick="switchSettingsView('accounts')" 
              class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
            >
              Accounts
            </button>
            <button 
              id="settingsLocationsTab"
              onclick="switchSettingsView('locations')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Locations
            </button>
            <button 
              id="settingsCodesTab"
              onclick="switchSettingsView('codes')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Codes
            </button>
            <button 
              id="settingsUsersTab"
              onclick="switchSettingsView('users')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Users
            </button>
          </div>

          <!-- Accounts Section -->
          <div id="settingsAccountsContent">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Customer Accounts</h4>
              <button 
                onclick="showAddCustomerModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add New Customer
              </button>
            </div>

            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsCustomerSearch" 
                  type="text" 
                  placeholder="Search customers..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchCustomers()"
                />
              </div>
              <div>
                <select 
                  onchange="filterByStatus(this.value)" 
                  class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Status</option>
                  <option value="current">Current</option>
                  <option value="overdue">Overdue</option>
                </select>
              </div>
            </div>

            <!-- Customer Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Account</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Customer</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Codes</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsCustomerTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Customer rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Locations Section -->
          <div id="settingsLocationsContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Property Locations</h4>
              <div class="flex gap-3">
                <button 
                  onclick="showAddLocationModal()" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Add Location
                </button>
                <button 
                  onclick="showImportModal()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                >
                  Import Locations
                </button>
              </div>
            </div>

            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsLocationSearch" 
                  type="text" 
                  placeholder="Search locations..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchLocations()"
                />
              </div>
              <div>
                <select 
                  onchange="filterLocationsByStatus(this.value)" 
                  class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Status</option>
                  <option value="occupied">Occupied</option>
                  <option value="available">Available</option>
                </select>
              </div>
            </div>

            <!-- Locations Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Premise ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Owner & Resident</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsLocationsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Location rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Codes Section -->
          <div id="settingsCodesContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Tax Codes</h4>
              <button 
                onclick="showAddCodeModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add Code
              </button>
            </div>

            <!-- Codes Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Code Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Percentage</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Requirements</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsCodesTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Code rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Users Section -->
          <div id="settingsUsersContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">System Users</h4>
              <button 
                onclick="showAddUserModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add User
              </button>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsUserSearch" 
                  type="text" 
                  placeholder="Search users..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchUsers()"
                />
              </div>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Full Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsUsersTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- User rows populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Action Buttons -->
      <br><br>
      <div class="flex flex-col items-center gap-4 mb-8 p-8 max-w-2xl mx-auto bg-white dark:bg-slate-800 rounded-3xl border border-blue-100 dark:border-slate-700 shadow-md hover:shadow-2xl hover:scale-[1.02] focus-within:shadow-2xl focus-within:scale-[1.02] transition-all duration-300 ease-out cursor-default">
        <button 
          onclick="showAddClientModule()" 
          class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
          </svg>
          <span class="text-base">Add Client</span>
        </button>
        
        <button 
          onclick="showPaymentModule()" 
          class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <span class="text-4xl font-black leading-none">$</span>
          <span class="text-base">Make Payment</span>
        </button>
        
        <button 
          onclick="showBillModule()" 
          class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <span class="text-base">Send Bill</span>
        </button>
        
        <button 
          onclick="showSearchModule()" 
          class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span class="text-base">Search Database</span>
        </button>
        
        <button 
          onclick="showSettingsModule()" 
          class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span class="text-base">Settings</span>
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex space-x-1 mb-6 hidden">
        <button 
          id="accountsTab"
          onclick="switchView('accounts')" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
        >
          Accounts
        </button>
        <button 
          id="locationsTab"
          onclick="switchView('locations')" 
          class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
        >
          Locations
        </button>
      </div>

      <!-- Accounts Section -->
      <div id="accountsContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Accounts</h2>
          <button 
            onclick="showAddCustomerModal()" 
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Add New Customer
          </button>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <input 
              id="customerSearch" 
              type="text" 
              placeholder="Search customers..." 
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeyup="searchCustomers()"
            />
          </div>
          <div>
            <select 
              onchange="filterByStatus(this.value)" 
              class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="current">Current</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>
        </div>

        <!-- Customer Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Account</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Customer</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Due Date</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Last Payment</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="customerTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Customer rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Locations Section -->
      <div id="locationsContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Property Locations</h2>
          <div class="flex gap-3">
            <button 
              onclick="showAddLocationModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add Location
            </button>
            <button 
              onclick="showImportModal()" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
            >
              Import Locations
            </button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <input 
              id="locationSearch" 
              type="text" 
              placeholder="Search locations..." 
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeyup="searchLocations()"
            />
          </div>
          <div>
            <select 
              onchange="filterLocationsByStatus(this.value)" 
              class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="occupied">Occupied</option>
              <option value="available">Available</option>
            </select>
          </div>
        </div>

        <!-- Locations Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Premise ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Owner & Resident</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="locationsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Location rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Customer</h3>
          <button 
            onclick="hideAddCustomerModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <form id="addCustomerForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              id="newCustomerName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter customer's full name"
              required
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
            <input 
              id="newCustomerEmail" 
              type="email" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="customer@email.com"
              required
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <input 
              id="newCustomerPhone" 
              type="tel" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="(916) 555-0123"
              oninput="formatPhoneInput(this)"
              required
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <select 
              id="newCustomerLocation" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">Select a property location</option>
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <select 
              id="newCustomerEntityType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select Entity Type</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Farmer">Farmer</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
            <input 
              id="newCustomerSSN" 
              type="text" 
              oninput="formatSSNInput(this)"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="xxx-xx-xxxx"
              maxlength="11"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
            <select 
              id="newCustomerIDType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select ID Type</option>
              <option value="Drivers License">Drivers License</option>
              <option value="ID">ID</option>
              <option value="Passport">Passport</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
            <input 
              id="newCustomerIDNumber" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter ID number"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
            <input 
              id="newCustomerSecondaryContactName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter secondary contact name"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
            <input 
              id="newCustomerSecondaryContactPhone" 
              type="tel" 
              oninput="formatPhoneInput(this)"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="(xxx)-xxx-xxxx"
            />
          </div>

          <div class="mt-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
                <input 
                  id="newCustomerMailingStreet" 
                  type="text" 
                  class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter street address"
                />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
                  <input 
                    id="newCustomerMailingCity" 
                    type="text" 
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter city"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
                  <select 
                    id="newCustomerMailingState" 
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">Select State</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                <input 
                  id="newCustomerMailingZip" 
                  type="text" 
                  class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter ZIP code"
                  maxlength="10"
                />
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
            <div class="flex gap-2 mb-4">
              <select 
                id="newCustomerCodeSelect" 
                class="flex-1 px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select a code...</option>
              </select>
              <button 
                type="button"
                onclick="addCustomerCode()" 
                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors"
              >
                Add Code
              </button>
            </div>
            <div id="newCustomerCodesList" class="space-y-2">
              <!-- Selected codes will be displayed here -->
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <input 
                type="number" 
                id="newCustomerFactor" 
                step="any"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter factor"
              >
            </div>
          </div>
          
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Note:</strong> The customer will be able to log in using their email address and the temporary password "password".
            </p>
          </div>
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddCustomerModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addCustomer()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Customer
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Add Location Modal -->
    <div id="addLocationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Location</h3>
          <button 
            onclick="hideAddLocationModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <form id="addLocationForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Premise ID</label>
            <input 
              id="newLocationPremiseId" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-600 text-slate-800 dark:text-slate-200"
              readonly
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
            <input 
              id="newLocationStreet" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="123 Main Street"
              required
            />
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <input 
                id="newLocationCity" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Sacramento"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <input 
                id="newLocationState" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="CA"
                required
              />
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
            <input 
              id="newLocationZip" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="95814"
              required
            />
          </div>
          
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddLocationModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addLocation()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Location
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add System User</h3>
          <button 
            onclick="hideAddUserModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <form class="space-y-4" onsubmit="event.preventDefault(); addUser();">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              id="newUserFullName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter full name"
              required
            />
          </div>
          
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              Users are stored in the users collection in Firestore using their full name.
            </p>
          </div>
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddUserModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="submit"
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add User
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Record Payment</h3>
          <button 
            onclick="hidePaymentModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="paymentCustomerName"></span></h4>
            <p class="text-sm text-blue-800 dark:text-blue-200">Current Balance: <span id="paymentCurrentAmount" class="font-bold"></span></p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
            <input 
              id="paymentAmount" 
              type="number" 
              step="0.01"
              min="0.01"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter payment amount"
              required
            />
          </div>
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hidePaymentModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="processPayment()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Record Payment
            </button>
          </div>
        </div>
        
        <!-- Hidden input for tracking -->
        <input type="hidden" id="paymentCustomerId" />
      </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-4xl w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment History - <span id="historyCustomerName"></span></h3>
          <button 
            onclick="hidePaymentHistory()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Paid</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Remaining Balance</th>
              </tr>
            </thead>
            <tbody id="paymentHistoryBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Payment history rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
        
        <div class="mt-6">
          <button 
            type="button"
            onclick="hidePaymentHistory()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Amount Details Modal -->
    <div id="amountDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAmountDetails()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Amount Breakdown</h3>
          <button 
            onclick="hideAmountDetails()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="amountDetailsCustomer"></span></h4>
            <div class="space-y-2 pt-2 border-t border-blue-200 dark:border-blue-700 mt-2">
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Due Date</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsDueDate">--/--/----</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Billing Cycle</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsBillingCycle">--/--/-- - --/--/--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Last Payment</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsLastPayment">Never</span>
              </div>
            </div>
          </div>
          
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
              <span class="font-medium" id="amountDetailsService">$150.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Late Fee</span>
              <span class="font-medium" id="amountDetailsLateFee">$0.00</span>
            </div>
            <div id="amountDetailsCodesContainer"></div>
            <div id="amountDetailsFactorContainer"></div>
            <div class="flex justify-between items-center py-3 bg-slate-50 dark:bg-slate-700 rounded-lg px-4">
              <span class="font-semibold text-slate-800 dark:text-slate-200">Total Due</span>
              <span class="font-bold text-lg" id="amountDetailsTotal">$170.00</span>
            </div>
          </div>
          
          <button 
            type="button"
            onclick="hideAmountDetails()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Field Modal -->
    <div id="editFieldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Edit <span id="editFieldType">Field</span></h3>
          <button 
            onclick="cancelFieldEdit()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">New Value</label>
            <div id="editFieldInputContainer">
              <input 
                id="editFieldValue" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter new value"
                required
              />
            </div>
          </div>
          
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Tip:</strong> For status, use "available" or "occupied". For residents, use "Available" to make the property available.
            </p>
          </div>
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="cancelFieldEdit()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="saveFieldEdit()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Save Changes
            </button>
          </div>
        </div>
        
        <!-- Hidden inputs for tracking -->
        <input type="hidden" id="editFieldLocationId" />
        <input type="hidden" id="editFieldFieldType" />
      </div>
    </div>

    <!-- Import Locations Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Import Locations</h3>
          <button 
            onclick="hideImportModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select JSON File</label>
            <input 
              id="locationFileInput" 
              type="file" 
              accept=".json"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          
          <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">
            <p class="text-sm text-green-800 dark:text-green-200">
              <strong>JSON Format:</strong> Your file should contain a "locations" array with objects having properties like id, address, propertyType, bedrooms, bathrooms, squareFootage.
            </p>
          </div>
          
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Sample:</strong> You can use the provided locations.json file as a template.
            </p>
          </div>
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideImportModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="importLocations()" 
              class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200"
            >
              Import Locations
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="paymentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Breakdown</h3>
          <button 
            onclick="hidePaymentDetailsModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="paymentDetailsCustomer"></span></h4>
          </div>
          
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
              <span class="font-medium" id="paymentDetailsService">$150.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Late Fee</span>
              <span class="font-medium" id="paymentDetailsLateFee">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-3 bg-slate-50 dark:bg-slate-700 rounded-lg px-4">
              <span class="font-semibold text-slate-800 dark:text-slate-200">Total Due</span>
              <span class="font-bold text-lg" id="paymentDetailsTotal">$170.00</span>
            </div>
          </div>
          
          <button 
            type="button"
            onclick="hidePaymentDetailsModal()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Transfer Ownership Modal -->
    <div id="transferOwnershipModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Transfer Property Ownership</h3>
          <button 
            onclick="hideTransferOwnershipModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-6">
          <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">âš ï¸ Location Already Occupied</h4>
            <p class="text-sm text-yellow-700 dark:text-yellow-300">
              This location is currently being used by <strong id="transferWarningName"></strong> at <strong id="transferLocation"></strong>.
            </p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <h5 class="font-semibold text-slate-800 dark:text-slate-200 mb-3">Current Resident</h5>
              <div class="space-y-2">
                <p><span class="text-slate-600 dark:text-slate-400">Name:</span> <span id="transferCurrentResident"></span></p>
                <p><span class="text-slate-600 dark:text-slate-400">Status:</span> <span id="transferCurrentStatus"></span></p>
                <p><span class="text-slate-600 dark:text-slate-400">Balance:</span> <span id="transferBalance"></span></p>
              </div>
            </div>
            
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
              <h5 class="font-semibold text-blue-800 dark:text-blue-200 mb-3">New Client</h5>
              <div class="space-y-2">
                <p><span class="text-blue-600 dark:text-blue-400">Name:</span> <span id="transferNewClient"></span></p>
                <p class="text-sm text-blue-600 dark:text-blue-400">Will be assigned to this location</p>
              </div>
            </div>
          </div>
          
          <div id="transferStatusMessage" class="p-4 rounded-xl">
            <!-- Status message will be populated by JavaScript -->
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              New Location for <span id="transferNewLocationLabel"></span>
            </label>
            <input 
              id="transferNewLocation" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter the new address where they're moving"
              required
            />
          </div>
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideTransferOwnershipModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="processTransferOwnership()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Transfer Ownership
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Code Modal -->
    <div id="addCodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Code</h3>
          <button 
            onclick="hideAddCodeModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <form id="addCodeForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Code Name</label>
            <input 
              id="newCodeName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter code name"
              required
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Percentage</label>
            <input 
              id="newCodePercentage" 
              type="number" 
              step="0.01"
              min="0"
              max="100"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter percentage (0-100)"
              required
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Description</label>
            <textarea 
              id="newCodeDescription" 
              rows="3"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter description"
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Requirements</label>
            <div id="newCodeRequirementsList" class="mb-2 space-y-2">
              <!-- Selected requirements will be displayed here -->
            </div>
            <button 
              type="button"
              onclick="showAddRequirementModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
            >
              Add requirement
            </button>
          </div>
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddCodeModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addCode()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Code
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Requirement Modal -->
    <div id="addRequirementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAddRequirementModal()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add Requirement</h3>
          <button 
            onclick="hideAddRequirementModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-4">Select Requirements</label>
            <div class="space-y-3">
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="requirementBusiness" 
                  class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementBusiness" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  Business
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="requirementIndividual" 
                  class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementIndividual" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  Individual
                </label>
              </div>
            </div>
          </div>

          <div class="border-t border-slate-200 dark:border-slate-600 pt-4">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">Logic Type</label>
            <div class="space-y-2">
              <div class="flex items-center">
                <input 
                  type="radio" 
                  id="requirementLogicAND" 
                  name="requirementLogic"
                  value="AND"
                  checked
                  class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementLogicAND" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  AND (both must be selected)
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="radio" 
                  id="requirementLogicOR" 
                  name="requirementLogic"
                  value="OR"
                  class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementLogicOR" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  OR (at least one must be selected)
                </label>
              </div>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddRequirementModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addRequirement()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Full Info Modal -->
    <div id="customerFullInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideCustomerFullInfo()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Information</h3>
          <button 
            onclick="hideCustomerFullInfo()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div id="customerFullInfoContent" class="space-y-4">
          <!-- Content will be populated by JavaScript -->
        </div>

        <div class="mt-6">
          <button 
            type="button"
            onclick="hideCustomerFullInfo()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
