<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>CUS Billing - Admin Portal</title>
  <!-- IMPORTANT: Include auth.js in <head> to check auth before page loads -->
  <script src="auth.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, getDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCxfnleg4jI9C3xPI_UabT81vIsnPjukSY",
      authDomain: "cus-billing-e84eb.firebaseapp.com",
      projectId: "cus-billing-e84eb",
      storageBucket: "cus-billing-e84eb.firebasestorage.app",
      messagingSenderId: "606152504829",
      appId: "1:606152504829:web:6d14518df4a56ecfe81594",
      measurementId: "G-FKLJNHMWHV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Firebase Authentication helper functions
    window.firebaseAuth = {
      // Sign in with Firebase Auth (called after password verification)
      signIn: async function(email, password) {
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          console.log('[FIREBASE AUTH] Successfully signed in:', userCredential.user.uid);
          return { success: true, user: userCredential.user };
        } catch (error) {
          console.error('[FIREBASE AUTH] Sign in error:', error);
          return { success: false, error: error.message };
        }
      },
      // Sign out
      signOut: async function() {
        try {
          await signOut(auth);
          console.log('[FIREBASE AUTH] Signed out successfully');
        } catch (error) {
          console.error('[FIREBASE AUTH] Sign out error:', error);
        }
      },
      // Get current user
      getCurrentUser: function() {
        return auth.currentUser;
      },
      // Wait for auth state
      waitForAuth: function() {
        return new Promise((resolve) => {
          const unsubscribe = onAuthStateChanged(auth, (user) => {
            unsubscribe();
            resolve(user);
          });
        });
      }
    };

    // Sample admin credentials
    const adminCredentials = {
      email: 'admin@cus.com',
      password: 'admin123'
    };

    // Customer data (starts empty, customers added through admin interface)
    let customers = [];

    // Locations data (starts empty, locations added through import or admin interface)
    let locations = [];

    // Users data (managed from the Settings module)
    let users = [];

    // Tax codes data (starts empty, codes added through admin interface)
    let codes = [];

    // Payment batch tracking
    window.paymentBatches = [];
    window.currentPaymentBatch = null;

    function logBatch(message, data) {
      const payload = data !== undefined ? data : '';

    }

    // Format phone number as (xxx)-xxx-xxxx
    function formatPhoneNumber(phone) {
      // Remove all non-digit characters
      const cleaned = phone.replace(/\D/g, '');

      // Format as (xxx)-xxx-xxxx
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0, 3)})-${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
      }

      // Return original if not 10 digits
      return phone;
    }

    // Format phone number input as user types
    window.formatPhoneInput = function(input) {
      let value = input.value.replace(/\D/g, ''); // Remove all non-digits

      if (value.length >= 6) {
        // Format as (xxx)-xxx-xxxx
        value = `(${value.slice(0, 3)})-${value.slice(3, 6)}-${value.slice(6, 10)}`;
      } else if (value.length >= 3) {
        // Format as (xxx)-xxx
        value = `(${value.slice(0, 3)})-${value.slice(3)}`;
      } else if (value.length > 0) {
        // Format as (xxx
        value = `(${value}`;
      }

      input.value = value;
    };

    // Format SSN input as user types (xxx-xx-xxxx)
    window.formatSSNInput = function(input) {
      let value = input.value.replace(/\D/g, ''); // Remove all non-digits

      if (value.length >= 5) {
        // Format as xxx-xx-xxxx
        value = `${value.slice(0, 3)}-${value.slice(3, 5)}-${value.slice(5, 9)}`;
      } else if (value.length >= 3) {
        // Format as xxx-xx
        value = `${value.slice(0, 3)}-${value.slice(3)}`;
      }

      input.value = value;
    };

    // Format date as mm/dd/yyyy
    function formatDate(dateString) {
      if (!dateString || dateString === 'Never') {
        return 'Never';
      }

      // If already in mm/dd/yyyy format, return as is
      if (dateString.includes('/')) {
        return dateString;
      }

      // If in yyyy-mm-dd format, convert to mm/dd/yyyy
      if (dateString.includes('-')) {
        const parts = dateString.split('-');
        if (parts.length === 3) {
          return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
      }

      return dateString;
    }

    // Firestore functions
    async function saveLocationsToFirestore(progressCallback) {
      try {
        const locationsRef = collection(db, 'locations');
        // Clear existing locations first
        const existingLocations = await getDocs(locationsRef);
        const deletePromises = [];
        existingLocations.forEach(doc => {
          deletePromises.push(deleteDoc(doc.ref));
        });
        await Promise.all(deletePromises);

        // Add all current locations
        const totalLocations = locations.length;
        let savedCount = 0;
        for (const location of locations) {
          await addDoc(locationsRef, location);
          savedCount++;

          // Update progress every location (or every 10 for console)
          if (savedCount % 10 === 0 || savedCount === totalLocations) {

          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalLocations) * 100);
            progressCallback(savedCount, totalLocations, percent);
          }
        }

      } catch (error) {

        throw error; // Re-throw to be caught by caller
      }
    }

    async function loadLocationsFromFirestore() {
      try {
        const locationsRef = collection(db, 'locations');
        const snapshot = await getDocs(locationsRef);
        locations = [];
        snapshot.forEach(doc => {
          locations.push({ id: doc.id, ...doc.data() });
        });
        filteredLocations = [...locations];
        updateLocationsTable();

      } catch (error) {

      }
    }

    // Save all customers to Firestore (used for imports - replaces all customers)
    async function saveAllCustomersToFirestore(progressCallback) {
      try {
        console.log('[SAVE ALL CUSTOMERS] Starting save all customers to Firestore...');
        console.log('[SAVE ALL CUSTOMERS] Total customers to save:', customers.length);
        
        const customersRef = collection(db, 'customers');

        // Clear existing customers first (only for full imports) - use batches for deletion too
        console.log('[SAVE ALL CUSTOMERS] Deleting existing customers...');
        const existingCustomers = await getDocs(customersRef);
        const customerDocs = [];
        existingCustomers.forEach(doc => {
          customerDocs.push(doc);
        });

        // Delete in batches of 500 (Firestore batch limit)
        const deleteBatchSize = 500;
        for (let i = 0; i < customerDocs.length; i += deleteBatchSize) {
          const batch = writeBatch(db);
          const batchDocs = customerDocs.slice(i, Math.min(i + deleteBatchSize, customerDocs.length));
          batchDocs.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          // Small delay between batches to avoid rate limiting
          if (i + deleteBatchSize < customerDocs.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        console.log('[SAVE ALL CUSTOMERS] Deleted', customerDocs.length, 'existing customers');

        // Add all current customers using batch writes (500 operations per batch)
        const totalCustomers = customers.length;
        const batchSize = 500; // Firestore batch limit
        let savedCount = 0;

        for (let i = 0; i < customers.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchCustomers = customers.slice(i, Math.min(i + batchSize, customers.length));
          
          batchCustomers.forEach(customer => {
            const customerRef = doc(customersRef, customer.id);
            batch.set(customerRef, customer);
          });

          await batch.commit();
          savedCount += batchCustomers.length;

          // Update progress
          if (savedCount % 100 === 0 || savedCount === totalCustomers) {
            console.log(`[SAVE ALL CUSTOMERS] Saved ${savedCount} / ${totalCustomers} customers`);
          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalCustomers) * 100);
            progressCallback(savedCount, totalCustomers, percent);
          }

          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customers.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        
        console.log('[SAVE ALL CUSTOMERS] Successfully saved', savedCount, 'of', totalCustomers, 'customers to Firestore');
      } catch (error) {
        console.error('[SAVE ALL CUSTOMERS] Error saving all customers to Firestore:', error);
        throw error; // Re-throw to be caught by caller
      }
    }

    // Save/update customers to Firestore (used for regular updates - updates existing customers)
    async function saveCustomersToFirestore(progressCallback) {
      try {
        console.log('[SAVE CUSTOMERS] Starting save customers to Firestore (update mode)...');
        console.log('[SAVE CUSTOMERS] Total customers to save:', customers.length);
        
        const customersRef = collection(db, 'customers');
        const totalCustomers = customers.length;
        const batchSize = 500; // Firestore batch limit
        let savedCount = 0;
        
        // Use batch writes to reduce API calls
        for (let i = 0; i < customers.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchCustomers = customers.slice(i, Math.min(i + batchSize, customers.length));
          
          batchCustomers.forEach(customer => {
            try {
              const customerRef = doc(customersRef, customer.id);
              batch.set(customerRef, customer);
            } catch (customerError) {
              console.error(`[SAVE CUSTOMERS] Error preparing customer ${customer.id} (${customer.name}):`, customerError);
            }
          });

          await batch.commit();
          savedCount += batchCustomers.length;

          // Update progress every 100 customers
          if (savedCount % 100 === 0 || savedCount === totalCustomers) {
            console.log(`[SAVE CUSTOMERS] Saved ${savedCount} / ${totalCustomers} customers`);
          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalCustomers) * 100);
            progressCallback(savedCount, totalCustomers, percent);
          }

          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customers.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        
        console.log('[SAVE CUSTOMERS] Successfully saved', savedCount, 'of', totalCustomers, 'customers to Firestore');
      } catch (error) {
        console.error('[SAVE CUSTOMERS] Error saving customers to Firestore:', error);
        throw error; // Re-throw to be caught by caller
      }
    }

    async function loadCustomersFromFirestore() {
      try {
        const customersRef = collection(db, 'customers');
        const snapshot = await getDocs(customersRef);
        customers = [];
        snapshot.forEach(doc => {
          const customer = { id: doc.id, ...doc.data() };
          // Populate codes from importData if available
          if (customer.importData) {
            populateCustomerCodesFromImportData(customer);
          }
          customers.push(customer);
        });
        filteredCustomers = [...customers];

        updateCustomerTable();

        // Save codes to Firestore if any new codes were added during customer load
        // NOTE: Since loadCodesFromFirestore() now runs FIRST, codes are already loaded.
        // This will only save if ensureCodeExists() created any NEW codes that weren't in Firestore.
        // If codes already existed, ensureCodeExists() will find them and return them, so no new codes are created.
        if (codes.length > 0) {

          // Only save if there might be new codes (codes that were just created by ensureCodeExists)
          // Since codes are loaded first, this should rarely happen, but we save to be safe
          await saveCodesToFirestore();

        } else {

        }
      } catch (error) {

      }
    }

    async function saveCodesToFirestore() {
      try {

        const codesRef = collection(db, 'codes');

        // Get existing codes to find ones that should be deleted
        const existingCodes = await getDocs(codesRef);
        const existingCodeIds = new Set(existingCodes.docs.map(doc => doc.id));
        const currentCodeIds = new Set(codes.map(code => code.id));

        // Delete codes that no longer exist
        const deletePromises = [];
        existingCodes.forEach(doc => {
          if (!currentCodeIds.has(doc.id)) {
            deletePromises.push(deleteDoc(doc.ref));
          }
        });
        if (deletePromises.length > 0) {

          await Promise.all(deletePromises);
        }

        // Save all current codes using their ID as the document ID
        for (const code of codes) {
          const codeRef = doc(codesRef, code.id);

          // Build the code object to save - preserve ALL fields from the code object
          // Use spread operator to copy all properties, then ensure amount/percentage are set correctly
          const codeToSave = {
            ...code,
            // Ensure amount is set - use code.amount if it exists (even if 0), otherwise fall back to percentage or 0
            amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
            // For percentage type, sync percentage with amount if amount is set, otherwise use percentage or 0
            percentage: code.type === 'percentage' && code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0)
          };

          await setDoc(codeRef, codeToSave);

          // Verify what was actually saved by reading it back immediately
          const verifyDoc = await getDoc(codeRef);
          const verifyData = verifyDoc.data();

        }

      } catch (error) {

        throw error; // Re-throw so caller can handle it
      }
    }

    async function loadCodesFromFirestore() {
      try {
        const codesRef = collection(db, 'codes');
        const snapshot = await getDocs(codesRef);
        codes = [];
        snapshot.forEach(doc => {
          // Use document ID as the code ID (since we save with code.id as document ID)
          // Spread data first, then override id to ensure document ID takes precedence
          const codeData = doc.data();
          const loadedCode = { ...codeData, id: doc.id };
          codes.push(loadedCode);

          // Log each code as it's loaded

        });

        updateCodesTable();

      } catch (error) {

      }
    }

    async function saveUsersToFirestore() {
      try {
        const usersRef = collection(db, 'users');
        const existingUsers = await getDocs(usersRef);
        existingUsers.forEach(userDoc => {
          deleteDoc(userDoc.ref);
        });

        for (const user of users) {
          const userRef = doc(usersRef, user.id);
          await setDoc(userRef, user);
        }

      } catch (error) {

      }
    }

    async function loadUsersFromFirestore() {
      try {
        const usersRef = collection(db, 'users');
        const snapshot = await getDocs(usersRef);
        users = [];
        snapshot.forEach(docSnap => {
          users.push({ id: docSnap.id, ...docSnap.data() });
        });
        filteredUsers = [...users];
        updateSettingsUsersTable();
        populateBatchStartUserSelect();

      } catch (error) {

      }
    }

    async function saveBatchToFirestore(batch) {
      try {
        const batchesRef = collection(db, 'paymentBatches');
        const batchRef = doc(batchesRef, batch.id);
        await setDoc(batchRef, batch);

      } catch (error) {

      }
    }

    async function loadPaymentBatchesFromFirestore() {
      try {
        const batchesRef = collection(db, 'paymentBatches');
        const snapshot = await getDocs(batchesRef);
        window.paymentBatches = [];
        snapshot.forEach(batchDoc => {
          window.paymentBatches.push({ id: batchDoc.id, ...batchDoc.data() });
        });

        renderBatchesList();
      } catch (error) {

      }
    }

    let currentUser = null;
    let filteredCustomers = [...customers];
    let filteredLocations = [...locations];
    let filteredUsers = [...users];
    let currentView = 'accounts'; // 'accounts' or 'locations'

    // Show dashboard immediately (no authentication required)
    function showDashboard() {
      updateDashboard();
    }

    // Reset bills on first of month
    function resetMonthlyBills() {
      const now = new Date();
      const isFirstOfMonth = now.getDate() === 1;

      if (isFirstOfMonth) {
        // Check if we've already reset this month by checking if there's a reset flag in localStorage
        const lastResetDate = localStorage.getItem('lastMonthlyBillReset');
        const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;
        
        // Only reset if we haven't reset this month yet
        if (lastResetDate !== currentMonthKey) {
          console.log('[RESET MONTHLY BILLS] Resetting bills for first of month');
          let needsSave = false;
          
          customers.forEach(customer => {
            // Only reset if currentBill is not already 170 (avoid unnecessary saves)
            if (customer.currentBill !== 170) {
              // Reset current bill to full amount on first of month
              // Note: pastDue should NOT be reset - it carries over from previous months
              customer.currentBill = 170;
              // Update payment status based on past due amount
              updateCustomerPaymentStatus(customer);
              needsSave = true;
            }
          });

          // Only save if we actually made changes
          if (needsSave) {
            console.log('[RESET MONTHLY BILLS] Saving updated customers to Firestore');
            saveCustomersToFirestore().then(() => {
              // Mark that we've reset this month
              localStorage.setItem('lastMonthlyBillReset', currentMonthKey);
              console.log('[RESET MONTHLY BILLS] Monthly reset completed and saved');
            }).catch(error => {
              console.error('[RESET MONTHLY BILLS] Error saving customers:', error);
            });
          } else {
            // Mark as reset even if no changes (all customers already had currentBill = 170)
            localStorage.setItem('lastMonthlyBillReset', currentMonthKey);
            console.log('[RESET MONTHLY BILLS] No changes needed, all bills already reset');
          }
        } else {
          console.log('[RESET MONTHLY BILLS] Already reset this month, skipping');
        }
      }
    }

    // MutationObserver to track payment module changes
    let paymentModuleObserver = null;
    function setupPaymentModuleObserver() {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule || paymentModuleObserver) return;

      paymentModuleObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {

          }
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {

          }
        });
      });

      paymentModuleObserver.observe(paymentModule, {
        childList: true,
        subtree: true,
        characterData: true,
        attributes: true,
        attributeOldValue: true,
        attributeFilter: ['class']
      });

    }

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', async function() {

      // Ensure the payment module markup (with batch controls) is in place before data loads
      // Pass true to keepHidden to prevent showing payment batches on initial load
      resetPaymentForm(true);
      showDashboard();
      // Set up mutation observer after payment module is created
      setTimeout(setupPaymentModuleObserver, 100);

      // SECURITY: Check Firebase Authentication - show modal if not authenticated
      console.log('[INIT] Checking Firebase Authentication...');
      const ADMIN_UID = 'fQEVSsWI0DRca4h8K7uJgTwmjfv2'; // Admin user UID
      
      const currentUser = await window.firebaseAuth.waitForAuth();
      
      // Function to show Firebase Auth modal
      function showFirebaseAuthModal() {
        const modal = document.getElementById('firebaseAuthModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.getElementById('firebaseEmail').focus();
        }
      }
      
      // Function to hide Firebase Auth modal
      function hideFirebaseAuthModal() {
        const modal = document.getElementById('firebaseAuthModal');
        if (modal) {
          modal.classList.add('hidden');
        }
      }
      
      // Function to verify admin and log out if not admin
      async function verifyAdminAndLoad() {
        const user = window.firebaseAuth.getCurrentUser();
        if (!user) {
          console.log('[INIT] No Firebase user, showing auth modal');
          showFirebaseAuthModal();
          return false;
        }
        
        // Check if user is the admin
        if (user.uid !== ADMIN_UID) {
          console.error('[INIT] User is not admin. UID:', user.uid, 'Expected:', ADMIN_UID);
          // Sign out and clear auth
          await window.firebaseAuth.signOut();
          if (window.auth && window.auth.clearAuthentication) {
            window.auth.clearAuthentication();
          }
          alert('Access denied. Only admin users can access this system.');
          window.location.replace('login.html');
          return false;
        }
        
        console.log('[INIT] Firebase Authentication confirmed - Admin user:', user.uid);
        hideFirebaseAuthModal();
        return true;
      }
      
      // Set up Firebase Auth form handler
      const firebaseAuthForm = document.getElementById('firebaseAuthForm');
      if (firebaseAuthForm) {
        firebaseAuthForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const email = document.getElementById('firebaseEmail').value.trim();
          const password = document.getElementById('firebasePassword').value;
          const errorDiv = document.getElementById('firebaseAuthError');
          const submitBtn = document.getElementById('firebaseAuthSubmit');
          
          errorDiv.classList.add('hidden');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Signing in...';
          
          try {
            const result = await window.firebaseAuth.signIn(email, password);
            if (result.success) {
              // Verify admin after sign in
              const isAdmin = await verifyAdminAndLoad();
              if (isAdmin) {
                // Reload page to initialize with authenticated user
                window.location.reload();
              }
            } else {
              errorDiv.textContent = result.error || 'Invalid email or password';
              errorDiv.classList.remove('hidden');
              submitBtn.disabled = false;
              submitBtn.textContent = 'Sign In';
            }
          } catch (error) {
            console.error('[FIREBASE AUTH] Error:', error);
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign In';
          }
        });
      }
      
      // Check authentication status
      const isAdmin = await verifyAdminAndLoad();
      if (!isAdmin) {
        // Don't load data if not authenticated as admin
        return;
      }

      // CRITICAL: Load codes FIRST before customers!
      // This ensures that when populateCustomerCodesFromImportData() runs during customer load,
      // it will find existing codes in the array instead of creating new ones with default values

      await loadCodesFromFirestore();

      // Now load other data
      await loadLocationsFromFirestore();
      await loadCustomersFromFirestore();

      await loadUsersFromFirestore();
      await loadPaymentBatchesFromFirestore();
      // Update customer payment statuses based on past due amounts
      updateAllCustomerPaymentStatuses();
      // Reset bills if it's the first of the month
      resetMonthlyBills();
      // Update location statuses based on customers
      updateLocationStatuses();
      // Update stats after data is loaded

      updateStats();
    });

    // Switch between accounts and locations views
    window.switchView = function(view) {
      currentView = view;
      const accountsTab = document.getElementById('accountsTab');
      const locationsTab = document.getElementById('locationsTab');
      const accountsContent = document.getElementById('accountsContent');
      const locationsContent = document.getElementById('locationsContent');

      if (view === 'accounts') {
        accountsTab.classList.add('bg-blue-600', 'text-white');
        accountsTab.classList.remove('bg-slate-200', 'text-slate-700');
        locationsTab.classList.add('bg-slate-200', 'text-slate-700');
        locationsTab.classList.remove('bg-blue-600', 'text-white');
        accountsContent.classList.remove('hidden');
        locationsContent.classList.add('hidden');

        // Refresh customer codes from the global codes array to ensure latest amounts are used
        // This ensures that when showAmountDetails is called, it will have the latest code data
        customers.forEach(customer => {
          if (customer.codes && customer.codes.length > 0) {
            customer.codes = customer.codes.map(customerCode => {
              // Look up the latest code data from the global codes array
              let latestCode = codes.find(c => c.id === customerCode.id);
              if (!latestCode) {
                latestCode = codes.find(c => c.name.toLowerCase() === customerCode.name.toLowerCase());
              }
              // Use the latest code data if found, otherwise keep the customer code data
              if (latestCode) {
                return {
                  id: latestCode.id,
                  name: latestCode.name,
                  type: latestCode.type || 'percentage',
                  amount: latestCode.amount !== undefined ? latestCode.amount : (latestCode.percentage !== undefined ? latestCode.percentage : 0),
                  percentage: latestCode.type === 'percentage' && latestCode.amount !== undefined ? latestCode.amount : (latestCode.percentage !== undefined ? latestCode.percentage : 0)
                };
              }
              return customerCode;
            });
          }
        });
      } else {
        locationsTab.classList.add('bg-blue-600', 'text-white');
        locationsTab.classList.remove('bg-slate-200', 'text-slate-700');
        accountsTab.classList.add('bg-slate-200', 'text-slate-700');
        accountsTab.classList.remove('bg-blue-600', 'text-white');
        locationsContent.classList.remove('hidden');
        accountsContent.classList.add('hidden');
      }
      updateDashboard();
    };

    // Switch between settings accounts, locations, and codes views
    window.switchSettingsView = function(view) {
      const accountsTab = document.getElementById('settingsAccountsTab');
      const locationsTab = document.getElementById('settingsLocationsTab');
      const codesTab = document.getElementById('settingsCodesTab');
      const usersTab = document.getElementById('settingsUsersTab');
      const accountsContent = document.getElementById('settingsAccountsContent');
      const locationsContent = document.getElementById('settingsLocationsContent');
      const codesContent = document.getElementById('settingsCodesContent');
      const usersContent = document.getElementById('settingsUsersContent');

      // Reset all tabs and content
      [accountsTab, locationsTab, codesTab, usersTab].forEach(tab => {
        if (!tab) return;
        tab.classList.remove('bg-blue-600', 'text-white');
        tab.classList.add('bg-slate-200', 'text-slate-700');
      });
      accountsContent.classList.add('hidden');
      locationsContent.classList.add('hidden');
      codesContent.classList.add('hidden');
      usersContent.classList.add('hidden');

      if (view === 'accounts') {
        accountsTab.classList.add('bg-blue-600', 'text-white');
        accountsTab.classList.remove('bg-slate-200', 'text-slate-700');
        accountsContent.classList.remove('hidden');
        updateSettingsCustomerTable();
      } else if (view === 'locations') {
        locationsTab.classList.add('bg-blue-600', 'text-white');
        locationsTab.classList.remove('bg-slate-200', 'text-slate-700');
        locationsContent.classList.remove('hidden');
        updateSettingsLocationsTable();
      } else if (view === 'codes') {
        codesTab.classList.add('bg-blue-600', 'text-white');
        codesTab.classList.remove('bg-slate-200', 'text-slate-700');
        codesContent.classList.remove('hidden');
        updateCodesTable();
      } else if (view === 'users') {
        usersTab.classList.add('bg-blue-600', 'text-white');
        usersTab.classList.remove('bg-slate-200', 'text-slate-700');
        usersContent.classList.remove('hidden');
        updateSettingsUsersTable();
      }
    };

    function updateDashboard() {

      const paymentModuleBefore = document.getElementById('paymentModule');

      updateStats();
      updateLocationStatuses(); // Update location statuses based on customers
      if (currentView === 'accounts') {
        updateCustomerTable();
      } else {
        updateLocationsTable();
      }

      const paymentModuleAfter = document.getElementById('paymentModule');

      if ((paymentModuleBefore?.innerHTML?.length || 0) !== (paymentModuleAfter?.innerHTML?.length || 0)) {

      }

    }

    // Update customer payment status based on past due amount
    function updateCustomerPaymentStatus(customer) {
      // Don't change status if it's inactive or pending closing (these are manually set)
      if (customer.paymentStatus === 'inactive' || customer.paymentStatus === 'pending closing') {
        return;
      }

      if (customer.pastDue > 0) {
        customer.paymentStatus = 'overdue';
      } else {
        customer.paymentStatus = 'current';
      }
    }

    // Update all customer payment statuses
    function updateAllCustomerPaymentStatuses() {
      customers.forEach(customer => {
        updateCustomerPaymentStatus(customer);
      });
    }

    // Update location statuses based on associated customers
    function updateLocationStatuses() {
      locations.forEach(location => {
        // Check if there's a customer associated with this location
        const associatedCustomer = customers.find(customer => 
          customer.address === location.address || 
          customer.name === location.currentResident
        );

        if (associatedCustomer) {
          // Location has an active customer
          location.status = 'occupied';
          location.currentResident = associatedCustomer.name;
          location.ownerFullName = associatedCustomer.name;
          // Split name into first and last
          const nameParts = associatedCustomer.name.split(' ');
          location.ownerFirstName = nameParts[0] || '';
          location.ownerLastName = nameParts.slice(1).join(' ') || '';
        } else {
          // No customer associated - set to inactive
          location.status = 'inactive';
          location.currentResident = null;
          location.ownerFullName = '';
          location.ownerFirstName = '';
          location.ownerLastName = '';
        }
      });

      // Update filtered locations
      filteredLocations = [...locations];
    }

    function updateStats() {

      const totalCustomers = customers.length;
      const overdueCustomers = customers.filter(c => c.paymentStatus === 'overdue').length;
      const currentCustomers = customers.filter(c => c.paymentStatus === 'current').length;

      // Calculate total revenue from payment history
      let totalRevenue = 0;
      customers.forEach(customer => {
        if (customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0) {
          customer.paymentHistory.forEach(payment => {
            totalRevenue += payment.amountPaid;
          });
        }
      });

      // Only update stats if the elements exist (they were removed from the UI)
      const totalCustomersEl = document.getElementById('totalCustomers');
      const overdueCustomersEl = document.getElementById('overdueCustomers');
      const currentCustomersEl = document.getElementById('currentCustomers');
      const totalRevenueEl = document.getElementById('totalRevenue');

      if (totalCustomersEl) totalCustomersEl.textContent = totalCustomers;
      if (overdueCustomersEl) overdueCustomersEl.textContent = overdueCustomers;
      if (currentCustomersEl) currentCustomersEl.textContent = currentCustomers;
      if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
    }

    function updateCustomerTable() {
      const tbody = document.getElementById('customerTableBody');
      tbody.innerHTML = '';

      // Update the customer count display
      const countDisplay = document.getElementById('customerCountDisplay');
      const totalDisplay = document.getElementById('customerTotalDisplay');
      if (countDisplay) countDisplay.textContent = filteredCustomers.length;
      if (totalDisplay) totalDisplay.textContent = customers.length;

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early (before due date)
        const hasPaidEarly = customer.lastPayment && customer.lastPayment !== 'Never' && 
                            customer.lastPayment.includes('/') && 
                            new Date(customer.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount based on breakdown logic
        const serviceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFee = pastDue > 0 ? 20 : 0; // $20 late fee if there's past due
        const subtotal = serviceCost + pastDue + lateFee;

        // Calculate code surcharges (applied only to service cost, not subtotal)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += serviceCost * (codeAmount / 100);
            }
          });
        }

        // Calculate factor adjustment (based on service cost only)
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const factorAdjustment = serviceCost * (factor - 1);
        const totalAmount = hasPaidEarly ? 0 : (serviceCost + pastDue + lateFee + totalSurcharge + factorAdjustment);

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'accountNumber', '${customer.accountNumber}')" 
                 title="Double-click to edit">
              ${customer.accountNumber}
            </div>
          </td>
          <td class="px-0 py-4 pr-0 -mr-4 whitespace-nowrap text-center max-w-[180px]">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'name', '${customer.name}')" 
                 title="Double-click to edit">
              ${customer.name}
            </div>
            <div class="flex flex-col items-center gap-1 mt-2">
              <button 
                onclick="showCustomerFullInfo('${customer.id}')" 
                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium"
              >
                View Full Info
              </button>
              <button 
                onclick="showCustomerDataProfile('${customer.id}')" 
                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 text-xs font-medium"
              >
                View Data Profile
              </button>
            </div>
          </td>
          <td class="px-0 py-4 pl-0 -ml-4 text-center max-w-[180px]">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'address', '${getCustomerDisplayAddress(customer)}')" 
                 title="Double-click to edit">
              ${(() => {
                const displayAddress = getCustomerDisplayAddress(customer);
                if (typeof displayAddress === 'string' && displayAddress.includes(',')) {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress.split(',')[0].trim()}</div>
                  <div class="text-slate-500 dark:text-slate-400 whitespace-nowrap">${displayAddress.split(',').slice(1).join(',').trim()}</div>`;
                } else {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress}</div>`;
                }
              })()}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editCustomerField('${customer.id}', 'paymentStatus', '${customer.paymentStatus}')" 
                  title="Double-click to edit">
              ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-900 dark:text-slate-100">
            <div class="font-medium">$${totalAmount.toFixed(2)}</div>
            <button onclick="showAmountDetails('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
              View Details
            </button>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600 dark:text-slate-400">
            <div class="flex flex-wrap gap-1 justify-center">
              ${customer.codes && customer.codes.length > 0 
                ? customer.codes.map(code => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.name}</span>`).join('')
                : '<span class="text-slate-400 dark:text-slate-500">â€”</span>'
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <div class="flex flex-col space-y-2">
              <button onclick="showPaymentModal('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Mark Paid
              </button>
              <button onclick="showPaymentHistory('${customer.id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                View History
              </button>
              <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Logout function (simply redirects to client page)
    window.logout = function() {
      window.location.href = 'billing.html';
    };

    // Module Management Functions
    window.showPaymentModule = function() {
      hideAllModules();
      // Reset payment module to original form
      resetPaymentForm();
      document.getElementById('paymentModule').classList.remove('hidden');
    };

    window.showBillModule = function() {
      hideAllModules();
      // Reset bill module to original form
      resetBillForm();
      document.getElementById('billModule').classList.remove('hidden');
    };

    window.showAddClientModule = function() {
      hideAllModules();
      // Reset add client module to original form
      resetAddClientForm();
      // Populate codes dropdown after form is reset
      setTimeout(() => {
        populateAddClientCodeSelect();
        window.selectedClientCodes = [];
        updateClientCodesList();
      }, 100);
      document.getElementById('addClientModule').classList.remove('hidden');
    };

    window.showSearchModule = function() {
      hideAllModules();
      // Clear search results and reset form
      document.getElementById('searchByName').value = '';
      document.getElementById('searchByStatus').value = '';
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('searchModule').classList.remove('hidden');
    };

    window.showSettingsModule = async function() {
      hideAllModules();
      const settingsModule = document.getElementById('settingsModule');
      const loadingOverlay = document.getElementById('settingsLoadingOverlay');
      
      // Show settings module immediately
      settingsModule.classList.remove('hidden');
      
      // Show loading overlay if data might not be ready
      // Check if customers array is empty or if we're still in initial load
      const needsLoading = customers.length === 0;
      
      if (needsLoading && loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }
      
      // Wait for data to be loaded if customers array is empty
      // This ensures data is ready before showing the tables
      if (needsLoading) {
        // Data might still be loading, wait a bit and check again
        let attempts = 0;
        const maxAttempts = 50; // 5 seconds max wait (50 * 100ms)
        
        while (customers.length === 0 && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }
      }
      
      // Small delay to ensure data is fully processed and UI is ready
      await new Promise(resolve => setTimeout(resolve, 50));
      
      // Populate the settings tables
      updateSettingsCustomerTable();
      updateSettingsLocationsTable();
      updateSettingsUsersTable();
      
      // Hide loading overlay once data is ready
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
    };

    window.hideAllModules = function() {
      document.getElementById('paymentModule').classList.add('hidden');
      document.getElementById('billModule').classList.add('hidden');
      document.getElementById('addClientModule').classList.add('hidden');
      document.getElementById('searchModule').classList.add('hidden');
      document.getElementById('settingsModule').classList.add('hidden');
    };

    // Payment Module Functions
    function populatePaymentCustomerSelect() {
      const select = document.getElementById('paymentCustomerSelect');
      if (!select) {

        return;
      }
      select.innerHTML = '<option value="">Choose a customer...</option>';

      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.name} (${customer.accountNumber})`;
        select.appendChild(option);
      });

      select.onchange = function() {
        const customerId = this.value;

        if (customerId) {
          showCustomerPaymentInfo(customerId);
        } else {
          hideCustomerPaymentInfo();
        }
      };

    }

    function populateBatchStartUserSelect() {
      const select = document.getElementById('batchStartUserSelect');
      if (!select) {

        return;
      }

      select.innerHTML = '<option value="">Select a user...</option>';
      users.forEach(user => {
        const option = document.createElement('option');
        const fullName = user.fullName || user.id || 'Unnamed User';
        option.value = fullName;
        option.textContent = fullName;
        select.appendChild(option);
      });

    }

    function showCustomerPaymentInfo(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        // Calculate prorated service cost based on when customer was added
        const serviceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFee = pastDue > 0 ? 20 : 0; // $20 late fee if there's past due
        const subtotal = serviceCost + pastDue + lateFee;

        // Calculate code surcharges (applied only to service cost, not subtotal)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += serviceCost * (codeAmount / 100);
            }
          });
        }

        const totalAmount = subtotal + totalSurcharge;

        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Set up status indicator
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        document.getElementById('paymentAmountDue').textContent = `$${totalAmount.toFixed(2)}`;
        document.getElementById('paymentPastDue').textContent = `$${customer.pastDue.toFixed(2)}`;
        document.getElementById('paymentDueDate').textContent = dueDateStr;
        document.getElementById('paymentLateFee').textContent = `$${lateFee.toFixed(2)}`;
        document.getElementById('paymentAmount').value = (totalAmount + customer.pastDue).toFixed(2);

        // Update status indicator
        const statusIndicator = document.getElementById('paymentStatusIndicator');
        statusIndicator.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
        statusIndicator.textContent = customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1);

        // Update property location
        document.getElementById('paymentPropertyLocation').textContent = customer.address;

        document.getElementById('customerPaymentInfo').classList.remove('hidden');
      }
    }

    // Calculate prorated service cost based on when customer was added
    function calculateProratedServiceCost(customer) {
      const baseServiceCost = 170;

      // Imported customers should not be prorated - always charge full amount
      if (customer.importData) {
        return baseServiceCost;
      }

      // If customer was added this month, calculate proration
      const now = new Date();
      const customerAddedDate = new Date(customer.createdDate);

      // Check if customer was added in the current month
      if (customerAddedDate.getMonth() === now.getMonth() && 
          customerAddedDate.getFullYear() === now.getFullYear()) {

        // Calculate days remaining in the month from when they joined
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const totalDaysInMonth = lastDayOfMonth.getDate();

        // Days from when they joined to end of month
        const daysRemaining = lastDayOfMonth.getDate() - customerAddedDate.getDate() + 1;

        // Calculate prorated amount
        const proratedAmount = (baseServiceCost * daysRemaining) / totalDaysInMonth;

        return Math.round(proratedAmount * 100) / 100; // Round to 2 decimal places
      }

      // If customer was added in a previous month, charge full amount
      return baseServiceCost;
    }

    function hideCustomerPaymentInfo() {
      document.getElementById('customerPaymentInfo').classList.add('hidden');
    }

    // Bill Module Functions
    function populateBillCustomerSelect() {
      const select = document.getElementById('billCustomerSelect');
      select.innerHTML = '<option value="">Choose a customer...</option>';

      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.name} (${customer.accountNumber})`;
        select.appendChild(option);
      });

      // Add event listener for customer selection
      select.addEventListener('change', function() {
        const customerId = this.value;
        if (customerId) {
          showCustomerBillInfo(customerId);
        } else {
          hideCustomerBillInfo();
        }
      });
    }

    function showCustomerBillInfo(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        // Calculate prorated service cost based on when customer was added
        const serviceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFee = pastDue > 0 ? 20 : 0; // $20 late fee if there's past due
        const subtotal = serviceCost + pastDue + lateFee;

        // Calculate code surcharges (applied only to service cost, not subtotal)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += serviceCost * (codeAmount / 100);
            }
          });
        }

        // Calculate factor adjustment (based on service cost only)
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const factorAdjustment = serviceCost * (factor - 1);
        const totalAmount = serviceCost + pastDue + lateFee + totalSurcharge + factorAdjustment;

        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Set up status indicator
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        document.getElementById('billAmountDue').textContent = `$${totalAmount.toFixed(2)}`;
        document.getElementById('billPastDue').textContent = `$${customer.pastDue.toFixed(2)}`;
        document.getElementById('billDueDate').textContent = dueDateStr;
        document.getElementById('billLateFee').textContent = `$${lateFee.toFixed(2)}`;

        // Update status indicator
        const statusIndicator = document.getElementById('billStatusIndicator');
        statusIndicator.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
        statusIndicator.textContent = customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1);

        // Update property location
        document.getElementById('billPropertyLocation').textContent = customer.address;

        document.getElementById('customerBillInfo').classList.remove('hidden');
      }
    }

    function hideCustomerBillInfo() {
      document.getElementById('customerBillInfo').classList.add('hidden');
    }

    window.resetBillForm = function() {
      const billModule = document.getElementById('billModule');
      billModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>

          <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>

            <br>
            <button 
              onclick="produceBill()" 
              class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Bill
            </button>

            <!-- PDF Display Container -->
            <div id="billPdfDisplay" class="hidden mt-4">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            </div>
          </div>
        </div>

      `;

      // Repopulate the customer dropdown
      populateBillCustomerSelect();
    };

    window.produceBill = async function() {
      const customerId = document.getElementById('billCustomerSelect').value;
      if (!customerId) {
        alert('Please select a customer');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      try {
        // Calculate all the amounts (same logic as showCustomerBillInfo)
        const serviceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFee = pastDue > 0 ? 20 : 0; // $20 late fee if there's past due
        const subtotal = serviceCost + pastDue + lateFee;

        // Calculate code surcharges (applied only to service cost, not subtotal)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += serviceCost * (codeAmount / 100);
            }
          });
        }

        // Calculate factor adjustment (based on service cost only)
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const factorAdjustment = serviceCost * (factor - 1);
        const totalAmount = serviceCost + pastDue + lateFee + totalSurcharge + factorAdjustment;

        // Calculate dates
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const statementDate = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getFullYear();

        // Calculate billing cycle (first day of month to last day of month)
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayStr = (firstDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           firstDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                           String(firstDayOfMonth.getFullYear()).slice(-2);
        const lastDayStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          String(lastDayOfMonth.getFullYear()).slice(-2);
        const cyclePeriod = `${firstDayStr} to ${lastDayStr}`;

        // Due date is the last day of the billing cycle month (same as lastDayOfMonth)
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Create FormData with all the required fields
        const formData = new FormData();
        formData.append('account_no', customer.accountNumber || '');
        formData.append('account_name', customer.name || '');
        formData.append('account_address', customer.address || '');
        formData.append('statement_date', statementDate);
        formData.append('cycle_period', cyclePeriod);
        formData.append('current_charges', `$${serviceCost.toFixed(2)}`);
        formData.append('previous_charges', `$${customer.pastDue.toFixed(2)}`);
        formData.append('taxes_charges', `$${totalSurcharge.toFixed(2)}`);
        formData.append('total_amount', `$${totalAmount.toFixed(2)}`);
        formData.append('due_date', dueDateStr);

        // Send to server
        const response = await fetch('/edit_pdf?pdf=bill', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Failed to generate PDF');
        }

        // Get the PDF blob
        const blob = await response.blob();

        // Create blob URL for download
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'bill.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        // Display the PDF below the button
        const displayUrl = URL.createObjectURL(blob);
        const pdfDisplay = document.getElementById('billPdfDisplay');
        const pdfViewer = document.getElementById('billPdfViewer');
        const billModule = document.getElementById('billModule');

        if (pdfDisplay && pdfViewer) {
          // Revoke any previous display URL to prevent memory leaks
          if (pdfViewer.src && pdfViewer.src.startsWith('blob:')) {
            URL.revokeObjectURL(pdfViewer.src);
          }

          pdfViewer.src = displayUrl;
          pdfDisplay.classList.remove('hidden');

          // Increase bill module height by 25% when PDF is displayed
          if (billModule) {
            // Wait a moment for the PDF display to render, then calculate height
            setTimeout(() => {
              const currentHeight = billModule.offsetHeight;
              billModule.style.minHeight = `${currentHeight * 1.25}px`;
              billModule.style.paddingBottom = '2rem';
            }, 50);
          }

          // Scroll to the PDF viewer smoothly
          setTimeout(() => {
            pdfDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 100);
        } else {
          // If elements don't exist, create them dynamically
          const customerBillInfo = document.getElementById('customerBillInfo');
          if (customerBillInfo) {
            const pdfContainer = document.createElement('div');
            pdfContainer.id = 'billPdfDisplay';
            pdfContainer.className = 'mt-4';
            pdfContainer.innerHTML = `
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            `;
            customerBillInfo.appendChild(pdfContainer);
            document.getElementById('billPdfViewer').src = displayUrl;

            // Increase bill module height by 25% when PDF is displayed
            if (billModule) {
              // Wait a moment for the PDF display to render, then calculate height
              setTimeout(() => {
                const currentHeight = billModule.offsetHeight;
                billModule.style.minHeight = `${currentHeight * 1.25}px`;
                billModule.style.paddingBottom = '2rem';
              }, 50);
            }

            setTimeout(() => {
              pdfContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
          }
        }

        alert('Bill PDF generated successfully!');
      } catch (error) {

        alert('Failed to generate bill PDF: ' + error.message);
      }
    };

    window.showBillDetailsModal = function() {
      // Placeholder function - can be implemented later if needed
      const customerId = document.getElementById('billCustomerSelect').value;
      if (customerId) {
        showAmountDetails(customerId);
      }
    };

    window.processPaymentFromModule = async function() {

      const paymentModule = document.getElementById('paymentModule');

      if (window.currentPaymentBatch) {

      }

      const customerId = document.getElementById('paymentCustomerSelect')?.value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount')?.value);
      const paymentType = document.getElementById('paymentType')?.value || '';

      if (!customerId) {

        alert('Please select a customer');
        return;
      }

      if (!paymentAmount || paymentAmount <= 0) {

        alert('Please enter a valid payment amount');
        return;
      }

      if (!paymentType) {

        alert('Please select a payment type');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (customer) {

        // Process payment (same logic as existing processPayment function)
        const today = new Date();
        const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();

        // Add to payment history
        if (!customer.paymentHistory) {
          customer.paymentHistory = [];
        }
        customer.paymentHistory.push({
          date: formattedDate,
          amountPaid: paymentAmount,
          amountDue: customer.pastDue + (customer.currentBill || 0)
        });

        // Update customer balance
        customer.pastDue = Math.max(0, customer.pastDue - paymentAmount);

        // If customer was pending closing and now has no balance, mark as inactive
        if (customer.paymentStatus === 'pending closing' && customer.pastDue === 0 && customer.currentBill === 0) {
          customer.paymentStatus = 'inactive';
        } else {
          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);
        }

        // Update last payment
        customer.lastPayment = formattedDate;

        // Save to Firestore
        await saveCustomersToFirestore();

        updateDashboard();

        if (window.currentPaymentBatch) {

          addEntryToCurrentBatch(customer, paymentAmount, paymentType, formattedDate);

        } else {

          showPaymentSuccessScreen(customer.name, paymentAmount);
        }

      } else {

      }
    };

    // Show payment success screen
    window.showPaymentSuccessScreen = function(customerName, amount) {
      const paymentModule = document.getElementById('paymentModule');
      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Processed Successfully!</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>

          <h4 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Payment Processed Successfully!</h4>
          <p class="text-slate-600 dark:text-slate-400 mb-4">Payment of <span class="font-semibold text-green-600">$${amount.toFixed(2)}</span> has been processed for <span class="font-semibold">${customerName}</span></p>
          <p class="text-sm text-slate-500 dark:text-slate-400 mb-8">The payment has been recorded and the customer's account has been updated.</p>

          <div class="flex flex-col gap-4 justify-center">
            <button 
              onclick="resetPaymentForm()" 
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Make Another Payment
            </button>
            <button 
              onclick="hideAllModules()" 
              class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Exit
            </button>
          </div>
        </div>

      `;
    };

    // Reset payment form
    window.resetPaymentForm = function(keepHidden = false) {

      console.trace('[FLOW][resetPaymentForm][STEP 1.1] Stack trace to see who called this:');
      const paymentModule = document.getElementById('paymentModule');

      if (window.currentPaymentBatch) {

      }

      window.currentPaymentBatch = null;

      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Batches</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="batchStartSection" class="space-y-6 py-8 px-6 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-center">
          <p class="text-slate-700 dark:text-slate-100 text-base font-semibold">Group multiple payments into a batch, tag it with your username, and submit everything at once.</p>
          <p class="text-sm text-slate-500 dark:text-slate-300">Select your username and click "Start Batch" to begin capturing payments.</p>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center md:text-left">Select User</label>
              <select 
                id="batchStartUserSelect" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-green-500"
              >
                <option value="">Select a user...</option>
              </select>
            </div>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
              <button 
                onclick="startPaymentBatch()" 
                class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow">
                Start Batch
              </button>
              <button 
                onclick="viewPaymentBatches()" 
                class="w-full md:w-auto bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-3 px-6 rounded-xl shadow">
                View Batches
              </button>
            </div>
          </div>
        </div>

        <div id="batchEntrySection" class="hidden space-y-6 mt-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <p class="text-sm text-slate-500">Active Batch</p>
              <p class="text-lg font-semibold text-slate-800 dark:text-slate-200" id="activeBatchUser">--</p>
            </div>
            <div class="flex gap-3">
              <button onclick="cancelCurrentBatch()" class="text-sm text-slate-500 hover:text-slate-700">End Batch</button>
            </div>
          </div>

          <div class="space-y-6">
            <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="paymentCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>

          <div id="customerPaymentInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="paymentAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewDetailsBtn" onclick="showPaymentDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="paymentPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="paymentLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="paymentPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="paymentDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="paymentStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Type</label>
              <select 
                id="paymentType" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              >
                <option value="">Select Payment Type</option>
                <option value="Check">Check</option>
                <option value="Cash">Cash</option>
              </select>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
              <input 
                type="number" 
                id="paymentAmount" 
                step="0.01" 
                min="0" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter payment amount"
              >
            </div>

            <button 
              onclick="processPaymentFromModule()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Process Payment
            </button>
          </div>
        </div>

        <div id="batchPreviewSection" data-batch-section="preview" class="hidden mt-8 batch-preview-custom">
          <div class="w-full rounded-xl border border-slate-200 bg-white shadow-md overflow-hidden">
            <!-- Header -->
            <div class="border-b px-6 py-4 bg-slate-50 flex items-center justify-between">
              <h2 class="text-lg font-semibold text-slate-800">Batch Preview</h2>
              <button class="px-4 py-2 text-sm bg-green-600 text-white rounded-md shadow hover:bg-green-700 transition">
                Submit Batch
              </button>
            </div>

            <!-- Scrollable Table Wrapper -->
            <div class="overflow-x-auto">
              <table class="min-w-full table-fixed border-collapse text-sm">
                <colgroup>
                  <col style="width: 100px;" />
                  <col style="width: 160px;" />
                  <col style="width: 267px;" />
                  <col style="width: 200px;" />
                  <col style="width: 96px;" />
                  <col style="width: 112px;" />
                </colgroup>

                <!-- Column Headers -->
                <thead class="bg-slate-100 text-xs uppercase text-slate-600">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Date</th>
                    <th class="px-4 py-3 text-left font-semibold">Customer</th>
                    <th class="px-4 py-3 text-left font-semibold">Account #</th>
                    <th class="px-4 py-3 text-left font-semibold">Property</th>
                    <th class="px-4 py-3 text-left font-semibold">Type</th>
                    <th class="px-4 py-3 text-right font-semibold">Amount</th>
                  </tr>
                </thead>

                <!-- Table Rows -->
                <tbody id="batchPreviewTable" class="divide-y divide-slate-100">
                  <!-- Filled by renderBatchPreview() -->
                </tbody>

                <!-- Table Footer -->
                <tfoot class="bg-slate-100">
                  <tr>
                    <td colspan="4"></td>
                    <td class="px-4 py-3 text-right font-semibold text-slate-700">Total</td>
                    <td id="batchPreviewTotal" class="px-4 py-3 text-right font-bold text-slate-900">$0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <div id="batchesListSection" data-batch-section="list" class="hidden mt-8">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Submitted Batches</h4>
            <button onclick="closeBatchList()" class="text-sm text-slate-500 hover:text-slate-700">Close</button>
          </div>
          <div class="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-inner">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Batch ID</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">User</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Entries</th>
                  <th class="px-4 py-2 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Amount</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Submitted</th>
                </tr>
              </thead>
              <tbody id="batchesListTable" class="bg-white divide-y divide-slate-200">
                <tr>
                  <td colspan="5" class="px-4 py-3 text-center text-sm text-slate-500">No batches submitted yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;

      // Repopulate dropdowns and ensure sections/logs are in sync

      populatePaymentCustomerSelect();
      populateBatchStartUserSelect();

      setBatchViewState('start');

      renderBatchPreview();

      renderBatchesList();
      // If keepHidden is true, ensure payment module stays hidden (for initial page load)
      if (keepHidden) {
        paymentModule.classList.add('hidden');
      }

      debugBatchDom('after-reset');

    };

    function debugBatchDom(label) {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule) {

        return;
      }
      const snapshot = {
        hasStart: !!paymentModule.querySelector('#batchStartSection'),
        hasEntry: !!paymentModule.querySelector('#batchEntrySection'),
        hasPreview: !!paymentModule.querySelector('#batchPreviewSection'),
        hasPreviewTable: !!paymentModule.querySelector('#batchPreviewTable'),
        hasList: !!paymentModule.querySelector('#batchesListSection'),
        hasListTable: !!paymentModule.querySelector('#batchesListTable')
      };

    }

    function setBatchViewState(view) {

      // Ensure payment module is visible

      const paymentModule = document.getElementById('paymentModule');

      if (paymentModule) {
        const wasHidden = paymentModule.classList.contains('hidden');
        paymentModule.classList.remove('hidden');

      } else {

      }

      const sections = {
        start: document.getElementById('batchStartSection'),
        entry: document.getElementById('batchEntrySection'),
        preview: document.getElementById('batchPreviewSection'),
        list: document.getElementById('batchesListSection')
      };

      Object.entries(sections).forEach(([name, el]) => {
        if (!el) {
          if (view === name) {

          } else {

          }
          return;
        }
        const wasHidden = el.classList.contains('hidden');
        if (view === name) {
          el.classList.remove('hidden');

        } else {
          el.classList.add('hidden');

        }
      });

      debugBatchDom('view-' + view);

      const target = sections[view];
      if (target) {

        requestAnimationFrame(() => {

          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      } else {

      }

    }

    window.startPaymentBatch = function() {
      const userSelect = document.getElementById('batchStartUserSelect');
      const username = userSelect ? userSelect.value.trim() : '';

      if (!username) {
        alert('Please select a user before starting a batch.');
        return;
      }

      // Calculate day of year (1-365/366)
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);

      // Generate batch ID: [username][dayOfYear]
      // Remove spaces from username for the ID
      const usernameForId = username.replace(/\s+/g, '');
      const batchId = `${usernameForId}${dayOfYear}`;

      window.currentPaymentBatch = {
        id: batchId,
        username: username,
        startedAt: new Date().toISOString(),
        entries: []
      };
      renderBatchPreview();

      const activeUserLabel = document.getElementById('activeBatchUser');
      if (activeUserLabel) activeUserLabel.textContent = username;

      setBatchViewState('entry');
      addAnotherBatchEntry();
      debugBatchDom('after-start');
    };

    window.cancelCurrentBatch = function() {
      if (!window.currentPaymentBatch) {
        setBatchViewState('start');
        return;
      }

      if (!confirm('End the current batch? Unsubmitted entries will be lost.')) {
        return;
      }

      window.currentPaymentBatch = null;
      renderBatchPreview();
      setBatchViewState('start');

    };

    window.addAnotherBatchEntry = function() {
      if (!window.currentPaymentBatch) {
        alert('Start a batch before adding entries.');
        return;
      }

      setBatchViewState('entry');
      debugBatchDom('add-entry');
      const select = document.getElementById('paymentCustomerSelect');
      if (select) select.value = '';
      hideCustomerPaymentInfo();
      const paymentTypeField = document.getElementById('paymentType');
      if (paymentTypeField) paymentTypeField.value = '';
      const paymentAmountField = document.getElementById('paymentAmount');
      if (paymentAmountField) paymentAmountField.value = '';

    };

    window.viewPaymentBatches = function() {
      renderBatchesList();
      setBatchViewState('list');

    };

    window.closeBatchList = function() {
      if (window.currentPaymentBatch) {
        setBatchViewState(window.currentPaymentBatch.entries.length ? 'preview' : 'entry');
      } else {
        setBatchViewState('start');
      }

    };

    window.submitCurrentBatch = async function() {
      if (!window.currentPaymentBatch) {
        alert('Start a batch before submitting.');
        return;
      }

      if (window.currentPaymentBatch.entries.length === 0) {
        alert('Add at least one payment to the batch.');
        return;
      }

      const totalAmount = window.currentPaymentBatch.entries.reduce((sum, entry) => sum + entry.amount, 0);
      const submittedBatch = {
        ...window.currentPaymentBatch,
        submittedAt: new Date().toISOString(),
        totalAmount
      };

      window.paymentBatches.push(submittedBatch);
      await saveBatchToFirestore(submittedBatch);
      alert('Batch submitted successfully!');

      window.currentPaymentBatch = null;
      renderBatchPreview();
      renderBatchesList();
      setBatchViewState('list');

      viewPaymentBatches();
    };

    function addEntryToCurrentBatch(customer, paymentAmount, paymentType, paymentDate) {

      if (!window.currentPaymentBatch) {

        return;
      }

      const paymentModule = document.getElementById('paymentModule');

      const entry = {
        id: `ENTRY-${Date.now()}`,
        customerName: customer.name,
        accountNumber: customer.accountNumber || customer.id,
        property: customer.address || 'N/A',
        paymentType,
        amount: paymentAmount,
        date: paymentDate
      };

      window.currentPaymentBatch.entries.push(entry);

      const previewSectionBefore = document.getElementById('batchPreviewSection');
      const previewTableBefore = document.getElementById('batchPreviewTable');

      // Render the preview table first

      renderBatchPreview();

      const previewSectionAfter = document.getElementById('batchPreviewSection');
      const previewTableAfter = document.getElementById('batchPreviewTable');

      // Then switch to preview view - ensure preview section exists and is visible

      const previewSection = document.getElementById('batchPreviewSection');
      if (!previewSection) {

        return;
      }

      setBatchViewState('preview');

      // IMMEDIATE: Force preview section visible right after setBatchViewState
      const immediatePreviewSection = document.getElementById('batchPreviewSection');
      if (immediatePreviewSection) {
        // Remove hidden class
        immediatePreviewSection.classList.remove('hidden');

        // FORCE visibility with inline styles that override everything
        immediatePreviewSection.style.cssText = `
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          position: relative !important;
          width: 100% !important;
        `;

        // Check parent containers
        let parent = immediatePreviewSection.parentElement;
        let depth = 0;
        while (parent && depth < 5) {
          const parentStyle = window.getComputedStyle(parent);

          // Force parent visible if needed
          if (parent.classList.contains('hidden')) {
            parent.classList.remove('hidden');
            parent.style.display = 'block';
            parent.style.visibility = 'visible';
            parent.style.opacity = '1';

          }

          parent = parent.parentElement;
          depth++;
        }

        const immediateRect = immediatePreviewSection.getBoundingClientRect();

        // Force scroll into view immediately
        immediatePreviewSection.scrollIntoView({ behavior: 'auto', block: 'start', inline: 'nearest' });

        // Also ensure payment module is visible
        if (paymentModule) {
          paymentModule.classList.remove('hidden');
          paymentModule.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          `;

        }
      } else {

      }

      // Double-check preview section is visible

      // Force payment module visible
      if (paymentModule.classList.contains('hidden')) {

        paymentModule.classList.remove('hidden');
      }

      // Force preview section visible
      if (previewSection.classList.contains('hidden')) {

        previewSection.classList.remove('hidden');

      } else {

      }

      // Check computed styles to verify visibility
      const previewSectionStyle = window.getComputedStyle(previewSection);
      const paymentModuleStyle = window.getComputedStyle(paymentModule);

      // Final verification after a short delay
      setTimeout(() => {
        const finalPreviewSection = document.getElementById('batchPreviewSection');
        const finalPaymentModule = document.getElementById('paymentModule');
        const finalTable = document.getElementById('batchPreviewTable');

        // AGGRESSIVE: Force everything visible
        if (finalPaymentModule) {
          finalPaymentModule.classList.remove('hidden');
          finalPaymentModule.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          `;
        }

        if (finalPreviewSection) {
          finalPreviewSection.classList.remove('hidden');
          // FORCE visibility without breaking layout
          finalPreviewSection.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
          `;

          // Force the table inside to be visible too
          if (finalTable) {
            finalTable.style.cssText = `
              display: table !important;
              visibility: visible !important;
              width: 100% !important;
            `;
          }

          // Scroll preview section into view
          finalPreviewSection.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });

          // Check bounding rect to verify it's actually visible
          const rect = finalPreviewSection.getBoundingClientRect();

          // If still zero dimensions, try even more aggressive approach
          if (rect.width === 0 || rect.height === 0) {

            // Try appending to body temporarily to see if it's a parent issue
            const originalParent = finalPreviewSection.parentElement;
            document.body.appendChild(finalPreviewSection);
            const bodyRect = finalPreviewSection.getBoundingClientRect();

            // Put it back
            originalParent.appendChild(finalPreviewSection);
          }
        }

        if (finalTable) {
          const tableRect = finalTable.getBoundingClientRect();

        }
      }, 100);

      debugBatchDom('after-add-entry');

    }

    function renderBatchPreview() {
      const tbody = document.getElementById("batchPreviewTable");
      const totalCell = document.getElementById("batchPreviewTotal");

      // If tbody doesn't exist, just return
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!window.currentPaymentBatch || !window.currentPaymentBatch.entries || window.currentPaymentBatch.entries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-3 text-center text-sm text-slate-500">
              No payments added yet.
            </td>
          </tr>
        `;
        if (totalCell) totalCell.textContent = "$0.00";
        return;
      }

      window.currentPaymentBatch.entries.forEach(entry => {
        const row = document.createElement("tr");
        row.className = "hover:bg-slate-50 transition-colors";

        // Format property as multi-line (the KEY fix)
        const [street, cityStateZip] = entry.property.split(/,(.+)/);

        row.innerHTML = `
            <td class="px-4 py-4 align-top whitespace-nowrap">${entry.date || ''}</td>
            <td class="px-4 py-4 align-top whitespace-nowrap">${entry.customerName || ''}</td>
            <td class="px-4 py-4 align-top whitespace-nowrap">${entry.accountNumber || ''}</td>
            <td class="px-4 py-4 align-top leading-5">
                ${street || ''}${cityStateZip ? ',<br>' + cityStateZip.trim() : ''}
            </td>
            <td class="px-4 py-4 align-top whitespace-nowrap">${entry.paymentType || ''}</td>
            <td class="px-4 py-4 align-top text-right whitespace-nowrap">$${(entry.amount || 0).toFixed(2)}</td>
        `;

        tbody.appendChild(row);
      });

      // Update total
      const total = window.currentPaymentBatch.entries.reduce((sum, e) => sum + (e.amount || 0), 0);
      if (totalCell) {
        totalCell.textContent = `$${total.toFixed(2)}`;
      }
    }

    function renderBatchesList() {
      const tbody = document.getElementById('batchesListTable');
      if (!tbody) {

        debugBatchDom('renderList-missing');
        return;
      }

      if (!window.paymentBatches || window.paymentBatches.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-3 text-center text-sm text-slate-500">No batches submitted yet.</td></tr>`;

        return;
      }

      let rows = '';
      window.paymentBatches.slice().reverse().forEach(batch => {
        const submitted = batch.submittedAt ? new Date(batch.submittedAt).toLocaleString() : 'â€”';
        rows += `
          <tr>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.id}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.username}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.entries.length}</td>
            <td class="px-4 py-2 text-sm text-slate-700 text-right">$${(batch.totalAmount || 0).toFixed(2)}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${submitted}</td>
          </tr>
        `;
      });

      tbody.innerHTML = rows;

    }

    // Add Client Module Functions
    function populateAddClientLocationSelect() {
      const select = document.getElementById('newClientLocation');
      select.innerHTML = '<option value="">Choose a location...</option><option value="add-new">+ Add New Location</option>';

      // Show all locations, not just available ones
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = `${location.address} (${location.status})`;
        select.appendChild(option);
      });

      // Add event listener for add new location
      select.addEventListener('change', function() {
        if (this.value === 'add-new') {
          showAddLocationModal();
        }
      });
    }

    window.addClientFromModule = async function() {
      const name = document.getElementById('newClientName').value.trim();
      const email = document.getElementById('newClientEmail').value.trim();
      const phone = document.getElementById('newClientPhone').value.replace(/\D/g, '');
      const locationId = document.getElementById('newClientLocation').value;

      // Get new fields
      const entityType = document.getElementById('newClientEntityType')?.value || '';
      const ssn = document.getElementById('newClientSSN')?.value.trim() || '';
      const idType = document.getElementById('newClientIDType')?.value || '';
      const idNumber = document.getElementById('newClientIDNumber')?.value.trim() || '';
      const secondaryContactName = document.getElementById('newClientSecondaryContactName')?.value.trim() || '';
      const secondaryContactPhone = document.getElementById('newClientSecondaryContactPhone')?.value.replace(/\D/g, '') || '';
      const mailingStreet = document.getElementById('newClientMailingStreet')?.value.trim() || '';
      const mailingCity = document.getElementById('newClientMailingCity')?.value.trim() || '';
      const mailingState = document.getElementById('newClientMailingState')?.value || '';
      const mailingZip = document.getElementById('newClientMailingZip')?.value.trim() || '';

      // Build mailing address
      let mailingAddress = '';
      if (mailingStreet || mailingCity || mailingState || mailingZip) {
        const parts = [];
        if (mailingStreet) parts.push(mailingStreet);
        if (mailingCity || mailingState || mailingZip) {
          const cityStateZip = [mailingCity, mailingState, mailingZip].filter(Boolean).join(', ');
          parts.push(cityStateZip);
        }
        mailingAddress = parts.join(', ');
      }

      // Get selected codes
      const selectedCodes = window.selectedClientCodes.map(code => ({
        id: code.id,
        name: code.name,
        type: code.type || 'percentage',
        amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
        percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
      }));

      // Get factor
      const factor = document.getElementById('newClientFactor')?.value.trim() || '';

      if (!name || !email || !phone || !locationId) {
        alert('Please fill in all required fields');
        return;
      }

      if (locationId === 'add-new') {
        alert('Please select a location or add a new one first');
        return;
      }

      const selectedLocation = locations.find(l => l.id === locationId);
      if (!selectedLocation) {
        alert('Selected location not found');
        return;
      }

      // Check if location is already occupied
      if (selectedLocation.status === 'occupied' && selectedLocation.currentResident) {
        const currentResident = customers.find(c => c.name === selectedLocation.currentResident);
        if (currentResident) {
          showTransferOwnershipModal(selectedLocation, currentResident, { 
            name, 
            email, 
            phone,
            entityType,
            ssn,
            idType,
            idNumber,
            secondaryContactName,
            secondaryContactPhone,
            mailingAddress,
            mailingStreet,
            mailingCity,
            mailingState,
            mailingZip,
            codes: selectedCodes,
            factor: factor
          });
          return;
        }
      }

      // Create new customer (same logic as existing addCustomer function)
      const newCustomer = {
        id: 'CUS-' + String(Date.now()).slice(-6), // Use accountNumber as ID
        name: name,
        email: email,
        phone: phone,
        address: selectedLocation.address,
        accountNumber: 'CUS-' + String(Date.now()).slice(-6),
        currentBill: 170,
        pastDue: 0,
        lastPayment: 'Never',
        paymentHistory: [],
        needsPasswordChange: true,
        createdDate: new Date().toISOString(),
        entityType: entityType,
        ssn: ssn,
        idType: idType,
        idNumber: idNumber,
        secondaryContactName: secondaryContactName,
        secondaryContactPhone: secondaryContactPhone,
        mailingAddress: mailingAddress,
        mailingStreet: mailingStreet,
        mailingCity: mailingCity,
        mailingState: mailingState,
        mailingZip: mailingZip,
        codes: selectedCodes,
        factor: factor
      };

      // Update payment status based on past due amount
      updateCustomerPaymentStatus(newCustomer);

      customers.push(newCustomer);
      filteredCustomers = [...customers];

      // Update location
      selectedLocation.currentResident = name;
      selectedLocation.status = 'occupied';
      selectedLocation.ownerFullName = name;
      const nameParts = name.split(' ');
      selectedLocation.ownerFirstName = nameParts[0] || '';
      selectedLocation.ownerLastName = nameParts.slice(1).join(' ') || '';

      // Clear selected codes after creation
      window.selectedClientCodes = [];
      updateClientCodesList();

      // Save to Firestore
      await saveCustomersToFirestore();
      await saveLocationsToFirestore();
      updateDashboard();

      // Show success screen instead of hiding module
      showClientSuccessScreen();
    };

    // Show client success screen
    window.showClientSuccessScreen = function() {
      const addClientModule = document.getElementById('addClientModule');
      addClientModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Client Successfully Added!</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>

          <h4 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Client Added Successfully!</h4>
          <p class="text-slate-600 dark:text-slate-400 mb-8">The client has been added to the system successfully</p>

          <div class="flex flex-col gap-4 justify-center">
            <button 
              onclick="resetAddClientForm()" 
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Add Another Client
            </button>
            <button 
              onclick="hideAllModules()" 
              class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Exit
            </button>
          </div>
        </div>
      `;
    };

    // Reset add client form
    window.resetAddClientForm = function() {
      const addClientModule = document.getElementById('addClientModule');
      addClientModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Client</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Account Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              type="text" 
              id="newClientName" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter full name"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
            <input 
              type="email" 
              id="newClientEmail" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter email address"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <input 
              type="tel" 
              id="newClientPhone" 
              oninput="formatPhoneInput(this)"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="(xxx)-xxx-xxxx"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <select id="newClientLocation" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" required>
              <option value="">Choose a location...</option>
              <option value="add-new">+ Add New Location</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <select id="newClientEntityType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Select Entity Type</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Farmer">Farmer</option>
            </select>
          </div>
        </div>
        </div>

        <!-- Identification Info Section -->
        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Identification Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
              <input 
                type="text" 
                id="newClientSSN" 
                oninput="formatSSNInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="xxx-xx-xxxx"
                maxlength="11"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
              <select id="newClientIDType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Select ID Type</option>
                <option value="Drivers License">Drivers License</option>
                <option value="ID">ID</option>
                <option value="Passport">Passport</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
              <input 
                type="text" 
                id="newClientIDNumber" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter ID number"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
              <input 
                type="text" 
                id="newClientSecondaryContactName" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter secondary contact name"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
              <input 
                type="tel" 
                id="newClientSecondaryContactPhone" 
                oninput="formatPhoneInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="(xxx)-xxx-xxxx"
              >
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
              <input 
                type="text" 
                id="newClientMailingStreet" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter street address"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <input 
                type="text" 
                id="newClientMailingCity" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter city"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <select id="newClientMailingState" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Select State</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
              <input 
                type="text" 
                id="newClientMailingZip" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter ZIP code"
                maxlength="10"
              >
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
          <div id="newClientCodesList" class="space-y-2">
            <!-- Selected codes will be displayed here -->
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
            <input 
              type="number" 
              id="newClientFactor" 
              step="any"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter factor"
            >
          </div>
        </div>

        <div class="mt-6">
          <button 
            onclick="addClientFromModule()" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
          >
            Create Client Account
          </button>
        </div>
      `;

      // Repopulate the location dropdown
      populateAddClientLocationSelect();
      // Populate codes dropdown
      populateAddClientCodeSelect();
      // Clear selected codes
      window.selectedClientCodes = [];
      updateClientCodesList();

      // Add event listener to Entity Type dropdown for auto-adding codes
      const entityTypeSelect = document.getElementById('newClientEntityType');
      if (entityTypeSelect) {
        // Remove existing listeners by cloning the element
        const newEntityTypeSelect = entityTypeSelect.cloneNode(true);
        entityTypeSelect.parentNode.replaceChild(newEntityTypeSelect, entityTypeSelect);

        newEntityTypeSelect.addEventListener('change', function() {
          const selectedEntityType = this.value;
          // Auto-add matching codes based on Entity Type
          autoAddCodesForEntityType(selectedEntityType);
        });
      }
    };

    // Check if a code matches the selected Entity Type
    function codeMatchesEntityType(code, entityType) {
      if (!entityType || !code.requirements) {
        return false;
      }

      // Handle new requirements structure with AND/OR logic
      if (code.requirements && code.requirements.values && Array.isArray(code.requirements.values)) {
        const entityTypeInValues = code.requirements.values.includes(entityType);

        if (code.requirements.type === 'OR') {
          // OR logic: Entity Type must be in the values array
          return entityTypeInValues;
        } else if (code.requirements.type === 'AND') {
          // AND logic: For now, we'll check if Entity Type is in values
          // (Full AND logic would require Entity Type to match all values, which isn't possible with single selection)
          return entityTypeInValues;
        }
      }

      // Handle old array format (backward compatibility)
      if (Array.isArray(code.requirements)) {
        return code.requirements.includes(entityType);
      }

      return false;
    }

    // Automatically add codes based on Entity Type
    function autoAddCodesForEntityType(entityType) {
      if (!entityType) {
        return;
      }

      // Check each code to see if it matches the Entity Type
      codes.forEach(code => {
        if (codeMatchesEntityType(code, entityType)) {
          // Check if code is already added
          if (!window.selectedClientCodes.find(c => c.id === code.id)) {
            window.selectedClientCodes.push(code);
          }
        }
      });

      updateClientCodesList();
    }

    // Populate codes dropdown for Add Client form
    function populateAddClientCodeSelect() {
      const select = document.getElementById('newClientCodeSelect');
      if (!select) return;

      select.innerHTML = '<option value="">Select a code...</option>';
      codes.forEach(code => {
        const option = document.createElement('option');
        option.value = code.id;
        const codeType = code.type || 'percentage';
        const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
        const displayText = codeType === 'flat' 
          ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
          : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
        option.textContent = displayText;
        select.appendChild(option);
      });
    }

    // Initialize selected codes array
    window.selectedClientCodes = [];
    window.selectedCustomerCodes = [];

    // Add code to client
    window.addClientCode = function() {
      const select = document.getElementById('newClientCodeSelect');
      if (!select || !select.value) {
        alert('Please select a code first');
        return;
      }

      const codeId = select.value;
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      // Check if already added
      if (window.selectedClientCodes.find(c => c.id === codeId)) {
        alert('This code has already been added');
        select.value = '';
        return;
      }

      window.selectedClientCodes.push(code);
      select.value = '';
      updateClientCodesList();
    };

    // Remove code from client
    window.removeClientCode = function(codeId) {
      window.selectedClientCodes = window.selectedClientCodes.filter(c => c.id !== codeId);
      updateClientCodesList();
    };

    // Update codes list display
    function updateClientCodesList() {
      const listContainer = document.getElementById('newClientCodesList');
      if (!listContainer) return;

      if (window.selectedClientCodes.length === 0) {
        listContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400">No codes selected</p>';
        return;
      }

        listContainer.innerHTML = window.selectedClientCodes.map(code => {
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          return `
          <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
            <span class="text-sm text-slate-800 dark:text-slate-200">${displayText}</span>
          <button 
            type="button"
            onclick="removeClientCode('${code.id}')" 
            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-sm"
          >
            Remove
          </button>
        </div>
      `;
        }).join('');
    }

    // Add code to customer (for Add Customer modal)
    window.addCustomerCode = function() {
      const select = document.getElementById('newCustomerCodeSelect');
      if (!select || !select.value) {
        alert('Please select a code first');
        return;
      }

      const codeId = select.value;
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      // Check if already added
      if (window.selectedCustomerCodes.find(c => c.id === codeId)) {
        alert('This code has already been added');
        select.value = '';
        return;
      }

      window.selectedCustomerCodes.push(code);
      select.value = '';
      updateCustomerCodesList();
    };

    // Remove code from customer
    window.removeCustomerCode = function(codeId) {
      window.selectedCustomerCodes = window.selectedCustomerCodes.filter(c => c.id !== codeId);
      updateCustomerCodesList();
    };

    // Update customer codes list display
    function updateCustomerCodesList() {
      const listContainer = document.getElementById('newCustomerCodesList');
      if (!listContainer) return;

      if (window.selectedCustomerCodes.length === 0) {
        listContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400">No codes selected</p>';
        return;
      }

        listContainer.innerHTML = window.selectedCustomerCodes.map(code => {
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          return `
          <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
            <span class="text-sm text-slate-800 dark:text-slate-200">${displayText}</span>
          <button 
            type="button"
            onclick="removeCustomerCode('${code.id}')" 
            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-sm"
          >
            Remove
          </button>
        </div>
      `;
        }).join('');
    }

    // Search Module Functions
    window.performSearch = function() {
      const nameQuery = document.getElementById('searchByName').value.toLowerCase().trim();
      const statusFilter = document.getElementById('searchByStatus').value;

      let results = customers;

      // Filter by name
      if (nameQuery) {
        results = results.filter(customer => 
          customer.name.toLowerCase().includes(nameQuery)
        );
      }

      // Filter by status
      if (statusFilter) {
        results = results.filter(customer => 
          customer.paymentStatus === statusFilter
        );
      }

      displaySearchResults(results);
    };

    window.clearSearch = function() {
      document.getElementById('searchByName').value = '';
      document.getElementById('searchByStatus').value = '';
      document.getElementById('searchResults').innerHTML = '';
    };

    function displaySearchResults(results) {
      const container = document.getElementById('searchResults');

      if (results.length === 0) {
        container.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">No customers found matching your search criteria.</p>';
        return;
      }

      let html = '<div class="space-y-4">';
      results.forEach(customer => {
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0;
        const totalAmount = serviceCost + lateFee;

        const statusClass = customer.paymentStatus === 'overdue' ? 
          'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
          customer.paymentStatus === 'inactive' ?
          'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200' :
          customer.paymentStatus === 'pending closing' ?
          'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
          'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';

        html += `
          <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-semibold text-slate-800 dark:text-slate-200">${customer.name}</h4>
                <p class="text-sm text-slate-600 dark:text-slate-400">${customer.email}</p>
                <p class="text-sm text-slate-600 dark:text-slate-400">${customer.accountNumber}</p>
              </div>
              <div class="text-right">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                  ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
                </span>
                <p class="text-lg font-semibold text-slate-800 dark:text-slate-200 mt-2">$${totalAmount.toFixed(2)}</p>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    // Add new customer
    window.showAddCustomerModal = function() {
      // Populate location dropdown with all locations
      const locationSelect = document.getElementById('newCustomerLocation');
      locationSelect.innerHTML = '<option value="">Select a property location</option>';

      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = `${location.address} (${location.status})`;
        locationSelect.appendChild(option);
      });

      // Populate codes dropdown
      const codeSelect = document.getElementById('newCustomerCodeSelect');
      if (codeSelect) {
        codeSelect.innerHTML = '<option value="">Select a code...</option>';
        codes.forEach(code => {
          const option = document.createElement('option');
          option.value = code.id;
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          option.textContent = displayText;
          codeSelect.appendChild(option);
        });
      }

      // Clear selected codes
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();

      document.getElementById('addCustomerModal').classList.remove('hidden');
    };

    window.hideAddCustomerModal = function() {
      document.getElementById('addCustomerModal').classList.add('hidden');
      document.getElementById('addCustomerForm').reset();
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();
    };

    window.addCustomer = async function() {
      const name = document.getElementById('newCustomerName').value;
      const email = document.getElementById('newCustomerEmail').value;
      const locationId = document.getElementById('newCustomerLocation').value;
      const phone = document.getElementById('newCustomerPhone').value.replace(/\D/g, ''); // Store as digits only

      // Get new fields
      const entityType = document.getElementById('newCustomerEntityType')?.value || '';
      const ssn = document.getElementById('newCustomerSSN')?.value.trim() || '';
      const idType = document.getElementById('newCustomerIDType')?.value || '';
      const idNumber = document.getElementById('newCustomerIDNumber')?.value.trim() || '';
      const secondaryContactName = document.getElementById('newCustomerSecondaryContactName')?.value.trim() || '';
      const secondaryContactPhone = document.getElementById('newCustomerSecondaryContactPhone')?.value.replace(/\D/g, '') || '';
      const mailingStreet = document.getElementById('newCustomerMailingStreet')?.value.trim() || '';
      const mailingCity = document.getElementById('newCustomerMailingCity')?.value.trim() || '';
      const mailingState = document.getElementById('newCustomerMailingState')?.value || '';
      const mailingZip = document.getElementById('newCustomerMailingZip')?.value.trim() || '';

      // Build mailing address
      let mailingAddress = '';
      if (mailingStreet || mailingCity || mailingState || mailingZip) {
        const parts = [];
        if (mailingStreet) parts.push(mailingStreet);
        if (mailingCity || mailingState || mailingZip) {
          const cityStateZip = [mailingCity, mailingState, mailingZip].filter(Boolean).join(', ');
          parts.push(cityStateZip);
        }
        mailingAddress = parts.join(', ');
      }

      // Get selected codes
      const selectedCodes = window.selectedCustomerCodes.map(code => ({
        id: code.id,
        name: code.name,
        type: code.type || 'percentage',
        amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
        percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
      }));

      // Get factor
      const factor = document.getElementById('newCustomerFactor')?.value.trim() || '';

      if (!name || !email || !locationId || !phone) {
        alert('Please fill in all required fields');
        return;
      }

      // Find the selected location
      const selectedLocation = locations.find(l => l.id === locationId);
      if (!selectedLocation) {
        alert('Selected location not found');
        return;
      }

      if (selectedLocation.status === 'occupied') {
        alert('This location is already occupied. Please select an available location.');
        return;
      }

      // Calculate current month's bill
      const now = new Date();
      const isNewMonth = now.getDate() === 1; // Check if it's the first of the month

      const newCustomer = {
        id: `CUS-${String(customers.length + 1).padStart(6, '0')}`,
        name: name,
        email: email,
        locationId: locationId,
        address: selectedLocation.address,
        accountNumber: `CUS-${String(customers.length + 1).padStart(6, '0')}`,
        currentBill: isNewMonth ? 170 : 0, // New bill on 1st of month, otherwise 0
        pastDue: 0,
        lastPayment: 'Never',
        needsPasswordChange: true,
        createdDate: (() => {
          const today = new Date();
          return (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                 today.getDate().toString().padStart(2, '0') + '/' + 
                 today.getFullYear();
        })(),
        phone: phone,
        paymentHistory: [], // Track payment history
        entityType: entityType,
        ssn: ssn,
        idType: idType,
        idNumber: idNumber,
        secondaryContactName: secondaryContactName,
        secondaryContactPhone: secondaryContactPhone,
        mailingAddress: mailingAddress,
        mailingStreet: mailingStreet,
        mailingCity: mailingCity,
        mailingState: mailingState,
        mailingZip: mailingZip,
        codes: selectedCodes,
        factor: factor
      };

      // Update payment status based on past due amount
      updateCustomerPaymentStatus(newCustomer);

      // Update location status and owner
      selectedLocation.currentResident = name;
      selectedLocation.status = 'occupied';
      selectedLocation.ownerFirstName = name.split(' ')[0];
      selectedLocation.ownerLastName = name.split(' ').slice(1).join(' ');
      selectedLocation.ownerFullName = name;

      customers.push(newCustomer);
      filteredCustomers = [...customers];

      // Clear selected codes after creation
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();

      updateDashboard();
      await saveCustomersToFirestore();
      hideAddCustomerModal();

      alert('Customer added successfully!');
    };

    // Mark customer as paid
    window.markAsPaid = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        const today = new Date();
        const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();

        customer.pastDue = 0;
        customer.lastPayment = formattedDate;
        customer.currentBill = 0; // Reset current bill to 0 for early payment
        // Update payment status based on past due amount
        updateCustomerPaymentStatus(customer);
        updateDashboard();
        await saveCustomersToFirestore();
        alert('Payment recorded successfully! Amount due is now $0.00 until next month.');
      }
    };

    // Edit customer
    window.editCustomer = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        const newName = prompt('Enter new name:', customer.name);
        const newAddress = prompt('Enter new address:', customer.address);

        if (newName && newAddress) {
          customer.name = newName;
          customer.address = newAddress;
          updateDashboard();
          await saveCustomersToFirestore();
          alert('Customer updated successfully!');
        }
      }
    };

    // Delete customer
    window.deleteCustomer = async function(customerId) {
      if (confirm('Are you sure you want to delete this customer? This will permanently delete their account and all associated data.')) {
        const customer = customers.find(c => c.id === customerId);

        if (!customer) {
          alert('Customer not found');
          return;
        }

        try {
          // Delete customer document from Firestore
          const customerRef = doc(db, 'customers', customerId);
          await deleteDoc(customerRef);

          // Remove from local arrays FIRST
          customers = customers.filter(c => c.id !== customerId);
          filteredCustomers = [...customers];

          // Find and update the associated location
          const associatedLocation = locations.find(l => l.currentResident === customer.name);
          if (associatedLocation) {
            associatedLocation.currentResident = null;
            associatedLocation.status = 'available';
            associatedLocation.ownerFirstName = '';
            associatedLocation.ownerLastName = '';
            associatedLocation.ownerFullName = '';

            // Update filtered locations if needed
            const filteredLocationIndex = filteredLocations.findIndex(l => l.id === associatedLocation.id);
            if (filteredLocationIndex !== -1) {
              filteredLocations[filteredLocationIndex] = associatedLocation;
            }

            // Save location changes to Firestore
            await saveLocationsToFirestore();
          }

          // Reload data from Firestore to ensure UI is in sync
          await loadCustomersFromFirestore();

          // Update displays
          updateDashboard();
          updateSettingsCustomerTable();

          alert('Customer deleted successfully! Password will be reset to "password" on next login and all payment history has been cleared.');
        } catch (error) {

          alert('Error deleting customer: ' + error.message);
        }
      }
    };

    // Delete all user data
    window.deleteAllUserData = async function() {
      const confirmMessage = 'Are you sure you want to delete ALL customer data? This action cannot be undone and will permanently delete all customers from the database.';
      if (!confirm(confirmMessage)) {
        return;
      }

      // Double confirmation
      const doubleConfirm = confirm('This will delete ALL customer data. Type OK to confirm, or Cancel to abort.');
      if (!doubleConfirm) {
        return;
      }

      try {

        // Show progress modal
        const deleteProgressModal = document.getElementById('deleteProgressModal');
        const deleteProgress = document.getElementById('deleteProgress');
        const deleteProgressText = document.getElementById('deleteProgressText');
        const deleteProgressBar = document.getElementById('deleteProgressBar');
        const deleteProgressStats = document.getElementById('deleteProgressStats');

        if (deleteProgressModal) {
          deleteProgressModal.classList.remove('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.remove('hidden');
        }

        const customersRef = collection(db, 'customers');

        // Get all customers from Firestore
        const existingCustomers = await getDocs(customersRef);
        const totalCustomers = existingCustomers.size;
        const customerDocs = [];
        existingCustomers.forEach(doc => {
          customerDocs.push(doc);
        });

        // Process deletions in batches with progress updates (using Firestore batch writes)
        const batchSize = 500; // Firestore batch limit
        let deletedCount = 0;

        for (let i = 0; i < customerDocs.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchDocs = customerDocs.slice(i, Math.min(i + batchSize, customerDocs.length));
          
          batchDocs.forEach(doc => {
            batch.delete(doc.ref);
          });

          await batch.commit();
          deletedCount += batchDocs.length;
          
          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customerDocs.length) {
            await new Promise(resolve => setTimeout(resolve, 200));
          }

          // Update progress
          const percent = Math.round((deletedCount / totalCustomers) * 100);
          if (deleteProgressText) {
            deleteProgressText.textContent = `${deletedCount} / ${totalCustomers}`;
          }
          if (deleteProgressBar) {
            deleteProgressBar.style.width = percent + '%';
          }
          if (deleteProgressStats) {
            deleteProgressStats.textContent = `Deleted: ${deletedCount} of ${totalCustomers} customers`;
          }

          // Allow UI to update
          await new Promise(resolve => setTimeout(resolve, 0));
        }

        // Update progress to 100%
        if (deleteProgressText) {
          deleteProgressText.textContent = `${totalCustomers} / ${totalCustomers}`;
        }
        if (deleteProgressBar) {
          deleteProgressBar.style.width = '100%';
        }
        if (deleteProgressStats) {
          deleteProgressStats.textContent = `Deleted: ${totalCustomers} of ${totalCustomers} customers`;
        }

        // Clear local arrays
        customers = [];
        filteredCustomers = [];

        // Update all locations to be available
        locations.forEach(location => {
          location.currentResident = null;
          location.status = 'available';
          location.ownerFirstName = '';
          location.ownerLastName = '';
          location.ownerFullName = '';
        });
        filteredLocations = [...locations];

        // Save location changes
        await saveLocationsToFirestore();

        // Reload data from Firestore to ensure UI is in sync
        await loadCustomersFromFirestore();

        // Update displays
        updateDashboard();
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Hide progress modal
        if (deleteProgressModal) {
          deleteProgressModal.classList.add('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.add('hidden');
        }

        // Close settings module if it's open
        if (window.hideAllModules) {
          window.hideAllModules();
        }

        // Show success alert
        alert(`Successfully deleted ${totalCustomers} customer${totalCustomers !== 1 ? 's' : ''}!`);
      } catch (error) {

        // Hide progress modal on error
        const deleteProgressModal = document.getElementById('deleteProgressModal');
        const deleteProgress = document.getElementById('deleteProgress');
        if (deleteProgressModal) {
          deleteProgressModal.classList.add('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.add('hidden');
        }

        alert('Error deleting customer data: ' + error.message);
      }
    };

    // Search customers
    window.searchCustomers = function() {
      // Check both search inputs (main table and settings table)
      const mainSearch = document.getElementById('customerSearch');
      const settingsSearch = document.getElementById('settingsCustomerSearch');
      const searchTerm = (mainSearch ? mainSearch.value : (settingsSearch ? settingsSearch.value : '')).toLowerCase();
      
      filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) ||
        customer.email.toLowerCase().includes(searchTerm) ||
        customer.accountNumber.toLowerCase().includes(searchTerm) ||
        customer.address.toLowerCase().includes(searchTerm)
      );
      updateCustomerTable();
      updateSettingsCustomerTable(); // Update settings table count as well
    };

    // Filter by status or codes
    window.filterByStatus = function(status) {
      if (status === 'all') {
        filteredCustomers = [...customers];
      } else if (status === 'no-codes') {
        filteredCustomers = customers.filter(c => !c.codes || c.codes.length === 0);
      } else if (status === 'has-codes') {
        filteredCustomers = customers.filter(c => c.codes && c.codes.length > 0);
      } else {
        filteredCustomers = customers.filter(c => c.paymentStatus === status);
      }
      updateCustomerTable();
      updateSettingsCustomerTable(); // Update settings table count as well
    };

    // Location management functions
    function updateLocationsTable() {
      const tbody = document.getElementById('locationsTableBody');
      tbody.innerHTML = '';

      filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = location.status === 'occupied' 
          ? 'bg-green-100 text-green-800' 
          : location.status === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : 'bg-blue-100 text-blue-800';

        const statusText = location.status === 'occupied' 
          ? 'Occupied' 
          : location.status === 'inactive'
          ? 'Inactive'
          : 'Available';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${location.premiseId || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'address', '${location.address}')" 
                 title="Double-click to edit">
              ${location.address}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${location.currentResident ? `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'currentResident', '${location.currentResident}')" 
                 title="Double-click to edit">
              ${location.currentResident}
            </div>
            ` : `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'ownerFullName', '${location.ownerFullName || 'No Owner'}')" 
                 title="Double-click to edit">
              ${location.ownerFullName || 'No Owner'}
            </div>
            `}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editField('${location.id}', 'status', '${location.status}')" 
                  title="Double-click to edit">
              ${statusText}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteLocation('${location.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Settings module table update functions
    function updateSettingsCustomerTable() {
      const tbody = document.getElementById('settingsCustomerTableBody');
      tbody.innerHTML = '';

      // Update the customer count display in settings
      const countDisplay = document.getElementById('settingsCustomerCountDisplay');
      const totalDisplay = document.getElementById('settingsCustomerTotalDisplay');
      if (countDisplay) countDisplay.textContent = filteredCustomers.length;
      if (totalDisplay) totalDisplay.textContent = customers.length;

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early (before due date)
        const hasPaidEarly = customer.lastPayment && customer.lastPayment !== 'Never' && 
                            customer.lastPayment.includes('/') && 
                            new Date(customer.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount based on breakdown logic
        const serviceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFee = pastDue > 0 ? 20 : 0; // $20 late fee if there's past due
        const subtotal = serviceCost + pastDue + lateFee;

        // Calculate code surcharges (applied only to service cost, not subtotal)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += serviceCost * (codeAmount / 100);
            }
          });
        }

        // Calculate factor adjustment (based on service cost only)
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const factorAdjustment = serviceCost * (factor - 1);
        const totalAmount = hasPaidEarly ? 0 : (serviceCost + pastDue + lateFee + totalSurcharge + factorAdjustment);

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'accountNumber', '${customer.accountNumber}')" 
                 title="Double-click to edit">
              ${customer.accountNumber}
            </div>
          </td>
          <td class="px-0 py-4 pr-0 -mr-4 whitespace-nowrap text-center max-w-[180px]">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'name', '${customer.name}')" 
                 title="Double-click to edit">
              ${customer.name}
            </div>
            <div class="flex flex-col items-center gap-1 mt-2">
              <button 
                onclick="showCustomerFullInfo('${customer.id}')" 
                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium"
              >
                View Full Info
              </button>
              <button 
                onclick="showCustomerDataProfile('${customer.id}')" 
                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 text-xs font-medium"
              >
                View Data Profile
              </button>
            </div>
          </td>
          <td class="px-0 py-4 pl-0 -ml-4 text-center max-w-[180px]">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'address', '${getCustomerDisplayAddress(customer)}')" 
                 title="Double-click to edit">
              ${(() => {
                const displayAddress = getCustomerDisplayAddress(customer);
                if (typeof displayAddress === 'string' && displayAddress.includes(',')) {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress.split(',')[0].trim()}</div>
                  <div class="text-slate-500 dark:text-slate-400 whitespace-nowrap">${displayAddress.split(',').slice(1).join(',').trim()}</div>`;
                } else {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress}</div>`;
                }
              })()}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editCustomerField('${customer.id}', 'paymentStatus', '${customer.paymentStatus}')" 
                  title="Double-click to edit">
              ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-900 dark:text-slate-100">
            <div class="font-medium">$${totalAmount.toFixed(2)}</div>
            <button onclick="showAmountDetails('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
              View Details
            </button>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600 dark:text-slate-400">
            <div class="flex flex-wrap gap-1 justify-center">
              ${customer.codes && customer.codes.length > 0 
                ? customer.codes.map(code => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.name}</span>`).join('')
                : '<span class="text-slate-400 dark:text-slate-500">â€”</span>'
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <div class="flex flex-col space-y-2">
              <button onclick="showPaymentModal('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Mark Paid
              </button>
              <button onclick="showPaymentHistory('${customer.id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                View History
              </button>
              <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateCodesTable() {

      const tbody = document.getElementById('settingsCodesTableBody');
      tbody.innerHTML = '';

      if (codes.length === 0) {

        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              You don't have any codes currently
            </td>
          </tr>
        `;
        return;
      }

      codes.forEach(code => {
        // Default to 'percentage' type for existing codes without type
        const codeType = code.type || 'percentage';
        const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);

        // Log each code when rendering the table

        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'name', '${(code.name || '').replace(/'/g, "\\'")}')" 
                 title="Double-click to edit">
              ${code.name || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'type', '${codeType}')" 
                 title="Double-click to edit">
              ${codeType === 'flat' ? 'Flat Rate' : 'Percentage'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'amount', '${codeAmount}')" 
                 title="Double-click to edit">
              ${codeType === 'flat' ? `$${parseFloat(codeAmount).toFixed(2)}` : `${parseFloat(codeAmount).toFixed(2)}%`}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'description', '${(code.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" 
                 title="Double-click to edit">
              ${code.description || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'requirements', '${JSON.stringify(code.requirements || {}).replace(/'/g, "\\'")}')" 
                 title="Double-click to edit">
              ${code.requirements && code.requirements.values && code.requirements.values.length > 0 
                ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.requirements.values.join(` ${code.requirements.type} `)}</span>`
                : code.requirements && Array.isArray(code.requirements) && code.requirements.length > 0
                  ? code.requirements.map(req => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 mr-1">${req}</span>`).join('')
                  : '<span class="text-slate-400 dark:text-slate-500">â€”</span>'
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteCode('${code.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateSettingsLocationsTable() {
      const tbody = document.getElementById('settingsLocationsTableBody');
      tbody.innerHTML = '';

      filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = location.status === 'occupied' 
          ? 'bg-green-100 text-green-800' 
          : location.status === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : 'bg-blue-100 text-blue-800';

        const statusText = location.status === 'occupied' 
          ? 'Occupied' 
          : location.status === 'inactive'
          ? 'Inactive'
          : 'Available';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${location.premiseId || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'address', '${location.address}')" 
                 title="Double-click to edit">
              ${location.address}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${location.currentResident ? `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'currentResident', '${location.currentResident}')" 
                 title="Double-click to edit">
              ${location.currentResident}
            </div>
            ` : `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'ownerFullName', '${location.ownerFullName || 'No Owner'}')" 
                 title="Double-click to edit">
              ${location.ownerFullName || 'No Owner'}
            </div>
            `}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editField('${location.id}', 'status', '${location.status}')" 
                  title="Double-click to edit">
              ${statusText}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteLocation('${location.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateSettingsUsersTable() {
      const tbody = document.getElementById('settingsUsersTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!filteredUsers || filteredUsers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              You don't have any users yet.
            </td>
          </tr>
        `;
        return;
      }

      filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        let createdDate = 'â€”';
        if (user.createdAt) {
          try {
            createdDate = new Date(user.createdAt).toLocaleDateString('en-US');
          } catch (error) {
            createdDate = user.createdAt;
          }
        }

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${user.fullName || 'Unnamed User'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
            ${createdDate}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Search locations
    window.searchLocations = function() {
      const searchTerm = document.getElementById('locationSearch').value.toLowerCase();
      filteredLocations = locations.filter(location => 
        location.address.toLowerCase().includes(searchTerm) ||
        location.propertyType.toLowerCase().includes(searchTerm) ||
        (location.currentResident && location.currentResident.toLowerCase().includes(searchTerm))
      );
      updateLocationsTable();
    };

    window.searchUsers = function() {
      const searchInput = document.getElementById('settingsUserSearch');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      if (!searchTerm) {
        filteredUsers = [...users];
      } else {
        filteredUsers = users.filter(user => 
          (user.fullName || '').toLowerCase().includes(searchTerm)
        );
      }
      updateSettingsUsersTable();
    };

    // Filter locations by status
    window.filterLocationsByStatus = function(status) {
      if (status === 'all') {
        filteredLocations = [...locations];
      } else {
        filteredLocations = locations.filter(l => l.status === status);
      }
      updateLocationsTable();
    };

    // Import locations from JSON
    window.importLocations = async function() {
      const fileInput = document.getElementById('locationFileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a JSON file');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.locations && Array.isArray(data.locations)) {
            // Add new locations to existing ones
            data.locations.forEach(newLocation => {
              // Check if location already exists
              const exists = locations.find(l => l.id === newLocation.id);
              if (!exists) {
                locations.push({
                  ...newLocation,
                  currentResident: null,
                  status: 'available'
                });
              }
            });

            filteredLocations = [...locations];
            updateLocationsTable();
            await saveLocationsToFirestore();
            alert(`Successfully imported ${data.locations.length} locations!`);
            fileInput.value = ''; // Clear the input
          } else {
            alert('Invalid JSON format. Expected "locations" array.');
          }
        } catch (error) {
          alert('Error parsing JSON file: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    // Show transfer ownership modal
    window.showTransferOwnershipModal = function(location, currentResident, newClientData) {
      // Store the data for later use
      window.transferData = {
        location: location,
        currentResident: currentResident,
        newClientData: newClientData
      };

      // Calculate actual amount due (same logic as in table)
      const now = new Date();
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getFullYear();

      // Check if customer has paid early (before due date)
      const hasPaidEarly = currentResident.lastPayment && currentResident.lastPayment !== 'Never' && 
                          currentResident.lastPayment.includes('/') && 
                          new Date(currentResident.lastPayment) < new Date(dueDateStr);

      // Calculate actual amount based on breakdown logic
      const serviceCost = calculateProratedServiceCost(currentResident);
      const lateFee = currentResident.pastDue > 0 ? 20 : 0; // $20 late fee
      const totalAmount = hasPaidEarly ? 0 : (serviceCost + lateFee);

      // Populate the modal
      document.getElementById('transferWarningName').textContent = currentResident.name;
      document.getElementById('transferCurrentResident').textContent = currentResident.name;
      document.getElementById('transferNewLocationLabel').textContent = currentResident.name;
      document.getElementById('transferLocation').textContent = location.address;
      document.getElementById('transferNewClient').textContent = newClientData.name;
      document.getElementById('transferCurrentStatus').textContent = currentResident.paymentStatus.charAt(0).toUpperCase() + currentResident.paymentStatus.slice(1);
      document.getElementById('transferBalance').textContent = `$${totalAmount.toFixed(2)}`;

      // Show appropriate message based on balance
      const statusMessage = document.getElementById('transferStatusMessage');
      if (totalAmount === 0) {
        statusMessage.innerHTML = 'The current resident has a balance of $0.00 and will be marked as <strong>Inactive</strong> after transfer.';
        statusMessage.className = 'text-green-600 dark:text-green-400';
      } else {
        statusMessage.innerHTML = 'The current resident has an outstanding balance and will be marked as <strong>Pending Closing</strong> until their balance is paid.';
        statusMessage.className = 'text-red-600 dark:text-red-400';
      }

      document.getElementById('transferOwnershipModal').classList.remove('hidden');
    };

    // Hide transfer ownership modal
    window.hideTransferOwnershipModal = function() {
      document.getElementById('transferOwnershipModal').classList.add('hidden');
      document.getElementById('transferNewLocation').value = '';
    };

    // Process transfer ownership
    window.processTransferOwnership = async function() {
      const newLocation = document.getElementById('transferNewLocation').value.trim();

      if (!newLocation) {
        alert('Please enter the new location for the current resident');
        return;
      }

      const { location, currentResident, newClientData } = window.transferData;

      try {
        // Update current resident's location and status
        currentResident.address = newLocation;

        // Calculate actual balance to determine status
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early
        const hasPaidEarly = currentResident.lastPayment && currentResident.lastPayment !== 'Never' && 
                            currentResident.lastPayment.includes('/') && 
                            new Date(currentResident.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount due
        const serviceCost = calculateProratedServiceCost(currentResident);
        const lateFee = currentResident.pastDue > 0 ? 20 : 0;
        const totalAmount = hasPaidEarly ? 0 : (serviceCost + lateFee);

        // Set status based on balance: inactive if balance is 0, pending closing if they owe money
        if (totalAmount === 0) {
          currentResident.paymentStatus = 'inactive';
        } else {
          currentResident.paymentStatus = 'pending closing';
        }

        // Update location to new resident
        location.currentResident = newClientData.name;
        location.ownerFullName = newClientData.name;
        const nameParts = newClientData.name.split(' ');
        location.ownerFirstName = nameParts[0] || '';
        location.ownerLastName = nameParts.slice(1).join(' ') || '';

        // Create new customer
        const newCustomer = {
          id: 'CUS-' + String(Date.now()).slice(-6),
          name: newClientData.name,
          email: newClientData.email,
          phone: newClientData.phone,
          address: location.address,
          accountNumber: 'CUS-' + String(Date.now()).slice(-6),
          currentBill: 170,
          pastDue: 0,
          lastPayment: 'Never',
          paymentHistory: [],
          needsPasswordChange: true,
          createdDate: new Date().toISOString(),
          entityType: newClientData.entityType || '',
          ssn: newClientData.ssn || '',
          idType: newClientData.idType || '',
          idNumber: newClientData.idNumber || '',
          secondaryContactName: newClientData.secondaryContactName || '',
          secondaryContactPhone: newClientData.secondaryContactPhone || '',
          mailingAddress: newClientData.mailingAddress || '',
          mailingStreet: newClientData.mailingStreet || '',
          mailingCity: newClientData.mailingCity || '',
          mailingState: newClientData.mailingState || '',
          mailingZip: newClientData.mailingZip || '',
          codes: newClientData.codes || [],
          factor: newClientData.factor || ''
        };

        // Update payment status for new customer
        updateCustomerPaymentStatus(newCustomer);

        // Add new customer
        customers.push(newCustomer);
        filteredCustomers = [...customers];

        // Save to Firestore
        await saveCustomersToFirestore();
        await saveLocationsToFirestore();

        // Update displays
        updateDashboard();
        updateSettingsCustomerTable();

        // Hide modal and show success
        hideTransferOwnershipModal();
        showClientSuccessScreen();

      } catch (error) {

        alert('Error processing transfer: ' + error.message);
      }
    };

    // Show add location modal
    window.showAddLocationModal = function() {
      // Generate a random 6-digit number for Premise ID
      const premiseId = Math.floor(100000 + Math.random() * 900000).toString();
      document.getElementById('newLocationPremiseId').value = premiseId;
      document.getElementById('addLocationModal').classList.remove('hidden');
    };

    // User management helpers
    window.showAddUserModal = function() {
      document.getElementById('newUserFullName').value = '';
      document.getElementById('addUserModal').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('newUserFullName').focus();
      }, 50);
    };

    window.hideAddUserModal = function() {
      document.getElementById('addUserModal').classList.add('hidden');
      document.getElementById('newUserFullName').value = '';
    };

    // Hide add location modal
    window.hideAddLocationModal = function() {
      document.getElementById('addLocationModal').classList.add('hidden');
      document.getElementById('addLocationForm').reset();
    };

    // Show add code modal
    window.showAddCodeModal = function() {
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
      document.getElementById('addCodeModal').classList.remove('hidden');
    };

    // Hide add code modal
    window.hideAddCodeModal = function() {
      document.getElementById('addCodeModal').classList.add('hidden');
      document.getElementById('addCodeForm').reset();
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
    };

    // Global variable to store selected requirements for new code
    // Structure: { type: "AND" | "OR", values: ["Business", "Individual"] }
    window.selectedCodeRequirements = null;

    // Update requirements list display
    window.updateCodeRequirementsList = function() {
      const listContainer = document.getElementById('newCodeRequirementsList');
      if (!listContainer) return;

      listContainer.innerHTML = '';

      if (!window.selectedCodeRequirements || window.selectedCodeRequirements.values.length === 0) {
        return;
      }

      const requirementDiv = document.createElement('div');
      requirementDiv.className = 'flex items-center justify-between bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg';

      const valuesText = window.selectedCodeRequirements.values.join(` ${window.selectedCodeRequirements.type} `);
      requirementDiv.innerHTML = `
        <span class="text-sm text-slate-800 dark:text-slate-200">${valuesText}</span>
        <button 
          type="button"
          onclick="removeCodeRequirement()" 
          class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 ml-2"
        >
          Ã—
        </button>
      `;
      listContainer.appendChild(requirementDiv);
    };

    // Show add requirement modal
    window.showAddRequirementModal = function() {
      document.getElementById('addRequirementModal').classList.remove('hidden');
    };

    // Hide add requirement modal
    window.hideAddRequirementModal = function() {
      document.getElementById('addRequirementModal').classList.add('hidden');
      // Reset checkboxes and radio buttons
      document.getElementById('requirementBusiness').checked = false;
      document.getElementById('requirementIndividual').checked = false;
      document.getElementById('requirementLogicAND').checked = true; // Default to AND
      document.getElementById('requirementLogicOR').checked = false;
    };

    // Add requirement to list
    window.addRequirement = function() {
      const businessChecked = document.getElementById('requirementBusiness').checked;
      const individualChecked = document.getElementById('requirementIndividual').checked;
      const logicType = document.getElementById('requirementLogicAND').checked ? 'AND' : 'OR';

      if (!businessChecked && !individualChecked) {
        alert('Please select at least one requirement');
        return;
      }

      const selectedValues = [];
      if (businessChecked) {
        selectedValues.push('Business');
      }
      if (individualChecked) {
        selectedValues.push('Individual');
      }

      window.selectedCodeRequirements = {
        type: logicType,
        values: selectedValues
      };

      updateCodeRequirementsList();
      hideAddRequirementModal();
    };

    // Remove requirement from list
    window.removeCodeRequirement = function() {
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
    };

    // Update code amount input based on type
    window.updateCodeAmountInput = function() {
      const type = document.getElementById('newCodeType').value;
      const amountInput = document.getElementById('newCodeAmount');

      if (type === 'percentage') {
        amountInput.max = '100';
        amountInput.placeholder = 'Enter percentage (0-100)';
      } else {
        amountInput.removeAttribute('max');
        amountInput.placeholder = 'Enter dollar amount';
      }
    };

    // Add new code
    window.addCode = async function() {
      const name = document.getElementById('newCodeName').value.trim();
      const type = document.getElementById('newCodeType').value;
      const amount = parseFloat(document.getElementById('newCodeAmount').value);
      const description = document.getElementById('newCodeDescription').value.trim() || '';

      if (!name || isNaN(amount) || amount < 0) {
        alert('Please enter a valid code name and amount');
        return;
      }

      if (type === 'percentage' && amount > 100) {
        alert('Percentage cannot exceed 100%');
        return;
      }

      const newCode = {
        id: `CODE-${String(Date.now()).slice(-6)}`,
        name: name,
        type: type,
        amount: amount,
        percentage: type === 'percentage' ? amount : undefined, // Keep for backward compatibility
        description: description,
        requirements: window.selectedCodeRequirements ? { ...window.selectedCodeRequirements } : null
      };

      codes.push(newCode);
      await saveCodesToFirestore();
      updateCodesTable();
      hideAddCodeModal();

      // Reset form
      document.getElementById('newCodeName').value = '';
      document.getElementById('newCodeType').value = 'percentage';
      document.getElementById('newCodeAmount').value = '';
      document.getElementById('newCodeDescription').value = '';
      updateCodeAmountInput();

      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();

      alert('Code added successfully!');
    };

    // Save edit code field
    window.saveEditCodeField = async function() {
      const codeId = document.getElementById('editCodeFieldCodeId').value;
      const fieldType = document.getElementById('editCodeFieldFieldType').value;
      const newValue = document.getElementById('editCodeFieldValue').value;

      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      if (fieldType === 'type') {
        const newType = newValue;
        code.type = newType;
        // If switching types, preserve amount value
        if (!code.amount && code.percentage !== undefined) {
          code.amount = code.percentage;
        }
        if (newType === 'percentage' && code.amount > 100) {
          code.amount = 100;
        }
      }

      await saveCodesToFirestore();
      updateCodesTable();
      cancelEditCodeField();
    };

    // Cancel edit code field
    window.cancelEditCodeField = function() {
      document.getElementById('editCodeFieldModal').classList.add('hidden');
      document.getElementById('editCodeFieldInputContainer').innerHTML = '';
    };

    // Delete code
    window.deleteCode = async function(codeId) {
      if (confirm('Are you sure you want to delete this code?')) {
        codes = codes.filter(c => c.id !== codeId);
        await saveCodesToFirestore();
        updateCodesTable();
        alert('Code deleted successfully!');
      }
    };

    // Edit code field
    window.editCodeField = function(codeId, fieldType, currentValue) {
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      let newValue;

      // Special handling for type field - show dropdown modal
      if (fieldType === 'type') {
        // Set up the edit modal with dropdown
        document.getElementById('editCodeFieldType').textContent = 'Type';
        document.getElementById('editCodeFieldCodeId').value = codeId;
        document.getElementById('editCodeFieldFieldType').value = 'type';

        const container = document.getElementById('editCodeFieldInputContainer');
        const currentType = currentValue || 'percentage';
        container.innerHTML = `
          <select 
            id="editCodeFieldValue" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="percentage" ${currentType === 'percentage' ? 'selected' : ''}>Percentage</option>
            <option value="flat" ${currentType === 'flat' ? 'selected' : ''}>Flat Rate</option>
          </select>
        `;

        // Show the modal
        document.getElementById('editCodeFieldModal').classList.remove('hidden');
        return;
      }

      // Special handling for amount field
      if (fieldType === 'amount') {

        const codeType = code.type || 'percentage';
        const promptText = codeType === 'flat' 
          ? `Enter new flat rate amount (dollars):` 
          : `Enter new percentage (0-100):`;
        newValue = prompt(promptText, currentValue);

        if (newValue === null) {

          return; // User cancelled
        }

        newValue = newValue.trim();
        const amount = parseFloat(newValue);

        if (isNaN(amount) || amount < 0) {

          alert('Please enter a valid amount');
          return;
        }

        if (codeType === 'percentage' && amount > 100) {

          alert('Percentage cannot exceed 100%');
          return;
        }

        // Find the code in the array by index to ensure we're updating the right object
        const codeIndex = codes.findIndex(c => c.id === codeId);
        if (codeIndex === -1) {

          alert('Error: Code not found in array');
          return;
        }

        // Update the code object in the array directly
        codes[codeIndex].amount = amount;
        if (codeType === 'percentage') {
          codes[codeIndex].percentage = amount; // Keep for backward compatibility
        }

        // Also update the local code variable for consistency
        code.amount = amount;
        if (codeType === 'percentage') {
          code.percentage = amount;
        }

        // Update table immediately to show the change
        updateCodesTable();

        // Save to Firestore asynchronously

        saveCodesToFirestore()
          .then(() => {

          })
          .catch(error => {

            alert('Error saving code amount to database. The change may not persist after reload.');
            // Reload codes from Firestore to restore correct state
            loadCodesFromFirestore();
          });
        return;
      }

      // Standard prompt for other fields
      newValue = prompt(`Enter new ${fieldType}:`, currentValue);

      if (newValue === null) return; // User cancelled

      newValue = newValue.trim();

      // Validation
      if (fieldType === 'name') {
        if (!newValue) {
          alert('Code name cannot be empty');
          return;
        }
        code.name = newValue;
      } else if (fieldType === 'description') {
        code.description = newValue || '';
      }

      // Save to Firestore and update table
      saveCodesToFirestore().then(() => {
        updateCodesTable();

        // Update code references in all customers if name changed
        if (fieldType === 'name') {
          customers.forEach(customer => {
            if (customer.codes && customer.codes.length > 0) {
              customer.codes.forEach(c => {
                if (c.id === codeId) {
                  c.name = newValue;
                }
              });
            }
          });
          saveCustomersToFirestore();
          updateCustomerTable();
          updateSettingsCustomerTable();
        }
      });
    };

    // Add new location
    window.addLocation = async function() {
      const street = document.getElementById('newLocationStreet').value;
      const city = document.getElementById('newLocationCity').value;
      const state = document.getElementById('newLocationState').value;
      const zip = document.getElementById('newLocationZip').value;
      const premiseId = document.getElementById('newLocationPremiseId').value;

      if (!street || !city || !state || !zip || !premiseId) {
        alert('Please fill in all fields');
        return;
      }

      const fullAddress = `${street}, ${city}, ${state} ${zip}`;

      const newLocation = {
        id: `LOC-${String(locations.length + 1).padStart(3, '0')}`,
        address: fullAddress,
        street: street,
        city: city,
        state: state,
        zip: zip,
        premiseId: premiseId,
        ownerFirstName: '',
        ownerLastName: '',
        ownerFullName: '',
        currentResident: null,
        status: 'available'
      };

      locations.push(newLocation);
      filteredLocations = [...locations];
      updateLocationsTable();
      updateSettingsLocationsTable();
      await saveLocationsToFirestore();
      hideAddLocationModal();

      // Update the location dropdowns and select the new location
      updateLocationDropdowns(newLocation.id);

      alert('Location added successfully!');
    };

    window.addUser = async function() {
      const input = document.getElementById('newUserFullName');
      const fullName = input.value.trim();

      if (!fullName) {
        alert('Please enter the user\'s full name.');
        return;
      }

      const timestamp = Date.now();
      const newUser = {
        id: `USR-${String(timestamp).slice(-6)}`,
        fullName,
        createdAt: new Date(timestamp).toISOString()
      };

      users.push(newUser);
      filteredUsers = [...users];
      updateSettingsUsersTable();
      populateBatchUserSelect(fullName);
      populateBatchStartUserSelect();
      await saveUsersToFirestore();
      hideAddUserModal();
      alert('User added successfully!');
    };

    window.deleteUser = async function(userId) {
      if (!confirm('Are you sure you want to delete this user?')) {
        return;
      }

      users = users.filter(user => user.id !== userId);
      filteredUsers = [...users];
      updateSettingsUsersTable();
      populateBatchUserSelect();
      populateBatchStartUserSelect();
      await saveUsersToFirestore();
      alert('User deleted successfully!');
    };

    // Update location dropdowns and select the new location
    function updateLocationDropdowns(selectedLocationId) {
      // Update Add Client Module dropdown
      const addClientSelect = document.getElementById('newClientLocation');
      if (addClientSelect) {
        populateAddClientLocationSelect();
        addClientSelect.value = selectedLocationId;
      }

      // Update Add Customer Modal dropdown
      const addCustomerSelect = document.getElementById('newCustomerLocation');
      if (addCustomerSelect) {
        // Repopulate the dropdown
        addCustomerSelect.innerHTML = '<option value="">Select a property location</option>';
        locations.forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = `${location.address} (${location.status})`;
          addCustomerSelect.appendChild(option);
        });
        addCustomerSelect.value = selectedLocationId;
      }
    }

    // Show import modal
    window.showImportModal = function() {
      document.getElementById('importModal').classList.remove('hidden');
    };

    // Hide import modal
    window.hideImportModal = function() {
      document.getElementById('importModal').classList.add('hidden');
      document.getElementById('locationFileInput').value = '';
    };

    // Show import customer data modal
    window.showImportCustomerDataModal = function() {

      try {
        const modal = document.getElementById('importCustomerDataModal');
        if (!modal) {

          alert('Error: Import modal not found. Please refresh the page.');
          return;
        }

        modal.classList.remove('hidden');
        // Add file input listener for preview
        const fileInput = document.getElementById('customerDataFileInput');
        if (fileInput) {
          fileInput.onchange = function() {
            previewExcelFile(this.files[0]);
          };
        } else {

        }
      } catch (error) {

        alert('Error opening import dialog: ' + error.message);
      }
    };

    // Hide import customer data modal
    window.hideImportCustomerDataModal = function() {
      document.getElementById('importCustomerDataModal').classList.add('hidden');
      document.getElementById('customerDataFileInput').value = '';
      document.getElementById('importPreview').classList.add('hidden');
    };

    // Preview Excel file
    function previewExcelFile(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (jsonData.length === 0) {
            alert('Excel file is empty');
            return;
          }

          // Show preview
          const previewDiv = document.getElementById('importPreview');
          const previewTable = document.getElementById('previewTable');
          const thead = previewTable.querySelector('thead');
          const tbody = previewTable.querySelector('tbody');

          // Clear previous content
          thead.innerHTML = '';
          tbody.innerHTML = '';

          // Add headers
          const headerRow = document.createElement('tr');
          if (jsonData[0]) {
            jsonData[0].forEach(header => {
              const th = document.createElement('th');
              th.className = 'px-4 py-2 text-left border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300';
              th.textContent = header || '';
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
          }

          // Add first 5 data rows
          const previewRows = jsonData.slice(1, 6);
          previewRows.forEach(row => {
            const tr = document.createElement('tr');
            jsonData[0].forEach((_, colIndex) => {
              const td = document.createElement('td');
              td.className = 'px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-400';
              td.textContent = row[colIndex] || '';
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });

          previewDiv.classList.remove('hidden');
        } catch (error) {

          alert('Error reading Excel file: ' + error.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Import customer data from Excel
    // Helper function to combine PremiseAddress, PremiseStreet, and PremiseApt
    // Example: PremiseAddress="20120" + PremiseStreet="ANZA DR" = "20120 ANZA DR"
    function combinePropertyAddress(rowData) {
      const premiseAddress = String(rowData['PremiseAddress'] || '').trim();
      const premiseStreet = String(rowData['PremiseStreet'] || '').trim();
      const premiseApt = String(rowData['PremiseApt'] || '').trim();

      // Build address parts array
      const addressParts = [];

      // Add PremiseAddress if it exists
      if (premiseAddress) {
        addressParts.push(premiseAddress);
      }

      // Add PremiseStreet if it exists
      if (premiseStreet) {
        addressParts.push(premiseStreet);
      }

      // Combine the parts
      let address = addressParts.join(' ').trim();

      // Add apartment number if it exists (only if not blank)
      if (premiseApt) {
        address = `${address} ${premiseApt}`.trim();
      }

      return address || '';
    }

    // Helper function to get the display address for a customer
    // Uses importData if available, otherwise falls back to customer.address
    function getCustomerDisplayAddress(customer) {
      // If customer has importData, use combinePropertyAddress to build the address
      if (customer.importData) {
        const combinedAddress = combinePropertyAddress(customer.importData);
        if (combinedAddress) {
          return combinedAddress;
        }
      }

      // Fall back to customer.address if no importData or combined address is empty
      return customer.address || 'N/A';
    }

    // Helper function to parse tax codes from "tax codes per person" field
    function parseTaxCodesPerPerson(taxCodesStr) {
      if (!taxCodesStr || typeof taxCodesStr !== 'string') {
        return [];
      }
      // Split by comma and trim whitespace
      return taxCodesStr.split(',').map(code => code.trim()).filter(code => code.length > 0);
    }

    // Helper function to ensure a code exists in the codes array, creating it if it doesn't
    function ensureCodeExists(codeName) {
      if (!codeName || typeof codeName !== 'string') {
        return null;
      }

      // Check if code already exists (case-insensitive)
      let existingCode = codes.find(c => c.name.toLowerCase() === codeName.toLowerCase());
      if (existingCode) {
        return existingCode;
      }

      // Create new code with just the name (type, amount, description, requirements can be added later)
      // Use timestamp + random number for unique ID
      const uniqueId = `CODE-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      const newCode = {
        id: uniqueId,
        name: codeName,
        type: 'percentage', // Default to percentage
        amount: 0, // Default to 0, can be updated later
        percentage: 0, // Default to 0 for backward compatibility
        description: '', // Empty, can be added later
        requirements: null // No requirements, can be added later
      };

      codes.push(newCode);
      return newCode;
    }

    // Helper function to populate customer codes from importData
    function populateCustomerCodesFromImportData(customer) {
      if (!customer.importData) {
        return;
      }

      // Try various possible column names for "tax codes per person"
      const taxCodesStr = customer.importData['Tax Codes Per Person'] || 
                         customer.importData['Tax Codes per Person'] ||
                         customer.importData['Tax Codes'] ||
                         customer.importData['Codes Per Person'] ||
                         customer.importData['Codes per Person'] ||
                         customer.importData['Codes'] ||
                         '';

      if (!taxCodesStr) {
        return;
      }

      // Parse the tax codes
      const codeNames = parseTaxCodesPerPerson(taxCodesStr);

      // Ensure all codes exist and populate customer.codes
      customer.codes = codeNames.map(codeName => {
        const code = ensureCodeExists(codeName);
        if (code) {
          return {
            id: code.id,
            name: code.name,
            type: code.type || 'percentage',
            amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
            percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
          };
        }
        return null;
      }).filter(code => code !== null);
    }

    // Re-sync pastDue amounts from stored importData
    window.syncPastDueFromImportData = async function() {
      if (!confirm('This will update all customers\' past due amounts from their imported Excel data. Continue?')) {
        return;
      }

      let updated = 0;
      let errors = 0;

      customers.forEach(customer => {
        if (!customer.importData) {
          return; // Skip customers without importData
        }

        try {
          const rowData = customer.importData;

          // Use the same logic as import to extract pastDue
          let pastDue = 0;
          const prevBal = rowData['PrevBal'];
          const pastDueAmount = rowData['Past Due'];
          const pastDueFlag = rowData['PastDue'];

          // Prioritize PrevBal (actual dollar amount)
          if (prevBal !== undefined && prevBal !== null && prevBal !== '') {
            const parsed = parseFloat(prevBal);
            if (!isNaN(parsed)) {
              pastDue = parsed;
            }
          } else if (pastDueAmount !== undefined && pastDueAmount !== null && pastDueAmount !== '') {
            const parsed = parseFloat(pastDueAmount);
            if (!isNaN(parsed)) {
              pastDue = parsed;
            }
          } else if (pastDueFlag !== undefined && pastDueFlag !== null && pastDueFlag !== '') {
            // Only use PastDue flag if it looks like a dollar amount (not just 1 or 0)
            const parsed = parseFloat(pastDueFlag);
            if (!isNaN(parsed) && parsed > 1) {
              pastDue = parsed;
            }
          }

          // Update customer's pastDue
          customer.pastDue = pastDue;

          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);

          updated++;
        } catch (error) {

          errors++;
        }
      });

      // Update filtered customers
      filteredCustomers = [...customers];

      // Refresh UI
      updateCustomerTable();
      updateSettingsCustomerTable();
      updateDashboard();

      // Save to Firestore
      await saveCustomersToFirestore();

      alert(`Sync complete! Updated ${updated} customers. ${errors > 0 ? errors + ' errors occurred.' : ''}`);
    };

    window.importCustomerData = async function() {

      const fileInput = document.getElementById('customerDataFileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select an Excel file');
        return;
      }

      // Show loading indicator
      const importButton = document.querySelector('button[onclick*="importCustomerData"]');
      const originalText = importButton?.textContent || 'Import Customer Data';
      if (importButton) {
        importButton.disabled = true;
        importButton.textContent = 'Importing...';
      }

      const reader = new FileReader();

      reader.onerror = function(error) {

        alert('Error reading file. Please try again.');
        if (importButton) {
          importButton.disabled = false;
          importButton.textContent = originalText;
        }
      };

      reader.onload = async function(e) {
        try {

          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (jsonData.length < 2) {
            alert('Excel file must have at least a header row and one data row');
            if (importButton) {
              importButton.disabled = false;
              importButton.textContent = originalText;
            }
            return;
          }

          // Get headers (first row)
          const headers = jsonData[0].map(h => String(h || '').trim());

          // Find account number column index (look for variations)
          const accountColIndex = headers.findIndex(h => {
            const header = String(h || '').toLowerCase().trim();
            return /account/i.test(header) || 
                   /acct/i.test(header) || 
                   /^id$/i.test(header) || 
                   /customer.*id/i.test(header) ||
                   /account.*number/i.test(header) ||
                   /account.*num/i.test(header);
          });

          if (accountColIndex === -1) {
            alert('Could not find account number column. Please ensure your Excel file has a column for account numbers.');
            if (importButton) {
              importButton.disabled = false;
              importButton.textContent = originalText;
            }
            return;
          }

          // Show progress indicator
          const progressDiv = document.getElementById('importProgress');
          const progressText = document.getElementById('progressText');
          const progressBar = document.getElementById('progressBar');
          const progressStats = document.getElementById('progressStats');
          const previewDiv = document.getElementById('importPreview');

          // Upload progress elements
          const uploadProgressDiv = document.getElementById('uploadProgress');
          const uploadProgressText = document.getElementById('uploadProgressText');
          const uploadProgressBar = document.getElementById('uploadProgressBar');
          const uploadProgressStats = document.getElementById('uploadProgressStats');

          if (previewDiv) previewDiv.classList.add('hidden');
          if (progressDiv) progressDiv.classList.remove('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');
          const locationsUploadProgressDiv = document.getElementById('locationsUploadProgress');
          if (locationsUploadProgressDiv) locationsUploadProgressDiv.classList.add('hidden');

          const totalRows = jsonData.length - 1; // Exclude header row

          // Process each row
          let imported = 0;
          let updated = 0;
          let errors = 0;

          // Process rows in batches to allow UI updates
          const processBatch = async (startIndex, batchSize = 50) => {
            const endIndex = Math.min(startIndex + batchSize, jsonData.length);

            for (let i = startIndex; i < endIndex; i++) {
              const row = jsonData[i];
              if (!row || row.length === 0) continue;

              try {
                // Create object with all Excel data
                const rowData = {};
                headers.forEach((header, index) => {
                  rowData[header] = row[index] || '';
                });

                // Get account number
                const accountNumber = String(row[accountColIndex] || '').trim();
                if (!accountNumber) {
                  errors++;
                  continue;
                }

                // Find existing customer or create new
                let customer = customers.find(c => 
                  c.accountNumber === accountNumber || c.id === accountNumber
                );

                // Build full name from FirstName/LastName or Name/Full Name
                let fullName = '';
                if (rowData['FirstName'] && rowData['LastName']) {
                  fullName = `${rowData['FirstName']} ${rowData['LastName']}`.trim();
                } else if (rowData['Name']) {
                  fullName = rowData['Name'];
                } else if (rowData['Full Name']) {
                  fullName = rowData['Full Name'];
                }

                // Get phone number from various possible columns
                const phone = rowData['HomePhone'] || rowData['WorkPhone'] || rowData['Phone'] || rowData['Phone Number'] || '';

                // Get address by combining PremiseAddress, PremiseStreet, and PremiseApt
                const address = combinePropertyAddress(rowData) || rowData['Address'] || rowData['Service Address'] || '';

                // Get amounts
                const totalDue = parseFloat(rowData['TotalDue'] || rowData['CurrDue'] || rowData['Current Bill'] || rowData['Amount Due'] || 0) || 0;
                // Handle PrevBal first (actual amount), then Past Due (amount), then PastDue (flag - ignore if it's just 1/0)
                // If PrevBal is empty/blank, treat as 0. Only use PastDue flag if it's actually a dollar amount
                let pastDue = 0;
                const prevBal = rowData['PrevBal'];
                const pastDueAmount = rowData['Past Due'];
                const pastDueFlag = rowData['PastDue'];

                // Prioritize PrevBal (actual dollar amount)
                if (prevBal !== undefined && prevBal !== null && prevBal !== '') {
                  const parsed = parseFloat(prevBal);
                  if (!isNaN(parsed)) {
                    pastDue = parsed;
                  }
                } else if (pastDueAmount !== undefined && pastDueAmount !== null && pastDueAmount !== '') {
                  const parsed = parseFloat(pastDueAmount);
                  if (!isNaN(parsed)) {
                    pastDue = parsed;
                  }
                } else if (pastDueFlag !== undefined && pastDueFlag !== null && pastDueFlag !== '') {
                  // Only use PastDue flag if it looks like a dollar amount (not just 1 or 0)
                  const parsed = parseFloat(pastDueFlag);
                  if (!isNaN(parsed) && parsed > 1) {
                    pastDue = parsed;
                  }
                  // If it's 1 or 0, treat as flag and ignore (pastDue stays 0)
                }

                if (customer) {
                  // Update existing customer - preserve existing fields, add/update importData
                  customer.importData = rowData;
                  // Update standard fields if they exist in Excel
                  if (fullName) {
                    customer.name = fullName;
                  }
                  if (rowData['Email']) {
                    customer.email = rowData['Email'] || customer.email;
                  }
                  if (phone) {
                    customer.phone = phone;
                  }
                  // Always update address with combined address from importData
                  if (address) {
                    customer.address = address;
                  }
                  if (totalDue > 0) {
                    customer.currentBill = totalDue;
                  }
                  // Always update pastDue (can be 0 to reset existing value)
                  customer.pastDue = pastDue;
                  // Populate codes from "tax codes per person" field
                  populateCustomerCodesFromImportData(customer);
                  updated++;
                } else {
                  // Create new customer
                  const customerId = accountNumber.startsWith('CUS-') ? accountNumber : 'CUS-' + accountNumber;
                  customer = {
                    id: customerId,
                    accountNumber: customerId,
                    name: fullName,
                    email: rowData['Email'] || '',
                    phone: phone,
                    address: address,
                    currentBill: totalDue,
                    pastDue: pastDue,
                    lastPayment: rowData['Last Payment'] || 'Never',
                    paymentHistory: [],
                    needsPasswordChange: true,
                    createdDate: new Date().toISOString(),
                    entityType: rowData['Entity Type'] || rowData['Type'] || '',
                    ssn: rowData['SSN'] || rowData['Social Security Number'] || '',
                    idType: rowData['ID Type'] || '',
                    idNumber: rowData['ID Number'] || '',
                    secondaryContactName: rowData['Secondary Contact Name'] || '',
                    secondaryContactPhone: rowData['Secondary Contact Number'] || '',
                    mailingAddress: rowData['Mailing Address'] || '',
                    mailingStreet: rowData['Mailing Street'] || '',
                    mailingCity: rowData['Mailing City'] || '',
                    mailingState: rowData['Mailing State'] || '',
                    mailingZip: rowData['Mailing ZIP'] || rowData['Mailing Zip'] || '',
                    codes: [],
                    factor: parseFloat(rowData['Factor'] || 1) || 1,
                    importData: rowData // Store all Excel data
                  };

                  // Populate codes from "tax codes per person" field
                  populateCustomerCodesFromImportData(customer);

                  updateCustomerPaymentStatus(customer);
                  customers.push(customer);
                  imported++;
                }

                // Create or update location from customer data
                if (address) {
                  // Get Premise ID (handle formats like "P3000500" or just "3000500")
                  let premiseId = rowData['Premise'] || rowData['PremiseId'] || rowData['Premise ID'] || '';
                  if (premiseId) {
                    premiseId = String(premiseId).trim();
                    // Remove "P" prefix if present
                    if (premiseId.startsWith('P') || premiseId.startsWith('p')) {
                      premiseId = premiseId.substring(1);
                    }
                  }

                  // Only create location if we have a premise ID
                  if (premiseId) {
                    // Check if location already exists by premiseId
                    let existingLocation = locations.find(l => l.premiseId === premiseId);

                    // Parse address into components (try to extract city, state, zip)
                    // Format is typically: "Street Address, City, State ZIP"
                    let street = address;
                    let city = '';
                    let state = '';
                    let zip = '';

                    // Try to parse address format: "123 Street, City, State ZIP"
                    const addressMatch = address.match(/^(.+?),\s*(.+?),\s*([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/i);
                    if (addressMatch) {
                      street = addressMatch[1].trim();
                      city = addressMatch[2].trim();
                      state = addressMatch[3].trim().toUpperCase();
                      zip = addressMatch[4].trim();
                    } else {
                      // Try simpler format: "Street, City, State ZIP"
                      const simpleMatch = address.match(/^(.+?),\s*(.+?),\s*(.+)$/);
                      if (simpleMatch) {
                        street = simpleMatch[1].trim();
                        const stateZip = simpleMatch[3].trim();
                        const stateZipMatch = stateZip.match(/^([A-Z]{2})\s+(.+)$/i);
                        if (stateZipMatch) {
                          city = simpleMatch[2].trim();
                          state = stateZipMatch[1].trim().toUpperCase();
                          zip = stateZipMatch[2].trim();
                        } else {
                          // Can't parse, use full address as street
                          street = address;
                        }
                      }
                    }

                    // Get owner name from FirstName/LastName
                    const ownerFirstName = rowData['FirstName'] || '';
                    const ownerLastName = rowData['LastName'] || '';
                    const ownerFullName = fullName || `${ownerFirstName} ${ownerLastName}`.trim() || 'No Owner';

                    if (existingLocation) {
                      // Update existing location
                      existingLocation.address = address;
                      existingLocation.street = street;
                      existingLocation.city = city;
                      existingLocation.state = state;
                      existingLocation.zip = zip;
                      existingLocation.ownerFirstName = ownerFirstName;
                      existingLocation.ownerLastName = ownerLastName;
                      existingLocation.ownerFullName = ownerFullName;
                      // Don't change status if it's already set, but set to "active" if it's empty or "inactive"
                      if (!existingLocation.status || existingLocation.status === 'inactive') {
                        existingLocation.status = 'active';
                      }
                    } else {
                      // Create new location
                      const newLocation = {
                        id: `LOC-${String(locations.length + 1).padStart(3, '0')}`,
                        address: address,
                        street: street,
                        city: city,
                        state: state,
                        zip: zip,
                        premiseId: premiseId,
                        ownerFirstName: ownerFirstName,
                        ownerLastName: ownerLastName,
                        ownerFullName: ownerFullName,
                        currentResident: null,
                        status: 'active'
                      };
                      locations.push(newLocation);
                    }
                  }
                }
              } catch (error) {

                errors++;
              }

              // Update progress every row (i is the current index, so processed = i - 1 to account for header)
              const processed = i; // i is the current row index (1-based for data rows)
              const percent = Math.min(Math.round((processed / totalRows) * 100), 100);

              if (progressText) {
                progressText.textContent = `${processed} / ${totalRows}`;
              }
              if (progressBar) {
                progressBar.style.width = percent + '%';
              }
              if (progressStats) {
                progressStats.textContent = `Imported: ${imported} | Updated: ${updated} | Errors: ${errors}`;
              }
            }

            // If there are more rows to process, continue with next batch
            if (endIndex < jsonData.length) {
              // Use setTimeout to allow UI to update
              await new Promise(resolve => setTimeout(resolve, 0));
              return processBatch(endIndex, batchSize);
            }

            // Final progress update to ensure 100%
            if (progressText) {
              progressText.textContent = `${totalRows} / ${totalRows}`;
            }
            if (progressBar) {
              progressBar.style.width = '100%';
            }
          };

          // Start processing batches

          await processBatch(1, 50);

          // Update filtered customers first to get accurate count

          filteredCustomers = [...customers];

          // Show upload progress bar with initial values
          if (uploadProgressDiv) {
            uploadProgressDiv.classList.remove('hidden');
          }
          const totalCustomers = customers.length;
          if (uploadProgressText) {
            uploadProgressText.textContent = `0 / ${totalCustomers}`;
          }
          if (uploadProgressBar) {
            uploadProgressBar.style.width = '0%';
          }
          if (uploadProgressStats) {
            uploadProgressStats.textContent = `Uploading... (0 of ${totalCustomers} customers)`;
          }

          // Create progress callback for Firestore upload
          const uploadProgressCallback = (saved, total, percent) => {
            if (uploadProgressText) {
              uploadProgressText.textContent = `${saved} / ${total}`;
            }
            if (uploadProgressBar) {
              uploadProgressBar.style.width = percent + '%';
            }
            if (uploadProgressStats) {
              uploadProgressStats.textContent = `Uploaded: ${saved} of ${total} customers`;
            }
          };

          await saveAllCustomersToFirestore(uploadProgressCallback);

          // Save codes to Firestore if any new codes were added
          if (codes.length > 0) {

            await saveCodesToFirestore();

          }

          // Save locations to Firestore if any locations were created/updated
          if (locations.length > 0) {

            // Show locations upload progress
            const locationsProgressDiv = document.getElementById('locationsUploadProgress');
            const locationsUploadProgressText = document.getElementById('locationsUploadProgressText');
            const locationsUploadProgressBar = document.getElementById('locationsUploadProgressBar');
            const locationsUploadProgressStats = document.getElementById('locationsUploadProgressStats');

            if (locationsProgressDiv) {
              locationsProgressDiv.classList.remove('hidden');
            }

            const totalLocations = locations.length;
            if (locationsUploadProgressText) {
              locationsUploadProgressText.textContent = `0 / ${totalLocations}`;
            }
            if (locationsUploadProgressBar) {
              locationsUploadProgressBar.style.width = '0%';
            }
            if (locationsUploadProgressStats) {
              locationsUploadProgressStats.textContent = `Uploading... (0 of ${totalLocations} locations)`;
            }

            // Create progress callback for locations upload
            const locationsUploadProgressCallback = (saved, total, percent) => {
              if (locationsUploadProgressText) {
                locationsUploadProgressText.textContent = `${saved} / ${total}`;
              }
              if (locationsUploadProgressBar) {
                locationsUploadProgressBar.style.width = percent + '%';
              }
              if (locationsUploadProgressStats) {
                locationsUploadProgressStats.textContent = `Uploaded: ${saved} of ${total} locations`;
              }
            };

            filteredLocations = [...locations];
            updateLocationsTable();
            updateSettingsLocationsTable();
            await saveLocationsToFirestore(locationsUploadProgressCallback);

            // Update progress to 100%
            if (locationsUploadProgressText) {
              locationsUploadProgressText.textContent = `${totalLocations} / ${totalLocations}`;
            }
            if (locationsUploadProgressBar) {
              locationsUploadProgressBar.style.width = '100%';
            }
            if (locationsUploadProgressStats) {
              locationsUploadProgressStats.textContent = `Uploaded: ${totalLocations} of ${totalLocations} locations`;
            }
          }

          updateCustomerTable();
          updateSettingsCustomerTable();
          updateCodesTable();
          updateDashboard();

          // Hide progress indicators
          if (progressDiv) progressDiv.classList.add('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');
          const locationsUploadProgressDivHide = document.getElementById('locationsUploadProgress');
          if (locationsUploadProgressDivHide) locationsUploadProgressDivHide.classList.add('hidden');

          // Show success message
          const totalProcessed = imported + updated;

          // Re-enable button
          if (importButton) {
            importButton.disabled = false;
            importButton.textContent = originalText;
          }

          // Close modal first
          hideImportCustomerDataModal();

          // Show completion alert
          alert('Import is all done');
        } catch (error) {

          alert('Error importing Excel file: ' + error.message);

          // Hide progress indicators on error
          const progressDiv = document.getElementById('importProgress');
          const uploadProgressDiv = document.getElementById('uploadProgress');
          if (progressDiv) progressDiv.classList.add('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');

          // Re-enable button on error
          if (importButton) {
            importButton.disabled = false;
            importButton.textContent = originalText;
          }
        }
      };

      try {
        reader.readAsArrayBuffer(file);
      } catch (error) {

        alert('Error reading file: ' + error.message);
        if (importButton) {
          importButton.disabled = false;
          importButton.textContent = originalText;
        }
      }
    };

    // Show payment details modal
    window.showPaymentDetailsModal = function() {
      const selectedCustomerId = document.getElementById('paymentCustomerSelect').value;
      const customer = customers.find(c => c.id === selectedCustomerId);

      if (customer) {
        // Calculate amounts (same logic as in showCustomerPaymentInfo)
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFee = customer.pastDue > 0 ? 20 : 0;
        const totalAmount = serviceCost + lateFee;

        // Populate the modal
        document.getElementById('paymentDetailsCustomer').textContent = customer.name;
        document.getElementById('paymentDetailsService').textContent = `$${serviceCost.toFixed(2)}`;
        document.getElementById('paymentDetailsLateFee').textContent = `$${lateFee.toFixed(2)}`;
        document.getElementById('paymentDetailsTotal').textContent = `$${totalAmount.toFixed(2)}`;

        // Show the modal
        document.getElementById('paymentDetailsModal').classList.remove('hidden');
      }
    };

    // Hide payment details modal
    window.hidePaymentDetailsModal = function() {
      document.getElementById('paymentDetailsModal').classList.add('hidden');
    };

    // Edit location
    window.editLocation = function(locationId) {
      const location = locations.find(l => l.id === locationId);
      if (location) {
        const newAddress = prompt('Enter new address:', location.address);
        const newType = prompt('Enter property type:', location.propertyType);

        if (newAddress && newType) {
          location.address = newAddress;
          location.propertyType = newType;
          updateLocationsTable();
          alert('Location updated successfully!');
        }
      }
    };

    // Delete location
    window.deleteLocation = async function(locationId) {
      if (confirm('Are you sure you want to delete this location?')) {
        locations = locations.filter(l => l.id !== locationId);
        filteredLocations = [...locations];
        updateLocationsTable();
        updateSettingsLocationsTable(); // Update settings table as well
        await saveLocationsToFirestore();
        alert('Location deleted successfully!');
      }
    };

    // Inline editing functionality
    window.editField = function(locationId, fieldType, currentValue) {
      const location = locations.find(l => l.id === locationId);
      const customer = customers.find(c => c.id === locationId);
      if (!location && !customer) return;

      // Set up the edit modal
      document.getElementById('editFieldType').textContent = fieldType.charAt(0).toUpperCase() + fieldType.slice(1);
      document.getElementById('editFieldLocationId').value = locationId;
      document.getElementById('editFieldFieldType').value = fieldType;

      // Check if this is a status field that should use a dropdown
      const container = document.getElementById('editFieldInputContainer');
      if (fieldType === 'paymentStatus') {
        // Create dropdown for payment status
        container.innerHTML = `
          <select 
            id="editFieldValue" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="current" ${currentValue === 'current' ? 'selected' : ''}>Current</option>
            <option value="overdue" ${currentValue === 'overdue' ? 'selected' : ''}>Overdue</option>
            <option value="inactive" ${currentValue === 'inactive' ? 'selected' : ''}>Inactive</option>
            <option value="pending closing" ${currentValue === 'pending closing' ? 'selected' : ''}>Pending Closing</option>
          </select>
        `;
      } else {
        // Use regular input for other fields
        container.innerHTML = `
          <input 
            id="editFieldValue" 
            type="text" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Enter new value"
            value="${currentValue}"
            required
          />
        `;
      }

      // Show the modal
      document.getElementById('editFieldModal').classList.remove('hidden');
    };

    // Save field edit
    window.saveFieldEdit = async function() {
      const locationId = document.getElementById('editFieldLocationId').value;
      const fieldType = document.getElementById('editFieldFieldType').value;
      const newValue = document.getElementById('editFieldValue').value.trim();

      if (!newValue) {
        alert('Please enter a value');
        return;
      }

      // Check if this is a customer or location field
      const customer = customers.find(c => c.id === locationId);
      const location = locations.find(l => l.id === locationId);

      if (customer) {
        // Update customer field
        if (fieldType === 'accountNumber') {
          customer.accountNumber = newValue;
        } else if (fieldType === 'name') {
          customer.name = newValue;
        } else if (fieldType === 'email') {
          customer.email = newValue;
        } else if (fieldType === 'phone') {
          customer.phone = newValue;
        } else if (fieldType === 'address') {
          customer.address = newValue;
        } else if (fieldType === 'paymentStatus') {
          customer.paymentStatus = newValue;
          // Note: Status will be automatically updated based on pastDue amount
        } else if (fieldType === 'dueDate') {
          customer.dueDate = newValue;
        } else if (fieldType === 'lastPayment') {
          customer.lastPayment = newValue;
        } else if (fieldType === 'factor') {
          // Validate factor is a valid number
          const factorValue = parseFloat(newValue);
          if (isNaN(factorValue) || factorValue < 0) {
            alert('Please enter a valid factor (must be a positive number)');
            return;
          }
          customer.factor = newValue;
        } else if (fieldType === 'pastDue') {
          // Validate pastDue is a valid number
          const pastDueValue = parseFloat(newValue);
          if (isNaN(pastDueValue) || pastDueValue < 0) {
            alert('Please enter a valid past due amount (must be a positive number)');
            return;
          }
          customer.pastDue = pastDueValue;
          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);
        }

        // Update filtered customers
        const filteredIndex = filteredCustomers.findIndex(c => c.id === locationId);
        if (filteredIndex !== -1) {
          filteredCustomers[filteredIndex] = customer;
        }

        // Refresh customer table
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Refresh Customer Information modal if it's open for this customer
        const customerFullInfoModal = document.getElementById('customerFullInfoModal');
        if (!customerFullInfoModal.classList.contains('hidden')) {
          // Check if the modal is showing this customer
          const content = document.getElementById('customerFullInfoContent');
          if (content && content.innerHTML.includes(customer.id)) {
            showCustomerFullInfo(locationId);
          }
        }

        // Refresh Amount Breakdown modal if it's open for this customer
        const amountDetailsModal = document.getElementById('amountDetailsModal');
        if (!amountDetailsModal.classList.contains('hidden')) {
          // Check if the modal is showing this customer
          const customerName = document.getElementById('amountDetailsCustomer');
          if (customerName && customerName.textContent === customer.name) {
            showAmountDetails(locationId);
          }
        }

        // Save to Firestore
        await saveCustomersToFirestore();
      } else if (location) {
        // Update location field
        if (fieldType === 'address') {
          location.address = newValue;
        } else if (fieldType === 'ownerFullName') {
          location.ownerFullName = newValue;
          // Split the name into first and last name
          const nameParts = newValue.split(' ');
          location.ownerFirstName = nameParts[0] || '';
          location.ownerLastName = nameParts.slice(1).join(' ') || '';
        } else if (fieldType === 'currentResident') {
          location.currentResident = newValue === 'Available' ? null : newValue;
          location.status = newValue === 'Available' ? 'available' : 'occupied';
        } else if (fieldType === 'status') {
          location.status = newValue;
        }

        // Update filtered locations
        const filteredIndex = filteredLocations.findIndex(l => l.id === locationId);
        if (filteredIndex !== -1) {
          filteredLocations[filteredIndex] = location;
        }

        // Refresh locations table
        updateLocationsTable();

        // Save to Firestore
        await saveLocationsToFirestore();
      }

      // Hide the modal
      document.getElementById('editFieldModal').classList.add('hidden');
    };

    // Cancel field edit
    window.cancelFieldEdit = function() {
      document.getElementById('editFieldModal').classList.add('hidden');
    };

    // Customer field editing functionality
    window.editCustomerField = function(customerId, fieldType, currentValue) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      // Set up the edit modal
      document.getElementById('editFieldType').textContent = fieldType.charAt(0).toUpperCase() + fieldType.slice(1);
      document.getElementById('editFieldValue').value = currentValue;
      document.getElementById('editFieldLocationId').value = customerId;
      document.getElementById('editFieldFieldType').value = fieldType;

      // Show the modal
      document.getElementById('editFieldModal').classList.remove('hidden');
    };

    // Show amount details modal
    window.showAmountDetails = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const serviceCost = calculateProratedServiceCost(customer);
      const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
      const lateFee = pastDue > 0 ? 20 : 0; // $20 late fee if there's past due
      const subtotal = serviceCost + pastDue + lateFee;

      // Calculate code surcharges (applied only to service cost, not subtotal)
      // IMPORTANT: Refresh customer codes from the global codes array to get latest amounts
      let totalSurcharge = 0;
      const codesContainer = document.getElementById('amountDetailsCodesContainer');
      codesContainer.innerHTML = '';

      if (customer.codes && customer.codes.length > 0) {
        customer.codes.forEach(customerCode => {
          // Look up the latest code data from the global codes array
          // Try to find by ID first, then by name (case-insensitive)
          let latestCode = codes.find(c => c.id === customerCode.id);
          if (!latestCode) {
            latestCode = codes.find(c => c.name.toLowerCase() === customerCode.name.toLowerCase());
          }

          // Use the latest code data if found, otherwise fall back to customer code data
          const codeToUse = latestCode || customerCode;

          const codeType = codeToUse.type || 'percentage';
          const codeAmount = codeToUse.amount !== undefined ? codeToUse.amount : (codeToUse.percentage !== undefined ? codeToUse.percentage : 0);
          let surchargeAmount;
          if (codeType === 'flat') {
            surchargeAmount = codeAmount;
          } else {
            surchargeAmount = serviceCost * (codeAmount / 100);
          }
          totalSurcharge += surchargeAmount;

          const codeRow = document.createElement('div');
          codeRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600';
          const displayText = codeType === 'flat' 
            ? `${codeToUse.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${codeToUse.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          codeRow.innerHTML = `
            <span class="text-slate-600 dark:text-slate-400">${displayText}</span>
            <span class="font-medium">$${surchargeAmount.toFixed(2)}</span>
          `;
          codesContainer.appendChild(codeRow);
        });
      }

      // Calculate factor adjustment (based on service cost only)
      const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
      const factorAdjustment = serviceCost * (factor - 1);
      const total = serviceCost + pastDue + lateFee + totalSurcharge + factorAdjustment;

      // Calculate due date as last day of current month
      const now = new Date();
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getFullYear();

      // Calculate billing cycle (month after due date)
      const billingCycleStart = new Date(lastDayOfMonth.getFullYear(), lastDayOfMonth.getMonth() + 1, 1);
      const billingCycleEnd = new Date(billingCycleStart.getFullYear(), billingCycleStart.getMonth() + 1, 0);

      const formatShortDate = (date) => {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const year = date.getFullYear().toString().slice(-2);
        return `${month}/${day}/${year}`;
      };

      const billingCycleStr = `${formatShortDate(billingCycleStart)} to ${formatShortDate(billingCycleEnd)}`;

      // Add factor adjustment to display if factor is not 1.0
      const factorContainer = document.getElementById('amountDetailsFactorContainer');
      if (factorContainer) {
        factorContainer.innerHTML = '';
        if (factor !== 1.0 && factorAdjustment > 0) {
          const factorRow = document.createElement('div');
          factorRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600';
          factorRow.innerHTML = `
            <span class="text-slate-600 dark:text-slate-400">Factor (${factor}x)</span>
            <span class="font-medium">$${factorAdjustment.toFixed(2)}</span>
          `;
          factorContainer.appendChild(factorRow);
        }
      }

      document.getElementById('amountDetailsCustomer').textContent = customer.name;
      document.getElementById('amountDetailsService').textContent = `$${serviceCost.toFixed(2)}`;
      const pastDueElement = document.getElementById('amountDetailsPastDue');
      pastDueElement.textContent = `$${pastDue.toFixed(2)}`;
      pastDueElement.setAttribute('data-customer-id', customerId);
      pastDueElement.setAttribute('data-past-due', pastDue.toFixed(2));
      document.getElementById('amountDetailsLateFee').textContent = `$${lateFee.toFixed(2)}`;
      document.getElementById('amountDetailsTotal').textContent = `$${total.toFixed(2)}`;
      document.getElementById('amountDetailsDueDate').textContent = dueDateStr;
      document.getElementById('amountDetailsBillingCycle').textContent = billingCycleStr;
      document.getElementById('amountDetailsLastPayment').textContent = formatDate(customer.lastPayment);

      document.getElementById('amountDetailsModal').classList.remove('hidden');
    };

    // Hide amount details modal
    window.hideAmountDetails = function() {
      document.getElementById('amountDetailsModal').classList.add('hidden');
    };

    // Edit past due from amount details modal
    window.editPastDueFromModal = function() {
      const pastDueElement = document.getElementById('amountDetailsPastDue');
      const customerId = pastDueElement.getAttribute('data-customer-id');
      const currentPastDue = pastDueElement.getAttribute('data-past-due') || '0.00';

      // Remove $ sign and parse
      const numericValue = currentPastDue.replace('$', '');
      editCustomerField(customerId, 'pastDue', numericValue);
    };

    // Show customer full info modal
    window.showCustomerFullInfo = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const content = document.getElementById('customerFullInfoContent');
      content.innerHTML = `
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Personal Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.name || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.email || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.phone ? formatPhoneNumber(customer.phone) : 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.address || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.entityType || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.ssn || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.idType || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.idNumber || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.secondaryContactName || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.secondaryContactPhone ? formatPhoneNumber(customer.secondaryContactPhone) : 'N/A'}
            </div>
          </div>
          </div>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-600 my-6"></div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingStreet || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingCity || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingState || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingZip || 'N/A'}
              </div>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-600 my-6"></div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor & Codes</h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <div 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600" 
                ondblclick="editCustomerField('${customer.id}', 'factor', '${customer.factor || ''}')" 
                title="Double-click to edit"
              >
                ${customer.factor || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tax Codes</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.codes && customer.codes.length > 0 
                  ? customer.codes.map(code => {
                      const codeType = code.type || 'percentage';
                      const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
                      return codeType === 'flat' 
                        ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
                        : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
                    }).join(', ')
                  : 'N/A'}
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('customerFullInfoModal').classList.remove('hidden');
    };

    // Hide customer full info modal
    window.hideCustomerFullInfo = function() {
      document.getElementById('customerFullInfoModal').classList.add('hidden');
    };

    // Show customer data profile modal (Excel preview)
    window.showCustomerDataProfile = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      // Check if customer has importData
      if (!customer.importData) {
        alert('No imported data available for this customer. Please import customer data first.');
        return;
      }

      const modalContent = document.getElementById('customerDataProfileContent');
      const headers = Object.keys(customer.importData);

      // Build Excel-like table
      let tableHTML = `
        <div class="overflow-x-auto border border-slate-300 dark:border-slate-600 rounded-lg">
          <table class="min-w-full text-sm border-collapse">
            <thead>
              <tr class="bg-slate-100 dark:bg-slate-700">
      `;

      // Add header row
      headers.forEach(header => {
        tableHTML += `<th class="px-4 py-2 text-left border border-slate-300 dark:border-slate-600 font-semibold text-slate-700 dark:text-slate-300 whitespace-nowrap">${header || ''}</th>`;
      });

      tableHTML += `
              </tr>
            </thead>
            <tbody>
              <tr class="bg-white dark:bg-slate-800">
      `;

      // Add data row
      headers.forEach(header => {
        const value = customer.importData[header];
        tableHTML += `<td class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-400">${value || ''}</td>`;
      });

      tableHTML += `
              </tr>
            </tbody>
          </table>
        </div>
      `;

      modalContent.innerHTML = tableHTML;
      const modal = document.getElementById('customerDataProfileModal');
      modal.setAttribute('data-customer-id', customerId);
      modal.classList.remove('hidden');
    };

    // Hide customer data profile modal
    window.hideCustomerDataProfile = function() {
      document.getElementById('customerDataProfileModal').classList.add('hidden');
    };

    // Copy full data profile to clipboard
    window.copyFullDataProfile = function() {
      const customerId = document.getElementById('customerDataProfileModal').getAttribute('data-customer-id');
      const customer = customers.find(c => c.id === customerId);

      if (!customer || !customer.importData) {
        alert('No data available to copy');
        return;
      }

      // Build a readable text format of all the data
      let textToCopy = 'Customer Data Profile (Excel Preview)\n\n';

      const headers = Object.keys(customer.importData);

      // Add header row
      textToCopy += headers.join('\t') + '\n';

      // Add data row
      const values = headers.map(header => customer.importData[header] || '');
      textToCopy += values.join('\t') + '\n';

      // Copy to clipboard
      navigator.clipboard.writeText(textToCopy).then(() => {
        alert('Full data profile copied to clipboard!');
      }).catch(err => {

        // Fallback: select text and show message
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          alert('Full data profile copied to clipboard!');
        } catch (err) {
          alert('Failed to copy. Please select and copy manually.');
        }
        document.body.removeChild(textArea);
      });
    };

    // Show payment modal
    window.showPaymentModal = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const currentAmount = customer.currentBill + customer.pastDue;
      document.getElementById('paymentCustomerName').textContent = customer.name;
      document.getElementById('paymentCurrentAmount').textContent = `$${currentAmount.toFixed(2)}`;
      document.getElementById('paymentAmount').value = '';
      document.getElementById('paymentAmount').max = currentAmount;
      document.getElementById('paymentCustomerId').value = customerId;

      document.getElementById('paymentModal').classList.remove('hidden');
    };

    // Hide payment modal
    window.hidePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };

    // Process payment
    window.processPayment = async function() {
      const customerId = document.getElementById('paymentCustomerId').value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);

      if (!paymentAmount || paymentAmount <= 0) {
        alert('Please enter a valid payment amount');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const currentAmount = customer.currentBill + customer.pastDue;
      if (paymentAmount > currentAmount) {
        alert(`Payment amount cannot exceed current balance of $${currentAmount.toFixed(2)}`);
        return;
      }

      // Record payment in history
      const today = new Date();
      const paymentDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                         today.getDate().toString().padStart(2, '0') + '/' + 
                         today.getFullYear();

      const paymentRecord = {
        date: paymentDate,
        amountDue: currentAmount,
        amountPaid: paymentAmount,
        remainingBalance: currentAmount - paymentAmount
      };

      customer.paymentHistory.push(paymentRecord);

      // Update customer balance
      if (paymentAmount >= customer.currentBill) {
        const remaining = paymentAmount - customer.currentBill;
        customer.currentBill = 0;
        customer.pastDue = Math.max(0, customer.pastDue - remaining);
      } else {
        customer.currentBill -= paymentAmount;
      }

      // Update last payment date
      customer.lastPayment = paymentDate;

      // If customer was pending closing and now has no balance, mark as inactive
      if (customer.paymentStatus === 'pending closing' && customer.pastDue === 0 && customer.currentBill === 0) {
        customer.paymentStatus = 'inactive';
      } else {
        // Update payment status based on past due amount
        updateCustomerPaymentStatus(customer);
      }

      // Save to Firestore
      await saveCustomersToFirestore();

      // Update display
      updateDashboard();
      hidePaymentModal();

      alert(`Payment of $${paymentAmount.toFixed(2)} recorded successfully!`);
    };

    // Show payment history
    window.showPaymentHistory = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      document.getElementById('historyCustomerName').textContent = customer.name;

      const historyBody = document.getElementById('paymentHistoryBody');
      historyBody.innerHTML = '';

      // Check if paymentHistory exists and has items
      if (!customer.paymentHistory || customer.paymentHistory.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 dark:text-slate-400 py-4">No payment history available</td></tr>';
      } else {
        customer.paymentHistory.forEach(payment => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">${payment.date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.amountDue.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.amountPaid.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.remainingBalance.toFixed(2)}</td>
          `;
          historyBody.appendChild(row);
        });
      }

      document.getElementById('paymentHistoryModal').classList.remove('hidden');
    };

    // Hide payment history modal
    window.hidePaymentHistory = function() {
      document.getElementById('paymentHistoryModal').classList.add('hidden');
    };

    // Keyboard shortcut to switch to client page
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey) {
        event.preventDefault();
        window.location.href = 'billing.html';
      }
    });
  </script>
  <style>
    :root { color-scheme: light dark; }
    body { background: radial-gradient(1200px 800px at 30% -10%, #e6f0ff 0%, #ffffff 45%) no-repeat; }
    @media (prefers-color-scheme: dark) {
      body { background: radial-gradient(1200px 800px at 30% -10%, #0b1220 0%, #0e1628 45%) no-repeat; }
    }
    .card { backdrop-filter: saturate(1.2) blur(8px); }
    .modal-show { display: flex !important; }
    .safe-pad { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .tap { -webkit-tap-highlight-color: transparent; }

    /* Batch Preview - Custom CSS (overrides Tailwind utilities) */
    /* Use !important to override Tailwind's utility classes */
    /* Target specific elements within .batch-preview-custom for full control */

    .batch-preview-custom table {
      /* Custom table styles - these will override Tailwind */
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed !important;
      border: 1px solid #e2e8f0; /* Outer border */
    }

    /* DRASTIC MEASURES: Force Date column to be exactly 100px - no exceptions */
    .batch-preview-custom colgroup col:nth-child(1) { 
      width: 100px !important; 
      min-width: 100px !important;
      max-width: 100px !important;
    }

    /* Force Date header cell to be exactly 100px */
    .batch-preview-custom thead th:nth-child(1) {
      width: 100px !important;
      min-width: 100px !important;
      max-width: 100px !important;
      box-sizing: border-box !important;
    }

    /* Force Date data cells to be exactly 100px */
    .batch-preview-custom tbody td:nth-child(1),
    .batch-preview-custom tfoot td:nth-child(1) {
      width: 130px !important;
      min-width: 130px !important;
      max-width: 130px !important;
      box-sizing: border-box !important;
    }

    /* DRASTIC MEASURES: Force Customer column to be exactly 160px */
    .batch-preview-custom colgroup col:nth-child(2) { 
      width: 160px !important; 
      min-width: 160px !important;
      max-width: 160px !important;
    }
    /* Customer header 50px narrower */
    .batch-preview-custom thead th:nth-child(2) {
      width: 160px !important;
      min-width: 160px !important;
      max-width: 160px !important;
      box-sizing: border-box !important;
    }
    .batch-preview-custom tbody td:nth-child(2),
    .batch-preview-custom tfoot td:nth-child(2) {
      width: 202px !important;
      min-width: 202px !important;
      max-width: 202px !important;
      box-sizing: border-box !important;
    }

    /* DRASTIC MEASURES: Force Account # column to be exactly 267px */
    .batch-preview-custom colgroup col:nth-child(3) { 
      width: 267px !important; 
      min-width: 267px !important;
      max-width: 267px !important;
    }
    /* Account # header to be exactly 267px */
    .batch-preview-custom thead th:nth-child(3) {
      width: 267px !important;
      min-width: 267px !important;
      max-width: 267px !important;
      box-sizing: border-box !important;
    }
    .batch-preview-custom tbody td:nth-child(3),
    .batch-preview-custom tfoot td:nth-child(3) {
      width: 340px !important;
      min-width: 340px !important;
      max-width: 340px !important;
      box-sizing: border-box !important;
    }

    /* DRASTIC MEASURES: Force Property column to be exactly 200px */
    .batch-preview-custom colgroup col:nth-child(4) { 
      width: 200px !important; 
      min-width: 200px !important;
      max-width: 200px !important;
    }
    /* Property header 50px narrower */
    .batch-preview-custom thead th:nth-child(4) {
      width: 150px !important;
      min-width: 150px !important;
      max-width: 150px !important;
      box-sizing: border-box !important;
    }
    .batch-preview-custom tbody td:nth-child(4),
    .batch-preview-custom tfoot td:nth-child(4) {
      width: 255px !important;
      min-width: 255px !important;
      max-width: 255px !important;
      box-sizing: border-box !important;
    }

    /* DRASTIC MEASURES: Force Type column to be exactly 96px */
    .batch-preview-custom colgroup col:nth-child(5) { 
      width: 96px !important; 
      min-width: 96px !important;
      max-width: 96px !important;
    }
    /* Type header 50px narrower */
    .batch-preview-custom thead th:nth-child(5) {
      width: 46px !important;
      min-width: 46px !important;
      max-width: 46px !important;
      box-sizing: border-box !important;
    }
    .batch-preview-custom tbody td:nth-child(5),
    .batch-preview-custom tfoot td:nth-child(5) {
      width: 125px !important;
      min-width: 125px !important;
      max-width: 125px !important;
      box-sizing: border-box !important;
    }

    /* DRASTIC MEASURES: Force Amount column to be exactly 112px */
    .batch-preview-custom colgroup col:nth-child(6) { 
      width: 112px !important; 
      min-width: 112px !important;
      max-width: 112px !important;
    }
    /* Amount header 50px narrower */
    .batch-preview-custom thead th:nth-child(6) {
      width: 62px !important;
      min-width: 62px !important;
      max-width: 62px !important;
      box-sizing: border-box !important;
    }
    .batch-preview-custom tbody td:nth-child(6),
    .batch-preview-custom tfoot td:nth-child(6) {
      width: 112px !important;
      min-width: 140px !important;
      max-width: 140px !important;
      box-sizing: border-box !important;
    }

    /* Ensure all cells align properly - each in its own column box */
    .batch-preview-custom th,
    .batch-preview-custom td {
      vertical-align: top;
      box-sizing: border-box;
      border: 1px solid #e2e8f0; /* Grid lines between cells */
    }

    /* Remove double borders by only showing right and bottom */
    .batch-preview-custom th,
    .batch-preview-custom td {
      border-top: 1px solid #e2e8f0;
      border-left: 1px solid #e2e8f0;
      border-right: none;
      border-bottom: none;
    }

    /* Add right border to last column */
    .batch-preview-custom th:last-child,
    .batch-preview-custom td:last-child {
      border-right: 1px solid #e2e8f0;
    }

    /* Add bottom border to last row */
    .batch-preview-custom tbody tr:last-child td,
    .batch-preview-custom tfoot tr td {
      border-bottom: 1px solid #e2e8f0;
    }

    /* Property column can wrap */
    .batch-preview-custom tbody td:nth-child(4) {
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* All other columns should not wrap and stay in their boxes */
    .batch-preview-custom tbody td:not(:nth-child(4)) {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Ensure header and body cells align perfectly */
    .batch-preview-custom thead th,
    .batch-preview-custom tbody td {
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }

    .batch-preview-custom thead th {
      padding-top: 0.75rem !important;
      padding-bottom: 0.75rem !important;
    }

    .batch-preview-custom tbody td {
      padding-top: 1rem !important;
      padding-bottom: 1rem !important;
    }

    /* Custom cell styles - override Tailwind padding, spacing, etc. */
    /* Example: uncomment and customize as needed */
    /*
    .batch-preview-custom th,
    .batch-preview-custom td {
      padding: 1rem !important;
      font-size: 0.875rem !important;
    }
    */

    /* Override specific Tailwind classes within batch preview */
    .batch-preview-custom .px-4 {
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }

    .batch-preview-custom .py-4 {
      padding-top: 1rem !important;
      padding-bottom: 1rem !important;
    }

    /* Add your custom styles here - they will take precedence over Tailwind */
  </style>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 tap">
  <!-- Firebase Auth Modal -->
  <div id="firebaseAuthModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Admin Authentication</h2>
      <p class="text-slate-600 dark:text-slate-400 mb-6">Please enter your admin credentials to continue</p>
      
      <form id="firebaseAuthForm" class="space-y-4">
        <div>
          <label for="firebaseEmail" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
          <input 
            type="email" 
            id="firebaseEmail" 
            required
            autocomplete="email"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
            placeholder="admin@cus.com"
          >
        </div>
        
        <div>
          <label for="firebasePassword" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Password</label>
          <input 
            type="password" 
            id="firebasePassword" 
            required
            autocomplete="current-password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
            placeholder="Enter password"
          >
        </div>
        
        <div id="firebaseAuthError" class="text-red-600 dark:text-red-400 text-sm hidden"></div>
        
        <button 
          type="submit" 
          id="firebaseAuthSubmit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors"
        >
          Sign In
        </button>
      </form>
    </div>
  </div>

  <div class="mx-auto max-w-7xl px-4 pt-6 pb-24 safe-pad">

    <!-- Dashboard Screen -->
    <div id="dashboardScreen">
      <!-- Header -->
      <header class="mb-8">
        <div class="text-center">
          <br><br>
          <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200">CUS Admin Dashboard</h1>
          <p class="text-slate-600 dark:text-slate-400">Manage customer accounts and billing</p>
        </div>
      </header>

      <!-- Action Modules -->
      <div id="actionModules" class="mb-8">
        <!-- Payment Module -->
        <div id="paymentModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Payment</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
              <select id="paymentCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Choose a customer...</option>
              </select>
            </div>

            <div id="customerPaymentInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                  <p id="paymentAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                  <button id="viewDetailsBtn" onclick="showPaymentDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                    View Details
                  </button>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                  <p id="paymentPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                  <p id="paymentLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                  <p id="paymentPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                  <p id="paymentDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                  <span id="paymentStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be populated by JavaScript -->
                  </span>
                </div>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Type</label>
                <select 
                  id="paymentType" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                >
                  <option value="">Select Payment Type</option>
                  <option value="Check">Check</option>
                  <option value="Cash">Cash</option>
                </select>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
                <input 
                  type="number" 
                  id="paymentAmount" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter payment amount"
                >
              </div>

              <button 
                onclick="processPaymentFromModule()" 
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Process Payment
              </button>
            </div>
          </div>
        </div>

        <!-- Bill Module -->
        <div id="billModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
              <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Choose a customer...</option>
              </select>
            </div>

            <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                  <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                  <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                    View Details
                  </button>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                  <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                  <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                  <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                  <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                  <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be populated by JavaScript -->
                  </span>
                </div>
              </div>

              <!-- Bill Preview -->
              <div id="billPreview" class="mb-4 p-4 bg-white dark:bg-slate-600 rounded-lg border-2 border-slate-300 dark:border-slate-500">
                <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-3">Bill Preview</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Service Cost:</span>
                    <span id="previewServiceCost" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Late Fee:</span>
                    <span id="previewLateFee" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Surcharges:</span>
                    <span id="previewSurcharges" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Factor Adjustment:</span>
                    <span id="previewFactorAdjustment" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between pt-2 border-t border-slate-300 dark:border-slate-500">
                    <span class="font-semibold text-slate-800 dark:text-slate-200">Total Amount:</span>
                    <span id="previewTotalAmount" class="font-bold text-lg text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                </div>
              </div>

              <button 
                onclick="produceBill()" 
                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Produce Bill
              </button>

              <!-- PDF Display Container -->
              <div id="billPdfDisplay" class="hidden mt-4">
                <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
                <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Client Module -->
        <div id="addClientModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Client</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Account Info</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
              <input 
                type="text" 
                id="newClientName" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter full name"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
              <input 
                type="email" 
                id="newClientEmail" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter email address"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
              <input 
                type="tel" 
                id="newClientPhone" 
                oninput="formatPhoneInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="(xxx)-xxx-xxxx"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
              <select id="newClientLocation" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" required>
                <option value="">Choose a location...</option>
                <option value="add-new">+ Add New Location</option>
              </select>
            </div>
            </div>
          </div>

          <!-- Identification Info Section -->
          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Identification Info</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
                <input 
                  type="text" 
                  id="newClientSSN" 
                  oninput="formatSSNInput(this)"
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="xxx-xx-xxxx"
                  maxlength="11"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
                <select id="newClientIDType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">Select ID Type</option>
                  <option value="Drivers License">Drivers License</option>
                  <option value="ID">ID</option>
                  <option value="Passport">Passport</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
                <input 
                  type="text" 
                  id="newClientIDNumber" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter ID number"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
                <input 
                  type="text" 
                  id="newClientSecondaryContactName" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter secondary contact name"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
                <input 
                  type="tel" 
                  id="newClientSecondaryContactPhone" 
                  oninput="formatPhoneInput(this)"
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="(xxx)-xxx-xxxx"
                >
              </div>
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
                <input 
                  type="text" 
                  id="newClientMailingStreet" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter street address"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
                <input 
                  type="text" 
                  id="newClientMailingCity" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter city"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
                <select id="newClientMailingState" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">Select State</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                <input 
                  type="text" 
                  id="newClientMailingZip" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter ZIP code"
                  maxlength="10"
                >
              </div>
            </div>
          </div>

            <div class="mt-6">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
              <div id="newClientCodesList" class="space-y-2">
                <!-- Selected codes will be displayed here -->
              </div>
            </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <input 
                type="number" 
                id="newClientFactor" 
                step="any"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter factor"
              >
            </div>
          </div>

          <div class="mt-6">
            <button 
              onclick="addClientFromModule()" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Create Client Account
            </button>
          </div>
        </div>

        <!-- Search Module -->
        <div id="searchModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Search Accounts</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Search by Name</label>
                <input 
                  type="text" 
                  id="searchByName" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter customer name..."
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Filter by Status</label>
                <select id="searchByStatus" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">All Status</option>
                  <option value="current">Current</option>
                  <option value="overdue">Overdue</option>
                </select>
              </div>
            </div>

            <div class="flex space-x-4">
              <button 
                onclick="performSearch()" 
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Search
              </button>
              <button 
                onclick="clearSearch()" 
                class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Clear
              </button>
            </div>

            <div id="searchResults" class="mt-6">
              <!-- Search results will be displayed here -->
            </div>
          </div>
        </div>

        <!-- Settings Module -->
        <div id="settingsModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 relative">
          <!-- Loading Overlay -->
          <div id="settingsLoadingOverlay" class="absolute inset-0 bg-white dark:bg-slate-800 bg-opacity-90 dark:bg-opacity-90 flex items-center justify-center z-50 rounded-3xl hidden">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p class="text-slate-700 dark:text-slate-300 font-medium">Loading settings data...</p>
            </div>
          </div>

          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Settings & Management</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex space-x-1 mb-6">
            <button 
              id="settingsAccountsTab"
              onclick="switchSettingsView('accounts')" 
              class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
            >
              Accounts
            </button>
            <button 
              id="settingsLocationsTab"
              onclick="switchSettingsView('locations')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Locations
            </button>
            <button 
              id="settingsCodesTab"
              onclick="switchSettingsView('codes')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Codes
            </button>
            <button 
              id="settingsUsersTab"
              onclick="switchSettingsView('users')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Users
            </button>
          </div>

          <!-- Accounts Section -->
          <div id="settingsAccountsContent">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Customer Accounts</h4>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                  Showing <span id="settingsCustomerCountDisplay" class="font-semibold">0</span> of <span id="settingsCustomerTotalDisplay" class="font-semibold">0</span> customers
                </p>
              </div>
              <div class="flex flex-col gap-2">
                <button 
                  onclick="showAddCustomerModal()" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Add New Customer
                </button>
                <button 
                  onclick="showImportCustomerDataModal()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm"
                >
                  Import Customer Data
                </button>
                <button 
                  onclick="syncPastDueFromImportData()" 
                  class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm"
                  title="Re-sync past due amounts from imported Excel data"
                >
                  Sync Past Due Amounts
                </button>
                <button 
                  onclick="deleteAllUserData()" 
                  class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
                >
                  Delete User Data
                </button>
              </div>
            </div>

            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsCustomerSearch" 
                  type="text" 
                  placeholder="Search customers..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchCustomers()"
                />
              </div>
              <div>
                <select 
                  onchange="filterByStatus(this.value)" 
                  class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Status</option>
                  <option value="current">Current</option>
                  <option value="overdue">Overdue</option>
                  <option value="no-codes">No codes</option>
                  <option value="has-codes">Has codes</option>
                </select>
              </div>
            </div>

            <!-- Customer Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Account</th>
                    <th class="px-0 py-3 pr-0 -mr-4 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Customer</th>
                    <th class="px-0 py-3 pl-0 -ml-4 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Property</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Codes</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsCustomerTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Customer rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Locations Section -->
          <div id="settingsLocationsContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Property Locations</h4>
              <div class="flex gap-3">
                <button 
                  onclick="showAddLocationModal()" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Add Location
                </button>
                <button 
                  onclick="showImportModal()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                >
                  Import Locations
                </button>
              </div>
            </div>

            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsLocationSearch" 
                  type="text" 
                  placeholder="Search locations..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchLocations()"
                />
              </div>
              <div>
                <select 
                  onchange="filterLocationsByStatus(this.value)" 
                  class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Status</option>
                  <option value="occupied">Occupied</option>
                  <option value="available">Available</option>
                </select>
              </div>
            </div>

            <!-- Locations Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Premise ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Owner & Resident</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsLocationsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Location rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Codes Section -->
          <div id="settingsCodesContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Tax Codes</h4>
              <button 
                onclick="showAddCodeModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add Code
              </button>
            </div>

            <!-- Codes Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Code Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Requirements</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsCodesTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Code rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Users Section -->
          <div id="settingsUsersContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">System Users</h4>
              <button 
                onclick="showAddUserModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add User
              </button>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsUserSearch" 
                  type="text" 
                  placeholder="Search users..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchUsers()"
                />
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Full Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsUsersTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- User rows populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Action Buttons -->
      <br><br>
      <div class="flex flex-col items-center gap-4 mb-8 p-8 max-w-2xl mx-auto bg-white dark:bg-slate-800 rounded-3xl border border-blue-100 dark:border-slate-700 shadow-md hover:shadow-2xl hover:scale-[1.02] focus-within:shadow-2xl focus-within:scale-[1.02] transition-all duration-300 ease-out cursor-default">
        <button 
          onclick="showAddClientModule()" 
          class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
          </svg>
          <span class="text-base">Add Client</span>
        </button>

        <button 
          onclick="showPaymentModule()" 
          class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <span class="text-4xl font-black leading-none">$</span>
          <span class="text-base">Make Payment</span>
        </button>

        <button 
          onclick="showBillModule()" 
          class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <span class="text-base">Send Bill</span>
        </button>

        <button 
          onclick="showSearchModule()" 
          class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span class="text-base">Search Database</span>
        </button>

        <button 
          onclick="showSettingsModule()" 
          class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span class="text-base">Settings</span>
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex space-x-1 mb-6 hidden">
        <button 
          id="accountsTab"
          onclick="switchView('accounts')" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
        >
          Accounts
        </button>
        <button 
          id="locationsTab"
          onclick="switchView('locations')" 
          class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
        >
          Locations
        </button>
      </div>

      <!-- Accounts Section -->
      <div id="accountsContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Accounts</h2>
          <div class="flex flex-col gap-2">
            <button 
              onclick="showAddCustomerModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add New Customer
            </button>
            <button 
              onclick="showImportCustomerDataModal()" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm"
            >
              Import Customer Data
            </button>
            <button 
              onclick="syncPastDueFromImportData()" 
              class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm"
              title="Re-sync past due amounts from imported Excel data"
            >
              Sync Past Due Amounts
            </button>
            <button 
              onclick="deleteAllUserData()" 
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
            >
              Delete User Data
            </button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <input 
              id="customerSearch" 
              type="text" 
              placeholder="Search customers..." 
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeyup="searchCustomers()"
            />
          </div>
          <div>
            <select 
              onchange="filterByStatus(this.value)" 
              class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="current">Current</option>
              <option value="overdue">Overdue</option>
              <option value="no-codes">No codes</option>
              <option value="has-codes">Has codes</option>
            </select>
          </div>
        </div>

        <!-- Customer Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Account</th>
                <th class="px-0 py-3 pr-0 -mr-2 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Customer</th>
                <th class="px-0 py-3 pl-0 -ml-2 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Property</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Due Date</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Last Payment</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="customerTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Customer rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Locations Section -->
      <div id="locationsContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Property Locations</h2>
          <div class="flex gap-3">
            <button 
              onclick="showAddLocationModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add Location
            </button>
            <button 
              onclick="showImportModal()" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
            >
              Import Locations
            </button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <input 
              id="locationSearch" 
              type="text" 
              placeholder="Search locations..." 
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeyup="searchLocations()"
            />
          </div>
          <div>
            <select 
              onchange="filterLocationsByStatus(this.value)" 
              class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="occupied">Occupied</option>
              <option value="available">Available</option>
            </select>
          </div>
        </div>

        <!-- Locations Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Premise ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Owner & Resident</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="locationsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Location rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Customer</h3>
          <button 
            onclick="hideAddCustomerModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addCustomerForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              id="newCustomerName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter customer's full name"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
            <input 
              id="newCustomerEmail" 
              type="email" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="customer@email.com"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <input 
              id="newCustomerPhone" 
              type="tel" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="(916) 555-0123"
              oninput="formatPhoneInput(this)"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <select 
              id="newCustomerLocation" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">Select a property location</option>
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <select 
              id="newCustomerEntityType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select Entity Type</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Farmer">Farmer</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
            <input 
              id="newCustomerSSN" 
              type="text" 
              oninput="formatSSNInput(this)"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="xxx-xx-xxxx"
              maxlength="11"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
            <select 
              id="newCustomerIDType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select ID Type</option>
              <option value="Drivers License">Drivers License</option>
              <option value="ID">ID</option>
              <option value="Passport">Passport</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
            <input 
              id="newCustomerIDNumber" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter ID number"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
            <input 
              id="newCustomerSecondaryContactName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter secondary contact name"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
            <input 
              id="newCustomerSecondaryContactPhone" 
              type="tel" 
              oninput="formatPhoneInput(this)"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="(xxx)-xxx-xxxx"
            />
          </div>

          <div class="mt-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
                <input 
                  id="newCustomerMailingStreet" 
                  type="text" 
                  class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter street address"
                />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
                  <input 
                    id="newCustomerMailingCity" 
                    type="text" 
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter city"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
                  <select 
                    id="newCustomerMailingState" 
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">Select State</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                <input 
                  id="newCustomerMailingZip" 
                  type="text" 
                  class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter ZIP code"
                  maxlength="10"
                />
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
            <div class="flex gap-2 mb-4">
              <select 
                id="newCustomerCodeSelect" 
                class="flex-1 px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select a code...</option>
              </select>
              <button 
                type="button"
                onclick="addCustomerCode()" 
                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors"
              >
                Add Code
              </button>
            </div>
            <div id="newCustomerCodesList" class="space-y-2">
              <!-- Selected codes will be displayed here -->
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <input 
                type="number" 
                id="newCustomerFactor" 
                step="any"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter factor"
              >
            </div>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Note:</strong> The customer will be able to log in using their email address and the temporary password "password".
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddCustomerModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addCustomer()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Customer
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Location Modal -->
    <div id="addLocationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Location</h3>
          <button 
            onclick="hideAddLocationModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addLocationForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Premise ID</label>
            <input 
              id="newLocationPremiseId" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-600 text-slate-800 dark:text-slate-200"
              readonly
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
            <input 
              id="newLocationStreet" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="123 Main Street"
              required
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <input 
                id="newLocationCity" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Sacramento"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <input 
                id="newLocationState" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="CA"
                required
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
            <input 
              id="newLocationZip" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="95814"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddLocationModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addLocation()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Location
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add System User</h3>
          <button 
            onclick="hideAddUserModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form class="space-y-4" onsubmit="event.preventDefault(); addUser();">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              id="newUserFullName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter full name"
              required
            />
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              Users are stored in the users collection in Firestore using their full name.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddUserModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="submit"
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add User
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Record Payment</h3>
          <button 
            onclick="hidePaymentModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="paymentCustomerName"></span></h4>
            <p class="text-sm text-blue-800 dark:text-blue-200">Current Balance: <span id="paymentCurrentAmount" class="font-bold"></span></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
            <input 
              id="paymentAmount" 
              type="number" 
              step="0.01"
              min="0.01"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter payment amount"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hidePaymentModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="processPayment()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Record Payment
            </button>
          </div>
        </div>

        <!-- Hidden input for tracking -->
        <input type="hidden" id="paymentCustomerId" />
      </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-4xl w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment History - <span id="historyCustomerName"></span></h3>
          <button 
            onclick="hidePaymentHistory()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Paid</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Remaining Balance</th>
              </tr>
            </thead>
            <tbody id="paymentHistoryBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Payment history rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <div class="mt-6">
          <button 
            type="button"
            onclick="hidePaymentHistory()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Amount Details Modal -->
    <div id="amountDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAmountDetails()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Amount Breakdown</h3>
          <button 
            onclick="hideAmountDetails()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="amountDetailsCustomer"></span></h4>
            <div class="space-y-2 pt-2 border-t border-blue-200 dark:border-blue-700 mt-2">
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Due Date</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsDueDate">--/--/----</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Billing Cycle</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsBillingCycle">--/--/-- - --/--/--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Last Payment</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsLastPayment">Never</span>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
              <span class="font-medium" id="amountDetailsService">$150.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Past Due</span>
              <span class="font-medium cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 p-2 rounded" 
                    id="amountDetailsPastDue" 
                    ondblclick="editPastDueFromModal()"
                    title="Double-click to edit">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Late Fee</span>
              <span class="font-medium" id="amountDetailsLateFee">$0.00</span>
            </div>
            <div id="amountDetailsCodesContainer"></div>
            <div id="amountDetailsFactorContainer"></div>
            <div class="flex justify-between items-center py-3 bg-slate-50 dark:bg-slate-700 rounded-lg px-4">
              <span class="font-semibold text-slate-800 dark:text-slate-200">Total Due</span>
              <span class="font-bold text-lg" id="amountDetailsTotal">$170.00</span>
            </div>
          </div>

          <button 
            type="button"
            onclick="hideAmountDetails()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Field Modal -->
    <div id="editFieldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Edit <span id="editFieldType">Field</span></h3>
          <button 
            onclick="cancelFieldEdit()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">New Value</label>
            <div id="editFieldInputContainer">
              <input 
                id="editFieldValue" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter new value"
                required
              />
            </div>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Tip:</strong> For status, use "available" or "occupied". For residents, use "Available" to make the property available.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="cancelFieldEdit()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="saveFieldEdit()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Save Changes
            </button>
          </div>
        </div>

        <!-- Hidden inputs for tracking -->
        <input type="hidden" id="editFieldLocationId" />
        <input type="hidden" id="editFieldFieldType" />
      </div>
    </div>

    <!-- Import Locations Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Import Locations</h3>
          <button 
            onclick="hideImportModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select JSON File</label>
            <input 
              id="locationFileInput" 
              type="file" 
              accept=".json"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">
            <p class="text-sm text-green-800 dark:text-green-200">
              <strong>JSON Format:</strong> Your file should contain a "locations" array with objects having properties like id, address, propertyType, bedrooms, bathrooms, squareFootage.
            </p>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Sample:</strong> You can use the provided locations.json file as a template.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideImportModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="importLocations()" 
              class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200"
            >
              Import Locations
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Customer Data Modal -->
    <div id="importCustomerDataModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Import Customer Data</h3>
          <button 
            onclick="hideImportCustomerDataModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Excel File (ImportData.xlsx)</label>
            <input 
              id="customerDataFileInput" 
              type="file" 
              accept=".xlsx,.xls"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Note:</strong> All data from the Excel file will be imported and saved to Firebase. The first row should contain column headers. The system will match customers by account number if they already exist, or create new ones.
            </p>
          </div>

          <div id="importPreview" class="hidden">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Preview (first 5 rows)</h4>
            <div class="overflow-x-auto border border-slate-300 dark:border-slate-600 rounded-lg">
              <table id="previewTable" class="min-w-full text-sm">
                <thead class="bg-slate-100 dark:bg-slate-700">
                  <!-- Headers will be populated by JavaScript -->
                </thead>
                <tbody class="bg-white dark:bg-slate-800">
                  <!-- Rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Import Progress Indicator -->
          <div id="importProgress" class="hidden">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl border-2 border-blue-500 mb-4">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-blue-800 dark:text-blue-200">Importing Customer Data...</h4>
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
              </div>
              <div class="space-y-2">
                <div class="flex justify-between text-sm text-blue-700 dark:text-blue-300">
                  <span>Progress:</span>
                  <span id="progressText" class="font-semibold">0 / 0</span>
                </div>
                <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-3">
                  <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="text-xs text-blue-600 dark:text-blue-400 mt-2">
                  <span id="progressStats">Processing...</span>
                </div>
              </div>
            </div>

            <!-- Firestore Upload Progress Indicator -->
            <div id="uploadProgress" class="hidden">
              <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-xl border-2 border-green-500 mb-4">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-lg font-semibold text-green-800 dark:text-green-200">Uploading customers to database</h4>
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                </div>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm text-green-700 dark:text-green-300">
                    <span>Progress:</span>
                    <span id="uploadProgressText" class="font-semibold">0 / 0</span>
                  </div>
                  <div class="w-full bg-green-200 dark:bg-green-800 rounded-full h-3">
                    <div id="uploadProgressBar" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-green-600 dark:text-green-400 mt-2">
                    <span id="uploadProgressStats">Uploading...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Locations Upload Progress Indicator -->
            <div id="locationsUploadProgress" class="hidden">
              <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-xl border-2 border-purple-500">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-lg font-semibold text-purple-800 dark:text-purple-200">Uploading locations to database</h4>
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                </div>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm text-purple-700 dark:text-purple-300">
                    <span>Progress:</span>
                    <span id="locationsUploadProgressText" class="font-semibold">0 / 0</span>
                  </div>
                  <div class="w-full bg-purple-200 dark:bg-purple-800 rounded-full h-3">
                    <div id="locationsUploadProgressBar" class="bg-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-purple-600 dark:text-purple-400 mt-2">
                    <span id="locationsUploadProgressStats">Uploading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideImportCustomerDataModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="importCustomerData()" 
              class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200"
            >
              Import Customer Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="paymentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Breakdown</h3>
          <button 
            onclick="hidePaymentDetailsModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="paymentDetailsCustomer"></span></h4>
          </div>

          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
              <span class="font-medium" id="paymentDetailsService">$150.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Late Fee</span>
              <span class="font-medium" id="paymentDetailsLateFee">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-3 bg-slate-50 dark:bg-slate-700 rounded-lg px-4">
              <span class="font-semibold text-slate-800 dark:text-slate-200">Total Due</span>
              <span class="font-bold text-lg" id="paymentDetailsTotal">$170.00</span>
            </div>
          </div>

          <button 
            type="button"
            onclick="hidePaymentDetailsModal()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Transfer Ownership Modal -->
    <div id="transferOwnershipModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Transfer Property Ownership</h3>
          <button 
            onclick="hideTransferOwnershipModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">âš ï¸ Location Already Occupied</h4>
            <p class="text-sm text-yellow-700 dark:text-yellow-300">
              This location is currently being used by <strong id="transferWarningName"></strong> at <strong id="transferLocation"></strong>.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <h5 class="font-semibold text-slate-800 dark:text-slate-200 mb-3">Current Resident</h5>
              <div class="space-y-2">
                <p><span class="text-slate-600 dark:text-slate-400">Name:</span> <span id="transferCurrentResident"></span></p>
                <p><span class="text-slate-600 dark:text-slate-400">Status:</span> <span id="transferCurrentStatus"></span></p>
                <p><span class="text-slate-600 dark:text-slate-400">Balance:</span> <span id="transferBalance"></span></p>
              </div>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
              <h5 class="font-semibold text-blue-800 dark:text-blue-200 mb-3">New Client</h5>
              <div class="space-y-2">
                <p><span class="text-blue-600 dark:text-blue-400">Name:</span> <span id="transferNewClient"></span></p>
                <p class="text-sm text-blue-600 dark:text-blue-400">Will be assigned to this location</p>
              </div>
            </div>
          </div>

          <div id="transferStatusMessage" class="p-4 rounded-xl">
            <!-- Status message will be populated by JavaScript -->
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              New Location for <span id="transferNewLocationLabel"></span>
            </label>
            <input 
              id="transferNewLocation" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter the new address where they're moving"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideTransferOwnershipModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="processTransferOwnership()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Transfer Ownership
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Code Modal -->
    <div id="addCodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Code</h3>
          <button 
            onclick="hideAddCodeModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addCodeForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Code Name</label>
            <input 
              id="newCodeName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter code name"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Type</label>
            <select 
              id="newCodeType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onchange="updateCodeAmountInput()"
              required
            >
              <option value="percentage">Percentage</option>
              <option value="flat">Flat Rate</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Amount</label>
            <input 
              id="newCodeAmount" 
              type="number" 
              step="0.01"
              min="0"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter amount"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Description</label>
            <textarea 
              id="newCodeDescription" 
              rows="3"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter description"
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Requirements</label>
            <div id="newCodeRequirementsList" class="mb-2 space-y-2">
              <!-- Selected requirements will be displayed here -->
            </div>
            <button 
              type="button"
              onclick="showAddRequirementModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
            >
              Add requirement
            </button>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddCodeModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addCode()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Code
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Code Field Modal -->
    <div id="editCodeFieldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Edit <span id="editCodeFieldType">Field</span></h3>
          <button 
            onclick="cancelEditCodeField()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">New Value</label>
            <div id="editCodeFieldInputContainer">
              <!-- Input will be dynamically inserted here -->
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="cancelEditCodeField()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="saveEditCodeField()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Save Changes
            </button>
          </div>
        </div>

        <!-- Hidden inputs for tracking -->
        <input type="hidden" id="editCodeFieldCodeId" />
        <input type="hidden" id="editCodeFieldFieldType" />
      </div>
    </div>

    <!-- Add Requirement Modal -->
    <div id="addRequirementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAddRequirementModal()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add Requirement</h3>
          <button 
            onclick="hideAddRequirementModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-4">Select Requirements</label>
            <div class="space-y-3">
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="requirementBusiness" 
                  class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementBusiness" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  Business
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="requirementIndividual" 
                  class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementIndividual" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  Individual
                </label>
              </div>
            </div>
          </div>

          <div class="border-t border-slate-200 dark:border-slate-600 pt-4">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">Logic Type</label>
            <div class="space-y-2">
              <div class="flex items-center">
                <input 
                  type="radio" 
                  id="requirementLogicAND" 
                  name="requirementLogic"
                  value="AND"
                  checked
                  class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementLogicAND" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  AND (both must be selected)
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="radio" 
                  id="requirementLogicOR" 
                  name="requirementLogic"
                  value="OR"
                  class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementLogicOR" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  OR (at least one must be selected)
                </label>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddRequirementModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addRequirement()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Full Info Modal -->
    <div id="customerFullInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideCustomerFullInfo()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Information</h3>
          <button 
            onclick="hideCustomerFullInfo()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="customerFullInfoContent" class="space-y-4">
          <!-- Content will be populated by JavaScript -->
        </div>

        <div class="mt-6">
          <button 
            type="button"
            onclick="hideCustomerFullInfo()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Customer Data Profile Modal (Excel Preview) -->
    <div id="customerDataProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideCustomerDataProfile()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Data Profile (Excel Preview)</h3>
          <button 
            onclick="hideCustomerDataProfile()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="customerDataProfileContent" class="space-y-4">
          <!-- Excel-like table will be populated by JavaScript -->
        </div>

        <div class="mt-6 space-y-3">
          <button 
            type="button"
            onclick="copyFullDataProfile()" 
            class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-purple-700 transition-colors duration-200"
          >
            Copy Full Data Profile
          </button>
          <button 
            type="button"
            onclick="hideCustomerDataProfile()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Customer Data Progress Modal -->
    <div id="deleteProgressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Deleting Customer Data</h3>
        </div>

        <div id="deleteProgress" class="hidden">
          <div class="bg-red-50 dark:bg-red-900/20 p-6 rounded-xl border-2 border-red-500 mb-4">
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-lg font-semibold text-red-800 dark:text-red-200">Deleting Customers...</h4>
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
            </div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm text-red-700 dark:text-red-300">
                <span>Progress:</span>
                <span id="deleteProgressText" class="font-semibold">0 / 0</span>
              </div>
              <div class="w-full bg-red-200 dark:bg-red-800 rounded-full h-3">
                <div id="deleteProgressBar" class="bg-red-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <div class="text-xs text-red-600 dark:text-red-400 mt-2">
                <span id="deleteProgressStats">Deleting...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
