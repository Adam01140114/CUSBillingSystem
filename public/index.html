<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Billing - Admin Portal</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- JSZip for creating zip files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, getDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCxfnleg4jI9C3xPI_UabT81vIsnPjukSY",
      authDomain: "cus-billing-e84eb.firebaseapp.com",
      projectId: "cus-billing-e84eb",
      storageBucket: "cus-billing-e84eb.firebasestorage.app",
      messagingSenderId: "606152504829",
      appId: "1:606152504829:web:6d14518df4a56ecfe81594",
      measurementId: "G-FKLJNHMWHV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Firebase Authentication helper functions
    window.firebaseAuth = {
      // Sign in with Firebase Auth (called after password verification)
      signIn: async function(email, password) {
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);

          return { success: true, user: userCredential.user };
        } catch (error) {

          return { success: false, error: error.message };
        }
      },
      // Sign out
      signOut: async function() {
        try {
          await signOut(auth);

        } catch (error) {

        }
      },
      // Sign in anonymously (fallback when userCode is too short for Firebase Auth)
      signInAnonymously: async function() {
        try {
          const userCredential = await signInAnonymously(auth);

          return { success: true, user: userCredential.user };
        } catch (error) {

          return { success: false, error: error.message, code: error.code };
        }
      },
      // Get current user
      getCurrentUser: function() {
        return auth.currentUser;
      },
      // Wait for auth state
      waitForAuth: function() {
        return new Promise((resolve) => {
          const unsubscribe = onAuthStateChanged(auth, (user) => {
            unsubscribe();
            resolve(user);
          });
        });
      }
    };

    // Sample admin credentials
    const adminCredentials = {
      email: 'admin@cus.com',
      password: 'admin123'
    };

    // Customer data (starts empty, customers added through admin interface)
    let customers = [];

    // Drawers data (starts empty, drawers added through settings)
    let drawers = [];

    // Locations data (starts empty, locations added through import or admin interface)
    let locations = [];

    // Users data (managed from the Settings module)
    let users = [];

    // Tax codes data (starts empty, codes added through admin interface)
    let codes = [];

    // Track deleted code names to prevent them from being recreated
    let deletedCodeNames = new Set();

    // Sewer charge setting (defaults to 170, loaded from Firebase)
    let sewerCharge = 170;

    // Late fee setting (defaults to 20, loaded from Firebase)
    let lateFee = 20;

    // PUC Surcharge setting (defaults to 0, loaded from Firebase, applied as percentage to all customers)
    let pucSurcharge = 0;

    // Payment processing tracking
    window.paymentProcessingSessions = [];
    window.currentPaymentProcessing = null;

    function logBatch(message, data) {
      const payload = data !== undefined ? data : '';

    }

    function populatePaymentCustomerSelect() {

      const select = document.getElementById('paymentCustomerSelect');
      if (!select) {

        return;
      }

      const previousValue = select.value;
      select.innerHTML = '<option value="">Choose a customer...</option>';

      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        const name = customer.name || customer.fullName || customer.accountName || 'Unnamed Customer';
        const account = customer.accountNumber || customer.account || customer.id;
        option.textContent = `${name} (${account})`;
        select.appendChild(option);
      });

      if (previousValue) {
        select.value = previousValue;
      }

      select.onchange = () => {
        const customerId = select.value;

        if (!customerId) {
          const info = document.getElementById('customerPaymentInfo');
          if (info) info.classList.add('hidden');
          return;
        }
        window.selectedCustomerIdForPayment = customerId;
        const paymentCustomerId = document.getElementById('paymentCustomerId');
        if (paymentCustomerId) {
          paymentCustomerId.value = customerId;
        }
        showCustomerPaymentInfo(customerId);
      };

    }

    // Format phone number as (xxx)-xxx-xxxx
    function formatPhoneNumber(phone) {
      // Handle null, undefined, or non-string values
      if (!phone) {
        return 'N/A';
      }

      // Convert to string if it's a number
      const phoneStr = String(phone);

      // Remove all non-digit characters
      const cleaned = phoneStr.replace(/\D/g, '');

      // Format as (xxx)-xxx-xxxx
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0, 3)})-${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
      }

      // Return original if not 10 digits
      return phone;
    }

    // Format phone number input as user types
    window.formatPhoneInput = function(input) {
      let value = input.value.replace(/\D/g, ''); // Remove all non-digits

      if (value.length >= 6) {
        // Format as (xxx)-xxx-xxxx
        value = `(${value.slice(0, 3)})-${value.slice(3, 6)}-${value.slice(6, 10)}`;
      } else if (value.length >= 3) {
        // Format as (xxx)-xxx
        value = `(${value.slice(0, 3)})-${value.slice(3)}`;
      } else if (value.length > 0) {
        // Format as (xxx
        value = `(${value}`;
      }

      input.value = value;
    };

    // Format SSN input as user types (xxx-xx-xxxx)
    window.formatSSNInput = function(input) {
      let value = input.value.replace(/\D/g, ''); // Remove all non-digits

      if (value.length >= 5) {
        // Format as xxx-xx-xxxx
        value = `${value.slice(0, 3)}-${value.slice(3, 5)}-${value.slice(5, 9)}`;
      } else if (value.length >= 3) {
        // Format as xxx-xx
        value = `${value.slice(0, 3)}-${value.slice(3)}`;
      }

      input.value = value;
    };

    // Format date as mm/dd/yyyy
    function formatDate(dateString) {
      if (!dateString || dateString === 'Never') {
        return 'Never';
      }

      // If already in mm/dd/yyyy format, return as is
      if (dateString.includes('/')) {
        return dateString;
      }

      // If in yyyy-mm-dd format, convert to mm/dd/yyyy
      if (dateString.includes('-')) {
        const parts = dateString.split('-');
        if (parts.length === 3) {
          return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
      }

      return dateString;
    }

    // Firestore functions
    async function saveLocationsToFirestore(progressCallback) {
      try {
        const locationsRef = collection(db, 'locations');
        // Clear existing locations first
        const existingLocations = await getDocs(locationsRef);
        const deletePromises = [];
        existingLocations.forEach(doc => {
          deletePromises.push(deleteDoc(doc.ref));
        });
        await Promise.all(deletePromises);

        // Add all current locations
        const totalLocations = locations.length;
        let savedCount = 0;
        for (const location of locations) {
          await addDoc(locationsRef, location);
          savedCount++;

          // Update progress every location (or every 10 for console)
          if (savedCount % 10 === 0 || savedCount === totalLocations) {

          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalLocations) * 100);
            progressCallback(savedCount, totalLocations, percent);
          }
        }

      } catch (error) {

        throw error; // Re-throw to be caught by caller
      }
    }

    async function loadLocationsFromFirestore() {
      try {

        const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
        const effectiveRole = window.getEffectiveRole ? window.getEffectiveRole(effectiveUser) : null;

        const locationsRef = collection(db, 'locations');
        const snapshot = await getDocs(locationsRef);

        locations = [];
        snapshot.forEach(doc => {
          locations.push({ id: doc.id, ...doc.data() });
        });

        filteredLocations = [...locations];
        updateLocationsTable();

      } catch (error) {

        // If permission denied, show helpful message
        if (error?.code === 'permission-denied') {
          const firebaseUser = window.firebaseAuth ? window.firebaseAuth.getCurrentUser() : null;
          if (!firebaseUser) {

            // Don't throw - let the app continue, but data won't load
            return;
          }
        }
        throw error;
      }
    }

    // Load drawers from Firestore
    async function loadDrawersFromFirestore() {
      try {

        const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
        const effectiveRole = window.getEffectiveRole ? window.getEffectiveRole(effectiveUser) : null;

        const drawersRef = collection(db, 'drawers');
        const snapshot = await getDocs(drawersRef);

        drawers = [];
        snapshot.forEach(doc => {
          const drawer = { id: doc.id, ...doc.data() };
          // Initialize available field if it doesn't exist (backward compatibility)
          if (drawer.available === undefined) {
            drawer.available = false;
          }
          drawers.push(drawer);
        });

        // Sort by created date (newest first)
        drawers.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
        updateSettingsDrawersTable();
      } catch (error) {

        // If permission denied, show helpful message
        if (error?.code === 'permission-denied') {
          const firebaseUser = window.firebaseAuth ? window.firebaseAuth.getCurrentUser() : null;
          if (!firebaseUser) {

            // Don't throw - let the app continue, but data won't load
            return;
          }
        }
        throw error;
      }
    }

    // Save drawers to Firestore
    async function saveDrawersToFirestore() {
      try {
        const drawersRef = collection(db, 'drawers');
        // Clear existing drawers first
        const existingDrawers = await getDocs(drawersRef);
        const deletePromises = [];
        existingDrawers.forEach(doc => {
          deletePromises.push(deleteDoc(doc.ref));
        });
        await Promise.all(deletePromises);

        // Add all current drawers
        for (const drawer of drawers) {
          await addDoc(drawersRef, drawer);
        }
      } catch (error) {

        throw error;
      }
    }

    // Save all customers to Firestore (used for imports - replaces all customers)
    async function saveAllCustomersToFirestore(progressCallback) {
      try {

        const customersRef = collection(db, 'customers');

        // Clear existing customers first (only for full imports) - use batches for deletion too

        const existingCustomers = await getDocs(customersRef);
        const customerDocs = [];
        existingCustomers.forEach(doc => {
          customerDocs.push(doc);
        });

        // Delete in batches of 500 (Firestore batch limit)
        const deleteBatchSize = 500;
        for (let i = 0; i < customerDocs.length; i += deleteBatchSize) {
          const batch = writeBatch(db);
          const batchDocs = customerDocs.slice(i, Math.min(i + deleteBatchSize, customerDocs.length));
          batchDocs.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          // Small delay between batches to avoid rate limiting
          if (i + deleteBatchSize < customerDocs.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }

        // Add all current customers using batch writes (500 operations per batch)
        const totalCustomers = customers.length;
        const batchSize = 500; // Firestore batch limit
        let savedCount = 0;

        for (let i = 0; i < customers.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchCustomers = customers.slice(i, Math.min(i + batchSize, customers.length));

          batchCustomers.forEach(customer => {
            const customerRef = doc(customersRef, customer.id);
            batch.set(customerRef, customer);
          });

          await batch.commit();
          savedCount += batchCustomers.length;

          // Update progress
          if (savedCount % 100 === 0 || savedCount === totalCustomers) {

          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalCustomers) * 100);
            progressCallback(savedCount, totalCustomers, percent);
          }

          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customers.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }

      } catch (error) {

        throw error; // Re-throw to be caught by caller
      }
    }

    // Save/update customers to Firestore (used for regular updates - updates existing customers)
    async function saveCustomersToFirestore(progressCallback) {
      try {

        const customersRef = collection(db, 'customers');
        const totalCustomers = customers.length;
        const batchSize = 500; // Firestore batch limit
        let savedCount = 0;

        // Use batch writes to reduce API calls
        for (let i = 0; i < customers.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchCustomers = customers.slice(i, Math.min(i + batchSize, customers.length));

          batchCustomers.forEach(customer => {
            try {
              const customerRef = doc(customersRef, customer.id);
              batch.set(customerRef, customer);
            } catch (customerError) {

            }
          });

          await batch.commit();
          savedCount += batchCustomers.length;

          // Update progress every 100 customers
          if (savedCount % 100 === 0 || savedCount === totalCustomers) {

          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalCustomers) * 100);
            progressCallback(savedCount, totalCustomers, percent);
          }

          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customers.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }

      } catch (error) {

        throw error; // Re-throw to be caught by caller
      }
    }

    // Save a single customer to Firestore (avoid updating all customers)
    async function saveSingleCustomerToFirestore(customer) {
      if (!customer || !customer.id) {
        throw new Error('Customer object with valid id is required');
      }
      const customersRef = collection(db, 'customers');
      const customerRef = doc(customersRef, customer.id);
      await setDoc(customerRef, customer);
    }

    async function loadCustomersFromFirestore() {
      try {

        const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
        const effectiveRole = window.getEffectiveRole ? window.getEffectiveRole(effectiveUser) : null;

        const customersRef = collection(db, 'customers');
        const snapshot = await getDocs(customersRef);

        customers = [];
        snapshot.forEach(doc => {
          const customer = { id: doc.id, ...doc.data() };
          // Initialize per-category paid tracking for current month
          customer.currentMonthPaid = parseFloat(customer.currentMonthPaid || 0);
          customer.currentMonthPaidSewer = parseFloat(customer.currentMonthPaidSewer || 0);
          customer.currentMonthPaidTaxCodes = parseFloat(customer.currentMonthPaidTaxCodes || 0);
          customer.currentMonthPaidLateFee = parseFloat(customer.currentMonthPaidLateFee || 0);
          customer.currentMonthPaymentHistory = Array.isArray(customer.currentMonthPaymentHistory) ? customer.currentMonthPaymentHistory : [];
          // Only populate codes from importData if customer doesn't already have codes saved
          // This preserves codes that were added via "Apply to All" or manually
          if (customer.importData && (!customer.codes || customer.codes.length === 0)) {
            populateCustomerCodesFromImportData(customer);
          }
          // Initialize currentMonthPaid if it doesn't exist (for customers loaded from Firestore)
          if (customer.currentMonthPaid === undefined || customer.currentMonthPaid === null) {
            customer.currentMonthPaid = 0;
          }
          customers.push(customer);
        });
        filteredCustomers = [...customers];

        updateCustomerTable();
        populatePaymentCustomerSelect();

        // Save codes to Firestore if any new codes were added during customer load
        // NOTE: Since loadCodesFromFirestore() now runs FIRST, codes are already loaded.
        // This will only save if ensureCodeExists() created any NEW codes that weren't in Firestore.
        // If codes already existed, ensureCodeExists() will find them and return them, so no new codes are created.
        if (codes.length > 0) {
          // Avoid write attempts during customer load to prevent permission errors

        }
      } catch (error) {

        // If permission denied, show helpful message
        if (error?.code === 'permission-denied') {
          const firebaseUser = window.firebaseAuth ? window.firebaseAuth.getCurrentUser() : null;
          if (!firebaseUser) {

            // Don't throw - let the app continue, but data won't load
            return;
          }
        }
        throw error;
      }
    }

    async function saveCodesToFirestore() {
      try {

        const codesRef = collection(db, 'codes');

        // Get existing codes to find ones that should be deleted
        const existingCodes = await getDocs(codesRef);
        const existingCodeIds = new Set(existingCodes.docs.map(doc => doc.id));
        const currentCodeIds = new Set(codes.map(code => code.id));

        // Delete codes that no longer exist
        const deletePromises = [];
        existingCodes.forEach(doc => {
          if (!currentCodeIds.has(doc.id)) {
            deletePromises.push(deleteDoc(doc.ref));
          }
        });
        if (deletePromises.length > 0) {

          await Promise.all(deletePromises);
        }

        // Save all current codes using their ID as the document ID
        for (const code of codes) {
          const codeRef = doc(codesRef, code.id);

          // Build the code object to save - preserve ALL fields from the code object
          // Use spread operator to copy all properties, then ensure amount/percentage are set correctly
          const codeToSave = {
            ...code,
            // Ensure amount is set - use code.amount if it exists (even if 0), otherwise fall back to percentage or 0
            amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
            // For percentage type, sync percentage with amount if amount is set, otherwise use percentage or 0
            percentage: code.type === 'percentage' && code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0)
          };

          await setDoc(codeRef, codeToSave);

          // Verify what was actually saved by reading it back immediately
          const verifyDoc = await getDoc(codeRef);
          const verifyData = verifyDoc.data();

        }

      } catch (error) {

        throw error; // Re-throw so caller can handle it
      }
    }

    async function loadCodesFromFirestore() {
      try {
        // First, load deleted code names to prevent recreation
        try {
          const deletedCodesRef = doc(db, 'settings', 'deletedCodeNames');
          const deletedCodesDoc = await getDoc(deletedCodesRef);
          if (deletedCodesDoc.exists()) {
            const data = deletedCodesDoc.data();
            if (data.names && Array.isArray(data.names)) {
              deletedCodeNames = new Set(data.names);

            }
          }
        } catch (error) {

        }

        const codesRef = collection(db, 'codes');
        const snapshot = await getDocs(codesRef);
        codes = [];
        snapshot.forEach(doc => {
          // Use document ID as the code ID (since we save with code.id as document ID)
          // Spread data first, then override id to ensure document ID takes precedence
          const codeData = doc.data();
          const loadedCode = { ...codeData, id: doc.id };
          codes.push(loadedCode);

          // Log each code as it's loaded

        });

        updateCodesTable();

      } catch (error) {

      }
    }

    async function saveUsersToFirestore() {
      try {
        const usersRef = collection(db, 'users');
        const existingUsers = await getDocs(usersRef);
        existingUsers.forEach(userDoc => {
          deleteDoc(userDoc.ref);
        });

        for (const user of users) {
          const userRef = doc(usersRef, user.id);
          await setDoc(userRef, user);
        }

      } catch (error) {

      }
    }

    async function loadUsersFromFirestore() {

      try {
        const usersRef = collection(db, 'users');

        const snapshot = await getDocs(usersRef);

        users = [];
        snapshot.forEach(docSnap => {
          const userData = { id: docSnap.id, ...docSnap.data() };

          users.push(userData);
        });

        filteredUsers = [...users];

        // Only update UI if functions exist (might not be available before auth)
        if (typeof updateSettingsUsersTable === 'function') {
        updateSettingsUsersTable();
        }
        if (typeof populateBatchStartUserSelect === 'function') {
        populateBatchStartUserSelect();
        }

      } catch (error) {

        // Don't throw - allow login to continue even if users can't be loaded
        // (might be a permissions issue that will resolve after auth)
      }
    }

    // Hierarchy order management
    // Default order updated: remove PUC Surcharge, rename Current Due -> Sewer Charge
    window.paymentHierarchyOrder = ['Sewer Charge', 'Tax Codes', 'Late Fee', 'Past Due'];
    let hierarchyLoaded = false;
    let hierarchyIsDirty = false;
    let hierarchyLoadVersion = 0;

    async function loadHierarchyOrder() {
      try {
        const loadVersion = ++hierarchyLoadVersion;
        const hierarchyRef = doc(db, 'settings', 'paymentHierarchy');
        const hierarchyDoc = await getDoc(hierarchyRef);

        if (loadVersion !== hierarchyLoadVersion) {
          return;
        }
        if (hierarchyIsDirty) {
          // Keep local changes if the user has already reordered
          return;
        }
        if (hierarchyDoc.exists()) {
          const data = hierarchyDoc.data();
          if (data.order && Array.isArray(data.order)) {
            // Filter out removed item and rename "Current Due" -> "Sewer Charge"
            window.paymentHierarchyOrder = data.order
              .filter(item => item !== 'PUC Surcharge')
              .map(item => item === 'Current Due' ? 'Sewer Charge' : item);
          }
        }

        renderHierarchyList();
        hierarchyLoaded = true;
      } catch (error) {

        renderHierarchyList(); // Render with default order even if load fails
      }
    }

    window.saveHierarchyOrder = async function(options = {}) {
      try {
        const hierarchyRef = doc(db, 'settings', 'paymentHierarchy');
        await setDoc(hierarchyRef, {
          order: window.paymentHierarchyOrder,
          updatedAt: new Date().toISOString()
        });

        hierarchyIsDirty = false;
        if (!options.silent) {
          alert('Hierarchy order saved successfully!');
        }
      } catch (error) {

        if (!options.silent) {
          alert('Error saving hierarchy order. Please try again.');
        }
      }
    }

    function renderHierarchyList() {
      const hierarchyList = document.getElementById('hierarchyList');
      if (!hierarchyList) return;

      // Use DocumentFragment for faster DOM updates
      const fragment = document.createDocumentFragment();

      window.paymentHierarchyOrder.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 p-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg cursor-move hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors draggable-item';
        div.draggable = true;
        div.dataset.index = index;
        div.dataset.item = item;
        div.ondragstart = handleHierarchyDragStart;
        div.ondragenter = handleHierarchyDragEnter;
        div.ondragleave = handleHierarchyDragLeave;
        div.ondragover = handleHierarchyDragOver;
        div.ondrop = handleHierarchyDrop;
        div.ondragend = handleHierarchyDragEnd;

        div.innerHTML = `
          <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
          </svg>
          <span class="flex-1 text-slate-700 dark:text-slate-200 font-medium">${item}</span>
          <span class="text-sm text-slate-500 dark:text-slate-400">${index + 1}</span>
        `;

        fragment.appendChild(div);
      });

      // Clear and update in one operation
      hierarchyList.innerHTML = '';
      hierarchyList.appendChild(fragment);
    }

    let draggedHierarchyIndex = null;
    let draggedHierarchyElement = null;
    let lastHierarchyDragOverIndex = null;

    window.handleHierarchyDragStart = function(e) {
      draggedHierarchyElement = e.target.closest('.draggable-item');
      if (!draggedHierarchyElement) return;

      draggedHierarchyIndex = parseInt(draggedHierarchyElement.dataset.index);
      draggedHierarchyElement.classList.add('opacity-50');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', draggedHierarchyElement.innerHTML);
    };

    window.handleHierarchyDragOver = function(e) {
      e.preventDefault();
      if (e.dataTransfer) {
        e.dataTransfer.dropEffect = 'move';
      }

      const item = e.target.closest('.draggable-item');
      if (!item || item === draggedHierarchyElement) return;

      // Move the dragged element immediately on hover for instant visual feedback
      const hierarchyList = document.getElementById('hierarchyList');
      if (!hierarchyList) return;

      const overIndex = parseInt(item.dataset.index);
      if (Number.isNaN(overIndex) || overIndex === lastHierarchyDragOverIndex) return;

      if (draggedHierarchyIndex < overIndex) {
        hierarchyList.insertBefore(draggedHierarchyElement, item.nextSibling);
      } else {
        hierarchyList.insertBefore(draggedHierarchyElement, item);
      }

      // Update order array and indices based on current DOM
      const items = Array.from(hierarchyList.children);
      window.paymentHierarchyOrder = items.map(node => node.dataset.item);
      items.forEach((node, index) => {
        node.dataset.index = index;
        const orderLabel = node.querySelector('span:last-child');
        if (orderLabel) orderLabel.textContent = index + 1;
      });

      draggedHierarchyIndex = parseInt(draggedHierarchyElement.dataset.index);
      lastHierarchyDragOverIndex = overIndex;
      hierarchyIsDirty = true;

      // Highlight the current item
      document.querySelectorAll('.draggable-item').forEach(i => {
        i.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
      });
      item.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
    };

    window.handleHierarchyDragEnter = function(e) {
      e.preventDefault();
      const item = e.target.closest('.draggable-item');
      if (item && item !== draggedHierarchyElement) {
        // Remove highlight from all items first
        document.querySelectorAll('.draggable-item').forEach(i => {
          if (i !== item) {
            i.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
          }
        });
        item.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
      }
    };

    window.handleHierarchyDragLeave = function(e) {
      // Only remove highlight if we're actually leaving the item (not just moving to a child)
      const item = e.target.closest('.draggable-item');
      const relatedTarget = e.relatedTarget;
      if (item && (!relatedTarget || !item.contains(relatedTarget))) {
        item.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
      }
    };

    window.handleHierarchyDrop = function(e) {
      e.preventDefault();
      e.stopPropagation();

      if (hierarchyIsDirty) {
        // Save silently in the background so reloads preserve the order
        window.saveHierarchyOrder({ silent: true });
      }

      handleHierarchyDragEnd(e);
    };

    window.handleHierarchyDragEnd = function(e) {
      // Remove opacity from all items
      document.querySelectorAll('.draggable-item').forEach(item => {
        item.classList.remove('opacity-50', 'border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
      });
      draggedHierarchyIndex = null;
      draggedHierarchyElement = null;
      lastHierarchyDragOverIndex = null;
    };

    // Load sewer charge from Firestore
    async function loadSewerChargeFromFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'sewerCharge');
        const settingsDoc = await getDoc(settingsRef);

        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          sewerCharge = data.value !== undefined ? data.value : 170;
        } else {
          // If setting doesn't exist, create it with default value
          await setDoc(settingsRef, { value: 170 });
          sewerCharge = 170;
        }

        // Update UI if Codes screen is visible
        updateSewerChargeDisplay();
      } catch (error) {

        // Keep default value on error
        sewerCharge = 170;
      }
    }

    // Save sewer charge to Firestore
    async function saveSewerChargeToFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'sewerCharge');
        await setDoc(settingsRef, { value: sewerCharge });
      } catch (error) {

        throw error;
      }
    }

    // Load late fee from Firestore
    async function loadLateFeeFromFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'lateFee');
        const settingsDoc = await getDoc(settingsRef);

        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          lateFee = data.value !== undefined ? data.value : 20;
        } else {
          // If setting doesn't exist, create it with default value
          await setDoc(settingsRef, { value: 20 });
          lateFee = 20;
        }

        // Update UI if Codes screen is visible
        updateLateFeeDisplay();
      } catch (error) {

        // Keep default value on error
        lateFee = 20;
      }
    }

    // Save late fee to Firestore
    async function saveLateFeeToFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'lateFee');
        await setDoc(settingsRef, { value: lateFee });
      } catch (error) {

        throw error;
      }
    }

    // Load PUC Surcharge from Firestore
    async function loadPucSurchargeFromFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'pucSurcharge');
        const settingsDoc = await getDoc(settingsRef);

        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          pucSurcharge = data.value !== undefined ? data.value : 0;
        } else {
          // If setting doesn't exist, create it with default value
          await setDoc(settingsRef, { value: 0 });
          pucSurcharge = 0;
        }

        // Update UI if Codes screen is visible
        updatePucSurchargeDisplay();
      } catch (error) {

        // Keep default value on error
        pucSurcharge = 0;
      }
    }

    // Save PUC Surcharge to Firestore
    async function savePucSurchargeToFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'pucSurcharge');
        await setDoc(settingsRef, { value: pucSurcharge });
      } catch (error) {

        throw error;
      }
    }

    // Load toggles settings from Firestore
    async function loadTogglesSettings() {
      try {
        const settingsRef = doc(db, 'settings', 'toggles');
        const settingsDoc = await getDoc(settingsRef);

        let settings;
        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          settings = {
            askUserCodePerTransaction: data.askUserCodePerTransaction || false,
            skipPOSInitialRegisterCount: data.skipPOSInitialRegisterCount || false,
            afterHoursLogoutEnabled: data.afterHoursLogoutEnabled || false,
            afterHoursStartTime: data.afterHoursStartTime || '17:00',
            afterHoursEndTime: data.afterHoursEndTime || '09:00',
            posDoesntCloseOut: data.posDoesntCloseOut || false,
            useUsernameInsteadOfUserCode: data.useUsernameInsteadOfUserCode || false
          };
        } else {
          // If setting doesn't exist, create it with default values
          settings = { 
            askUserCodePerTransaction: false,
            skipPOSInitialRegisterCount: false,
            afterHoursLogoutEnabled: false,
            afterHoursStartTime: '17:00',
            afterHoursEndTime: '09:00',
            posDoesntCloseOut: false,
            useUsernameInsteadOfUserCode: false
          };
          await setDoc(settingsRef, settings);
        }

        // Update checkboxes if they exist
        const toggleCheckbox = document.getElementById('toggleUserCodePerTransaction');
        if (toggleCheckbox) {
          toggleCheckbox.checked = settings.askUserCodePerTransaction;
        }
        const skipInitialCountCheckbox = document.getElementById('toggleSkipPOSInitialCount');
        if (skipInitialCountCheckbox) {
          skipInitialCountCheckbox.checked = settings.skipPOSInitialRegisterCount;
        }
        const afterHoursCheckbox = document.getElementById('toggleAfterHoursLogout');
        if (afterHoursCheckbox) {
          afterHoursCheckbox.checked = settings.afterHoursLogoutEnabled;

        }
        const afterHoursStartTimeInput = document.getElementById('afterHoursStartTime');
        if (afterHoursStartTimeInput) {
          const startTimeValue = settings.afterHoursStartTime || '17:00';
          afterHoursStartTimeInput.value = startTimeValue;

        }
        const afterHoursEndTimeInput = document.getElementById('afterHoursEndTime');
        if (afterHoursEndTimeInput) {
          const endTimeValue = settings.afterHoursEndTime || '09:00';
          afterHoursEndTimeInput.value = endTimeValue;

        }
        const posDoesntCloseOutCheckbox = document.getElementById('togglePOSDoesntCloseOut');
        if (posDoesntCloseOutCheckbox) {
          posDoesntCloseOutCheckbox.checked = settings.posDoesntCloseOut;
        }
        const useUsernameInsteadOfUserCodeCheckbox = document.getElementById('toggleUseUsernameInsteadOfUserCode');
        if (useUsernameInsteadOfUserCodeCheckbox) {
          const toggleValue = settings.useUsernameInsteadOfUserCode === true || settings.useUsernameInsteadOfUserCode === 'true' || settings.useUsernameInsteadOfUserCode === 1;
          useUsernameInsteadOfUserCodeCheckbox.checked = toggleValue;
          console.log('[loadTogglesSettings] useUsernameInsteadOfUserCode checkbox found, setting to:', toggleValue, 'from settings:', settings.useUsernameInsteadOfUserCode);
        } else {
          console.warn('[loadTogglesSettings] useUsernameInsteadOfUserCode checkbox not found in DOM');
        }

        // Update time inputs visibility
        updateAfterHoursTimeInputs();

        return settings;
      } catch (error) {

        // Return default values on error
        return { 
          askUserCodePerTransaction: false,
          skipPOSInitialRegisterCount: false,
          afterHoursLogoutEnabled: false,
          afterHoursStartTime: '17:00',
          afterHoursEndTime: '09:00',
          posDoesntCloseOut: false,
          useUsernameInsteadOfUserCode: false
        };
      }
    }

    // Save toggles settings to Firestore
    async function saveTogglesSettings() {
      try {
        const toggleCheckbox = document.getElementById('toggleUserCodePerTransaction');
        const skipInitialCountCheckbox = document.getElementById('toggleSkipPOSInitialCount');
        const afterHoursCheckbox = document.getElementById('toggleAfterHoursLogout');
        const afterHoursStartTimeInput = document.getElementById('afterHoursStartTime');
        const afterHoursEndTimeInput = document.getElementById('afterHoursEndTime');
        const posDoesntCloseOutCheckbox = document.getElementById('togglePOSDoesntCloseOut');
        const useUsernameInsteadOfUserCodeCheckbox = document.getElementById('toggleUseUsernameInsteadOfUserCode');

        const askUserCodePerTransaction = toggleCheckbox ? toggleCheckbox.checked : false;
        const skipPOSInitialRegisterCount = skipInitialCountCheckbox ? skipInitialCountCheckbox.checked : false;
        const afterHoursLogoutEnabled = afterHoursCheckbox ? afterHoursCheckbox.checked : false;
        const afterHoursStartTime = afterHoursStartTimeInput ? afterHoursStartTimeInput.value : '17:00';
        const afterHoursEndTime = afterHoursEndTimeInput ? afterHoursEndTimeInput.value : '09:00';
        const posDoesntCloseOut = posDoesntCloseOutCheckbox ? posDoesntCloseOutCheckbox.checked : false;
        const useUsernameInsteadOfUserCode = useUsernameInsteadOfUserCodeCheckbox ? useUsernameInsteadOfUserCodeCheckbox.checked : false;
        console.log('[saveTogglesSettings] Saving useUsernameInsteadOfUserCode:', useUsernameInsteadOfUserCode, 'checkbox found:', !!useUsernameInsteadOfUserCodeCheckbox, 'checkbox checked:', useUsernameInsteadOfUserCodeCheckbox?.checked);

        const settingsRef = doc(db, 'settings', 'toggles');
        const settingsToSave = {
          askUserCodePerTransaction: askUserCodePerTransaction,
          skipPOSInitialRegisterCount: skipPOSInitialRegisterCount,
          afterHoursLogoutEnabled: afterHoursLogoutEnabled,
          afterHoursStartTime: afterHoursStartTime,
          afterHoursEndTime: afterHoursEndTime,
          posDoesntCloseOut: posDoesntCloseOut,
          useUsernameInsteadOfUserCode: useUsernameInsteadOfUserCode,
          updatedAt: new Date().toISOString()
        };
        console.log('[saveTogglesSettings] Saving settings to Firestore:', settingsToSave);
        await setDoc(settingsRef, settingsToSave);
        console.log('[saveTogglesSettings] Settings saved successfully');

        // Show success feedback
        if (toggleCheckbox) {
          toggleCheckbox.disabled = true;
          setTimeout(() => {
            toggleCheckbox.disabled = false;
          }, 500);
        }
        if (skipInitialCountCheckbox) {
          skipInitialCountCheckbox.disabled = true;
          setTimeout(() => {
            skipInitialCountCheckbox.disabled = false;
          }, 500);
        }
        if (afterHoursCheckbox) {
          afterHoursCheckbox.disabled = true;
          setTimeout(() => {
            afterHoursCheckbox.disabled = false;
          }, 500);
        }
      } catch (error) {

        alert('Error saving toggle settings. Please try again.');
      }
    }

    // Update after hours time inputs visibility
    function updateAfterHoursTimeInputs() {
      const afterHoursCheckbox = document.getElementById('toggleAfterHoursLogout');
      const timeInputsContainer = document.getElementById('afterHoursTimeInputs');
      if (afterHoursCheckbox && timeInputsContainer) {
        if (afterHoursCheckbox.checked) {
          timeInputsContainer.classList.remove('hidden');
        } else {
          timeInputsContainer.classList.add('hidden');
        }
      }
    }

    // Make loadTogglesSettings globally accessible
    window.loadTogglesSettings = loadTogglesSettings;
    window.saveTogglesSettings = saveTogglesSettings;
    window.updateAfterHoursTimeInputs = updateAfterHoursTimeInputs;

    // Print payment receipt from session details
    window.printPaymentReceiptFromSession = function(sessionId, entryIndex) {
      const session = window.paymentProcessingSessions.find(s => s.id === sessionId);
      if (!session || !session.entries || !session.entries[entryIndex]) {
        alert('Payment entry not found');
        return;
      }

      const entry = session.entries[entryIndex];
      const customer = customers.find(c => c.id === entry.accountNumber || c.accountNumber === entry.accountNumber);

      const receivedAmount = entry.paymentType === 'Cash'
        ? (entry.cashReceived ?? entry.amount)
        : (entry.checkReceived ?? entry.amount);
      const changeGiven = entry.paymentType === 'Cash'
        ? (entry.changeGiven || 0)
        : (entry.checkChangeGiven || 0);
      const creditGiven = entry.checkCreditGiven || 0;

      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Payment Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
            .text-right { text-align: right; }
          </style>
        </head>
        <body>
          <h1>Payment Receipt</h1>
          <div class="info">
            <p><strong>Date:</strong> ${entry.date || '—'}</p>
            <p><strong>Customer:</strong> ${entry.customerName || '—'}</p>
            <p><strong>Account #:</strong> ${entry.accountNumber || '—'}</p>
            <p><strong>Property:</strong> ${entry.property || '—'}</p>
            <p><strong>Processed By:</strong> ${entry.processedBy || window.authenticatedUser?.fullName || session.username || '—'}</p>
          </div>
          <table>
            <tr><th>Item</th><th class="text-right">Amount</th></tr>
            <tr><td>Payment Type</td><td class="text-right">${entry.paymentType || '—'}</td></tr>
            <tr><td>Amount Received</td><td class="text-right">$${receivedAmount.toFixed(2)}</td></tr>
            ${changeGiven > 0 ? `<tr><td>Change Given</td><td class="text-right">$${changeGiven.toFixed(2)}</td></tr>` : ''}
            <tr><td>Credit Given</td><td class="text-right">$${creditGiven.toFixed(2)}</td></tr>
            ${entry.checkNumber ? `<tr><td>Check Number</td><td class="text-right">${entry.checkNumber}</td></tr>` : ''}
          </table>
          <div class="total">Total Paid: $${entry.amount.toFixed(2)}</div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    // Print payment receipt
    window.printPaymentReceipt = function(entryIndex) {
      if (!window.currentPaymentProcessing || !window.currentPaymentProcessing.entries || !window.currentPaymentProcessing.entries[entryIndex]) {
        alert('Payment entry not found');
        return;
      }

      const entry = window.currentPaymentProcessing.entries[entryIndex];
      const customer = customers.find(c => c.id === entry.accountNumber || c.accountNumber === entry.accountNumber);

      const receivedAmount = entry.paymentType === 'Cash'
        ? (entry.cashReceived ?? entry.amount)
        : (entry.checkReceived ?? entry.amount);
      const changeGiven = entry.paymentType === 'Cash'
        ? (entry.changeGiven || 0)
        : (entry.checkChangeGiven || 0);
      const creditGiven = entry.checkCreditGiven || 0;

      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Payment Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
            .text-right { text-align: right; }
          </style>
        </head>
        <body>
          <h1>Payment Receipt</h1>
          <div class="info">
            <p><strong>Date:</strong> ${entry.date || '—'}</p>
            <p><strong>Customer:</strong> ${entry.customerName || '—'}</p>
            <p><strong>Account #:</strong> ${entry.accountNumber || '—'}</p>
            <p><strong>Property:</strong> ${entry.property || '—'}</p>
            <p><strong>Processed By:</strong> ${entry.processedBy || window.authenticatedUser?.fullName || '—'}</p>
          </div>
          <table>
            <tr><th>Item</th><th class="text-right">Amount</th></tr>
            <tr><td>Payment Type</td><td class="text-right">${entry.paymentType || '—'}</td></tr>
            <tr><td>Amount Received</td><td class="text-right">$${receivedAmount.toFixed(2)}</td></tr>
            ${changeGiven > 0 ? `<tr><td>Change Given</td><td class="text-right">$${changeGiven.toFixed(2)}</td></tr>` : ''}
            <tr><td>Credit Given</td><td class="text-right">$${creditGiven.toFixed(2)}</td></tr>
            ${entry.checkNumber ? `<tr><td>Check Number</td><td class="text-right">${entry.checkNumber}</td></tr>` : ''}
            ${entry.amountDue !== undefined && entry.amountDue !== null ? `<tr><td>Amount Due</td><td class="text-right">$${parseFloat(entry.amountDue).toFixed(2)}</td></tr>` : ''}
            ${entry.checkOverpaymentHandling ? `<tr><td>Overpayment Handling</td><td class="text-right">${entry.checkOverpaymentHandling === 'credit' ? 'Give Credit' : entry.checkOverpaymentHandling === 'change' ? 'Give Change' : entry.checkOverpaymentHandling}</td></tr>` : ''}
          </table>
          <div class="total">Total Paid: $${entry.amount.toFixed(2)}</div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    async function savePaymentProcessingSessionToFirestore(session) {
      try {

        const sessionsRef = collection(db, 'paymentProcessingSessions');
        const sessionRef = doc(sessionsRef, session.id);
        await setDoc(sessionRef, session);

        return true;
      } catch (error) {

        throw error;
      }
    }

    async function loadPaymentProcessingSessionsFromFirestore() {
      try {

        const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
        const effectiveRole = window.getEffectiveRole ? window.getEffectiveRole(effectiveUser) : null;

        const sessionsRef = collection(db, 'paymentProcessingSessions');
        const snapshot = await getDocs(sessionsRef);

        window.paymentProcessingSessions = [];
        snapshot.forEach(sessionDoc => {
          const sessionData = { id: sessionDoc.id, ...sessionDoc.data() };

          window.paymentProcessingSessions.push(sessionData);
        });

        renderPaymentProcessingSessionsList();
      } catch (error) {

        // If it's a permissions error, provide helpful message
        if (error.code === 'permission-denied' || error.message.includes('permissions')) {

        }

        // Initialize empty array so the app doesn't break
        if (!window.paymentProcessingSessions) {
          window.paymentProcessingSessions = [];
        }
      }
    }

    let currentUser = null;
    let filteredCustomers = [...customers];
    let filteredLocations = [...locations];
    let filteredUsers = [...users];
    let currentView = 'accounts'; // 'accounts' or 'locations'

    // Test date functionality - allows testing month changes without waiting
    let testDate = null; // If null, use real current date. If set, use this date for all calculations.

    // Get current date (either real or test date)
    window.getCurrentDate = function() {
      if (testDate) {
        return new Date(testDate);
      }
      return new Date();
    };

    // Set test date (called from Data Cleanup input)
    window.setTestDate = function(dateString) {
      if (dateString && dateString.trim() !== '') {
        const parsed = new Date(dateString);
        if (!isNaN(parsed.getTime())) {
          testDate = dateString;

          updateTestDateDisplay();
          // Refresh UI to reflect new date
          updateDashboard();
          if (document.getElementById('settingsModule') && !document.getElementById('settingsModule').classList.contains('hidden')) {
            updateSettingsCustomerTable();
          }
        } else {
          alert('Invalid date format. Please use YYYY-MM-DD format.');
        }
      } else {
        testDate = null;

        updateTestDateDisplay();
        // Refresh UI
        updateDashboard();
        if (document.getElementById('settingsModule') && !document.getElementById('settingsModule').classList.contains('hidden')) {
          updateSettingsCustomerTable();
        }
      }
    };

    // Clear test date
    window.clearTestDate = function() {
      testDate = null;
      const input = document.getElementById('testDateInput');
      if (input) {
        input.value = '';
      }
      updateTestDateDisplay();

      // Refresh UI
      updateDashboard();
      if (document.getElementById('settingsModule') && !document.getElementById('settingsModule').classList.contains('hidden')) {
        updateSettingsCustomerTable();
      }
    };

    // Update test date display
    function updateTestDateDisplay() {
      const statusEl = document.getElementById('testDateStatus');
      const displayEl = document.getElementById('currentDateDisplay');
      if (statusEl && displayEl) {
        const current = window.getCurrentDate();
        const dateStr = current.toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        if (testDate) {
          statusEl.innerHTML = `Using test date: <strong>${dateStr}</strong>`;
        } else {
          statusEl.innerHTML = `Using real current date: <strong>${dateStr}</strong>`;
        }
      }
    }

    // Initialize test date input when settings module opens
    const originalShowSettingsModule = window.showSettingsModule;
    window.showSettingsModule = async function() {
      await originalShowSettingsModule();
      // Initialize test date input
      const testDateInput = document.getElementById('testDateInput');
      if (testDateInput) {
        // Set default to today's date in YYYY-MM-DD format
        const today = window.getCurrentDate();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');
        testDateInput.value = testDate || `${year}-${month}-${day}`;
        updateTestDateDisplay();
      }
    };

    // Show dashboard immediately (no authentication required)
    function showDashboard() {
      updateDashboard();
    }

    // Reset bills on first of month
    function resetMonthlyBills() {
      const now = window.getCurrentDate();
      const isFirstOfMonth = now.getDate() === 1;

      if (isFirstOfMonth) {
        // Check if we've already reset this month by checking if there's a reset flag in localStorage
        const lastResetDate = localStorage.getItem('lastMonthlyBillReset');
        const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;

        // Only reset if we haven't reset this month yet
        if (lastResetDate !== currentMonthKey) {

          let needsSave = false;

          customers.forEach(customer => {
            // Only reset if currentBill is not already equal to sewer charge (avoid unnecessary saves)
            if (customer.currentBill !== sewerCharge) {
              // Reset current bill to full amount on first of month
              // Note: pastDue should NOT be reset - it carries over from previous months
              customer.currentBill = sewerCharge;
              // Reset currentMonthPaid to 0 for the new month
              customer.currentMonthPaid = 0;
              // Update payment status based on past due amount
              updateCustomerPaymentStatus(customer);
              needsSave = true;
            } else if (customer.currentMonthPaid !== undefined && customer.currentMonthPaid !== 0) {
              // Reset currentMonthPaid even if currentBill is already correct
              customer.currentMonthPaid = 0;
              needsSave = true;
            }
          });

          // Only save if we actually made changes
          if (needsSave) {

            saveCustomersToFirestore().then(() => {
              // Mark that we've reset this month
              localStorage.setItem('lastMonthlyBillReset', currentMonthKey);

            }).catch(error => {

            });
          } else {
            // Mark as reset even if no changes (all customers already had currentBill = 170)
            localStorage.setItem('lastMonthlyBillReset', currentMonthKey);

          }
        } else {

        }
      }
    }

    // MutationObserver to track payment module changes
    let paymentModuleObserver = null;
    function setupPaymentModuleObserver() {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule || paymentModuleObserver) return;

      paymentModuleObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {

          }
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {

          }
        });
      });

      paymentModuleObserver.observe(paymentModule, {
        childList: true,
        subtree: true,
        characterData: true,
        attributes: true,
        attributeOldValue: true,
        attributeFilter: ['class']
      });

    }

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', async function() {

      // Ensure the payment module markup (with batch controls) is in place before data loads
      // Pass true to keepHidden to prevent showing payment batches on initial load
      resetPaymentForm(true);
      showDashboard();
      // Set up mutation observer after payment module is created
      setTimeout(setupPaymentModuleObserver, 100);

      // SECURITY: Check Firebase Authentication - show modal if not authenticated

      // Account roles configuration
      const ACCOUNT_ROLES = {
        'adam@gmail.com': 'admin',
        'admin@alcowater.com': 'admin',
        'adamchaabane1234@gmail.com': 'helpdesk',
        'pos@alcowater.com': 'pos',
        'supervisor@alcowater.com': 'supervisor'
      };

      // Admin UID (for backward compatibility with Firestore rules)
      const ADMIN_UID = 'fQEVSsWI0DRca4h8K7uJgTwmjfv2'; // Admin user UID

      // Get user role from email (legacy) or user object (new)
      function getUserRole(emailOrUser) {

        // If it's a user object (new system)
        if (emailOrUser && typeof emailOrUser === 'object' && emailOrUser.title) {

          // Map title to role
          const title = (emailOrUser.title || '').toLowerCase().trim();
          let role = null;
          if (title.includes('point of sale') || title === 'pos') {
            role = 'pos';
          } else if (title.includes('admin')) {
            role = 'admin';
          } else if (title.includes('supervisor')) {
            role = 'supervisor';
          } else if (title.includes('helpdesk')) {
            role = 'helpdesk';
          }

          return role;
        }

        // Legacy: email-based lookup
        if (typeof emailOrUser === 'string') {
          const normalizedEmail = emailOrUser.toLowerCase().trim();
          const role = ACCOUNT_ROLES[normalizedEmail] || null;

          return role;
        }

        return null;
      }

      // Make getUserRole globally accessible
      window.getUserRole = getUserRole;

      // Store authenticated user (new system)
      window.authenticatedUser = null;

      // Helper: get the current active user (new auth first, then Firebase Auth)
      window.getEffectiveUser = function getEffectiveUser() {
        const authUser = window.authenticatedUser || null;
        if (authUser) {
          return authUser;
        }
        const firebaseUser = window.firebaseAuth ? window.firebaseAuth.getCurrentUser() : null;
        return firebaseUser || null;
      };

      // Helper: resolve role for any user type (new or legacy)
      window.getEffectiveRole = function getEffectiveRole(user = null) {
        const resolvedUser = user || window.getEffectiveUser();
        if (!resolvedUser) return null;
        if (resolvedUser.role) return resolvedUser.role;
        if (resolvedUser.title) return getUserRole(resolvedUser);
        if (resolvedUser.email) return getUserRole(resolvedUser.email);
        return getUserRole(resolvedUser);
      };

      // Helper: ensure Firebase Auth is available for Firestore rules
      async function ensureFirebaseAuthSession(user, userCode) {
        const currentFirebaseUser = window.firebaseAuth ? window.firebaseAuth.getCurrentUser() : null;
        if (currentFirebaseUser) {

          return { success: true, user: currentFirebaseUser, method: 'existing' };
        }

        const email = user?.email || null;
        const password = userCode || user?.userCode || '';
        const authPassword = password.length < 6 ? password.padStart(6, '0') : password;

        // Firebase Auth requires passwords >= 6 chars
        if (!email) {

          const anonResult = await window.firebaseAuth.signInAnonymously();

          return { ...anonResult, method: 'anonymous' };
        }

        // Try sign-in
        const signInResult = await window.firebaseAuth.signIn(email, authPassword);

        if (signInResult.success) {
          return { ...signInResult, method: 'password' };
        }

        // If sign-in failed due to wrong password (email exists), try anonymous auth
        if (signInResult.error && (signInResult.error.includes('wrong-password') || signInResult.error.includes('invalid-credential'))) {

          const anonResult = await window.firebaseAuth.signInAnonymously();

          if (anonResult.success) {
            return { ...anonResult, method: 'anonymous-fallback' };
          }
          // If anonymous also fails, log warning but continue - custom auth will still work

          // Return failure but don't throw - let the app continue with custom auth
          return { success: false, error: 'Firebase Auth unavailable', method: 'failed' };
        }

        // Try create + sign-in if needed (only if email doesn't exist)
        try {
          const auth = getAuth();
          await createUserWithEmailAndPassword(auth, email, authPassword);

          const retryResult = await window.firebaseAuth.signIn(email, authPassword);
          return { ...retryResult, method: 'created' };
        } catch (createError) {
          // If email already exists, try anonymous auth
          if (createError.code === 'auth/email-already-in-use' || createError.message?.includes('email-already-in-use')) {

            const anonResult = await window.firebaseAuth.signInAnonymously();

            if (anonResult.success) {
              return { ...anonResult, method: 'anonymous-fallback' };
            }
            // If anonymous also fails, log warning but continue

            return { success: false, error: 'Firebase Auth unavailable - email exists with different password', method: 'failed' };
          }
          // For other errors, also try anonymous

          const anonResult = await window.firebaseAuth.signInAnonymously();

          if (anonResult.success) {
            return { ...anonResult, method: 'anonymous-fallback' };
          }
          // If all fails, return failure but don't throw

          return { success: false, error: 'Firebase Auth unavailable', method: 'failed' };
        }
      }

      // Helper function to ensure currentPaymentProcessing session is always available
      // This function will restore from localStorage if needed
      window.ensurePaymentProcessingSession = function(context = 'unknown') {

        // If session exists, verify it's valid
        if (window.currentPaymentProcessing) {

          // Double-check: if session exists but has no entries and no drawer, it might be invalid
          if (!window.currentPaymentProcessing.entries && !window.currentPaymentProcessing.drawer && !window.currentPaymentProcessing.id) {

            window.currentPaymentProcessing = null;
          } else {
            // Session is valid, verify it's also in localStorage

            try {
              const sessionJson = JSON.stringify(window.currentPaymentProcessing);
              localStorage.setItem('currentPaymentProcessingSession', sessionJson);

            } catch (e) {

            }

            return window.currentPaymentProcessing;
          }
        }

        // Session doesn't exist or was invalid, try to restore from localStorage

        const savedSession = localStorage.getItem('currentPaymentProcessingSession');

        if (!savedSession) {

          return null;
        }

        try {
          const parsed = JSON.parse(savedSession);

          // Don't restore if already submitted
          if (parsed.submittedAt) {

            localStorage.removeItem('currentPaymentProcessingSession');

            return null;
          }

          // Restore the session
          window.currentPaymentProcessing = parsed;

          return window.currentPaymentProcessing;

        } catch (e) {

          localStorage.removeItem('currentPaymentProcessingSession');

          return null;
        }
      };

      // Clear current payment processing session across the app (and other tabs)
      window.clearPaymentProcessingSession = function(source = 'unknown') {

        window.currentPaymentProcessing = null;

        try {
          localStorage.removeItem('currentPaymentProcessingSession');
          localStorage.removeItem('currentPaymentProcessing');
          const resetStamp = new Date().toISOString();
          localStorage.setItem('paymentProcessingResetAt', resetStamp);

        } catch (e) {

        }

        if (typeof renderPaymentProcessingPreview === 'function') {

          renderPaymentProcessingPreview();
        } else {

        }

      };

      // Listen for reset events from other tabs/sessions
      window.addEventListener('storage', function(event) {
        if (!event) return;
        if (event.key === 'paymentProcessingResetAt') {

          window.clearPaymentProcessingSession('storage-event');
        }
        if (event.key === 'currentPaymentProcessingSession' && event.newValue === null) {

          window.clearPaymentProcessingSession('storage-session-removed');
        }
      });

      // Check if user has admin role
      function isAdmin(user) {
        const role = window.getEffectiveRole ? window.getEffectiveRole(user) : null;
        return role === 'admin';
      }

      // Check if user has helpdesk role
      function isHelpDesk(user) {
        const role = window.getEffectiveRole ? window.getEffectiveRole(user) : null;
        return role === 'helpdesk';
      }

      // Check if user has POS role
      function isPOS(user) {
        const role = window.getEffectiveRole ? window.getEffectiveRole(user) : null;
        return role === 'pos';
      }

      // Check if user has supervisor role
      function isSupervisor(user) {
        const role = window.getEffectiveRole ? window.getEffectiveRole(user) : null;
        return role === 'supervisor';
      }

      // Check if user is authorized (admin, helpdesk, pos, or supervisor)
      function isAuthorized(user) {
        return isAdmin(user) || isHelpDesk(user) || isPOS(user) || isSupervisor(user);
      }

      // Expose isAuthorized globally for data-loading guards
      window.isAuthorized = isAuthorized;

      // Update dashboard title based on user role
      function updateDashboardTitle(user) {

        const dashboardTitle = document.querySelector('#dashboardScreen h1');
        const dashboardSubtitle = document.querySelector('#dashboardScreen p');

        if (!dashboardTitle || !dashboardSubtitle) {

          return;
        }

        const userRole = window.getEffectiveRole ? window.getEffectiveRole(user) : null;

        if (userRole === 'pos') {
          dashboardTitle.textContent = 'Payments';
          // Get username from authenticated user or Firebase
          let username = '';
          const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
          if (effectiveUser?.fullName) {
            username = effectiveUser.fullName;

          } else if (effectiveUser?.email) {
            username = effectiveUser.email.replace('@alcowater.com', '');

          }
          dashboardSubtitle.textContent = 'Point of Sale - Process payments and manage transactions';
          if (username) {
            const loggedInText = document.createElement('p');
            loggedInText.className = 'text-sm text-slate-500 dark:text-slate-400 mt-1';
            loggedInText.textContent = `Logged in as: ${username}`;
            if (dashboardSubtitle.nextSibling && dashboardSubtitle.nextSibling.nodeType === 1 && dashboardSubtitle.nextSibling.classList && dashboardSubtitle.nextSibling.classList.contains('text-sm')) {
              dashboardSubtitle.nextSibling.remove();
            }
            dashboardSubtitle.parentElement.insertBefore(loggedInText, dashboardSubtitle.nextSibling);
          }
        } else if (userRole === 'supervisor') {
          dashboardTitle.textContent = 'Supervisor Dashboard';
          dashboardSubtitle.textContent = 'Supervisor - Manage drawer counts and verify transactions';
          
          // Add "Logged In As" text for supervisor
          let username = '';
          const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
          if (effectiveUser?.fullName) {
            username = effectiveUser.fullName;
          } else if (effectiveUser?.email) {
            username = effectiveUser.email.replace('@alcowater.com', '');
          }
          
          if (username) {
            const loggedInText = document.createElement('p');
            loggedInText.className = 'text-sm text-slate-500 dark:text-slate-400 mt-1';
            loggedInText.textContent = `Logged in as: ${username}`;
            // Remove existing logged in text if it exists
            if (dashboardSubtitle.nextSibling && dashboardSubtitle.nextSibling.nodeType === 1 && dashboardSubtitle.nextSibling.classList && dashboardSubtitle.nextSibling.classList.contains('text-sm')) {
              dashboardSubtitle.nextSibling.remove();
            }
            dashboardSubtitle.parentElement.insertBefore(loggedInText, dashboardSubtitle.nextSibling);
          }
        } else if (userRole === 'admin' || userRole === 'helpdesk') {
          dashboardTitle.textContent = 'Admin Dashboard';
          dashboardSubtitle.textContent = 'Manage customer accounts and billing';
        } else {
          dashboardTitle.textContent = 'Admin Dashboard';
          dashboardSubtitle.textContent = 'Manage customer accounts and billing';
        }
      }

      // Update button visibility based on user role
      window.updateButtonVisibility = async function updateButtonVisibility(user) {

        const addClientBtn = document.getElementById('addClientButton');
        const makePaymentBtn = document.getElementById('makePaymentButton');
        const sendBillBtn = document.getElementById('sendBillButton');
        const searchDatabaseBtn = document.getElementById('searchDatabaseButton');
        const settingsBtn = document.getElementById('settingsButton');
        const logoutBtn = document.getElementById('logoutButton');
        let closeOutDrawerBtn = document.getElementById('closeOutDrawerButton');

        // Create Close Out Drawer button if it doesn't exist
        if (!closeOutDrawerBtn && (makePaymentBtn || searchDatabaseBtn || logoutBtn)) {
          // Find a container to add the button to (use the same container as other buttons)
          const buttonContainer = makePaymentBtn?.parentElement || searchDatabaseBtn?.parentElement || logoutBtn?.parentElement;
          if (buttonContainer) {
            // Get the classes from an existing button to match styling
            const referenceBtn = makePaymentBtn || searchDatabaseBtn || logoutBtn;
            const baseClasses = referenceBtn ? referenceBtn.className.split(' ').filter(c => !c.includes('bg-') && !c.includes('hover:bg-')).join(' ') : '';

            closeOutDrawerBtn = document.createElement('button');
            closeOutDrawerBtn.id = 'closeOutDrawerButton';
            // Use w-full to make it full width like other buttons, and match the styling
            closeOutDrawerBtn.className = 'w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200';
            closeOutDrawerBtn.innerHTML = `
              <div class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span>Close Out Drawer</span>
              </div>
            `;
            closeOutDrawerBtn.onclick = () => {

              // CRITICAL: Use helper function to ensure session is available - call it multiple times for safety
              let session = window.ensurePaymentProcessingSession('closeOutDrawer-step1');

              // Double-check immediately after
              if (!session) {

                session = window.ensurePaymentProcessingSession('closeOutDrawer-step2');
              }

              // Triple-check with direct localStorage access
              if (!session) {

                try {
                  const savedSession = localStorage.getItem('currentPaymentProcessingSession');
                  if (savedSession) {
                    const parsed = JSON.parse(savedSession);
                    if (!parsed.submittedAt) {
                      window.currentPaymentProcessing = parsed;
                      session = parsed;

                    }
                  }
                } catch (e) {

                }
              }

              // Final check before showing alert
              if (!session || !window.currentPaymentProcessing) {

                const savedSession = localStorage.getItem('currentPaymentProcessingSession');

                if (savedSession) {
                  try {
                    const parsed = JSON.parse(savedSession);

                  } catch (e) {

                  }
                }

                alert('No active payment processing session. Please start a payment session first.');
                return;
              }

              // Ensure window object has the session
              if (window.currentPaymentProcessing !== session) {

                window.currentPaymentProcessing = session;
              }

              // Final verification before proceeding

              showClosingRegisterCount();

            };
            // Insert before logout button if it exists, otherwise append
            if (logoutBtn && logoutBtn.parentElement) {
              logoutBtn.parentElement.insertBefore(closeOutDrawerBtn, logoutBtn);
            } else if (buttonContainer) {
              buttonContainer.appendChild(closeOutDrawerBtn);
            }
          }
        }

        if (!user) {

          // Hide all buttons if no user
          [addClientBtn, makePaymentBtn, sendBillBtn, searchDatabaseBtn, settingsBtn, logoutBtn, closeOutDrawerBtn].forEach(btn => {
            if (btn) btn.classList.add('hidden');
          });
          return;
        }

        const userRole = window.getEffectiveRole ? window.getEffectiveRole(user) : null;

        // Reset all buttons to hidden first

        const drawerCountBtn = document.getElementById('drawerCountButton');
        const endOfDayDrawerCountBtn = document.getElementById('endOfDayDrawerCountButton');
        const businessEndOfDayBtn = document.getElementById('businessEndOfDayButton');
        [addClientBtn, makePaymentBtn, sendBillBtn, searchDatabaseBtn, settingsBtn, logoutBtn, drawerCountBtn, endOfDayDrawerCountBtn, businessEndOfDayBtn, closeOutDrawerBtn].forEach(btn => {
          if (btn) {
            btn.classList.add('hidden');

          }
        });

        // Show buttons based on role

        if (userRole === 'pos') {
          // Check if "POS Doesn't Close Out" toggle is enabled
          let hideCloseOutButton = false;
          try {
            const togglesSettings = await loadTogglesSettings();
            hideCloseOutButton = togglesSettings && togglesSettings.posDoesntCloseOut === true;
          } catch (error) {

          }

          // POS users: Make Payment, Search Database, Close Out Drawer (if not hidden), Log Out
          if (makePaymentBtn) makePaymentBtn.classList.remove('hidden');
          if (searchDatabaseBtn) searchDatabaseBtn.classList.remove('hidden');
          if (closeOutDrawerBtn) {
            if (hideCloseOutButton) {
              closeOutDrawerBtn.classList.add('hidden');
            } else {
              closeOutDrawerBtn.classList.remove('hidden');
            }
          }
          if (logoutBtn) logoutBtn.classList.remove('hidden');
        } else if (userRole === 'supervisor') {
          // Supervisor users: Send Bill, Search Clients, Start Of Day Drawer Count, End Of Day Drawer Count, Business End Of Day, Logout
          if (sendBillBtn) sendBillBtn.classList.remove('hidden');
          if (searchDatabaseBtn) searchDatabaseBtn.classList.remove('hidden');
          const drawerCountBtn = document.getElementById('drawerCountButton');
          if (drawerCountBtn) drawerCountBtn.classList.remove('hidden');

          // Create End Of Day Drawer Count button if it doesn't exist
          let endOfDayDrawerCountBtn = document.getElementById('endOfDayDrawerCountButton');
          if (!endOfDayDrawerCountBtn && (drawerCountBtn || settingsBtn || logoutBtn)) {
            const buttonContainer = drawerCountBtn?.parentElement || settingsBtn?.parentElement || logoutBtn?.parentElement;
            if (buttonContainer) {
              endOfDayDrawerCountBtn = document.createElement('button');
              endOfDayDrawerCountBtn.id = 'endOfDayDrawerCountButton';
              endOfDayDrawerCountBtn.className = 'w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200';
              endOfDayDrawerCountBtn.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <span>End Of Day Drawer Count</span>
                </div>
              `;
              endOfDayDrawerCountBtn.onclick = () => showEndOfDayDrawerCountSelection();
              // Insert before settings button if it exists, otherwise append
              if (settingsBtn && settingsBtn.parentElement) {
                settingsBtn.parentElement.insertBefore(endOfDayDrawerCountBtn, settingsBtn);
              } else if (buttonContainer) {
                buttonContainer.appendChild(endOfDayDrawerCountBtn);
              }
            }
          }

          if (endOfDayDrawerCountBtn) endOfDayDrawerCountBtn.classList.remove('hidden');

          // Create Business End Of Day button if it doesn't exist
          let businessEndOfDayBtn = document.getElementById('businessEndOfDayButton');
          if (!businessEndOfDayBtn && (endOfDayDrawerCountBtn || settingsBtn || logoutBtn)) {
            const buttonContainer = endOfDayDrawerCountBtn?.parentElement || settingsBtn?.parentElement || logoutBtn?.parentElement;
            if (buttonContainer) {
              businessEndOfDayBtn = document.createElement('button');
              businessEndOfDayBtn.id = 'businessEndOfDayButton';
              businessEndOfDayBtn.className = 'w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200';
              businessEndOfDayBtn.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18"/>
                  </svg>
                  <span>Business End Of Day</span>
                </div>
              `;
              businessEndOfDayBtn.onclick = () => showBusinessEndOfDaySummary();
              if (endOfDayDrawerCountBtn && endOfDayDrawerCountBtn.parentElement) {
                endOfDayDrawerCountBtn.parentElement.insertBefore(businessEndOfDayBtn, endOfDayDrawerCountBtn.nextSibling);
              } else if (settingsBtn && settingsBtn.parentElement) {
                settingsBtn.parentElement.insertBefore(businessEndOfDayBtn, settingsBtn);
              } else if (buttonContainer) {
                buttonContainer.appendChild(businessEndOfDayBtn);
              }
            }
          }

          if (businessEndOfDayBtn) businessEndOfDayBtn.classList.remove('hidden');
          if (logoutBtn) logoutBtn.classList.remove('hidden');
        } else if (userRole === 'admin' || userRole === 'helpdesk') {

          // Admin and Help Desk users: All buttons (default behavior)
          if (addClientBtn) {
            addClientBtn.classList.remove('hidden');

          }
          if (makePaymentBtn) {
            makePaymentBtn.classList.remove('hidden');

          }
          if (sendBillBtn) {
            sendBillBtn.classList.remove('hidden');

          }
          if (searchDatabaseBtn) {
            searchDatabaseBtn.classList.remove('hidden');

          }
          if (settingsBtn) {
            settingsBtn.classList.remove('hidden');

          }

          // Show logout button and position it above Settings button
          if (logoutBtn) {
            logoutBtn.classList.remove('hidden');
            // Position logout button above Settings button if they're in the same container
            if (settingsBtn && settingsBtn.parentElement && logoutBtn.parentElement === settingsBtn.parentElement) {
              settingsBtn.parentElement.insertBefore(logoutBtn, settingsBtn);
            } else if (settingsBtn && settingsBtn.parentElement) {
              // If logout button is in a different container, move it
              settingsBtn.parentElement.insertBefore(logoutBtn, settingsBtn);
            }
          }
        }
      }

      const currentUser = await window.firebaseAuth.waitForAuth();

      // Function to show Firebase Auth modal
      function showFirebaseAuthModal() {
        const modal = document.getElementById('firebaseAuthModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.getElementById('firebaseEmail').focus();
        }
      }

      // Function to hide Firebase Auth modal
      function hideFirebaseAuthModal() {
        const modal = document.getElementById('firebaseAuthModal');
        if (modal) {
          modal.classList.add('hidden');
        }
      }

      // Make it globally accessible
      window.hideFirebaseAuthModal = hideFirebaseAuthModal;

      // Function to verify authorized user and log out if not authorized
      async function verifyAdminAndLoad() {

        // Try to get authenticated user from new system first
        let user = null;
        let userRole = null;

        // Check localStorage for authenticated user
        try {
          const storedUser = localStorage.getItem('authenticatedUser');
          if (storedUser) {
            window.authenticatedUser = JSON.parse(storedUser);

          }
        } catch (e) {

        }

        // Use authenticated user if available
        if (window.authenticatedUser) {
          user = window.authenticatedUser;
          userRole = window.getEffectiveRole ? window.getEffectiveRole(user) : null;

          // Also ensure Firebase Auth is signed in for Firestore rules
          const firebaseAuthResult = await ensureFirebaseAuthSession(user, window.authenticatedUser.userCode || '');
          if (!firebaseAuthResult.success) {

            // Show warning to user if Firebase Auth completely failed
            if (firebaseAuthResult.error && firebaseAuthResult.error.includes('admin-restricted-operation')) {

            } else if (firebaseAuthResult.error && firebaseAuthResult.error.includes('email exists')) {

            }
            // Continue anyway - custom auth still works, but Firestore may deny access
          }
        } else {
          // Fallback to Firebase Auth (legacy)

          const firebaseUser = window.firebaseAuth.getCurrentUser();
          if (firebaseUser) {
            user = firebaseUser;
            const userEmail = user.email ? user.email.toLowerCase() : '';
            userRole = getEffectiveRole(userEmail);

          }
        }

        if (!user) {

          showFirebaseAuthModal();
          return false;
        }

        // Check after hours restriction for POS users (even if already authenticated)

        if (userRole === 'pos') {

          try {
            const togglesSettings = await loadTogglesSettings();

            if (togglesSettings && togglesSettings.afterHoursLogoutEnabled) {

              const now = new Date();

              const currentTime = now.getHours() * 60 + now.getMinutes();

              const startTime = togglesSettings.afterHoursStartTime || '00:00';
              const endTime = togglesSettings.afterHoursEndTime || '23:59';

              const startTimeParts = startTime.split(':');
              const endTimeParts = endTime.split(':');

              if (startTimeParts.length < 2 || endTimeParts.length < 2) {

              }

              const startHours = parseInt(startTimeParts[0], 10);
              const startMinutes = parseInt(startTimeParts[1] || '0', 10);
              const endHours = parseInt(endTimeParts[0], 10);
              const endMinutes = parseInt(endTimeParts[1] || '0', 10);

              if (isNaN(startHours) || isNaN(startMinutes) || isNaN(endHours) || isNaN(endMinutes)) {

              }

              const startMinutesTotal = startHours * 60 + startMinutes;
              const endMinutesTotal = endHours * 60 + endMinutes;

              let isRestricted = false;
              if (startMinutesTotal <= endMinutesTotal) {

                isRestricted = currentTime >= startMinutesTotal && currentTime < endMinutesTotal;

              } else {

                isRestricted = currentTime >= startMinutesTotal || currentTime < endMinutesTotal;

              }

              if (isRestricted) {

          // Sign out and clear auth
          await window.firebaseAuth.signOut();
          if (window.auth && window.auth.clearAuthentication) {
            window.auth.clearAuthentication();
          }
                alert(`Login is not allowed during after hours (${startTime} - ${endTime}). Please try again during allowed hours.`);
                // Reload the page to show login screen
                window.location.reload();
          return false;
              } else {

              }
            } else {

            }
          } catch (error) {

            // On error, allow access (fail open for safety)
          }
        } else {

        }

        // Check if user is authorized (admin, helpdesk, pos, or supervisor)

        const isAuth = isAuthorized(user);

        if (!isAuth) {

          // Clear authenticated user
          window.authenticatedUser = null;
          localStorage.removeItem('authenticatedUser');

          // Sign out Firebase Auth (if used)
          try {
            await window.firebaseAuth.signOut();
          } catch (e) {

          }

          if (window.auth && window.auth.clearAuthentication) {
            window.auth.clearAuthentication();
          }

          alert('Access denied. Only authorized users can access this system.');
          // Reload the page to show login screen
          window.location.reload();
          return false;
        }

        // Update button visibility based on user role
        await updateButtonVisibility(user);

        // Update dashboard title based on user role
        updateDashboardTitle(user);

        // Show drawer selection modal for POS users
        if (isPOS(user)) {
          // Ensure drawers are loaded before showing modal
          if (drawers.length === 0) {
            await loadDrawersFromFirestore();
          }
          showDrawerSelectionModal();
        } else {
        hideFirebaseAuthModal();
        }

        return true;
      }

      // Set up Firebase Auth form handler
      const firebaseAuthForm = document.getElementById('firebaseAuthForm');
      if (firebaseAuthForm) {

        firebaseAuthForm.addEventListener('submit', async function(e) {

          e.preventDefault();

          const username = document.getElementById('firebaseEmail').value.trim();
          const userCode = document.getElementById('firebasePassword').value.trim();
          const errorDiv = document.getElementById('firebaseAuthError');
          const submitBtn = document.getElementById('firebaseAuthSubmit');

          errorDiv.classList.add('hidden');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Signing in...';

          try {
            // Ensure users are loaded

            if (users.length === 0) {

              await loadUsersFromFirestore();

              // If still empty after loading, show helpful error
              if (users.length === 0) {

                errorDiv.textContent = 'No users found in system. Please contact administrator.';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign In';
                return;
              }
            }

            // Find user by fullName (case-insensitive) and userCode

            const foundUser = users.find(u => {
              const nameMatch = (u.fullName || '').toLowerCase().trim() === username.toLowerCase().trim();
              const codeMatch = (u.userCode || '').toString().trim() === userCode.trim();

              return nameMatch && codeMatch;
            });

            if (!foundUser) {

              errorDiv.textContent = 'Invalid username or password';
              errorDiv.classList.remove('hidden');
              submitBtn.disabled = false;
              submitBtn.textContent = 'Sign In';
              return;
            }

            // Get user role from title
            const userRole = getUserRole(foundUser);

            if (!userRole) {

              errorDiv.textContent = 'User role not recognized. Please contact administrator.';
              errorDiv.classList.remove('hidden');
              submitBtn.disabled = false;
              submitBtn.textContent = 'Sign In';
              return;
            }

            // Check after hours restriction for POS users
            if (userRole === 'pos') {

              const togglesSettings = await loadTogglesSettings();

              if (togglesSettings && togglesSettings.afterHoursLogoutEnabled) {
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const startTime = togglesSettings.afterHoursStartTime || '00:00';
                const endTime = togglesSettings.afterHoursEndTime || '23:59';

                const startTimeParts = startTime.split(':');
                const endTimeParts = endTime.split(':');

                if (startTimeParts.length < 2 || endTimeParts.length < 2) {

                } else {
                  const startHours = parseInt(startTimeParts[0], 10);
                  const startMinutes = parseInt(startTimeParts[1] || '0', 10);
                  const endHours = parseInt(endTimeParts[0], 10);
                  const endMinutes = parseInt(endTimeParts[1] || '0', 10);

                  if (isNaN(startHours) || isNaN(startMinutes) || isNaN(endHours) || isNaN(endMinutes)) {

                  } else {
                    const startMinutesTotal = startHours * 60 + startMinutes;
                    const endMinutesTotal = endHours * 60 + endMinutes;

                    let isRestricted = false;
                    if (startMinutesTotal <= endMinutesTotal) {
                      isRestricted = currentTime >= startMinutesTotal && currentTime < endMinutesTotal;
                    } else {
                      isRestricted = currentTime >= startMinutesTotal || currentTime < endMinutesTotal;
                    }

                    if (isRestricted) {

                      errorDiv.textContent = `Login is not allowed during after hours (${startTime} - ${endTime}). Please try again during allowed hours.`;
                      errorDiv.classList.remove('hidden');
                      submitBtn.disabled = false;
                      submitBtn.textContent = 'Sign In';
                      return;
                    }
                  }
                }
              }
            }

            // Store authenticated user

            const firebaseEmail = `${foundUser.fullName.toLowerCase().replace(/\s+/g, '')}@alcowater.com`;
            window.authenticatedUser = {
              ...foundUser,
              role: userRole,
              email: firebaseEmail
            };

            // Store in localStorage for persistence
            try {
              localStorage.setItem('authenticatedUser', JSON.stringify(window.authenticatedUser));

            } catch (e) {

            }

            // Ensure Firebase Auth session exists for Firestore rules

            await ensureFirebaseAuthSession(window.authenticatedUser, userCode);

            // Verify authorized user after sign in
            const authResult = await verifyAdminAndLoad();

            if (authResult) {

                // Reload page to initialize with authenticated user
                window.location.reload();
            } else {

              errorDiv.textContent = 'Access denied. Only authorized users can access this system.';
              errorDiv.classList.remove('hidden');
              submitBtn.disabled = false;
              submitBtn.textContent = 'Sign In';
            }
          } catch (error) {

            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign In';
          }
        });

      } else {

      }

      // Check authentication status

      // Load users FIRST (before auth check) so login can work
      // This might fail due to permissions, but we'll try

      try {
        await loadUsersFromFirestore();

      } catch (e) {

        // Continue - users will be loaded after auth if needed
      }

      // Try to restore authenticated user from localStorage
      try {
        const storedUser = localStorage.getItem('authenticatedUser');
        if (storedUser) {
          window.authenticatedUser = JSON.parse(storedUser);

        } else {

        }
      } catch (e) {

      }

      const authResult = await verifyAdminAndLoad();

      if (!authResult) {

        // Don't load data if not authenticated
        return;
      }

      const buttonContainerBefore = document.querySelector('.flex.flex-col.items-center.gap-4.mb-8.p-8.max-w-2xl.mx-auto.bg-white');

      // Ensure Firebase Auth session before data load
      const initUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
      const initRole = window.getEffectiveRole ? window.getEffectiveRole(initUser) : null;

      const firebaseUserBefore = window.firebaseAuth ? window.firebaseAuth.getCurrentUser() : null;

      try {
        await ensureFirebaseAuthSession(initUser, window.authenticatedUser?.userCode || '');
        const firebaseUserAfter = window.firebaseAuth ? window.firebaseAuth.getCurrentUser() : null;

      } catch (e) {

      }

      // CRITICAL: Load codes FIRST before customers!
      // This ensures that when populateCustomerCodesFromImportData() runs during customer load,
      // it will find existing codes in the array instead of creating new ones with default values

      await loadCodesFromFirestore();

      await loadSewerChargeFromFirestore();
      await loadLateFeeFromFirestore();
      await loadPucSurchargeFromFirestore();
      await loadHierarchyOrder();

      // Now load other data

      await loadLocationsFromFirestore();

      await loadCustomersFromFirestore();

      await loadUsersFromFirestore();

      await loadDrawersFromFirestore();

      await loadPaymentProcessingSessionsFromFirestore();

      await loadTogglesSettings();

      const buttonContainerAfter = document.querySelector('.flex.flex-col.items-center.gap-4.mb-8.p-8.max-w-2xl.mx-auto.bg-white');

      // Check if drawer count module is visible - if so, don't show buttons
      const drawerCountModule = document.getElementById('drawerCountModule');
      const isDrawerCountVisible = drawerCountModule && !drawerCountModule.classList.contains('hidden');
      
      // Ensure buttons are visible after data load (but not if drawer count is showing)
      if (!isDrawerCountVisible && buttonContainerAfter && buttonContainerAfter.classList.contains('hidden')) {
        console.log('[verifyAdminAndLoad] Button container is hidden and drawer count is not visible, showing buttons');
        showDashboardButtons();
      } else if (isDrawerCountVisible) {
        console.log('[verifyAdminAndLoad] Drawer count module is visible, NOT showing buttons');
      } else if (!buttonContainerAfter) {
        console.log('[verifyAdminAndLoad] Button container not found');
      } else {
        console.log('[verifyAdminAndLoad] Button container is already visible');
      }
      // Update customer payment statuses based on past due amounts
      updateAllCustomerPaymentStatuses();
      // Reset bills if it's the first of the month
      resetMonthlyBills();
      // Update location statuses based on customers
      updateLocationStatuses();
      // Update stats after data is loaded

      updateStats();
    });

    // Switch between accounts and locations views
    window.switchView = function(view) {
      currentView = view;
      const accountsTab = document.getElementById('accountsTab');
      const locationsTab = document.getElementById('locationsTab');
      const accountsContent = document.getElementById('accountsContent');
      const locationsContent = document.getElementById('locationsContent');

      if (view === 'accounts') {
        accountsTab.classList.add('bg-blue-600', 'text-white');
        accountsTab.classList.remove('bg-slate-200', 'text-slate-700');
        locationsTab.classList.add('bg-slate-200', 'text-slate-700');
        locationsTab.classList.remove('bg-blue-600', 'text-white');
        accountsContent.classList.remove('hidden');
        locationsContent.classList.add('hidden');

        // Refresh customer codes from the global codes array to ensure latest amounts are used
        // This ensures that when showAmountDetails is called, it will have the latest code data
        customers.forEach(customer => {
          if (customer.codes && customer.codes.length > 0) {
            customer.codes = customer.codes.map(customerCode => {
              // Look up the latest code data from the global codes array
              let latestCode = codes.find(c => c.id === customerCode.id);
              if (!latestCode) {
                latestCode = codes.find(c => c.name.toLowerCase() === customerCode.name.toLowerCase());
              }
              // Use the latest code data if found, otherwise keep the customer code data
              if (latestCode) {
                return {
                  id: latestCode.id,
                  name: latestCode.name,
                  type: latestCode.type || 'percentage',
                  amount: latestCode.amount !== undefined ? latestCode.amount : (latestCode.percentage !== undefined ? latestCode.percentage : 0),
                  percentage: latestCode.type === 'percentage' && latestCode.amount !== undefined ? latestCode.amount : (latestCode.percentage !== undefined ? latestCode.percentage : 0)
                };
              }
              return customerCode;
            });
          }
        });
      } else {
        locationsTab.classList.add('bg-blue-600', 'text-white');
        locationsTab.classList.remove('bg-slate-200', 'text-slate-700');
        accountsTab.classList.add('bg-slate-200', 'text-slate-700');
        accountsTab.classList.remove('bg-blue-600', 'text-white');
        locationsContent.classList.remove('hidden');
        accountsContent.classList.add('hidden');
      }
      updateDashboard();
    };

    // Switch between settings accounts, locations, and codes views
    window.switchSettingsView = function(view) {
      const accountsTab = document.getElementById('settingsAccountsTab');
      const locationsTab = document.getElementById('settingsLocationsTab');
      const codesTab = document.getElementById('settingsCodesTab');
      const usersTab = document.getElementById('settingsUsersTab');
      const cleanupTab = document.getElementById('settingsCleanupTab');
      const hierarchyTab = document.getElementById('settingsHierarchyTab');
      const drawersTab = document.getElementById('settingsDrawersTab');
      const togglesTab = document.getElementById('settingsTogglesTab');
      const accountsContent = document.getElementById('settingsAccountsContent');
      const locationsContent = document.getElementById('settingsLocationsContent');
      const codesContent = document.getElementById('settingsCodesContent');
      const usersContent = document.getElementById('settingsUsersContent');
      const cleanupContent = document.getElementById('settingsCleanupContent');
      const hierarchyContent = document.getElementById('settingsHierarchyContent');
      const drawersContent = document.getElementById('settingsDrawersContent');
      const togglesContent = document.getElementById('settingsTogglesContent');

      // Reset all tabs and content
      [accountsTab, locationsTab, codesTab, usersTab, cleanupTab, hierarchyTab, drawersTab, togglesTab].forEach(tab => {
        if (!tab) return;
        tab.classList.remove('bg-blue-600', 'text-white');
        tab.classList.add('bg-slate-200', 'text-slate-700');
      });
      accountsContent.classList.add('hidden');
      locationsContent.classList.add('hidden');
      codesContent.classList.add('hidden');
      usersContent.classList.add('hidden');
      if (cleanupContent) cleanupContent.classList.add('hidden');
      if (hierarchyContent) hierarchyContent.classList.add('hidden');
      if (drawersContent) drawersContent.classList.add('hidden');
      if (togglesContent) togglesContent.classList.add('hidden');

      if (view === 'accounts') {
        accountsTab.classList.add('bg-blue-600', 'text-white');
        accountsTab.classList.remove('bg-slate-200', 'text-slate-700');
        accountsContent.classList.remove('hidden');
        updateSettingsCustomerTable();
      } else if (view === 'locations') {
        locationsTab.classList.add('bg-blue-600', 'text-white');
        locationsTab.classList.remove('bg-slate-200', 'text-slate-700');
        locationsContent.classList.remove('hidden');
        updateSettingsLocationsTable();
      } else if (view === 'codes') {
        codesTab.classList.add('bg-blue-600', 'text-white');
        codesTab.classList.remove('bg-slate-200', 'text-slate-700');
        codesContent.classList.remove('hidden');
        updateCodesTable();
        updateSewerChargeDisplay();
        updateLateFeeDisplay();
        updatePucSurchargeDisplay();
        updateLateFeeDisplay();
      } else if (view === 'users') {
        usersTab.classList.add('bg-blue-600', 'text-white');
        usersTab.classList.remove('bg-slate-200', 'text-slate-700');
        usersContent.classList.remove('hidden');
        updateSettingsUsersTable();
      } else if (view === 'cleanup') {
        if (cleanupTab) {
          cleanupTab.classList.add('bg-blue-600', 'text-white');
          cleanupTab.classList.remove('bg-slate-200', 'text-slate-700');
        }
        if (cleanupContent) cleanupContent.classList.remove('hidden');
      } else if (view === 'hierarchy') {
        if (hierarchyTab) {
          hierarchyTab.classList.add('bg-blue-600', 'text-white');
          hierarchyTab.classList.remove('bg-slate-200', 'text-slate-700');
        }
        if (hierarchyContent) {
          hierarchyContent.classList.remove('hidden');
          loadHierarchyOrder();
        }
      } else if (view === 'drawers') {
        if (drawersTab) {
          drawersTab.classList.add('bg-blue-600', 'text-white');
          drawersTab.classList.remove('bg-slate-200', 'text-slate-700');
        }
        if (drawersContent) {
          drawersContent.classList.remove('hidden');
          updateSettingsDrawersTable();
        }
      } else if (view === 'toggles') {
        if (togglesTab) {
          togglesTab.classList.add('bg-blue-600', 'text-white');
          togglesTab.classList.remove('bg-slate-200', 'text-slate-700');
        }
        if (togglesContent) {
          togglesContent.classList.remove('hidden');
          loadTogglesSettings();
        }
      }
    };

    function updateDashboard() {

      const paymentModuleBefore = document.getElementById('paymentModule');

      updateStats();
      updateLocationStatuses(); // Update location statuses based on customers
      if (currentView === 'accounts') {
        updateCustomerTable();
      } else {
        updateLocationsTable();
      }

      const paymentModuleAfter = document.getElementById('paymentModule');

      if ((paymentModuleBefore?.innerHTML?.length || 0) !== (paymentModuleAfter?.innerHTML?.length || 0)) {

      }

    }

    // Update customer payment status based on past due amount
    function updateCustomerPaymentStatus(customer) {
      // Don't change status if it's inactive or pending closing (these are manually set)
      if (customer.paymentStatus === 'inactive' || customer.paymentStatus === 'pending closing') {
        return;
      }

      // Handle negative pastDue (which represents credit/overpayment)
      if (customer.pastDue > 0) {
        customer.paymentStatus = 'overdue';
      } else if (customer.pastDue < 0) {
        // Negative pastDue means they have a credit
        customer.paymentStatus = 'current';
      } else {
        customer.paymentStatus = 'current';
      }
    }

    // Update all customer payment statuses
    function updateAllCustomerPaymentStatuses() {
      customers.forEach(customer => {
        updateCustomerPaymentStatus(customer);
      });
    }

    // Update location statuses based on associated customers
    function updateLocationStatuses() {
      locations.forEach(location => {
        // Check if there's a customer associated with this location
        const associatedCustomer = customers.find(customer => 
          customer.address === location.address || 
          customer.name === location.currentResident
        );

        if (associatedCustomer) {
          // Location has an active customer
          location.status = 'occupied';
          location.currentResident = associatedCustomer.name;
          location.ownerFullName = associatedCustomer.name;
          // Split name into first and last
          const nameParts = associatedCustomer.name.split(' ');
          location.ownerFirstName = nameParts[0] || '';
          location.ownerLastName = nameParts.slice(1).join(' ') || '';
        } else {
          // No customer associated - set to inactive
          location.status = 'inactive';
          location.currentResident = null;
          location.ownerFullName = '';
          location.ownerFirstName = '';
          location.ownerLastName = '';
        }
      });

      // Update filtered locations
      filteredLocations = [...locations];
    }

    function updateStats() {

      const totalCustomers = customers.length;
      const overdueCustomers = customers.filter(c => c.paymentStatus === 'overdue').length;
      const currentCustomers = customers.filter(c => c.paymentStatus === 'current').length;

      // Calculate total revenue from payment history
      let totalRevenue = 0;
      customers.forEach(customer => {
        if (customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0) {
          customer.paymentHistory.forEach(payment => {
            totalRevenue += payment.amountPaid;
          });
        }
      });

      // Only update stats if the elements exist (they were removed from the UI)
      const totalCustomersEl = document.getElementById('totalCustomers');
      const overdueCustomersEl = document.getElementById('overdueCustomers');
      const currentCustomersEl = document.getElementById('currentCustomers');
      const totalRevenueEl = document.getElementById('totalRevenue');

      if (totalCustomersEl) totalCustomersEl.textContent = totalCustomers;
      if (overdueCustomersEl) overdueCustomersEl.textContent = overdueCustomers;
      if (currentCustomersEl) currentCustomersEl.textContent = currentCustomers;
      if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
    }

    function updateCustomerTable() {
      const tbody = document.getElementById('customerTableBody');
      tbody.innerHTML = '';

      // Update the customer count display
      const countDisplay = document.getElementById('customerCountDisplay');
      const totalDisplay = document.getElementById('customerTotalDisplay');
      if (countDisplay) countDisplay.textContent = filteredCustomers.length;
      if (totalDisplay) totalDisplay.textContent = customers.length;

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        // Calculate due date as last day of current month
        const now = window.getCurrentDate();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early (before due date)
        const hasPaidEarly = customer.lastPayment && customer.lastPayment !== 'Never' && 
                            customer.lastPayment.includes('/') && 
                            new Date(customer.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount based on breakdown logic
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due

        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate code surcharges (applied to adjusted service cost after factor, affected by factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            let baseSurcharge;
            if (codeType === 'flat') {
              baseSurcharge = codeAmount;
            } else {
              baseSurcharge = adjustedServiceCost * (codeAmount / 100);
            }
            // Apply factor to tax codes
            totalSurcharge += baseSurcharge * factor;
          });
        }

        // Calculate subtotal: adjusted service cost + tax codes (both affected by factor)
        const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;

        // Calculate PUC Surcharge (applied to subtotal, NOT affected by factor)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = subtotalBeforePuc * (pucSurcharge / 100);
        }

        const totalAmount = hasPaidEarly ? 0 : (subtotalBeforePuc + pastDue + lateFeeAmount + pucSurchargeAmount);

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'accountNumber', '${customer.accountNumber}')" 
                 title="Double-click to edit">
              ${customer.accountNumber}
            </div>
          </td>
          <td class="px-0 py-4 pr-0 -mr-4 whitespace-nowrap text-center max-w-[180px]">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'name', '${customer.name}')" 
                 title="Double-click to edit">
              ${customer.name}
            </div>
            <div class="flex flex-col items-center gap-1 mt-2">
              <button 
                onclick="showCustomerFullInfo('${customer.id}')" 
                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium"
              >
                View Full Info
              </button>
              <button 
                onclick="showCustomerDataProfile('${customer.id}')" 
                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 text-xs font-medium"
              >
                View Data Profile
              </button>
            </div>
          </td>
          <td class="px-0 py-4 pl-0 -ml-4 text-center max-w-[180px]">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'address', '${getCustomerDisplayAddress(customer)}')" 
                 title="Double-click to edit">
              ${(() => {
                const displayAddress = getCustomerDisplayAddress(customer);
                if (typeof displayAddress === 'string' && displayAddress.includes(',')) {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress.split(',')[0].trim()}</div>
                  <div class="text-slate-500 dark:text-slate-400 whitespace-nowrap">${displayAddress.split(',').slice(1).join(',').trim()}</div>`;
                } else {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress}</div>`;
                }
              })()}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editCustomerField('${customer.id}', 'paymentStatus', '${customer.paymentStatus}')" 
                  title="Double-click to edit">
              ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-900 dark:text-slate-100">
            <div class="font-medium">$${totalAmount.toFixed(2)}</div>
            <button onclick="showAmountDetails('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
              View Details
            </button>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600 dark:text-slate-400">
            <div class="flex flex-wrap gap-1 justify-center">
              ${pucSurcharge > 0 ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">PUC SCHG SW (${pucSurcharge.toFixed(2)}%)</span>` : ''}
              ${customer.codes && customer.codes.length > 0 
                ? customer.codes.map(code => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.name}</span>`).join('')
                : (pucSurcharge > 0 ? '' : '<span class="text-slate-400 dark:text-slate-500">—</span>')
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <div class="flex flex-col space-y-2">
              <button onclick="showPaymentModal('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Mark Paid
              </button>
              <button onclick="showPaymentHistory('${customer.id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                View History
              </button>
              <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Logout function
    window.logout = async function() {

      // Clear authenticated user

      window.authenticatedUser = null;
      try {
        localStorage.removeItem('authenticatedUser');

      } catch (e) {

      }

      // Sign out Firebase Auth (if used)

      try {
        await window.firebaseAuth.signOut();

      } catch (error) {

      }

      if (window.auth && window.auth.clearAuthentication) {
        window.auth.clearAuthentication();
      }

      // Reload the page to show login screen
      window.location.reload();
    };

    // Function to hide/show dashboard buttons
    window.hideDashboardButtons = function() {
      console.log('[UI][hideDashboardButtons] ========== FUNCTION CALLED ==========');
      console.trace('[UI][hideDashboardButtons] Stack trace:');
      
      // Try to find button container by class selector
      const buttonContainer = document.querySelector('.flex.flex-col.items-center.gap-4.mb-8.p-8.max-w-2xl.mx-auto.bg-white');
      console.log('[UI][hideDashboardButtons] Button container found by selector:', buttonContainer);
      
      // Also try to find by individual button IDs
      const sendBillBtn = document.getElementById('sendBillButton');
      const searchDatabaseBtn = document.getElementById('searchDatabaseButton');
      const drawerCountBtn = document.getElementById('drawerCountButton');
      const endOfDayDrawerCountBtn = document.getElementById('endOfDayDrawerCountButton');
      const businessEndOfDayBtn = document.getElementById('businessEndOfDayButton');
      const settingsBtn = document.getElementById('settingsButton');
      const logoutBtn = document.getElementById('logoutButton');
      const makePaymentBtn = document.getElementById('makePaymentButton');
      const closeOutDrawerBtn = document.getElementById('closeOutDrawerButton');
      
      console.log('[UI][hideDashboardButtons] Individual buttons found:');
      console.log('  - sendBillBtn:', sendBillBtn);
      console.log('  - searchDatabaseBtn:', searchDatabaseBtn);
      console.log('  - drawerCountBtn:', drawerCountBtn);
      console.log('  - endOfDayDrawerCountBtn:', endOfDayDrawerCountBtn);
      console.log('  - businessEndOfDayBtn:', businessEndOfDayBtn);
      console.log('  - settingsBtn:', settingsBtn);
      console.log('  - logoutBtn:', logoutBtn);
      console.log('  - makePaymentBtn:', makePaymentBtn);
      console.log('  - closeOutDrawerBtn:', closeOutDrawerBtn);

      // Hide individual buttons first (regardless of container)
      const buttonsToHide = [
        sendBillBtn, searchDatabaseBtn, drawerCountBtn, endOfDayDrawerCountBtn,
        businessEndOfDayBtn, settingsBtn, logoutBtn, makePaymentBtn, closeOutDrawerBtn
      ];
      buttonsToHide.forEach((btn, index) => {
        if (btn) {
          const wasVisible = !btn.classList.contains('hidden');
          btn.classList.add('hidden');
          console.log(`[UI][hideDashboardButtons] Button ${index} (${btn.id || 'no-id'}) was visible: ${wasVisible} - Now hidden`);
        }
      });

      if (buttonContainer) {
        const wasVisible = !buttonContainer.classList.contains('hidden');
        buttonContainer.classList.add('hidden');
        console.log('[UI][hideDashboardButtons] Container was visible:', wasVisible, '- Now hidden');
      } else {
        console.log('[UI][hideDashboardButtons] No container found by selector, but individual buttons hidden');
        
        // Also try to find parent container from any button
        const firstButton = buttonsToHide.find(btn => btn);
        if (firstButton && firstButton.parentElement) {
          const parent = firstButton.parentElement;
          console.log('[UI][hideDashboardButtons] Found parent container from button:', parent);
          console.log('[UI][hideDashboardButtons] Parent classes:', parent.className);
          const wasParentVisible = !parent.classList.contains('hidden');
          parent.classList.add('hidden');
          console.log('[UI][hideDashboardButtons] Parent was visible:', wasParentVisible, '- Now hidden');
        }
      }

      console.log('[UI][hideDashboardButtons] ========== FUNCTION COMPLETED ==========');
    };

    window.showDashboardButtons = async function() {
      console.log('[UI][showDashboardButtons] ========== FUNCTION CALLED ==========');
      console.trace('[UI][showDashboardButtons] Stack trace:');
      
      // Get current user to determine which buttons should be visible
      const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
      const userRole = window.getEffectiveRole ? window.getEffectiveRole(effectiveUser) : null;
      console.log('[UI][showDashboardButtons] Current user role:', userRole);
      
      // Try to find button container by class selector
      const buttonContainer = document.querySelector('.flex.flex-col.items-center.gap-4.mb-8.p-8.max-w-2xl.mx-auto.bg-white');
      console.log('[UI][showDashboardButtons] Button container found by selector:', buttonContainer);
      
      // Also try to find by individual button IDs
      const sendBillBtn = document.getElementById('sendBillButton');
      const searchDatabaseBtn = document.getElementById('searchDatabaseButton');
      const drawerCountBtn = document.getElementById('drawerCountButton');
      const endOfDayDrawerCountBtn = document.getElementById('endOfDayDrawerCountButton');
      const businessEndOfDayBtn = document.getElementById('businessEndOfDayButton');
      const settingsBtn = document.getElementById('settingsButton');
      const logoutBtn = document.getElementById('logoutButton');
      const makePaymentBtn = document.getElementById('makePaymentButton');
      const closeOutDrawerBtn = document.getElementById('closeOutDrawerButton');
      
      console.log('[UI][showDashboardButtons] Individual buttons found:');
      console.log('  - sendBillBtn:', sendBillBtn);
      console.log('  - searchDatabaseBtn:', searchDatabaseBtn);
      console.log('  - drawerCountBtn:', drawerCountBtn);
      console.log('  - endOfDayDrawerCountBtn:', endOfDayDrawerCountBtn);
      console.log('  - businessEndOfDayBtn:', businessEndOfDayBtn);
      console.log('  - settingsBtn:', settingsBtn);
      console.log('  - logoutBtn:', logoutBtn);
      console.log('  - makePaymentBtn:', makePaymentBtn);
      console.log('  - closeOutDrawerBtn:', closeOutDrawerBtn);

      // Show container
      if (buttonContainer) {
        const wasHidden = buttonContainer.classList.contains('hidden');
        buttonContainer.classList.remove('hidden');
        console.log('[UI][showDashboardButtons] Container was hidden:', wasHidden, '- Now visible');
      }
      
      // Show individual buttons based on user role
      if (userRole === 'supervisor') {
        console.log('[UI][showDashboardButtons] Showing supervisor buttons...');
        if (sendBillBtn) {
          sendBillBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] sendBillBtn shown');
        }
        if (searchDatabaseBtn) {
          searchDatabaseBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] searchDatabaseBtn shown');
        }
        if (drawerCountBtn) {
          drawerCountBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] drawerCountBtn shown');
        }
        if (endOfDayDrawerCountBtn) {
          endOfDayDrawerCountBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] endOfDayDrawerCountBtn shown');
        }
        if (businessEndOfDayBtn) {
          businessEndOfDayBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] businessEndOfDayBtn shown');
        }
        if (logoutBtn) {
          logoutBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] logoutBtn shown');
        }
        // Hide buttons that shouldn't be visible for supervisor
        if (makePaymentBtn) makePaymentBtn.classList.add('hidden');
        if (closeOutDrawerBtn) closeOutDrawerBtn.classList.add('hidden');
        if (settingsBtn) settingsBtn.classList.add('hidden');
      } else if (userRole === 'pos') {
        console.log('[UI][showDashboardButtons] Showing POS buttons...');
        if (makePaymentBtn) {
          makePaymentBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] makePaymentBtn shown');
        }
        if (searchDatabaseBtn) {
          searchDatabaseBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] searchDatabaseBtn shown');
        }
        
        // Check if "POS Doesn't Close Out" toggle is enabled
        let hideCloseOutButton = false;
        try {
          const togglesSettings = loadTogglesSettings ? await loadTogglesSettings() : null;
          hideCloseOutButton = togglesSettings && togglesSettings.posDoesntCloseOut === true;
          console.log('[UI][showDashboardButtons] POS Doesn\'t Close Out toggle:', hideCloseOutButton);
        } catch (error) {
          console.error('[UI][showDashboardButtons] Error loading toggles settings:', error);
        }
        
        if (closeOutDrawerBtn) {
          if (hideCloseOutButton) {
            closeOutDrawerBtn.classList.add('hidden');
            console.log('[UI][showDashboardButtons] closeOutDrawerBtn hidden (toggle enabled)');
          } else {
            closeOutDrawerBtn.classList.remove('hidden');
            console.log('[UI][showDashboardButtons] closeOutDrawerBtn shown');
          }
        }
        if (logoutBtn) {
          logoutBtn.classList.remove('hidden');
          console.log('[UI][showDashboardButtons] logoutBtn shown');
        }
        // Hide buttons that shouldn't be visible for POS
        if (sendBillBtn) sendBillBtn.classList.add('hidden');
        if (drawerCountBtn) drawerCountBtn.classList.add('hidden');
        if (endOfDayDrawerCountBtn) endOfDayDrawerCountBtn.classList.add('hidden');
        if (businessEndOfDayBtn) businessEndOfDayBtn.classList.add('hidden');
        if (settingsBtn) settingsBtn.classList.add('hidden');
      } else {
        // Admin/Helpdesk - show all buttons
        console.log('[UI][showDashboardButtons] Showing admin buttons...');
        const allButtons = [sendBillBtn, searchDatabaseBtn, drawerCountBtn, endOfDayDrawerCountBtn,
          businessEndOfDayBtn, settingsBtn, logoutBtn, makePaymentBtn, closeOutDrawerBtn];
        allButtons.forEach((btn) => {
          if (btn) {
            btn.classList.remove('hidden');
            console.log(`[UI][showDashboardButtons] ${btn.id || 'button'} shown`);
          }
        });
      }

      console.log('[UI][showDashboardButtons] ========== FUNCTION COMPLETED ==========');
    };

    // Module Management Functions
    window.showPaymentModule = function() {
      hideAllModules();
      hideDashboardButtons();
      // Reset payment module to original form
      resetPaymentForm();
      const paymentModule = document.getElementById('paymentModule');
      if (paymentModule) {
        paymentModule.classList.remove('hidden');
        paymentModule.style.cssText = '';
      }
    };

    window.showBillModule = function() {
      hideAllModules();
      hideDashboardButtons();
      // Reset bill module to original form
      resetBillForm();
      document.getElementById('billModule').classList.remove('hidden');
    };

    window.showAddClientModule = function() {
      hideAllModules();
      hideDashboardButtons();
      // Reset add client module to original form
      resetAddClientForm();
      // Populate codes dropdown after form is reset
      setTimeout(() => {
        populateAddClientCodeSelect();
        window.selectedClientCodes = [];
        updateClientCodesList();
      }, 100);
      document.getElementById('addClientModule').classList.remove('hidden');
    };

    window.showSearchModule = function() {
      hideAllModules();
      hideDashboardButtons();
      // Clear search results and reset form
      document.getElementById('searchByName').value = '';
      document.getElementById('searchByStatus').value = '';
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('searchModule').classList.remove('hidden');
    };

    window.showSettingsModule = async function() {
      hideAllModules();
      hideDashboardButtons();
      const settingsModule = document.getElementById('settingsModule');
      const loadingOverlay = document.getElementById('settingsLoadingOverlay');

      // Show settings module immediately
      settingsModule.classList.remove('hidden');

      // Ensure payment module is definitely hidden (in case setPaymentProcessingViewState tries to show it)
      const paymentModule = document.getElementById('paymentModule');
      if (paymentModule) {
        paymentModule.classList.add('hidden');
      }

      // Show loading overlay if data might not be ready
      // Check if customers array is empty or if we're still in initial load
      const needsLoading = customers.length === 0;

      if (needsLoading && loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }

      // Wait for data to be loaded if customers array is empty
      // This ensures data is ready before showing the tables
      if (needsLoading) {
        // Data might still be loading, wait a bit and check again
        let attempts = 0;
        const maxAttempts = 50; // 5 seconds max wait (50 * 100ms)

        while (customers.length === 0 && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }

        // If data still hasn't loaded after waiting, try to load it now
        if (customers.length === 0) {

          try {
            await loadCustomersFromFirestore();
            await loadLocationsFromFirestore();
            await loadUsersFromFirestore();
          } catch (error) {

          }
        }
      }

      // Small delay to ensure data is fully processed and UI is ready
      await new Promise(resolve => setTimeout(resolve, 50));

      // Always refresh filteredCustomers from customers array when opening settings
      // This ensures data is up-to-date regardless of when settings is opened
      filteredCustomers = [...customers];

      // Clear search input when opening settings
      const settingsSearch = document.getElementById('settingsCustomerSearch');
      if (settingsSearch) {
        settingsSearch.value = '';
      }

      // Populate the settings tables
      updateSettingsCustomerTable();
      updateSettingsLocationsTable();
      updateSettingsUsersTable();

      // Hide loading overlay once data is ready
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
    };

    window.hideAllModules = function() {
      // Hide main modules
      const paymentModule = document.getElementById('paymentModule');
      const billModule = document.getElementById('billModule');
      const addClientModule = document.getElementById('addClientModule');
      const searchModule = document.getElementById('searchModule');
      const settingsModule = document.getElementById('settingsModule');

      if (paymentModule) {
        paymentModule.classList.add('hidden');
        paymentModule.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
      }
      if (billModule) billModule.classList.add('hidden');
      if (addClientModule) addClientModule.classList.add('hidden');
      if (searchModule) searchModule.classList.add('hidden');
      if (settingsModule) settingsModule.classList.add('hidden');

      // Show dashboard buttons when all modules are hidden
      showDashboardButtons();

      // Hide drawer count module
      const drawerCountModule = document.getElementById('drawerCountModule');
      if (drawerCountModule) drawerCountModule.classList.add('hidden');

      // Also hide all payment processing sections to ensure clean state
      const paymentProcessingSections = [
        'paymentProcessingStartSection',
        'registerCountSection',
        'paymentProcessingEntrySection',
        'paymentProcessingPreviewSection',
        'registerRecountSection',
        'paymentProcessingSessionsListSection'
      ];

      paymentProcessingSections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          section.classList.add('hidden');
          section.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
        }
      });

      // DO NOT clear currentPaymentProcessing when hiding modules
      // The session should persist even when the module is closed
      // This allows the "Close Out Drawer" button to work even when payment module is hidden

      // Restore session from localStorage if it doesn't exist in memory
      if (!window.currentPaymentProcessing) {

        const savedSession = localStorage.getItem('currentPaymentProcessingSession');
        if (savedSession) {
          try {
            const parsed = JSON.parse(savedSession);
            if (!parsed.submittedAt) {
              window.currentPaymentProcessing = parsed;

            } else {

            }
          } catch (e) {

          }
        } else {

        }
      }

      if (window.currentPaymentProcessing) {

      }
    };

    // Payment Module Functions
    window.searchCustomers = function(query) {

      if (!query || query.trim().length === 0) {

        return [];
      }

      // Ensure customers array exists and is loaded

      if (!customers || !Array.isArray(customers) || customers.length === 0) {

        return [];
      }

      const searchTerm = query.toLowerCase().trim();

      const results = [];
      let checkedCount = 0;
      let matchCount = 0;

      customers.forEach((customer, index) => {
        checkedCount++;

        // Normalize customer data - handle null/undefined and trim whitespace
        const customerName = (customer.name || '').toLowerCase().trim();
        const customerAccount = (customer.accountNumber || '').toLowerCase().trim();
        const customerAddress = (customer.address || '').toLowerCase().trim();
        const customerPhone = String(customer.phone || '').toLowerCase().trim();

        // Log first few customers for debugging
        if (index < 5) {

        }

        const nameMatch = customerName.includes(searchTerm);
        const accountMatch = customerAccount.includes(searchTerm);
        const addressMatch = customerAddress.includes(searchTerm);
        const phoneMatch = customerPhone.includes(searchTerm);

        if (nameMatch || accountMatch || addressMatch || phoneMatch) {
          matchCount++;

          results.push(customer);
        }
      });

      if (results.length > 0) {

        } else {

      }

      return results;
    }

    window.renderCustomerSearchResults = function(results) {

      const container = document.getElementById('customerSearchResults');

      if (!container) {

        return;
      }

      // Handle undefined/null results
      if (!results || !Array.isArray(results)) {

        results = [];
      }

      if (results.length === 0) {

        container.innerHTML = '<p class="text-sm text-slate-500 p-4 text-center">No customers found</p>';
        container.classList.remove('hidden');

        return;
      }

      const html = results.map((customer, index) => {

        return `
        <div 
          onclick="selectCustomerFromSearch('${customer.id}')"
          class="p-4 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer transition-colors"
        >
          <div class="font-semibold text-slate-800 dark:text-slate-200">${customer.name || 'N/A'}</div>
          <div class="text-sm text-slate-600 dark:text-slate-400 mt-1">
            <div>Account #: ${customer.accountNumber || 'N/A'}</div>
            <div>Address: ${customer.address || 'N/A'}</div>
            <div>Phone: ${customer.phone || 'N/A'}</div>
          </div>
        </div>
      `;
      }).join('');

      container.innerHTML = html;

      container.classList.remove('hidden');

    }

    window.selectCustomerFromSearch = function(customerId) {
      const searchInput = document.getElementById('customerSearchInput');
      const resultsContainer = document.getElementById('customerSearchResults');

      if (searchInput) searchInput.value = '';
      if (resultsContainer) resultsContainer.classList.add('hidden');

      window.selectedCustomerIdForPayment = customerId;
      showCustomerPaymentInfo(customerId);
    }

    function populatePaymentProcessingStartUserSelect() {
      const select = document.getElementById('paymentProcessingStartUserSelect');
      if (!select) {

        return;
      }

      select.innerHTML = '<option value="">Select a user...</option><option value="Test User">Test User</option>';
      users.forEach(user => {
        const option = document.createElement('option');
        const fullName = user.fullName || user.id || 'Unnamed User';
        option.value = fullName;
        option.textContent = fullName;
        select.appendChild(option);
      });

    }

    function showCustomerPaymentInfo(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        // Use shared calculation function to ensure consistency
        const calc = calculateCustomerTotal(customer);
        const totalAmount = calc.total;
        const pastDue = calc.pastDue;
        const lateFeeAmount = calc.lateFeeAmount;

        // Calculate due date as last day of current month
        const now = window.getCurrentDate();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Set up status indicator
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        // Clamp totalAmount to never show negative (should be $0.00 minimum)
        const displayAmount = Math.max(0, totalAmount);
        document.getElementById('paymentAmountDue').textContent = `$${displayAmount.toFixed(2)}`;
        document.getElementById('paymentPastDue').textContent = `$${pastDue.toFixed(2)}`; // Show 0.00 if there's a credit
        document.getElementById('paymentDueDate').textContent = dueDateStr;
        document.getElementById('paymentLateFee').textContent = `$${lateFeeAmount.toFixed(2)}`;
        document.getElementById('paymentAmount').value = displayAmount.toFixed(2);

        // Update status indicator
        const statusIndicator = document.getElementById('paymentStatusIndicator');
        statusIndicator.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
        statusIndicator.textContent = customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1);

        // Update property location
        document.getElementById('paymentPropertyLocation').textContent = customer.address;

        document.getElementById('customerPaymentInfo').classList.remove('hidden');
      }
    }

    // Shared function to calculate customer total amount breakdown
    // Returns an object with all calculated values
    function calculateCustomerTotal(customer) {

      const baseServiceCost = calculateProratedServiceCost(customer);
      const pastDueRaw = parseFloat(customer.pastDue || 0);
      const pastDue = Math.max(0, pastDueRaw);
      const credit = Math.abs(Math.min(0, pastDueRaw));

      const lateFeeAmount = pastDue > 0 ? lateFee : 0;

      const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
      const adjustedServiceCost = baseServiceCost * factor;

      // Calculate code surcharges - refresh from global codes array
      let totalSurcharge = 0;
      if (customer.codes && customer.codes.length > 0) {
        customer.codes.forEach(customerCode => {
          // Look up the latest code data from the global codes array
          let latestCode = codes.find(c => c.id === customerCode.id);
          if (!latestCode) {
            latestCode = codes.find(c => c.name.toLowerCase() === customerCode.name.toLowerCase());
          }
          const codeToUse = latestCode || customerCode;

          const codeType = codeToUse.type || 'percentage';
          const codeAmount = codeToUse.amount !== undefined ? codeToUse.amount : (codeToUse.percentage !== undefined ? codeToUse.percentage : 0);

          let baseSurchargeAmount;
          if (codeType === 'flat') {
            baseSurchargeAmount = codeAmount;
          } else {
            baseSurchargeAmount = adjustedServiceCost * (codeAmount / 100);
          }

          const surchargeAmount = baseSurchargeAmount * factor;
          totalSurcharge += surchargeAmount;
        });
      }

      const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;

      let pucSurchargeAmount = 0;
      if (pucSurcharge > 0) {
        pucSurchargeAmount = subtotalBeforePuc * (pucSurcharge / 100);
      }

      // Calculate current due before payment
      const currentDueBeforePayment = subtotalBeforePuc + pucSurchargeAmount + lateFeeAmount;

      // Subtract any payments made toward the current month's bill
      const currentMonthPaid = parseFloat(customer.currentMonthPaid || 0);
      const currentDue = Math.max(0, currentDueBeforePayment - currentMonthPaid);

      const total = currentDue + pastDue - credit;

      return {
        baseServiceCost,
        adjustedServiceCost,
        pastDue,
        credit,
        lateFeeAmount,
        totalSurcharge,
        subtotalBeforePuc,
        pucSurchargeAmount,
        currentDue,
        total
      };
    }

    // Calculate prorated service cost based on when customer was added
    function calculateProratedServiceCost(customer) {
      const baseServiceCost = sewerCharge;

      // Imported customers should not be prorated - always charge full amount
      if (customer.importData) {
        return baseServiceCost;
      }

      // If customer was added this month, calculate proration
      const now = window.getCurrentDate();
      const customerAddedDate = new Date(customer.createdDate);

      // Check if customer was added in the current month
      if (customerAddedDate.getMonth() === now.getMonth() && 
          customerAddedDate.getFullYear() === now.getFullYear()) {

        // Calculate days remaining in the month from when they joined
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const totalDaysInMonth = lastDayOfMonth.getDate();

        // Days from when they joined to end of month
        const daysRemaining = lastDayOfMonth.getDate() - customerAddedDate.getDate() + 1;

        // Calculate prorated amount
        const proratedAmount = (baseServiceCost * daysRemaining) / totalDaysInMonth;

        return Math.round(proratedAmount * 100) / 100; // Round to 2 decimal places
      }

      // If customer was added in a previous month, charge full amount
      return baseServiceCost;
    }

    function hideCustomerPaymentInfo() {
      document.getElementById('customerPaymentInfo').classList.add('hidden');
    }

    // Bill Module Functions
    function populateBillCustomerSelect() {
      const select = document.getElementById('billCustomerSelect');
      select.innerHTML = '<option value="">Choose a customer...</option>';

      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.name} (${customer.accountNumber})`;
        select.appendChild(option);
      });

      // Add event listener for customer selection
      select.addEventListener('change', function() {
        const customerId = this.value;
        if (customerId) {
          // Clear cycle select when customer is selected
          const cycleSelect = document.getElementById('billCycleSelect');
          const produceBillingCycleContainer = document.getElementById('produceBillingCycleContainer');
          if (cycleSelect) {
            cycleSelect.value = '';
          }
          if (produceBillingCycleContainer) {
            produceBillingCycleContainer.classList.add('hidden');
          }
          showCustomerBillInfo(customerId);
        } else {
          hideCustomerBillInfo();
        }
      });
    }

    function showCustomerBillInfo(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        // Calculate prorated service cost based on when customer was added
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due

        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate PUC Surcharge first (applied to adjusted service cost after factor, before other codes)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = adjustedServiceCost * (pucSurcharge / 100);
        }

        // Calculate code surcharges (applied to adjusted service cost after factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += adjustedServiceCost * (codeAmount / 100);
            }
          });
        }

        const totalAmount = adjustedServiceCost + pastDue + lateFeeAmount + pucSurchargeAmount + totalSurcharge;

        // Calculate due date as last day of current month
        const now = window.getCurrentDate();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Set up status indicator
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        document.getElementById('billAmountDue').textContent = `$${totalAmount.toFixed(2)}`;
        document.getElementById('billPastDue').textContent = `$${customer.pastDue.toFixed(2)}`;
        document.getElementById('billDueDate').textContent = dueDateStr;
        document.getElementById('billLateFee').textContent = `$${lateFeeAmount.toFixed(2)}`;

        // Update status indicator
        const statusIndicator = document.getElementById('billStatusIndicator');
        statusIndicator.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
        statusIndicator.textContent = customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1);

        // Update property location
        document.getElementById('billPropertyLocation').textContent = customer.address;

        document.getElementById('customerBillInfo').classList.remove('hidden');
      }
    }

    function hideCustomerBillInfo() {
      document.getElementById('customerBillInfo').classList.add('hidden');
    }

    window.resetBillForm = function() {
      const billModule = document.getElementById('billModule');
      billModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Or Select Cycle Number</label>
            <select id="billCycleSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" onchange="handleCycleSelectChange()">
              <option value="">Select cycle number...</option>
              <option value="1">Cycle 1</option>
              <option value="2">Cycle 2</option>
              <option value="3">Cycle 3</option>
              <option value="4">Cycle 4</option>
              <option value="5">Cycle 5</option>
              <option value="6">Cycle 6</option>
              <option value="7">Cycle 7</option>
              <option value="8">Cycle 8</option>
              <option value="9">Cycle 9</option>
              <option value="10">Cycle 10</option>
            </select>
          </div>

          <div id="produceBillingCycleContainer" class="hidden">
            <button 
              onclick="produceBillingCycle()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Billing Cycle
            </button>
          </div>

          <div class="mt-4">
            <button 
              onclick="showPastBillingCycles()" 
              class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              View Past Cycles
            </button>
          </div>

          <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>

            <br>
            <button 
              onclick="produceBill()" 
              class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Bill
            </button>

            <!-- PDF Display Container -->
            <div id="billPdfDisplay" class="hidden mt-4">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            </div>
          </div>
        </div>

      `;

      // Repopulate the customer dropdown
      populateBillCustomerSelect();
    };

    window.produceBill = async function() {
      const customerId = document.getElementById('billCustomerSelect').value;
      if (!customerId) {
        alert('Please select a customer');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      try {
        // Calculate all the amounts (same logic as showCustomerBillInfo)
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due

        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate PUC Surcharge first (applied to adjusted service cost after factor, before other codes)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = adjustedServiceCost * (pucSurcharge / 100);
        }

        // Calculate code surcharges (applied to adjusted service cost after factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += adjustedServiceCost * (codeAmount / 100);
            }
          });
        }

        const totalAmount = adjustedServiceCost + pastDue + lateFeeAmount + pucSurchargeAmount + totalSurcharge;

        // Calculate dates
        const now = window.getCurrentDate();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const statementDate = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getFullYear();

        // Calculate billing cycle (first day of month to last day of month)
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayStr = (firstDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           firstDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                           String(firstDayOfMonth.getFullYear()).slice(-2);
        const lastDayStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          String(lastDayOfMonth.getFullYear()).slice(-2);
        const cyclePeriod = `${firstDayStr} to ${lastDayStr}`;

        // Due date is the last day of the billing cycle month (same as lastDayOfMonth)
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Create FormData with all the required fields
        const formData = new FormData();
        formData.append('account_no', customer.accountNumber || '');
        formData.append('account_name', customer.name || '');
        formData.append('account_address', customer.address || '');
        formData.append('statement_date', statementDate);
        formData.append('cycle_period', cyclePeriod);
        formData.append('current_charges', `$${adjustedServiceCost.toFixed(2)}`);
        formData.append('previous_charges', `$${customer.pastDue.toFixed(2)}`);
        // Calculate subtotal before PUC (adjusted service cost + tax codes)
        const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;

        // Recalculate PUC surcharge based on subtotal before PUC
        let pucSurchargeAmountRecalc = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmountRecalc = subtotalBeforePuc * (pucSurcharge / 100);
        }

        const currentDue = subtotalBeforePuc + pucSurchargeAmountRecalc + lateFeeAmount;
        const totalAmountRecalc = currentDue + pastDue;

        formData.append('taxes_charges', `$${totalSurcharge.toFixed(2)}`);
        formData.append('total_amount', `$${totalAmountRecalc.toFixed(2)}`);
        formData.append('due_date', dueDateStr);

        // Send to server
        const response = await fetch('/edit_pdf?pdf=bill', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Failed to generate PDF');
        }

        // Get the PDF blob
        const blob = await response.blob();

        // Create blob URL for download
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'bill.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        // Display the PDF below the button
        const displayUrl = URL.createObjectURL(blob);
        const pdfDisplay = document.getElementById('billPdfDisplay');
        const pdfViewer = document.getElementById('billPdfViewer');
        const billModule = document.getElementById('billModule');

        if (pdfDisplay && pdfViewer) {
          // Revoke any previous display URL to prevent memory leaks
          if (pdfViewer.src && pdfViewer.src.startsWith('blob:')) {
            URL.revokeObjectURL(pdfViewer.src);
          }

          pdfViewer.src = displayUrl;
          pdfDisplay.classList.remove('hidden');

          // Increase bill module height by 25% when PDF is displayed
          if (billModule) {
            // Wait a moment for the PDF display to render, then calculate height
            setTimeout(() => {
              const currentHeight = billModule.offsetHeight;
              billModule.style.minHeight = `${currentHeight * 1.25}px`;
              billModule.style.paddingBottom = '2rem';
            }, 50);
          }

          // Scroll to the PDF viewer smoothly
          setTimeout(() => {
            pdfDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 100);
        } else {
          // If elements don't exist, create them dynamically
          const customerBillInfo = document.getElementById('customerBillInfo');
          if (customerBillInfo) {
            const pdfContainer = document.createElement('div');
            pdfContainer.id = 'billPdfDisplay';
            pdfContainer.className = 'mt-4';
            pdfContainer.innerHTML = `
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            `;
            customerBillInfo.appendChild(pdfContainer);
            document.getElementById('billPdfViewer').src = displayUrl;

            // Increase bill module height by 25% when PDF is displayed
            if (billModule) {
              // Wait a moment for the PDF display to render, then calculate height
              setTimeout(() => {
                const currentHeight = billModule.offsetHeight;
                billModule.style.minHeight = `${currentHeight * 1.25}px`;
                billModule.style.paddingBottom = '2rem';
              }, 50);
            }

            setTimeout(() => {
              pdfContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
          }
        }

        alert('Bill PDF generated successfully!');
      } catch (error) {
        alert('Failed to generate bill PDF: ' + error.message);
      }
    };

    // Handle cycle select change - show/hide produce billing cycle button
    window.handleCycleSelectChange = function() {
      const cycleSelect = document.getElementById('billCycleSelect');
      const produceBillingCycleContainer = document.getElementById('produceBillingCycleContainer');
      const billCustomerSelect = document.getElementById('billCustomerSelect');

      if (cycleSelect && produceBillingCycleContainer) {
        if (cycleSelect.value) {
          produceBillingCycleContainer.classList.remove('hidden');
          // Clear customer selection when cycle is selected
          if (billCustomerSelect) {
            billCustomerSelect.value = '';
            const customerBillInfo = document.getElementById('customerBillInfo');
            if (customerBillInfo) {
              customerBillInfo.classList.add('hidden');
            }
          }
        } else {
          produceBillingCycleContainer.classList.add('hidden');
        }
      }
    };

    // Produce billing cycle - generate bills for all customers in a cycle and zip them
    window.produceBillingCycle = async function() {
      const cycleNumber = document.getElementById('billCycleSelect').value;
      if (!cycleNumber) {
        alert('Please select a cycle number');
        return;
      }

      // Get all customers with this cycle number
      const cycleCustomers = customers.filter(c => c.cycleNumber === cycleNumber);

      if (cycleCustomers.length === 0) {
        alert(`No customers found for Cycle ${cycleNumber}`);
        return;
      }

      if (!confirm(`This will generate bills for ${cycleCustomers.length} customer(s) in Cycle ${cycleNumber}. Continue?`)) {
        return;
      }

      try {
        // Show loading message
        const produceButton = document.querySelector('#produceBillingCycleContainer button');
        const originalButtonText = produceButton ? produceButton.textContent : '';
        if (produceButton) {
          produceButton.textContent = 'Generating bills...';
          produceButton.disabled = true;
        }

        // Create snapshot of data before generating bills
        const now = window.getCurrentDate();
        const snapshotDate = now.toISOString();
        const dateStr = (now.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                       now.getDate().toString().padStart(2, '0') + '-' + 
                       now.getFullYear();

        // Calculate dates for snapshot
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const statementDate = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getFullYear();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayStr = (firstDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           firstDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                           String(firstDayOfMonth.getFullYear()).slice(-2);
        const lastDayStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          String(lastDayOfMonth.getFullYear()).slice(-2);
        const cyclePeriod = `${firstDayStr} to ${lastDayStr}`;
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Create snapshot with all customer data and calculations
        const billingCycleSnapshot = {
          cycleNumber: cycleNumber,
          generatedDate: snapshotDate,
          generatedDateStr: dateStr,
          statementDate: statementDate,
          cyclePeriod: cyclePeriod,
          dueDateStr: dueDateStr,
          // Save all settings used
          settings: {
            sewerCharge: sewerCharge,
            lateFee: lateFee,
            pucSurcharge: pucSurcharge,
            codes: JSON.parse(JSON.stringify(codes)) // Deep copy
          },
          // Save complete customer snapshots with all calculations
          customerSnapshots: []
        };

        // Create JSZip instance
        const zip = new JSZip();

        // Generate bill for each customer
        let successCount = 0;
        let errorCount = 0;

        for (const customer of cycleCustomers) {
          try {
            // Calculate all the amounts (same logic as produceBill)
            const baseServiceCost = calculateProratedServiceCost(customer);
            const pastDue = parseFloat(customer.pastDue || 0);
            const lateFeeAmount = pastDue > 0 ? lateFee : 0;

            const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
            const adjustedServiceCost = baseServiceCost * factor;

            // Calculate tax codes
            let totalSurcharge = 0;
            if (customer.codes && customer.codes.length > 0) {
              customer.codes.forEach(code => {
                const codeType = code.type || 'percentage';
                const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
                if (codeType === 'flat') {
                  totalSurcharge += codeAmount;
                } else {
                  totalSurcharge += adjustedServiceCost * (codeAmount / 100);
                }
              });
            }

            // Calculate PUC Surcharge
            const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;
            let pucSurchargeAmount = 0;
            if (pucSurcharge > 0) {
              pucSurchargeAmount = subtotalBeforePuc * (pucSurcharge / 100);
            }

            const currentDue = subtotalBeforePuc + pucSurchargeAmount + lateFeeAmount;
            const totalAmount = currentDue + pastDue;

            // Save customer snapshot with all calculations
            const customerSnapshot = {
              customerId: customer.id,
              customerData: JSON.parse(JSON.stringify(customer)), // Deep copy of customer data
              calculations: {
                baseServiceCost: baseServiceCost,
                pastDue: pastDue,
                lateFeeAmount: lateFeeAmount,
                factor: factor,
                adjustedServiceCost: adjustedServiceCost,
                totalSurcharge: totalSurcharge,
                subtotalBeforePuc: subtotalBeforePuc,
                pucSurchargeAmount: pucSurchargeAmount,
                currentDue: currentDue,
                totalAmount: totalAmount
              },
              pdfData: {
                account_no: customer.accountNumber || '',
                account_name: customer.name || '',
                account_address: customer.address || '',
                statement_date: statementDate,
                cycle_period: cyclePeriod,
                current_charges: `$${adjustedServiceCost.toFixed(2)}`,
                previous_charges: `$${customer.pastDue.toFixed(2)}`,
                taxes_charges: `$${totalSurcharge.toFixed(2)}`,
                total_amount: `$${totalAmount.toFixed(2)}`,
                due_date: dueDateStr
              }
            };
            billingCycleSnapshot.customerSnapshots.push(customerSnapshot);

            // Create FormData
            const formData = new FormData();
            formData.append('account_no', customerSnapshot.pdfData.account_no);
            formData.append('account_name', customerSnapshot.pdfData.account_name);
            formData.append('account_address', customerSnapshot.pdfData.account_address);
            formData.append('statement_date', customerSnapshot.pdfData.statement_date);
            formData.append('cycle_period', customerSnapshot.pdfData.cycle_period);
            formData.append('current_charges', customerSnapshot.pdfData.current_charges);
            formData.append('previous_charges', customerSnapshot.pdfData.previous_charges);
            formData.append('taxes_charges', customerSnapshot.pdfData.taxes_charges);
            formData.append('total_amount', customerSnapshot.pdfData.total_amount);
            formData.append('due_date', customerSnapshot.pdfData.due_date);

            // Generate PDF
            const response = await fetch('/edit_pdf?pdf=bill', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              throw new Error(`Failed to generate PDF for ${customer.name}`);
            }

            // Get PDF blob
            const blob = await response.blob();

            // Sanitize customer name for filename (remove special characters)
            const sanitizedName = customer.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const filename = `${sanitizedName}-${dateStr}.pdf`;

            // Add to zip
            zip.file(filename, blob);
            successCount++;

          } catch (error) {

            errorCount++;
          }
        }

        // Generate zip file
        const zipBlob = await zip.generateAsync({ type: 'blob' });

        // Save snapshot to Firestore before downloading
        try {
          const billingCyclesRef = collection(db, 'billingCycles');
          await addDoc(billingCyclesRef, billingCycleSnapshot);

        } catch (snapshotError) {

          // Don't fail the whole operation if snapshot save fails
        }

        // Download zip file
        const downloadUrl = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `cycle-${cycleNumber}-bills-${dateStr}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        // Restore button
        if (produceButton) {
          produceButton.textContent = originalButtonText;
          produceButton.disabled = false;
        }

        // Show success message
        if (errorCount === 0) {
          alert(`Successfully generated ${successCount} bill(s) for Cycle ${cycleNumber}!\nSnapshot saved for future reference.`);
        } else {
          alert(`Generated ${successCount} bill(s) successfully, but ${errorCount} failed. Check console for details.\nSnapshot saved for future reference.`);
        }

      } catch (error) {

        alert('Error producing billing cycle: ' + error.message);

        // Restore button
        const produceButton = document.querySelector('#produceBillingCycleContainer button');
        if (produceButton) {
          produceButton.textContent = 'Produce Billing Cycle';
          produceButton.disabled = false;
        }
      }
    };

    window.showBillDetailsModal = function() {
      // Placeholder function - can be implemented later if needed
      const customerId = document.getElementById('billCustomerSelect').value;
      if (customerId) {
        showAmountDetails(customerId);
      }
    };

    // Show past billing cycles modal
    window.showPastBillingCycles = async function() {
      try {
        // Load all billing cycle snapshots from Firestore
        const billingCyclesRef = collection(db, 'billingCycles');
        const snapshot = await getDocs(billingCyclesRef);

        const pastCycles = [];
        snapshot.forEach(doc => {
          pastCycles.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Sort by date (newest first)
        pastCycles.sort((a, b) => new Date(b.generatedDate) - new Date(a.generatedDate));

        // Create modal content
        const billModule = document.getElementById('billModule');
        billModule.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Past Billing Cycles</h3>
            <button onclick="showProcessBillModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="mb-4">
            <button 
              onclick="showProcessBillModal()" 
              class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-xl transition-colors duration-200 flex items-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              Back to Process Bill
            </button>
          </div>
          <br>

          <div class="space-y-4">
            ${pastCycles.length === 0 ? `
              <div class="text-center py-8">
                <p class="text-slate-600 dark:text-slate-400">No past billing cycles found.</p>
              </div>
            ` : `
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                  <thead class="bg-slate-50 dark:bg-slate-700">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Date</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Cycle</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Customers</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Period</th>
                      <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="pastBillingCyclesBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                    ${pastCycles.map(cycle => {
                      const date = new Date(cycle.generatedDate);
                      const dateStr = (date.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                     date.getDate().toString().padStart(2, '0') + '/' + 
                                     date.getFullYear();
                      const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                      const customerCount = cycle.customerSnapshots ? cycle.customerSnapshots.length : 0;
                      return `
                        <tr>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            ${dateStr}<br>
                            <span class="text-xs text-slate-500 dark:text-slate-400">${timeStr}</span>
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                              Cycle ${cycle.cycleNumber}
                            </span>
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            ${customerCount} customer(s)
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            ${cycle.cyclePeriod || 'N/A'}
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button 
                              onclick="reproduceBillingCycle('${cycle.id}')" 
                              class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-4"
                              title="Reproduce this billing cycle"
                            >
                              Reproduce
                            </button>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        `;

        billModule.classList.remove('hidden');
      } catch (error) {

        alert('Error loading past billing cycles: ' + error.message);
      }
    };

    // Reproduce a past billing cycle
    window.reproduceBillingCycle = async function(cycleId) {
      if (!confirm('This will reproduce the billing cycle using the exact same data from when it was generated. Continue?')) {
        return;
      }

      try {
        // Load the billing cycle snapshot from Firestore
        const billingCyclesRef = collection(db, 'billingCycles');
        const cycleDoc = await getDoc(doc(billingCyclesRef, cycleId));

        if (!cycleDoc.exists()) {
          alert('Billing cycle snapshot not found');
          return;
        }

        const cycleSnapshot = cycleDoc.data();

        // Show loading message
        const billModule = document.getElementById('billModule');
        billModule.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Reproducing Billing Cycle</h3>
          </div>
          <div class="text-center py-8">
            <p class="text-slate-600 dark:text-slate-400">Generating bills from snapshot...</p>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Cycle ${cycleSnapshot.cycleNumber} - ${cycleSnapshot.generatedDateStr}</p>
          </div>
        `;

        // Create JSZip instance
        const zip = new JSZip();

        // Generate bill for each customer using snapshot data
        let successCount = 0;
        let errorCount = 0;

        for (const customerSnapshot of cycleSnapshot.customerSnapshots) {
          try {
            // Use the exact PDF data from the snapshot
            const formData = new FormData();
            Object.keys(customerSnapshot.pdfData).forEach(key => {
              formData.append(key, customerSnapshot.pdfData[key]);
            });

            // Generate PDF
            const response = await fetch('/edit_pdf?pdf=bill', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              throw new Error(`Failed to generate PDF for ${customerSnapshot.pdfData.account_name}`);
            }

            // Get PDF blob
            const blob = await response.blob();

            // Use the original filename format
            const sanitizedName = customerSnapshot.pdfData.account_name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const filename = `${sanitizedName}-${cycleSnapshot.generatedDateStr}.pdf`;

            // Add to zip
            zip.file(filename, blob);
            successCount++;

          } catch (error) {

            errorCount++;
          }
        }

        // Generate zip file
        const zipBlob = await zip.generateAsync({ type: 'blob' });

        // Download zip file with original naming
        const downloadUrl = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `cycle-${cycleSnapshot.cycleNumber}-bills-${cycleSnapshot.generatedDateStr}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        // Show success message and return to past cycles view
        if (errorCount === 0) {
          alert(`Successfully reproduced ${successCount} bill(s) from Cycle ${cycleSnapshot.cycleNumber} (${cycleSnapshot.generatedDateStr})!`);
        } else {
          alert(`Reproduced ${successCount} bill(s) successfully, but ${errorCount} failed. Check console for details.`);
        }

        // Return to past cycles view
        showPastBillingCycles();

      } catch (error) {

        alert('Error reproducing billing cycle: ' + error.message);
        showPastBillingCycles();
      }
    };

    // Helper function to show process bill modal
    window.showProcessBillModal = function() {
      const billModule = document.getElementById('billModule');
      billModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Or Select Cycle Number</label>
            <select id="billCycleSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" onchange="handleCycleSelectChange()">
              <option value="">Select cycle number...</option>
              <option value="1">Cycle 1</option>
              <option value="2">Cycle 2</option>
              <option value="3">Cycle 3</option>
              <option value="4">Cycle 4</option>
              <option value="5">Cycle 5</option>
              <option value="6">Cycle 6</option>
              <option value="7">Cycle 7</option>
              <option value="8">Cycle 8</option>
              <option value="9">Cycle 9</option>
              <option value="10">Cycle 10</option>
            </select>
          </div>

          <div id="produceBillingCycleContainer" class="hidden">
            <button 
              onclick="produceBillingCycle()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Billing Cycle
            </button>
          </div>

          <div class="mt-4">
            <button 
              onclick="showPastBillingCycles()" 
              class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              View Past Cycles
            </button>
          </div>

          <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>

            <br>
            <button 
              onclick="produceBill()" 
              class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Bill
            </button>

            <!-- PDF Display Container -->
            <div id="billPdfDisplay" class="hidden mt-4">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            </div>
          </div>
        </div>

      `;

      // Repopulate the customer dropdown
      populateBillCustomerSelect();
    };

    window.processPaymentFromModule = async function() {
      // Check if user code prompt is enabled
      const togglesSettings = await loadTogglesSettings();
      if (togglesSettings && togglesSettings.askUserCodePerTransaction) {
        const userCode = prompt('Enter your user code:');
        if (!userCode || !userCode.trim()) {
          alert('User code is required to process this payment.');
          return;
        }
        // Find user by code
        const user = users.find(u => u.userCode && u.userCode.trim().toLowerCase() === userCode.trim().toLowerCase());
        if (!user) {
          alert('User code not found. Please enter a valid user code.');
          return;
        }
        // Store user code for this payment (can be used for logging/auditing)
        window.currentPaymentUserCode = userCode.trim();
        window.currentPaymentUserName = user.fullName || userCode;
      } else {
        // If user code prompt is not enabled, use the authenticated user's name
        if (window.authenticatedUser && window.authenticatedUser.fullName) {
          window.currentPaymentUserName = window.authenticatedUser.fullName;
        }
      }

      const paymentModule = document.getElementById('paymentModule');

      if (window.currentPaymentProcessing) {

      }

      const customerId = window.selectedCustomerIdForPayment;
      const paymentAmountInput = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
      const paymentType = document.getElementById('paymentType')?.value || '';
      const cashReceived = parseFloat(document.getElementById('cashReceivedInput')?.value);
      const changeDueInput = parseFloat(document.getElementById('cashChangeDisplay')?.value);
      const checkReceivedInput = parseFloat(document.getElementById('checkReceivedInput')?.value);
      const checkChangeInput = parseFloat(document.getElementById('checkChangeDisplay')?.value);
      const checkCreditInput = parseFloat(document.getElementById('checkCreditDisplay')?.value);
      const checkOverpaymentHandling = document.getElementById('checkOverpaymentHandling')?.value || '';
      const checkNumberInput = document.getElementById('checkNumberInput')?.value || '';

      if (!customerId) {

        alert('Please select a customer');
        return;
      }

      // Determine the actual payment amount based on payment type
      let actualPaymentAmount = 0;
      if (paymentType === 'Cash') {
        // For cash, payment amount is cashReceived minus change given
        const changeGiven = !isNaN(changeDueInput) ? changeDueInput : 0;
        actualPaymentAmount = !isNaN(cashReceived) ? (cashReceived - changeGiven) : paymentAmountInput;

      } else if (paymentType === 'Check') {
        // For check, payment amount is checkReceived minus change given (if Give Change is selected)
        const changeGiven = (checkOverpaymentHandling === 'change' && !isNaN(checkChangeInput)) ? checkChangeInput : 0;
        actualPaymentAmount = !isNaN(checkReceivedInput) ? (checkReceivedInput - changeGiven) : paymentAmountInput;

      } else {
        // Fallback to paymentAmountInput if no payment type or other type
        actualPaymentAmount = paymentAmountInput;

      }

      // Use actualPaymentAmount as paymentAmount for the rest of the function
      const paymentAmount = actualPaymentAmount;

      if (!paymentAmount || paymentAmount <= 0) {

        alert('Please enter a valid payment amount');
        return;
      }

      if (!paymentType) {

        alert('Please select a payment type');
        return;
      }

      // If Check payment type, require overpayment handling selection
      if (paymentType === 'Check' && !checkOverpaymentHandling) {
        alert('Please select how to handle overpayment (Give Change or Give Credit)');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (customer) {

        // Process payment (same logic as existing processPayment function)
        const today = window.getCurrentDate();
        const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();
        const timestamp = today.toISOString(); // Store full timestamp for date/time display

        // Calculate the total amount due (current due + past due) BEFORE payment

        const calcBeforePayment = calculateCustomerTotal(customer);
        const currentDueBeforePayment = calcBeforePayment.currentDue;
        const pastDueBeforePayment = calcBeforePayment.pastDue;
        const totalOwedBeforePayment = currentDueBeforePayment + pastDueBeforePayment;

        // Initialize per-category trackers if missing
        customer.currentMonthPaid = parseFloat(customer.currentMonthPaid || 0);
        customer.currentMonthPaidSewer = parseFloat(customer.currentMonthPaidSewer || 0);
        customer.currentMonthPaidTaxCodes = parseFloat(customer.currentMonthPaidTaxCodes || 0);
        customer.currentMonthPaidLateFee = parseFloat(customer.currentMonthPaidLateFee || 0);
        customer.currentMonthPaymentHistory = Array.isArray(customer.currentMonthPaymentHistory) ? customer.currentMonthPaymentHistory : [];

        // Calculate credit amount if "Give Credit" is selected
        // We'll calculate this after payment hierarchy is applied to get the actual overpayment
        let creditGiven = 0;
        let overpaymentAmount = 0;
        const checkReceived = paymentType === 'Check' ? (!isNaN(checkReceivedInput) ? checkReceivedInput : paymentAmount) : 0;

        // Prepare amounts for hierarchy application
        const sewerCharge = Math.max(0, calcBeforePayment.adjustedServiceCost);
        const taxCodesTotal = Math.max(0, (calcBeforePayment.totalSurcharge || 0) + (calcBeforePayment.pucSurchargeAmount || 0));
        const lateFeeDue = Math.max(0, calcBeforePayment.lateFeeAmount || 0);

        let remainingPayment = paymentAmount;
        let paidSewer = customer.currentMonthPaidSewer || 0;
        let paidTax = customer.currentMonthPaidTaxCodes || 0;
        let paidLate = customer.currentMonthPaidLateFee || 0;
        let pastDueRemaining = pastDueBeforePayment;

        const paymentsApplied = [];

        const hierarchy = window.paymentHierarchyOrder || [];

        const applyToCategory = (label, dueGetter, applyFn) => {
          const due = Math.max(0, dueGetter());

          if (remainingPayment > 0 && due > 0) {
            const applied = Math.min(remainingPayment, due);

            remainingPayment -= applied;
            applyFn(applied);
            paymentsApplied.push({ category: label, amount: applied, date: formattedDate });

          } else {

          }
        };

        hierarchy.forEach((item, idx) => {

          switch (item) {
            case 'Past Due':
              applyToCategory('Past Due', () => Math.max(0, pastDueRemaining), (applied) => {
                pastDueRemaining -= applied;
                customer.pastDue = pastDueRemaining;
              });
              break;
            case 'Late Fee':
              applyToCategory('Late Fee', () => Math.max(0, lateFeeDue - paidLate), (applied) => {
                paidLate += applied;
              });
              break;
            case 'Tax Codes':
              applyToCategory('Tax Codes', () => Math.max(0, taxCodesTotal - paidTax), (applied) => {
                paidTax += applied;
              });
              break;
            case 'Sewer Charge':
              applyToCategory('Sewer Charge', () => Math.max(0, sewerCharge - paidSewer), (applied) => {
                paidSewer += applied;
              });
              break;
            default:

              applyToCategory('Sewer Charge', () => Math.max(0, sewerCharge - paidSewer), (applied) => {
                paidSewer += applied;
              });
              break;
          }
        });

        // Calculate credit after payment hierarchy is applied
        // Credit is the actual overpayment: checkReceived - paymentAmount (when credit is selected)
        if (paymentType === 'Check' && checkOverpaymentHandling === 'credit') {
          // When giving credit, the credit is whatever remains after applying the payment.
          // If the user entered a credit value, cap it to the remaining amount.
          const creditInputValue = !isNaN(checkCreditInput) ? checkCreditInput : 0;
          const remainingForCredit = Math.max(0, remainingPayment);
          creditGiven = creditInputValue > 0
            ? Math.min(creditInputValue, remainingForCredit)
            : remainingForCredit;
          overpaymentAmount = remainingForCredit;

        }

        // Any remaining payment becomes credit (overpayment)

        if (creditGiven > 0) {
          const pastDueBeforeCredit = customer.pastDue || 0;
          customer.pastDue = pastDueBeforeCredit - creditGiven;

        } else if (remainingPayment > 0) {
          const pastDueBeforeRemaining = customer.pastDue || 0;
          customer.pastDue = pastDueBeforeRemaining - remainingPayment;

        }

        // Update trackers
        customer.currentMonthPaidSewer = paidSewer;
        customer.currentMonthPaidTaxCodes = paidTax;
        customer.currentMonthPaidLateFee = paidLate;
        customer.currentMonthPaid = paidSewer + paidTax + paidLate;

        // Get the payment number BEFORE adding to paymentHistory (this will be the global payment number)
        if (!customer.paymentHistory) {
          customer.paymentHistory = [];
        }
        const globalPaymentNumber = customer.paymentHistory.length + 1;

        // Store payment history per category for detail view

        paymentsApplied.forEach((p, idx) => {
          const historyEntry = {
            date: p.date,
            amount: p.amount,
            category: p.category,
            paymentNumber: globalPaymentNumber  // Add global payment number to each entry
          };

          customer.currentMonthPaymentHistory.push(historyEntry);
        });

        // Calculate total credit given (from check credit OR remaining payment for cash)
        const totalCreditGiven = creditGiven > 0 ? creditGiven : (remainingPayment > 0 ? remainingPayment : 0);

        // Add to payment history
        const paymentRecord = {
          date: formattedDate,
          timestamp: timestamp, // Full timestamp for date/time display
          amountPaid: paymentAmount,
          amountDue: totalOwedBeforePayment,
          creditGiven: totalCreditGiven > 0 ? totalCreditGiven : null
        };

        customer.paymentHistory.push(paymentRecord);

        // If customer was pending closing and now has no balance, mark as inactive
        if (customer.paymentStatus === 'pending closing' && customer.pastDue === 0 && customer.currentBill === 0) {
          customer.paymentStatus = 'inactive';
        } else {
          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);
        }

        // Update last payment
        customer.lastPayment = formattedDate;

        // Ensure currentMonthPaid is defined before saving
        if (customer.currentMonthPaid === undefined || customer.currentMonthPaid === null) {
          customer.currentMonthPaid = 0;
        }

        // Save only this customer to Firestore
        await saveSingleCustomerToFirestore(customer);

        updateDashboard();

        if (window.currentPaymentProcessing) {

          let cashIn = 0;
          let cashOut = 0;
          let checkIn = 0;
          if (paymentType === 'Cash') {
            const received = !isNaN(cashReceived) ? cashReceived : paymentAmount;
            const change = Math.max(0, !isNaN(changeDueInput) ? changeDueInput : received - paymentAmount);
            cashIn = received;
            cashOut = change;
          } else if (paymentType === 'Check') {
            const received = !isNaN(checkReceivedInput) ? checkReceivedInput : paymentAmount;
            const overpayment = Math.max(0, received - paymentAmount);
            checkIn = received;

            // Only count change as cash out if "Give Change" is selected
            if (checkOverpaymentHandling === 'change') {
              const change = !isNaN(checkChangeInput) ? checkChangeInput : overpayment;
              cashOut = change; // change given comes out of cash drawer
            } else if (checkOverpaymentHandling === 'credit') {
              // Credit doesn't come out of cash drawer
              cashOut = 0;
            } else {
              // No handling selected (shouldn't happen due to validation, but handle gracefully)
              cashOut = 0;
            }
          }
          if (window.currentPaymentProcessing.register && window.currentPaymentProcessing.register.runningTotals) {
            window.currentPaymentProcessing.register.runningTotals.cashIn += cashIn;
            window.currentPaymentProcessing.register.runningTotals.cashOut += cashOut;
            window.currentPaymentProcessing.register.runningTotals.checkIn += checkIn;
          }

        const categoryTotals = {
          'Sewer Charge': 0,
          'Tax Codes': 0,
          'Late Fee': 0,
          'Past Due': 0
        };
        paymentsApplied.forEach(p => {
          if (categoryTotals[p.category] !== undefined) {
            categoryTotals[p.category] += p.amount;
          }
        });

        const taxCodesApplied = categoryTotals['Tax Codes'] || 0;
        const taxCodeDetails = [];
        const totalTaxCodesDue = Math.max(0, taxCodesTotal);

        if (taxCodesApplied > 0 && totalTaxCodesDue > 0) {
          // Calculate factor and adjustedServiceCost for tax code breakdown
          const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
          const adjustedServiceCost = calcBeforePayment.adjustedServiceCost || 0;
          const pucSurchargeAmount = calcBeforePayment.pucSurchargeAmount || 0;

          const codeTotals = [];
          if (customer.codes && customer.codes.length > 0) {
            customer.codes.forEach(code => {
              const codeType = code.type || 'percentage';
              const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
              let baseSurcharge;
              if (codeType === 'flat') {
                baseSurcharge = codeAmount;
              } else {
                baseSurcharge = adjustedServiceCost * (codeAmount / 100);
              }
              const codeTotal = baseSurcharge * factor;
              if (codeTotal > 0) {
                codeTotals.push({
                  label: code.name || code.code || code.label || 'Tax Code',
                  total: codeTotal
                });
              }
            });
          }

          if (pucSurchargeAmount > 0) {
            codeTotals.push({
              label: 'PUC Surcharge',
              total: pucSurchargeAmount
            });
          }

          codeTotals.forEach(code => {
            const appliedAmount = taxCodesApplied * (code.total / totalTaxCodesDue);
            if (appliedAmount > 0) {
              taxCodeDetails.push({
                label: code.label,
                amount: appliedAmount
              });
            }
          });
        }

        addEntryToCurrentPaymentProcessing(customer, paymentAmount, paymentType, formattedDate, {
            cashReceived: !isNaN(cashReceived) ? cashReceived : null,
            changeGiven: paymentType === 'Cash' ? Math.max(0, (!isNaN(cashReceived) ? cashReceived : paymentAmount) - paymentAmount) : 0,
            checkReceived: !isNaN(checkReceivedInput) ? checkReceivedInput : null,
            checkChangeGiven: (paymentType === 'Check' && checkOverpaymentHandling === 'change') ? Math.max(0, (!isNaN(checkReceivedInput) ? checkReceivedInput : paymentAmount) - paymentAmount) : 0,
            checkCreditGiven: creditGiven,
            checkOverpaymentHandling: paymentType === 'Check' ? checkOverpaymentHandling : null,
            amountDue: totalOwedBeforePayment,
          checkNumber: checkNumberInput || null,
          breakdown: {
            sewerCharge: categoryTotals['Sewer Charge'] || 0,
            pastDue: categoryTotals['Past Due'] || 0,
            lateFee: categoryTotals['Late Fee'] || 0,
            taxCodes: categoryTotals['Tax Codes'] || 0,
            taxCodeDetails: taxCodeDetails
          }
          });

        } else {

          showPaymentSuccessScreen(customer.name, paymentAmount);
        }

      } else {

      }
    };

    // Show payment success screen
    window.showPaymentSuccessScreen = function(customerName, amount) {
      const paymentModule = document.getElementById('paymentModule');
      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Processed Successfully!</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>

          <h4 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Payment Processed Successfully!</h4>
          <p class="text-slate-600 dark:text-slate-400 mb-4">Payment of <span class="font-semibold text-green-600">$${amount.toFixed(2)}</span> has been processed for <span class="font-semibold">${customerName}</span></p>
          <p class="text-sm text-slate-500 dark:text-slate-400 mb-8">The payment has been recorded and the customer's account has been updated.</p>

          <div class="flex flex-col gap-4 justify-center">
            <button 
              onclick="resetPaymentForm()" 
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Make Another Payment
            </button>
            <button 
              onclick="hideAllModules()" 
              class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Exit
            </button>
          </div>
        </div>

      `;
    };

    // Reset payment form
    window.resetPaymentForm = function(keepHidden = false) {

      console.trace('[FLOW][resetPaymentForm][STEP 1.1] Stack trace to see who called this:');
      const paymentModule = document.getElementById('paymentModule');

      // Restore session from localStorage if it doesn't exist in memory
      if (!window.currentPaymentProcessing) {

        const savedSession = localStorage.getItem('currentPaymentProcessingSession');
        if (savedSession) {
          try {
            const parsed = JSON.parse(savedSession);
            if (!parsed.submittedAt) {
              window.currentPaymentProcessing = parsed;

            } else {

            }
          } catch (e) {

          }
        } else {

        }
      } else {

      }

      // Don't clear currentPaymentProcessing when resetting form - it should persist
      // Only clear it when explicitly canceling or starting a new session
      // if (window.currentPaymentProcessing) {
      //   window.currentPaymentProcessing = null;
      // }

      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Processing</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="paymentProcessingStartSection" class="space-y-6 py-8 px-6 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-center">
          <div class="flex flex-col gap-4 justify-center items-center">
              <button 
              onclick="startNewPayment()" 
                class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow">
              Start New Payment
              </button>
              <button 
              onclick="viewPaymentProcessingSessions()" 
                class="w-full md:w-auto bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-3 px-6 rounded-xl shadow">
              View Past Payments
              </button>
            </div>
          </div>

        <!-- Initial cash register count -->
        <div id="registerCountSection" class="hidden space-y-6 py-6 px-6 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl">
          <div class="flex items-center justify-between">
            <div>
              <h4 id="initialCountTitle" class="text-lg font-semibold text-slate-800 dark:text-slate-100">Initial Cash Register Count</h4>
              <p id="drawerCountSubtitle" class="text-sm text-slate-500 dark:text-slate-400">Enter quantities to establish the initial register balance.</p>
            </div>
            <button onclick="cancelCurrentBatch()" class="text-sm text-slate-500 hover:text-slate-700">Cancel</button>
        </div>

          <div id="expectedDrawerCountDisplay" class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800 hidden">
            <p class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">Expected Drawer Count (from Start of Day)</p>
            <p id="expectedDrawerCountText" class="text-xs text-blue-600 dark:text-blue-400"></p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
              <div class="grid grid-cols-2 gap-3">
                ${[1,2,5,10,20,50,100].map(v => `
                  <div class="flex items-center gap-2">
                    <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
                      <!-- Bill background -->
                      <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
                      <!-- Decorative border lines -->
                      <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
                      <!-- Center denomination -->
                      <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
                      <!-- Decorative lines -->
                      <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                      <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                    </svg>
                    <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
                    <input type="number" min="0" id="init_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRegisterTotal('init')">
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
              <div class="grid grid-cols-2 gap-3">
                ${[['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0'],['dollar',1.00,'Dollar Coin','#FFD700']].map(([k,val,label,color]) => `
                  <div class="flex items-center gap-2">
                    <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
                      <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
                      <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
                      <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${k === 'penny' ? '1¢' : k === 'nickel' ? '5¢' : k === 'dime' ? '10¢' : k === 'quarter' ? '25¢' : k === 'half' ? '50¢' : '$1'}</text>
                    </svg>
                    <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
                    <input type="number" min="0" id="init_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRegisterTotal('init')">
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <p id="initRegisterTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">Total: $0.00</p>
            </div>
            <div class="flex gap-3">
              <button onclick="calculateRegisterTotal('init')" class="px-4 py-2 text-sm bg-slate-200 rounded-lg">Recalculate</button>
              <button onclick="saveInitialRegisterCount()" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Save Initial Count</button>
            </div>
          </div>
        </div>

        <!-- Final recount before submit -->
        <div id="registerRecountSection" class="hidden space-y-6 py-6 px-6 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl">
          <div class="flex items-center justify-between">
            <div>
              <h4 id="closingCountTitle" class="text-lg font-semibold text-slate-800 dark:text-slate-100">End Of Day Count</h4>
              <p class="text-sm text-slate-500 dark:text-slate-400">Recount the drawer to balance the payment processing session.</p>
            </div>
            <button onclick="backToPaymentProcessingEntryFromRecount()" class="text-sm text-slate-500 hover:text-slate-700">Back</button>
          </div>

          <!-- Step Indicator -->
          <div class="flex items-center gap-4 mb-6">
            <button id="recountStep1Btn" onclick="switchRecountStep(1)" class="px-4 py-2 text-sm font-semibold bg-green-600 text-white rounded-lg">Step 1: SOD Fund Count</button>
            <button id="recountStep2Btn" onclick="switchRecountStep(2)" class="px-4 py-2 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg">Step 2: Count Payment Total</button>
          </div>

          <!-- Step 1: SOD Fund Count -->
          <div id="recountStep1" class="space-y-6">
            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
              <p class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2">SOD Fund Count (what was in the drawer at the start)</p>
              <p id="expectedInitialTotal" class="text-xs text-green-600 dark:text-green-400"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${[1,2,5,10,20,50,100].map(v => `
                    <div class="flex items-center gap-2">
                      <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
                        <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
                        <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
                        <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
                        <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                        <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                      </svg>
                      <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
                      <input type="number" min="0" id="initial_recount_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRecountTotal('initial')">
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${[['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0'],['dollar',1.00,'Dollar Coin','#FFD700']].map(([k,val,label,color]) => `
                    <div class="flex items-center gap-2">
                      <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
                        <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
                        <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${k === 'penny' ? '1¢' : k === 'nickel' ? '5¢' : k === 'dime' ? '10¢' : k === 'quarter' ? '25¢' : k === 'half' ? '50¢' : '$1'}</text>
                      </svg>
                      <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
                      <input type="number" min="0" id="initial_recount_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRecountTotal('initial')">
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <p id="initialRecountTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">SOD Fund Total: $0.00</p>
                <p id="registerVarianceText" class="text-xs text-slate-500 mt-1"></p>
              </div>
              <div class="flex gap-3">
                <button onclick="switchRecountStep(2)" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Continue to Step 2</button>
              </div>
            </div>
          </div>

          <!-- Step 2: Payment Count -->
          <div id="recountStep2" class="hidden space-y-6">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
              <p class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">Count the payment total (money received during this batch)</p>
              <p id="expectedPaymentTotal" class="text-xs text-blue-600 dark:text-blue-400"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${[1,2,5,10,20,50,100].map(v => `
                    <div class="flex items-center gap-2">
                      <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
                        <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
                        <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
                        <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
                        <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                        <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                      </svg>
                      <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
                      <input type="number" min="0" id="payment_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRecountTotal('payment')">
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${[['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0'],['dollar',1.00,'Dollar Coin','#FFD700']].map(([k,val,label,color]) => `
                    <div class="flex items-center gap-2">
                      <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
                        <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
                        <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${k === 'penny' ? '1¢' : k === 'nickel' ? '5¢' : k === 'dime' ? '10¢' : k === 'quarter' ? '25¢' : k === 'half' ? '50¢' : '$1'}</text>
                      </svg>
                      <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
                      <input type="number" min="0" id="payment_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRecountTotal('payment')">
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Checks</h5>
                <button onclick="addCheckInput('payment')" class="text-sm text-blue-600 hover:text-blue-800">Add Check</button>
              </div>
              <div id="payment_checksContainer" class="space-y-2">
                <div class="flex items-center gap-3">
                  <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #1</label>
                  <input type="text" class="w-32 px-3 py-2 border rounded-lg" placeholder="Check #" data-check-number />
                  <input type="number" min="0" step="0.01" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Amount" data-check-amount oninput="calculateRecountTotal('payment')" />
                  <button onclick="removeCheckInput(this)" class="text-xs text-red-500">Remove</button>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <p id="paymentRecountTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">Payment Total: $0.00</p>
              <div class="flex gap-3">
                <button onclick="switchRecountStep(1)" class="px-4 py-2 text-sm bg-slate-200 rounded-lg">Back to Step 1</button>
                <button onclick="finalizePaymentProcessingWithRecount()" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Submit Payments</button>
              </div>
            </div>
          </div>
        </div>

        <div id="paymentProcessingEntrySection" class="hidden space-y-6 mt-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <p class="text-lg font-semibold text-slate-800 dark:text-slate-200" id="activePaymentProcessingUser">--</p>
            </div>
            <div class="flex gap-3">
              <!-- End Session button removed -->
            </div>
          </div>

          <div class="space-y-6">
            <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Search Customer</label>
            <input 
              type="text" 
              id="customerSearchInput" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Search by name, account number, address, or phone number..."
              oninput="const results = searchCustomers(this.value); renderCustomerSearchResults(results);"
            >
            <div id="customerSearchResults" class="hidden mt-2 max-h-64 overflow-y-auto space-y-2 border border-slate-200 dark:border-slate-600 rounded-lg p-2 bg-white dark:bg-slate-800">
              <!-- Search results will appear here -->
            </div>
          </div>

          <div id="customerPaymentInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="paymentAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewDetailsBtn" onclick="showPaymentDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="paymentPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="paymentLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="paymentPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="paymentDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="paymentStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Type</label>
              <select 
                id="paymentType" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                onchange="togglePaymentInputs()"
              >
                <option value="">Select Payment Type</option>
                <option value="Check">Check</option>
                <option value="Cash">Cash</option>
              </select>
            </div>

            <div class="mb-4 hidden">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
              <input 
                type="number" 
                id="paymentAmount" 
                step="0.01" 
                min="0" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter payment amount"
                oninput="updateCashChangeDisplay(); updateCheckChangeDisplay();"
              >
            </div>

            <div id="cashInputsContainer" class="hidden mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cash Received</label>
                <input 
                  type="number" 
                  id="cashReceivedInput" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Amount given by customer"
                  oninput="updateCashChangeDisplay()"
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Change Due</label>
                <input 
                  type="number" 
                  id="cashChangeDisplay" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="$0.00" 
                  readonly
                >
              </div>
            </div>

            <div id="checkInputsContainer" class="hidden mb-4 space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Check Number</label>
                  <input 
                    type="text" 
                    id="checkNumberInput" 
                    class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                    placeholder="Enter check number"
                  >
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Check Received</label>
                  <input 
                    type="number" 
                    id="checkReceivedInput" 
                    step="0.01" 
                    min="0" 
                    class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                    placeholder="Amount on check"
                    oninput="updateCheckChangeDisplay()"
                  >
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Overpayment Handling</label>
                <select 
                  id="checkOverpaymentHandling" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  onchange="updateCheckChangeDisplay()"
                >
                  <option value="">Select your option</option>
                  <option value="change">Give Change</option>
                  <option value="credit">Give Credit</option>
                </select>
              </div>
              <div id="checkChangeDueContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Change Due</label>
                  <input 
                    type="number" 
                    id="checkChangeDisplay" 
                    step="0.01" 
                    min="0" 
                    class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                    placeholder="$0.00" 
                    readonly
                  >
                </div>
              </div>
              <div id="checkCreditDueContainer" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Credit Due</label>
                  <input 
                    type="number" 
                    id="checkCreditDisplay" 
                    step="0.01" 
                    min="0" 
                    class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                    placeholder="$0.00" 
                    readonly
                  >
                </div>
              </div>
            </div>

            <button 
              onclick="processPaymentFromModule()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Process Payment
            </button>
          </div>
        </div>

        <div id="paymentProcessingPreviewSection" data-payment-processing-section="preview" class="hidden mt-8 payment-processing-preview-custom">
          <div class="w-full rounded-xl border border-slate-200 bg-white shadow-md overflow-hidden">
            <!-- Header -->
            <div class="border-b px-6 py-4 bg-slate-50 flex items-center justify-between">
              <h2 class="text-lg font-semibold text-slate-800">Payment Processing Preview</h2>
            </div>

            <!-- Scrollable Table Wrapper -->
            <div class="overflow-x-auto">
              <div class="min-w-[1200px] text-sm">
                <div class="grid grid-cols-[110px_180px_140px_220px_90px_110px_120px_120px_120px_110px_150px_120px] bg-slate-100 text-xs uppercase text-slate-600">
                  <div class="px-4 py-3 text-left font-semibold">Date</div>
                  <div class="px-4 py-3 text-left font-semibold">Customer</div>
                  <div class="px-4 py-3 text-left font-semibold">Account #</div>
                  <div class="px-4 py-3 text-left font-semibold">Property</div>
                  <div class="px-4 py-3 text-left font-semibold">Type</div>
                  <div class="px-4 py-3 text-right font-semibold">Amount</div>
                  <div class="px-4 py-3 text-right font-semibold">Change Given</div>
                  <div class="px-4 py-3 text-right font-semibold">Credit Given</div>
                  <div class="px-4 py-3 text-left font-semibold">Check Number</div>
                  <div class="px-4 py-3 text-right font-semibold">Total Paid</div>
                  <div class="px-4 py-3 text-left font-semibold">Processed By</div>
                  <div class="px-4 py-3 text-center font-semibold">Actions</div>
                </div>

                <div id="paymentProcessingPreviewTable" class="divide-y divide-slate-100">
                  <!-- Filled by renderPaymentProcessingPreview() -->
                </div>

                <div class="grid grid-cols-[110px_180px_140px_220px_90px_110px_120px_120px_120px_110px_150px_120px] bg-slate-100">
                  <div class="col-span-10"></div>
                  <div class="px-4 py-3 text-right font-semibold text-slate-700">Total Paid</div>
                  <div id="paymentProcessingPreviewTotal" class="px-4 py-3 text-right font-bold text-slate-900">$0.00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="paymentProcessingSessionsListSection" data-payment-processing-section="list" class="hidden mt-8">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Submitted Sessions</h4>
            <button onclick="closePaymentProcessingSessionsList()" class="text-sm text-slate-500 hover:text-slate-700">Close</button>
          </div>
          <div class="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-inner">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Batch ID</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">User</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Entries</th>
                  <th class="px-4 py-2 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Amount</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Submitted</th>
                  <th class="px-4 py-2 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="paymentProcessingSessionsListTable" class="bg-white divide-y divide-slate-200">
                <tr>
                  <td colspan="6" class="px-4 py-3 text-center text-sm text-slate-500">No sessions submitted yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;

      // Repopulate dropdowns and ensure sections/logs are in sync

      populatePaymentProcessingStartUserSelect();

      setPaymentProcessingViewState('start');

      renderPaymentProcessingPreview();

      renderPaymentProcessingSessionsList();
      // If keepHidden is true, ensure payment module stays hidden (for initial page load)
      if (keepHidden) {
        paymentModule.classList.add('hidden');
      }

      debugPaymentProcessingDom('after-reset');

    };

    function debugPaymentProcessingDom(label) {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule) {

        return;
      }
      const snapshot = {
        hasStart: !!paymentModule.querySelector('#paymentProcessingStartSection'),
        hasEntry: !!paymentModule.querySelector('#paymentProcessingEntrySection'),
        hasPreview: !!paymentModule.querySelector('#paymentProcessingPreviewSection'),
        hasPreviewTable: !!paymentModule.querySelector('#paymentProcessingPreviewTable'),
        hasList: !!paymentModule.querySelector('#paymentProcessingSessionsListSection'),
        hasListTable: !!paymentModule.querySelector('#paymentProcessingSessionsListTable')
      };

    }

    function setPaymentProcessingViewState(view) {

      // Check if another module (like settings) is currently visible
      // If so, don't show the payment module
      const settingsModule = document.getElementById('settingsModule');
      const isSettingsVisible = settingsModule && !settingsModule.classList.contains('hidden');

      if (isSettingsVisible) {

        return; // Don't change payment module visibility
      }

      // Ensure payment module is visible

      const paymentModule = document.getElementById('paymentModule');
      if (paymentModule) {
        const wasHidden = paymentModule.classList.contains('hidden');
        paymentModule.classList.remove('hidden');

      } else {

        return;
      }

      const sections = {
        start: document.getElementById('paymentProcessingStartSection'),
        register: document.getElementById('registerCountSection'),
        entry: document.getElementById('paymentProcessingEntrySection'),
        preview: document.getElementById('paymentProcessingPreviewSection'),
        recount: document.getElementById('registerRecountSection'),
        list: document.getElementById('paymentProcessingSessionsListSection')
      };

      Object.entries(sections).forEach(([name, el]) => {

      });

      // CRITICAL: If recount section is missing and we're trying to show it, we have a problem
      if (view === 'recount' && !sections.recount) {

        alert('Payment module structure is missing. Please refresh the page.');
        return;
      }

      Object.entries(sections).forEach(([name, el]) => {
        if (!el) {
          if (view === name) {

          }
          return;
        }
        const wasHidden = el.classList.contains('hidden');
        if (view === name) {
          el.classList.remove('hidden');
          // CRITICAL: clear inline display styles set by hideAllModules
          if (el.style && el.style.cssText) {

            el.style.cssText = '';
          }

        } else {
          el.classList.add('hidden');

        }
      });

      // When viewing list, hide Active Payment Processing and Search Customer sections
      const paymentProcessingEntrySection = document.getElementById('paymentProcessingEntrySection');
      if (view === 'list') {
        if (paymentProcessingEntrySection) {
          paymentProcessingEntrySection.classList.add('hidden');
          paymentProcessingEntrySection.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
        }
      }

      debugPaymentProcessingDom('view-' + view);

      const target = sections[view];
      if (target) {

        requestAnimationFrame(() => {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      } else {

      }

    }

    function showPaymentProcessingEntryWithPreview() {
      const idsToHide = ['paymentProcessingStartSection', 'registerCountSection', 'registerRecountSection', 'paymentProcessingSessionsListSection'];
      idsToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
      const entry = document.getElementById('paymentProcessingEntrySection');
      const preview = document.getElementById('paymentProcessingPreviewSection');
      if (entry) {
        entry.classList.remove('hidden');
        entry.style.cssText = '';
      }
      if (preview) {
        preview.classList.remove('hidden');
        preview.style.cssText = '';
      }
    }

    function resetPaymentProcessingEntryForm() {
      const searchInput = document.getElementById('customerSearchInput');
      if (searchInput) searchInput.value = '';
      const resultsContainer = document.getElementById('customerSearchResults');
      if (resultsContainer) resultsContainer.classList.add('hidden');
      window.selectedCustomerIdForPayment = null;
      hideCustomerPaymentInfo();
      const paymentTypeField = document.getElementById('paymentType');
      if (paymentTypeField) paymentTypeField.value = '';
      const paymentAmountField = document.getElementById('paymentAmount');
      if (paymentAmountField) paymentAmountField.value = '';
      const cashReceived = document.getElementById('cashReceivedInput');
      if (cashReceived) cashReceived.value = '';
      const cashChange = document.getElementById('cashChangeDisplay');
      if (cashChange) cashChange.value = '';
      const checkNumber = document.getElementById('checkNumberInput');
      if (checkNumber) checkNumber.value = '';
      const checkReceived = document.getElementById('checkReceivedInput');
      if (checkReceived) checkReceived.value = '';
      const checkChange = document.getElementById('checkChangeDisplay');
      if (checkChange) checkChange.value = '';
      const checkCredit = document.getElementById('checkCreditDisplay');
      if (checkCredit) checkCredit.value = '';
      const checkHandling = document.getElementById('checkOverpaymentHandling');
      if (checkHandling) checkHandling.value = '';
      togglePaymentInputs();
    }

    // Helpers for register counting (prefix init|close)
    const billDenoms = [1, 2, 5, 10, 20, 50, 100];
    const coinDenoms = [
      { key: 'penny', value: 0.01 },
      { key: 'nickel', value: 0.05 },
      { key: 'dime', value: 0.10 },
      { key: 'quarter', value: 0.25 },
      { key: 'half', value: 0.50 }
    ];

    window.addCheckInput = function(prefix) {
      const container = document.getElementById(`${prefix}_checksContainer`);
      if (!container) return;
      const idx = container.children.length + 1;
      const row = document.createElement('div');
      row.className = 'flex items-center gap-3';
      const calcFunc = (prefix === 'payment' || prefix === 'initial_recount') ? 'calculateRecountTotal' : 'calculateRegisterTotal';
      const calcParam = prefix === 'payment' ? 'payment' : (prefix === 'initial_recount' ? 'initial' : prefix);
      row.innerHTML = `
        <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #${idx}</label>
        <input type="text" class="w-32 px-3 py-2 border rounded-lg" placeholder="Check #" data-check-number />
        <input type="number" min="0" step="0.01" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Amount" data-check-amount oninput="${calcFunc}('${calcParam}')" />
        <button onclick="removeCheckInput(this)" class="text-xs text-red-500">Remove</button>
      `;
      container.appendChild(row);
    };

    window.removeCheckInput = function(btn) {
      const row = btn.closest('div');
      if (row && row.parentElement) {
        row.parentElement.removeChild(row);
      }
    };

    function readRegisterCounts(prefix) {
      const bills = {};
      const coins = {};
      let cashTotal = 0;
      billDenoms.forEach(v => {
        const el = document.getElementById(`${prefix}_bill_${v}`);
        const qty = el ? parseFloat(el.value) || 0 : 0;
        bills[v] = qty;
        cashTotal += qty * v;
      });
      coinDenoms.forEach(({ key, value }) => {
        const el = document.getElementById(`${prefix}_coin_${key}`);
        const qty = el ? parseFloat(el.value) || 0 : 0;
        coins[key] = qty;
        cashTotal += qty * value;
      });
      const checksContainer = document.getElementById(`${prefix}_checksContainer`);
      const checks = [];
      if (checksContainer) {
        const checkRows = checksContainer.querySelectorAll('div.flex.items-center');
        checkRows.forEach(row => {
          const numberInput = row.querySelector('input[data-check-number]');
          const amountInput = row.querySelector('input[data-check-amount]');
          if (numberInput && amountInput) {
            const checkNumber = numberInput.value.trim();
            const amt = parseFloat(amountInput.value);
            if (!isNaN(amt) && amt > 0) {
              checks.push({
                number: checkNumber || null,
                amount: amt
              });
            }
          }
        });
      }
      const checksTotal = checks.reduce((s, v) => s + (v.amount || v), 0);
      const total = cashTotal + checksTotal;
      return { bills, coins, checks, cashTotal, checksTotal, total };
    }

    window.calculateRegisterTotal = function(prefix) {
      const result = readRegisterCounts(prefix);
      const target = document.getElementById(prefix === 'init' ? 'initRegisterTotal' : 'closeRegisterTotal');
      if (target) {
        target.textContent = `Total: $${result.total.toFixed(2)}`;
      }
      return result;
    };

    // Start new payment - goes directly to initial count screen or entry screen based on toggle
    window.startNewPayment = async function() {
      if (!selectedDrawer) {
        alert('Please select a drawer first.');
        return;
      }

      // Check if skip initial count toggle is enabled
      const togglesSettings = await loadTogglesSettings();
      const skipInitialCount = togglesSettings && togglesSettings.skipPOSInitialRegisterCount;

      if (!skipInitialCount) {
        // Show initial count screen
        showInitialRegisterCount();
        return;
      }

      // Skip initial count - go directly to payment entry
      // Calculate day of year (1-365/366)
      const now = window.getCurrentDate();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);

      // Generate temporary session ID (will be updated when user code is entered)
      const sessionId = `TEMP-${dayOfYear}-${Date.now()}`;

      // Check if there's a saved session to restore
      // Only restore if the session hasn't been submitted (no submittedAt)
      const savedSession = localStorage.getItem('currentPaymentProcessingSession');
      if (savedSession) {
        try {
          const parsed = JSON.parse(savedSession);
          // Don't restore if session was already submitted
          if (parsed.submittedAt) {
            // Clear the submitted session from localStorage
            localStorage.removeItem('currentPaymentProcessingSession');
            // Clear currentPaymentProcessing to ensure preview is empty
            window.currentPaymentProcessing = null;
            renderPaymentProcessingPreview();
          } else {
            // Restore the session if it's from today and same drawer
            const savedDate = new Date(parsed.startedAt);
            const today = window.getCurrentDate();
            if (savedDate.getFullYear() === today.getFullYear() &&
                savedDate.getMonth() === today.getMonth() &&
                savedDate.getDate() === today.getDate() &&
                parsed.drawer && parsed.drawer.id === selectedDrawer.id) {
              window.currentPaymentProcessing = parsed;
              renderPaymentProcessingPreview();
              setPaymentProcessingViewState('entry');
              showPaymentProcessingEntryWithPreview();
              return;
            } else {
              // Session is from a different day or drawer, clear it
              localStorage.removeItem('currentPaymentProcessingSession');
              window.currentPaymentProcessing = null;
              renderPaymentProcessingPreview();
            }
          }
        } catch (e) {

          // Clear invalid session data
          localStorage.removeItem('currentPaymentProcessingSession');
          window.currentPaymentProcessing = null;
          renderPaymentProcessingPreview();
        }
      } else {
        // No saved session, ensure currentPaymentProcessing is null
        window.currentPaymentProcessing = null;
        renderPaymentProcessingPreview();
      }

      // Get expected drawer count from supervisor's start of day count
      const drawer = drawers.find(d => d.id === selectedDrawer.id);
      let initialCount = { bills: {}, coins: {}, checks: [], cashTotal: 0, checksTotal: 0, total: 0 };
      if (drawer && drawer.lastCount) {
        initialCount = {
          bills: { ...drawer.lastCount.bills },
          coins: { ...drawer.lastCount.coins },
          checks: drawer.lastCount.checks ? [...drawer.lastCount.checks] : [],
          cashTotal: drawer.lastCount.cashTotal || 0,
          checksTotal: drawer.lastCount.checksTotal || 0,
          total: drawer.lastCount.total || 0
        };
      }

      window.currentPaymentProcessing = {
        id: sessionId,
        username: null, // Will be set when user code is entered
        userCode: null, // Will be set when user code is entered
        drawer: selectedDrawer ? {
          id: selectedDrawer.id,
          name: selectedDrawer.name
        } : null,
        startedAt: new Date().toISOString(),
        entries: [],
        register: {
          initial: initialCount, // Set initial count from supervisor's count
          closing: null,
          runningTotals: { cashIn: 0, cashOut: 0, checkIn: 0 }
        }
      };

      // Save session to localStorage
      try {
        if (window.currentPaymentProcessing) {
          const sessionJson = JSON.stringify(window.currentPaymentProcessing);
          localStorage.setItem('currentPaymentProcessingSession', sessionJson);

          // Also save to Firestore so supervisors can access it
          if (typeof savePaymentProcessingSessionToFirestore === 'function') {
            savePaymentProcessingSessionToFirestore(window.currentPaymentProcessing).catch(err => {
              console.error('[startNewPayment] Error saving session to Firestore:', err);
            });
          }
        } else {

        }
      } catch (e) {

      }

      const activeUserLabel = document.getElementById('activePaymentProcessingUser');
      if (activeUserLabel) activeUserLabel.textContent = '--';

      // Go directly to payment entry screen
      renderPaymentProcessingPreview();
      setPaymentProcessingViewState('entry');
      showPaymentProcessingEntryWithPreview();
    };

    window.cancelCurrentPaymentProcessing = function() {
      if (!window.currentPaymentProcessing) {
        setPaymentProcessingViewState('start');
        return;
      }

      // Save session to localStorage before closing
      try {
        if (window.currentPaymentProcessing) {
          const sessionJson = JSON.stringify(window.currentPaymentProcessing);
          localStorage.setItem('currentPaymentProcessingSession', sessionJson);

        } else {

        }
      } catch (e) {

      }

      // Note: This is cancelCurrentPaymentProcessing, so clearing is expected

      window.currentPaymentProcessing = null;
      renderPaymentProcessingPreview();
      setPaymentProcessingViewState('start');
      hideAllModules();
    };

    window.saveInitialRegisterCount = function() {
      if (!window.currentPaymentProcessing) {
        alert('Start a payment processing session first.');
        return;
      }

      const initial = calculateRegisterTotal('init');

      // Validate against expected drawer count if available
      if (selectedDrawer) {
        const drawer = drawers.find(d => d.id === selectedDrawer.id);
        if (drawer && drawer.lastCount) {
          const expectedTotal = drawer.lastCount.total || 0;
          const actualTotal = initial.total || 0;
          const difference = actualTotal - expectedTotal;

          if (Math.abs(difference) > 0.01) { // Allow for small floating point differences
            if (difference > 0) {
              alert(`Drawer count is OVER by $${difference.toFixed(2)}.\n\nExpected: $${expectedTotal.toFixed(2)}\nActual: $${actualTotal.toFixed(2)}\n\nPlease recount the drawer to match the expected amount.`);
            } else {
              alert(`Drawer count is SHORT by $${Math.abs(difference).toFixed(2)}.\n\nExpected: $${expectedTotal.toFixed(2)}\nActual: $${actualTotal.toFixed(2)}\n\nPlease recount the drawer to match the expected amount.`);
            }
            return; // Don't proceed if counts don't match
          }
        }
      }

      // Prompt for user code
      const userCode = prompt('Enter your user code:');
      if (!userCode || !userCode.trim()) {
        alert('User code is required to save the initial count.');
        return;
      }

      // Find user by code
      const user = users.find(u => u.userCode && u.userCode.trim().toLowerCase() === userCode.trim().toLowerCase());
      if (!user) {
        alert('User code not found. Please enter a valid user code.');
        return;
      }

      const userName = user.fullName || userCode;

      // Update session with user information
      const now = window.getCurrentDate();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);
      const usernameForId = userName.replace(/\s+/g, '');
      const sessionId = `${usernameForId}${dayOfYear}-${Date.now()}`;

      window.currentPaymentProcessing.id = sessionId;
      window.currentPaymentProcessing.username = userName;
      window.currentPaymentProcessing.userCode = userCode.trim();

      const activeUserLabel = document.getElementById('activePaymentProcessingUser');
      if (activeUserLabel) activeUserLabel.textContent = userName;

      window.currentPaymentProcessing.register.initial = {
        ...initial,
        recordedAt: new Date().toISOString()
      };
      window.currentPaymentProcessing.register.runningTotals = window.currentPaymentProcessing.register.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };
      renderPaymentProcessingPreview();
      setPaymentProcessingViewState('entry');
      addAnotherPaymentProcessingEntry();
    };

    window.addAnotherPaymentProcessingEntry = function() {
      if (!window.currentPaymentProcessing) {
        alert('Start a payment processing session before adding entries.');
        return;
      }

      setPaymentProcessingViewState('entry');
      debugPaymentProcessingDom('add-entry');
      resetPaymentProcessingEntryForm();

    };

    // Show closing register count screen
    window.showClosingRegisterCount = function() {

      // Use helper function to ensure session is available
      const session = window.ensurePaymentProcessingSession('showClosingRegisterCount');

      if (!session) {

        alert('Start a payment processing session first.');
        return;
      }

      // Ensure window object has the session
      if (window.currentPaymentProcessing !== session) {

        window.currentPaymentProcessing = session;
      }

      // CRITICAL: Ensure payment module is visible before trying to access DOM elements

      let paymentModuleEl = document.getElementById('paymentModule');
      if (!paymentModuleEl) {

        alert('Payment module not found. Please open the payment module first.');
        return;
      }

      // Make sure payment module is visible
      paymentModuleEl.classList.remove('hidden');
      paymentModuleEl.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';

      // Verify session properties exist

      if (!window.currentPaymentProcessing.register) {

        window.currentPaymentProcessing.register = {
          initial: null,
          closing: null,
          runningTotals: { cashIn: 0, cashOut: 0, checkIn: 0 }
        };
      }

      if (!window.currentPaymentProcessing.entries) {

        window.currentPaymentProcessing.entries = [];
      }

      // Update closing count title with drawer name

      const closingCountTitle = document.getElementById('closingCountTitle');
      if (closingCountTitle) {
        if (window.currentPaymentProcessing.drawer) {
          closingCountTitle.textContent = `Closing Register Count for ${window.currentPaymentProcessing.drawer.name}`;

      } else {
          closingCountTitle.textContent = 'Closing Register Count';

        }
      } else {

      }

      // Calculate and display expected values

      const running = window.currentPaymentProcessing.register.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };

      // Get expected initial total from drawer's lastCount (supervisor's start of day count) if available

      let expectedInitialCash = 0;
      let expectedInitialChecks = 0;
      let expectedInitialTotal = 0;

      try {
        if (window.currentPaymentProcessing.drawer) {

          const drawer = drawers.find(d => d.id === window.currentPaymentProcessing.drawer.id);
          if (drawer) {

            if (drawer.lastCount) {
              // Use supervisor's start of day count
              // Calculate cashTotal from bills and coins if not stored
              if (drawer.lastCount.cashTotal === undefined && drawer.lastCount.bills) {

                let calculatedCash = 0;
                [1,2,5,10,20,50,100].forEach(v => {
                  calculatedCash += (drawer.lastCount.bills[v] || 0) * v;
                });
                if (drawer.lastCount.coins) {
                  [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
                    calculatedCash += (drawer.lastCount.coins[k] || 0) * val;
                  });
                }
                expectedInitialCash = calculatedCash;

              } else {
                expectedInitialCash = drawer.lastCount.cashTotal || 0;

              }
              expectedInitialChecks = drawer.lastCount.checksTotal || 0;
              expectedInitialTotal = drawer.lastCount.total || 0;

            } else if (window.currentPaymentProcessing.register.initial) {
              // Fall back to register.initial if drawer count not available

              expectedInitialCash = window.currentPaymentProcessing.register.initial.cashTotal || 0;
              expectedInitialChecks = window.currentPaymentProcessing.register.initial.checksTotal || 0;
              expectedInitialTotal = expectedInitialCash + expectedInitialChecks;

            } else {

            }
          } else {

          }
        } else if (window.currentPaymentProcessing.register.initial) {

          expectedInitialCash = window.currentPaymentProcessing.register.initial.cashTotal || 0;
          expectedInitialChecks = window.currentPaymentProcessing.register.initial.checksTotal || 0;
          expectedInitialTotal = expectedInitialCash + expectedInitialChecks;

        } else {

        }
      } catch (e) {

      }

      const expectedPaymentCash = (running.cashIn || 0) - (running.cashOut || 0);
      const expectedPaymentChecks = running.checkIn || 0;
      const expectedPaymentTotal = expectedPaymentCash + expectedPaymentChecks;

      const expectedPaymentTotalEl = document.getElementById('expectedPaymentTotal');
      if (expectedPaymentTotalEl) {
        expectedPaymentTotalEl.textContent = `Expected Payment Total: $${expectedPaymentTotal.toFixed(2)} (received cash ${expectedPaymentCash.toFixed(2)}, received checks ${expectedPaymentChecks.toFixed(2)})`;

      } else {

      }

      const expectedInitialTotalEl = document.getElementById('expectedInitialTotal');
      if (expectedInitialTotalEl) {
        expectedInitialTotalEl.textContent = `Expected Initial Total: $${expectedInitialTotal.toFixed(2)} (initial cash ${expectedInitialCash.toFixed(2)}, initial checks ${expectedInitialChecks.toFixed(2)})`;

      } else {

      }

      // Show recount section

      const recountSectionCheck = document.getElementById('registerRecountSection');
      if (!recountSectionCheck) {

        alert('Recount section is missing. The payment module may need to be refreshed. Please try opening the payment module again.');
        return;
      }

      const step1Check = document.getElementById('recountStep1');
      const step2Check = document.getElementById('recountStep2');
      const btn1Check = document.getElementById('recountStep1Btn');
      const btn2Check = document.getElementById('recountStep2Btn');

      if (!step1Check || !step2Check || !btn1Check || !btn2Check) {

        alert('Recount section structure is incomplete. Please refresh the page.');
        return;
      }

      try {
        setPaymentProcessingViewState('recount');

        // Double-check the section is visible
        const recountSectionVisible = !recountSectionCheck.classList.contains('hidden');

        if (recountSectionCheck.style && recountSectionCheck.style.cssText) {

          recountSectionCheck.style.cssText = '';
        }
        if (!recountSectionVisible) {

          recountSectionCheck.classList.remove('hidden');
          recountSectionCheck.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
        }
      } catch (e) {

      }

      try {
        switchRecountStep(1);

        // Final verification - check if step 1 is actually visible
        setTimeout(() => {
          const step1Final = document.getElementById('recountStep1');
          const step1Visible = step1Final && !step1Final.classList.contains('hidden');

          if (!step1Visible) {

          }
        }, 100);

      } catch (e) {

        alert('Error displaying closing register count. Please try again.');
      }
    };

    // Back to payment processing entry from recount
    window.backToPaymentProcessingEntryFromRecount = function() {
      setPaymentProcessingViewState('preview');
    };

    window.togglePaymentInputs = function() {
      const type = document.getElementById('paymentType')?.value;
      const cashContainer = document.getElementById('cashInputsContainer');
      const checkContainer = document.getElementById('checkInputsContainer');
      if (cashContainer) cashContainer.classList.add('hidden');
      if (checkContainer) checkContainer.classList.add('hidden');
      if (type === 'Cash') {
        if (cashContainer) cashContainer.classList.remove('hidden');
        updateCashChangeDisplay();
      } else if (type === 'Check') {
        if (checkContainer) {
          checkContainer.classList.remove('hidden');
          updateCheckChangeDisplay(); // This will show/hide change vs credit based on dropdown
        }
      }
    };

    window.updateCashChangeDisplay = function() {
      const paymentAmount = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
      const cashReceived = parseFloat(document.getElementById('cashReceivedInput')?.value) || paymentAmount;
      const change = Math.max(0, cashReceived - paymentAmount);
      const display = document.getElementById('cashChangeDisplay');
      if (display) display.value = change.toFixed(2);
    };

    window.updateCheckChangeDisplay = function() {
      const paymentAmount = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
      const checkReceived = parseFloat(document.getElementById('checkReceivedInput')?.value) || paymentAmount;
      const overpayment = Math.max(0, checkReceived - paymentAmount);
      const handling = document.getElementById('checkOverpaymentHandling')?.value || '';

      const changeContainer = document.getElementById('checkChangeDueContainer');
      const creditContainer = document.getElementById('checkCreditDueContainer');
      const changeDisplay = document.getElementById('checkChangeDisplay');
      const creditDisplay = document.getElementById('checkCreditDisplay');

      // If no handling selected, hide both containers
      if (!handling) {
        if (changeContainer) changeContainer.classList.add('hidden');
        if (creditContainer) creditContainer.classList.add('hidden');
        if (changeDisplay) changeDisplay.value = '0.00';
        if (creditDisplay) creditDisplay.value = '0.00';
        return;
      }

      if (handling === 'change') {
        // Show change due, hide credit due
        if (changeContainer) changeContainer.classList.remove('hidden');
        if (creditContainer) creditContainer.classList.add('hidden');
        if (changeDisplay) changeDisplay.value = overpayment.toFixed(2);
        if (creditDisplay) creditDisplay.value = '0.00';
      } else {
        // Show credit due, hide change due
        if (changeContainer) changeContainer.classList.add('hidden');
        if (creditContainer) creditContainer.classList.remove('hidden');
        if (creditDisplay) creditDisplay.value = overpayment.toFixed(2);
        if (changeDisplay) changeDisplay.value = '0.00';
      }
    };

    function renderPaymentProcessingSessionsOnlyView() {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule) {

        return;
      }

      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Processing</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="paymentProcessingSessionsListSection" data-payment-processing-section="list" class="mt-4">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Submitted Sessions</h4>
            <button onclick="closePaymentProcessingSessionsList()" class="text-sm text-slate-500 hover:text-slate-700">Close</button>
          </div>
          <div class="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-inner">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Batch ID</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">User</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Entries</th>
                  <th class="px-4 py-2 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Amount</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Submitted</th>
                  <th class="px-4 py-2 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="paymentProcessingSessionsListTable" class="bg-white divide-y divide-slate-200">
                <tr>
                  <td colspan="6" class="px-4 py-3 text-center text-sm text-slate-500">No sessions submitted yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    window.viewPaymentProcessingSessions = async function() {

      // Ensure payment module is visible
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule) {

        return;
      }

      paymentModule.classList.remove('hidden');
      paymentModule.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';

      // Rebuild the module UI to only show the sessions list
      renderPaymentProcessingSessionsOnlyView();

      await loadPaymentProcessingSessionsFromFirestore();
      renderPaymentProcessingSessionsList();

    };

    window.closePaymentProcessingSessionsList = function() {
      resetPaymentForm();

    };

    window.submitCurrentPaymentProcessing = async function() {
      if (!window.currentPaymentProcessing) {
        alert('Start a payment processing session before submitting.');
        return;
      }

      if (window.currentPaymentProcessing.entries.length === 0) {
        alert('Add at least one payment to the session.');
        return;
      }

      if (!window.currentPaymentProcessing.register || !window.currentPaymentProcessing.register.initial) {
        alert('Please record the initial register count before submitting.');
        return;
      }

      const running = window.currentPaymentProcessing.register.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };

      // Get expected initial total from drawer's lastCount (supervisor's start of day count) if available
      let initialCash = 0;
      let initialChecks = 0;
      let expectedInitialTotal = 0;

      if (window.currentPaymentProcessing.drawer) {
        const drawer = drawers.find(d => d.id === window.currentPaymentProcessing.drawer.id);
        if (drawer && drawer.lastCount) {
          // Use supervisor's start of day count
          // Calculate cashTotal from bills and coins if not stored
          if (drawer.lastCount.cashTotal === undefined && drawer.lastCount.bills) {
            let calculatedCash = 0;
            [1,2,5,10,20,50,100].forEach(v => {
              calculatedCash += (drawer.lastCount.bills[v] || 0) * v;
            });
            if (drawer.lastCount.coins) {
              [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
                calculatedCash += (drawer.lastCount.coins[k] || 0) * val;
              });
            }
            initialCash = calculatedCash;
          } else {
            initialCash = drawer.lastCount.cashTotal || 0;
          }
          initialChecks = drawer.lastCount.checksTotal || 0;
          expectedInitialTotal = drawer.lastCount.total || 0;
        } else if (window.currentPaymentProcessing.register.initial) {
          // Fall back to register.initial if drawer count not available
          initialCash = window.currentPaymentProcessing.register.initial.cashTotal || 0;
          initialChecks = window.currentPaymentProcessing.register.initial.checksTotal || 0;
          expectedInitialTotal = initialCash + initialChecks;
        }
      } else if (window.currentPaymentProcessing.register.initial) {
        initialCash = window.currentPaymentProcessing.register.initial.cashTotal || 0;
        initialChecks = window.currentPaymentProcessing.register.initial.checksTotal || 0;
        expectedInitialTotal = initialCash + initialChecks;
      }

      const expectedCash = initialCash + (running.cashIn || 0) - (running.cashOut || 0);
      const expectedChecks = initialChecks + (running.checkIn || 0);
      const expectedTotal = expectedCash + expectedChecks;
      const receivedCash = (running.cashIn || 0) - (running.cashOut || 0);
      const receivedChecks = running.checkIn || 0;

      // Populate expected values for Step 1 (Initial Count)
      const expectedInitialTotalText = document.getElementById('expectedInitialTotal');
      if (expectedInitialTotalText) {
        expectedInitialTotalText.innerHTML =
          `<strong>Expected Initial Total:</strong> $${expectedInitialTotal.toFixed(2)} (initial cash ${initialCash.toFixed(2)}, initial checks ${initialChecks.toFixed(2)})`;
      }

      // Populate expected values for Step 2 (Payment Count)
      const expectedPaymentTotal = receivedCash + receivedChecks;
      const expectedPaymentTotalText = document.getElementById('expectedPaymentTotal');
      if (expectedPaymentTotalText) {
        expectedPaymentTotalText.innerHTML =
          `<strong>Expected Payment Total:</strong> $${expectedPaymentTotal.toFixed(2)} (received cash ${receivedCash.toFixed(2)}, received checks ${receivedChecks.toFixed(2)})`;
      }

      // Reset recount step to 1
      switchRecountStep(1);
      // Update closing count title with drawer name
      const closingCountTitle = document.getElementById('closingCountTitle');
      if (closingCountTitle && window.currentPaymentProcessing && window.currentPaymentProcessing.drawer) {
        closingCountTitle.textContent = `Closing Register Count for ${window.currentPaymentProcessing.drawer.name}`;
      } else if (closingCountTitle) {
        closingCountTitle.textContent = 'Closing Register Count';
      }

      setPaymentProcessingViewState('recount');
      // Force-hide entry/preview when moving to recount
      ['paymentProcessingEntrySection','paymentProcessingPreviewSection','paymentProcessingStartSection','registerCountSection','paymentProcessingSessionsListSection'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.add('hidden');
          el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
        }
      });
      const recount = document.getElementById('registerRecountSection');
      if (recount) {
        recount.classList.remove('hidden');
        recount.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    window.backToPaymentProcessingEntryFromRecount = function() {
      if (!window.currentPaymentProcessing) {
        setPaymentProcessingViewState('start');
        return;
      }
      setPaymentProcessingViewState('preview');
    };

    window.switchRecountStep = function(step) {

      // Validate initial count before proceeding to step 2
      if (step === 2) {

        if (!window.currentPaymentProcessing || !window.currentPaymentProcessing.register) {

          alert('No payment processing session data found.');
          return;
        }

        // Get expected initial total from drawer's lastCount or register.initial
        let expectedInitialTotal = 0;
        if (window.currentPaymentProcessing.drawer) {
          const drawer = drawers.find(d => d.id === window.currentPaymentProcessing.drawer.id);
          if (drawer && drawer.lastCount) {
            // Use the total from lastCount
            expectedInitialTotal = drawer.lastCount.total || 0;
            // If total is not set but we have bills/coins, calculate it
            if (!expectedInitialTotal && drawer.lastCount.bills) {
              let calculatedTotal = 0;
              [1,2,5,10,20,50,100].forEach(v => {
                calculatedTotal += (drawer.lastCount.bills[v] || 0) * v;
              });
              if (drawer.lastCount.coins) {
                [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
                  calculatedTotal += (drawer.lastCount.coins[k] || 0) * val;
                });
              }
              expectedInitialTotal = calculatedTotal;
            }
          } else if (window.currentPaymentProcessing.register.initial) {
            expectedInitialTotal = (window.currentPaymentProcessing.register.initial.cashTotal || 0) + (window.currentPaymentProcessing.register.initial.checksTotal || 0);
          }
        } else if (window.currentPaymentProcessing.register.initial) {
          expectedInitialTotal = (window.currentPaymentProcessing.register.initial.cashTotal || 0) + (window.currentPaymentProcessing.register.initial.checksTotal || 0);
        }

        const initialCountTotal = calculateRecountTotal('initial');

        const initialVariance = initialCountTotal - expectedInitialTotal;

        if (Math.abs(initialVariance) > 0.01) {
          const statusMsg = `Initial count ${initialVariance > 0 ? 'over' : 'short'} by $${Math.abs(initialVariance).toFixed(2)}. Please correct the count before continuing.`;

          alert(statusMsg);
          return;
        }

      }

      const step1 = document.getElementById('recountStep1');
      const step2 = document.getElementById('recountStep2');
      const btn1 = document.getElementById('recountStep1Btn');
      const btn2 = document.getElementById('recountStep2Btn');

      if (!step1 || !step2 || !btn1 || !btn2) {

        const recountSection = document.getElementById('registerRecountSection');

        if (recountSection) {

        }
        alert('Recount section elements are missing. Please refresh the page.');
        return;
      }

      if (step === 1) {

        if (step1) {
          step1.classList.remove('hidden');

        }
        if (step2) {
          step2.classList.add('hidden');

        }
        if (btn1) {
          btn1.classList.remove('bg-slate-200', 'text-slate-700');
          btn1.classList.add('bg-green-600', 'text-white');

        }
        if (btn2) {
          btn2.classList.remove('bg-green-600', 'text-white');
          btn2.classList.add('bg-slate-200', 'text-slate-700');

        }

      } else if (step === 2) {

        if (step1) {
          step1.classList.add('hidden');

        }
        if (step2) {
          step2.classList.remove('hidden');

        }
        if (btn1) {
          btn1.classList.remove('bg-green-600', 'text-white');
          btn1.classList.add('bg-slate-200', 'text-slate-700');

        }
        if (btn2) {
          btn2.classList.remove('bg-slate-200', 'text-slate-700');
          btn2.classList.add('bg-green-600', 'text-white');

        }

      }

    };

    window.calculateRecountTotal = function(type) {
      let total = 0;
      const prefix = type === 'payment' ? 'payment' : 'initial_recount';

      // Calculate bills
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`${prefix}_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          total += count * v;
        }
      });

      // Calculate coins
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const input = document.getElementById(`${prefix}_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          total += count * val;
        }
      });

      // Calculate checks
      const checksContainer = document.getElementById(`${prefix}_checksContainer`);
      if (checksContainer) {
        const checkInputs = checksContainer.querySelectorAll('input[type="number"]');
        checkInputs.forEach(input => {
          const amount = parseFloat(input.value) || 0;
          total += amount;
        });
      }

      // Update display
      const totalElement = document.getElementById(type === 'payment' ? 'paymentRecountTotal' : 'initialRecountTotal');
      if (totalElement) {
        totalElement.textContent = `${type === 'payment' ? 'Payment' : 'SOD Fund'} Total: $${total.toFixed(2)}`;
      }

      return total;
    };

    // Print SOD Fund Count Receipt (Step 1)
    window.printSODCountReceipt = function() {
      if (!window.currentPaymentProcessing || !window.currentPaymentProcessing.drawer) {
        alert('No drawer information available');
        return;
      }

      const drawer = window.currentPaymentProcessing.drawer;
      const today = window.getCurrentDate();
      const dateStr = today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Read current count values
      const bills = {};
      const coins = {};
      let total = 0;

      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`initial_recount_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          bills[v] = count;
          total += count * v;
        }
      });

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        const input = document.getElementById(`initial_recount_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          coins[k] = count;
          total += count * val;
        }
      });

      // Build receipt HTML
      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>SOD Fund Count Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
          </style>
        </head>
        <body>
          <h1>${drawer.name} - SOD Fund Count Receipt</h1>
          <div class="info">
            <p><strong>Date:</strong> ${dateStr}</p>
            <p><strong>Counted by:</strong> ${window.currentPaymentProcessing.username || 'Cashier'}</p>
          </div>
          <h3>Bills</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [1,2,5,10,20,50,100].forEach(v => {
        const billCount = bills[v] || 0;
        if (billCount > 0) {
          const amount = billCount * v;
          receiptHtml += `<tr><td>$${v}</td><td>${billCount}</td><td>$${amount.toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <h3>Coins</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        const coinCount = coins[k] || 0;
        if (coinCount > 0) {
          const amount = coinCount * val;
          receiptHtml += `<tr><td>${label}</td><td>${coinCount}</td><td>$${amount.toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <div class="total">Total: $${total.toFixed(2)}</div>
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin-top: 30px;">Initials: _____________</p>
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    // Print Payment Count Receipt (Step 2)
    window.printPaymentCountReceipt = function() {
      if (!window.currentPaymentProcessing || !window.currentPaymentProcessing.drawer) {
        alert('No drawer information available');
        return;
      }

      const drawer = window.currentPaymentProcessing.drawer;
      const today = window.getCurrentDate();
      const dateStr = today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Read current count values
      const bills = {};
      const coins = {};
      const checks = [];
      let total = 0;

      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`payment_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          bills[v] = count;
          total += count * v;
        }
      });

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        const input = document.getElementById(`payment_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          coins[k] = count;
          total += count * val;
        }
      });

      // Calculate checks
      const checksContainer = document.getElementById('payment_checksContainer');
      if (checksContainer) {
        const checkRows = checksContainer.querySelectorAll('div.flex.items-center');
        checkRows.forEach(row => {
          const numberInput = row.querySelector('input[data-check-number]');
          const amountInput = row.querySelector('input[data-check-amount]');
          if (numberInput && amountInput) {
            const checkNumber = numberInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;
            if (amount > 0) {
              checks.push({
                number: checkNumber || null,
                amount: amount
              });
              total += amount;
            }
          }
        });
      }

      // Build receipt HTML
      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Payment Count Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
          </style>
        </head>
        <body>
          <h1>${drawer.name} - Payment Count Receipt</h1>
          <div class="info">
            <p><strong>Date:</strong> ${dateStr}</p>
            <p><strong>Counted by:</strong> ${window.currentPaymentProcessing.username || 'Cashier'}</p>
          </div>
          <h3>Bills</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [1,2,5,10,20,50,100].forEach(v => {
        const billCount = bills[v] || 0;
        if (billCount > 0) {
          const amount = billCount * v;
          receiptHtml += `<tr><td>$${v}</td><td>${billCount}</td><td>$${amount.toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <h3>Coins</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        const coinCount = coins[k] || 0;
        if (coinCount > 0) {
          const amount = coinCount * val;
          receiptHtml += `<tr><td>${label}</td><td>${coinCount}</td><td>$${amount.toFixed(2)}</td></tr>`;
        }
      });

      if (checks.length > 0) {
        receiptHtml += `
          </table>
          <h3>Checks</h3>
          <table>
            <tr><th>Check #</th><th>Amount</th></tr>
        `;
        checks.forEach((check, idx) => {
          const checkNumber = (typeof check === 'object' && check.number) ? check.number : (check.number || `Check #${idx + 1}`);
          const amount = (typeof check === 'object' && check.amount !== undefined) ? check.amount : check;
          receiptHtml += `<tr><td>${checkNumber || `Check #${idx + 1}`}</td><td>$${Number(amount).toFixed(2)}</td></tr>`;
        });
      }

      receiptHtml += `
          </table>
          <div class="total">Total: $${total.toFixed(2)}</div>
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin-top: 30px;">Initials: _____________</p>
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    window.finalizePaymentProcessingWithRecount = async function() {

      if (!window.currentPaymentProcessing) {

        alert('Start a payment processing session before submitting.');
        return;
      }

      // Prompt for user code and verify it matches the initial one
      const userCode = prompt('Enter your user code to submit the batch:');
      if (!userCode || !userCode.trim()) {
        alert('User code is required to submit the batch.');
        return;
      }

      // Verify user code matches the one entered at the start
      if (window.currentPaymentProcessing.userCode && 
          window.currentPaymentProcessing.userCode.trim().toLowerCase() !== userCode.trim().toLowerCase()) {
        alert('User code does not match the one entered at the start of this session. Please enter the correct user code.');
        return;
      }

      // If no user code was set initially (shouldn't happen, but handle gracefully)
      if (!window.currentPaymentProcessing.userCode) {
        // Find user by code
        const user = users.find(u => u.userCode && u.userCode.trim().toLowerCase() === userCode.trim().toLowerCase());
        if (!user) {
          alert('User code not found. Please enter a valid user code.');
          return;
        }
        window.currentPaymentProcessing.username = user.fullName || userCode;
        window.currentPaymentProcessing.userCode = userCode.trim();
      }

      const running = window.currentPaymentProcessing.register.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };

      // Get expected initial total from drawer's lastCount (supervisor's start of day count) if available
      let expectedInitialCash = 0;
      let expectedInitialChecks = 0;
      let expectedInitialTotal = 0;

      if (window.currentPaymentProcessing.drawer) {
        const drawer = drawers.find(d => d.id === window.currentPaymentProcessing.drawer.id);
        if (drawer && drawer.lastCount) {
          // Calculate cashTotal from bills and coins if not stored
          if (drawer.lastCount.cashTotal === undefined && drawer.lastCount.bills) {
            let calculatedCash = 0;
            [1,2,5,10,20,50,100].forEach(v => {
              calculatedCash += (drawer.lastCount.bills[v] || 0) * v;
            });
            if (drawer.lastCount.coins) {
              [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
                calculatedCash += (drawer.lastCount.coins[k] || 0) * val;
              });
            }
            expectedInitialCash = calculatedCash;
          } else {
            expectedInitialCash = drawer.lastCount.cashTotal || 0;
          }
          expectedInitialChecks = drawer.lastCount.checksTotal || 0;
          expectedInitialTotal = drawer.lastCount.total || 0;
          // If total is not set but we have cashTotal, use that
          if (!expectedInitialTotal && expectedInitialCash) {
            expectedInitialTotal = expectedInitialCash + expectedInitialChecks;
          }
        } else if (window.currentPaymentProcessing.register.initial) {
          // Fall back to register.initial if drawer count not available
          expectedInitialCash = window.currentPaymentProcessing.register.initial.cashTotal || 0;
          expectedInitialChecks = window.currentPaymentProcessing.register.initial.checksTotal || 0;
          expectedInitialTotal = expectedInitialCash + expectedInitialChecks;
        }
      } else if (window.currentPaymentProcessing.register.initial) {
        expectedInitialCash = window.currentPaymentProcessing.register.initial.cashTotal || 0;
        expectedInitialChecks = window.currentPaymentProcessing.register.initial.checksTotal || 0;
        expectedInitialTotal = expectedInitialCash + expectedInitialChecks;
      }

      // Calculate expected values
      const expectedPaymentCash = (running.cashIn || 0) - (running.cashOut || 0);
      const expectedPaymentChecks = running.checkIn || 0;
      const expectedPaymentTotal = expectedPaymentCash + expectedPaymentChecks;

      const expectedTotal = expectedInitialTotal + expectedPaymentTotal;

      // Get counted values
      const paymentCountTotal = calculateRecountTotal('payment');
      const initialCountTotal = calculateRecountTotal('initial');

      // Collect payment count details FIRST to validate cash and checks separately
      const paymentCount = {
        bills: {},
        coins: {},
        checks: [],
        cashTotal: 0,
        checksTotal: 0,
        total: paymentCountTotal
      };
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`payment_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          paymentCount.bills[v] = count;
          paymentCount.cashTotal += count * v;
        }
      });
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const input = document.getElementById(`payment_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          paymentCount.coins[k] = count;
          paymentCount.cashTotal += count * val;
        }
      });
      const paymentChecksContainer = document.getElementById('payment_checksContainer');
      if (paymentChecksContainer) {
        const checkRows = paymentChecksContainer.querySelectorAll('div.flex.items-center');
        checkRows.forEach(row => {
          const numberInput = row.querySelector('input[data-check-number]');
          const amountInput = row.querySelector('input[data-check-amount]');
          if (numberInput && amountInput) {
            const checkNumber = numberInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;
            if (amount > 0) {
              paymentCount.checks.push({
                number: checkNumber || null,
                amount: amount
              });
              paymentCount.checksTotal += amount;
            }
          }
        });
      }

      // Validate check numbers against processed payments
      const expectedCheckNumbers = (window.currentPaymentProcessing.entries || [])
        .filter(entry => entry.paymentType === 'Check')
        .map(entry => (entry.checkNumber || '').trim())
        .filter(num => num.length > 0);

      if (expectedCheckNumbers.length > 0) {
        const missingNumbers = paymentCount.checks.filter(c => !c.number || !c.number.trim());
        if (missingNumbers.length > 0) {
          const statusMsg = `Each check must include a check number to close out the drawer.\n\nMissing check numbers: ${missingNumbers.length}`;
          showPaymentCountErrorModal('Check Number Required', statusMsg);
          return;
        }

        const countedNumbers = paymentCount.checks.map(c => c.number.trim());
        const normalize = list => list.slice().sort((a, b) => a.localeCompare(b));
        const expectedSorted = normalize(expectedCheckNumbers);
        const countedSorted = normalize(countedNumbers);

        const isMatch = expectedSorted.length === countedSorted.length &&
          expectedSorted.every((val, idx) => val === countedSorted[idx]);

        if (!isMatch) {
          const statusMsg = `Check numbers do not match the processed payments.\n\nExpected: ${expectedSorted.join(', ')}\nCounted: ${countedSorted.join(', ')}`;
          showPaymentCountErrorModal('Check Number Mismatch', statusMsg);
          return;
        }
      }

      // Validate payment count - check cash and checks separately
      const actualPaymentCash = paymentCount.cashTotal;
      const actualPaymentChecks = paymentCount.checksTotal;

      const paymentCashVariance = actualPaymentCash - expectedPaymentCash;
      const paymentChecksVariance = actualPaymentChecks - expectedPaymentChecks;
      const paymentVariance = paymentCountTotal - expectedPaymentTotal;
      const initialVariance = initialCountTotal - expectedInitialTotal;
      const totalVariance = (initialCountTotal + paymentCountTotal) - expectedTotal;

      // Check payment cash count
      if (Math.abs(paymentCashVariance) > 0.01) {
        const statusMsg = `Payment cash count ${paymentCashVariance > 0 ? 'over' : 'short'} by $${Math.abs(paymentCashVariance).toFixed(2)}.\n\nExpected Cash Total: $${expectedPaymentCash.toFixed(2)}\nYour Cash Count: $${actualPaymentCash.toFixed(2)}\n\nPlease correct the count and try again.`;
        showPaymentCountErrorModal('Payment Cash Count Error', statusMsg);
        return;
      }

      // Check payment checks count
      if (Math.abs(paymentChecksVariance) > 0.01) {
        const statusMsg = `Payment checks count ${paymentChecksVariance > 0 ? 'over' : 'short'} by $${Math.abs(paymentChecksVariance).toFixed(2)}.\n\nExpected Checks Total: $${expectedPaymentChecks.toFixed(2)}\nYour Checks Count: $${actualPaymentChecks.toFixed(2)}\n\nPlease correct the count and try again.`;
        showPaymentCountErrorModal('Payment Checks Count Error', statusMsg);
        return;
      }

      // Check payment total count (backup check)
      if (Math.abs(paymentVariance) > 0.01) {
        const statusMsg = `Payment count ${paymentVariance > 0 ? 'over' : 'short'} by $${Math.abs(paymentVariance).toFixed(2)}. Please try again.`;
        showPaymentCountErrorModal('Payment Count Error', statusMsg);
        return;
      }

      // Check initial count
      if (Math.abs(initialVariance) > 0.01) {
        const statusMsg = `Initial count ${initialVariance > 0 ? 'over' : 'short'} by $${Math.abs(initialVariance).toFixed(2)}.\n\nExpected Initial Total: $${expectedInitialTotal.toFixed(2)}\nYour Count: $${initialCountTotal.toFixed(2)}\n\nPlease correct the count and try again.`;
        showPaymentCountErrorModal('Initial Count Error', statusMsg);
        return;
      }

      // Collect initial count details
      const initialCount = {
        bills: {},
        coins: {},
        checks: [],
        cashTotal: 0,
        checksTotal: 0,
        total: initialCountTotal
      };
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`initial_recount_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          initialCount.bills[v] = count;
          initialCount.cashTotal += count * v;
        }
      });
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const input = document.getElementById(`initial_recount_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          initialCount.coins[k] = count;
          initialCount.cashTotal += count * val;
        }
      });
      const initialChecksContainer = document.getElementById('initial_recount_checksContainer');
      if (initialChecksContainer) {
        const checkRows = initialChecksContainer.querySelectorAll('div.flex.items-center');
        checkRows.forEach(row => {
          const numberInput = row.querySelector('input[data-check-number]');
          const amountInput = row.querySelector('input[data-check-amount]');
          if (numberInput && amountInput) {
            const checkNumber = numberInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;
            if (amount > 0) {
              initialCount.checks.push({
                number: checkNumber || null,
                amount: amount
              });
              initialCount.checksTotal += amount;
            }
          }
        });
      }

      window.currentPaymentProcessing.register.closing = {
        paymentCount,
        initialCount,
        recordedAt: new Date().toISOString(),
        expectedPaymentTotal,
        expectedInitialTotal,
        expectedTotal,
        paymentVariance,
        initialVariance,
        variance: totalVariance
      };

      const totalAmount = window.currentPaymentProcessing.entries.reduce((sum, entry) => sum + entry.amount, 0);
      const submittedSession = {
        ...window.currentPaymentProcessing,
        submittedAt: new Date().toISOString(),
        totalAmount
      };

      // Add to local array first
      window.paymentProcessingSessions.push(submittedSession);

      // Save to Firestore

      await savePaymentProcessingSessionToFirestore(submittedSession);

      // Small delay to ensure Firestore write propagates
      await new Promise(resolve => setTimeout(resolve, 500));

      // Reload from Firestore to get fresh data

      await loadPaymentProcessingSessionsFromFirestore();

      // Show custom success modal instead of alert
      showPaymentSubmissionSuccessModal(submittedSession);

      // Clear saved session from localStorage
      try {
        localStorage.removeItem('currentPaymentProcessingSession');
      } catch (e) {

      }

      // Clear current payment processing session
      window.currentPaymentProcessing = null;

      // Clear the preview table to show no payments
      renderPaymentProcessingPreview();
      renderPaymentProcessingSessionsList();
      setPaymentProcessingViewState('list');

      viewPaymentProcessingSessions();

    };

    // Payment Submission Success Modal Functions
    let lastSubmittedPaymentSession = null;

    window.showPaymentSubmissionSuccessModal = function(session) {
      lastSubmittedPaymentSession = session;
      const modal = document.getElementById('paymentSubmissionSuccessModal');
      if (modal) {
        modal.classList.remove('hidden');
      }
    };

    window.hidePaymentSubmissionSuccessModal = function() {
      const modal = document.getElementById('paymentSubmissionSuccessModal');
      if (modal) {
        modal.classList.add('hidden');
      }
      lastSubmittedPaymentSession = null;
    };

    window.printPaymentSubmissionReceipt = function() {
      if (!lastSubmittedPaymentSession) {
        alert('No payment session data available');
        return;
      }

      const session = lastSubmittedPaymentSession;
      const drawer = session.drawer;
      const drawerName = drawer ? drawer.name : 'Unknown Drawer';
      const today = new Date();
      const dateStr = today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const closing = session.register?.closing;
      const initialCount = closing?.initialCount;
      const paymentCount = closing?.paymentCount;

      // Build receipt HTML
      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Payment Processing Session Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
            .section { margin-top: 30px; }
          </style>
        </head>
        <body>
          <h1>${drawerName} - Payment Processing Session</h1>
          <h2>End Of Day Receipt</h2>
          <div class="info">
            <p><strong>Date:</strong> ${dateStr}</p>
            <p><strong>Processed by:</strong> ${session.username || 'Cashier'}</p>
            <p><strong>Session ID:</strong> ${session.id}</p>
            <p><strong>Total Amount:</strong> $${session.totalAmount?.toFixed(2) || '0.00'}</p>
            <p><strong>Entries:</strong> ${session.entries?.length || 0}</p>
          </div>
      `;

      // Add SOD Fund Count section
      if (initialCount) {
        receiptHtml += `
          <div class="section">
            <h3>SOD Fund Count</h3>
            <table>
              <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
        `;
        [1,2,5,10,20,50,100].forEach(v => {
          const count = initialCount.bills?.[v] || 0;
          if (count > 0) {
            receiptHtml += `<tr><td>$${v}</td><td>${count}</td><td>$${(count * v).toFixed(2)}</td></tr>`;
          }
        });
        [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
          const count = initialCount.coins?.[k] || 0;
          if (count > 0) {
            receiptHtml += `<tr><td>${label}</td><td>${count}</td><td>$${(count * val).toFixed(2)}</td></tr>`;
          }
        });
        if (initialCount.checks && initialCount.checks.length > 0) {

          initialCount.checks.forEach((check, idx) => {
            const isObj = typeof check === 'object' && check !== null;
            const rawNumber = isObj ? check.number : null;
            const displayNumber = rawNumber ? `Check #${rawNumber}` : `Check #${idx + 1}`;
            const amount = isObj ? check.amount : check;

            receiptHtml += `<tr><td>${displayNumber}</td><td>1</td><td>$${Number(amount || 0).toFixed(2)}</td></tr>`;
          });
        }
        receiptHtml += `
            </table>
            <div class="total">SOD Fund Total: $${(initialCount.total || 0).toFixed(2)}</div>
          </div>
        `;
      }

      // Add Payment Count section
      if (paymentCount) {
        receiptHtml += `
          <div class="section">
            <h3>Payment Count</h3>
            <table>
              <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
        `;
        [1,2,5,10,20,50,100].forEach(v => {
          const count = paymentCount.bills?.[v] || 0;
          if (count > 0) {
            receiptHtml += `<tr><td>$${v}</td><td>${count}</td><td>$${(count * v).toFixed(2)}</td></tr>`;
          }
        });
        [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
          const count = paymentCount.coins?.[k] || 0;
          if (count > 0) {
            receiptHtml += `<tr><td>${label}</td><td>${count}</td><td>$${(count * val).toFixed(2)}</td></tr>`;
          }
        });
        if (paymentCount.checks && paymentCount.checks.length > 0) {

          paymentCount.checks.forEach((check, idx) => {
            const isObj = typeof check === 'object' && check !== null;
            const rawNumber = isObj ? check.number : null;
            const displayNumber = rawNumber ? `Check #${rawNumber}` : `Check #${idx + 1}`;
            const amount = isObj ? check.amount : check;

            receiptHtml += `<tr><td>${displayNumber}</td><td>1</td><td>$${Number(amount || 0).toFixed(2)}</td></tr>`;
          });
        }
        receiptHtml += `
            </table>
            <div class="total">Payment Total: $${(paymentCount.total || 0).toFixed(2)}</div>
          </div>
        `;
      }

      receiptHtml += `
          <div class="section">
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
              <p style="margin-top: 30px;">Initials: _____________</p>
            </div>
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    // EOD Verification Success Modal Functions
    let lastEODVerifiedSession = null;

    window.showEODVerificationSuccessModal = function(session, initialMsg, paymentMsg, verifiedByName) {
      lastEODVerifiedSession = { session, initialMsg, paymentMsg, verifiedByName };
      const modal = document.getElementById('eodVerificationSuccessModal');
      const content = document.getElementById('eodVerificationSuccessContent');

      if (modal && content) {
        // Populate content
        let contentHtml = '';
        if (initialMsg) {
          contentHtml += `<p class="font-medium">${initialMsg}</p>`;
        }
        if (paymentMsg) {
          contentHtml += `<p class="font-medium">${paymentMsg}</p>`;
        }
        contentHtml += `<p class="font-medium mt-2">Verified by: ${verifiedByName}</p>`;
        content.innerHTML = contentHtml;

        modal.classList.remove('hidden');
      }
    };

    window.hideEODVerificationSuccessModal = function() {
      const modal = document.getElementById('eodVerificationSuccessModal');
      if (modal) {
        modal.classList.add('hidden');
      }
      lastEODVerifiedSession = null;
    };

    window.printEODVerificationReceipt = function() {
      if (!lastEODVerifiedSession) {
        alert('No verification data available');
        return;
      }

      const { session, initialMsg, paymentMsg, verifiedByName } = lastEODVerifiedSession;
      const drawer = session.drawer;
      const drawerName = drawer ? drawer.name : 'Unknown Drawer';
      const verifiedDate = session.verifiedAt ? new Date(session.verifiedAt).toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : new Date().toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const supervisorCount = session.supervisorCount;
      const posInitialCount = session.register?.closing?.initialCount;
      const posPaymentCount = session.register?.closing?.paymentCount;

      // Helper function to build count table HTML
      const buildCountTable = (countData, title) => {
        if (!countData) return '';

        let html = `<h3>${title}</h3>`;
        html += `<h4>Bills</h4><table><tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>`;

        [1,2,5,10,20,50,100].forEach(v => {
          const count = countData.bills?.[v] || 0;
          if (count > 0) {
            html += `<tr><td>$${v}</td><td>${count}</td><td>$${(count * v).toFixed(2)}</td></tr>`;
          }
        });

        html += `</table><h4>Coins</h4><table><tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>`;

        [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
          const count = countData.coins?.[k] || 0;
          if (count > 0) {
            html += `<tr><td>${label}</td><td>${count}</td><td>$${(count * val).toFixed(2)}</td></tr>`;
          }
        });

        html += `</table>`;

        const checks = countData.checks || [];
        html += `<h4>Checks</h4><table><tr><th>Check #</th><th>Amount</th></tr>`;
        if (checks.length > 0) {
          checks.forEach((check, idx) => {
            const isObj = typeof check === 'object' && check !== null;
            const rawNumber = isObj ? check.number : null;
            const displayNumber = rawNumber ? `Check #${rawNumber}` : `Check #${idx + 1}`;
            const amount = isObj ? check.amount : check;

            html += `<tr><td>${displayNumber}</td><td>$${Number(amount || 0).toFixed(2)}</td></tr>`;
          });
        } else {
          html += `<tr><td colspan="2">No checks</td></tr>`;
        }
        html += `</table>`;

        const total = countData.total || 0;
        html += `<div class="total">${title} Total: $${total.toFixed(2)}</div>`;

        return html;
      };

      // Build receipt HTML
      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${drawerName} - EOD Verification Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
            .section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; }
            .comparison { background-color: #f9f9f9; padding: 10px; margin: 10px 0; border-left: 4px solid #4CAF50; }
          </style>
        </head>
        <body>
          <h1>${drawerName} - End Of Day Verification Receipt</h1>
          <div class="info">
            <p><strong>Verified by:</strong> ${verifiedByName}</p>
            <p><strong>Verified at:</strong> ${verifiedDate}</p>
            <p><strong>Session ID:</strong> ${session.id}</p>
          </div>
          <div class="comparison">
            <p><strong>Verification Summary:</strong></p>
            ${initialMsg ? `<p>${initialMsg}</p>` : ''}
            ${paymentMsg ? `<p>${paymentMsg}</p>` : ''}
          </div>
      `;

      // Add Supervisor's SOD Fund Count section
      if (supervisorCount?.initialCount) {
        receiptHtml += `<div class="section">${buildCountTable(supervisorCount.initialCount, 'Supervisor SOD Fund Count')}</div>`;
      }

      // Add Supervisor's Payment Count section
      if (supervisorCount?.paymentCount) {
        receiptHtml += `<div class="section">${buildCountTable(supervisorCount.paymentCount, 'Supervisor Payment Count')}</div>`;
      }

      receiptHtml += `
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin-top: 30px;">Initials: _____________</p>
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    function addEntryToCurrentPaymentProcessing(customer, paymentAmount, paymentType, paymentDate, extra = {}) {

      if (!window.currentPaymentProcessing) {

        return;
      }

      const paymentModule = document.getElementById('paymentModule');

      const entry = {
        id: `ENTRY-${Date.now()}`,
        customerName: customer.name,
        accountNumber: customer.accountNumber || customer.id,
        property: customer.address || 'N/A',
        paymentType,
        amount: paymentAmount,
        date: paymentDate,
        cashReceived: extra.cashReceived || null,
        changeGiven: extra.changeGiven || 0,
        checkReceived: extra.checkReceived || null,
        checkChangeGiven: extra.checkChangeGiven || 0,
        checkCreditGiven: extra.checkCreditGiven || 0,
        checkOverpaymentHandling: extra.checkOverpaymentHandling || null,
        amountDue: extra.amountDue || null,
        checkNumber: extra.checkNumber || null,
        processedBy: window.currentPaymentUserName || (window.authenticatedUser && window.authenticatedUser.fullName) || window.currentPaymentProcessing.username || '—',
        breakdown: extra.breakdown || null
      };

      window.currentPaymentProcessing.entries.push(entry);

      // Save session to localStorage whenever entries are added
      try {
        if (window.currentPaymentProcessing) {
          const sessionJson = JSON.stringify(window.currentPaymentProcessing);
          localStorage.setItem('currentPaymentProcessingSession', sessionJson);

          // Also save to Firestore so supervisors can access it
          if (typeof savePaymentProcessingSessionToFirestore === 'function') {
            savePaymentProcessingSessionToFirestore(window.currentPaymentProcessing).catch(err => {
              console.error('[addEntryToCurrentPaymentProcessing] Error saving session to Firestore:', err);
            });
          }
        } else {

        }

      } catch (e) {

      }

      const previewSectionBefore = document.getElementById('paymentProcessingPreviewSection');
      const previewTableBefore = document.getElementById('paymentProcessingPreviewTable');

      // Render the preview table first

      renderPaymentProcessingPreview();

      const previewSectionAfter = document.getElementById('paymentProcessingPreviewSection');
      const previewTableAfter = document.getElementById('paymentProcessingPreviewTable');

      // Then switch to preview view - ensure preview section exists and is visible

      const previewSection = document.getElementById('paymentProcessingPreviewSection');
      if (!previewSection) {

        return;
      }

      setPaymentProcessingViewState('preview');
      showPaymentProcessingEntryWithPreview();

      // Show receipt popup after payment is processed
      const entryIndex = window.currentPaymentProcessing.entries.length - 1;
      showPaymentReceiptPopup(entryIndex);

      // IMMEDIATE: Force preview section visible right after setPaymentProcessingViewState
      const immediatePreviewSection = document.getElementById('paymentProcessingPreviewSection');
      if (immediatePreviewSection) {
        // Remove hidden class
        immediatePreviewSection.classList.remove('hidden');

        // FORCE visibility with inline styles that override everything
        immediatePreviewSection.style.cssText = `
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          position: relative !important;
          width: 100% !important;
        `;

        // Check parent containers
        let parent = immediatePreviewSection.parentElement;
        let depth = 0;
        while (parent && depth < 5) {
          const parentStyle = window.getComputedStyle(parent);

          // Force parent visible if needed
          if (parent.classList.contains('hidden')) {
            parent.classList.remove('hidden');
            parent.style.display = 'block';
            parent.style.visibility = 'visible';
            parent.style.opacity = '1';

          }

          parent = parent.parentElement;
          depth++;
        }

        const immediateRect = immediatePreviewSection.getBoundingClientRect();

        // Force scroll into view immediately
        immediatePreviewSection.scrollIntoView({ behavior: 'auto', block: 'start', inline: 'nearest' });

        // Also ensure payment module is visible
        if (paymentModule) {
          paymentModule.classList.remove('hidden');
          paymentModule.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          `;

        }
      } else {

      }

      // Double-check preview section is visible

      // Force payment module visible
      if (paymentModule.classList.contains('hidden')) {

        paymentModule.classList.remove('hidden');
      }

      // Force preview section visible
      if (previewSection.classList.contains('hidden')) {

        previewSection.classList.remove('hidden');

      } else {

      }

      // Check computed styles to verify visibility
      const previewSectionStyle = window.getComputedStyle(previewSection);
      const paymentModuleStyle = window.getComputedStyle(paymentModule);

      // Final verification after a short delay
      setTimeout(() => {
        const finalPreviewSection = document.getElementById('paymentProcessingPreviewSection');
        const finalPaymentModule = document.getElementById('paymentModule');
        const finalTable = document.getElementById('paymentProcessingPreviewTable');

        // AGGRESSIVE: Force everything visible
        if (finalPaymentModule) {
          finalPaymentModule.classList.remove('hidden');
          finalPaymentModule.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          `;
        }

        if (finalPreviewSection) {
          finalPreviewSection.classList.remove('hidden');
          // FORCE visibility without breaking layout
          finalPreviewSection.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
          `;

          // Force the table inside to be visible too
          if (finalTable) {
            finalTable.style.cssText = `
              display: table !important;
              visibility: visible !important;
              width: 100% !important;
            `;
          }

          // Scroll preview section into view
          finalPreviewSection.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });

          // Check bounding rect to verify it's actually visible
          const rect = finalPreviewSection.getBoundingClientRect();

          // If still zero dimensions, try even more aggressive approach
          if (rect.width === 0 || rect.height === 0) {

            // Try appending to body temporarily to see if it's a parent issue
            const originalParent = finalPreviewSection.parentElement;
            document.body.appendChild(finalPreviewSection);
            const bodyRect = finalPreviewSection.getBoundingClientRect();

            // Put it back
            originalParent.appendChild(finalPreviewSection);
          }
        }

        if (finalTable) {
          const tableRect = finalTable.getBoundingClientRect();

        }
      }, 100);

      resetPaymentProcessingEntryForm();
      debugPaymentProcessingDom('after-add-entry');

    }

    function renderPaymentProcessingPreview() {
      const tbody = document.getElementById("paymentProcessingPreviewTable");
      const totalCell = document.getElementById("paymentProcessingPreviewTotal");

      // If tbody doesn't exist, just return
      if (!tbody) return;

      tbody.innerHTML = "";

      // Clear preview if currentPaymentProcessing is null or has no entries
      if (!window.currentPaymentProcessing || !window.currentPaymentProcessing.entries || window.currentPaymentProcessing.entries.length === 0) {
        tbody.innerHTML = `
          <div class="grid grid-cols-[110px_180px_140px_220px_90px_110px_120px_120px_120px_110px_150px_120px]">
            <div class="col-span-12 px-4 py-3 text-center text-sm text-slate-500">
              No payments added yet.
            </div>
          </div>
        `;
        if (totalCell) totalCell.textContent = "$0.00";
        return;
      }

      window.currentPaymentProcessing.entries.forEach((entry, index) => {
        const row = document.createElement("div");
        row.className = "grid grid-cols-[110px_180px_140px_220px_90px_110px_120px_120px_120px_110px_150px_120px] hover:bg-slate-50 transition-colors";

        // Format property as multi-line (the KEY fix)
        const [street, cityStateZip] = (entry.property || '').split(/,(.+)/);

        const receivedAmount = entry.paymentType === 'Cash'
          ? (entry.cashReceived ?? entry.amount)
          : (entry.checkReceived ?? entry.amount);
        const changeGiven = entry.paymentType === 'Cash'
          ? (entry.changeGiven || 0)
          : (entry.checkChangeGiven || 0);
        const creditGiven = entry.checkCreditGiven || 0;
        // Ensure processedBy is always set - check entry first, then authenticated user, then session username
        let processedBy = entry.processedBy;
        if (!processedBy || processedBy === '—' || processedBy.trim() === '') {
          processedBy = (window.authenticatedUser && window.authenticatedUser.fullName) || window.currentPaymentProcessing.username || '—';
        }

        const checkNumber = entry.checkNumber || (entry.paymentType === 'Check' ? '—' : '');

        row.innerHTML = `
            <div class="px-4 py-4 align-top whitespace-nowrap">${entry.date || ''}</div>
            <div class="px-4 py-4 align-top whitespace-nowrap">${entry.customerName || ''}</div>
            <div class="px-4 py-4 align-top whitespace-nowrap">${entry.accountNumber || ''}</div>
            <div class="px-4 py-4 align-top leading-5">
                ${street || ''}${cityStateZip ? ',<br>' + cityStateZip.trim() : ''}
            </div>
            <div class="px-4 py-4 align-top whitespace-nowrap">${entry.paymentType || ''}</div>
            <div class="px-4 py-4 align-top text-right whitespace-nowrap">$${(receivedAmount || 0).toFixed(2)}</div>
            <div class="px-4 py-4 align-top text-right whitespace-nowrap">$${(changeGiven || 0).toFixed(2)}</div>
            <div class="px-4 py-4 align-top text-right whitespace-nowrap">$${(creditGiven || 0).toFixed(2)}</div>
            <div class="px-4 py-4 align-top whitespace-nowrap">${checkNumber}</div>
            <div class="px-4 py-4 align-top text-right whitespace-nowrap">$${(entry.amount || 0).toFixed(2)}</div>
            <div class="px-4 py-4 align-top whitespace-nowrap">${processedBy}</div>
            <div class="px-4 py-4 align-top text-center">
              <button onclick="printPaymentReceipt(${index})" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                Print Receipt
              </button>
            </div>
        `;

        tbody.appendChild(row);
      });

      // Update total
      const total = window.currentPaymentProcessing.entries.reduce((sum, e) => sum + (e.amount || 0), 0);
      if (totalCell) {
        totalCell.textContent = `$${total.toFixed(2)}`;
      }
    }

    function renderPaymentProcessingSessionsList() {

      const tbody = document.getElementById('paymentProcessingSessionsListTable');
      if (!tbody) {

        debugPaymentProcessingDom('renderList-missing');
        return;
      }

      if (!window.paymentProcessingSessions || window.paymentProcessingSessions.length === 0) {

        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-3 text-center text-sm text-slate-500">No sessions submitted yet.</td></tr>`;
        return;
      }

      // Check if current user is POS (POS users can't delete)
      const currentUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
      const userRole = window.getEffectiveRole ? window.getEffectiveRole(currentUser) : null;
      const canDelete = userRole === 'admin' || userRole === 'supervisor' || userRole === 'helpdesk';

      let rows = '';
      window.paymentProcessingSessions.slice().reverse().forEach((session, index) => {

        const submitted = session.submittedAt ? new Date(session.submittedAt).toLocaleString() : '—';
        const deleteButton = canDelete 
          ? `<button onclick="deletePaymentProcessingSession('${session.id.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>`
          : '';
        rows += `
          <tr>
            <td class="px-4 py-2 text-sm text-slate-700">${session.id}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${session.username}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${session.entries?.length || 0}</td>
            <td class="px-4 py-2 text-sm text-slate-700 text-right">$${(session.totalAmount || 0).toFixed(2)}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${submitted}</td>
            <td class="px-4 py-2 text-sm text-slate-700 text-center">
              <button onclick="openPaymentProcessingSessionDetails('${session.id.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 ${canDelete ? 'mr-2' : ''}">Open</button>
              ${deleteButton}
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = rows;

      // Force table row visibility
      Array.from(tbody.children).forEach((row, idx) => {
        row.style.cssText = 'display: table-row !important; visibility: visible !important;';

      });

      // Verify it was set
      setTimeout(() => {

        const listSection = document.getElementById('paymentProcessingSessionsListSection');
        if (listSection) {

        }
        const table = tbody.closest('table');
        if (table) {

        }
      }, 200);

    }

    window.openPaymentProcessingSessionDetails = function(sessionId) {

      const session = window.paymentProcessingSessions.find(s => s.id === sessionId);
      if (!session) {
        alert('Payment processing session not found');
        return;
      }

      // Create modal HTML
      let entriesHtml = '';
      if (session.entries && session.entries.length > 0) {
        entriesHtml = session.entries.map((entry, index) => {
          const receivedAmount = entry.paymentType === 'Cash'
            ? (entry.cashReceived ?? entry.amount)
            : (entry.checkReceived ?? entry.amount);
          const changeGiven = entry.paymentType === 'Cash'
            ? (entry.changeGiven || 0)
            : (entry.checkChangeGiven || 0);
          const creditGiven = entry.checkCreditGiven || 0;
          const processedBy = entry.processedBy || window.authenticatedUser?.fullName || session.username || '—';

          return '<tr class="border-b border-slate-200">' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.date || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.customerName || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.accountNumber || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.property || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.paymentType || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700 text-right">$' + (receivedAmount || 0).toFixed(2) + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700 text-right">$' + (changeGiven || 0).toFixed(2) + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700 text-right">$' + (creditGiven || 0).toFixed(2) + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700 text-right">$' + (entry.amount || 0).toFixed(2) + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + processedBy + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700 text-center">' +
            '<button onclick="printPaymentReceiptFromSession(\'' + sessionId.replace(/'/g, "\\'") + '\', ' + index + ')" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Print Receipt</button>' +
            '</td>' +
            '</tr>';
        }).join('');
      }

      const submitted = session.submittedAt ? new Date(session.submittedAt).toLocaleString() : '—';
      const started = session.startedAt ? new Date(session.startedAt).toLocaleString() : '—';

      const modalHtml = `
        <div id="paymentProcessingSessionDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-slate-800">Payment Processing Session Details</h2>
              <button onclick="closePaymentProcessingSessionDetailsModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
              <div>
                <p class="text-sm text-slate-600">Session ID</p>
                <p class="text-lg font-semibold text-slate-800">${session.id}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">User</p>
                <p class="text-lg font-semibold text-slate-800">${session.username || '—'}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Drawer</p>
                <p class="text-lg font-semibold text-slate-800">${session.drawer?.name || '—'}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Started</p>
                <p class="text-sm text-slate-700">${started}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Submitted</p>
                <p class="text-sm text-slate-700">${submitted}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Total Amount</p>
                <p class="text-lg font-bold text-green-600">$${(session.totalAmount || 0).toFixed(2)}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Entries</p>
                <p class="text-lg font-semibold text-slate-800">${session.entries?.length || 0}</p>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full border-collapse text-sm">
                <thead class="bg-slate-100">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Date</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Customer</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Account #</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Property</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Type</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Amount</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Change Given</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Credit Given</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Total Paid</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Processed By</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${entriesHtml || '<tr><td colspan="11" class="px-4 py-3 text-center text-slate-500">No entries</td></tr>'}
                </tbody>
                <tfoot class="bg-slate-100">
                  <tr>
                    <td colspan="8" class="px-4 py-3 text-right font-semibold text-slate-700">Total Paid</td>
                    <td colspan="3" class="px-4 py-3 text-right font-bold text-slate-900">$${(session.totalAmount || 0).toFixed(2)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="mt-6 space-y-4">
              <div class="flex justify-end gap-3">
                <button onclick="printPaymentProcessingSessionDetails('${session.id.replace(/'/g, "\\'")}')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Print</button>
                <button onclick="closePaymentProcessingSessionDetailsModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('paymentProcessingSessionDetailsModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    window.closePaymentProcessingSessionDetailsModal = function() {
      const modal = document.getElementById('paymentProcessingSessionDetailsModal');
      if (modal) {
        modal.remove();
      }
    };

    window.printPaymentProcessingSessionDetails = function(sessionId) {
      const session = window.paymentProcessingSessions.find(s => s.id === sessionId);
      if (!session) {
        alert('Payment processing session not found');
        return;
      }

      const submitted = session.submittedAt ? new Date(session.submittedAt).toLocaleString() : '—';
      const started = session.startedAt ? new Date(session.startedAt).toLocaleString() : '—';

      let rowsHtml = '';
      if (session.entries && session.entries.length > 0) {
        rowsHtml = session.entries.map((entry) => {
          const receivedAmount = entry.paymentType === 'Cash'
            ? (entry.cashReceived ?? entry.amount)
            : (entry.checkReceived ?? entry.amount);
          const changeGiven = entry.paymentType === 'Cash'
            ? (entry.changeGiven || 0)
            : (entry.checkChangeGiven || 0);
          const creditGiven = entry.checkCreditGiven || 0;
          const processedBy = entry.processedBy || window.authenticatedUser?.fullName || session.username || '—';

          return `
            <tr>
              <td>${entry.date || ''}</td>
              <td>${entry.customerName || ''}</td>
              <td>${entry.accountNumber || ''}</td>
              <td>${entry.property || ''}</td>
              <td>${entry.paymentType || ''}</td>
              <td style="text-align:right;">$${(receivedAmount || 0).toFixed(2)}</td>
              <td style="text-align:right;">$${(changeGiven || 0).toFixed(2)}</td>
              <td style="text-align:right;">$${(creditGiven || 0).toFixed(2)}</td>
              <td style="text-align:right;">$${(entry.amount || 0).toFixed(2)}</td>
              <td>${processedBy}</td>
            </tr>
          `;
        }).join('');
      } else {
        rowsHtml = `<tr><td colspan="10" style="text-align:center;">No entries</td></tr>`;
      }

      const receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Payment Processing Session Details</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px; }
            th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
            th { background-color: #f2f2f2; }
            .info { margin-bottom: 20px; }
            .info p { margin: 4px 0; }
            .total { font-weight: bold; text-align: right; }
          </style>
        </head>
        <body>
          <h1>Payment Processing Session Details</h1>
          <div class="info">
            <p><strong>Session ID:</strong> ${session.id}</p>
            <p><strong>User:</strong> ${session.username || '—'}</p>
            <p><strong>Drawer:</strong> ${session.drawer?.name || '—'}</p>
            <p><strong>Started:</strong> ${started}</p>
            <p><strong>Submitted:</strong> ${submitted}</p>
            <p><strong>Total Amount:</strong> $${(session.totalAmount || 0).toFixed(2)}</p>
            <p><strong>Entries:</strong> ${session.entries?.length || 0}</p>
          </div>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Account #</th>
                <th>Property</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Change Given</th>
                <th>Credit Given</th>
                <th>Total Paid</th>
                <th>Processed By</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
            <tfoot>
              <tr>
                <td colspan="8" class="total">Total Paid</td>
                <td colspan="2" class="total">$${(session.totalAmount || 0).toFixed(2)}</td>
              </tr>
            </tfoot>
          </table>
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    window.viewDenominations = function(sessionId, type) {
      const session = window.paymentProcessingSessions.find(s => s.id === sessionId);
      if (!session) {
        alert('Payment processing session not found');
        return;
      }

      let countData = null;
      let title = '';

      if (type === 'initial1') {
        countData = session.register?.initial;
        title = 'Initial Count #1 Denominations';
      } else if (type === 'initial2') {
        countData = session.register?.closing?.initialCount;
        title = 'Initial Count #2 Denominations';
      } else if (type === 'payment') {
        countData = session.register?.closing?.paymentCount;
        title = 'Payment Count Denominations';
      }

      if (!countData) {
        alert('Count data not available for this session');
        return;
      }

      // Build bills HTML
      const billsHtml = [1,2,5,10,20,50,100].map(v => {
        const count = countData.bills?.[v] || 0;
        return `
          <div class="flex items-center gap-2">
            <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
              <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
              <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
              <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
              <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
              <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
            <input type="number" class="w-24 px-3 py-2 border rounded-lg text-right bg-slate-100" value="${count}" readonly>
          </div>
        `;
      }).join('');

      // Build coins HTML
      const coinsHtml = [['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0'],['dollar',1.00,'Dollar Coin','#FFD700']].map(([k,val,label,color]) => {
        const count = countData.coins?.[k] || 0;
        return `
          <div class="flex items-center gap-2">
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
              <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
              <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${k === 'penny' ? '1¢' : k === 'nickel' ? '5¢' : k === 'dime' ? '10¢' : k === 'quarter' ? '25¢' : '50¢'}</text>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
            <input type="number" class="w-24 px-3 py-2 border rounded-lg text-right bg-slate-100" value="${count}" readonly>
          </div>
        `;
      }).join('');

      // Build checks HTML
      const checks = countData.checks || [];
      const checksHtml = checks.length > 0 
        ? checks.map((amount, idx) => `
            <div class="flex items-center gap-3">
              <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #${idx + 1}</label>
              <input type="number" step="0.01" class="flex-1 px-3 py-2 border rounded-lg bg-slate-100" value="${amount.toFixed(2)}" readonly>
            </div>
          `).join('')
        : '<p class="text-sm text-slate-500">No checks</p>';

      // Calculate total
      let total = 0;
      // Bills
      [1,2,5,10,20,50,100].forEach(v => {
        const count = countData.bills?.[v] || 0;
        total += count * v;
      });
      // Coins
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const count = countData.coins?.[k] || 0;
        total += count * val;
      });
      // Checks
      checks.forEach(amount => {
        total += amount;
      });

      const modalHtml = `
        <div id="denominationsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-slate-800">${title}</h2>
              <button onclick="closeDenominationsModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${billsHtml}
                </div>
              </div>

              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${coinsHtml}
                </div>
              </div>
            </div>

            <div class="space-y-3 mt-6">
              <div class="flex items-center justify-between">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Checks in Drawer</h5>
              </div>
              <div class="space-y-2">
                ${checksHtml}
              </div>
            </div>

            <div class="mt-6 flex items-center justify-between border-t border-slate-200 pt-4">
              <p class="text-lg font-semibold text-slate-700 dark:text-slate-100">Total: $${total.toFixed(2)}</p>
              <button onclick="closeDenominationsModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('denominationsModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    window.closeDenominationsModal = function() {
      const modal = document.getElementById('denominationsModal');
      if (modal) {
        modal.remove();
      }
    };

    window.deletePaymentProcessingSession = async function(sessionId) {
      if (!confirm('Are you sure you want to delete this payment processing session? This action cannot be undone.')) {
        return;
      }

      try {
        // Delete from Firestore
        const sessionsRef = collection(db, 'paymentProcessingSessions');
        const sessionRef = doc(sessionsRef, sessionId);
        await deleteDoc(sessionRef);

        // Remove from local array
        window.paymentProcessingSessions = window.paymentProcessingSessions.filter(s => s.id !== sessionId);

        // Re-render the list
        renderPaymentProcessingSessionsList();

        alert('Payment processing session deleted successfully');
      } catch (error) {

        alert('Error deleting batch: ' + error.message);
      }
    };

    // Add Client Module Functions
    function populateAddClientLocationSelect() {
      const select = document.getElementById('newClientLocation');
      select.innerHTML = '<option value="">Choose a location...</option><option value="add-new">+ Add New Location</option>';

      // Show all locations, not just available ones
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = `${location.address} (${location.status})`;
        select.appendChild(option);
      });

      // Add event listener for add new location
      select.addEventListener('change', function() {
        if (this.value === 'add-new') {
          showAddLocationModal();
        }
      });
    }

    window.addClientFromModule = async function() {
      const name = document.getElementById('newClientName').value.trim();
      const email = document.getElementById('newClientEmail').value.trim();
      const phone = document.getElementById('newClientPhone').value.replace(/\D/g, '');
      const locationId = document.getElementById('newClientLocation').value;

      // Get new fields
      const entityType = document.getElementById('newClientEntityType')?.value || '';
      const ssn = document.getElementById('newClientSSN')?.value.trim() || '';
      const idType = document.getElementById('newClientIDType')?.value || '';
      const idNumber = document.getElementById('newClientIDNumber')?.value.trim() || '';
      const secondaryContactName = document.getElementById('newClientSecondaryContactName')?.value.trim() || '';
      const secondaryContactPhone = document.getElementById('newClientSecondaryContactPhone')?.value.replace(/\D/g, '') || '';
      const mailingStreet = document.getElementById('newClientMailingStreet')?.value.trim() || '';
      const mailingCity = document.getElementById('newClientMailingCity')?.value.trim() || '';
      const mailingState = document.getElementById('newClientMailingState')?.value || '';
      const mailingZip = document.getElementById('newClientMailingZip')?.value.trim() || '';

      // Build mailing address
      let mailingAddress = '';
      if (mailingStreet || mailingCity || mailingState || mailingZip) {
        const parts = [];
        if (mailingStreet) parts.push(mailingStreet);
        if (mailingCity || mailingState || mailingZip) {
          const cityStateZip = [mailingCity, mailingState, mailingZip].filter(Boolean).join(', ');
          parts.push(cityStateZip);
        }
        mailingAddress = parts.join(', ');
      }

      // Get selected codes
      const selectedCodes = window.selectedClientCodes.map(code => ({
        id: code.id,
        name: code.name,
        type: code.type || 'percentage',
        amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
        percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
      }));

      // Get factor
      const factor = document.getElementById('newClientFactor')?.value.trim() || '';

      // Get cycle number
      const cycleNumber = document.getElementById('newClientCycleNumber')?.value.trim() || '';

      if (!name || !email || !phone || !locationId) {
        alert('Please fill in all required fields');
        return;
      }

      if (locationId === 'add-new') {
        alert('Please select a location or add a new one first');
        return;
      }

      const selectedLocation = locations.find(l => l.id === locationId);
      if (!selectedLocation) {
        alert('Selected location not found');
        return;
      }

      // Check if location is already occupied
      if (selectedLocation.status === 'occupied' && selectedLocation.currentResident) {
        const currentResident = customers.find(c => c.name === selectedLocation.currentResident);
        if (currentResident) {
          showTransferOwnershipModal(selectedLocation, currentResident, { 
            name, 
            email, 
            phone,
            entityType,
            ssn,
            idType,
            idNumber,
            secondaryContactName,
            secondaryContactPhone,
            mailingAddress,
            mailingStreet,
            mailingCity,
            mailingState,
            mailingZip,
            codes: selectedCodes,
        factor: factor,
        cycleNumber: cycleNumber || null
          });
          return;
        }
      }

      // Create new customer (same logic as existing addCustomer function)
      const newCustomer = {
        id: 'CUS-' + String(Date.now()).slice(-6), // Use accountNumber as ID
        name: name,
        email: email,
        phone: phone,
        address: selectedLocation.address,
        accountNumber: 'CUS-' + String(Date.now()).slice(-6),
        currentBill: sewerCharge,
        pastDue: 0,
        lastPayment: 'Never',
        paymentHistory: [],
        needsPasswordChange: true,
        createdDate: new Date().toISOString(),
        entityType: entityType,
        ssn: ssn,
        idType: idType,
        idNumber: idNumber,
        secondaryContactName: secondaryContactName,
        secondaryContactPhone: secondaryContactPhone,
        mailingAddress: mailingAddress,
        mailingStreet: mailingStreet,
        mailingCity: mailingCity,
        mailingState: mailingState,
        mailingZip: mailingZip,
        codes: selectedCodes,
        factor: factor
      };

      // Update payment status based on past due amount
      updateCustomerPaymentStatus(newCustomer);

      customers.push(newCustomer);
      filteredCustomers = [...customers];

      // Update location
      selectedLocation.currentResident = name;
      selectedLocation.status = 'occupied';
      selectedLocation.ownerFullName = name;
      const nameParts = name.split(' ');
      selectedLocation.ownerFirstName = nameParts[0] || '';
      selectedLocation.ownerLastName = nameParts.slice(1).join(' ') || '';

      // Clear selected codes after creation
      window.selectedClientCodes = [];
      updateClientCodesList();

      // Save only this customer to Firestore
      await saveSingleCustomerToFirestore(customer);
      await saveLocationsToFirestore();
      updateDashboard();

      // Show success screen instead of hiding module
      showClientSuccessScreen();
    };

    // Show client success screen
    window.showClientSuccessScreen = function() {
      const addClientModule = document.getElementById('addClientModule');
      addClientModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Client Successfully Added!</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>

          <h4 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Client Added Successfully!</h4>
          <p class="text-slate-600 dark:text-slate-400 mb-8">The client has been added to the system successfully</p>

          <div class="flex flex-col gap-4 justify-center">
            <button 
              onclick="resetAddClientForm()" 
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Add Another Client
            </button>
            <button 
              onclick="hideAllModules()" 
              class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Exit
            </button>
          </div>
        </div>
      `;
    };

    // Reset add client form
    window.resetAddClientForm = function() {
      const addClientModule = document.getElementById('addClientModule');
      addClientModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Client</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Account Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              type="text" 
              id="newClientName" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter full name"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
            <input 
              type="email" 
              id="newClientEmail" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter email address"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <input 
              type="tel" 
              id="newClientPhone" 
              oninput="formatPhoneInput(this)"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="(xxx)-xxx-xxxx"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <select id="newClientLocation" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" required>
              <option value="">Choose a location...</option>
              <option value="add-new">+ Add New Location</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <select id="newClientEntityType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Select Entity Type</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Farmer">Farmer</option>
            </select>
          </div>
        </div>
        </div>

        <!-- Identification Info Section -->
        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Identification Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
              <input 
                type="text" 
                id="newClientSSN" 
                oninput="formatSSNInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="xxx-xx-xxxx"
                maxlength="11"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
              <select id="newClientIDType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Select ID Type</option>
                <option value="Drivers License">Drivers License</option>
                <option value="ID">ID</option>
                <option value="Passport">Passport</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
              <input 
                type="text" 
                id="newClientIDNumber" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter ID number"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
              <input 
                type="text" 
                id="newClientSecondaryContactName" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter secondary contact name"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
              <input 
                type="tel" 
                id="newClientSecondaryContactPhone" 
                oninput="formatPhoneInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="(xxx)-xxx-xxxx"
              >
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
              <input 
                type="text" 
                id="newClientMailingStreet" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter street address"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <input 
                type="text" 
                id="newClientMailingCity" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter city"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <select id="newClientMailingState" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Select State</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
              <input 
                type="text" 
                id="newClientMailingZip" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter ZIP code"
                maxlength="10"
              >
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
          <div id="newClientCodesList" class="space-y-2">
            <!-- Selected codes will be displayed here -->
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
            <input 
              type="number" 
              id="newClientFactor" 
              step="any"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter factor"
            >
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Cycle Number</h4>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cycle Number</label>
            <input 
              type="number" 
              id="newClientCycleNumber" 
              min="1"
              max="10"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter cycle number (1-10)"
            >
          </div>
        </div>

        <div class="mt-6">
          <button 
            onclick="addClientFromModule()" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
          >
            Create Client Account
          </button>
        </div>
      `;

      // Repopulate the location dropdown
      populateAddClientLocationSelect();
      // Populate codes dropdown
      populateAddClientCodeSelect();
      // Clear selected codes
      window.selectedClientCodes = [];
      updateClientCodesList();

      // Add event listener to Entity Type dropdown for auto-adding codes
      const entityTypeSelect = document.getElementById('newClientEntityType');
      if (entityTypeSelect) {
        // Remove existing listeners by cloning the element
        const newEntityTypeSelect = entityTypeSelect.cloneNode(true);
        entityTypeSelect.parentNode.replaceChild(newEntityTypeSelect, entityTypeSelect);

        newEntityTypeSelect.addEventListener('change', function() {
          const selectedEntityType = this.value;
          // Auto-add matching codes based on Entity Type
          autoAddCodesForEntityType(selectedEntityType);
        });
      }
    };

    // Check if a code matches the selected Entity Type
    function codeMatchesEntityType(code, entityType) {
      if (!entityType || !code.requirements) {
        return false;
      }

      // Handle new requirements structure with AND/OR logic
      if (code.requirements && code.requirements.values && Array.isArray(code.requirements.values)) {
        const entityTypeInValues = code.requirements.values.includes(entityType);

        if (code.requirements.type === 'OR') {
          // OR logic: Entity Type must be in the values array
          return entityTypeInValues;
        } else if (code.requirements.type === 'AND') {
          // AND logic: For now, we'll check if Entity Type is in values
          // (Full AND logic would require Entity Type to match all values, which isn't possible with single selection)
          return entityTypeInValues;
        }
      }

      // Handle old array format (backward compatibility)
      if (Array.isArray(code.requirements)) {
        return code.requirements.includes(entityType);
      }

      return false;
    }

    // Automatically add codes based on Entity Type
    function autoAddCodesForEntityType(entityType) {
      if (!entityType) {
        return;
      }

      // Check each code to see if it matches the Entity Type
      codes.forEach(code => {
        if (codeMatchesEntityType(code, entityType)) {
          // Check if code is already added
          if (!window.selectedClientCodes.find(c => c.id === code.id)) {
            window.selectedClientCodes.push(code);
          }
        }
      });

      updateClientCodesList();
    }

    // Populate codes dropdown for Add Client form
    function populateAddClientCodeSelect() {
      const select = document.getElementById('newClientCodeSelect');
      if (!select) return;

      select.innerHTML = '<option value="">Select a code...</option>';
      codes.forEach(code => {
        const option = document.createElement('option');
        option.value = code.id;
        const codeType = code.type || 'percentage';
        const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
        const displayText = codeType === 'flat' 
          ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
          : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
        option.textContent = displayText;
        select.appendChild(option);
      });
    }

    // Initialize selected codes array
    window.selectedClientCodes = [];
    window.selectedCustomerCodes = [];

    // Add code to client
    window.addClientCode = function() {
      const select = document.getElementById('newClientCodeSelect');
      if (!select || !select.value) {
        alert('Please select a code first');
        return;
      }

      const codeId = select.value;
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      // Check if already added
      if (window.selectedClientCodes.find(c => c.id === codeId)) {
        alert('This code has already been added');
        select.value = '';
        return;
      }

      window.selectedClientCodes.push(code);
      select.value = '';
      updateClientCodesList();
    };

    // Remove code from client
    window.removeClientCode = function(codeId) {
      window.selectedClientCodes = window.selectedClientCodes.filter(c => c.id !== codeId);
      updateClientCodesList();
    };

    // Update codes list display
    function updateClientCodesList() {
      const listContainer = document.getElementById('newClientCodesList');
      if (!listContainer) return;

      if (window.selectedClientCodes.length === 0) {
        listContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400">No codes selected</p>';
        return;
      }

        listContainer.innerHTML = window.selectedClientCodes.map(code => {
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          return `
          <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
            <span class="text-sm text-slate-800 dark:text-slate-200">${displayText}</span>
          <button 
            type="button"
            onclick="removeClientCode('${code.id}')" 
            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-sm"
          >
            Remove
          </button>
        </div>
      `;
        }).join('');
    }

    // Add code to customer (for Add Customer modal)
    window.addCustomerCode = function() {
      const select = document.getElementById('newCustomerCodeSelect');
      if (!select || !select.value) {
        alert('Please select a code first');
        return;
      }

      const codeId = select.value;
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      // Check if already added
      if (window.selectedCustomerCodes.find(c => c.id === codeId)) {
        alert('This code has already been added');
        select.value = '';
        return;
      }

      window.selectedCustomerCodes.push(code);
      select.value = '';
      updateCustomerCodesList();
    };

    // Remove code from customer
    window.removeCustomerCode = function(codeId) {
      window.selectedCustomerCodes = window.selectedCustomerCodes.filter(c => c.id !== codeId);
      updateCustomerCodesList();
    };

    // Update customer codes list display
    function updateCustomerCodesList() {
      const listContainer = document.getElementById('newCustomerCodesList');
      if (!listContainer) return;

      if (window.selectedCustomerCodes.length === 0) {
        listContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400">No codes selected</p>';
        return;
      }

        listContainer.innerHTML = window.selectedCustomerCodes.map(code => {
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          return `
          <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
            <span class="text-sm text-slate-800 dark:text-slate-200">${displayText}</span>
          <button 
            type="button"
            onclick="removeCustomerCode('${code.id}')" 
            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-sm"
          >
            Remove
          </button>
        </div>
      `;
        }).join('');
    }

    // Search Module Functions
    window.performSearch = function() {
      const nameQuery = document.getElementById('searchByName').value.toLowerCase().trim();
      const statusFilter = document.getElementById('searchByStatus').value;

      let results = customers;

      // Filter by name
      if (nameQuery) {
        results = results.filter(customer => 
          customer.name.toLowerCase().includes(nameQuery)
        );
      }

      // Filter by status
      if (statusFilter) {
        results = results.filter(customer => 
          customer.paymentStatus === statusFilter
        );
      }

      displaySearchResults(results);
    };

    window.clearSearch = function() {
      document.getElementById('searchByName').value = '';
      document.getElementById('searchByStatus').value = '';
      document.getElementById('searchResults').innerHTML = '';
    };

    function displaySearchResults(results) {
      const container = document.getElementById('searchResults');

      if (results.length === 0) {
        container.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">No customers found matching your search criteria.</p>';
        return;
      }

      let html = '<div class="space-y-4">';
      results.forEach(customer => {
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFeeAmount = customer.pastDue > 0 ? lateFee : 0;
        const totalAmount = serviceCost + lateFeeAmount;

        const statusClass = customer.paymentStatus === 'overdue' ? 
          'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
          customer.paymentStatus === 'inactive' ?
          'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200' :
          customer.paymentStatus === 'pending closing' ?
          'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
          'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';

        html += `
          <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-semibold text-slate-800 dark:text-slate-200">${customer.name}</h4>
                <p class="text-sm text-slate-600 dark:text-slate-400">${customer.email}</p>
                <p class="text-sm text-slate-600 dark:text-slate-400">${customer.accountNumber}</p>
              </div>
              <div class="text-right">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                  ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
                </span>
                <p class="text-lg font-semibold text-slate-800 dark:text-slate-200 mt-2">$${totalAmount.toFixed(2)}</p>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    // Add new customer
    window.showAddCustomerModal = function() {
      // Populate location dropdown with all locations
      const locationSelect = document.getElementById('newCustomerLocation');
      locationSelect.innerHTML = '<option value="">Select a property location</option>';

      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = `${location.address} (${location.status})`;
        locationSelect.appendChild(option);
      });

      // Populate codes dropdown
      const codeSelect = document.getElementById('newCustomerCodeSelect');
      if (codeSelect) {
        codeSelect.innerHTML = '<option value="">Select a code...</option>';
        codes.forEach(code => {
          const option = document.createElement('option');
          option.value = code.id;
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          option.textContent = displayText;
          codeSelect.appendChild(option);
        });
      }

      // Clear selected codes
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();

      document.getElementById('addCustomerModal').classList.remove('hidden');
    };

    window.hideAddCustomerModal = function() {
      document.getElementById('addCustomerModal').classList.add('hidden');
      document.getElementById('addCustomerForm').reset();
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();
    };

    window.addCustomer = async function() {
      const name = document.getElementById('newCustomerName').value;
      const email = document.getElementById('newCustomerEmail').value;
      const locationId = document.getElementById('newCustomerLocation').value;
      const phone = document.getElementById('newCustomerPhone').value.replace(/\D/g, ''); // Store as digits only

      // Get new fields
      const entityType = document.getElementById('newCustomerEntityType')?.value || '';
      const ssn = document.getElementById('newCustomerSSN')?.value.trim() || '';
      const idType = document.getElementById('newCustomerIDType')?.value || '';
      const idNumber = document.getElementById('newCustomerIDNumber')?.value.trim() || '';
      const secondaryContactName = document.getElementById('newCustomerSecondaryContactName')?.value.trim() || '';
      const secondaryContactPhone = document.getElementById('newCustomerSecondaryContactPhone')?.value.replace(/\D/g, '') || '';
      const mailingStreet = document.getElementById('newCustomerMailingStreet')?.value.trim() || '';
      const mailingCity = document.getElementById('newCustomerMailingCity')?.value.trim() || '';
      const mailingState = document.getElementById('newCustomerMailingState')?.value || '';
      const mailingZip = document.getElementById('newCustomerMailingZip')?.value.trim() || '';

      // Build mailing address
      let mailingAddress = '';
      if (mailingStreet || mailingCity || mailingState || mailingZip) {
        const parts = [];
        if (mailingStreet) parts.push(mailingStreet);
        if (mailingCity || mailingState || mailingZip) {
          const cityStateZip = [mailingCity, mailingState, mailingZip].filter(Boolean).join(', ');
          parts.push(cityStateZip);
        }
        mailingAddress = parts.join(', ');
      }

      // Get selected codes
      const selectedCodes = window.selectedCustomerCodes.map(code => ({
        id: code.id,
        name: code.name,
        type: code.type || 'percentage',
        amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
        percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
      }));

      // Get factor
      const factor = document.getElementById('newCustomerFactor')?.value.trim() || '';

      // Get cycle number
      const cycleNumber = document.getElementById('newCustomerCycleNumber')?.value.trim() || '';

      if (!name || !email || !locationId || !phone) {
        alert('Please fill in all required fields');
        return;
      }

      // Find the selected location
      const selectedLocation = locations.find(l => l.id === locationId);
      if (!selectedLocation) {
        alert('Selected location not found');
        return;
      }

      if (selectedLocation.status === 'occupied') {
        alert('This location is already occupied. Please select an available location.');
        return;
      }

      // Calculate current month's bill
      const now = window.getCurrentDate();
      const isNewMonth = now.getDate() === 1; // Check if it's the first of the month

      const newCustomer = {
        id: `CUS-${String(customers.length + 1).padStart(6, '0')}`,
        name: name,
        email: email,
        locationId: locationId,
        address: selectedLocation.address,
        accountNumber: `CUS-${String(customers.length + 1).padStart(6, '0')}`,
        currentBill: isNewMonth ? sewerCharge : 0, // New bill on 1st of month, otherwise 0
        pastDue: 0,
        lastPayment: 'Never',
        needsPasswordChange: true,
        createdDate: (() => {
          const today = window.getCurrentDate();
          return (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                 today.getDate().toString().padStart(2, '0') + '/' + 
                 today.getFullYear();
        })(),
        phone: phone,
        paymentHistory: [], // Track payment history
        entityType: entityType,
        ssn: ssn,
        idType: idType,
        idNumber: idNumber,
        secondaryContactName: secondaryContactName,
        secondaryContactPhone: secondaryContactPhone,
        mailingAddress: mailingAddress,
        mailingStreet: mailingStreet,
        mailingCity: mailingCity,
        mailingState: mailingState,
        mailingZip: mailingZip,
        codes: selectedCodes,
        factor: factor,
        cycleNumber: cycleNumber || null
      };

      // Update payment status based on past due amount
      updateCustomerPaymentStatus(newCustomer);

      // Update location status and owner
      selectedLocation.currentResident = name;
      selectedLocation.status = 'occupied';
      selectedLocation.ownerFirstName = name.split(' ')[0];
      selectedLocation.ownerLastName = name.split(' ').slice(1).join(' ');
      selectedLocation.ownerFullName = name;

      customers.push(newCustomer);
      filteredCustomers = [...customers];

      // Clear selected codes after creation
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();

      updateDashboard();
      await saveCustomersToFirestore();
      hideAddCustomerModal();

      alert('Customer added successfully!');
    };

    // Mark customer as paid
    window.markAsPaid = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        const today = window.getCurrentDate();
        const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();

        customer.pastDue = 0;
        customer.lastPayment = formattedDate;
        customer.currentBill = 0; // Reset current bill to 0 for early payment
        // Update payment status based on past due amount
        updateCustomerPaymentStatus(customer);
        updateDashboard();
        await saveCustomersToFirestore();
        alert('Payment recorded successfully! Amount due is now $0.00 until next month.');
      }
    };

    // Edit customer
    window.editCustomer = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        const newName = prompt('Enter new name:', customer.name);
        const newAddress = prompt('Enter new address:', customer.address);

        if (newName && newAddress) {
          customer.name = newName;
          customer.address = newAddress;
          updateDashboard();
          await saveCustomersToFirestore();
          alert('Customer updated successfully!');
        }
      }
    };

    // Delete customer
    window.deleteCustomer = async function(customerId) {
      if (confirm('Are you sure you want to delete this customer? This will permanently delete their account and all associated data.')) {
        const customer = customers.find(c => c.id === customerId);

        if (!customer) {
          alert('Customer not found');
          return;
        }

        try {
          // Delete customer document from Firestore
          const customerRef = doc(db, 'customers', customerId);
          await deleteDoc(customerRef);

          // Remove from local arrays FIRST
          customers = customers.filter(c => c.id !== customerId);
          filteredCustomers = [...customers];

          // Find and update the associated location
          const associatedLocation = locations.find(l => l.currentResident === customer.name);
          if (associatedLocation) {
            associatedLocation.currentResident = null;
            associatedLocation.status = 'available';
            associatedLocation.ownerFirstName = '';
            associatedLocation.ownerLastName = '';
            associatedLocation.ownerFullName = '';

            // Update filtered locations if needed
            const filteredLocationIndex = filteredLocations.findIndex(l => l.id === associatedLocation.id);
            if (filteredLocationIndex !== -1) {
              filteredLocations[filteredLocationIndex] = associatedLocation;
            }

            // Save location changes to Firestore
            await saveLocationsToFirestore();
          }

          // Reload data from Firestore to ensure UI is in sync
          await loadCustomersFromFirestore();

          // Update displays
          updateDashboard();
          updateSettingsCustomerTable();

          alert('Customer deleted successfully! Password will be reset to "password" on next login and all payment history has been cleared.');
        } catch (error) {

          alert('Error deleting customer: ' + error.message);
        }
      }
    };

    // Delete all user data
    window.deleteAllUserData = async function() {
      const confirmMessage = 'Are you sure you want to delete ALL customer data? This action cannot be undone and will permanently delete all customers from the database.';
      if (!confirm(confirmMessage)) {
        return;
      }

      // Double confirmation
      const doubleConfirm = confirm('This will delete ALL customer data. Type OK to confirm, or Cancel to abort.');
      if (!doubleConfirm) {
        return;
      }

      try {

        // Show progress modal
        const deleteProgressModal = document.getElementById('deleteProgressModal');
        const deleteProgress = document.getElementById('deleteProgress');
        const deleteProgressText = document.getElementById('deleteProgressText');
        const deleteProgressBar = document.getElementById('deleteProgressBar');
        const deleteProgressStats = document.getElementById('deleteProgressStats');

        if (deleteProgressModal) {
          deleteProgressModal.classList.remove('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.remove('hidden');
        }

        const customersRef = collection(db, 'customers');

        // Get all customers from Firestore
        const existingCustomers = await getDocs(customersRef);
        const totalCustomers = existingCustomers.size;
        const customerDocs = [];
        existingCustomers.forEach(doc => {
          customerDocs.push(doc);
        });

        // Process deletions in batches with progress updates (using Firestore batch writes)
        const batchSize = 500; // Firestore batch limit
        let deletedCount = 0;

        for (let i = 0; i < customerDocs.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchDocs = customerDocs.slice(i, Math.min(i + batchSize, customerDocs.length));

          batchDocs.forEach(doc => {
            batch.delete(doc.ref);
          });

          await batch.commit();
          deletedCount += batchDocs.length;

          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customerDocs.length) {
            await new Promise(resolve => setTimeout(resolve, 200));
          }

          // Update progress
          const percent = Math.round((deletedCount / totalCustomers) * 100);
          if (deleteProgressText) {
            deleteProgressText.textContent = `${deletedCount} / ${totalCustomers}`;
          }
          if (deleteProgressBar) {
            deleteProgressBar.style.width = percent + '%';
          }
          if (deleteProgressStats) {
            deleteProgressStats.textContent = `Deleted: ${deletedCount} of ${totalCustomers} customers`;
          }

          // Allow UI to update
          await new Promise(resolve => setTimeout(resolve, 0));
        }

        // Update progress to 100%
        if (deleteProgressText) {
          deleteProgressText.textContent = `${totalCustomers} / ${totalCustomers}`;
        }
        if (deleteProgressBar) {
          deleteProgressBar.style.width = '100%';
        }
        if (deleteProgressStats) {
          deleteProgressStats.textContent = `Deleted: ${totalCustomers} of ${totalCustomers} customers`;
        }

        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 100));

        // Clear local arrays
        customers = [];
        filteredCustomers = [];

        // Update status: Updating locations
        if (deleteProgressStats) {
          deleteProgressStats.textContent = 'Updating locations...';
        }
        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 50));

        // Update all locations to be available
        locations.forEach(location => {
          location.currentResident = null;
          location.status = 'available';
          location.ownerFirstName = '';
          location.ownerLastName = '';
          location.ownerFullName = '';
        });
        filteredLocations = [...locations];

        // Save location changes
        await saveLocationsToFirestore();

        // Update status: Finalizing
        if (deleteProgressStats) {
          deleteProgressStats.textContent = 'Finalizing...';
        }
        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 50));

        // Reload data from Firestore to ensure UI is in sync
        await loadCustomersFromFirestore();

        // Update displays
        updateDashboard();
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Hide progress modal
        if (deleteProgressModal) {
          deleteProgressModal.classList.add('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.add('hidden');
        }

        // Close settings module if it's open
        if (window.hideAllModules) {
          window.hideAllModules();
        }

        // Show success alert
        alert(`Successfully deleted ${totalCustomers} customer${totalCustomers !== 1 ? 's' : ''}!`);
      } catch (error) {

        // Hide progress modal on error
        const deleteProgressModal = document.getElementById('deleteProgressModal');
        const deleteProgress = document.getElementById('deleteProgress');
        if (deleteProgressModal) {
          deleteProgressModal.classList.add('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.add('hidden');
        }

        alert('Error deleting customer data: ' + error.message);
      }
    };

    // Debounce timer for search
    let searchDebounceTimer = null;

    // Search customers (for main table and settings table - same logic as payment module search)
    window.searchCustomersTable = function() {
      // Clear existing debounce timer
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }

      // Debounce the search to prevent lag
      searchDebounceTimer = setTimeout(() => {
      // Check both search inputs (main table and settings table)
        // Prioritize the one that's currently visible/active
      const mainSearch = document.getElementById('customerSearch');
      const settingsSearch = document.getElementById('settingsCustomerSearch');

        // Determine which search input to use based on which module is visible
        const settingsModule = document.getElementById('settingsModule');
        const isSettingsVisible = settingsModule && !settingsModule.classList.contains('hidden');

        let searchTerm = '';
        if (isSettingsVisible && settingsSearch) {
          // Settings is visible, use settings search
          searchTerm = (settingsSearch.value || '').toLowerCase().trim();

        } else if (mainSearch) {
          // Main table is visible, use main search
          searchTerm = (mainSearch.value || '').toLowerCase().trim();

        } else if (settingsSearch) {
          // Fallback to settings search
          searchTerm = (settingsSearch.value || '').toLowerCase().trim();

        }

        // If search is empty, show all customers
        if (!searchTerm || searchTerm.length === 0) {
          filteredCustomers = [...customers];

        } else {
          // Use the same search logic as payment module - search by name, account number, or address
          // Split search term into words for better matching
          const searchWords = searchTerm.split(/\s+/).filter(word => word.length > 0);

          filteredCustomers = customers.filter(customer => {
            const customerName = (customer.name || '').toLowerCase().trim();
            const customerAccount = (customer.accountNumber || customer.id || '').toLowerCase().trim();
            const customerAddress = (customer.address || '').toLowerCase().trim();
            const customerEmail = (customer.email || '').toLowerCase().trim();

            // If multiple words, all must match somewhere
            if (searchWords.length > 1) {
              return searchWords.every(word => 
                customerName.includes(word) || 
                customerAccount.includes(word) || 
                customerAddress.includes(word) || 
                customerEmail.includes(word)
              );
            } else {
              // Single word - match anywhere
              return customerName.includes(searchTerm) || 
                     customerAccount.includes(searchTerm) || 
                     customerAddress.includes(searchTerm) || 
                     customerEmail.includes(searchTerm);
            }
          });

          if (filteredCustomers.length > 0) {

          } else {

          }
        }

        // Force update both tables

      updateCustomerTable();
      updateSettingsCustomerTable(); // Update settings table count as well

        // Double-check that the table was updated
        const tbody = document.getElementById('settingsCustomerTableBody');
        if (tbody) {
          const rowCount = tbody.querySelectorAll('tr').length;

          if (rowCount !== filteredCustomers.length && filteredCustomers.length > 0) {

            // Force re-render
            updateSettingsCustomerTable();
          }
        }
      }, 150); // 150ms debounce delay
    };

    // Filter by status or codes
    window.filterByStatus = function(status) {
      if (status === 'all') {
        filteredCustomers = [...customers];
      } else if (status === 'no-codes') {
        filteredCustomers = customers.filter(c => !c.codes || c.codes.length === 0);
      } else if (status === 'has-codes') {
        filteredCustomers = customers.filter(c => c.codes && c.codes.length > 0);
      } else {
        filteredCustomers = customers.filter(c => c.paymentStatus === status);
      }
      updateCustomerTable();
      updateSettingsCustomerTable(); // Update settings table count as well
    };

    // Location management functions
    function updateLocationsTable() {
      const tbody = document.getElementById('locationsTableBody');
      tbody.innerHTML = '';

      filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = location.status === 'occupied' 
          ? 'bg-green-100 text-green-800' 
          : location.status === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : 'bg-blue-100 text-blue-800';

        const statusText = location.status === 'occupied' 
          ? 'Occupied' 
          : location.status === 'inactive'
          ? 'Inactive'
          : 'Available';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${location.premiseId || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'address', '${location.address}')" 
                 title="Double-click to edit">
              ${location.address}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${location.currentResident ? `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'currentResident', '${location.currentResident}')" 
                 title="Double-click to edit">
              ${location.currentResident}
            </div>
            ` : `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'ownerFullName', '${location.ownerFullName || 'No Owner'}')" 
                 title="Double-click to edit">
              ${location.ownerFullName || 'No Owner'}
            </div>
            `}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editField('${location.id}', 'status', '${location.status}')" 
                  title="Double-click to edit">
              ${statusText}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteLocation('${location.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Settings module table update functions
    function updateSettingsCustomerTable() {
      const tbody = document.getElementById('settingsCustomerTableBody');
      tbody.innerHTML = '';

      // Update the customer count display in settings
      const countDisplay = document.getElementById('settingsCustomerCountDisplay');
      const totalDisplay = document.getElementById('settingsCustomerTotalDisplay');
      if (countDisplay) countDisplay.textContent = filteredCustomers.length;
      if (totalDisplay) totalDisplay.textContent = customers.length;

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        // Calculate due date as last day of current month
        const now = window.getCurrentDate();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early (before due date)
        const hasPaidEarly = customer.lastPayment && customer.lastPayment !== 'Never' && 
                            customer.lastPayment.includes('/') && 
                            new Date(customer.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount based on breakdown logic
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due

        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate code surcharges (applied to adjusted service cost after factor, affected by factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            let baseSurcharge;
            if (codeType === 'flat') {
              baseSurcharge = codeAmount;
            } else {
              baseSurcharge = adjustedServiceCost * (codeAmount / 100);
            }
            // Apply factor to tax codes
            totalSurcharge += baseSurcharge * factor;
          });
        }

        // Calculate subtotal: adjusted service cost + tax codes (both affected by factor)
        const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;

        // Calculate PUC Surcharge (applied to subtotal, NOT affected by factor)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = subtotalBeforePuc * (pucSurcharge / 100);
        }

        const totalAmount = hasPaidEarly ? 0 : (subtotalBeforePuc + pastDue + lateFeeAmount + pucSurchargeAmount);

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'accountNumber', '${customer.accountNumber}')" 
                 title="Double-click to edit">
              ${customer.accountNumber}
            </div>
          </td>
          <td class="px-0 py-4 pr-0 -mr-4 whitespace-nowrap text-center max-w-[180px]">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'name', '${customer.name}')" 
                 title="Double-click to edit">
              ${customer.name}
            </div>
            <div class="flex flex-col items-center gap-1 mt-2">
              <button 
                onclick="showCustomerFullInfo('${customer.id}')" 
                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium"
              >
                View Full Info
              </button>
              <button 
                onclick="showCustomerDataProfile('${customer.id}')" 
                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 text-xs font-medium"
              >
                View Data Profile
              </button>
            </div>
          </td>
          <td class="px-0 py-4 pl-0 -ml-4 text-center max-w-[180px]">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'address', '${getCustomerDisplayAddress(customer)}')" 
                 title="Double-click to edit">
              ${(() => {
                const displayAddress = getCustomerDisplayAddress(customer);
                if (typeof displayAddress === 'string' && displayAddress.includes(',')) {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress.split(',')[0].trim()}</div>
                  <div class="text-slate-500 dark:text-slate-400 whitespace-nowrap">${displayAddress.split(',').slice(1).join(',').trim()}</div>`;
                } else {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress}</div>`;
                }
              })()}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editCustomerField('${customer.id}', 'paymentStatus', '${customer.paymentStatus}')" 
                  title="Double-click to edit">
              ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-900 dark:text-slate-100">
            <div class="font-medium">$${totalAmount.toFixed(2)}</div>
            <button onclick="showAmountDetails('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
              View Details
            </button>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600 dark:text-slate-400">
            <div class="flex flex-wrap gap-1 justify-center">
              ${pucSurcharge > 0 ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">PUC SCHG SW (${pucSurcharge.toFixed(2)}%)</span>` : ''}
              ${customer.codes && customer.codes.length > 0 
                ? customer.codes.map(code => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.name}</span>`).join('')
                : (pucSurcharge > 0 ? '' : '<span class="text-slate-400 dark:text-slate-500">—</span>')
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <div class="flex flex-col space-y-2">
              <button onclick="showPaymentModal('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Mark Paid
              </button>
              <button onclick="showPaymentHistory('${customer.id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                View History
              </button>
              <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateCodesTable() {

      const tbody = document.getElementById('settingsCodesTableBody');
      tbody.innerHTML = '';

      if (codes.length === 0) {

        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              You don't have any codes currently
            </td>
          </tr>
        `;
        return;
      }

      codes.forEach(code => {
        // Default to 'percentage' type for existing codes without type
        const codeType = code.type || 'percentage';
        const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);

        // Log each code when rendering the table

        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'name', '${(code.name || '').replace(/'/g, "\\'")}')" 
                 title="Double-click to edit">
              ${code.name || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'type', '${codeType}')" 
                 title="Double-click to edit">
              ${codeType === 'flat' ? 'Flat Rate' : 'Percentage'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'amount', '${codeAmount}')" 
                 title="Double-click to edit">
              ${codeType === 'flat' ? `$${parseFloat(codeAmount).toFixed(2)}` : `${parseFloat(codeAmount).toFixed(2)}%`}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'description', '${(code.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" 
                 title="Double-click to edit">
              ${code.description || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'requirements', '${JSON.stringify(code.requirements || {}).replace(/'/g, "\\'")}')" 
                 title="Double-click to edit">
              ${code.requirements && code.requirements.values && code.requirements.values.length > 0 
                ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.requirements.values.join(` ${code.requirements.type} `)}</span>`
                : code.requirements && Array.isArray(code.requirements) && code.requirements.length > 0
                  ? code.requirements.map(req => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 mr-1">${req}</span>`).join('')
                  : '<span class="text-slate-400 dark:text-slate-500">—</span>'
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex flex-col space-y-2 items-end">
              <button onclick="applyCodeToAll('${code.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Apply to All
              </button>
            <button onclick="deleteCode('${code.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateSettingsLocationsTable() {
      const tbody = document.getElementById('settingsLocationsTableBody');
      tbody.innerHTML = '';

      filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = location.status === 'occupied' 
          ? 'bg-green-100 text-green-800' 
          : location.status === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : 'bg-blue-100 text-blue-800';

        const statusText = location.status === 'occupied' 
          ? 'Occupied' 
          : location.status === 'inactive'
          ? 'Inactive'
          : 'Available';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${location.premiseId || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'address', '${location.address}')" 
                 title="Double-click to edit">
              ${location.address}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${location.currentResident ? `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'currentResident', '${location.currentResident}')" 
                 title="Double-click to edit">
              ${location.currentResident}
            </div>
            ` : `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'ownerFullName', '${location.ownerFullName || 'No Owner'}')" 
                 title="Double-click to edit">
              ${location.ownerFullName || 'No Owner'}
            </div>
            `}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editField('${location.id}', 'status', '${location.status}')" 
                  title="Double-click to edit">
              ${statusText}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteLocation('${location.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateSettingsUsersTable() {
      const tbody = document.getElementById('settingsUsersTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!filteredUsers || filteredUsers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              You don't have any users yet.
            </td>
          </tr>
        `;
        return;
      }

      filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        let createdDate = '—';
        if (user.createdAt) {
          try {
            createdDate = new Date(user.createdAt).toLocaleDateString('en-US');
          } catch (error) {
            createdDate = user.createdAt;
          }
        }

        const titleDisplay = user.title || '—';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div id="user-fullname-${user.id}" class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 px-2 py-1 rounded" ondblclick="editUserName('${user.id}')" title="Double-click to edit">
              ${user.fullName || 'Unnamed User'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div id="user-usercode-${user.id}" class="text-sm text-slate-700 dark:text-slate-300 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 px-2 py-1 rounded" ondblclick="editUserCode('${user.id}')" title="Double-click to edit">
              ${user.userCode || '—'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div id="user-title-${user.id}" class="text-sm text-slate-700 dark:text-slate-300 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 px-2 py-1 rounded" ondblclick="editUserTitle('${user.id}')" title="Double-click to edit">
              ${titleDisplay}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
            ${createdDate}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Drawer management functions
    function updateSettingsDrawersTable() {
      const tbody = document.getElementById('settingsDrawersTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!drawers || drawers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              No drawers have been created yet. Add a drawer using the form above.
            </td>
          </tr>
        `;
        return;
      }

      drawers.forEach(drawer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        let createdDate = '—';
        if (drawer.createdAt) {
          try {
            const date = new Date(drawer.createdAt);
            createdDate = date.toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (error) {
            createdDate = drawer.createdAt;
          }
        }

        const statusBadge = drawer.available ? 
          '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">SOD Has Been Counted</span>' :
          '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Needs Start Of Day Count</span>';

        const fundValue = drawer.fundValue !== undefined ? `$${parseFloat(drawer.fundValue || 0).toFixed(2)}` : '$0.00';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div 
              id="drawer-name-${drawer.id}" 
              class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 px-2 py-1 rounded"
              ondblclick="editDrawerName('${drawer.id}')"
              title="Double-click to edit"
            >
              ${drawer.name || 'Unnamed Drawer'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div 
              id="drawer-fund-${drawer.id}" 
              class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 px-2 py-1 rounded"
              ondblclick="editDrawerFundValue('${drawer.id}')"
              title="Double-click to edit"
            >
              ${fundValue}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
            ${createdDate}
            <div class="mt-1">${statusBadge}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex gap-2 justify-end">
              <button onclick="resetDrawer('${drawer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Reset
              </button>
              <button onclick="deleteDrawer('${drawer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    window.addDrawer = async function() {
      const nameInput = document.getElementById('newDrawerName');
      const fundInput = document.getElementById('newDrawerFund');
      const name = nameInput.value.trim();
      const fundValue = parseFloat(fundInput?.value || 0) || 0;

      if (!name) {
        alert('Please enter a drawer name.');
        return;
      }

      // Check if drawer name already exists
      if (drawers.some(d => d.name.toLowerCase() === name.toLowerCase())) {
        alert('A drawer with this name already exists.');
        return;
      }

      const newDrawer = {
        id: `DRW-${Date.now()}`,
        name: name,
        fundValue: fundValue,
        available: false, // New drawers need to be counted before they're available
        createdAt: new Date().toISOString()
      };

      drawers.push(newDrawer);
      // Sort by created date (newest first)
      drawers.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

      await saveDrawersToFirestore();
      updateSettingsDrawersTable();

      // Clear inputs
      nameInput.value = '';
      if (fundInput) fundInput.value = '';

      alert('Drawer added successfully!');
    };

    window.resetDrawer = async function(drawerId) {
      const drawer = drawers.find(d => d.id === drawerId);
      if (!drawer) {
        alert('Drawer not found.');
        return;
      }

      if (!confirm(`Are you sure you want to reset "${drawer.name}"? This will delete and recreate the drawer, clearing its count history.`)) {
        return;
      }

      // Save drawer properties
      const drawerName = drawer.name;
      const drawerFundValue = drawer.fundValue !== undefined ? parseFloat(drawer.fundValue || 0) : 0;

      // Delete the drawer
      drawers = drawers.filter(d => d.id !== drawerId);

      // Create a new drawer with the same name and fund value
      const newDrawer = {
        id: `DRW-${Date.now()}`,
        name: drawerName,
        fundValue: drawerFundValue,
        available: false, // Reset drawers need to be counted before they're available
        createdAt: new Date().toISOString()
      };

      drawers.push(newDrawer);
      // Sort by created date (newest first)
      drawers.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

      await saveDrawersToFirestore();
      updateSettingsDrawersTable();
      alert(`Drawer "${drawerName}" has been reset successfully!`);
    };

    window.resetAllDrawers = async function() {
      if (!drawers || drawers.length === 0) {
        alert('No drawers to reset.');
        return;
      }

      if (!confirm(`Are you sure you want to reset ALL drawers? This will delete and recreate ${drawers.length} drawer(s), clearing count history and requiring new SOD counts.`)) {
        return;
      }

      // Preserve drawer properties
      const preserved = drawers.map(d => ({
        name: d.name,
        fundValue: d.fundValue !== undefined ? parseFloat(d.fundValue || 0) : 0
      }));

      const baseTimestamp = Date.now();
      drawers = preserved.map((d, idx) => ({
        id: `DRW-${baseTimestamp}-${idx}`,
        name: d.name,
        fundValue: d.fundValue,
        available: false,
        createdAt: new Date().toISOString()
      }));

      // Sort by created date (newest first)
      drawers.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

      await saveDrawersToFirestore();
      updateSettingsDrawersTable();

      alert('All drawers have been reset successfully!');
    };

    window.deleteDrawer = async function(drawerId) {
      if (!confirm('Are you sure you want to delete this drawer? This action cannot be undone.')) {
        return;
      }

      drawers = drawers.filter(d => d.id !== drawerId);
      await saveDrawersToFirestore();
      updateSettingsDrawersTable();
      alert('Drawer deleted successfully!');
    };

    // Edit drawer name inline
    window.editDrawerName = function(drawerId) {
      const drawer = drawers.find(d => d.id === drawerId);
      if (!drawer) return;

      const cell = document.getElementById(`drawer-name-${drawerId}`);
      if (!cell) return;

      const currentName = drawer.name || '';
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentName;
      input.className = 'text-sm font-medium text-slate-900 dark:text-slate-100 w-full px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800';

      const saveEdit = async () => {
        const newName = input.value.trim();
        if (newName === currentName) {
          cell.innerHTML = currentName || 'Unnamed Drawer';
          return;
        }

        if (!newName) {
          alert('Drawer name cannot be empty.');
          cell.innerHTML = currentName || 'Unnamed Drawer';
          return;
        }

        // Check if another drawer with this name exists
        if (drawers.some(d => d.id !== drawerId && d.name.toLowerCase() === newName.toLowerCase())) {
          alert('A drawer with this name already exists.');
          cell.innerHTML = currentName || 'Unnamed Drawer';
          return;
        }

        drawer.name = newName;
        await saveDrawersToFirestore();
        updateSettingsDrawersTable();
      };

      const cancelEdit = () => {
        cell.innerHTML = currentName || 'Unnamed Drawer';
      };

      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });

      cell.innerHTML = '';
      cell.appendChild(input);
      input.focus();
      input.select();
    };

    // Edit drawer fund value inline
    window.editDrawerFundValue = function(drawerId) {
      const drawer = drawers.find(d => d.id === drawerId);
      if (!drawer) return;

      const cell = document.getElementById(`drawer-fund-${drawerId}`);
      if (!cell) return;

      const currentFundValue = drawer.fundValue !== undefined ? parseFloat(drawer.fundValue || 0) : 0;
      const currentDisplay = `$${currentFundValue.toFixed(2)}`;

      const input = document.createElement('input');
      input.type = 'number';
      input.step = '0.01';
      input.min = '0';
      input.value = currentFundValue;
      input.className = 'text-sm text-slate-900 dark:text-slate-100 w-full px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800';

      const saveEdit = async () => {
        const newValue = parseFloat(input.value) || 0;
        if (newValue === currentFundValue) {
          cell.innerHTML = currentDisplay;
          return;
        }

        if (newValue < 0) {
          alert('Fund value cannot be negative.');
          cell.innerHTML = currentDisplay;
          return;
        }

        drawer.fundValue = newValue;
        await saveDrawersToFirestore();
        updateSettingsDrawersTable();
      };

      const cancelEdit = () => {
        cell.innerHTML = currentDisplay;
      };

      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });

      cell.innerHTML = '';
      cell.appendChild(input);
      input.focus();
      input.select();
    };

    // Global variable to store selected drawer for POS users
    let selectedDrawer = null;

    // Show drawer selection modal
    function showDrawerSelectionModal() {
      const modal = document.getElementById('drawerSelectionModal');
      const list = document.getElementById('drawerSelectionList');
      const errorDiv = document.getElementById('drawerSelectionError');

      if (!modal || !list) return;

      // Clear error
      if (errorDiv) {
        errorDiv.classList.add('hidden');
        errorDiv.textContent = '';
      }

      // Check if drawers are loaded
      if (!drawers || drawers.length === 0) {
        list.innerHTML = `
          <div class="text-center py-8 text-slate-500 dark:text-slate-400">
            <p class="mb-4">No drawers have been created yet.</p>
            <p class="text-sm mb-6">Please contact an administrator to add drawers in Settings.</p>
            <button 
              onclick="logout()" 
              class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors"
            >
              Logout
            </button>
          </div>
        `;
        modal.classList.remove('hidden');
        return;
      }

      // Replace drawer list with search bar
      list.innerHTML = '';
      const today = window.getCurrentDate();
      const availableDrawers = drawers.filter(drawer => {
        if (!drawer.lastCountDate) return false;
        const lastCountDate = new Date(drawer.lastCountDate);
        // Check if same day (year, month, day)
        return lastCountDate.getFullYear() === today.getFullYear() &&
               lastCountDate.getMonth() === today.getMonth() &&
               lastCountDate.getDate() === today.getDate();
      });

      if (availableDrawers.length === 0) {
        list.innerHTML = `
          <div class="text-center py-8 text-slate-500 dark:text-slate-400">
            <p class="mb-4">No drawers are available at this time.</p>
            <p class="text-sm mb-6">Please wait for a supervisor to complete the drawer count.</p>
            <button 
              onclick="logout()" 
              class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors"
            >
              Logout
            </button>
          </div>
        `;
        modal.classList.remove('hidden');
        return;
      }

      // Create search input
      const searchContainer = document.createElement('div');
      searchContainer.className = 'mb-4';
      searchContainer.innerHTML = `
        <input 
          type="text" 
          id="drawerSearchInput" 
          placeholder="Enter drawer name..." 
          class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
          autocomplete="off"
        />
        <div id="drawerSearchResults" class="mt-2 space-y-2"></div>
      `;
      list.appendChild(searchContainer);

      const searchInput = document.getElementById('drawerSearchInput');
      const searchResults = document.getElementById('drawerSearchResults');

      // Search function
      function performDrawerSearch() {
        const query = searchInput.value.trim().toLowerCase();
        searchResults.innerHTML = '';

        if (!query) {
          return;
        }

        const matchingDrawers = availableDrawers.filter(drawer => 
          drawer.name.toLowerCase().includes(query)
        );

        if (matchingDrawers.length === 0) {
          searchResults.innerHTML = `
            <div class="text-center py-4 text-slate-500 dark:text-slate-400">
              <p>No drawers found matching "${query}"</p>
            </div>
          `;
          return;
        }

        matchingDrawers.forEach(drawer => {
          const button = document.createElement('button');
          button.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors text-left';
          button.innerHTML = `
            <div class="flex items-center justify-between">
              <span>${drawer.name}</span>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          `;
          button.onclick = () => selectDrawer(drawer);
          searchResults.appendChild(button);
        });
      }

      // Add event listener for live search
      searchInput.addEventListener('input', performDrawerSearch);
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const firstResult = searchResults.querySelector('button');
          if (firstResult) {
            firstResult.click();
          }
        }
      });

      // Add logout button below search
      const logoutButton = document.createElement('button');
      logoutButton.className = 'w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors';
      logoutButton.innerHTML = `
        <div class="flex items-center justify-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          <span>Log Out</span>
        </div>
      `;
      logoutButton.onclick = () => logout();
      list.appendChild(logoutButton);

      // Focus search input
      setTimeout(() => {
        searchInput.focus();
      }, 100);

      modal.classList.remove('hidden');
    }

    // Hide drawer selection modal
    function hideDrawerSelectionModal() {
      const modal = document.getElementById('drawerSelectionModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Select drawer (for POS users - no cancel option)
    window.selectDrawer = async function(drawer) {
      if (!drawer) {
        // This shouldn't happen for POS users, but handle gracefully
        return;
      }

      selectedDrawer = drawer;

      // Check if this drawer has been verified today
      const today = window.getCurrentDate();
      const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format
      
      // Load payment processing sessions if not already loaded
      try {
        if (typeof loadPaymentProcessingSessionsFromFirestore === 'function') {
          await loadPaymentProcessingSessionsFromFirestore();
        }
      } catch (error) {
        console.error('Error loading payment processing sessions:', error);
      }
      
      // Check if there's a verified session for this drawer today
      const verifiedSession = (window.paymentProcessingSessions || []).find(session => {
        if (!session.drawer || !session.drawer.id) return false;
        if (session.drawer.id !== drawer.id) return false;
        if (!session.verifiedAt) return false;
        
        const verifiedDate = new Date(session.verifiedAt);
        const verifiedDateStr = verifiedDate.toISOString().split('T')[0];
        return verifiedDateStr === todayStr;
      });
      
      // If drawer has been verified today, clear the payment processing session
      if (verifiedSession) {
        console.log('[selectDrawer] Drawer has been verified today, clearing payment processing session');
        window.currentPaymentProcessing = null;
        if (typeof localStorage !== 'undefined') {
          try {
            localStorage.removeItem('currentPaymentProcessingSession');
          } catch (e) {
            console.error('Error clearing localStorage:', e);
          }
        }
        // Refresh the payment preview to show empty state
        if (typeof renderPaymentProcessingPreview === 'function') {
          renderPaymentProcessingPreview();
        }
      }

      hideDrawerSelectionModal();
      hideFirebaseAuthModal();

      // Show a brief confirmation
      alert(`You are now working with: ${drawer.name}`);
    };

    // Supervisor drawer selection functions
    let selectedDrawerForCount = null;

    window.showDrawerCountSelection = function() {
      const modal = document.getElementById('supervisorDrawerSelectionModal');
      const list = document.getElementById('supervisorDrawerSelectionList');

      if (!modal || !list) return;

      // Ensure drawers are loaded
      if (drawers.length === 0) {
        loadDrawersFromFirestore().then(() => {
          populateSupervisorDrawerList();
        });
      } else {
        populateSupervisorDrawerList();
      }

      modal.classList.remove('hidden');
    };

    function populateSupervisorDrawerList() {
      const list = document.getElementById('supervisorDrawerSelectionList');
      if (!list) return;

      list.innerHTML = '';

      if (!drawers || drawers.length === 0) {
        list.innerHTML = `
          <div class="text-center py-8 text-slate-500 dark:text-slate-400">
            <p class="mb-4">No drawers have been created yet.</p>
            <p class="text-sm">Please add drawers in Settings → Drawers.</p>
          </div>
        `;
        return;
      }

      drawers.forEach(drawer => {
        const button = document.createElement('button');
        // Check if drawer was counted TODAY
        let isAvailableToday = false;
        if (drawer.lastCountDate) {
          const lastCountDate = new Date(drawer.lastCountDate);
          const today = window.getCurrentDate();
          // Check if same day (year, month, day)
          isAvailableToday = lastCountDate.getFullYear() === today.getFullYear() &&
                             lastCountDate.getMonth() === today.getMonth() &&
                             lastCountDate.getDate() === today.getDate();
        }
        const statusBadge = isAvailableToday ? 
          '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">SOD Has Been Counted</span>' :
          '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Needs SOD Count</span>';

        button.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors text-left';
        button.innerHTML = `
          <div class="flex items-center justify-between w-full">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-3">
                <span class="font-semibold">${drawer.name}</span>
                ${statusBadge}
              </div>
              <div class="flex gap-2 mt-3">
                <button 
                  onclick="event.stopPropagation(); selectDrawerForCountById('${drawer.id}');" 
                  class="px-4 py-3 text-sm font-medium bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg transition-colors"
                >
                  Start Drawer Count
                </button>
                <button 
                  onclick="event.stopPropagation(); showDrawerCountHistory('${drawer.id}', 'SOD')" 
                  class="px-4 py-3 text-sm font-medium bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg transition-colors"
                >
                  Drawer History
                </button>
              </div>
            </div>
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        `;
        button.onclick = () => selectDrawerForCount(drawer);
        list.appendChild(button);
      });
    }

    window.selectDrawerForCount = function(drawer) {
      selectedDrawerForCount = drawer;
      hideSupervisorDrawerSelectionModal();
      showDrawerCountScreen(drawer);
    };

    window.selectDrawerForCountById = function(drawerId) {
      const drawer = drawers.find(d => d.id === drawerId);
      if (drawer) {
        selectDrawerForCount(drawer);
      }
    };

    // Store the most recent count for printing
    let lastDrawerCountForPrint = null;

    window.showDrawerCountSuccessModal = function(drawer, countRecord) {
      const modal = document.getElementById('drawerCountSuccessModal');
      const title = document.getElementById('drawerCountSuccessTitle');
      const content = document.getElementById('drawerCountSuccessContent');

      if (!modal || !title || !content) return;

      // Store for printing
      lastDrawerCountForPrint = { drawer, countRecord };

      title.textContent = `Drawer "${drawer.name}" Counted Successfully`;
      content.innerHTML = `
        <p class="text-lg font-semibold text-slate-900 dark:text-slate-100">Total: $${countRecord.total.toFixed(2)}</p>
        <p>Counted by: ${countRecord.countedBy}</p>
        <p class="text-sm text-slate-500 dark:text-slate-400">The drawer has been marked as available.</p>
      `;

      modal.classList.remove('hidden');
    };

    window.hideDrawerCountSuccessModal = function() {
      console.log('[hideDrawerCountSuccessModal] ========== FUNCTION CALLED ==========');
      const modal = document.getElementById('drawerCountSuccessModal');
      if (modal) {
        console.log('[hideDrawerCountSuccessModal] Hiding success modal');
        modal.classList.add('hidden');
      }
      lastDrawerCountForPrint = null;
      
      // Always show dashboard buttons when modal is closed
      console.log('[hideDrawerCountSuccessModal] Showing dashboard buttons...');
      showDashboardButtons();
      console.log('[hideDrawerCountSuccessModal] ========== FUNCTION COMPLETED ==========');
    };

    // Drawer Count Mismatch Modal Functions
    window.showDrawerCountMismatchModal = function(drawerName, expectedValue, actualValue, difference) {
      const modal = document.getElementById('drawerCountMismatchModal');
      const content = document.getElementById('drawerCountMismatchContent');

      if (modal && content) {
        const status = actualValue > expectedValue ? 'over' : 'short';
        const statusText = actualValue > expectedValue ? 'over' : 'short';

        content.innerHTML = `
          <p class="font-semibold text-slate-900 dark:text-slate-100">Drawer: ${drawerName}</p>
          <p class="mt-2">Expected Drawer Start Of Day Amount: <span class="font-semibold">$${expectedValue.toFixed(2)}</span></p>
          <p>Your Count: <span class="font-semibold">$${actualValue.toFixed(2)}</span></p>
          <p class="mt-3 text-red-600 dark:text-red-400 font-semibold">You are ${statusText} by $${difference.toFixed(2)}</p>
          <p class="mt-2 text-sm">Please recount and try again.</p>
        `;

        modal.classList.remove('hidden');
      }
    };

    window.hideDrawerCountMismatchModal = function() {
      const modal = document.getElementById('drawerCountMismatchModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    };

    // Payment Count Error Modal Functions
    window.showPaymentCountErrorModal = function(title, message) {
      const modal = document.getElementById('paymentCountErrorModal');
      const titleEl = document.getElementById('paymentCountErrorTitle');
      const content = document.getElementById('paymentCountErrorContent');

      if (modal && titleEl && content) {
        titleEl.textContent = title;
        content.textContent = message;
        modal.classList.remove('hidden');
      }
    };

    window.hidePaymentCountErrorModal = function() {
      const modal = document.getElementById('paymentCountErrorModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    };

    // Store the entry index for receipt printing
    let lastPaymentEntryIndex = null;

    window.showPaymentReceiptPopup = function(entryIndex) {
      const modal = document.getElementById('paymentReceiptPopupModal');
      if (!modal) return;

      lastPaymentEntryIndex = entryIndex;
      modal.classList.remove('hidden');
    };

    window.hidePaymentReceiptPopup = function() {
      const modal = document.getElementById('paymentReceiptPopupModal');
      if (modal) {
        modal.classList.add('hidden');
      }
      lastPaymentEntryIndex = null;
    };

    window.handleReceiptPopupYes = function() {
      if (lastPaymentEntryIndex !== null) {
        printPaymentReceipt(lastPaymentEntryIndex);
      }
      hidePaymentReceiptPopup();
    };

    window.printDrawerCountSuccessReceipt = function() {
      if (!lastDrawerCountForPrint) {
        alert('Count record not found');
        return;
      }

      const { drawer, countRecord } = lastDrawerCountForPrint;
      const date = new Date(countRecord.countedAt);
      const dateStr = date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const countType = countRecord.type === 'EOD' ? 'End Of Day' : 'Start Of Day';

      // Build receipt HTML
      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Drawer Count Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
          </style>
        </head>
        <body>
          <h1>${drawer.name} - ${countType} Count Receipt</h1>
          <div class="info">
            <p><strong>Date:</strong> ${dateStr}</p>
            <p><strong>Counted by:</strong> ${countRecord.countedBy}</p>
          </div>
          <h3>Bills</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [1,2,5,10,20,50,100].forEach(v => {
        const billCount = countRecord.bills[v] || 0;
        if (billCount > 0) {
          const amount = billCount * v;
          receiptHtml += `<tr><td>$${v}</td><td>${billCount}</td><td>$${amount.toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <h3>Coins</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        const coinCount = countRecord.coins[k] || 0;
        if (coinCount > 0) {
          const amount = coinCount * val;
          receiptHtml += `<tr><td>${label}</td><td>${coinCount}</td><td>$${amount.toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <div class="total">Total: $${countRecord.total.toFixed(2)}</div>
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin-top: 30px;">Initials: _____________</p>
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    window.hideSupervisorDrawerSelectionModal = function() {
      const modal = document.getElementById('supervisorDrawerSelectionModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    };

    function showDrawerCountScreen(drawer) {
      console.log('[showDrawerCountScreen] ========== FUNCTION CALLED ==========');
      console.log('[showDrawerCountScreen] Drawer:', drawer);
      
      const module = document.getElementById('drawerCountModule');
      const title = document.getElementById('drawerCountTitle');
      const billsContainer = document.getElementById('drawerCountBillsContainer');
      const coinsContainer = document.getElementById('drawerCountCoinsContainer');
      const subtitle = document.getElementById('drawerCountSubtitle');

      console.log('[showDrawerCountScreen] Elements found:');
      console.log('  - module:', module);
      console.log('  - title:', title);
      console.log('  - billsContainer:', billsContainer);
      console.log('  - coinsContainer:', coinsContainer);
      console.log('  - subtitle:', subtitle);

      if (!module || !title || !billsContainer || !coinsContainer) {
        console.error('[showDrawerCountScreen] Missing required elements, returning early');
        return;
      }

      // Hide other modules (but not the drawer count module)
      const paymentModule = document.getElementById('paymentModule');
      const billModule = document.getElementById('billModule');
      const addClientModule = document.getElementById('addClientModule');
      const searchModule = document.getElementById('searchModule');
      const settingsModule = document.getElementById('settingsModule');

      console.log('[showDrawerCountScreen] Hiding other modules:');
      if (paymentModule) {
        paymentModule.classList.add('hidden');
        paymentModule.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
        console.log('  - paymentModule: hidden');
      }
      if (billModule) {
        billModule.classList.add('hidden');
        console.log('  - billModule: hidden');
      }
      if (addClientModule) {
        addClientModule.classList.add('hidden');
        console.log('  - addClientModule: hidden');
      }
      if (searchModule) {
        searchModule.classList.add('hidden');
        console.log('  - searchModule: hidden');
      }
      if (settingsModule) {
        settingsModule.classList.add('hidden');
        console.log('  - settingsModule: hidden');
      }

      // Hide dashboard buttons
      console.log('[showDrawerCountScreen] Calling hideDashboardButtons()...');
      hideDashboardButtons();
      console.log('[showDrawerCountScreen] hideDashboardButtons() completed');

      // Update title with drawer name - this is Start Of Day
      title.textContent = `${drawer.name} Start Of Day Cash Count`;
      if (subtitle) {
        subtitle.textContent = 'Enter quantities to establish the initial register balance.';
      }

      // Display expected drawer fund value - insert right after the title
      let expectedFundDisplay = document.getElementById('drawerCountExpectedFund');
      const fundValue = drawer.fundValue !== undefined ? parseFloat(drawer.fundValue || 0) : 0;

      if (!expectedFundDisplay) {
        // Create the display element if it doesn't exist
        expectedFundDisplay = document.createElement('div');
        expectedFundDisplay.id = 'drawerCountExpectedFund';
        expectedFundDisplay.className = 'mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800';
        // Insert right after the title element
        if (title.nextSibling) {
          title.parentElement.insertBefore(expectedFundDisplay, title.nextSibling);
        } else {
          title.parentElement.appendChild(expectedFundDisplay);
        }
      }

      expectedFundDisplay.innerHTML = `
        <p class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-1">Drawer Start Of Day Amount</p>
        <p class="text-lg font-bold text-blue-900 dark:text-blue-100">$${fundValue.toFixed(2)}</p>
      `;

      // Build bills HTML
      billsContainer.innerHTML = '';
      [1,2,5,10,20,50,100].forEach(v => {
        const billDiv = document.createElement('div');
        billDiv.className = 'flex items-center gap-2';
        billDiv.innerHTML = `
          <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
            <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
            <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
            <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
            <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
            <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
          </svg>
          <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
          <input type="number" min="0" id="drawer_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateDrawerCountTotal()">
        `;
        billsContainer.appendChild(billDiv);
      });

      // Build coins HTML
      coinsContainer.innerHTML = '';
      [['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0'],['dollar',1.00,'Dollar Coin','#FFD700']].forEach(([k,val,label,color]) => {
        const coinDiv = document.createElement('div');
        coinDiv.className = 'flex items-center gap-2';
        const coinSymbol = k === 'penny' ? '1¢' : k === 'nickel' ? '5¢' : k === 'dime' ? '10¢' : k === 'quarter' ? '25¢' : k === 'half' ? '50¢' : '$1';
        coinDiv.innerHTML = `
          <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
            <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
            <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${coinSymbol}</text>
          </svg>
          <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
          <input type="number" min="0" id="drawer_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateDrawerCountTotal()">
        `;
        coinsContainer.appendChild(coinDiv);
      });

      // Show drawer count module (self-contained, doesn't hide dashboard)
      console.log('[showDrawerCountScreen] Showing drawer count module...');
      module.classList.remove('hidden');
      console.log('[showDrawerCountScreen] Drawer count module classes after remove hidden:', module.className);
      console.log('[showDrawerCountScreen] Drawer count module computed display:', window.getComputedStyle(module).display);

      // Scroll module into view
      module.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Update total
      calculateDrawerCountTotal();
      
      // Double-check buttons are hidden after a short delay
      setTimeout(() => {
        console.log('[showDrawerCountScreen] Double-checking buttons are hidden after delay...');
        const buttonContainer = document.querySelector('.flex.flex-col.items-center.gap-4.mb-8.p-8.max-w-2xl.mx-auto.bg-white');
        const sendBillBtn = document.getElementById('sendBillButton');
        const drawerCountBtn = document.getElementById('drawerCountButton');
        console.log('[showDrawerCountScreen] After delay - buttonContainer:', buttonContainer);
        const searchDatabaseBtn = document.getElementById('searchDatabaseButton');
        const endOfDayDrawerCountBtn = document.getElementById('endOfDayDrawerCountButton');
        const businessEndOfDayBtn = document.getElementById('businessEndOfDayButton');
        const logoutBtn = document.getElementById('logoutButton');
        
        console.log('[showDrawerCountScreen] After delay - buttonContainer:', buttonContainer, 'hidden:', buttonContainer?.classList.contains('hidden'));
        console.log('[showDrawerCountScreen] After delay - sendBillBtn:', sendBillBtn, 'hidden:', sendBillBtn?.classList.contains('hidden'));
        console.log('[showDrawerCountScreen] After delay - searchDatabaseBtn:', searchDatabaseBtn, 'hidden:', searchDatabaseBtn?.classList.contains('hidden'));
        console.log('[showDrawerCountScreen] After delay - drawerCountBtn:', drawerCountBtn, 'hidden:', drawerCountBtn?.classList.contains('hidden'));
        console.log('[showDrawerCountScreen] After delay - endOfDayDrawerCountBtn:', endOfDayDrawerCountBtn, 'hidden:', endOfDayDrawerCountBtn?.classList.contains('hidden'));
        console.log('[showDrawerCountScreen] After delay - businessEndOfDayBtn:', businessEndOfDayBtn, 'hidden:', businessEndOfDayBtn?.classList.contains('hidden'));
        console.log('[showDrawerCountScreen] After delay - logoutBtn:', logoutBtn, 'hidden:', logoutBtn?.classList.contains('hidden'));
        
        // Hide container if visible
        if (buttonContainer && !buttonContainer.classList.contains('hidden')) {
          console.warn('[showDrawerCountScreen] Button container is still visible! Hiding again...');
          buttonContainer.classList.add('hidden');
        }
        
        // Hide all individual buttons that are visible
        const buttonsToCheck = [
          sendBillBtn, searchDatabaseBtn, drawerCountBtn, 
          endOfDayDrawerCountBtn, businessEndOfDayBtn, logoutBtn
        ];
        buttonsToCheck.forEach((btn) => {
          if (btn && !btn.classList.contains('hidden')) {
            console.warn(`[showDrawerCountScreen] ${btn.id || 'button'} is still visible! Hiding again...`);
            btn.classList.add('hidden');
          }
        });
      }, 100);
      
      console.log('[showDrawerCountScreen] ========== FUNCTION COMPLETED ==========');
    }

    window.cancelDrawerCount = function() {
      console.log('[cancelDrawerCount] ========== FUNCTION CALLED ==========');
      const module = document.getElementById('drawerCountModule');
      if (module) {
        console.log('[cancelDrawerCount] Hiding drawer count module');
        module.classList.add('hidden');
      }
      selectedDrawerForCount = null;
      selectedSessionForVerification = null;

      // Reset save button to default
      if (module) {
        const allButtons = module.querySelectorAll('button');
        allButtons.forEach(btn => {
          if (btn.textContent.includes('Verify') || btn.getAttribute('onclick')?.includes('saveEndOfDayDrawerCount')) {
            btn.setAttribute('onclick', 'saveDrawerCount()');
            btn.textContent = 'Save Drawer Count';
          }
        });
      }

      // Show dashboard buttons when drawer count module is closed
      console.log('[cancelDrawerCount] Calling showDashboardButtons()...');
      showDashboardButtons();
      console.log('[cancelDrawerCount] ========== FUNCTION COMPLETED ==========');
    };

    window.calculateDrawerCountTotal = function() {
      let total = 0;

      // Calculate bills
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`drawer_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          total += count * v;
        }
      });

      // Calculate coins
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const input = document.getElementById(`drawer_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          total += count * val;
        }
      });

      const totalEl = document.getElementById('drawerCountTotal');
      if (totalEl) {
        totalEl.textContent = `Total: $${total.toFixed(2)}`;
      }

      return total;
    };

    window.clearDrawerCount = function() {
      // Clear all bill inputs
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`drawer_bill_${v}`);
        if (input) {
          input.value = '0';
        }
      });

      // Clear all coin inputs
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const input = document.getElementById(`drawer_coin_${k}`);
        if (input) {
          input.value = '0';
        }
      });

      // Recalculate total
      calculateDrawerCountTotal();
    };

    window.saveDrawerCount = async function() {
      if (!selectedDrawerForCount) {
        alert('No drawer selected');
        return;
      }

      // Check if "Use username instead of user code" toggle is enabled
      const togglesSettings = await loadTogglesSettings();
      const useUsernameInsteadOfUserCode = togglesSettings && (togglesSettings.useUsernameInsteadOfUserCode === true || togglesSettings.useUsernameInsteadOfUserCode === 'true' || togglesSettings.useUsernameInsteadOfUserCode === 1);

      let countedByName = null;
      let user = null;
      let userCode = null;

      if (useUsernameInsteadOfUserCode) {
        // Use logged-in username
        const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
        if (effectiveUser && effectiveUser.fullName) {
          countedByName = effectiveUser.fullName;
          user = users.find(u => u.fullName && u.fullName.trim().toLowerCase() === effectiveUser.fullName.trim().toLowerCase());
          if (!user) {
            alert('User not found in system. Please contact an administrator.');
            return;
          }
          // Get userCode from the found user
          userCode = user.userCode || '';
        } else {
          alert('Unable to determine your username. Please contact an administrator.');
          return;
        }
      } else {
        // Prompt for user code
        const userCodeInput = prompt('Enter your user code:');
        if (!userCodeInput || !userCodeInput.trim()) {
          alert('User code is required to save the drawer count.');
          return;
        }

        // Find user by code
        user = users.find(u => u.userCode && u.userCode.trim().toLowerCase() === userCodeInput.trim().toLowerCase());
        if (!user) {
          alert('User code not found. Please enter a valid user code.');
          return;
        }

        countedByName = user.fullName || userCodeInput;
        userCode = userCodeInput.trim();
      }

      // Read the count
      const bills = {};
      const coins = {};
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`drawer_bill_${v}`);
        if (input) {
          bills[v] = parseFloat(input.value) || 0;
        }
      });
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const input = document.getElementById(`drawer_coin_${k}`);
        if (input) {
          coins[k] = parseFloat(input.value) || 0;
        }
      });

      const total = calculateDrawerCountTotal();

      // Update drawer with count and mark as available
      const drawer = drawers.find(d => d.id === selectedDrawerForCount.id);
      if (drawer) {
        // Validate count matches expected fund value
        const expectedFundValue = drawer.fundValue !== undefined ? parseFloat(drawer.fundValue || 0) : 0;
        const difference = Math.abs(total - expectedFundValue);

        if (difference > 0.01) {
          // Count doesn't match expected value - show custom alert modal
          showDrawerCountMismatchModal(drawer.name, expectedFundValue, total, difference);
          return;
        }
        const today = window.getCurrentDate();
        drawer.available = true;
        drawer.lastCountDate = today.toISOString();

        // Initialize countHistory array if it doesn't exist
        if (!drawer.countHistory) {
          drawer.countHistory = [];
        }

        // Calculate cash total from bills and coins
        let cashTotal = 0;
        [1,2,5,10,20,50,100].forEach(v => {
          cashTotal += (bills[v] || 0) * v;
        });
        [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
          cashTotal += (coins[k] || 0) * val;
        });

        // Create count record
        const countRecord = {
          bills: bills,
          coins: coins,
          cashTotal: cashTotal,
          checksTotal: 0, // Start of day count doesn't include checks
          total: total,
          countedBy: countedByName,
          countedByCode: userCode ? userCode.trim() : (user?.userCode || ''),
          countedAt: today.toISOString(),
          type: 'SOD' // Start Of Day count
        };

        // Add to history (most recent first)
        drawer.countHistory.unshift(countRecord);

        // Keep lastCount for backward compatibility
        drawer.lastCount = countRecord;

        await saveDrawersToFirestore();
        updateSettingsDrawersTable();

        // Hide drawer count screen first (this will show buttons)
        cancelDrawerCount();

        // Then show custom success modal
        showDrawerCountSuccessModal(drawer, countRecord);
      }
    };

    // End Of Day Drawer Count functions
    let selectedSessionForVerification = null;

    window.showEndOfDayDrawerCountSelection = async function() {
      // Create or get modal
      let modal = document.getElementById('endOfDayDrawerSelectionModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'endOfDayDrawerSelectionModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
        document.body.appendChild(modal);
      }

      // Show loading screen first
      modal.innerHTML = `
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">End Of Day Drawer Count</h2>
            <button onclick="hideEndOfDayDrawerSelectionModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-slate-600 dark:text-slate-400">Loading drawer data...</p>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');

      // Load payment processing sessions if not already loaded
      try {
        if (typeof loadPaymentProcessingSessionsFromFirestore === 'function') {
          await loadPaymentProcessingSessionsFromFirestore();
        }
      } catch (error) {

      }

      // Small delay to ensure data is processed
      await new Promise(resolve => setTimeout(resolve, 100));

      // Ensure drawers are loaded so we can validate session drawer IDs
      try {
        if (typeof loadDrawersFromFirestore === 'function' && (!Array.isArray(drawers) || drawers.length === 0)) {
          await loadDrawersFromFirestore();
        }
      } catch (error) {
      }

      const today = window.getCurrentDate();
      const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format

      // Check if "POS Doesn't Close Out" toggle is enabled
      const togglesSettings = await loadTogglesSettings();
      const posDoesntCloseOut = togglesSettings && togglesSettings.posDoesntCloseOut;

      // Find all sessions that were submitted today (both verified and unverified)
      const sessionsForTodayRaw = (window.paymentProcessingSessions || []).filter(session => {
        if (!session.submittedAt) return false;
        const submittedDate = new Date(session.submittedAt);
        const submittedDateStr = submittedDate.toISOString().split('T')[0];
        // Check if submitted today
        return submittedDateStr === todayStr;
      });

      // Filter out sessions that reference drawers that no longer exist
      const drawerIdSet = new Set((drawers || []).map(d => d.id));
      const sessionsForToday = sessionsForTodayRaw.filter(session => session.drawer?.id && drawerIdSet.has(session.drawer.id));

      // If "POS Doesn't Close Out" is enabled, also show drawers with SOD count but no close-out
      if (posDoesntCloseOut) {
        // Find drawers that have SOD count today but no submitted session
        const drawersWithSODButNoCloseOut = (drawers || []).filter(drawer => {
          // Check if drawer has SOD count today
          if (!drawer.lastCountDate) return false;
          const lastCountDate = new Date(drawer.lastCountDate);
          const lastCountDateStr = lastCountDate.toISOString().split('T')[0];
          if (lastCountDateStr !== todayStr) return false;

          // Check if drawer has a submitted session today
          const hasSessionToday = sessionsForToday.some(session => session.drawer?.id === drawer.id);
          return !hasSessionToday;
        });

        // Load active (non-submitted) sessions from Firestore
        let activeSessions = [];
        try {
          const sessionsRef = collection(db, 'paymentProcessingSessions');
          const snapshot = await getDocs(sessionsRef);
          snapshot.forEach(sessionDoc => {
            const sessionData = { id: sessionDoc.id, ...sessionDoc.data() };
            // Only include sessions that are not submitted and are for today's drawers
            if (!sessionData.submittedAt && sessionData.drawer) {
              activeSessions.push(sessionData);
            }
          });
        } catch (error) {
          console.error('[showEndOfDayDrawerCountSelection] Error loading active sessions:', error);
        }

        // Add these drawers to the list as "pending" entries
        drawersWithSODButNoCloseOut.forEach(drawer => {
          // Find active session for this drawer from Firestore
          let currentSession = activeSessions.find(s => s.drawer?.id === drawer.id);
          
          // Fallback to localStorage if Firestore doesn't have it
          if (!currentSession) {
            try {
              const savedSession = localStorage.getItem('currentPaymentProcessingSession');
              if (savedSession) {
                const parsed = JSON.parse(savedSession);
                if (!parsed.submittedAt && parsed.drawer?.id === drawer.id) {
                  currentSession = parsed;
                }
              }
            } catch (e) {
              // Ignore localStorage errors
            }
          }

          // Calculate payment total from current session if it exists
          let paymentTotal = 0;
          let paymentCash = 0;
          let paymentChecks = 0;
          if (currentSession && currentSession.entries && currentSession.entries.length > 0) {
            currentSession.entries.forEach(entry => {
              const entryAmount = parseFloat(entry.amount || 0);
              paymentTotal += entryAmount;
              if (entry.paymentType === 'Cash') {
                paymentCash += entryAmount;
              } else if (entry.paymentType === 'Check') {
                paymentChecks += entryAmount;
              }
            });
          }

          // Use the actual session if found, otherwise create a pending session
          // If we found a real session, use it directly (but mark as pending for display)
          if (currentSession) {
            // Use the real session but mark it as pending
            const pendingSession = {
              ...currentSession,
              isPending: true // Flag to indicate this is a pending drawer, not a submitted session
            };
            sessionsForToday.push(pendingSession);
          } else {
            // No active session found, create a minimal pending session with PENDING- prefix
            // This will trigger the PENDING- handling in selectSessionForVerification
            const fakeSession = {
              id: `PENDING-${drawer.id}-${Date.now()}`,
              drawer: {
                id: drawer.id,
                name: drawer.name
              },
              username: 'Pending',
              submittedAt: null,
              verifiedBy: null,
              verifiedAt: null,
              register: {
                closing: {
                  initialCount: drawer.lastCount,
                  paymentCount: {
                    cashTotal: paymentCash,
                    checksTotal: paymentChecks,
                    total: paymentTotal
                  }
                },
                runningTotals: {
                  cashIn: paymentCash,
                  cashOut: 0,
                  checkIn: paymentChecks
                }
              },
              entries: [],
              isPending: true
            };
            sessionsForToday.push(fakeSession);
          }
        });
      }

      if (sessionsForToday.length === 0) {
        modal.innerHTML = `
          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">End Of Day Drawer Count</h2>
              <button onclick="hideEndOfDayDrawerSelectionModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="text-center py-8 text-slate-500 dark:text-slate-400">
              <p class="mb-4">No drawers have been closed out today.</p>
            </div>
            <div class="flex justify-end mt-6">
              <button onclick="hideEndOfDayDrawerSelectionModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
            </div>
          </div>
        `;
        return;
      }

      // Group sessions by drawer
      const sessionsByDrawer = {};
      sessionsForToday.forEach(session => {
        const drawerName = session.drawer?.name || 'Unknown Drawer';
        if (!sessionsByDrawer[drawerName]) {
          sessionsByDrawer[drawerName] = [];
        }
        sessionsByDrawer[drawerName].push(session);
      });

      let listHtml = '';
      Object.keys(sessionsByDrawer).forEach(drawerName => {
        const sessions = sessionsByDrawer[drawerName];
        sessions.forEach(session => {
          const isPending = session.isPending || false;
          const submittedDate = session.submittedAt ? new Date(session.submittedAt) : new Date();
          const dateStr = submittedDate.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          // Get closing count details (only for non-pending sessions)
          let denominationsInfo = 'No count details available';
          if (!isPending) {
            const closing = session.register?.closing;
            const posCount = closing?.initialCount || closing?.paymentCount;
            if (posCount) {
              const billCounts = [];
              [1,2,5,10,20,50,100].forEach(v => {
                const count = posCount.bills?.[v] || 0;
                if (count > 0) billCounts.push(`$${v}: ${count}`);
              });
              const coinCounts = [];
              [['penny','Pennies'],['nickel','Nickels'],['dime','Dimes'],['quarter','Quarters'],['half','Half Dollars']].forEach(([k,label]) => {
                const count = posCount.coins?.[k] || 0;
                if (count > 0) coinCounts.push(`${label}: ${count}`);
              });
              const total = (posCount.cashTotal || 0) + (posCount.checksTotal || 0);
              denominationsInfo = `Total: $${total.toFixed(2)}`;
              if (billCounts.length > 0) denominationsInfo += ` | Bills: ${billCounts.join(', ')}`;
              if (coinCounts.length > 0) denominationsInfo += ` | Coins: ${coinCounts.join(', ')}`;
            }
          } else {
            // For pending drawers, show expected payment total from session
            const paymentCount = session.register?.closing?.paymentCount;
            if (paymentCount) {
              const total = (paymentCount.cashTotal || 0) + (paymentCount.checksTotal || 0);
              denominationsInfo = `Expected Payment Total: $${total.toFixed(2)}`;
            }
          }

          const isVerified = !!session.verifiedBy;
          const verifiedDate = session.verifiedAt ? new Date(session.verifiedAt).toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) : '';

          const safeSessionId = session.id.replace(/'/g, "\\'");
          const safeDrawerId = session.drawer?.id ? session.drawer.id.replace(/'/g, "\\'") : '';
          listHtml += `
            <div class="w-full bg-white border border-slate-200 rounded-xl p-4 shadow-sm mb-3">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span class="font-semibold text-slate-800">${drawerName}</span>
                    ${isPending
                      ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">EOD Count Pending</span>`
                      : isVerified 
                        ? `<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Verified</span>`
                        : `<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Needs Verifying</span>`
                    }
                  </div>
                  <div class="mt-1 text-xs text-slate-600">
                    ${isPending 
                      ? `<div>Status: Drawer has SOD count but not yet closed out</div>`
                      : `<div>Closed by: ${session.username || 'Unknown'}</div>
                         <div>Submitted: ${dateStr}</div>
                         ${isVerified ? `<div>Verified by: ${session.verifiedBy || 'Unknown'}</div>` : ''}
                         ${isVerified && verifiedDate ? `<div>Verified: ${verifiedDate}</div>` : ''}`
                    }
                  </div>
                </div>
                <div class="flex flex-col gap-2">
                  <button
                    onclick="selectSessionForVerification('${safeSessionId}')"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold"
                  >
                    Start End Of Day Count
                  </button>
                  ${!isPending && !posDoesntCloseOut ? `
                  <button
                    onclick="printCashierReceipt('${safeSessionId}')"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold"
                  >
                    View Cashier Receipt
                  </button>
                  ` : ''}
                  <button
                    onclick="showDrawerCountHistory('${safeDrawerId}', 'EOD')"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold"
                  >
                    Drawer History
                  </button>
                </div>
              </div>
            </div>
          `;
        });
      });

      modal.innerHTML = `
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">End Of Day Drawer Count</h2>
            <button onclick="hideEndOfDayDrawerSelectionModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Select a drawer that has been closed out today to verify the count.</p>
          <div id="endOfDayDrawerSelectionList" class="space-y-3">
            ${listHtml}
          </div>
          <div class="flex justify-end mt-6">
            <button onclick="hideEndOfDayDrawerSelectionModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
    };

    window.hideEndOfDayDrawerSelectionModal = function() {
      const modal = document.getElementById('endOfDayDrawerSelectionModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    };

    // Business End Of Day (BEOD) summary
    function renderBusinessEndOfDayModal(innerHtml) {
      let modal = document.getElementById('businessEndOfDayModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'businessEndOfDayModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
        document.body.appendChild(modal);
      }
      modal.innerHTML = innerHtml;
      modal.classList.remove('hidden');
    }

    function formatBeodDateLabel(dateKey) {
      const [year, month, day] = dateKey.split('-').map(v => parseInt(v, 10));
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    window.showBusinessEndOfDaySummary = async function() {
      renderBusinessEndOfDayModal(`
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Business End Of Day</h2>
            <button onclick="hideBusinessEndOfDayModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-slate-600 dark:text-slate-400">Loading daily totals...</p>
          </div>
        </div>
      `);

      try {
        if (typeof loadPaymentProcessingSessionsFromFirestore === 'function') {
          await loadPaymentProcessingSessionsFromFirestore();
        }
      } catch (error) {

      }

      const sessions = window.paymentProcessingSessions || [];
      const sessionsByDay = {};
      sessions.forEach(session => {
        // Include sessions that are either submitted OR verified (for pending drawers verified by supervisor)
        const dateToUse = session.submittedAt || session.verifiedAt;
        if (!dateToUse) return;
        const dateKey = new Date(dateToUse).toISOString().split('T')[0];
        if (!sessionsByDay[dateKey]) sessionsByDay[dateKey] = [];
        sessionsByDay[dateKey].push(session);
      });
      window.businessEndOfDaySessionsByDay = sessionsByDay;

      const dayKeys = Object.keys(sessionsByDay).sort((a, b) => b.localeCompare(a));
      if (dayKeys.length === 0) {
        renderBusinessEndOfDayModal(`
          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Business End Of Day</h2>
              <button onclick="hideBusinessEndOfDayModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="text-center py-8 text-slate-500 dark:text-slate-400">
              <p>No payment sessions have been submitted yet.</p>
            </div>
            <div class="flex justify-end mt-6">
              <button onclick="hideBusinessEndOfDayModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
            </div>
          </div>
        `);
        return;
      }

      let listHtml = '';
      dayKeys.forEach(dateKey => {
        const daySessions = sessionsByDay[dateKey] || [];
        const total = daySessions.reduce((sum, s) => sum + (s.totalAmount || 0), 0);
        const drawers = new Set(daySessions.map(s => s.drawer?.name || 'Unknown Drawer'));
        listHtml += `
          <div class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl mb-3">
            <div class="flex items-center justify-between w-full">
              <div class="flex-1">
                <span class="font-semibold">${formatBeodDateLabel(dateKey)}</span>
                <div class="mt-1 text-xs opacity-90">
                  <div>Drawers: ${drawers.size}</div>
                  <div>Sessions: ${daySessions.length}</div>
                  <div>Total Received: $${total.toFixed(2)}</div>
                </div>
              </div>
            </div>
            <div class="mt-3 flex gap-2">
              <button
                onclick="showBusinessEndOfDayDay('${dateKey}')"
                class="flex-1 bg-white text-blue-700 hover:bg-blue-50 font-semibold py-2 px-3 rounded-lg transition-colors text-sm"
              >
                View Drawers
              </button>
              <button
                onclick="showBusinessEndOfDayBreakdown('${dateKey}')"
                class="flex-1 bg-white text-blue-700 hover:bg-blue-50 font-semibold py-2 px-3 rounded-lg transition-colors text-sm"
              >
                Show Breakdown
              </button>
              <button
                onclick="deleteBusinessEndOfDayDate('${dateKey}')"
                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg transition-colors text-sm"
              >
                Delete
              </button>
            </div>
          </div>
        `;
      });

      renderBusinessEndOfDayModal(`
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Business End Of Day</h2>
            <button onclick="hideBusinessEndOfDayModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Select a day to review totals by drawer and payment.</p>
          <div class="space-y-3">
            ${listHtml}
          </div>
          <div class="flex justify-end mt-6">
            <button onclick="hideBusinessEndOfDayModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
          </div>
        </div>
      `);
    };

    window.deleteBusinessEndOfDayDate = async function(dateKey) {
      const sessionsByDay = window.businessEndOfDaySessionsByDay || {};
      const daySessions = sessionsByDay[dateKey] || [];

      if (daySessions.length === 0) {
        alert('No sessions found for this date.');
        return;
      }

      const dateLabel = formatBeodDateLabel(dateKey);
      const sessionCount = daySessions.length;
      const totalAmount = daySessions.reduce((sum, s) => sum + (s.totalAmount || 0), 0);

      if (!confirm(`Are you sure you want to delete all ${sessionCount} session(s) for ${dateLabel}?\n\nTotal Amount: $${totalAmount.toFixed(2)}\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        // Delete all sessions for this date from Firestore
        const sessionsRef = collection(db, 'paymentProcessingSessions');
        const deletePromises = daySessions.map(session => {
          const sessionRef = doc(sessionsRef, session.id);
          return deleteDoc(sessionRef);
        });

        await Promise.all(deletePromises);

        // Remove from local array
        daySessions.forEach(session => {
          window.paymentProcessingSessions = window.paymentProcessingSessions.filter(s => s.id !== session.id);
        });

        // Reload sessions from Firestore
        if (typeof loadPaymentProcessingSessionsFromFirestore === 'function') {
          await loadPaymentProcessingSessionsFromFirestore();
        }

        // Refresh the Business End Of Day summary
        await showBusinessEndOfDaySummary();

        alert(`Successfully deleted ${sessionCount} session(s) for ${dateLabel}.`);
      } catch (error) {

        alert('Error deleting sessions: ' + error.message);
      }
    };

    window.showBusinessEndOfDayBreakdown = function(dateKey) {
      const sessionsByDay = window.businessEndOfDaySessionsByDay || {};
      const daySessions = sessionsByDay[dateKey] || [];
      if (daySessions.length === 0) {
        showBusinessEndOfDaySummary();
        return;
      }

      const totals = {
        sewerCharge: 0,
        pastDue: 0,
        lateFee: 0,
        taxCodes: 0
      };
      const taxCodeTotals = {};

      daySessions.forEach(session => {
        (session.entries || []).forEach(entry => {
          const breakdown = entry.breakdown;
          if (!breakdown) return;
          totals.sewerCharge += breakdown.sewerCharge || 0;
          totals.pastDue += breakdown.pastDue || 0;
          totals.lateFee += breakdown.lateFee || 0;
          totals.taxCodes += breakdown.taxCodes || 0;
          (breakdown.taxCodeDetails || []).forEach(detail => {
            if (!taxCodeTotals[detail.label]) taxCodeTotals[detail.label] = 0;
            taxCodeTotals[detail.label] += detail.amount || 0;
          });
        });
      });

      const totalReceived = daySessions.reduce((sum, s) => sum + (s.totalAmount || 0), 0);
      const dateLabel = formatBeodDateLabel(dateKey);
      const taxDetailId = `beod-tax-details-${dateKey}`;

      const taxDetailsHtml = Object.keys(taxCodeTotals).length === 0
        ? `<p class="text-sm text-slate-500 dark:text-slate-400">No tax code details available.</p>`
        : `
          <div class="space-y-2">
            ${Object.entries(taxCodeTotals).map(([label, amount]) => `
              <div class="flex items-center justify-between text-sm text-slate-700 dark:text-slate-300">
                <span>${label}</span>
                <span class="font-semibold">$${amount.toFixed(2)}</span>
              </div>
            `).join('')}
          </div>
        `;

      renderBusinessEndOfDayModal(`
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Business End Of Day</h2>
              <p class="text-sm text-slate-600 dark:text-slate-400">${dateLabel}</p>
            </div>
            <button onclick="hideBusinessEndOfDayModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="mb-6">
            <p class="text-sm text-slate-600 dark:text-slate-400">Total Received</p>
            <p class="text-2xl font-bold text-slate-900 dark:text-slate-100">$${totalReceived.toFixed(2)}</p>
          </div>

          <div class="space-y-4">
            <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3">
              <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Sewer Charges</span>
              <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">$${totals.sewerCharge.toFixed(2)}</span>
            </div>
            <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3">
              <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Past Due Amount</span>
              <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">$${totals.pastDue.toFixed(2)}</span>
            </div>
            <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3">
              <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Late Fees</span>
              <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">$${totals.lateFee.toFixed(2)}</span>
            </div>
            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3">
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Tax Codes</span>
                <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">$${totals.taxCodes.toFixed(2)}</span>
              </div>
              <button
                onclick="toggleBeodTaxDetails('${taxDetailId}')"
                class="mt-2 text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold"
              >
                View Details
              </button>
              <div id="${taxDetailId}" class="hidden mt-3">
                ${taxDetailsHtml}
              </div>
            </div>
          </div>

          <div class="flex justify-between mt-6">
            <button onclick="showBusinessEndOfDaySummary()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">Back</button>
            <div class="flex gap-2">
              <button onclick="printBusinessEndOfDayReport('${dateKey}')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Print</button>
              <button onclick="hideBusinessEndOfDayModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
            </div>
          </div>
        </div>
      `);
    };

    window.printBusinessEndOfDayReport = function(dateKey) {
      const sessionsByDay = window.businessEndOfDaySessionsByDay || {};
      const daySessions = sessionsByDay[dateKey] || [];
      if (daySessions.length === 0) {
        alert('No sessions found for this date.');
        return;
      }

      const dateLabel = formatBeodDateLabel(dateKey);

      // Group sessions by drawer
      const sessionsByDrawer = {};
      daySessions.forEach(session => {
        const drawerName = session.drawer?.name || 'Unknown Drawer';
        if (!sessionsByDrawer[drawerName]) sessionsByDrawer[drawerName] = [];
        sessionsByDrawer[drawerName].push(session);
      });

      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Business End Of Day Report - ${dateLabel}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            h3 { margin-top: 30px; margin-bottom: 15px; color: #333; border-bottom: 2px solid #333; padding-bottom: 5px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; }
            .text-right { text-align: right; }
            .breakdown-section { margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 5px; }
            .breakdown-row { display: flex; justify-content: space-between; padding: 5px 0; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
            .drawer-total { font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <h1>Business End Of Day Report</h1>
          <h2>${dateLabel}</h2>
          <div class="info">
            <p><strong>Date:</strong> ${dateLabel}</p>
            <p><strong>Total Drawers:</strong> ${Object.keys(sessionsByDrawer).length}</p>
            <p><strong>Total Sessions:</strong> ${daySessions.length}</p>
          </div>
      `;

      // Process each drawer
      Object.keys(sessionsByDrawer).forEach(drawerName => {
        const drawerSessions = sessionsByDrawer[drawerName];
        const drawerTotal = drawerSessions.reduce((sum, s) => sum + (s.totalAmount || 0), 0);

        // Calculate breakdown for this drawer
        const drawerBreakdown = {
          sewerCharge: 0,
          pastDue: 0,
          lateFee: 0,
          taxCodes: 0
        };
        const drawerTaxCodeTotals = {};

        const drawerEntries = [];
        drawerSessions.forEach(session => {
          (session.entries || []).forEach(entry => {
            drawerEntries.push(entry);
            const breakdown = entry.breakdown;
            if (breakdown) {
              drawerBreakdown.sewerCharge += breakdown.sewerCharge || 0;
              drawerBreakdown.pastDue += breakdown.pastDue || 0;
              drawerBreakdown.lateFee += breakdown.lateFee || 0;
              drawerBreakdown.taxCodes += breakdown.taxCodes || 0;
              (breakdown.taxCodeDetails || []).forEach(detail => {
                if (!drawerTaxCodeTotals[detail.label]) drawerTaxCodeTotals[detail.label] = 0;
                drawerTaxCodeTotals[detail.label] += detail.amount || 0;
              });
            }
          });
        });

        receiptHtml += `
          <h3>${drawerName}</h3>
          <table>
            <tr>
              <th>Date</th>
              <th>Customer</th>
              <th>Account #</th>
              <th>Property</th>
              <th>Payment Type</th>
              <th class="text-right">Amount</th>
            </tr>
        `;

        drawerEntries.forEach(entry => {
          const entryDate = entry.timestamp ? new Date(entry.timestamp) : (entry.date ? new Date(entry.date) : null);
          const dateStr = entry.date || (entryDate ? entryDate.toLocaleDateString() : '—');
          receiptHtml += `
            <tr>
              <td>${dateStr}</td>
              <td>${entry.customerName || '—'}</td>
              <td>${entry.accountNumber || '—'}</td>
              <td>${entry.property || '—'}</td>
              <td>${entry.paymentType || '—'}</td>
              <td class="text-right">$${(entry.amount || 0).toFixed(2)}</td>
            </tr>
          `;
        });

        receiptHtml += `
            <tr>
              <td colspan="5" class="drawer-total text-right">Drawer Total:</td>
              <td class="text-right drawer-total">$${drawerTotal.toFixed(2)}</td>
            </tr>
          </table>

          <div class="breakdown-section">
            <h4>Payment Breakdown for ${drawerName}</h4>
            <div class="breakdown-row">
              <span>Sewer Charges:</span>
              <span class="text-right">$${drawerBreakdown.sewerCharge.toFixed(2)}</span>
            </div>
            <div class="breakdown-row">
              <span>Past Due Amount:</span>
              <span class="text-right">$${drawerBreakdown.pastDue.toFixed(2)}</span>
            </div>
            <div class="breakdown-row">
              <span>Late Fees:</span>
              <span class="text-right">$${drawerBreakdown.lateFee.toFixed(2)}</span>
            </div>
            <div class="breakdown-row">
              <span>Tax Codes:</span>
              <span class="text-right">$${drawerBreakdown.taxCodes.toFixed(2)}</span>
            </div>
        `;

        if (Object.keys(drawerTaxCodeTotals).length > 0) {
          receiptHtml += `
            <div style="margin-top: 10px; padding-left: 20px;">
              <strong>Tax Code Details:</strong>
          `;
          Object.entries(drawerTaxCodeTotals).forEach(([label, amount]) => {
            receiptHtml += `
              <div class="breakdown-row">
                <span>${label}:</span>
                <span class="text-right">$${amount.toFixed(2)}</span>
              </div>
            `;
          });
          receiptHtml += `</div>`;
        }

        receiptHtml += `
          </div>
        `;
      });

      // Add grand totals
      const grandTotals = {
        sewerCharge: 0,
        pastDue: 0,
        lateFee: 0,
        taxCodes: 0
      };
      const grandTaxCodeTotals = {};

      daySessions.forEach(session => {
        (session.entries || []).forEach(entry => {
          const breakdown = entry.breakdown;
          if (breakdown) {
            grandTotals.sewerCharge += breakdown.sewerCharge || 0;
            grandTotals.pastDue += breakdown.pastDue || 0;
            grandTotals.lateFee += breakdown.lateFee || 0;
            grandTotals.taxCodes += breakdown.taxCodes || 0;
            (breakdown.taxCodeDetails || []).forEach(detail => {
              if (!grandTaxCodeTotals[detail.label]) grandTaxCodeTotals[detail.label] = 0;
              grandTaxCodeTotals[detail.label] += detail.amount || 0;
            });
          }
        });
      });

      const grandTotal = daySessions.reduce((sum, s) => sum + (s.totalAmount || 0), 0);

      receiptHtml += `
          <div class="breakdown-section" style="margin-top: 40px; background-color: #e8f5e9; border: 2px solid #4caf50;">
            <h4 style="margin-top: 0;">Grand Totals</h4>
            <div class="breakdown-row">
              <span><strong>Total Received:</strong></span>
              <span class="text-right"><strong>$${grandTotal.toFixed(2)}</strong></span>
            </div>
            <div class="breakdown-row">
              <span>Sewer Charges:</span>
              <span class="text-right">$${grandTotals.sewerCharge.toFixed(2)}</span>
            </div>
            <div class="breakdown-row">
              <span>Past Due Amount:</span>
              <span class="text-right">$${grandTotals.pastDue.toFixed(2)}</span>
            </div>
            <div class="breakdown-row">
              <span>Late Fees:</span>
              <span class="text-right">$${grandTotals.lateFee.toFixed(2)}</span>
            </div>
            <div class="breakdown-row">
              <span>Tax Codes:</span>
              <span class="text-right">$${grandTotals.taxCodes.toFixed(2)}</span>
            </div>
      `;

      if (Object.keys(grandTaxCodeTotals).length > 0) {
        receiptHtml += `
          <div style="margin-top: 10px; padding-left: 20px;">
            <strong>Tax Code Details:</strong>
        `;
        Object.entries(grandTaxCodeTotals).forEach(([label, amount]) => {
          receiptHtml += `
            <div class="breakdown-row">
              <span>${label}:</span>
              <span class="text-right">$${amount.toFixed(2)}</span>
            </div>
          `;
        });
        receiptHtml += `</div>`;
      }

      receiptHtml += `
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    window.toggleBeodTaxDetails = function(detailId) {
      const detailEl = document.getElementById(detailId);
      if (detailEl) {
        detailEl.classList.toggle('hidden');
      }
    };

    window.showBusinessEndOfDayDay = function(dateKey) {
      const sessionsByDay = window.businessEndOfDaySessionsByDay || {};
      const daySessions = sessionsByDay[dateKey] || [];
      if (daySessions.length === 0) {
        showBusinessEndOfDaySummary();
        return;
      }

      const sessionsByDrawer = {};
      daySessions.forEach(session => {
        const drawerName = session.drawer?.name || 'Unknown Drawer';
        if (!sessionsByDrawer[drawerName]) sessionsByDrawer[drawerName] = [];
        sessionsByDrawer[drawerName].push(session);
      });

      let listHtml = '';
      Object.keys(sessionsByDrawer).forEach(drawerName => {
        const drawerSessions = sessionsByDrawer[drawerName];
        const total = drawerSessions.reduce((sum, s) => sum + (s.totalAmount || 0), 0);
        const entriesCount = drawerSessions.reduce((sum, s) => sum + (s.entries?.length || 0), 0);
        listHtml += `
          <button 
            onclick="showBusinessEndOfDayDrawer('${dateKey}', '${drawerName.replace(/'/g, "\\'")}')" 
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors text-left mb-3"
          >
            <div class="flex items-center justify-between w-full">
              <div class="flex-1">
                <span class="font-semibold">${drawerName}</span>
                <div class="mt-1 text-xs opacity-90">
                  <div>Sessions: ${drawerSessions.length}</div>
                  <div>Payments: ${entriesCount}</div>
                  <div>Total Received: $${total.toFixed(2)}</div>
                </div>
              </div>
              <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </button>
        `;
      });

      renderBusinessEndOfDayModal(`
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Business End Of Day</h2>
              <p class="text-sm text-slate-600 dark:text-slate-400">${formatBeodDateLabel(dateKey)}</p>
            </div>
            <button onclick="hideBusinessEndOfDayModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Select a drawer to review the payments for the day.</p>
          <div class="space-y-3">
            ${listHtml}
          </div>
          <div class="flex justify-between mt-6">
            <button onclick="showBusinessEndOfDaySummary()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">Back</button>
            <button onclick="hideBusinessEndOfDayModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
          </div>
        </div>
      `);
    };

    window.showBusinessEndOfDayDrawer = function(dateKey, drawerName) {
      const sessionsByDay = window.businessEndOfDaySessionsByDay || {};
      const daySessions = sessionsByDay[dateKey] || [];
      const drawerSessions = daySessions.filter(s => (s.drawer?.name || 'Unknown Drawer') === drawerName);

      const entries = [];
      drawerSessions.forEach(session => {
        (session.entries || []).forEach(entry => entries.push(entry));
      });

      const totals = {
        sewerCharge: 0,
        pastDue: 0,
        lateFee: 0,
        taxCodes: 0
      };
      const taxCodeTotals = {};

      entries.forEach(entry => {
        const breakdown = entry.breakdown;
        if (!breakdown) return;
        totals.sewerCharge += breakdown.sewerCharge || 0;
        totals.pastDue += breakdown.pastDue || 0;
        totals.lateFee += breakdown.lateFee || 0;
        totals.taxCodes += breakdown.taxCodes || 0;
        (breakdown.taxCodeDetails || []).forEach(detail => {
          if (!taxCodeTotals[detail.label]) taxCodeTotals[detail.label] = 0;
          taxCodeTotals[detail.label] += detail.amount || 0;
        });
      });

      const totalReceived = entries.reduce((sum, e) => sum + (e.amount || 0), 0);
      const dateLabel = formatBeodDateLabel(dateKey);
      const taxDetailId = `beod-tax-details-${dateKey}-${drawerName.replace(/\s+/g, '-').toLowerCase()}`;

      const taxDetailsHtml = Object.keys(taxCodeTotals).length === 0
        ? `<p class="text-sm text-slate-500 dark:text-slate-400">No tax code details available.</p>`
        : `
          <div class="space-y-2">
            ${Object.entries(taxCodeTotals).map(([label, amount]) => `
              <div class="flex items-center justify-between text-sm text-slate-700 dark:text-slate-300">
                <span>${label}</span>
                <span class="font-semibold">$${amount.toFixed(2)}</span>
              </div>
            `).join('')}
          </div>
        `;

      renderBusinessEndOfDayModal(`
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Business End Of Day For ${drawerName}</h2>
              <p class="text-sm text-slate-600 dark:text-slate-400">${dateLabel}</p>
            </div>
            <button onclick="hideBusinessEndOfDayModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="mb-6">
            <p class="text-sm text-slate-600 dark:text-slate-400">Total Received</p>
            <p class="text-2xl font-bold text-slate-900 dark:text-slate-100">$${totalReceived.toFixed(2)}</p>
          </div>

          <div class="space-y-4">
            <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3">
              <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Sewer Charges</span>
              <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">$${totals.sewerCharge.toFixed(2)}</span>
            </div>
            <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3">
              <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Past Due Amount</span>
              <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">$${totals.pastDue.toFixed(2)}</span>
            </div>
            <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3">
              <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Late Fees</span>
              <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">$${totals.lateFee.toFixed(2)}</span>
            </div>
            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg px-4 py-3">
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Tax Codes</span>
                <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">$${totals.taxCodes.toFixed(2)}</span>
              </div>
              <button
                onclick="toggleBeodTaxDetails('${taxDetailId}')"
                class="mt-2 text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold"
              >
                View Details
              </button>
              <div id="${taxDetailId}" class="hidden mt-3">
                ${taxDetailsHtml}
              </div>
            </div>
          </div>

          <div class="flex justify-between mt-6">
            <button onclick="showBusinessEndOfDayDay('${dateKey}')" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">Back</button>
            <div class="flex gap-2">
              <button onclick="printBusinessEndOfDayDrawerReport('${dateKey}', '${drawerName.replace(/'/g, "\\'")}')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Print</button>
              <button onclick="hideBusinessEndOfDayModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
            </div>
          </div>
        </div>
      `);
    };

    window.printBusinessEndOfDayDrawerReport = function(dateKey, drawerName) {
      const sessionsByDay = window.businessEndOfDaySessionsByDay || {};
      const daySessions = sessionsByDay[dateKey] || [];
      const drawerSessions = daySessions.filter(s => (s.drawer?.name || 'Unknown Drawer') === drawerName);
      const entries = [];
      drawerSessions.forEach(session => {
        (session.entries || []).forEach(entry => entries.push(entry));
      });

      const totals = {
        sewerCharge: 0,
        pastDue: 0,
        lateFee: 0,
        taxCodes: 0
      };
      const taxCodeTotals = {};
      entries.forEach(entry => {
        const breakdown = entry.breakdown;
        if (!breakdown) return;
        totals.sewerCharge += breakdown.sewerCharge || 0;
        totals.pastDue += breakdown.pastDue || 0;
        totals.lateFee += breakdown.lateFee || 0;
        totals.taxCodes += breakdown.taxCodes || 0;
        (breakdown.taxCodeDetails || []).forEach(detail => {
          if (!taxCodeTotals[detail.label]) taxCodeTotals[detail.label] = 0;
          taxCodeTotals[detail.label] += detail.amount || 0;
        });
      });

      const totalReceived = entries.reduce((sum, e) => sum + (e.amount || 0), 0);
      const dateLabel = formatBeodDateLabel(dateKey);

      const taxDetailsHtml = Object.keys(taxCodeTotals).length === 0
        ? `<p>No tax code details available.</p>`
        : `
          <table>
            <tr><th>Tax Code</th><th>Amount</th></tr>
            ${Object.entries(taxCodeTotals).map(([label, amount]) => `
              <tr><td>${label}</td><td>$${amount.toFixed(2)}</td></tr>
            `).join('')}
          </table>
        `;

      const reportHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Business End Of Day - ${drawerName}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 20px; }
            .section { margin-top: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .row { display: flex; justify-content: space-between; margin: 8px 0; }
            .label { font-weight: bold; }
          </style>
        </head>
        <body>
          <h1>Business End Of Day For ${drawerName}</h1>
          <h2>${dateLabel}</h2>
          <div class="section">
            <div class="row"><span class="label">Total Received</span><span>$${totalReceived.toFixed(2)}</span></div>
            <div class="row"><span class="label">Sewer Charges</span><span>$${totals.sewerCharge.toFixed(2)}</span></div>
            <div class="row"><span class="label">Past Due Amount</span><span>$${totals.pastDue.toFixed(2)}</span></div>
            <div class="row"><span class="label">Late Fees</span><span>$${totals.lateFee.toFixed(2)}</span></div>
            <div class="row"><span class="label">Tax Codes</span><span>$${totals.taxCodes.toFixed(2)}</span></div>
          </div>
          <div class="section">
            <h3>Tax Code Details</h3>
            ${taxDetailsHtml}
          </div>
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(reportHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    window.hideBusinessEndOfDayModal = function() {
      const modal = document.getElementById('businessEndOfDayModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    };

    window.selectSessionForVerification = async function(sessionId) {
      // Check if it's a pending session (starts with PENDING- or is marked as pending)
      let session = null;
      
      // First, try to find it in the loaded sessions (it might be a real session marked as pending)
      session = window.paymentProcessingSessions.find(s => s.id === sessionId);
      
      // If not found and it's a PENDING- ID, or if it's marked as pending, load from Firestore
      if (!session || sessionId.startsWith('PENDING-') || session?.isPending) {
        let drawerId = null;
        
        // Extract drawer ID from sessionId if it's a PENDING- ID
        if (sessionId.startsWith('PENDING-')) {
          const parts = sessionId.split('-');
          if (parts.length >= 2) {
            drawerId = parts[1];
          }
        } else if (session?.drawer?.id) {
          drawerId = session.drawer.id;
        }
        
        if (drawerId) {
          const drawer = drawers.find(d => d.id === drawerId);
          if (drawer && drawer.lastCountDate) {
            const today = window.getCurrentDate();
            const todayStr = today.toISOString().split('T')[0];
            const lastCountDateStr = new Date(drawer.lastCountDate).toISOString().split('T')[0];
            if (lastCountDateStr === todayStr) {
              // Load active session from Firestore
              let currentSession = null;
              try {
                const sessionsRef = collection(db, 'paymentProcessingSessions');
                const snapshot = await getDocs(sessionsRef);
                snapshot.forEach(sessionDoc => {
                  const sessionData = { id: sessionDoc.id, ...sessionDoc.data() };
                  // Find active session for this drawer
                  if (!sessionData.submittedAt && sessionData.drawer?.id === drawer.id) {
                    currentSession = sessionData;
                  }
                });
              } catch (error) {
                console.error('[selectSessionForVerification] Error loading active session from Firestore:', error);
              }
              
              // Fallback to localStorage if Firestore doesn't have it
              if (!currentSession) {
                try {
                  const savedSession = localStorage.getItem('currentPaymentProcessingSession');
                  if (savedSession) {
                    const parsed = JSON.parse(savedSession);
                    if (!parsed.submittedAt && parsed.drawer?.id === drawer.id) {
                      currentSession = parsed;
                    }
                  }
                } catch (e) {
                  // Ignore localStorage errors
                }
              }

              if (currentSession) {
                // Use the real session from Firestore
                session = currentSession;
              } else {
                // No session found - calculate payment totals from drawer's lastCount if available
                let paymentTotal = 0;
                let paymentCash = 0;
                let paymentChecks = 0;
                
                // Create minimal session for EOD count
                session = {
                  id: sessionId,
                  drawer: {
                    id: drawer.id,
                    name: drawer.name
                  },
                  username: 'Pending',
                  submittedAt: null,
                  verifiedBy: null,
                  verifiedAt: null,
                  register: {
                    closing: {
                      initialCount: drawer.lastCount,
                      paymentCount: {
                        cashTotal: paymentCash,
                        checksTotal: paymentChecks,
                        total: paymentTotal
                      }
                    },
                    runningTotals: {
                      cashIn: paymentCash,
                      cashOut: 0,
                      checkIn: paymentChecks
                    }
                  },
                  entries: [],
                  isPending: true
                };
              }
            }
          }
        }
      }
      
      // If still no session found, try regular lookup
      if (!session) {
        session = window.paymentProcessingSessions.find(s => s.id === sessionId);
      }

      if (!session) {
        alert('Session not found. The payment processing session may not have been saved yet.');
        console.error('[selectSessionForVerification] Session not found. SessionId:', sessionId);
        console.error('[selectSessionForVerification] Available sessions:', window.paymentProcessingSessions.map(s => ({ id: s.id, drawer: s.drawer?.name, submittedAt: s.submittedAt })));
        return;
      }

      selectedSessionForVerification = session;
      hideEndOfDayDrawerSelectionModal();
      showEndOfDayDrawerCountScreen(session);
    };

    window.printCashierReceipt = function(sessionId) {
      const session = window.paymentProcessingSessions.find(s => s.id === sessionId);
      if (!session) {
        alert('Session not found');
        return;
      }

      const closing = session.register?.closing;
      const posInitialCount = closing?.initialCount;
      const posPaymentCount = closing?.paymentCount;

      if (!posInitialCount && !posPaymentCount) {
        alert('POS count details are not available for this session.');
        return;
      }

      const drawerName = session.drawer?.name || 'Unknown Drawer';
      const submittedDate = session.submittedAt ? new Date(session.submittedAt).toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : 'Unknown';

      // Helper function to build count table HTML
      const buildCountTable = (countData, title) => {
        if (!countData) return '';

        let html = `<h3>${title}</h3>`;
        html += `<h4>Bills</h4><table><tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>`;

        [1,2,5,10,20,50,100].forEach(v => {
          const count = countData.bills?.[v] || 0;
          if (count > 0) {
            html += `<tr><td>$${v}</td><td>${count}</td><td>$${(count * v).toFixed(2)}</td></tr>`;
          }
        });

        html += `</table><h4>Coins</h4><table><tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>`;

        [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
          const count = countData.coins?.[k] || 0;
          if (count > 0) {
            html += `<tr><td>${label}</td><td>${count}</td><td>$${(count * val).toFixed(2)}</td></tr>`;
          }
        });

        html += `</table>`;

        const checks = countData.checks || [];
        html += `<h4>Checks</h4><table><tr><th>Check #</th><th>Amount</th></tr>`;
        if (checks.length > 0) {

          checks.forEach((check, idx) => {
            const isObj = typeof check === 'object' && check !== null;
            const rawNumber = isObj ? check.number : null;
            const displayNumber = rawNumber ? `Check #${rawNumber}` : `Check #${idx + 1}`;
            const amount = isObj ? check.amount : check;

            html += `<tr><td>${displayNumber}</td><td>$${Number(amount || 0).toFixed(2)}</td></tr>`;
          });
        } else {
          html += `<tr><td colspan="2">No checks</td></tr>`;
        }
        html += `</table>`;

        const total = (countData.cashTotal || 0) + (countData.checksTotal || 0);
        html += `<div class="total">${title} Total: $${total.toFixed(2)}</div>`;

        return html;
      };

      // Build receipt HTML
      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${drawerName} - Cashier Count Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
            .section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; }
          </style>
        </head>
        <body>
          <h1>${drawerName} - Cashier Count Receipt</h1>
          <div class="info">
            <p><strong>Closed by:</strong> ${session.username || 'Unknown'}</p>
            <p><strong>Submitted:</strong> ${submittedDate}</p>
          </div>
      `;

      // Add SOD Fund Count section
      if (posInitialCount) {
        receiptHtml += `<div class="section">${buildCountTable(posInitialCount, 'SOD Fund Count')}</div>`;
      }

      // Add Payment Count section
      if (posPaymentCount) {
        receiptHtml += `<div class="section">${buildCountTable(posPaymentCount, 'Payment Count')}</div>`;
      }

      receiptHtml += `
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin-top: 30px;">Initials: _____________</p>
          </div>
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    function showEndOfDayDrawerCountScreen(session) {
      const module = document.getElementById('drawerCountModule');
      if (!module) return;

      // Hide other modules and dashboard buttons
      hideAllModules();
      hideDashboardButtons();

      const drawerName = session.drawer?.name || 'Unknown Drawer';

      // Get POS counts for comparison
      const posInitialCount = session.register?.closing?.initialCount;
      const posPaymentCount = session.register?.closing?.paymentCount;

      // Calculate expected initial total from drawer's lastCount (supervisor's SOD count)
      let expectedInitialCash = 0;
      let expectedInitialChecks = 0;
      let expectedInitialTotal = 0;

      if (session.drawer) {
        const drawer = drawers.find(d => d.id === session.drawer.id);
        if (drawer && drawer.lastCount) {
          if (drawer.lastCount.cashTotal !== undefined) {
            expectedInitialCash = drawer.lastCount.cashTotal || 0;
          } else if (drawer.lastCount.bills) {
            [1,2,5,10,20,50,100].forEach(v => {
              expectedInitialCash += (drawer.lastCount.bills[v] || 0) * v;
            });
            [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
              expectedInitialCash += (drawer.lastCount.coins?.[k] || 0) * val;
            });
          }
          expectedInitialChecks = drawer.lastCount.checksTotal || 0;
          expectedInitialTotal = drawer.lastCount.total || expectedInitialCash + expectedInitialChecks;
        }
      }

      // Calculate expected payment total
      const running = session.register?.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };
      const expectedPaymentCash = (running.cashIn || 0) - (running.cashOut || 0);
      const expectedPaymentChecks = running.checkIn || 0;
      const expectedPaymentTotal = expectedPaymentCash + expectedPaymentChecks;

      // Build the two-step interface
      module.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <div>
            <h3 id="drawerCountTitle" class="text-2xl font-bold text-slate-800 dark:text-slate-200">${drawerName} End Of Day Cash Count</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400">Enter quantities to establish the end of day register balance.</p>
          </div>
          <button onclick="cancelDrawerCount()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Step Indicator -->
        <div class="flex items-center gap-4 mb-6">
          <button id="eodStep1Btn" onclick="switchEODStep(1)" class="px-4 py-2 text-sm font-semibold bg-green-600 text-white rounded-lg">Step 1: SOD Fund Count</button>
          <button id="eodStep2Btn" onclick="switchEODStep(2)" class="px-4 py-2 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg">Step 2: Count Payment Total</button>
        </div>

        <!-- Step 1: SOD Fund Count -->
        <div id="eodStep1" class="space-y-6">
          <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
            <p class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2">SOD Fund Count (what was in the drawer at the start)</p>
            <p id="eodExpectedInitialTotal" class="text-xs text-green-600 dark:text-green-400">Expected Initial Total: $${expectedInitialTotal.toFixed(2)} (initial cash ${expectedInitialCash.toFixed(2)}, initial checks ${expectedInitialChecks.toFixed(2)})</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
              <div id="eodStep1BillsContainer" class="grid grid-cols-2 gap-3">
                <!-- Bills will be populated dynamically -->
              </div>
            </div>

            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
              <div id="eodStep1CoinsContainer" class="grid grid-cols-2 gap-3">
                <!-- Coins will be populated dynamically -->
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <p id="eodInitialTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">SOD Fund Total: $0.00</p>
            </div>
            <div class="flex gap-3">
              <button onclick="switchEODStep(2)" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Continue to Step 2</button>
            </div>
          </div>
        </div>

        <!-- Step 2: Payment Count -->
        <div id="eodStep2" class="hidden space-y-6">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
            <p class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">Count the payment total (money received during this batch)</p>
            <p id="eodExpectedPaymentTotal" class="text-xs text-blue-600 dark:text-blue-400">Expected Payment Total: $${expectedPaymentTotal.toFixed(2)} (received cash ${expectedPaymentCash.toFixed(2)}, received checks ${expectedPaymentChecks.toFixed(2)})</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
              <div id="eodStep2BillsContainer" class="grid grid-cols-2 gap-3">
                <!-- Bills will be populated dynamically -->
              </div>
            </div>

            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
              <div id="eodStep2CoinsContainer" class="grid grid-cols-2 gap-3">
                <!-- Coins will be populated dynamically -->
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Checks</h5>
              <button onclick="addEODCheckInput()" class="text-sm text-blue-600 hover:text-blue-800">Add Check</button>
            </div>
            <div id="eodChecksContainer" class="space-y-2">
              <div class="flex items-center gap-3">
                <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #1</label>
                <input type="text" class="w-32 px-3 py-2 border rounded-lg" placeholder="Check #" data-check-number />
                <input type="number" min="0" step="0.01" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Amount" data-check-amount oninput="calculateEODTotal('payment')" />
                <button onclick="removeCheckInput(this)" class="text-xs text-red-500">Remove</button>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <p id="eodPaymentTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">Payment Total: $0.00</p>
            <div class="flex gap-3">
              <button onclick="switchEODStep(1)" class="px-4 py-2 text-sm bg-slate-200 rounded-lg">Back to Step 1</button>
              <button onclick="saveEndOfDayDrawerCount()" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Verify Drawer Count</button>
            </div>
          </div>
        </div>
      `;

      // Populate Step 1 (SOD Fund Count) bills and coins
      const step1BillsContainer = document.getElementById('eodStep1BillsContainer');
      const step1CoinsContainer = document.getElementById('eodStep1CoinsContainer');

      if (step1BillsContainer) {
        step1BillsContainer.innerHTML = '';
        [1,2,5,10,20,50,100].forEach(v => {
          const posBillCount = posInitialCount?.bills?.[v] || 0;
          const billDiv = document.createElement('div');
          billDiv.className = 'flex items-center gap-2';
          billDiv.innerHTML = `
            <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
              <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
              <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
              <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
              <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
              <line x1="28" y="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
            <input type="number" min="0" id="eod_initial_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateEODTotal('initial')">
            ${posBillCount > 0 ? `<span class="text-xs text-slate-500">(POS: ${posBillCount})</span>` : ''}
          `;
          step1BillsContainer.appendChild(billDiv);
        });
      }

      if (step1CoinsContainer) {
        step1CoinsContainer.innerHTML = '';
        [['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0'],['dollar',1.00,'Dollar Coin','#FFD700']].forEach(([k,val,label,color]) => {
          const posCoinCount = posInitialCount?.coins?.[k] || 0;
          const coinDiv = document.createElement('div');
          coinDiv.className = 'flex items-center gap-2';
          const coinSymbol = k === 'penny' ? '1¢' : k === 'nickel' ? '5¢' : k === 'dime' ? '10¢' : k === 'quarter' ? '25¢' : k === 'half' ? '50¢' : '$1';
          coinDiv.innerHTML = `
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
              <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
              <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${coinSymbol}</text>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
            <input type="number" min="0" id="eod_initial_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateEODTotal('initial')">
            ${posCoinCount > 0 ? `<span class="text-xs text-slate-500">(POS: ${posCoinCount})</span>` : ''}
          `;
          step1CoinsContainer.appendChild(coinDiv);
        });
      }

      // Populate Step 2 (Payment Count) bills and coins
      const step2BillsContainer = document.getElementById('eodStep2BillsContainer');
      const step2CoinsContainer = document.getElementById('eodStep2CoinsContainer');

      if (step2BillsContainer) {
        step2BillsContainer.innerHTML = '';
        [1,2,5,10,20,50,100].forEach(v => {
          const posBillCount = posPaymentCount?.bills?.[v] || 0;
          const billDiv = document.createElement('div');
          billDiv.className = 'flex items-center gap-2';
          billDiv.innerHTML = `
            <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
              <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
              <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
              <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
              <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
              <line x1="28" y="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
            <input type="number" min="0" id="eod_payment_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateEODTotal('payment')">
            ${posBillCount > 0 ? `<span class="text-xs text-slate-500">(POS: ${posBillCount})</span>` : ''}
          `;
          step2BillsContainer.appendChild(billDiv);
        });
      }

      if (step2CoinsContainer) {
        step2CoinsContainer.innerHTML = '';
        [['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0'],['dollar',1.00,'Dollar Coin','#FFD700']].forEach(([k,val,label,color]) => {
          const posCoinCount = posPaymentCount?.coins?.[k] || 0;
          const coinDiv = document.createElement('div');
          coinDiv.className = 'flex items-center gap-2';
          const coinSymbol = k === 'penny' ? '1¢' : k === 'nickel' ? '5¢' : k === 'dime' ? '10¢' : k === 'quarter' ? '25¢' : k === 'half' ? '50¢' : '$1';
          coinDiv.innerHTML = `
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
              <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
              <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${coinSymbol}</text>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
            <input type="number" min="0" id="eod_payment_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateEODTotal('payment')">
            ${posCoinCount > 0 ? `<span class="text-xs text-slate-500">(POS: ${posCoinCount})</span>` : ''}
          `;
          step2CoinsContainer.appendChild(coinDiv);
        });
      }

      // Show drawer count module and start on step 1
      module.classList.remove('hidden');
      module.scrollIntoView({ behavior: 'smooth', block: 'start' });
      switchEODStep(1);
      calculateEODTotal('initial');
    }

    // EOD Helper Functions
    window.switchEODStep = function(step) {
      const step1 = document.getElementById('eodStep1');
      const step2 = document.getElementById('eodStep2');
      const btn1 = document.getElementById('eodStep1Btn');
      const btn2 = document.getElementById('eodStep2Btn');

      if (!step1 || !step2 || !btn1 || !btn2) return;

      if (step === 1) {
        step1.classList.remove('hidden');
        step2.classList.add('hidden');
        btn1.classList.remove('bg-slate-200', 'text-slate-700');
        btn1.classList.add('bg-green-600', 'text-white');
        btn2.classList.remove('bg-green-600', 'text-white');
        btn2.classList.add('bg-slate-200', 'text-slate-700');
        calculateEODTotal('initial');
      } else {
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        btn1.classList.remove('bg-green-600', 'text-white');
        btn1.classList.add('bg-slate-200', 'text-slate-700');
        btn2.classList.remove('bg-slate-200', 'text-slate-700');
        btn2.classList.add('bg-green-600', 'text-white');
        calculateEODTotal('payment');
      }
    };

    window.calculateEODTotal = function(type) {
      if (type === 'initial') {
        let total = 0;
        [1,2,5,10,20,50,100].forEach(v => {
          const input = document.getElementById(`eod_initial_bill_${v}`);
          if (input) total += (parseFloat(input.value) || 0) * v;
        });
        [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
          const input = document.getElementById(`eod_initial_coin_${k}`);
          if (input) total += (parseFloat(input.value) || 0) * val;
        });
        const totalEl = document.getElementById('eodInitialTotal');
        if (totalEl) totalEl.textContent = `SOD Fund Total: $${total.toFixed(2)}`;
        return total;
      } else {
        let total = 0;
        [1,2,5,10,20,50,100].forEach(v => {
          const input = document.getElementById(`eod_payment_bill_${v}`);
          if (input) total += (parseFloat(input.value) || 0) * v;
        });
        [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
          const input = document.getElementById(`eod_payment_coin_${k}`);
          if (input) total += (parseFloat(input.value) || 0) * val;
        });
        const checksContainer = document.getElementById('eodChecksContainer');
        if (checksContainer) {
          const checkRows = checksContainer.querySelectorAll('div.flex.items-center');
          checkRows.forEach(row => {
            const amountInput = row.querySelector('input[data-check-amount]');
            if (amountInput) {
              total += parseFloat(amountInput.value) || 0;
            }
          });
        }
        const totalEl = document.getElementById('eodPaymentTotal');
        if (totalEl) totalEl.textContent = `Payment Total: $${total.toFixed(2)}`;
        return total;
      }
    };

    window.addEODCheckInput = function() {
      const container = document.getElementById('eodChecksContainer');
      if (!container) return;
      const checkCount = container.querySelectorAll('.flex.items-center.gap-3').length + 1;
      const checkDiv = document.createElement('div');
      checkDiv.className = 'flex items-center gap-3';
      checkDiv.innerHTML = `
        <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #${checkCount}</label>
        <input type="text" class="w-32 px-3 py-2 border rounded-lg" placeholder="Check #" data-check-number />
        <input type="number" min="0" step="0.01" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Amount" data-check-amount oninput="calculateEODTotal('payment')" />
        <button onclick="removeCheckInput(this)" class="text-xs text-red-500">Remove</button>
      `;
      container.appendChild(checkDiv);
    };

    window.printEODSODReceipt = function() {
      if (!selectedSessionForVerification) return;
      const session = selectedSessionForVerification;
      const drawerName = session.drawer?.name || 'Unknown Drawer';

      let total = 0;
      const bills = {};
      const coins = {};

      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`eod_initial_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          bills[v] = count;
          total += count * v;
        }
      });

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        const input = document.getElementById(`eod_initial_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          coins[k] = count;
          total += count * val;
        }
      });

      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${drawerName} - EOD SOD Fund Count Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
          </style>
        </head>
        <body>
          <h1>${drawerName} - EOD SOD Fund Count</h1>
          <h2>Supervisor Verification Receipt</h2>
          <div class="info">
            <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
          </div>
          <h3>Bills</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [1,2,5,10,20,50,100].forEach(v => {
        if (bills[v] > 0) {
          receiptHtml += `<tr><td>$${v}</td><td>${bills[v]}</td><td>$${(bills[v] * v).toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <h3>Coins</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        if (coins[k] > 0) {
          receiptHtml += `<tr><td>${label}</td><td>${coins[k]}</td><td>$${(coins[k] * val).toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <div class="total">Total: $${total.toFixed(2)}</div>
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin-top: 30px;">Initials: _____________</p>
          </div>
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    window.printEODPaymentReceipt = function() {
      if (!selectedSessionForVerification) return;
      const session = selectedSessionForVerification;
      const drawerName = session.drawer?.name || 'Unknown Drawer';

      let total = 0;
      const bills = {};
      const coins = {};
      const checks = [];

      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`eod_payment_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          bills[v] = count;
          total += count * v;
        }
      });

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        const input = document.getElementById(`eod_payment_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          coins[k] = count;
          total += count * val;
        }
      });

      const checksContainer = document.getElementById('eodChecksContainer');
      if (checksContainer) {
        const checkRows = checksContainer.querySelectorAll('div.flex.items-center');
        checkRows.forEach(row => {
          const numberInput = row.querySelector('input[data-check-number]');
          const amountInput = row.querySelector('input[data-check-amount]');
          if (numberInput && amountInput) {
            const checkNumber = numberInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;
            if (amount > 0) {
              checks.push({
                number: checkNumber || null,
                amount: amount
              });
              total += amount;
            }
          }
        });
      }

      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${drawerName} - EOD Payment Count Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
          </style>
        </head>
        <body>
          <h1>${drawerName} - EOD Payment Count</h1>
          <h2>Supervisor Verification Receipt</h2>
          <div class="info">
            <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
          </div>
          <h3>Bills</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [1,2,5,10,20,50,100].forEach(v => {
        if (bills[v] > 0) {
          receiptHtml += `<tr><td>$${v}</td><td>${bills[v]}</td><td>$${(bills[v] * v).toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <h3>Coins</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars'],['dollar',1.00,'Dollar Coin']].forEach(([k,val,label]) => {
        if (coins[k] > 0) {
          receiptHtml += `<tr><td>${label}</td><td>${coins[k]}</td><td>$${(coins[k] * val).toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <h3>Checks</h3>
          <table>
            <tr><th>Check #</th><th>Amount</th></tr>
      `;

      if (checks.length > 0) {
        checks.forEach((check, idx) => {
          const checkNumber = (typeof check === 'object' && check.number) ? check.number : (check.number || `Check #${idx + 1}`);
          const amount = (typeof check === 'object' && check.amount !== undefined) ? check.amount : check;
          receiptHtml += `<tr><td>${checkNumber || `Check #${idx + 1}`}</td><td>$${Number(amount).toFixed(2)}</td></tr>`;
        });
      } else {
        receiptHtml += `<tr><td colspan="2">No checks</td></tr>`;
      }

      receiptHtml += `
          </table>
          <div class="total">Total: $${total.toFixed(2)}</div>
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin-top: 30px;">Initials: _____________</p>
          </div>
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    // Override saveDrawerCount for end of day verification
    const originalSaveDrawerCount = window.saveDrawerCount;
    window.saveEndOfDayDrawerCount = async function() {
      if (!selectedSessionForVerification) {
        alert('No session selected for verification');
        return;
      }

      // Check if "Use username instead of user code" toggle is enabled
      const togglesSettings = await loadTogglesSettings();
      console.log('[saveEndOfDayDrawerCount] Toggles settings:', togglesSettings);
      console.log('[saveEndOfDayDrawerCount] useUsernameInsteadOfUserCode value:', togglesSettings?.useUsernameInsteadOfUserCode);
      console.log('[saveEndOfDayDrawerCount] useUsernameInsteadOfUserCode type:', typeof togglesSettings?.useUsernameInsteadOfUserCode);
      const useUsernameInsteadOfUserCode = togglesSettings && (togglesSettings.useUsernameInsteadOfUserCode === true || togglesSettings.useUsernameInsteadOfUserCode === 'true' || togglesSettings.useUsernameInsteadOfUserCode === 1);
      console.log('[saveEndOfDayDrawerCount] Final useUsernameInsteadOfUserCode check result:', useUsernameInsteadOfUserCode);

      let verifiedByName = null;
      let user = null;

      let userCode = null;
      if (useUsernameInsteadOfUserCode) {
        console.log('[saveEndOfDayDrawerCount] Using username instead of user code');
        // Use logged-in username
        const effectiveUser = window.getEffectiveUser ? window.getEffectiveUser() : null;
        console.log('[saveEndOfDayDrawerCount] Effective user:', effectiveUser);
        if (effectiveUser && effectiveUser.fullName) {
          verifiedByName = effectiveUser.fullName;
          user = users.find(u => u.fullName && u.fullName.trim().toLowerCase() === effectiveUser.fullName.trim().toLowerCase());
          console.log('[saveEndOfDayDrawerCount] Found user by username:', user);
          if (!user) {
            alert('User not found in system. Please contact an administrator.');
            return;
          }
          // Get userCode from the found user
          userCode = user.userCode || '';
        } else {
          alert('Unable to determine your username. Please ensure you are logged in.');
          return;
        }
      } else {
        console.log('[saveEndOfDayDrawerCount] Prompting for user code');
        // Prompt for user code
        userCode = prompt('Enter your user code:');
        if (!userCode || !userCode.trim()) {
          alert('User code is required to verify the drawer count.');
          return;
        }

        // Find user by code
        user = users.find(u => u.userCode && u.userCode.trim().toLowerCase() === userCode.trim().toLowerCase());
        if (!user) {
          alert('User code not found. Please enter a valid user code.');
          return;
        }

        verifiedByName = user.fullName || userCode;
      }

      // Read Step 1: SOD Fund Count
      const initialBills = {};
      const initialCoins = {};
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`eod_initial_bill_${v}`);
        if (input) {
          initialBills[v] = parseFloat(input.value) || 0;
        }
      });
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const input = document.getElementById(`eod_initial_coin_${k}`);
        if (input) {
          initialCoins[k] = parseFloat(input.value) || 0;
        }
      });
      const supervisorInitialTotal = calculateEODTotal('initial');

      // Read Step 2: Payment Count
      const paymentBills = {};
      const paymentCoins = {};
      const paymentChecks = [];
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`eod_payment_bill_${v}`);
        if (input) {
          paymentBills[v] = parseFloat(input.value) || 0;
        }
      });
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
        const input = document.getElementById(`eod_payment_coin_${k}`);
        if (input) {
          paymentCoins[k] = parseFloat(input.value) || 0;
        }
      });
      const checksContainer = document.getElementById('eodChecksContainer');
      if (checksContainer) {
        const checkRows = checksContainer.querySelectorAll('div.flex.items-center');
        checkRows.forEach(row => {
          const numberInput = row.querySelector('input[data-check-number]');
          const amountInput = row.querySelector('input[data-check-amount]');
          if (numberInput && amountInput) {
            const checkNumber = numberInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;
            if (amount > 0) {
              paymentChecks.push({
                number: checkNumber || null,
                amount: amount
              });
            }
          }
        });
      }
      const supervisorPaymentTotal = calculateEODTotal('payment');
      const supervisorPaymentCash = Object.entries(paymentBills).reduce((sum, [denom, qty]) => sum + (parseFloat(denom) * (qty || 0)), 0)
        + Object.entries(paymentCoins).reduce((sum, [key, qty]) => {
          const valMap = { penny: 0.01, nickel: 0.05, dime: 0.10, quarter: 0.25, half: 0.50, dollar: 1.00 };
          return sum + ((valMap[key] || 0) * (qty || 0));
        }, 0);
      const supervisorPaymentChecks = paymentChecks.reduce((sum, check) => sum + (check.amount || 0), 0);

      // Get POS counts
      const posInitialCount = selectedSessionForVerification.register?.closing?.initialCount;
      const posPaymentCount = selectedSessionForVerification.register?.closing?.paymentCount;

      // Check if "POS Doesn't Close Out" toggle is enabled (reuse togglesSettings from earlier)
      const posDoesntCloseOut = togglesSettings && (togglesSettings.posDoesntCloseOut === true || togglesSettings.posDoesntCloseOut === 'true' || togglesSettings.posDoesntCloseOut === 1);

      // If POS doesn't close out toggle is enabled, skip POS count validation
      // The supervisor will do the count without POS validation
      if (!posDoesntCloseOut && !posInitialCount && !posPaymentCount) {
        alert('POS count data not found for this session.');
        return;
      }

      // Validate Step 1: Initial Count (only if POS count exists and toggle is off)
      if (posInitialCount && !posDoesntCloseOut) {
        let posInitialTotal = 0;
        [1,2,5,10,20,50,100].forEach(v => {
          const count = posInitialCount.bills?.[v] || 0;
          posInitialTotal += count * v;
        });
        [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
          const count = posInitialCount.coins?.[k] || 0;
          posInitialTotal += count * val;
        });
        posInitialTotal += posInitialCount.checksTotal || 0;

        const initialDifference = Math.abs(supervisorInitialTotal - posInitialTotal);
        if (initialDifference > 0.01) {
          const status = supervisorInitialTotal > posInitialTotal ? 'over' : 'short';
          alert(`Step 1 (SOD Fund Count) does not match!\n\nPOS Count: $${posInitialTotal.toFixed(2)}\nYour Count: $${supervisorInitialTotal.toFixed(2)}\n\nYou are ${status} by $${initialDifference.toFixed(2)}.\n\nPlease recount and try again.`);
          return;
        }
      }

      // Validate Step 2: Payment Count (only if POS count exists and toggle is off)
      if (posPaymentCount && !posDoesntCloseOut) {
        let posPaymentTotal = 0;
        [1,2,5,10,20,50,100].forEach(v => {
          const count = posPaymentCount.bills?.[v] || 0;
          posPaymentTotal += count * v;
        });
        [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50],['dollar',1.00]].forEach(([k,val]) => {
          const count = posPaymentCount.coins?.[k] || 0;
          posPaymentTotal += count * val;
        });
        const posChecksTotal = posPaymentCount.checksTotal !== undefined
          ? posPaymentCount.checksTotal
          : (posPaymentCount.checks || []).reduce((sum, check) => sum + (check.amount || 0), 0);
        posPaymentTotal += posChecksTotal;

        // Validate payment cash/check totals separately
        const posPaymentCash = posPaymentCount.cashTotal !== undefined
          ? posPaymentCount.cashTotal
          : posPaymentTotal - posChecksTotal;
        const cashVariance = supervisorPaymentCash - posPaymentCash;
        const checksVariance = supervisorPaymentChecks - posChecksTotal;

        if (Math.abs(cashVariance) > 0.01) {
          const statusMsg = `Payment cash count ${cashVariance > 0 ? 'over' : 'short'} by $${Math.abs(cashVariance).toFixed(2)}.\n\nExpected Cash Total: $${posPaymentCash.toFixed(2)}\nYour Cash Count: $${supervisorPaymentCash.toFixed(2)}\n\nPlease correct the count and try again.`;
          showPaymentCountErrorModal('Payment Cash Count Error', statusMsg);
          return;
        }

        if (Math.abs(checksVariance) > 0.01) {
          const statusMsg = `Payment checks count ${checksVariance > 0 ? 'over' : 'short'} by $${Math.abs(checksVariance).toFixed(2)}.\n\nExpected Checks Total: $${posChecksTotal.toFixed(2)}\nYour Checks Count: $${supervisorPaymentChecks.toFixed(2)}\n\nPlease correct the count and try again.`;
          showPaymentCountErrorModal('Payment Checks Count Error', statusMsg);
          return;
        }

        // Validate check numbers and amounts
        const expectedChecks = (posPaymentCount.checks || []).map((check) => ({
          number: (check.number || '').trim(),
          amount: check.amount || 0
        })).filter(c => c.number.length > 0 || c.amount > 0);

        if (expectedChecks.length > 0) {
          const missingNumbers = paymentChecks.filter(c => !c.number || !c.number.trim());
          if (missingNumbers.length > 0) {
            const statusMsg = `Each check must include a check number to verify the drawer.\n\nMissing check numbers: ${missingNumbers.length}`;
            showPaymentCountErrorModal('Check Number Required', statusMsg);
            return;
          }

          const toKey = (c) => `${c.number.trim()}::${Number(c.amount || 0).toFixed(2)}`;
          const expectedKeys = expectedChecks.map(toKey).sort();
          const countedKeys = paymentChecks.map(toKey).sort();
          const isMatch = expectedKeys.length === countedKeys.length &&
            expectedKeys.every((val, idx) => val === countedKeys[idx]);
          if (!isMatch) {
            const statusMsg = `Check numbers or amounts do not match the POS count.\n\nExpected: ${expectedKeys.join(', ')}\nCounted: ${countedKeys.join(', ')}`;
            showPaymentCountErrorModal('Check Mismatch', statusMsg);
            return;
          }
        }

        const paymentDifference = Math.abs(supervisorPaymentTotal - posPaymentTotal);
        if (paymentDifference > 0.01) {
          const status = supervisorPaymentTotal > posPaymentTotal ? 'over' : 'short';
          const statusMsg = `Step 2 (Payment Count) does not match!\n\nPOS Count: $${posPaymentTotal.toFixed(2)}\nYour Count: $${supervisorPaymentTotal.toFixed(2)}\n\nYou are ${status} by $${paymentDifference.toFixed(2)}.\n\nPlease recount and try again.`;
          showPaymentCountErrorModal('Payment Count Error', statusMsg);
          return;
        }
      }

      // Counts match - mark as verified
      selectedSessionForVerification.verifiedBy = verifiedByName;
      selectedSessionForVerification.verifiedByCode = userCode ? userCode.trim() : (user?.userCode || '');
      selectedSessionForVerification.verifiedAt = new Date().toISOString();
      
      // If session doesn't have submittedAt (pending drawer), set it to verifiedAt for BEOD reporting
      if (!selectedSessionForVerification.submittedAt) {
        selectedSessionForVerification.submittedAt = selectedSessionForVerification.verifiedAt;
      }
      
      // Set username to supervisor's name if it's a pending drawer (POS doesn't close out)
      if (!selectedSessionForVerification.username && verifiedByName) {
        selectedSessionForVerification.username = verifiedByName;
      }
      
      // Ensure totalAmount is calculated from entries if missing
      if (!selectedSessionForVerification.totalAmount && selectedSessionForVerification.entries && selectedSessionForVerification.entries.length > 0) {
        selectedSessionForVerification.totalAmount = selectedSessionForVerification.entries.reduce((sum, entry) => sum + (parseFloat(entry.amount) || 0), 0);
      }
      
      selectedSessionForVerification.supervisorCount = {
        initialCount: {
          bills: initialBills,
          coins: initialCoins,
          total: supervisorInitialTotal
        },
        paymentCount: {
          bills: paymentBills,
          coins: paymentCoins,
          checks: paymentChecks,
          checksTotal: paymentChecks.reduce((sum, check) => sum + (check.amount || 0), 0),
          total: supervisorPaymentTotal
        }
      };

      // Update in local array
      const sessionIndex = window.paymentProcessingSessions.findIndex(s => s.id === selectedSessionForVerification.id);
      if (sessionIndex !== -1) {
        window.paymentProcessingSessions[sessionIndex] = selectedSessionForVerification;
      }

      // Save to Firestore (if function exists)
      if (typeof savePaymentProcessingSessionToFirestore === 'function') {
        await savePaymentProcessingSessionToFirestore(selectedSessionForVerification);
      } else {
        // Fallback: try to save using Firestore directly
        try {
          const sessionsRef = collection(db, 'paymentProcessingSessions');
          const sessionRef = doc(sessionsRef, selectedSessionForVerification.id);
          await setDoc(sessionRef, selectedSessionForVerification);
        } catch (error) {

        }
      }

      const initialMsg = posInitialCount ? `Step 1 (SOD Fund): POS $${posInitialCount.total?.toFixed(2) || '0.00'}, Your $${supervisorInitialTotal.toFixed(2)}` : '';
      const paymentMsg = posPaymentCount ? `Step 2 (Payment): POS $${posPaymentCount.total?.toFixed(2) || '0.00'}, Your $${supervisorPaymentTotal.toFixed(2)}` : '';

      // Show custom success modal instead of alert
      showEODVerificationSuccessModal(selectedSessionForVerification, initialMsg, paymentMsg, verifiedByName);

      // Reload sessions if function exists
      if (typeof loadPaymentProcessingSessionsFromFirestore === 'function') {
        await loadPaymentProcessingSessionsFromFirestore();
      }

      // Hide drawer count screen
      cancelDrawerCount();
      selectedSessionForVerification = null;
    };

    // Show drawer count history
    window.showDrawerCountHistory = function(drawerId, context) {
      const drawer = drawers.find(d => d.id === drawerId);
      if (!drawer) {
        alert('Drawer not found');
        return;
      }

      const modal = document.getElementById('drawerCountHistoryModal');
      const title = document.getElementById('drawerCountHistoryTitle');
      const list = document.getElementById('drawerCountHistoryList');

      if (!modal || !title || !list) return;

      // Set title based on context
      if (context === 'EOD') {
        title.textContent = `${drawer.name} - EOD Count History`;
      } else if (context === 'SOD') {
        title.textContent = `${drawer.name} - SOD Count History`;
      } else {
        // Default: just "Count History"
        title.textContent = `${drawer.name} - Count History`;
      }

      if (!drawer.countHistory || drawer.countHistory.length === 0) {
        list.innerHTML = `
          <div class="text-center py-8 text-slate-500 dark:text-slate-400">
            <p>No count history available for this drawer.</p>
          </div>
        `;
      } else {
        list.innerHTML = '';
        drawer.countHistory.forEach((count, index) => {
          const date = new Date(count.countedAt);
          const dateStr = date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          // Determine count type (SOD or EOD)
          const isEndOfDay = count.type === 'EOD' || count.isEndOfDayVerification || count.verifiedBy || count.sessionId;
          const countType = isEndOfDay ? 'EOD' : (count.type || 'SOD');
          const countTypeLabel = countType === 'EOD' ? 'End Of Day' : 'Start Of Day';
          const countTypeBadge = countType === 'EOD' 
            ? '<span class="text-xs font-semibold bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-3 py-1 rounded-full">EOD</span>'
            : '<span class="text-xs font-semibold bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full">SOD</span>';

          const entry = document.createElement('div');
          entry.className = 'border border-slate-200 dark:border-slate-700 rounded-lg p-4 hover:bg-slate-50 dark:hover:bg-slate-700';
          entry.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="font-semibold text-slate-900 dark:text-slate-100 mb-2">${dateStr}</p>
                <div class="mb-2">
                  ${countTypeBadge}
                </div>
                <p class="text-sm text-slate-600 dark:text-slate-400 font-medium">${countTypeLabel} - Counted by: ${count.countedBy}</p>
                <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 mt-1">Total: $${count.total.toFixed(2)}</p>
              </div>
              <div class="flex gap-2">
                <button 
                  onclick="showDrawerCountDetails('${drawerId}', ${index})" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                >
                  Open
                </button>
                <button 
                  onclick="deleteDrawerCount('${drawerId}', ${index})" 
                  class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"
                >
                  Delete
                </button>
              </div>
            </div>
          `;
          list.appendChild(entry);
        });
      }

      modal.classList.remove('hidden');
    };

    window.hideDrawerCountHistoryModal = function() {
      const modal = document.getElementById('drawerCountHistoryModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    };

    // Show drawer count details
    window.showDrawerCountDetails = function(drawerId, countIndex) {
      const drawer = drawers.find(d => d.id === drawerId);
      if (!drawer || !drawer.countHistory || !drawer.countHistory[countIndex]) {
        alert('Count record not found');
        return;
      }

      const count = drawer.countHistory[countIndex];
      const modal = document.getElementById('drawerCountDetailsModal');
      const title = document.getElementById('drawerCountDetailsTitle');
      const content = document.getElementById('drawerCountDetailsContent');

      if (!modal || !title || !content) return;

      const date = new Date(count.countedAt);
      const dateStr = date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Determine if this is Start Of Day or End Of Day
      // Check if this count is from a payment processing session (End Of Day) or supervisor count (Start Of Day)
      const isEndOfDay = count.isEndOfDayVerification || count.verifiedBy || count.sessionId;
      const countType = isEndOfDay ? 'End Of Day' : 'Start Of Day';
      title.textContent = `${drawer.name} - ${countType} Count Details`;

      // Build bills section with SVG icons
      let billsHtml = '<div class="space-y-3 mb-6"><h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-3">Bills</h3><div class="grid grid-cols-2 gap-3">';
      [1,2,5,10,20,50,100].forEach(v => {
        const billCount = count.bills[v] || 0;
        const amount = billCount * v;
        billsHtml += `
          <div class="flex items-center gap-2 p-2 bg-slate-50 dark:bg-slate-700 rounded">
            <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
              <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
              <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
              <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
              <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
              <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300 flex-1">$${v}</label>
            <span class="text-sm font-medium text-slate-900 dark:text-slate-100">${billCount} × $${v} = $${amount.toFixed(2)}</span>
          </div>
        `;
      });
      billsHtml += '</div></div>';

      // Build coins section with SVG icons
      let coinsHtml = '<div class="space-y-3"><h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-3">Coins</h3><div class="grid grid-cols-2 gap-3">';
      [['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0']].forEach(([k,val,label,color]) => {
        const coinCount = count.coins[k] || 0;
        const amount = coinCount * val;
        const coinSymbol = k === 'penny' ? '1¢' : k === 'nickel' ? '5¢' : k === 'dime' ? '10¢' : k === 'quarter' ? '25¢' : '50¢';
        coinsHtml += `
          <div class="flex items-center gap-2 p-2 bg-slate-50 dark:bg-slate-700 rounded">
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
              <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
              <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${coinSymbol}</text>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300 flex-1">${label}</label>
            <span class="text-sm font-medium text-slate-900 dark:text-slate-100">${coinCount} × $${val.toFixed(2)} = $${amount.toFixed(2)}</span>
          </div>
        `;
      });
      coinsHtml += '</div></div>';

      content.innerHTML = `
        <div class="mb-6">
          <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">Date: ${dateStr}</p>
          <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">Counted by: ${count.countedBy}</p>
          <p class="text-lg font-bold text-slate-900 dark:text-slate-100">Total: $${count.total.toFixed(2)}</p>
        </div>
        ${billsHtml}
        ${coinsHtml}
        <div class="mt-6 flex justify-end">
          <button 
            onclick="printDrawerCountReceipt('${drawerId}', ${countIndex})" 
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          >
            Print Receipt
          </button>
        </div>
      `;

      modal.classList.remove('hidden');
    };

    window.hideDrawerCountDetailsModal = function() {
      const modal = document.getElementById('drawerCountDetailsModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    };

    // Print drawer count receipt (PDF without SVGs)
    window.printDrawerCountReceipt = function(drawerId, countIndex) {
      const drawer = drawers.find(d => d.id === drawerId);
      if (!drawer || !drawer.countHistory || !drawer.countHistory[countIndex]) {
        alert('Count record not found');
        return;
      }

      const count = drawer.countHistory[countIndex];
      const date = new Date(count.countedAt);
      const dateStr = date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const isEndOfDay = count.isEndOfDayVerification || count.verifiedBy || count.sessionId;
      const countType = isEndOfDay ? 'End Of Day' : 'Start Of Day';

      // Build receipt HTML without SVGs
      let receiptHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Drawer Count Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 10px; }
            h2 { text-align: center; color: #666; margin-bottom: 30px; }
            .info { margin-bottom: 20px; }
            .info p { margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
          </style>
        </head>
        <body>
          <h1>${drawer.name} - ${countType} Count Receipt</h1>
          <div class="info">
            <p><strong>Date:</strong> ${dateStr}</p>
            <p><strong>Counted by:</strong> ${count.countedBy}</p>
          </div>
          <h3>Bills</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [1,2,5,10,20,50,100].forEach(v => {
        const billCount = count.bills[v] || 0;
        if (billCount > 0) {
          const amount = billCount * v;
          receiptHtml += `<tr><td>$${v}</td><td>${billCount}</td><td>$${amount.toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <h3>Coins</h3>
          <table>
            <tr><th>Denomination</th><th>Quantity</th><th>Amount</th></tr>
      `;

      [['penny',0.01,'Pennies'],['nickel',0.05,'Nickels'],['dime',0.10,'Dimes'],['quarter',0.25,'Quarters'],['half',0.50,'Half Dollars']].forEach(([k,val,label]) => {
        const coinCount = count.coins[k] || 0;
        if (coinCount > 0) {
          const amount = coinCount * val;
          receiptHtml += `<tr><td>${label}</td><td>${coinCount}</td><td>$${amount.toFixed(2)}</td></tr>`;
        }
      });

      receiptHtml += `
          </table>
          <div class="total">Total: $${count.total.toFixed(2)}</div>
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin-top: 30px;">Initials: _____________</p>
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(receiptHtml);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    // Delete drawer count from history
    window.deleteDrawerCount = async function(drawerId, countIndex) {
      if (!confirm('Are you sure you want to delete this count record? This action cannot be undone.')) {
        return;
      }

      const drawer = drawers.find(d => d.id === drawerId);
      if (!drawer || !drawer.countHistory || !drawer.countHistory[countIndex]) {
        alert('Count record not found');
        return;
      }

      // Remove the count from history
      drawer.countHistory.splice(countIndex, 1);

      // Update lastCount if this was the most recent count
      if (drawer.countHistory.length > 0) {
        drawer.lastCount = drawer.countHistory[0];
        drawer.lastCountDate = drawer.countHistory[0].countedAt;
      } else {
        drawer.lastCount = null;
        drawer.lastCountDate = null;
        drawer.available = false;
      }

      await saveDrawersToFirestore();
      showDrawerCountHistory(drawerId); // Refresh the history display
    };

    // Perform search in search module
    window.performSearch = function() {
      const nameInput = document.getElementById('searchByName');
      const statusSelect = document.getElementById('searchByStatus');
      const resultsContainer = document.getElementById('searchResults');

      if (!nameInput || !statusSelect || !resultsContainer) return;

      const searchTerm = nameInput.value.toLowerCase().trim();
      const statusFilter = statusSelect.value;

      const results = customers.filter(customer => {
        const customerName = (customer.name || '').toLowerCase().trim();
        const customerAccount = (customer.accountNumber || '').toLowerCase().trim();
        const customerAddress = (customer.address || '').toLowerCase().trim();
        const customerPhone = String(customer.phone || '').toLowerCase().trim();

        const nameMatch = !searchTerm || customerName.includes(searchTerm);
        const accountMatch = !searchTerm || customerAccount.includes(searchTerm);
        const addressMatch = !searchTerm || customerAddress.includes(searchTerm);
        const phoneMatch = !searchTerm || customerPhone.includes(searchTerm);
        const statusMatch = !statusFilter || customer.paymentStatus === statusFilter;

        return statusMatch && (nameMatch || accountMatch || addressMatch || phoneMatch);
      });

      if (results.length === 0) {
        resultsContainer.innerHTML = '<p class="text-sm text-slate-500 p-4 text-center">No customers found</p>';
        return;
      }

      // Calculate totals for each customer
      const resultsHtml = results.map(customer => {
        const calc = calculateCustomerTotal(customer);
        const totalAmount = Math.max(0, calc.total);
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        return `
          <div class="p-4 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="font-semibold text-slate-800 dark:text-slate-200">${customer.name || 'N/A'}</div>
                <div class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                  <div>Account #: ${customer.accountNumber || 'N/A'}</div>
                  <div>Status: <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusClass}">${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}</span></div>
                  <div>Amount Due: $${totalAmount.toFixed(2)}</div>
                </div>
              </div>
              <div class="ml-4 flex gap-2">
                <button 
                  onclick="showAmountBreakdownForCustomer('${customer.id}')" 
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
                >
                  View Amount Breakdown
                </button>
                <button 
                  onclick="showCustomerFullInfo('${customer.id}')" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                >
                  View Customer Info
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      resultsContainer.innerHTML = resultsHtml;
    };

    // Clear search in search module
    window.clearSearch = function() {
      const nameInput = document.getElementById('searchByName');
      const statusSelect = document.getElementById('searchByStatus');
      const resultsContainer = document.getElementById('searchResults');

      if (nameInput) nameInput.value = '';
      if (statusSelect) statusSelect.value = '';
      if (resultsContainer) resultsContainer.innerHTML = '<!-- Search results will be displayed here -->';
    };

    // Search locations
    window.searchLocations = function() {
      const searchTerm = document.getElementById('locationSearch').value.toLowerCase();
      filteredLocations = locations.filter(location => 
        location.address.toLowerCase().includes(searchTerm) ||
        location.propertyType.toLowerCase().includes(searchTerm) ||
        (location.currentResident && location.currentResident.toLowerCase().includes(searchTerm))
      );
      updateLocationsTable();
    };

    window.searchUsers = function() {
      const searchInput = document.getElementById('settingsUserSearch');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      if (!searchTerm) {
        filteredUsers = [...users];
      } else {
        filteredUsers = users.filter(user => 
          (user.fullName || '').toLowerCase().includes(searchTerm)
        );
      }
      updateSettingsUsersTable();
    };

    // Filter locations by status
    window.filterLocationsByStatus = function(status) {
      if (status === 'all') {
        filteredLocations = [...locations];
      } else {
        filteredLocations = locations.filter(l => l.status === status);
      }
      updateLocationsTable();
    };

    // Import locations from JSON
    window.importLocations = async function() {
      const fileInput = document.getElementById('locationFileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a JSON file');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.locations && Array.isArray(data.locations)) {
            // Add new locations to existing ones
            data.locations.forEach(newLocation => {
              // Check if location already exists
              const exists = locations.find(l => l.id === newLocation.id);
              if (!exists) {
                locations.push({
                  ...newLocation,
                  currentResident: null,
                  status: 'available'
                });
              }
            });

            filteredLocations = [...locations];
            updateLocationsTable();
            await saveLocationsToFirestore();
            alert(`Successfully imported ${data.locations.length} locations!`);
            fileInput.value = ''; // Clear the input
          } else {
            alert('Invalid JSON format. Expected "locations" array.');
          }
        } catch (error) {
          alert('Error parsing JSON file: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    // Show transfer ownership modal
    window.showTransferOwnershipModal = function(location, currentResident, newClientData) {
      // Store the data for later use
      window.transferData = {
        location: location,
        currentResident: currentResident,
        newClientData: newClientData
      };

      // Calculate actual amount due (same logic as in table)
      const now = new Date();
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getFullYear();

      // Check if customer has paid early (before due date)
      const hasPaidEarly = currentResident.lastPayment && currentResident.lastPayment !== 'Never' && 
                          currentResident.lastPayment.includes('/') && 
                          new Date(currentResident.lastPayment) < new Date(dueDateStr);

      // Calculate actual amount based on breakdown logic
      const baseServiceCost = calculateProratedServiceCost(currentResident);
      const factor = currentResident.factor ? parseFloat(currentResident.factor) : 1.0;
      const adjustedServiceCost = baseServiceCost * factor;
      const lateFeeAmount = currentResident.pastDue > 0 ? lateFee : 0; // Late fee
      const totalAmount = hasPaidEarly ? 0 : (adjustedServiceCost + lateFeeAmount);

      // Populate the modal
      document.getElementById('transferWarningName').textContent = currentResident.name;
      document.getElementById('transferCurrentResident').textContent = currentResident.name;
      document.getElementById('transferNewLocationLabel').textContent = currentResident.name;
      document.getElementById('transferLocation').textContent = location.address;
      document.getElementById('transferNewClient').textContent = newClientData.name;
      document.getElementById('transferCurrentStatus').textContent = currentResident.paymentStatus.charAt(0).toUpperCase() + currentResident.paymentStatus.slice(1);
      document.getElementById('transferBalance').textContent = `$${totalAmount.toFixed(2)}`;

      // Show appropriate message based on balance
      const statusMessage = document.getElementById('transferStatusMessage');
      if (totalAmount === 0) {
        statusMessage.innerHTML = 'The current resident has a balance of $0.00 and will be marked as <strong>Inactive</strong> after transfer.';
        statusMessage.className = 'text-green-600 dark:text-green-400';
      } else {
        statusMessage.innerHTML = 'The current resident has an outstanding balance and will be marked as <strong>Pending Closing</strong> until their balance is paid.';
        statusMessage.className = 'text-red-600 dark:text-red-400';
      }

      document.getElementById('transferOwnershipModal').classList.remove('hidden');
    };

    // Hide transfer ownership modal
    window.hideTransferOwnershipModal = function() {
      document.getElementById('transferOwnershipModal').classList.add('hidden');
      document.getElementById('transferNewLocation').value = '';
    };

    // Process transfer ownership
    window.processTransferOwnership = async function() {
      const newLocation = document.getElementById('transferNewLocation').value.trim();

      if (!newLocation) {
        alert('Please enter the new location for the current resident');
        return;
      }

      const { location, currentResident, newClientData } = window.transferData;

      try {
        // Update current resident's location and status
        currentResident.address = newLocation;

        // Calculate actual balance to determine status
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early
        const hasPaidEarly = currentResident.lastPayment && currentResident.lastPayment !== 'Never' && 
                            currentResident.lastPayment.includes('/') && 
                            new Date(currentResident.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount due
        const baseServiceCost = calculateProratedServiceCost(currentResident);
        const factor = currentResident.factor ? parseFloat(currentResident.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;
        const lateFeeAmount = currentResident.pastDue > 0 ? lateFee : 0;
        const totalAmount = hasPaidEarly ? 0 : (adjustedServiceCost + lateFeeAmount);

        // Set status based on balance: inactive if balance is 0, pending closing if they owe money
        if (totalAmount === 0) {
          currentResident.paymentStatus = 'inactive';
        } else {
          currentResident.paymentStatus = 'pending closing';
        }

        // Update location to new resident
        location.currentResident = newClientData.name;
        location.ownerFullName = newClientData.name;
        const nameParts = newClientData.name.split(' ');
        location.ownerFirstName = nameParts[0] || '';
        location.ownerLastName = nameParts.slice(1).join(' ') || '';

        // Create new customer
        const newCustomer = {
          id: 'CUS-' + String(Date.now()).slice(-6),
          name: newClientData.name,
          email: newClientData.email,
          phone: newClientData.phone,
          address: location.address,
          accountNumber: 'CUS-' + String(Date.now()).slice(-6),
          currentBill: sewerCharge,
          pastDue: 0,
          lastPayment: 'Never',
          paymentHistory: [],
          needsPasswordChange: true,
          createdDate: new Date().toISOString(),
          entityType: newClientData.entityType || '',
          ssn: newClientData.ssn || '',
          idType: newClientData.idType || '',
          idNumber: newClientData.idNumber || '',
          secondaryContactName: newClientData.secondaryContactName || '',
          secondaryContactPhone: newClientData.secondaryContactPhone || '',
          mailingAddress: newClientData.mailingAddress || '',
          mailingStreet: newClientData.mailingStreet || '',
          mailingCity: newClientData.mailingCity || '',
          mailingState: newClientData.mailingState || '',
          mailingZip: newClientData.mailingZip || '',
          codes: newClientData.codes || [],
          factor: newClientData.factor || '',
          cycleNumber: newClientData.cycleNumber || null
        };

        // Update payment status for new customer
        updateCustomerPaymentStatus(newCustomer);

        // Add new customer
        customers.push(newCustomer);
        filteredCustomers = [...customers];

        // Save to Firestore
        await saveCustomersToFirestore();
        await saveLocationsToFirestore();

        // Update displays
        updateDashboard();
        updateSettingsCustomerTable();

        // Hide modal and show success
        hideTransferOwnershipModal();
        showClientSuccessScreen();

      } catch (error) {

        alert('Error processing transfer: ' + error.message);
      }
    };

    // Show add location modal
    window.showAddLocationModal = function() {
      // Generate a random 6-digit number for Premise ID
      const premiseId = Math.floor(100000 + Math.random() * 900000).toString();
      document.getElementById('newLocationPremiseId').value = premiseId;
      document.getElementById('addLocationModal').classList.remove('hidden');
    };

    // User management helpers
    window.showAddUserModal = function() {
      document.getElementById('newUserFullName').value = '';
      document.getElementById('newUserCode').value = '';
      const titleSelect = document.getElementById('newUserTitle');
      if (titleSelect) titleSelect.value = '';
      document.getElementById('addUserModal').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('newUserFullName').focus();
      }, 50);
    };

    window.hideAddUserModal = function() {
      document.getElementById('addUserModal').classList.add('hidden');
      document.getElementById('newUserFullName').value = '';
      document.getElementById('newUserCode').value = '';
      const titleSelect = document.getElementById('newUserTitle');
      if (titleSelect) titleSelect.value = '';
    };

    // Hide add location modal
    window.hideAddLocationModal = function() {
      document.getElementById('addLocationModal').classList.add('hidden');
      document.getElementById('addLocationForm').reset();
    };

    // Show add code modal
    window.showAddCodeModal = function() {
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
      document.getElementById('addCodeModal').classList.remove('hidden');
    };

    // Hide add code modal
    window.hideAddCodeModal = function() {
      document.getElementById('addCodeModal').classList.add('hidden');
      document.getElementById('addCodeForm').reset();
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
    };

    // Global variable to store selected requirements for new code
    // Structure: { type: "AND" | "OR", values: ["Business", "Individual"] }
    window.selectedCodeRequirements = null;

    // Update requirements list display
    window.updateCodeRequirementsList = function() {
      const listContainer = document.getElementById('newCodeRequirementsList');
      if (!listContainer) return;

      listContainer.innerHTML = '';

      if (!window.selectedCodeRequirements || window.selectedCodeRequirements.values.length === 0) {
        return;
      }

      const requirementDiv = document.createElement('div');
      requirementDiv.className = 'flex items-center justify-between bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg';

      const valuesText = window.selectedCodeRequirements.values.join(` ${window.selectedCodeRequirements.type} `);
      requirementDiv.innerHTML = `
        <span class="text-sm text-slate-800 dark:text-slate-200">${valuesText}</span>
        <button 
          type="button"
          onclick="removeCodeRequirement()" 
          class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 ml-2"
        >
          ×
        </button>
      `;
      listContainer.appendChild(requirementDiv);
    };

    // Show add requirement modal
    window.showAddRequirementModal = function() {
      document.getElementById('addRequirementModal').classList.remove('hidden');
    };

    // Hide add requirement modal
    window.hideAddRequirementModal = function() {
      document.getElementById('addRequirementModal').classList.add('hidden');
      // Reset checkboxes and radio buttons
      document.getElementById('requirementBusiness').checked = false;
      document.getElementById('requirementIndividual').checked = false;
      document.getElementById('requirementLogicAND').checked = true; // Default to AND
      document.getElementById('requirementLogicOR').checked = false;
    };

    // Add requirement to list
    window.addRequirement = function() {
      const businessChecked = document.getElementById('requirementBusiness').checked;
      const individualChecked = document.getElementById('requirementIndividual').checked;
      const logicType = document.getElementById('requirementLogicAND').checked ? 'AND' : 'OR';

      if (!businessChecked && !individualChecked) {
        alert('Please select at least one requirement');
        return;
      }

      const selectedValues = [];
      if (businessChecked) {
        selectedValues.push('Business');
      }
      if (individualChecked) {
        selectedValues.push('Individual');
      }

      window.selectedCodeRequirements = {
        type: logicType,
        values: selectedValues
      };

      updateCodeRequirementsList();
      hideAddRequirementModal();
    };

    // Remove requirement from list
    window.removeCodeRequirement = function() {
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
    };

    // Update code amount input based on type
    window.updateCodeAmountInput = function() {
      const type = document.getElementById('newCodeType').value;
      const amountInput = document.getElementById('newCodeAmount');

      if (type === 'percentage') {
        amountInput.max = '100';
        amountInput.placeholder = 'Enter percentage (0-100)';
      } else {
        amountInput.removeAttribute('max');
        amountInput.placeholder = 'Enter dollar amount';
      }
    };

    // Add new code
    window.addCode = async function() {
      const name = document.getElementById('newCodeName').value.trim();
      const type = document.getElementById('newCodeType').value;
      const amount = parseFloat(document.getElementById('newCodeAmount').value);
      const description = document.getElementById('newCodeDescription').value.trim() || '';

      if (!name || isNaN(amount) || amount < 0) {
        alert('Please enter a valid code name and amount');
        return;
      }

      if (type === 'percentage' && amount > 100) {
        alert('Percentage cannot exceed 100%');
        return;
      }

      const newCode = {
        id: `CODE-${String(Date.now()).slice(-6)}`,
        name: name,
        type: type,
        amount: amount,
        percentage: type === 'percentage' ? amount : undefined, // Keep for backward compatibility
        description: description,
        requirements: window.selectedCodeRequirements ? { ...window.selectedCodeRequirements } : null
      };

      codes.push(newCode);
      await saveCodesToFirestore();
      updateCodesTable();
      hideAddCodeModal();

      // Reset form
      document.getElementById('newCodeName').value = '';
      document.getElementById('newCodeType').value = 'percentage';
      document.getElementById('newCodeAmount').value = '';
      document.getElementById('newCodeDescription').value = '';
      updateCodeAmountInput();

      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();

      alert('Code added successfully!');
    };

    // Save edit code field
    window.saveEditCodeField = async function() {
      const codeId = document.getElementById('editCodeFieldCodeId').value;
      const fieldType = document.getElementById('editCodeFieldFieldType').value;
      const newValue = document.getElementById('editCodeFieldValue').value;

      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      if (fieldType === 'type') {
        const newType = newValue;
        code.type = newType;
        // If switching types, preserve amount value
        if (!code.amount && code.percentage !== undefined) {
          code.amount = code.percentage;
        }
        if (newType === 'percentage' && code.amount > 100) {
          code.amount = 100;
        }
      }

      await saveCodesToFirestore();
      updateCodesTable();
      cancelEditCodeField();
    };

    // Cancel edit code field
    window.cancelEditCodeField = function() {
      document.getElementById('editCodeFieldModal').classList.add('hidden');
      document.getElementById('editCodeFieldInputContainer').innerHTML = '';
    };

    // Apply code to all customers
    window.applyCodeToAll = async function(codeId) {
      const code = codes.find(c => c.id === codeId);
      if (!code) {
        alert('Code not found');
        return;
      }

      const codeType = code.type || 'percentage';
      const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
      const codeDisplay = codeType === 'flat' 
        ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
        : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;

      if (!confirm(`Are you sure you want to apply "${codeDisplay}" to ALL ${customers.length} customer accounts?\n\nThis will add this code to all customers who don't already have it.`)) {
        return;
      }

      try {
        let updatedCount = 0;
        let skippedCount = 0;

        // Apply code to all customers
        customers.forEach(customer => {
          // Initialize codes array if it doesn't exist
          if (!customer.codes) {
            customer.codes = [];
          }

          // Check if customer already has this code
          const hasCode = customer.codes.some(c => c.id === codeId);

          if (!hasCode) {
            // Add the code to the customer
            customer.codes.push({
              id: code.id,
              name: code.name,
              type: code.type || 'percentage',
              amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
              percentage: codeType === 'percentage' && code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0)
            });
            updatedCount++;
          } else {
            skippedCount++;
          }
        });

        // Save all customers to Firestore
        await saveCustomersToFirestore();

        // Update tables
        updateCustomerTable();
        updateSettingsCustomerTable();

        alert(`Successfully applied "${codeDisplay}" to ${updatedCount} customer(s).\n${skippedCount} customer(s) already had this code.`);
      } catch (error) {

        alert('Error applying code to all customers: ' + error.message);
      }
    };

    // Delete code
    window.deleteCode = async function(codeId) {
      const code = codes.find(c => c.id === codeId);
      if (!code) {
        alert('Code not found');
        return;
      }

      const codeType = code.type || 'percentage';
      const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
      const codeDisplay = codeType === 'flat' 
        ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
        : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;

      // Count how many customers have this code
      let customersWithCode = 0;
      customers.forEach(customer => {
        if (customer.codes && customer.codes.some(c => c.id === codeId)) {
          customersWithCode++;
        }
      });

      const confirmMessage = customersWithCode > 0
        ? `Are you sure you want to delete "${codeDisplay}"?\n\nThis will remove it from ${customersWithCode} customer account(s) as well.`
        : `Are you sure you want to delete "${codeDisplay}"?`;

      if (confirm(confirmMessage)) {
        try {
          // First, explicitly delete the document from Firestore
          const codesRef = collection(db, 'codes');
          const codeRef = doc(codesRef, codeId);
          await deleteDoc(codeRef);

          // Add code name to deleted set to prevent recreation
          deletedCodeNames.add(code.name.toLowerCase());

          // Save deleted code names to Firestore for persistence across reloads
          const deletedCodesRef = doc(db, 'settings', 'deletedCodeNames');
          await setDoc(deletedCodesRef, { 
            names: Array.from(deletedCodeNames),
            lastUpdated: new Date().toISOString()
          });

          // Then remove it from the local array
        codes = codes.filter(c => c.id !== codeId);

          // Remove the code from all customers who have it
          let updatedCustomers = 0;
          customers.forEach(customer => {
            let customerUpdated = false;

            // Remove from customer.codes array
            if (customer.codes && customer.codes.length > 0) {
              const originalLength = customer.codes.length;
              customer.codes = customer.codes.filter(c => c.id !== codeId);
              if (customer.codes.length < originalLength) {
                customerUpdated = true;
              }
            }

            // Also remove from importData to prevent code from being recreated on reload
            if (customer.importData) {
              const codeName = code.name;
              // Check all possible tax code fields in importData
              const taxCodeFields = [
                'Tax Codes Per Person',
                'Tax Codes per Person',
                'Tax Codes',
                'Codes Per Person',
                'Codes per Person',
                'Codes'
              ];

              taxCodeFields.forEach(field => {
                if (customer.importData[field]) {
                  const codesStr = customer.importData[field];
                  // Parse codes (comma-separated)
                  const codeNames = codesStr.split(',').map(c => c.trim());
                  // Remove the deleted code name (case-insensitive)
                  const filteredCodes = codeNames.filter(c => c.toLowerCase() !== codeName.toLowerCase());
                  // Update the field if codes were removed
                  if (filteredCodes.length < codeNames.length) {
                    customer.importData[field] = filteredCodes.join(', ');
                    customerUpdated = true;
                  }
                }
              });
            }

            if (customerUpdated) {
              updatedCustomers++;
            }
          });

          // Save all updated customers to Firestore
          if (updatedCustomers > 0) {

            await saveCustomersToFirestore();

          }

          // Update the UI
        updateCodesTable();
          updateCustomerTable();
          updateSettingsCustomerTable();

          const successMessage = updatedCustomers > 0
            ? `Code deleted successfully! Removed from ${updatedCustomers} customer account(s).`
            : 'Code deleted successfully!';
          alert(successMessage);
        } catch (error) {

          alert('Error deleting code: ' + error.message);
        }
      }
    };

    // Update sewer charge display
    function updateSewerChargeDisplay() {
      const input = document.getElementById('sewerChargeInput');
      const status = document.getElementById('sewerChargeStatus');
      if (input) {
        input.value = sewerCharge.toFixed(2);
      }
      if (status) {
        status.textContent = `Current value: $${sewerCharge.toFixed(2)}`;
      }
    }

    // Update late fee display
    function updateLateFeeDisplay() {
      const input = document.getElementById('lateFeeInput');
      const status = document.getElementById('lateFeeStatus');
      if (input) {
        input.value = lateFee.toFixed(2);
      }
      if (status) {
        status.textContent = `Current value: $${lateFee.toFixed(2)}`;
      }
    }

    // Update PUC Surcharge display
    function updatePucSurchargeDisplay() {
      const input = document.getElementById('pucSurchargeInput');
      const status = document.getElementById('pucSurchargeStatus');
      if (input) {
        input.value = pucSurcharge.toFixed(2);
      }
      if (status) {
        status.textContent = `Current value: ${pucSurcharge.toFixed(2)}%`;
      }
    }

    // Save late fee
    window.saveLateFee = async function() {
      const input = document.getElementById('lateFeeInput');
      const status = document.getElementById('lateFeeStatus');

      if (!input) return;

      const newValue = parseFloat(input.value);

      if (isNaN(newValue) || newValue < 0) {
        if (status) {
          status.textContent = 'Please enter a valid amount (must be 0 or greater)';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
        return;
      }

      const oldValue = lateFee;
      lateFee = newValue;

      try {
        await saveLateFeeToFirestore();
        if (status) {
          status.textContent = 'Late fee saved successfully!';
          status.className = 'text-xs text-green-500 dark:text-green-400';
        }

        // Clear status message after 3 seconds
        setTimeout(() => {
          if (status) {
            status.textContent = `Current value: $${lateFee.toFixed(2)}`;
            status.className = 'text-xs text-slate-500 dark:text-slate-400';
          }
        }, 3000);
      } catch (error) {

        lateFee = oldValue; // Revert on error
        if (status) {
          status.textContent = 'Error saving late fee. Please try again.';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
      }
    };

    // Save PUC Surcharge
    window.savePucSurcharge = async function() {
      const input = document.getElementById('pucSurchargeInput');
      const status = document.getElementById('pucSurchargeStatus');

      if (!input) return;

      const newValue = parseFloat(input.value);

      if (isNaN(newValue) || newValue < 0 || newValue > 100) {
        if (status) {
          status.textContent = 'Please enter a valid percentage (must be between 0 and 100)';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
        return;
      }

      const oldValue = pucSurcharge;
      pucSurcharge = newValue;

      try {
        await savePucSurchargeToFirestore();
        if (status) {
          status.textContent = 'PUC Surcharge saved successfully!';
          status.className = 'text-xs text-green-500 dark:text-green-400';
        }

        // Update all customer tables to reflect the change
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Clear status message after 3 seconds
        setTimeout(() => {
          if (status) {
            status.textContent = `Current value: ${pucSurcharge.toFixed(2)}%`;
            status.className = 'text-xs text-slate-500 dark:text-slate-400';
          }
        }, 3000);
      } catch (error) {

        pucSurcharge = oldValue; // Revert on error
        if (status) {
          status.textContent = 'Error saving PUC surcharge. Please try again.';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
      }
    };

    // Save sewer charge
    window.saveSewerCharge = async function() {
      const input = document.getElementById('sewerChargeInput');
      const status = document.getElementById('sewerChargeStatus');

      if (!input) return;

      const newValue = parseFloat(input.value);

      if (isNaN(newValue) || newValue < 0) {
        if (status) {
          status.textContent = 'Please enter a valid amount (must be 0 or greater)';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
        return;
      }

      const oldValue = sewerCharge;
      sewerCharge = newValue;

      try {
        await saveSewerChargeToFirestore();
        if (status) {
          status.textContent = 'Sewer charge saved successfully!';
          status.className = 'text-xs text-green-500 dark:text-green-400';
        }

        // Update all customers' currentBill if it was set to the old value
        let needsSave = false;
        customers.forEach(customer => {
          if (customer.currentBill === oldValue) {
            customer.currentBill = sewerCharge;
            needsSave = true;
          }
        });

        if (needsSave) {
          await saveCustomersToFirestore();
        }

        // Clear status message after 3 seconds
        setTimeout(() => {
          if (status) {
            status.textContent = `Current value: $${sewerCharge.toFixed(2)}`;
            status.className = 'text-xs text-slate-500 dark:text-slate-400';
          }
        }, 3000);
      } catch (error) {

        sewerCharge = oldValue; // Revert on error
        if (status) {
          status.textContent = 'Error saving sewer charge. Please try again.';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
      }
    };

    // Edit code field
    window.editCodeField = function(codeId, fieldType, currentValue) {
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      let newValue;

      // Special handling for type field - show dropdown modal
      if (fieldType === 'type') {
        // Set up the edit modal with dropdown
        document.getElementById('editCodeFieldType').textContent = 'Type';
        document.getElementById('editCodeFieldCodeId').value = codeId;
        document.getElementById('editCodeFieldFieldType').value = 'type';

        const container = document.getElementById('editCodeFieldInputContainer');
        const currentType = currentValue || 'percentage';
        container.innerHTML = `
          <select 
            id="editCodeFieldValue" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="percentage" ${currentType === 'percentage' ? 'selected' : ''}>Percentage</option>
            <option value="flat" ${currentType === 'flat' ? 'selected' : ''}>Flat Rate</option>
          </select>
        `;

        // Show the modal
        document.getElementById('editCodeFieldModal').classList.remove('hidden');
        return;
      }

      // Special handling for amount field
      if (fieldType === 'amount') {

        const codeType = code.type || 'percentage';
        const promptText = codeType === 'flat' 
          ? `Enter new flat rate amount (dollars):` 
          : `Enter new percentage (0-100):`;
        newValue = prompt(promptText, currentValue);

        if (newValue === null) {

          return; // User cancelled
        }

        newValue = newValue.trim();
        const amount = parseFloat(newValue);

        if (isNaN(amount) || amount < 0) {

          alert('Please enter a valid amount');
          return;
        }

        if (codeType === 'percentage' && amount > 100) {

          alert('Percentage cannot exceed 100%');
          return;
        }

        // Find the code in the array by index to ensure we're updating the right object
        const codeIndex = codes.findIndex(c => c.id === codeId);
        if (codeIndex === -1) {

          alert('Error: Code not found in array');
          return;
        }

        // Update the code object in the array directly
        codes[codeIndex].amount = amount;
        if (codeType === 'percentage') {
          codes[codeIndex].percentage = amount; // Keep for backward compatibility
        }

        // Also update the local code variable for consistency
        code.amount = amount;
        if (codeType === 'percentage') {
          code.percentage = amount;
        }

        // Update table immediately to show the change
        updateCodesTable();

        // Save to Firestore asynchronously

        saveCodesToFirestore()
          .then(() => {

          })
          .catch(error => {

            alert('Error saving code amount to database. The change may not persist after reload.');
            // Reload codes from Firestore to restore correct state
            loadCodesFromFirestore();
          });
        return;
      }

      // Standard prompt for other fields
      newValue = prompt(`Enter new ${fieldType}:`, currentValue);

      if (newValue === null) return; // User cancelled

      newValue = newValue.trim();

      // Validation
      if (fieldType === 'name') {
        if (!newValue) {
          alert('Code name cannot be empty');
          return;
        }
        code.name = newValue;
      } else if (fieldType === 'description') {
        code.description = newValue || '';
      }

      // Save to Firestore and update table
      saveCodesToFirestore().then(() => {
        updateCodesTable();

        // Update code references in all customers if name changed
        if (fieldType === 'name') {
          customers.forEach(customer => {
            if (customer.codes && customer.codes.length > 0) {
              customer.codes.forEach(c => {
                if (c.id === codeId) {
                  c.name = newValue;
                }
              });
            }
          });
          saveCustomersToFirestore();
          updateCustomerTable();
          updateSettingsCustomerTable();
        }
      });
    };

    // Add new location
    window.addLocation = async function() {
      const street = document.getElementById('newLocationStreet').value;
      const city = document.getElementById('newLocationCity').value;
      const state = document.getElementById('newLocationState').value;
      const zip = document.getElementById('newLocationZip').value;
      const premiseId = document.getElementById('newLocationPremiseId').value;

      if (!street || !city || !state || !zip || !premiseId) {
        alert('Please fill in all fields');
        return;
      }

      const fullAddress = `${street}, ${city}, ${state} ${zip}`;

      const newLocation = {
        id: `LOC-${String(locations.length + 1).padStart(3, '0')}`,
        address: fullAddress,
        street: street,
        city: city,
        state: state,
        zip: zip,
        premiseId: premiseId,
        ownerFirstName: '',
        ownerLastName: '',
        ownerFullName: '',
        currentResident: null,
        status: 'available'
      };

      locations.push(newLocation);
      filteredLocations = [...locations];
      updateLocationsTable();
      updateSettingsLocationsTable();
      await saveLocationsToFirestore();
      hideAddLocationModal();

      // Update the location dropdowns and select the new location
      updateLocationDropdowns(newLocation.id);

      alert('Location added successfully!');
    };

    window.addUser = async function() {
      const input = document.getElementById('newUserFullName');
      const fullName = input.value.trim();
      const userCodeInput = document.getElementById('newUserCode');
      const userCode = userCodeInput ? userCodeInput.value.trim() : '';
      const titleSelect = document.getElementById('newUserTitle');
      const title = titleSelect ? titleSelect.value : '';

      if (!fullName) {
        alert('Please enter the user\'s full name.');
        return;
      }

      if (!title) {
        alert('Please select a title for the user.');
        return;
      }

      // Check if a user with this code AND full name already exists (users can have same code, but not same code + name)
      if (users.some(u => 
        (u.fullName || '').toLowerCase() === fullName.toLowerCase() &&
        (u.userCode || '').toLowerCase() === (userCode || '').toLowerCase()
      )) {
        alert('A user with this full name and user code already exists. Users can share the same code, but not the same code and name combination.');
        return;
      }

      const timestamp = Date.now();
      const newUser = {
        id: `USR-${String(timestamp).slice(-6)}`,
        fullName,
        userCode: userCode || undefined,
        title: title,
        createdAt: new Date(timestamp).toISOString()
      };

      users.push(newUser);
      filteredUsers = [...users];
      updateSettingsUsersTable();
      if (typeof populateBatchStartUserSelect === 'function') {
      populateBatchStartUserSelect();
      }
      await saveUsersToFirestore();
      hideAddUserModal();
      alert('User added successfully!');
    };

    window.deleteUser = async function(userId) {
      if (!confirm('Are you sure you want to delete this user?')) {
        return;
      }

      users = users.filter(user => user.id !== userId);
      filteredUsers = [...users];
      updateSettingsUsersTable();
      if (typeof populateBatchStartUserSelect === 'function') {
      populateBatchStartUserSelect();
      }
      await saveUsersToFirestore();
      alert('User deleted successfully!');
    };

    // Edit user full name inline
    window.editUserName = function(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      const cell = document.getElementById(`user-fullname-${userId}`);
      if (!cell) return;

      const currentName = user.fullName || '';
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentName;
      input.className = 'text-sm font-medium text-slate-900 dark:text-slate-100 w-full px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800';

      const saveEdit = async () => {
        const newName = input.value.trim();
        if (newName === currentName) {
          cell.innerHTML = currentName || 'Unnamed User';
          cell.setAttribute('ondblclick', `editUserName('${userId}')`);
          cell.setAttribute('title', 'Double-click to edit');
          return;
        }

        if (!newName) {
          alert('Full name cannot be empty.');
          cell.innerHTML = currentName || 'Unnamed User';
          cell.setAttribute('ondblclick', `editUserName('${userId}')`);
          cell.setAttribute('title', 'Double-click to edit');
          return;
        }

        // Check if another user with this name AND user code exists (users can have same name, but not same code + name)
        const currentUserCode = user.userCode || '';
        if (users.some(u => 
          u.id !== userId && 
          (u.fullName || '').toLowerCase() === newName.toLowerCase() &&
          (u.userCode || '').toLowerCase() === currentUserCode.toLowerCase()
        )) {
          alert('A user with this full name and user code already exists. Users can share the same name, but not the same code and name combination.');
          cell.innerHTML = currentName || 'Unnamed User';
          cell.setAttribute('ondblclick', `editUserName('${userId}')`);
          cell.setAttribute('title', 'Double-click to edit');
          return;
        }

        user.fullName = newName;
        await saveUsersToFirestore();
        updateSettingsUsersTable();
      };

      const cancelEdit = () => {
        cell.innerHTML = currentName || 'Unnamed User';
        cell.setAttribute('ondblclick', `editUserName('${userId}')`);
        cell.setAttribute('title', 'Double-click to edit');
      };

      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });

      cell.innerHTML = '';
      cell.appendChild(input);
      input.focus();
      input.select();
    };

    // Edit user code inline
    window.editUserCode = function(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      const cell = document.getElementById(`user-usercode-${userId}`);
      if (!cell) return;

      const currentCode = user.userCode || '';
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentCode;
      input.className = 'text-sm text-slate-700 dark:text-slate-300 w-full px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800';

      const saveEdit = async () => {
        const newCode = input.value.trim();
        if (newCode === currentCode) {
          cell.innerHTML = currentCode || '—';
          cell.setAttribute('ondblclick', `editUserCode('${userId}')`);
          cell.setAttribute('title', 'Double-click to edit');
          return;
        }

        if (!newCode) {
          alert('User code cannot be empty.');
          cell.innerHTML = currentCode || '—';
          cell.setAttribute('ondblclick', `editUserCode('${userId}')`);
          cell.setAttribute('title', 'Double-click to edit');
          return;
        }

        // Check if another user with this code AND full name exists (users can have same code, but not same code + name)
        const currentFullName = user.fullName || '';
        if (users.some(u => 
          u.id !== userId && 
          u.userCode && 
          u.userCode.toLowerCase() === newCode.toLowerCase() &&
          (u.fullName || '').toLowerCase() === currentFullName.toLowerCase()
        )) {
          alert('A user with this code and full name already exists. Users can share the same code, but not the same code and name combination.');
          cell.innerHTML = currentCode || '—';
          cell.setAttribute('ondblclick', `editUserCode('${userId}')`);
          cell.setAttribute('title', 'Double-click to edit');
          return;
        }

        user.userCode = newCode;
        await saveUsersToFirestore();
        updateSettingsUsersTable();
      };

      const cancelEdit = () => {
        cell.innerHTML = currentCode || '—';
        cell.setAttribute('ondblclick', `editUserCode('${userId}')`);
        cell.setAttribute('title', 'Double-click to edit');
      };

      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });

      cell.innerHTML = '';
      cell.appendChild(input);
      input.focus();
      input.select();
    };

    // Edit user title inline
    window.editUserTitle = function(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      const cell = document.getElementById(`user-title-${userId}`);
      if (!cell) return;

      const currentTitle = user.title || '';
      const validTitles = ['Admin', 'Supervisor', 'Point Of Sale', 'Helpdesk'];

      const select = document.createElement('select');
      select.className = 'text-sm text-slate-700 dark:text-slate-300 w-full px-2 py-1 border border-blue-500 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800';

      // Add options
      validTitles.forEach(title => {
        const option = document.createElement('option');
        option.value = title;
        option.textContent = title;
        if (title === currentTitle) {
          option.selected = true;
        }
        select.appendChild(option);
      });

      const saveEdit = async () => {
        const newTitle = select.value;
        if (newTitle === currentTitle) {
          cell.innerHTML = newTitle || '—';
          cell.setAttribute('ondblclick', `editUserTitle('${userId}')`);
          cell.setAttribute('title', 'Double-click to edit');
          return;
        }

        user.title = newTitle;
        await saveUsersToFirestore();
        updateSettingsUsersTable();
      };

      const cancelEdit = () => {
        cell.innerHTML = currentTitle || '—';
        cell.setAttribute('ondblclick', `editUserTitle('${userId}')`);
        cell.setAttribute('title', 'Double-click to edit');
      };

      select.addEventListener('blur', saveEdit);
      select.addEventListener('change', saveEdit);
      select.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });

      cell.innerHTML = '';
      cell.appendChild(select);
      select.focus();
    };

    // Update location dropdowns and select the new location
    function updateLocationDropdowns(selectedLocationId) {
      // Update Add Client Module dropdown
      const addClientSelect = document.getElementById('newClientLocation');
      if (addClientSelect) {
        populateAddClientLocationSelect();
        addClientSelect.value = selectedLocationId;
      }

      // Update Add Customer Modal dropdown
      const addCustomerSelect = document.getElementById('newCustomerLocation');
      if (addCustomerSelect) {
        // Repopulate the dropdown
        addCustomerSelect.innerHTML = '<option value="">Select a property location</option>';
        locations.forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = `${location.address} (${location.status})`;
          addCustomerSelect.appendChild(option);
        });
        addCustomerSelect.value = selectedLocationId;
      }
    }

    // Show import modal
    window.showImportModal = function() {
      document.getElementById('importModal').classList.remove('hidden');
    };

    // Hide import modal
    window.hideImportModal = function() {
      document.getElementById('importModal').classList.add('hidden');
      document.getElementById('locationFileInput').value = '';
    };

    // Show import customer data modal
    window.showImportCustomerDataModal = function() {

      try {
        const modal = document.getElementById('importCustomerDataModal');
        if (!modal) {

          alert('Error: Import modal not found. Please refresh the page.');
          return;
        }

        modal.classList.remove('hidden');
        // Add file input listener for preview
        const fileInput = document.getElementById('customerDataFileInput');
        if (fileInput) {
          fileInput.onchange = function() {
            previewExcelFile(this.files[0]);
          };
        } else {

        }
      } catch (error) {

        alert('Error opening import dialog: ' + error.message);
      }
    };

    // Hide import customer data modal
    window.hideImportCustomerDataModal = function() {
      document.getElementById('importCustomerDataModal').classList.add('hidden');
      document.getElementById('customerDataFileInput').value = '';
      document.getElementById('importPreview').classList.add('hidden');
    };

    // Preview Excel file
    function previewExcelFile(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (jsonData.length === 0) {
            alert('Excel file is empty');
            return;
          }

          // Show preview
          const previewDiv = document.getElementById('importPreview');
          const previewTable = document.getElementById('previewTable');
          const thead = previewTable.querySelector('thead');
          const tbody = previewTable.querySelector('tbody');

          // Clear previous content
          thead.innerHTML = '';
          tbody.innerHTML = '';

          // Add headers
          const headerRow = document.createElement('tr');
          if (jsonData[0]) {
            jsonData[0].forEach(header => {
              const th = document.createElement('th');
              th.className = 'px-4 py-2 text-left border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300';
              th.textContent = header || '';
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
          }

          // Add first 5 data rows
          const previewRows = jsonData.slice(1, 6);
          previewRows.forEach(row => {
            const tr = document.createElement('tr');
            jsonData[0].forEach((_, colIndex) => {
              const td = document.createElement('td');
              td.className = 'px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-400';
              td.textContent = row[colIndex] || '';
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });

          previewDiv.classList.remove('hidden');
        } catch (error) {

          alert('Error reading Excel file: ' + error.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Import customer data from Excel
    // Helper function to combine PremiseAddress, PremiseStreet, and PremiseApt
    // Example: PremiseAddress="20120" + PremiseStreet="ANZA DR" = "20120 ANZA DR"
    function combinePropertyAddress(rowData) {
      const premiseAddress = String(rowData['PremiseAddress'] || '').trim();
      const premiseStreet = String(rowData['PremiseStreet'] || '').trim();
      const premiseApt = String(rowData['PremiseApt'] || '').trim();

      // Build address parts array
      const addressParts = [];

      // Add PremiseAddress if it exists
      if (premiseAddress) {
        addressParts.push(premiseAddress);
      }

      // Add PremiseStreet if it exists
      if (premiseStreet) {
        addressParts.push(premiseStreet);
      }

      // Combine the parts
      let address = addressParts.join(' ').trim();

      // Add apartment number if it exists (only if not blank)
      if (premiseApt) {
        address = `${address} ${premiseApt}`.trim();
      }

      return address || '';
    }

    // Helper function to get the display address for a customer
    // Uses importData if available, otherwise falls back to customer.address
    function getCustomerDisplayAddress(customer) {
      // If customer has importData, use combinePropertyAddress to build the address
      if (customer.importData) {
        const combinedAddress = combinePropertyAddress(customer.importData);
        if (combinedAddress) {
          return combinedAddress;
        }
      }

      // Fall back to customer.address if no importData or combined address is empty
      return customer.address || 'N/A';
    }

    // Helper function to parse tax codes from "tax codes per person" field
    function parseTaxCodesPerPerson(taxCodesStr) {
      if (!taxCodesStr || typeof taxCodesStr !== 'string') {
        return [];
      }
      // Split by comma and trim whitespace
      return taxCodesStr.split(',').map(code => code.trim()).filter(code => code.length > 0);
    }

    // Helper function to ensure a code exists in the codes array, creating it if it doesn't
    function ensureCodeExists(codeName) {
      if (!codeName || typeof codeName !== 'string') {
        return null;
      }

      // Check if this code name was intentionally deleted - if so, don't recreate it
      if (deletedCodeNames.has(codeName.toLowerCase())) {

        return null;
      }

      // Check if code already exists (case-insensitive)
      let existingCode = codes.find(c => c.name.toLowerCase() === codeName.toLowerCase());
      if (existingCode) {
        return existingCode;
      }

      // Create new code with just the name (type, amount, description, requirements can be added later)
      // Use timestamp + random number for unique ID
      const uniqueId = `CODE-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      const newCode = {
        id: uniqueId,
        name: codeName,
        type: 'percentage', // Default to percentage
        amount: 0, // Default to 0, can be updated later
        percentage: 0, // Default to 0 for backward compatibility
        description: '', // Empty, can be added later
        requirements: null // No requirements, can be added later
      };

      codes.push(newCode);
      return newCode;
    }

    // Helper function to populate customer codes from importData
    function populateCustomerCodesFromImportData(customer) {
      if (!customer.importData) {
        return;
      }

      // Try various possible column names for "tax codes per person"
      const taxCodesStr = customer.importData['Tax Codes Per Person'] || 
                         customer.importData['Tax Codes per Person'] ||
                         customer.importData['Tax Codes'] ||
                         customer.importData['Codes Per Person'] ||
                         customer.importData['Codes per Person'] ||
                         customer.importData['Codes'] ||
                         '';

      if (!taxCodesStr) {
        return;
      }

      // Parse the tax codes
      const codeNames = parseTaxCodesPerPerson(taxCodesStr);

      // Ensure all codes exist and populate customer.codes
      customer.codes = codeNames.map(codeName => {
        const code = ensureCodeExists(codeName);
        if (code) {
          return {
            id: code.id,
            name: code.name,
            type: code.type || 'percentage',
            amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
            percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
          };
        }
        return null;
      }).filter(code => code !== null);
    }

    // Helper function to convert Excel serial date to readable date string
    function excelSerialToDate(serial) {
      // Excel serial dates start from January 1, 1900
      // But Excel incorrectly treats 1900 as a leap year, so we need to adjust
      if (typeof serial === 'number' && serial > 0 && serial < 1000000) {
        // Check if it's likely an Excel serial date (between 1 and 1,000,000)
        // Excel date range: 1 (Jan 1, 1900) to ~2958465 (Dec 31, 9999)
        // Common dates are in the 40000-50000 range for recent years
        const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899 (Excel's epoch)
        const date = new Date(excelEpoch.getTime() + (serial - 1) * 24 * 60 * 60 * 1000);

        // Check if the resulting date is reasonable (between 1900 and 2100)
        if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const day = date.getDate().toString().padStart(2, '0');
          const year = date.getFullYear().toString().slice(-2);
          return `${month}/${day}/${year}`;
        }
      }
      return serial; // Return original if not a valid date
    }

    // Fix Excel serial dates in existing customer data
    window.fixExcelDates = async function() {
      if (!confirm('This will fix Excel serial dates (like 46053) in all customers\' importData. Continue?')) {
        return;
      }

      let fixed = 0;
      let errors = 0;

      customers.forEach(customer => {
        if (!customer.importData) {
          return; // Skip customers without importData
        }

        try {
          let updated = false;
          const rowData = customer.importData;

          // Check each field in importData
          Object.keys(rowData).forEach(key => {
            const value = rowData[key];
            // Check if key contains "date" and value is a number (likely Excel serial date)
            const keyLower = String(key || '').toLowerCase();
            if ((keyLower.includes('date') || keyLower.includes('billdate')) && typeof value === 'number') {
              const convertedDate = excelSerialToDate(value);
              if (convertedDate !== value) {
                rowData[key] = convertedDate;
                updated = true;
              }
            }
          });

          if (updated) {
            customer.importData = rowData;
            fixed++;
          }
        } catch (error) {

          errors++;
        }
      });

      if (fixed > 0) {
        // Save all updated customers to Firestore
        await saveCustomersToFirestore();
        alert(`Fixed Excel dates for ${fixed} customer(s).${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
        // Refresh the display if customer data profile is open
        const modal = document.getElementById('customerDataProfileModal');
        if (modal && !modal.classList.contains('hidden')) {
          const customerId = modal.getAttribute('data-customer-id');
          if (customerId) {
            showCustomerDataProfile(customerId);
          }
        }
      } else {
        alert(`No dates needed fixing.${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
      }
    };

    // Split all accounts evenly between cycle 1 and cycle 2
    window.splitAccountsByCycle = async function() {
      if (!confirm('This will split all accounts evenly across cycles 1-10. This is for testing purposes. Continue?')) {
        return;
      }

      try {
        // Shuffle customers array to randomize assignment
        const shuffledCustomers = [...customers].sort(() => Math.random() - 0.5);
        const totalCustomers = shuffledCustomers.length;
        const cycles = 10;

        // Calculate how many customers per cycle (rounded)
        const customersPerCycle = Math.floor(totalCustomers / cycles);
        const remainder = totalCustomers % cycles;

        // Initialize cycle counters
        const cycleCounts = {};
        for (let i = 1; i <= cycles; i++) {
          cycleCounts[i] = 0;
        }

        // Assign customers evenly across cycles 1-10
        let currentIndex = 0;
        for (let cycleNum = 1; cycleNum <= cycles; cycleNum++) {
          // Calculate how many customers for this cycle
          // Distribute remainder customers across first few cycles
          const customersForThisCycle = customersPerCycle + (cycleNum <= remainder ? 1 : 0);

          // Assign customers to this cycle
          for (let i = 0; i < customersForThisCycle && currentIndex < totalCustomers; i++) {
            shuffledCustomers[currentIndex].cycleNumber = String(cycleNum);
            cycleCounts[cycleNum]++;
            currentIndex++;
          }
        }

        // Save all updated customers to Firestore
        await saveCustomersToFirestore();

        // Build success message showing distribution
        let message = `Successfully split ${totalCustomers} account(s) across 10 cycles:\n\n`;
        for (let i = 1; i <= cycles; i++) {
          message += `Cycle ${i}: ${cycleCounts[i]} account(s)\n`;
        }
        alert(message);

        // Refresh customer tables if they're visible
        updateCustomerTable();
        updateSettingsCustomerTable();
      } catch (error) {

        alert('Error splitting accounts by cycle: ' + error.message);
      }
    };

    // Fix Bill Date column specifically
    window.fixBillDates = async function() {
      if (!confirm('This will fix the "Bill Date" column in all customers\' importData. Continue?')) {
        return;
      }

      let fixed = 0;
      let errors = 0;

      customers.forEach(customer => {
        if (!customer.importData) {
          return; // Skip customers without importData
        }

        try {
          let updated = false;
          const rowData = customer.importData;

          // Look for "Bill Date" column specifically (case-insensitive)
          Object.keys(rowData).forEach(key => {
            const keyLower = String(key || '').toLowerCase().trim();
            // Match "Bill Date" exactly or variations like "BillDate", "bill date", etc.
            if ((keyLower === 'bill date' || keyLower === 'billdate' || keyLower === 'bill_date') && typeof rowData[key] === 'number') {
              const value = rowData[key];
              const convertedDate = excelSerialToDate(value);
              if (convertedDate !== value) {
                rowData[key] = convertedDate;
                updated = true;
              }
            }
          });

          if (updated) {
            customer.importData = rowData;
            fixed++;
          }
        } catch (error) {

          errors++;
        }
      });

      if (fixed > 0) {
        // Save all updated customers to Firestore
        await saveCustomersToFirestore();
        alert(`Fixed Bill Date for ${fixed} customer(s).${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
        // Refresh the display if customer data profile is open
        const modal = document.getElementById('customerDataProfileModal');
        if (modal && !modal.classList.contains('hidden')) {
          const customerId = modal.getAttribute('data-customer-id');
          if (customerId) {
            showCustomerDataProfile(customerId);
          }
        }
      } else {
        alert(`No Bill Dates needed fixing.${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
      }
    };

    // Re-sync pastDue amounts from stored importData
    window.syncPastDueFromImportData = async function() {
      if (!confirm('This will update all customers\' past due amounts from their imported Excel data. Continue?')) {
        return;
      }

      let updated = 0;
      let errors = 0;

      customers.forEach(customer => {
        if (!customer.importData) {
          return; // Skip customers without importData
        }

        try {
          const rowData = customer.importData;

          // Use the same logic as import to extract pastDue
          let pastDue = 0;
          const prevBal = rowData['PrevBal'];
          const pastDueAmount = rowData['Past Due'];
          const pastDueFlag = rowData['PastDue'];

          // Prioritize PrevBal (actual dollar amount)
          if (prevBal !== undefined && prevBal !== null && prevBal !== '') {
            const parsed = parseFloat(prevBal);
            if (!isNaN(parsed)) {
              pastDue = parsed;
            }
          } else if (pastDueAmount !== undefined && pastDueAmount !== null && pastDueAmount !== '') {
            const parsed = parseFloat(pastDueAmount);
            if (!isNaN(parsed)) {
              pastDue = parsed;
            }
          } else if (pastDueFlag !== undefined && pastDueFlag !== null && pastDueFlag !== '') {
            // Only use PastDue flag if it looks like a dollar amount (not just 1 or 0)
            const parsed = parseFloat(pastDueFlag);
            if (!isNaN(parsed) && parsed > 1) {
              pastDue = parsed;
            }
          }

          // Update customer's pastDue
          customer.pastDue = pastDue;

          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);

          updated++;
        } catch (error) {

          errors++;
        }
      });

      // Update filtered customers
      filteredCustomers = [...customers];

      // Refresh UI
      updateCustomerTable();
      updateSettingsCustomerTable();
      updateDashboard();

      // Save only this customer to Firestore
      await saveSingleCustomerToFirestore(customer);

      alert(`Sync complete! Updated ${updated} customers. ${errors > 0 ? errors + ' errors occurred.' : ''}`);
    };

    // Fix Bill Avey's incorrect credit (one-time fix for the -200 credit issue)
    window.fixBillAveyCredit = async function() {
      const customer = customers.find(c => c.id === 'CUS-3000500' || c.name === 'BILL AVEY');
      if (!customer) {
        alert('Bill Avey not found');
        return;
      }

      // If pastDue is -200, it means $200 credit was incorrectly stored
      // The correct credit should be $25.78 (overpayment of $200 - $174.22)
      // And currentMonthPaid should be $174.22
      if (customer.pastDue === -200 || customer.pastDue < -25) {
        // Calculate what it should be: -25.78 credit
        const correctCredit = 25.78;
        customer.pastDue = -correctCredit;
        customer.currentMonthPaid = 174.22;

      // Save to Firestore
        await saveSingleCustomerToFirestore(customer);

        // Refresh UI
        updateCustomerTable();
        updateSettingsCustomerTable();
        updateDashboard();

        alert('Bill Avey\'s credit has been fixed! Credit is now $25.78 and currentMonthPaid is $174.22.');
      } else {
        alert('Bill Avey\'s credit appears to be correct already.');
      }
    };

    // Reset all credits (set pastDue to 0 for accounts with pastDue < 0)
    window.resetCredits = async function() {
      if (!confirm('This will reset all accounts with credits (negative pastDue amounts) to have pastDue = 0. This action cannot be undone. Continue?')) {
        return;
      }

      let reset = 0;
      let errors = 0;

      // Clear all submitted payment processing sessions in Firestore
      try {

        const sessionsRef = collection(db, 'paymentProcessingSessions');
        const snapshot = await getDocs(sessionsRef);

        const deletePromises = [];
        snapshot.forEach(docSnap => {

          deletePromises.push(deleteDoc(doc(sessionsRef, docSnap.id)));
        });
        await Promise.all(deletePromises);

      } catch (error) {

      }

      customers.forEach(customer => {
        try {
          const pastDue = parseFloat(customer.pastDue || 0);

          // Only reset if pastDue is negative (credit)
          if (pastDue < 0) {

            customer.pastDue = 0;
            // Also reset currentMonthPaid since credits are being cleared
            customer.currentMonthPaid = 0;
            customer.currentMonthPaidSewer = 0;
            customer.currentMonthPaidTaxCodes = 0;
            customer.currentMonthPaidLateFee = 0;
            customer.currentMonthPaymentHistory = [];

            // Update payment status based on new past due amount
            updateCustomerPaymentStatus(customer);

            reset++;
          }
        } catch (error) {

          errors++;
        }
      });

      if (reset > 0) {
        // Update filtered customers
        filteredCustomers = [...customers];

        // Refresh UI
        updateCustomerTable();
        updateSettingsCustomerTable();
        updateDashboard();

        // Save all updated customers to Firestore
      await saveCustomersToFirestore();

        alert(`Reset complete! Removed credits from ${reset} account(s).${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
      } else {
        alert(`No accounts with credits found.${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
      }
    };

    // Reset all payment history (clear paymentHistory and set lastPayment to 'Never')
    window.resetPayments = async function() {

      if (!confirm('This will reset all customers who have past payments so the data looks like they never paid any past payments. This will clear all payment history and reset lastPayment to "Never". This will also clear the current payment processing session. This action cannot be undone. Continue?')) {

        return;
      }

      // Clear current payment processing session (shared utility + storage sync)
      if (typeof window.clearPaymentProcessingSession === 'function') {
        window.clearPaymentProcessingSession('resetPayments');
      } else {

        window.currentPaymentProcessing = null;
        try {
          localStorage.removeItem('currentPaymentProcessingSession');
          localStorage.removeItem('currentPaymentProcessing');
          localStorage.setItem('paymentProcessingResetAt', new Date().toISOString());
        } catch (e) {

        }
        if (typeof renderPaymentProcessingPreview === 'function') {
          renderPaymentProcessingPreview();
        }
      }

      // Clear submitted sessions list in UI
      if (Array.isArray(window.paymentProcessingSessions)) {

        window.paymentProcessingSessions = [];
      } else {

      }

      if (typeof renderPaymentProcessingSessionsList === 'function') {

        renderPaymentProcessingSessionsList();
      } else {

      }

      // Clear all submitted payment processing sessions in Firestore
      try {

        const sessionsRef = collection(db, 'paymentProcessingSessions');
        const snapshot = await getDocs(sessionsRef);

        const deletePromises = [];
        snapshot.forEach(docSnap => {

          deletePromises.push(deleteDoc(doc(sessionsRef, docSnap.id)));
        });
        await Promise.all(deletePromises);

      } catch (error) {

      }

      let reset = 0;
      let errors = 0;

      customers.forEach(customer => {
        try {
          // Check if customer has payment history, lastPayment, or currentMonthPaid set
          const hasPaymentHistory = customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0;
          const hasLastPayment = customer.lastPayment && customer.lastPayment !== 'Never' && customer.lastPayment !== '';
          const hasCurrentMonthPaid = customer.currentMonthPaid && parseFloat(customer.currentMonthPaid || 0) > 0;
          const hasPerCategoryPaid = (customer.currentMonthPaidSewer || 0) > 0 || 
                                     (customer.currentMonthPaidTaxCodes || 0) > 0 || 
                                     (customer.currentMonthPaidLateFee || 0) > 0;
          const hasMonthlyHistory = customer.currentMonthPaymentHistory && 
                                    Array.isArray(customer.currentMonthPaymentHistory) && 
                                    customer.currentMonthPaymentHistory.length > 0;

          // Only reset if customer has any payment data
          if (hasPaymentHistory || hasLastPayment || hasCurrentMonthPaid || hasPerCategoryPaid || hasMonthlyHistory) {

            // Clear payment history
            customer.paymentHistory = [];

            // Reset lastPayment to 'Never'
            customer.lastPayment = 'Never';

            // Reset currentMonthPaid to 0 (since payments are being cleared)
            customer.currentMonthPaid = 0;
            customer.currentMonthPaidSewer = 0;
            customer.currentMonthPaidTaxCodes = 0;
            customer.currentMonthPaidLateFee = 0;
            customer.currentMonthPaymentHistory = [];

            // Update payment status (may change if lastPayment was affecting status)
            updateCustomerPaymentStatus(customer);

            reset++;
          }
        } catch (error) {

          errors++;
        }
      });

      if (reset > 0) {
        // Update filtered customers
        filteredCustomers = [...customers];

        // Refresh UI
        updateCustomerTable();
        updateSettingsCustomerTable();
        updateDashboard();

        // Save all updated customers to Firestore
        await saveCustomersToFirestore();

        alert(`Reset complete! Cleared payment history for ${reset} customer(s) and cleared the current payment processing session.${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
      } else {

        alert(`No customers with payment history found. Payment processing session has been cleared.${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
      }

      // Reload sessions list after deletion
      if (typeof loadPaymentProcessingSessionsFromFirestore === 'function') {

        await loadPaymentProcessingSessionsFromFirestore();
      }

    };

    // Add past due amount to a specific account
    window.addPastDueAmount = async function() {
      const accountNumber = 'CUS-3000500';
      const amountToAdd = 50.00;

      if (!confirm(`This will add $${amountToAdd.toFixed(2)} to the past due amount for account ${accountNumber}. Continue?`)) {
        return;
      }

      const customer = customers.find(c => c.id === accountNumber || c.accountNumber === accountNumber);

      if (!customer) {
        alert(`Customer with account number ${accountNumber} not found.`);

        return;
      }

      try {
        // Get current past due amount
        const currentPastDue = parseFloat(customer.pastDue || 0);

        // Add the amount
        customer.pastDue = currentPastDue + amountToAdd;

        // Update payment status based on new past due amount
        updateCustomerPaymentStatus(customer);

        // Save to Firestore
        await saveSingleCustomerToFirestore(customer);

        // Update filtered customers
        filteredCustomers = [...customers];

        // Refresh UI
        updateCustomerTable();
        updateSettingsCustomerTable();
        updateDashboard();

        alert(`Successfully added $${amountToAdd.toFixed(2)} to past due amount for ${customer.name} (${accountNumber}).\nNew past due amount: $${customer.pastDue.toFixed(2)}`);

      } catch (error) {

        alert(`Error adding past due amount: ${error.message}`);
      }
    };

    window.importCustomerData = async function() {

      const fileInput = document.getElementById('customerDataFileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select an Excel file');
        return;
      }

      // Show loading indicator
      const importButton = document.querySelector('button[onclick*="importCustomerData"]');
      const originalText = importButton?.textContent || 'Import Customer Data';
      if (importButton) {
        importButton.disabled = true;
        importButton.textContent = 'Importing...';
      }

      const reader = new FileReader();

      reader.onerror = function(error) {

        alert('Error reading file. Please try again.');
        if (importButton) {
          importButton.disabled = false;
          importButton.textContent = originalText;
        }
      };

      reader.onload = async function(e) {
        try {

          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (jsonData.length < 2) {
            alert('Excel file must have at least a header row and one data row');
            if (importButton) {
              importButton.disabled = false;
              importButton.textContent = originalText;
            }
            return;
          }

          // Get headers (first row)
          const headers = jsonData[0].map(h => String(h || '').trim());

          // Find account number column index (look for variations)
          const accountColIndex = headers.findIndex(h => {
            const header = String(h || '').toLowerCase().trim();
            return /account/i.test(header) || 
                   /acct/i.test(header) || 
                   /^id$/i.test(header) || 
                   /customer.*id/i.test(header) ||
                   /account.*number/i.test(header) ||
                   /account.*num/i.test(header);
          });

          if (accountColIndex === -1) {
            alert('Could not find account number column. Please ensure your Excel file has a column for account numbers.');
            if (importButton) {
              importButton.disabled = false;
              importButton.textContent = originalText;
            }
            return;
          }

          // Show progress indicator
          const progressDiv = document.getElementById('importProgress');
          const progressText = document.getElementById('progressText');
          const progressBar = document.getElementById('progressBar');
          const progressStats = document.getElementById('progressStats');
          const previewDiv = document.getElementById('importPreview');

          // Upload progress elements
          const uploadProgressDiv = document.getElementById('uploadProgress');
          const uploadProgressText = document.getElementById('uploadProgressText');
          const uploadProgressBar = document.getElementById('uploadProgressBar');
          const uploadProgressStats = document.getElementById('uploadProgressStats');

          if (previewDiv) previewDiv.classList.add('hidden');
          if (progressDiv) progressDiv.classList.remove('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');
          const locationsUploadProgressDiv = document.getElementById('locationsUploadProgress');
          if (locationsUploadProgressDiv) locationsUploadProgressDiv.classList.add('hidden');

          const totalRows = jsonData.length - 1; // Exclude header row

          // Process each row
          let imported = 0;
          let updated = 0;
          let errors = 0;

          // Process rows in batches to allow UI updates
          const processBatch = async (startIndex, batchSize = 50) => {
            const endIndex = Math.min(startIndex + batchSize, jsonData.length);

            for (let i = startIndex; i < endIndex; i++) {
              const row = jsonData[i];
              if (!row || row.length === 0) continue;

              try {
                // Helper function to convert Excel serial date to readable date string
                const excelSerialToDate = (serial) => {
                  // Excel serial dates start from January 1, 1900
                  // But Excel incorrectly treats 1900 as a leap year, so we need to adjust
                  if (typeof serial === 'number' && serial > 0 && serial < 1000000) {
                    // Check if it's likely an Excel serial date (between 1 and 1,000,000)
                    // Excel date range: 1 (Jan 1, 1900) to ~2958465 (Dec 31, 9999)
                    // Common dates are in the 40000-50000 range for recent years
                    const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899 (Excel's epoch)
                    const date = new Date(excelEpoch.getTime() + (serial - 1) * 24 * 60 * 60 * 1000);

                    // Check if the resulting date is reasonable (between 1900 and 2100)
                    if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                      const month = (date.getMonth() + 1).toString().padStart(2, '0');
                      const day = date.getDate().toString().padStart(2, '0');
                      const year = date.getFullYear().toString().slice(-2);
                      return `${month}/${day}/${year}`;
                    }
                  }
                  return serial; // Return original if not a valid date
                };

                // Create object with all Excel data
                const rowData = {};
                headers.forEach((header, index) => {
                  const value = row[index] || '';
                  // Check if header contains "date" or "Date" and value is a number (likely Excel serial date)
                  const headerLower = String(header || '').toLowerCase();
                  if ((headerLower.includes('date') || headerLower.includes('billdate')) && typeof value === 'number') {
                    rowData[header] = excelSerialToDate(value);
                  } else {
                    rowData[header] = value;
                  }
                });

                // Get account number
                const accountNumber = String(row[accountColIndex] || '').trim();
                if (!accountNumber) {
                  errors++;
                  continue;
                }

                // Find existing customer or create new
                let customer = customers.find(c => 
                  c.accountNumber === accountNumber || c.id === accountNumber
                );

                // Build full name from FirstName/LastName or Name/Full Name
                let fullName = '';
                if (rowData['FirstName'] && rowData['LastName']) {
                  fullName = `${rowData['FirstName']} ${rowData['LastName']}`.trim();
                } else if (rowData['Name']) {
                  fullName = rowData['Name'];
                } else if (rowData['Full Name']) {
                  fullName = rowData['Full Name'];
                }

                // Get phone number from various possible columns
                const phone = rowData['HomePhone'] || rowData['WorkPhone'] || rowData['Phone'] || rowData['Phone Number'] || '';

                // Get address by combining PremiseAddress, PremiseStreet, and PremiseApt
                const address = combinePropertyAddress(rowData) || rowData['Address'] || rowData['Service Address'] || '';

                // Get amounts
                const totalDue = parseFloat(rowData['TotalDue'] || rowData['CurrDue'] || rowData['Current Bill'] || rowData['Amount Due'] || 0) || 0;
                // Handle PrevBal first (actual amount), then Past Due (amount), then PastDue (flag - ignore if it's just 1/0)
                // If PrevBal is empty/blank, treat as 0. Only use PastDue flag if it's actually a dollar amount
                let pastDue = 0;
                const prevBal = rowData['PrevBal'];
                const pastDueAmount = rowData['Past Due'];
                const pastDueFlag = rowData['PastDue'];

                // Prioritize PrevBal (actual dollar amount)
                if (prevBal !== undefined && prevBal !== null && prevBal !== '') {
                  const parsed = parseFloat(prevBal);
                  if (!isNaN(parsed)) {
                    pastDue = parsed;
                  }
                } else if (pastDueAmount !== undefined && pastDueAmount !== null && pastDueAmount !== '') {
                  const parsed = parseFloat(pastDueAmount);
                  if (!isNaN(parsed)) {
                    pastDue = parsed;
                  }
                } else if (pastDueFlag !== undefined && pastDueFlag !== null && pastDueFlag !== '') {
                  // Only use PastDue flag if it looks like a dollar amount (not just 1 or 0)
                  const parsed = parseFloat(pastDueFlag);
                  if (!isNaN(parsed) && parsed > 1) {
                    pastDue = parsed;
                  }
                  // If it's 1 or 0, treat as flag and ignore (pastDue stays 0)
                }

                if (customer) {
                  // Update existing customer - preserve existing fields, add/update importData
                  customer.importData = rowData;
                  // Update standard fields if they exist in Excel
                  if (fullName) {
                    customer.name = fullName;
                  }
                  if (rowData['Email']) {
                    customer.email = rowData['Email'] || customer.email;
                  }
                  if (phone) {
                    customer.phone = phone;
                  }
                  // Always update address with combined address from importData
                  if (address) {
                    customer.address = address;
                  }
                  if (totalDue > 0) {
                    customer.currentBill = totalDue;
                  }
                  // Always update pastDue (can be 0 to reset existing value)
                  customer.pastDue = pastDue;
                  // Populate codes from "tax codes per person" field
                  populateCustomerCodesFromImportData(customer);
                  updated++;
                } else {
                  // Create new customer
                  const customerId = accountNumber.startsWith('CUS-') ? accountNumber : 'CUS-' + accountNumber;
                  customer = {
                    id: customerId,
                    accountNumber: customerId,
                    name: fullName,
                    email: rowData['Email'] || '',
                    phone: phone,
                    address: address,
                    currentBill: totalDue,
                    pastDue: pastDue,
                    lastPayment: rowData['Last Payment'] || 'Never',
                    paymentHistory: [],
                    needsPasswordChange: true,
                    createdDate: new Date().toISOString(),
                    entityType: rowData['Entity Type'] || rowData['Type'] || '',
                    ssn: rowData['SSN'] || rowData['Social Security Number'] || '',
                    idType: rowData['ID Type'] || '',
                    idNumber: rowData['ID Number'] || '',
                    secondaryContactName: rowData['Secondary Contact Name'] || '',
                    secondaryContactPhone: rowData['Secondary Contact Number'] || '',
                    mailingAddress: rowData['Mailing Address'] || '',
                    mailingStreet: rowData['Mailing Street'] || '',
                    mailingCity: rowData['Mailing City'] || '',
                    mailingState: rowData['Mailing State'] || '',
                    mailingZip: rowData['Mailing ZIP'] || rowData['Mailing Zip'] || '',
                    codes: [],
                    factor: parseFloat(rowData['Factor'] || 1) || 1,
                    importData: rowData // Store all Excel data
                  };

                  // Populate codes from "tax codes per person" field
                  populateCustomerCodesFromImportData(customer);

                  updateCustomerPaymentStatus(customer);
                  customers.push(customer);
                  imported++;
                }

                // Create or update location from customer data
                if (address) {
                  // Get Premise ID (handle formats like "P3000500" or just "3000500")
                  let premiseId = rowData['Premise'] || rowData['PremiseId'] || rowData['Premise ID'] || '';
                  if (premiseId) {
                    premiseId = String(premiseId).trim();
                    // Remove "P" prefix if present
                    if (premiseId.startsWith('P') || premiseId.startsWith('p')) {
                      premiseId = premiseId.substring(1);
                    }
                  }

                  // Only create location if we have a premise ID
                  if (premiseId) {
                    // Check if location already exists by premiseId
                    let existingLocation = locations.find(l => l.premiseId === premiseId);

                    // Parse address into components (try to extract city, state, zip)
                    // Format is typically: "Street Address, City, State ZIP"
                    let street = address;
                    let city = '';
                    let state = '';
                    let zip = '';

                    // Try to parse address format: "123 Street, City, State ZIP"
                    const addressMatch = address.match(/^(.+?),\s*(.+?),\s*([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/i);
                    if (addressMatch) {
                      street = addressMatch[1].trim();
                      city = addressMatch[2].trim();
                      state = addressMatch[3].trim().toUpperCase();
                      zip = addressMatch[4].trim();
                    } else {
                      // Try simpler format: "Street, City, State ZIP"
                      const simpleMatch = address.match(/^(.+?),\s*(.+?),\s*(.+)$/);
                      if (simpleMatch) {
                        street = simpleMatch[1].trim();
                        const stateZip = simpleMatch[3].trim();
                        const stateZipMatch = stateZip.match(/^([A-Z]{2})\s+(.+)$/i);
                        if (stateZipMatch) {
                          city = simpleMatch[2].trim();
                          state = stateZipMatch[1].trim().toUpperCase();
                          zip = stateZipMatch[2].trim();
                        } else {
                          // Can't parse, use full address as street
                          street = address;
                        }
                      }
                    }

                    // Get owner name from FirstName/LastName
                    const ownerFirstName = rowData['FirstName'] || '';
                    const ownerLastName = rowData['LastName'] || '';
                    const ownerFullName = fullName || `${ownerFirstName} ${ownerLastName}`.trim() || 'No Owner';

                    if (existingLocation) {
                      // Update existing location
                      existingLocation.address = address;
                      existingLocation.street = street;
                      existingLocation.city = city;
                      existingLocation.state = state;
                      existingLocation.zip = zip;
                      existingLocation.ownerFirstName = ownerFirstName;
                      existingLocation.ownerLastName = ownerLastName;
                      existingLocation.ownerFullName = ownerFullName;
                      // Don't change status if it's already set, but set to "active" if it's empty or "inactive"
                      if (!existingLocation.status || existingLocation.status === 'inactive') {
                        existingLocation.status = 'active';
                      }
                    } else {
                      // Create new location
                      const newLocation = {
                        id: `LOC-${String(locations.length + 1).padStart(3, '0')}`,
                        address: address,
                        street: street,
                        city: city,
                        state: state,
                        zip: zip,
                        premiseId: premiseId,
                        ownerFirstName: ownerFirstName,
                        ownerLastName: ownerLastName,
                        ownerFullName: ownerFullName,
                        currentResident: null,
                        status: 'active'
                      };
                      locations.push(newLocation);
                    }
                  }
                }
              } catch (error) {

                errors++;
              }

              // Update progress every row (i is the current index, so processed = i - 1 to account for header)
              const processed = i; // i is the current row index (1-based for data rows)
              const percent = Math.min(Math.round((processed / totalRows) * 100), 100);

              if (progressText) {
                progressText.textContent = `${processed} / ${totalRows}`;
              }
              if (progressBar) {
                progressBar.style.width = percent + '%';
              }
              if (progressStats) {
                progressStats.textContent = `Imported: ${imported} | Updated: ${updated} | Errors: ${errors}`;
              }
            }

            // If there are more rows to process, continue with next batch
            if (endIndex < jsonData.length) {
              // Use setTimeout to allow UI to update
              await new Promise(resolve => setTimeout(resolve, 0));
              return processBatch(endIndex, batchSize);
            }

            // Final progress update to ensure 100%
            if (progressText) {
              progressText.textContent = `${totalRows} / ${totalRows}`;
            }
            if (progressBar) {
              progressBar.style.width = '100%';
            }
          };

          // Start processing batches

          await processBatch(1, 50);

          // Update filtered customers first to get accurate count

          filteredCustomers = [...customers];

          // Show upload progress bar with initial values
          if (uploadProgressDiv) {
            uploadProgressDiv.classList.remove('hidden');
          }
          const totalCustomers = customers.length;
          if (uploadProgressText) {
            uploadProgressText.textContent = `0 / ${totalCustomers}`;
          }
          if (uploadProgressBar) {
            uploadProgressBar.style.width = '0%';
          }
          if (uploadProgressStats) {
            uploadProgressStats.textContent = `Uploading... (0 of ${totalCustomers} customers)`;
          }

          // Create progress callback for Firestore upload
          const uploadProgressCallback = (saved, total, percent) => {
            if (uploadProgressText) {
              uploadProgressText.textContent = `${saved} / ${total}`;
            }
            if (uploadProgressBar) {
              uploadProgressBar.style.width = percent + '%';
            }
            if (uploadProgressStats) {
              uploadProgressStats.textContent = `Uploaded: ${saved} of ${total} customers`;
            }
          };

          await saveAllCustomersToFirestore(uploadProgressCallback);

          // Save codes to Firestore if any new codes were added
          if (codes.length > 0) {

            await saveCodesToFirestore();

          }

          // Save locations to Firestore if any locations were created/updated
          if (locations.length > 0) {

            // Show locations upload progress
            const locationsProgressDiv = document.getElementById('locationsUploadProgress');
            const locationsUploadProgressText = document.getElementById('locationsUploadProgressText');
            const locationsUploadProgressBar = document.getElementById('locationsUploadProgressBar');
            const locationsUploadProgressStats = document.getElementById('locationsUploadProgressStats');

            if (locationsProgressDiv) {
              locationsProgressDiv.classList.remove('hidden');
            }

            const totalLocations = locations.length;
            if (locationsUploadProgressText) {
              locationsUploadProgressText.textContent = `0 / ${totalLocations}`;
            }
            if (locationsUploadProgressBar) {
              locationsUploadProgressBar.style.width = '0%';
            }
            if (locationsUploadProgressStats) {
              locationsUploadProgressStats.textContent = `Uploading... (0 of ${totalLocations} locations)`;
            }

            // Create progress callback for locations upload
            const locationsUploadProgressCallback = (saved, total, percent) => {
              if (locationsUploadProgressText) {
                locationsUploadProgressText.textContent = `${saved} / ${total}`;
              }
              if (locationsUploadProgressBar) {
                locationsUploadProgressBar.style.width = percent + '%';
              }
              if (locationsUploadProgressStats) {
                locationsUploadProgressStats.textContent = `Uploaded: ${saved} of ${total} locations`;
              }
            };

            filteredLocations = [...locations];
            updateLocationsTable();
            updateSettingsLocationsTable();
            await saveLocationsToFirestore(locationsUploadProgressCallback);

            // Update progress to 100%
            if (locationsUploadProgressText) {
              locationsUploadProgressText.textContent = `${totalLocations} / ${totalLocations}`;
            }
            if (locationsUploadProgressBar) {
              locationsUploadProgressBar.style.width = '100%';
            }
            if (locationsUploadProgressStats) {
              locationsUploadProgressStats.textContent = `Uploaded: ${totalLocations} of ${totalLocations} locations`;
            }
          }

          updateCustomerTable();
          updateSettingsCustomerTable();
          updateCodesTable();
          updateDashboard();

          // Hide progress indicators
          if (progressDiv) progressDiv.classList.add('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');
          const locationsUploadProgressDivHide = document.getElementById('locationsUploadProgress');
          if (locationsUploadProgressDivHide) locationsUploadProgressDivHide.classList.add('hidden');

          // Show success message
          const totalProcessed = imported + updated;

          // Re-enable button
          if (importButton) {
            importButton.disabled = false;
            importButton.textContent = originalText;
          }

          // Close modal first
          hideImportCustomerDataModal();

          // Show completion alert
          alert('Import is all done');
        } catch (error) {

          alert('Error importing Excel file: ' + error.message);

          // Hide progress indicators on error
          const progressDiv = document.getElementById('importProgress');
          const uploadProgressDiv = document.getElementById('uploadProgress');
          if (progressDiv) progressDiv.classList.add('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');

          // Re-enable button on error
          if (importButton) {
            importButton.disabled = false;
            importButton.textContent = originalText;
          }
        }
      };

      try {
        reader.readAsArrayBuffer(file);
      } catch (error) {

        alert('Error reading file: ' + error.message);
        if (importButton) {
          importButton.disabled = false;
          importButton.textContent = originalText;
        }
      }
    };

    // Show payment details modal
    window.showPaymentDetailsModal = function() {
      const selectedCustomerId = window.selectedCustomerIdForPayment;
      if (!selectedCustomerId) {
        alert('Please select a customer first');
        return;
      }
      // Use the same detailed breakdown modal as the bill module
      showAmountDetails(selectedCustomerId);
    };

    // Hide payment details modal
    window.hidePaymentDetailsModal = function() {
      document.getElementById('paymentDetailsModal').classList.add('hidden');
    };

    // Edit location
    window.editLocation = function(locationId) {
      const location = locations.find(l => l.id === locationId);
      if (location) {
        const newAddress = prompt('Enter new address:', location.address);
        const newType = prompt('Enter property type:', location.propertyType);

        if (newAddress && newType) {
          location.address = newAddress;
          location.propertyType = newType;
          updateLocationsTable();
          alert('Location updated successfully!');
        }
      }
    };

    // Delete location
    window.deleteLocation = async function(locationId) {
      if (confirm('Are you sure you want to delete this location?')) {
        locations = locations.filter(l => l.id !== locationId);
        filteredLocations = [...locations];
        updateLocationsTable();
        updateSettingsLocationsTable(); // Update settings table as well
        await saveLocationsToFirestore();
        alert('Location deleted successfully!');
      }
    };

    // Inline editing functionality
    window.editField = function(locationId, fieldType, currentValue) {
      const location = locations.find(l => l.id === locationId);
      const customer = customers.find(c => c.id === locationId);
      if (!location && !customer) return;

      // Set up the edit modal
      document.getElementById('editFieldType').textContent = fieldType.charAt(0).toUpperCase() + fieldType.slice(1);
      document.getElementById('editFieldLocationId').value = locationId;
      document.getElementById('editFieldFieldType').value = fieldType;

      // Check if this is a status field that should use a dropdown
      const container = document.getElementById('editFieldInputContainer');
      if (fieldType === 'paymentStatus') {
        // Create dropdown for payment status
        container.innerHTML = `
          <select 
            id="editFieldValue" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="current" ${currentValue === 'current' ? 'selected' : ''}>Current</option>
            <option value="overdue" ${currentValue === 'overdue' ? 'selected' : ''}>Overdue</option>
            <option value="inactive" ${currentValue === 'inactive' ? 'selected' : ''}>Inactive</option>
            <option value="pending closing" ${currentValue === 'pending closing' ? 'selected' : ''}>Pending Closing</option>
          </select>
        `;
      } else {
        // Use regular input for other fields
        container.innerHTML = `
          <input 
            id="editFieldValue" 
            type="text" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Enter new value"
            value="${currentValue}"
            required
          />
        `;
      }

      // Show the modal
      document.getElementById('editFieldModal').classList.remove('hidden');
    };

    // Save field edit
    window.saveFieldEdit = async function() {
      const locationId = document.getElementById('editFieldLocationId').value;
      const fieldType = document.getElementById('editFieldFieldType').value;
      const newValue = document.getElementById('editFieldValue').value.trim();

      if (!newValue) {
        alert('Please enter a value');
        return;
      }

      // Check if this is a customer or location field
      const customer = customers.find(c => c.id === locationId);
      const location = locations.find(l => l.id === locationId);

      if (customer) {
        // Update customer field
        if (fieldType === 'accountNumber') {
          customer.accountNumber = newValue;
        } else if (fieldType === 'name') {
          customer.name = newValue;
        } else if (fieldType === 'email') {
          customer.email = newValue;
        } else if (fieldType === 'phone') {
          customer.phone = newValue;
        } else if (fieldType === 'address') {
          customer.address = newValue;
        } else if (fieldType === 'paymentStatus') {
          customer.paymentStatus = newValue;
          // Note: Status will be automatically updated based on pastDue amount
        } else if (fieldType === 'dueDate') {
          customer.dueDate = newValue;
        } else if (fieldType === 'lastPayment') {
          customer.lastPayment = newValue;
        } else if (fieldType === 'factor') {
          // Validate factor is a valid number
          const factorValue = parseFloat(newValue);
          if (isNaN(factorValue) || factorValue < 0) {
            alert('Please enter a valid factor (must be a positive number)');
            return;
          }
          customer.factor = newValue;
        } else if (fieldType === 'pastDue') {
          // Validate pastDue is a valid number
          const pastDueValue = parseFloat(newValue);
          if (isNaN(pastDueValue) || pastDueValue < 0) {
            alert('Please enter a valid past due amount (must be a positive number)');
            return;
          }
          customer.pastDue = pastDueValue;
          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);
        }

        // Update filtered customers
        const filteredIndex = filteredCustomers.findIndex(c => c.id === locationId);
        if (filteredIndex !== -1) {
          filteredCustomers[filteredIndex] = customer;
        }

        // Refresh customer table
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Refresh Customer Information modal if it's open for this customer
        const customerFullInfoModal = document.getElementById('customerFullInfoModal');
        if (!customerFullInfoModal.classList.contains('hidden')) {
          // Check if the modal is showing this customer
          const content = document.getElementById('customerFullInfoContent');
          if (content && content.innerHTML.includes(customer.id)) {
            showCustomerFullInfo(locationId);
          }
        }

        // Refresh Amount Breakdown modal if it's open for this customer
        const amountDetailsModal = document.getElementById('amountDetailsModal');
        if (!amountDetailsModal.classList.contains('hidden')) {
          // Check if the modal is showing this customer
          const customerName = document.getElementById('amountDetailsCustomer');
          if (customerName && customerName.textContent === customer.name) {
            showAmountDetails(locationId);
          }
        }

        // Save to Firestore
        await saveCustomersToFirestore();
      } else if (location) {
        // Update location field
        if (fieldType === 'address') {
          location.address = newValue;
        } else if (fieldType === 'ownerFullName') {
          location.ownerFullName = newValue;
          // Split the name into first and last name
          const nameParts = newValue.split(' ');
          location.ownerFirstName = nameParts[0] || '';
          location.ownerLastName = nameParts.slice(1).join(' ') || '';
        } else if (fieldType === 'currentResident') {
          location.currentResident = newValue === 'Available' ? null : newValue;
          location.status = newValue === 'Available' ? 'available' : 'occupied';
        } else if (fieldType === 'status') {
          location.status = newValue;
        }

        // Update filtered locations
        const filteredIndex = filteredLocations.findIndex(l => l.id === locationId);
        if (filteredIndex !== -1) {
          filteredLocations[filteredIndex] = location;
        }

        // Refresh locations table
        updateLocationsTable();

        // Save to Firestore
        await saveLocationsToFirestore();
      }

      // Hide the modal
      document.getElementById('editFieldModal').classList.add('hidden');
    };

    // Cancel field edit
    window.cancelFieldEdit = function() {
      document.getElementById('editFieldModal').classList.add('hidden');
    };

    // Customer field editing functionality
    window.editCustomerField = function(customerId, fieldType, currentValue) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      // Set up the edit modal
      document.getElementById('editFieldType').textContent = fieldType.charAt(0).toUpperCase() + fieldType.slice(1);
      document.getElementById('editFieldValue').value = currentValue;
      document.getElementById('editFieldLocationId').value = customerId;
      document.getElementById('editFieldFieldType').value = fieldType;

      // Show the modal
      document.getElementById('editFieldModal').classList.remove('hidden');
    };

    // Show amount details modal
    window.showAmountDetails = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      // Use shared calculation function to ensure consistency
      const calc = calculateCustomerTotal(customer);
      const factor = customer.factor ? parseFloat(customer.factor) : 1.0;

      // Check if customer has actually paid their bill in full
      // Show "paid" message if Total Due = $0.00 AND they have made payments
      const currentMonthPaid = parseFloat(customer.currentMonthPaid || 0);
      const totalDue = Math.max(0, calc.total); // Clamp to 0 to avoid negative
      const hasPaymentHistory = customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0;
      const isCurrentBillPaid = totalDue === 0 && (currentMonthPaid > 0 || hasPaymentHistory);

      // Build code display rows for UI
      const codesContainer = document.getElementById('amountDetailsCodesContainer');
      codesContainer.innerHTML = '';
      const codeRows = [];

      if (customer.codes && customer.codes.length > 0) {
        customer.codes.forEach(customerCode => {
          // Look up the latest code data from the global codes array
          let latestCode = codes.find(c => c.id === customerCode.id);
          if (!latestCode) {
            latestCode = codes.find(c => c.name.toLowerCase() === customerCode.name.toLowerCase());
          }
          const codeToUse = latestCode || customerCode;

          const codeType = codeToUse.type || 'percentage';
          const codeAmount = codeToUse.amount !== undefined ? codeToUse.amount : (codeToUse.percentage !== undefined ? codeToUse.percentage : 0);

          // Calculate surcharge amount (same logic as shared function)
          let baseSurchargeAmount;
          if (codeType === 'flat') {
            baseSurchargeAmount = codeAmount;
          } else {
            baseSurchargeAmount = calc.adjustedServiceCost * (codeAmount / 100);
          }
          const surchargeAmount = baseSurchargeAmount * factor;

          // Build display text with factor if factor is not 1.0
          let displayText;
          if (factor !== 1.0) {
            if (codeType === 'flat') {
              displayText = `${codeToUse.name} ($${parseFloat(codeAmount).toFixed(2)} x ${factor})`;
            } else {
              displayText = `${codeToUse.name} (${parseFloat(codeAmount).toFixed(2)}% x ${factor} x ${calc.adjustedServiceCost.toFixed(2)})`;
            }
          } else {
            if (codeType === 'flat') {
              displayText = `${codeToUse.name} ($${parseFloat(codeAmount).toFixed(2)})`;
            } else {
              displayText = `${codeToUse.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
            }
          }

          codeRows.push({
            name: codeToUse.name,
            displayText: displayText,
            surchargeAmount: surchargeAmount
          });
        });
      }

      // ----- DEFINE paymentsHistory and paymentsByCategory EARLY so all sections can use it -----

      const paymentsHistory = Array.isArray(customer.currentMonthPaymentHistory) ? customer.currentMonthPaymentHistory : [];

      const paymentsByCategory = (cat) => {
        const filtered = paymentsHistory.filter(p => p.category === cat);

        return filtered;
      };

      // ----- Tax Codes summary + details -----
      const taxCodesSummaryRow = document.getElementById('amountDetailsTaxCodesSummaryRow');
      const taxCodesTotalEl = document.getElementById('amountDetailsTaxCodesTotal');
      const taxCodesDetailsEl = document.getElementById('amountDetailsTaxCodesDetails');
      const taxCodesToggleBtn = document.getElementById('amountDetailsTaxCodesToggleBtn');

      // Reset (always)
      if (taxCodesDetailsEl) taxCodesDetailsEl.innerHTML = '';
      if (taxCodesToggleBtn) taxCodesToggleBtn.textContent = 'View details';
      if (taxCodesDetailsEl) taxCodesDetailsEl.classList.add('hidden');
      if (taxCodesSummaryRow) taxCodesSummaryRow.classList.add('hidden');

      // Show tax codes section - calculate remaining after payments
      // Sort codes alphabetically by name
      codeRows.sort((a, b) => a.name.localeCompare(b.name));

      const taxCodesOnlyTotal = codeRows.reduce((sum, r) => sum + (r.surchargeAmount || 0), 0);
      const pucTotal = pucSurcharge > 0 ? (calc.pucSurchargeAmount || 0) : 0;
      const taxCodesBaseTotal = taxCodesOnlyTotal + pucTotal;
      const taxCodesPaid = customer.currentMonthPaidTaxCodes || 0;
      const taxCodesRemaining = Math.max(0, taxCodesBaseTotal - taxCodesPaid);

      // Get payments applied to Tax Codes category
      const taxCodePayments = paymentsByCategory('Tax Codes');

      // Show if there's any tax codes (base > 0) OR if payments have been made
      if (taxCodesSummaryRow && (taxCodesBaseTotal > 0 || taxCodePayments.length > 0)) {
        taxCodesSummaryRow.classList.remove('hidden');
        if (taxCodesTotalEl) taxCodesTotalEl.textContent = `$${taxCodesRemaining.toFixed(2)}`;

        // Build expandable details list (tax codes + PUC line + payments)
        if (taxCodesDetailsEl) {
          codeRows.forEach(codeRow => {
            const row = document.createElement('div');
            row.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
            row.innerHTML = `
              <span class="text-slate-600 dark:text-slate-300">${codeRow.displayText}</span>
              <span class="font-medium text-slate-800 dark:text-slate-100">$${codeRow.surchargeAmount.toFixed(2)}</span>
            `;
            taxCodesDetailsEl.appendChild(row);
          });

          if (pucSurcharge > 0) {
            const pucRow = document.createElement('div');
            pucRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
            const pucDisplayText = `PUC SCHG SW (${pucSurcharge.toFixed(2)}% x $${calc.subtotalBeforePuc.toFixed(2)})`;
            pucRow.innerHTML = `
              <span class="text-slate-600 dark:text-slate-300">${pucDisplayText}</span>
              <span class="font-medium text-slate-800 dark:text-slate-100">$${(calc.pucSurchargeAmount || 0).toFixed(2)}</span>
            `;
            taxCodesDetailsEl.appendChild(pucRow);
          }

          // Show payments made to Tax Codes
          taxCodePayments.forEach((p) => {
            const paymentNum = p.paymentNumber || '?';
            const r = document.createElement('div');
            r.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
            r.innerHTML = `
              <span class="text-green-600 dark:text-green-400">Previous Payment #${paymentNum} (${p.date || '—'})</span>
              <span class="font-medium text-green-600 dark:text-green-400">-$${(p.amount || 0).toFixed(2)}</span>
            `;
            taxCodesDetailsEl.appendChild(r);
          });
        }
      }

      // ----- Sewer, Late Fee, Past Due summaries -----
      const sewerSummaryRow = document.getElementById('amountDetailsSewerSummaryRow');
      const sewerTotalEl = document.getElementById('amountDetailsSewerTotal');
      const sewerDetailsEl = document.getElementById('amountDetailsSewerDetails');

      const lateFeeSummaryRow = document.getElementById('amountDetailsLateFeeSummaryRow');
      const lateFeeTotalEl = document.getElementById('amountDetailsLateFeeTotal');
      const lateFeeDetailsEl = document.getElementById('amountDetailsLateFeeDetails');

      const pastDueSummaryRow = document.getElementById('amountDetailsPastDueSummaryRow');
      const pastDueTotalEl = document.getElementById('amountDetailsPastDueTotal');
      const pastDueDetailsEl = document.getElementById('amountDetailsPastDueDetails');

      // Reset detail containers
      if (sewerDetailsEl) sewerDetailsEl.innerHTML = '';
      if (lateFeeDetailsEl) lateFeeDetailsEl.innerHTML = '';
      if (pastDueDetailsEl) pastDueDetailsEl.innerHTML = '';

      // Sewer Charge
      const sewerBase = calc.adjustedServiceCost;
      const sewerRemaining = Math.max(0, sewerBase - (customer.currentMonthPaidSewer || 0));

      if (sewerSummaryRow) {
        sewerSummaryRow.classList.remove('hidden');
        if (sewerTotalEl) sewerTotalEl.textContent = `$${sewerRemaining.toFixed(2)}`;
        if (sewerDetailsEl) {
          const baseRow = document.createElement('div');
          baseRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
          baseRow.innerHTML = `
            <span class="text-slate-600 dark:text-slate-300">Sewer Charge (base)</span>
            <span class="font-medium text-slate-800 dark:text-slate-100">$${sewerBase.toFixed(2)}</span>
          `;
          sewerDetailsEl.appendChild(baseRow);

          const sewerPays = paymentsByCategory('Sewer Charge');

          sewerPays.forEach((p) => {
            const paymentNum = p.paymentNumber || '?';

            const r = document.createElement('div');
            r.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
            r.innerHTML = `
              <span class="text-green-600 dark:text-green-400">Previous Payment #${paymentNum} (${p.date || '—'})</span>
              <span class="font-medium text-green-600 dark:text-green-400">-$${(p.amount || 0).toFixed(2)}</span>
            `;
            sewerDetailsEl.appendChild(r);
          });
        }
      }

      // Late Fee
      if (lateFeeSummaryRow) {
        if (calc.lateFeeAmount > 0 || (customer.currentMonthPaidLateFee || 0) > 0) {
          lateFeeSummaryRow.classList.remove('hidden');
          const lateRemaining = Math.max(0, (calc.lateFeeAmount || 0) - (customer.currentMonthPaidLateFee || 0));
          if (lateFeeTotalEl) lateFeeTotalEl.textContent = `$${lateRemaining.toFixed(2)}`;
          if (lateFeeDetailsEl) {
            const baseRow = document.createElement('div');
            baseRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
            baseRow.innerHTML = `
              <span class="text-slate-600 dark:text-slate-300">Late Fee (base)</span>
              <span class="font-medium text-slate-800 dark:text-slate-100">$${(calc.lateFeeAmount || 0).toFixed(2)}</span>
            `;
            lateFeeDetailsEl.appendChild(baseRow);

            const lfPays = paymentsByCategory('Late Fee');
            lfPays.forEach((p) => {
              const paymentNum = p.paymentNumber || '?';
              const r = document.createElement('div');
              r.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
              r.innerHTML = `
                <span class="text-green-600 dark:text-green-400">Previous Payment #${paymentNum} (${p.date || '—'})</span>
                <span class="font-medium text-green-600 dark:text-green-400">-$${(p.amount || 0).toFixed(2)}</span>
              `;
              lateFeeDetailsEl.appendChild(r);
            });
          }
        } else {
          lateFeeSummaryRow.classList.add('hidden');
        }
      }

      // Past Due
      if (pastDueSummaryRow) {
        // Show only if past due is positive or payments exist
        const pastDueDisplay = Math.max(0, calc.pastDue || 0);
        const pdPays = paymentsByCategory('Past Due');
        if (pastDueDisplay > 0 || pdPays.length > 0) {
          pastDueSummaryRow.classList.remove('hidden');
          if (pastDueTotalEl) pastDueTotalEl.textContent = `$${pastDueDisplay.toFixed(2)}`;
          if (pastDueDetailsEl) {
            const baseRow = document.createElement('div');
            baseRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
            baseRow.innerHTML = `
              <span class="text-slate-600 dark:text-slate-300">Past Due (remaining)</span>
              <span class="font-medium text-slate-800 dark:text-slate-100">$${pastDueDisplay.toFixed(2)}</span>
            `;
            pastDueDetailsEl.appendChild(baseRow);

            pdPays.forEach((p) => {
              const paymentNum = p.paymentNumber || '?';
              const r = document.createElement('div');
              r.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600 last:border-b-0';
              r.innerHTML = `
                <span class="text-green-600 dark:text-green-400">Previous Payment #${paymentNum} (${p.date || '—'})</span>
                <span class="font-medium text-green-600 dark:text-green-400">-$${(p.amount || 0).toFixed(2)}</span>
              `;
              pastDueDetailsEl.appendChild(r);
            });
          }
        } else {
          pastDueSummaryRow.classList.add('hidden');
        }
      }

      // Calculate due date as last day of current month
      const now = new Date();
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getFullYear();

      // Calculate billing cycle (month after due date)
      const billingCycleStart = new Date(lastDayOfMonth.getFullYear(), lastDayOfMonth.getMonth() + 1, 1);
      const billingCycleEnd = new Date(billingCycleStart.getFullYear(), billingCycleStart.getMonth() + 1, 0);

      const formatShortDate = (date) => {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const year = date.getFullYear().toString().slice(-2);
        return `${month}/${day}/${year}`;
      };

      const billingCycleStr = `${formatShortDate(billingCycleStart)} to ${formatShortDate(billingCycleEnd)}`;

      // Hide factor container since it's now shown inline with service cost
      const factorContainer = document.getElementById('amountDetailsFactorContainer');
      if (factorContainer) {
        factorContainer.innerHTML = ''; // Clear it since factor is now shown inline
        factorContainer.style.display = 'none'; // Hide it
      }

      document.getElementById('amountDetailsCustomer').textContent = customer.name;

      // Display factor if it's not 1.0
      const factorRow = document.getElementById('amountDetailsFactorRow');
      const factorElement = document.getElementById('amountDetailsFactor');
      if (factorRow && factorElement) {
        if (factor !== 1.0) {
          factorRow.style.display = 'flex';
          factorElement.textContent = factor.toFixed(1);
        } else {
          factorRow.style.display = 'none';
        }
      }

      // Show service cost with factor calculation inline, or show "paid" message
      const serviceRow = document.getElementById('amountDetailsServiceRow');
      if (serviceRow) {
        if (isCurrentBillPaid) {
          // Show "paid" message instead of breakdown
          serviceRow.innerHTML = `
            <div class="w-full py-6 px-4 bg-green-50 dark:bg-green-900/20 border-2 border-green-200 dark:border-green-700 rounded-xl">
              <div class="flex flex-col items-center justify-center space-y-2">
                <svg class="w-12 h-12 text-green-500 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-lg font-semibold text-green-700 dark:text-green-300">Bill Paid in Full</span>
                <span class="text-sm text-green-600 dark:text-green-400 text-center">This customer has completely paid off their bill for this month.</span>
              </div>
            </div>
          `;
          // Don't hide codes and PUC surcharge containers - they should still be visible with payment history
          // The breakdown sections below will show $0.00 remaining but with payment history when expanded
        } else {
          // Show normal breakdown
          if (factor !== 1.0) {
            serviceRow.innerHTML = `
              <span class="text-slate-600 dark:text-slate-400">Sewage Service (${calc.baseServiceCost.toFixed(2)} x ${factor})</span>
              <span class="font-medium" id="amountDetailsService">$${calc.adjustedServiceCost.toFixed(2)}</span>
            `;
          } else {
            serviceRow.innerHTML = `
              <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
              <span class="font-medium" id="amountDetailsService">$${calc.adjustedServiceCost.toFixed(2)}</span>
            `;
          }
        }
      } else {
        const serviceElement = document.getElementById('amountDetailsService');
        if (serviceElement && !isCurrentBillPaid) {
          serviceElement.textContent = `$${calc.adjustedServiceCost.toFixed(2)}`;
        }
      }

      // Display past due (only if positive)
      const pastDueElement = document.getElementById('amountDetailsPastDue');
      const pastDueRow = document.getElementById('amountDetailsPastDueRow');
      if (pastDueElement && pastDueRow) {
        if (calc.pastDue > 0) {
          pastDueRow.style.display = 'flex';
          pastDueElement.textContent = `$${calc.pastDue.toFixed(2)}`;
      pastDueElement.setAttribute('data-customer-id', customerId);
          pastDueElement.setAttribute('data-past-due', calc.pastDue.toFixed(2));
        } else {
          pastDueRow.style.display = 'none';
          pastDueElement.setAttribute('data-customer-id', customerId);
          pastDueElement.setAttribute('data-past-due', '0.00');
        }
      }

      // Display credit (only if there's a credit)
      const creditRow = document.getElementById('amountDetailsCreditRow');
      const creditElement = document.getElementById('amountDetailsCredit');

      if (creditRow && creditElement) {
        // Only show if strictly > 0.005 to avoid floating-point noise
        if (calc.credit > 0.005) {
          creditRow.style.display = 'flex';
          creditElement.textContent = `$${calc.credit.toFixed(2)}`;

        } else {
          creditRow.style.display = 'none';

        }
      } else {

      }

      // Display current due (Sewer + Tax Codes only, NOT including Late Fee)
      // Current Due = sewer remaining + tax codes remaining
      const currentDueElement = document.getElementById('amountDetailsCurrentDue');
      if (currentDueElement) {
        const sewerRemainingForCurrentDue = Math.max(0, (calc.adjustedServiceCost || 0) - (customer.currentMonthPaidSewer || 0));
        const taxCodesRemainingForCurrentDue = Math.max(0, ((calc.totalSurcharge || 0) + (calc.pucSurchargeAmount || 0)) - (customer.currentMonthPaidTaxCodes || 0));
        const currentDueDisplay = sewerRemainingForCurrentDue + taxCodesRemainingForCurrentDue;

        currentDueElement.textContent = `$${currentDueDisplay.toFixed(2)}`;
      }

      // Show/hide Late Fee based on amount - show REMAINING late fee, not base
      const lateFeeRow = document.getElementById('amountDetailsLateFeeRow');
      const lateFeeElement = document.getElementById('amountDetailsLateFee');
      if (lateFeeRow && lateFeeElement) {
        const lateFeeRemaining = Math.max(0, (calc.lateFeeAmount || 0) - (customer.currentMonthPaidLateFee || 0));

        if (calc.lateFeeAmount > 0) {
          lateFeeRow.style.display = 'flex';
          lateFeeElement.textContent = `$${lateFeeRemaining.toFixed(2)}`;
        } else {
          lateFeeRow.style.display = 'none';
        }
      }

      // Use total from shared calculation function, but never show negative (clamp at 0)
      const clampedTotal = Math.max(0, calc.total);

      document.getElementById('amountDetailsTotal').textContent = `$${clampedTotal.toFixed(2)}`;
      document.getElementById('amountDetailsDueDate').textContent = dueDateStr;
      document.getElementById('amountDetailsBillingCycle').textContent = billingCycleStr;
      document.getElementById('amountDetailsLastPayment').textContent = formatDate(customer.lastPayment);

      // Get last payment amount from payment history

      let lastPaymentAmount = '$0.00';
      if (customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0) {
        // Get the most recent payment (assuming they're ordered by date, or get the last one)
        const lastPayment = customer.paymentHistory[customer.paymentHistory.length - 1];

        if (lastPayment && lastPayment.amountPaid) {
          const amountPaid = parseFloat(lastPayment.amountPaid);

          lastPaymentAmount = `$${amountPaid.toFixed(2)}`;

        } else {

        }
      } else {

      }

      document.getElementById('amountDetailsLastPaymentAmount').textContent = lastPaymentAmount;

      // Get last amount due from payment history
      let lastAmountDue = '$0.00';
      if (customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0) {
        const lastPayment = customer.paymentHistory[customer.paymentHistory.length - 1];
        if (lastPayment && lastPayment.amountDue) {
          const amountDue = parseFloat(lastPayment.amountDue);
          lastAmountDue = `$${amountDue.toFixed(2)}`;
        }
      }
      const lastAmountDueEl = document.getElementById('amountDetailsLastAmountDue');
      if (lastAmountDueEl) {
        lastAmountDueEl.textContent = lastAmountDue;
      }

      // Show/hide "View All Previous Payments" button
      const viewAllPaymentsBtn = document.getElementById('viewAllPaymentsBtn');
      if (viewAllPaymentsBtn) {
        if (customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0) {
          viewAllPaymentsBtn.style.display = 'block';
          viewAllPaymentsBtn.setAttribute('data-customer-id', customerId);
        } else {
          viewAllPaymentsBtn.style.display = 'none';
        }
      }

      document.getElementById('amountDetailsModal').classList.remove('hidden');
    };

    // Show amount breakdown for a customer (used from search results)
    window.showAmountBreakdownForCustomer = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }
      showAmountDetails(customerId);
    };

    // Show all payments modal
    window.showAllPaymentsModal = function() {
      const btn = document.getElementById('viewAllPaymentsBtn');
      const customerId = btn ? btn.getAttribute('data-customer-id') : null;
      if (!customerId) {
        // Try to get from amountDetailsModal
        const modal = document.getElementById('amountDetailsModal');
        if (modal) {
          const customerNameEl = document.getElementById('amountDetailsCustomer');
          if (customerNameEl) {
            const customerName = customerNameEl.textContent;
            const customer = customers.find(c => c.name === customerName);
            if (customer) {
              displayAllPaymentsModal(customer);
              return;
            }
          }
        }
        alert('Customer not found');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      displayAllPaymentsModal(customer);
    };

    function displayAllPaymentsModal(customer) {
      // Create or get modal
      let modal = document.getElementById('allPaymentsModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'allPaymentsModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
        document.body.appendChild(modal);
      }

      const paymentHistory = customer.paymentHistory || [];
      const sortedPayments = [...paymentHistory].reverse(); // Most recent first

      let paymentsHtml = '';
      if (sortedPayments.length === 0) {
        paymentsHtml = '<tr><td colspan="4" class="text-center text-slate-500 dark:text-slate-400 py-8">No payment history available</td></tr>';
      } else {
        sortedPayments.forEach((payment, index) => {
          // Parse date and add time if available
          let dateTimeDisplay = payment.date || '—';
          // If date is in MM/DD/YYYY format, try to add time
          // For now, we'll show the date. If we stored timestamp, we can show time too.
          // Check if payment has a timestamp field
          const paymentDate = payment.timestamp ? new Date(payment.timestamp) : (payment.date ? parsePaymentDate(payment.date) : null);

          if (paymentDate && !isNaN(paymentDate.getTime())) {
            // Format as MM/DD/YYYY HH:MM AM/PM
            const month = (paymentDate.getMonth() + 1).toString().padStart(2, '0');
            const day = paymentDate.getDate().toString().padStart(2, '0');
            const year = paymentDate.getFullYear();
            const hours = paymentDate.getHours();
            const minutes = paymentDate.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            dateTimeDisplay = `${month}/${day}/${year} ${displayHours}:${minutes} ${ampm}`;
          }

          const creditGiven = payment.creditGiven || 0;
          paymentsHtml += `
            <tr class="border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">${dateTimeDisplay}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${(payment.amountDue || 0).toFixed(2)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${(payment.amountPaid || 0).toFixed(2)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm ${creditGiven > 0 ? 'text-green-600 dark:text-green-400' : 'text-slate-500 dark:text-slate-400'}">${creditGiven > 0 ? `$${creditGiven.toFixed(2)}` : '—'}</td>
            </tr>
          `;
        });
      }

      modal.innerHTML = `
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">All Previous Payments</h2>
            <button onclick="hideAllPaymentsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="mb-4">
            <p class="text-sm text-slate-600 dark:text-slate-400">
              <strong>Customer:</strong> ${customer.name} (${customer.accountNumber || customer.id})
            </p>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
              <thead class="bg-slate-50 dark:bg-slate-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Date & Time</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Paid</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Credit Given</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                ${paymentsHtml}
              </tbody>
            </table>
          </div>
          <div class="mt-6 flex justify-end">
            <button 
              onclick="hideAllPaymentsModal()" 
              class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      `;

      modal.classList.remove('hidden');
    }

    // Hide all payments modal
    window.hideAllPaymentsModal = function() {
      const modal = document.getElementById('allPaymentsModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Helper function to parse payment date (MM/DD/YYYY format)
    function parsePaymentDate(dateString) {
      if (!dateString || dateString === 'Never') return null;
      const parts = dateString.split('/');
      if (parts.length === 3) {
        const month = parseInt(parts[0]) - 1;
        const day = parseInt(parts[1]);
        const year = parseInt(parts[2]);
        return new Date(year, month, day);
      }
      return null;
    }

    // Toggle Tax Codes details inside Amount Breakdown
    window.toggleAmountDetailsTaxCodes = function() {
      const details = document.getElementById('amountDetailsTaxCodesDetails');
      const btn = document.getElementById('amountDetailsTaxCodesToggleBtn');
      if (!details || !btn) return;

      const isHidden = details.classList.contains('hidden');
      if (isHidden) {
        details.classList.remove('hidden');
        btn.textContent = 'Hide details';
      } else {
        details.classList.add('hidden');
        btn.textContent = 'View details';
      }

    };

    // Generic toggle for Sewer / Late Fee / Past Due details
    window.toggleAmountDetailsSection = function(section) {
      const map = {
        sewer: { detailsId: 'amountDetailsSewerDetails', btnId: 'amountDetailsSewerToggleBtn' },
        latefee: { detailsId: 'amountDetailsLateFeeDetails', btnId: 'amountDetailsLateFeeToggleBtn' },
        pastdue: { detailsId: 'amountDetailsPastDueDetails', btnId: 'amountDetailsPastDueToggleBtn' },
      };
      const ids = map[section];
      if (!ids) return;

      const details = document.getElementById(ids.detailsId);
      const btn = document.getElementById(ids.btnId);
      if (!details || !btn) return;

      const isHidden = details.classList.contains('hidden');
      if (isHidden) {
        details.classList.remove('hidden');
        btn.textContent = 'Hide details';
      } else {
        details.classList.add('hidden');
        btn.textContent = 'View details';
      }

    };

    // Hide amount details modal
    window.hideAmountDetails = function() {
      document.getElementById('amountDetailsModal').classList.add('hidden');
    };

    // Edit past due from amount details modal
    window.editPastDueFromModal = function() {
      const pastDueElement = document.getElementById('amountDetailsPastDue');
      const customerId = pastDueElement.getAttribute('data-customer-id');
      const currentPastDue = pastDueElement.getAttribute('data-past-due') || '0.00';

      // Remove $ sign and parse
      const numericValue = currentPastDue.replace('$', '');
      editCustomerField(customerId, 'pastDue', numericValue);
    };

    // Show customer full info modal
    window.showCustomerFullInfo = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const content = document.getElementById('customerFullInfoContent');
      content.innerHTML = `
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Personal Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.name || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.email || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.phone ? formatPhoneNumber(customer.phone) : 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.address || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cycle Number</label>
            <div class="flex items-center gap-2">
              <input 
                type="number" 
                id="customerCycleNumberInput_${customer.id}" 
                value="${customer.cycleNumber || ''}" 
                min="1"
                max="10"
                class="flex-1 px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter cycle number (1-10)"
              />
              <button 
                onclick="saveCustomerCycleNumber('${customer.id}')" 
                class="bg-blue-600 text-white px-4 py-3 rounded-xl hover:bg-blue-700 transition-colors font-medium"
              >
                Save
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.entityType || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.ssn || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.idType || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.idNumber || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.secondaryContactName || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.secondaryContactPhone ? formatPhoneNumber(customer.secondaryContactPhone) : 'N/A'}
            </div>
          </div>
          </div>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-600 my-6"></div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingStreet || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingCity || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingState || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingZip || 'N/A'}
              </div>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-600 my-6"></div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor & Codes</h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <div class="flex items-center gap-2">
                <input 
                  type="number" 
                  id="customerFactorInput_${customer.id}" 
                  value="${customer.factor || '1'}" 
                  step="0.01" 
                  min="0"
                  class="flex-1 px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="1.00"
                />
                <button 
                  onclick="saveCustomerFactor('${customer.id}')" 
                  class="bg-blue-600 text-white px-4 py-3 rounded-xl hover:bg-blue-700 transition-colors font-medium"
              >
                  Save
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tax Codes</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${(() => {
                  const codesList = [];
                  if (pucSurcharge > 0) {
                    codesList.push(`PUC SCHG SW (${pucSurcharge.toFixed(2)}%)`);
                  }
                  if (customer.codes && customer.codes.length > 0) {
                    customer.codes.forEach(code => {
                      const codeType = code.type || 'percentage';
                      const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
                      codesList.push(codeType === 'flat' 
                        ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
                        : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`);
                    });
                  }
                  return codesList.length > 0 ? codesList.join(', ') : 'N/A';
                })()}
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('customerFullInfoModal').classList.remove('hidden');
    };

    // Hide customer full info modal
    window.hideCustomerFullInfo = function() {
      document.getElementById('customerFullInfoModal').classList.add('hidden');
    };

    // Save customer factor (only saves that one customer)
    window.saveCustomerFactor = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      const input = document.getElementById(`customerFactorInput_${customerId}`);
      if (!input) {
        alert('Factor input not found');
        return;
      }

      const newFactor = parseFloat(input.value);

      if (isNaN(newFactor) || newFactor < 0) {
        alert('Please enter a valid factor (must be 0 or greater)');
        input.value = customer.factor || '1';
        return;
      }

      try {
        // Update the customer's factor
        customer.factor = newFactor;

        // Save only this customer to Firestore
        const customersRef = collection(db, 'customers');
        const customerRef = doc(customersRef, customerId);
        await setDoc(customerRef, customer);

        // Update the UI
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Show success message
        const button = input.nextElementSibling;
        const originalText = button.textContent;
        button.textContent = 'Saved!';
        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        button.classList.add('bg-green-600');

        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('bg-green-600');
          button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);

      } catch (error) {

        alert('Error saving factor: ' + error.message);
        // Revert input value on error
        input.value = customer.factor || '1';
      }
    };

    // Save customer cycle number (only saves that one customer)
    window.saveCustomerCycleNumber = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      const input = document.getElementById(`customerCycleNumberInput_${customerId}`);
      if (!input) {
        alert('Cycle number input not found');
        return;
      }

      const newCycleNumber = input.value.trim();

      // Allow empty value (null) or valid number between 1 and 10
      let cycleNumberValue = null;
      if (newCycleNumber !== '') {
        const parsed = parseInt(newCycleNumber);
        if (isNaN(parsed) || parsed < 1 || parsed > 10) {
          alert('Please enter a valid cycle number (must be between 1 and 10)');
          input.value = customer.cycleNumber || '';
          return;
        }
        cycleNumberValue = String(parsed);
      }

      try {
        // Update the customer's cycle number
        customer.cycleNumber = cycleNumberValue;

        // Save only this customer to Firestore
        const customersRef = collection(db, 'customers');
        const customerRef = doc(customersRef, customerId);
        await setDoc(customerRef, customer);

        // Update the UI
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Show success message
        const button = input.nextElementSibling;
        const originalText = button.textContent;
        button.textContent = 'Saved!';
        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        button.classList.add('bg-green-600');
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('bg-green-600');
          button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);
      } catch (error) {

        alert('Error saving cycle number: ' + error.message);
        // Revert input value on error
        input.value = customer.cycleNumber || '';
      }
    };

    // Show customer data profile modal (Excel preview)
    window.showCustomerDataProfile = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      // Check if customer has importData
      if (!customer.importData) {
        alert('No imported data available for this customer. Please import customer data first.');
        return;
      }

      const modalContent = document.getElementById('customerDataProfileContent');
      const headers = Object.keys(customer.importData);

      // Build Excel-like table
      let tableHTML = `
        <div class="overflow-x-auto border border-slate-300 dark:border-slate-600 rounded-lg">
          <table class="min-w-full text-sm border-collapse">
            <thead>
              <tr class="bg-slate-100 dark:bg-slate-700">
      `;

      // Add header row
      headers.forEach(header => {
        tableHTML += `<th class="px-4 py-2 text-left border border-slate-300 dark:border-slate-600 font-semibold text-slate-700 dark:text-slate-300 whitespace-nowrap">${header || ''}</th>`;
      });

      tableHTML += `
              </tr>
            </thead>
            <tbody>
              <tr class="bg-white dark:bg-slate-800">
      `;

      // Helper function to convert Excel serial date to readable date string
      const excelSerialToDate = (serial) => {
        if (typeof serial === 'number' && serial > 0 && serial < 1000000) {
          const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899 (Excel's epoch)
          const date = new Date(excelEpoch.getTime() + (serial - 1) * 24 * 60 * 60 * 1000);
          if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            return `${month}/${day}/${year}`;
          }
        }
        return serial;
      };

      // Add data row
      headers.forEach(header => {
        let value = customer.importData[header];
        // Check if it's a date field and value is a number (Excel serial date)
        const headerLower = String(header || '').toLowerCase();
        if ((headerLower.includes('date') || headerLower.includes('billdate')) && typeof value === 'number') {
          value = excelSerialToDate(value);
        }
        tableHTML += `<td class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-400">${value || ''}</td>`;
      });

      tableHTML += `
              </tr>
            </tbody>
          </table>
        </div>
      `;

      modalContent.innerHTML = tableHTML;
      const modal = document.getElementById('customerDataProfileModal');
      modal.setAttribute('data-customer-id', customerId);
      modal.classList.remove('hidden');
    };

    // Hide customer data profile modal
    window.hideCustomerDataProfile = function() {
      document.getElementById('customerDataProfileModal').classList.add('hidden');
    };

    // Copy full data profile to clipboard
    window.copyFullDataProfile = function() {
      const customerId = document.getElementById('customerDataProfileModal').getAttribute('data-customer-id');
      const customer = customers.find(c => c.id === customerId);

      if (!customer || !customer.importData) {
        alert('No data available to copy');
        return;
      }

      // Build a readable text format of all the data
      let textToCopy = 'Customer Data Profile (Excel Preview)\n\n';

      const headers = Object.keys(customer.importData);

      // Add header row
      textToCopy += headers.join('\t') + '\n';

      // Add data row
      const values = headers.map(header => customer.importData[header] || '');
      textToCopy += values.join('\t') + '\n';

      // Copy to clipboard
      navigator.clipboard.writeText(textToCopy).then(() => {
        alert('Full data profile copied to clipboard!');
      }).catch(err => {

        // Fallback: select text and show message
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          alert('Full data profile copied to clipboard!');
        } catch (err) {
          alert('Failed to copy. Please select and copy manually.');
        }
        document.body.removeChild(textArea);
      });
    };

    // Show payment modal
    window.showPaymentModal = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const currentAmount = customer.currentBill + customer.pastDue;
      document.getElementById('paymentCustomerName').textContent = customer.name;
      document.getElementById('paymentCurrentAmount').textContent = `$${currentAmount.toFixed(2)}`;
      document.getElementById('paymentAmount').value = '';
      document.getElementById('paymentAmount').max = currentAmount;
      document.getElementById('paymentCustomerId').value = customerId;

      document.getElementById('paymentModal').classList.remove('hidden');
    };

    // Hide payment modal
    window.hidePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };

    // Process payment
    window.processPayment = async function() {
      const customerId = document.getElementById('paymentCustomerId').value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);

      if (!paymentAmount || paymentAmount <= 0) {
        alert('Please enter a valid payment amount');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const currentAmount = customer.currentBill + customer.pastDue;
      if (paymentAmount > currentAmount) {
        alert(`Payment amount cannot exceed current balance of $${currentAmount.toFixed(2)}`);
        return;
      }

      // Record payment in history
      const today = new Date();
      const paymentDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                         today.getDate().toString().padStart(2, '0') + '/' + 
                         today.getFullYear();

      const paymentRecord = {
        date: paymentDate,
        amountDue: currentAmount,
        amountPaid: paymentAmount,
        remainingBalance: currentAmount - paymentAmount
      };

      customer.paymentHistory.push(paymentRecord);

      // Update customer balance
      if (paymentAmount >= customer.currentBill) {
        const remaining = paymentAmount - customer.currentBill;
        customer.currentBill = 0;
        customer.pastDue = Math.max(0, customer.pastDue - remaining);
      } else {
        customer.currentBill -= paymentAmount;
      }

      // Update last payment date
      customer.lastPayment = paymentDate;

      // If customer was pending closing and now has no balance, mark as inactive
      if (customer.paymentStatus === 'pending closing' && customer.pastDue === 0 && customer.currentBill === 0) {
        customer.paymentStatus = 'inactive';
      } else {
        // Update payment status based on past due amount
        updateCustomerPaymentStatus(customer);
      }

      // Save to Firestore
      await saveCustomersToFirestore();

      // Update display
      updateDashboard();
      hidePaymentModal();

      alert(`Payment of $${paymentAmount.toFixed(2)} recorded successfully!`);
    };

    // Show payment history
    window.showPaymentHistory = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      document.getElementById('historyCustomerName').textContent = customer.name;

      const historyBody = document.getElementById('paymentHistoryBody');
      historyBody.innerHTML = '';

      // Check if paymentHistory exists and has items
      if (!customer.paymentHistory || customer.paymentHistory.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 dark:text-slate-400 py-4">No payment history available</td></tr>';
      } else {
        customer.paymentHistory.forEach(payment => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">${payment.date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.amountDue.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.amountPaid.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.remainingBalance.toFixed(2)}</td>
          `;
          historyBody.appendChild(row);
        });
      }

      document.getElementById('paymentHistoryModal').classList.remove('hidden');
    };

    // Hide payment history modal
    window.hidePaymentHistory = function() {
      document.getElementById('paymentHistoryModal').classList.add('hidden');
    };

    // Keyboard shortcut to switch to client page
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey) {
        event.preventDefault();
        window.location.href = 'billing.html';
      }
    });
  </script>
  <style>
    :root { color-scheme: light dark; }
    body { background: radial-gradient(1200px 800px at 30% -10%, #e6f0ff 0%, #ffffff 45%) no-repeat; }
    @media (prefers-color-scheme: dark) {
      body { background: radial-gradient(1200px 800px at 30% -10%, #0b1220 0%, #0e1628 45%) no-repeat; }
    }
    .card { backdrop-filter: saturate(1.2) blur(8px); }
    .modal-show { display: flex !important; }
    .safe-pad { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .tap { -webkit-tap-highlight-color: transparent; }

  </style>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 tap">
  <!-- Firebase Auth Modal - Full Screen Homepage Style -->
  <div id="firebaseAuthModal" class="fixed inset-0 bg-gradient-to-br from-blue-50 via-white to-slate-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 flex items-center justify-center z-50 hidden">
    <div class="w-full max-w-md mx-4">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-2">PUBS Billing System</h1>
        <p class="text-sm text-slate-500 dark:text-slate-500 mt-2">Please enter your credentials to continue</p>
      </div>

      <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 border-4 border-blue-200 dark:border-blue-800 ring-4 ring-blue-100 dark:ring-blue-900/50">
        <form id="firebaseAuthForm" class="space-y-6">
        <div>
          <label for="firebaseEmail" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Username</label>
          <input 
              type="text"
            id="firebaseEmail" 
            required
              inputmode="email"
            autocomplete="email"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter Username"
          >
        </div>

        <div>
          <label for="firebasePassword" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Password</label>
          <input 
            type="password" 
            id="firebasePassword" 
            required
            autocomplete="current-password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
            placeholder="Enter password"
          >
        </div>

        <div id="firebaseAuthError" class="text-red-600 dark:text-red-400 text-sm hidden"></div>

        <button 
          type="submit" 
          id="firebaseAuthSubmit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors"
        >
          Sign In
        </button>
      </form>
      </div>
    </div>
  </div>

  <!-- Drawer Selection Modal (for POS users) -->
  <div id="drawerSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Select Drawer</h2>
      <p class="text-slate-600 dark:text-slate-400 mb-6">What drawer are you working with today?</p>

      <div id="drawerSelectionList" class="space-y-2 mb-6 max-h-96 overflow-y-auto">
        <!-- Drawer options will be populated dynamically -->
      </div>

      <div id="drawerSelectionError" class="text-red-600 dark:text-red-400 text-sm mb-4 hidden"></div>
      <!-- No cancel button - POS users must select a drawer -->
    </div>
  </div>

  <!-- Supervisor Drawer Selection Modal (for drawer counting) -->
  <div id="supervisorDrawerSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Select Drawer for SOD Count</h2>
      <p class="text-slate-600 dark:text-slate-400 mb-6">Which drawer would you like to count?</p>

      <div id="supervisorDrawerSelectionList" class="space-y-2 mb-6 max-h-96 overflow-y-auto">
        <!-- Drawer options will be populated dynamically -->
      </div>

      <button 
        onclick="hideSupervisorDrawerSelectionModal()" 
        class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-3 px-4 rounded-xl transition-colors"
      >
        Close
      </button>
    </div>
  </div>

  <!-- Drawer Count History Modal -->
      <div id="drawerCountHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 id="drawerCountHistoryTitle" class="text-2xl font-bold text-slate-900 dark:text-slate-100">Drawer Count History</h2>
        <button onclick="hideDrawerCountHistoryModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="drawerCountHistoryList" class="space-y-3">
        <!-- History entries will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Drawer Count Details Modal -->
  <div id="drawerCountDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 id="drawerCountDetailsTitle" class="text-2xl font-bold text-slate-900 dark:text-slate-100">Drawer Count Details</h2>
        <button onclick="hideDrawerCountDetailsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="drawerCountDetailsContent">
        <!-- Details will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Drawer Count Mismatch Modal -->
  <div id="drawerCountMismatchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 mb-4">
          <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Count Does Not Match</h2>
        <div id="drawerCountMismatchContent" class="text-slate-600 dark:text-slate-400 space-y-2 text-left mt-4">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
      <div class="flex justify-end">
        <button 
          onclick="hideDrawerCountMismatchModal()" 
          class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded-lg transition-colors"
        >
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Count Error Modal -->
  <div id="paymentCountErrorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 mb-4">
          <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        <h2 id="paymentCountErrorTitle" class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Count Error</h2>
        <div id="paymentCountErrorContent" class="text-slate-600 dark:text-slate-400 space-y-2 text-left mt-4 whitespace-pre-line">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
      <div class="flex justify-end">
        <button 
          onclick="hidePaymentCountErrorModal()" 
          class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded-lg transition-colors"
        >
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Drawer Count Success Modal -->
  <div id="drawerCountSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900 mb-4">
          <svg class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2 id="drawerCountSuccessTitle" class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Drawer Counted Successfully</h2>
        <div id="drawerCountSuccessContent" class="text-slate-600 dark:text-slate-400 space-y-2">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
      <div class="flex gap-3">
        <button 
          id="drawerCountSuccessPrintBtn"
          onclick="printDrawerCountSuccessReceipt()" 
          class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
        >
          Print Receipt
        </button>
        <button 
          onclick="hideDrawerCountSuccessModal()" 
          class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded-lg transition-colors"
        >
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Submission Success Modal -->
  <div id="paymentSubmissionSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900 mb-4">
          <svg class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Payment Processing Session Submitted</h2>
        <p class="text-slate-600 dark:text-slate-400">Register balanced.</p>
      </div>
      <div class="flex gap-3">
        <button 
          id="paymentSubmissionSuccessPrintBtn"
          onclick="printPaymentSubmissionReceipt()" 
          class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
        >
          Print Receipt
        </button>
        <button 
          onclick="hidePaymentSubmissionSuccessModal()" 
          class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded-lg transition-colors"
        >
          Continue
        </button>
      </div>
    </div>
  </div>

  <!-- EOD Verification Success Modal -->
  <div id="eodVerificationSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900 mb-4">
          <svg class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Drawer Count Verified Successfully!</h2>
        <div id="eodVerificationSuccessContent" class="text-slate-600 dark:text-slate-400 space-y-2 text-center mt-4">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
      <div class="flex gap-3">
        <button 
          id="eodVerificationSuccessPrintBtn"
          onclick="printEODVerificationReceipt()" 
          class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
        >
          Print Receipt
        </button>
        <button 
          onclick="hideEODVerificationSuccessModal()" 
          class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded-lg transition-colors"
        >
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Drawer Count Success Modal -->
  <div id="drawerCountSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900 mb-4">
          <svg class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2 id="drawerCountSuccessTitle" class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Drawer Counted Successfully</h2>
        <div id="drawerCountSuccessContent" class="text-slate-600 dark:text-slate-400 space-y-2">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
      <div class="flex gap-3">
        <button 
          id="drawerCountSuccessPrintBtn"
          onclick="printDrawerCountSuccessReceipt()" 
          class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
        >
          Print Receipt
        </button>
        <button 
          onclick="hideDrawerCountSuccessModal()" 
          class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded-lg transition-colors"
        >
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Receipt Popup Modal -->
  <div id="paymentReceiptPopupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-4">Payment Processed Successfully</h2>
        <p class="text-slate-600 dark:text-slate-400">Do you want a receipt?</p>
      </div>
      <div class="flex gap-3">
        <button 
          id="paymentReceiptPopupYesBtn"
          onclick="handleReceiptPopupYes()" 
          class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
        >
          Yes
        </button>
        <button 
          onclick="hidePaymentReceiptPopup()" 
          class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded-lg transition-colors"
        >
          No
        </button>
      </div>
    </div>
  </div>

  <div class="mx-auto max-w-7xl px-4 pt-6 pb-24 safe-pad">

    <!-- Dashboard Screen -->
    <div id="dashboardScreen">
      <!-- Header -->
      <header class="mb-8">
        <div class="text-center">
          <br><br>
          <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200">CUS Admin Dashboard</h1>
          <p class="text-slate-600 dark:text-slate-400">Manage customer accounts and billing</p>
        </div>
      </header>

      <!-- Action Modules -->
      <div id="actionModules" class="mb-8">
        <!-- Payment Module -->
        <div id="paymentModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Payment</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
              <select id="paymentCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Choose a customer...</option>
              </select>
            </div>

            <div id="customerPaymentInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                  <p id="paymentAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                  <button id="viewDetailsBtn" onclick="showPaymentDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                    View Details
                  </button>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                  <p id="paymentPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                  <p id="paymentLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                  <p id="paymentPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                  <p id="paymentDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                  <span id="paymentStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be populated by JavaScript -->
                  </span>
                </div>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Type</label>
                <select 
                  id="paymentType" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                >
                  <option value="">Select Payment Type</option>
                  <option value="Check">Check</option>
                  <option value="Cash">Cash</option>
                </select>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
                <input 
                  type="number" 
                  id="paymentAmount" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter payment amount"
                >
              </div>

              <button 
                onclick="processPaymentFromModule()" 
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Process Payment
              </button>
            </div>
          </div>
        </div>

        <!-- Bill Module -->
        <div id="billModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
              <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Choose a customer...</option>
              </select>
            </div>

            <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                  <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                  <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                    View Details
                  </button>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                  <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                  <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                  <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                  <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                  <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be populated by JavaScript -->
                  </span>
                </div>
              </div>

              <!-- Bill Preview -->
              <div id="billPreview" class="mb-4 p-4 bg-white dark:bg-slate-600 rounded-lg border-2 border-slate-300 dark:border-slate-500">
                <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-3">Bill Preview</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Service Cost:</span>
                    <span id="previewServiceCost" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Late Fee:</span>
                    <span id="previewLateFee" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Surcharges:</span>
                    <span id="previewSurcharges" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Factor Adjustment:</span>
                    <span id="previewFactorAdjustment" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between pt-2 border-t border-slate-300 dark:border-slate-500">
                    <span class="font-semibold text-slate-800 dark:text-slate-200">Total Amount:</span>
                    <span id="previewTotalAmount" class="font-bold text-lg text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                </div>
              </div>

              <button 
                onclick="produceBill()" 
                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Produce Bill
              </button>

              <!-- PDF Display Container -->
              <div id="billPdfDisplay" class="hidden mt-4">
                <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
                <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Client Module -->
        <div id="addClientModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Client</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Account Info</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
              <input 
                type="text" 
                id="newClientName" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter full name"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
              <input 
                type="email" 
                id="newClientEmail" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter email address"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
              <input 
                type="tel" 
                id="newClientPhone" 
                oninput="formatPhoneInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="(xxx)-xxx-xxxx"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
              <select id="newClientLocation" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" required>
                <option value="">Choose a location...</option>
                <option value="add-new">+ Add New Location</option>
              </select>
            </div>
            </div>
          </div>

          <!-- Identification Info Section -->
          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Identification Info</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
                <input 
                  type="text" 
                  id="newClientSSN" 
                  oninput="formatSSNInput(this)"
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="xxx-xx-xxxx"
                  maxlength="11"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
                <select id="newClientIDType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">Select ID Type</option>
                  <option value="Drivers License">Drivers License</option>
                  <option value="ID">ID</option>
                  <option value="Passport">Passport</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
                <input 
                  type="text" 
                  id="newClientIDNumber" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter ID number"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
                <input 
                  type="text" 
                  id="newClientSecondaryContactName" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter secondary contact name"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
                <input 
                  type="tel" 
                  id="newClientSecondaryContactPhone" 
                  oninput="formatPhoneInput(this)"
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="(xxx)-xxx-xxxx"
                >
              </div>
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
                <input 
                  type="text" 
                  id="newClientMailingStreet" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter street address"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
                <input 
                  type="text" 
                  id="newClientMailingCity" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter city"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
                <select id="newClientMailingState" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">Select State</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                <input 
                  type="text" 
                  id="newClientMailingZip" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter ZIP code"
                  maxlength="10"
                >
              </div>
            </div>
          </div>

            <div class="mt-6">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
              <div id="newClientCodesList" class="space-y-2">
                <!-- Selected codes will be displayed here -->
              </div>
            </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <input 
                type="number" 
                id="newClientFactor" 
                step="any"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter factor"
              >
            </div>
          </div>

          <div class="mt-6">
            <button 
              onclick="addClientFromModule()" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Create Client Account
            </button>
          </div>
        </div>

        <!-- Search Module -->
        <div id="searchModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Search Accounts</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Search by Name</label>
                <input 
                  type="text" 
                  id="searchByName" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Search by name, account number, address, or phone number..."
                  oninput="performSearch()"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Filter by Status</label>
                <select id="searchByStatus" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" onchange="performSearch()">
                  <option value="">All Status</option>
                  <option value="current">Current</option>
                  <option value="overdue">Overdue</option>
                </select>
              </div>
            </div>

            <div id="searchResults" class="mt-6">
              <!-- Search results will be displayed here -->
            </div>
          </div>
        </div>

        <!-- Drawer Count Module -->
        <div id="drawerCountModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h3 id="drawerCountTitle" class="text-2xl font-bold text-slate-800 dark:text-slate-200">Cash Register Count</h3>
              <p class="text-sm text-slate-500 dark:text-slate-400">Enter quantities to establish the initial register balance.</p>
            </div>
            <button onclick="cancelDrawerCount()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
              </button>
            </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
              <div id="drawerCountBillsContainer" class="grid grid-cols-2 gap-3">
                <!-- Bills will be populated dynamically -->
              </div>
            </div>

            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
              <div id="drawerCountCoinsContainer" class="grid grid-cols-2 gap-3">
                <!-- Coins will be populated dynamically -->
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between mt-6">
            <div>
              <p id="drawerCountTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">Total: $0.00</p>
            </div>
            <div class="flex gap-3">
              <button onclick="clearDrawerCount()" class="px-4 py-2 text-sm bg-slate-200 rounded-lg">Clear</button>
              <button onclick="saveDrawerCount()" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Save Drawer Count</button>
            </div>
          </div>
        </div>

        <!-- Settings Module -->
        <div id="settingsModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 relative">
          <!-- Loading Overlay -->
          <div id="settingsLoadingOverlay" class="absolute inset-0 bg-white dark:bg-slate-800 bg-opacity-90 dark:bg-opacity-90 flex items-center justify-center z-50 rounded-3xl hidden">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p class="text-slate-700 dark:text-slate-300 font-medium">Loading settings data...</p>
            </div>
          </div>

          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Settings & Management</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex space-x-1 mb-6">
            <button 
              id="settingsAccountsTab"
              onclick="switchSettingsView('accounts')" 
              class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
            >
              Accounts
            </button>
            <button 
              id="settingsLocationsTab"
              onclick="switchSettingsView('locations')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Locations
            </button>
            <button 
              id="settingsCodesTab"
              onclick="switchSettingsView('codes')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Codes
            </button>
            <button 
              id="settingsUsersTab"
              onclick="switchSettingsView('users')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Users
            </button>
            <button 
              id="settingsCleanupTab"
              onclick="switchSettingsView('cleanup')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Data Cleanup
            </button>
            <button 
              id="settingsHierarchyTab"
              onclick="switchSettingsView('hierarchy')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Hierarchy
            </button>
            <button 
              id="settingsDrawersTab"
              onclick="switchSettingsView('drawers')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Drawers
            </button>
            <button 
              id="settingsTogglesTab"
              onclick="switchSettingsView('toggles')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Toggles
            </button>
          </div>

          <!-- Accounts Section -->
          <div id="settingsAccountsContent">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Customer Accounts</h4>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                  Showing <span id="settingsCustomerCountDisplay" class="font-semibold">0</span> of <span id="settingsCustomerTotalDisplay" class="font-semibold">0</span> customers
                </p>
              </div>
              <div class="flex flex-col gap-2">
                <button 
                  onclick="showAddCustomerModal()" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Add New Customer
                </button>
                <button 
                  onclick="showImportCustomerDataModal()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm"
                >
                  Import Customer Data
                </button>
                <button 
                  onclick="deleteAllUserData()" 
                  class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
                >
                  Delete User Data
                </button>
                <button 
                  onclick="logout()" 
                  class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors text-sm"
                >
                  Logout
                </button>
              </div>
            </div>

            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsCustomerSearch" 
                  type="text" 
                  placeholder="Search by name, account number, or address..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  oninput="searchCustomersTable()"
                />
              </div>
              <div>
                <select 
                  onchange="filterByStatus(this.value)" 
                  class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Status</option>
                  <option value="current">Current</option>
                  <option value="overdue">Overdue</option>
                  <option value="no-codes">No codes</option>
                  <option value="has-codes">Has codes</option>
                </select>
              </div>
            </div>

            <!-- Customer Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Account</th>
                    <th class="px-0 py-3 pr-0 -mr-4 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Customer</th>
                    <th class="px-0 py-3 pl-0 -ml-4 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Property</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Codes</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsCustomerTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Customer rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Locations Section -->
          <div id="settingsLocationsContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Property Locations</h4>
              <div class="flex gap-3">
                <button 
                  onclick="showAddLocationModal()" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Add Location
                </button>
                <button 
                  onclick="showImportModal()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                >
                  Import Locations
                </button>
              </div>
            </div>

            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsLocationSearch" 
                  type="text" 
                  placeholder="Search locations..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchLocations()"
                />
              </div>
              <div>
                <select 
                  onchange="filterLocationsByStatus(this.value)" 
                  class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Status</option>
                  <option value="occupied">Occupied</option>
                  <option value="available">Available</option>
                </select>
              </div>
            </div>

            <!-- Locations Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Premise ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Owner & Resident</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsLocationsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Location rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Codes Section -->
          <div id="settingsCodesContent" class="hidden">
            <!-- Sewer Charge Setting -->
            <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Sewer Charge</h4>
                  <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Set the default sewer service charge amount</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Amount ($)</label>
                  <input 
                    type="number" 
                    id="sewerChargeInput" 
                    min="0" 
                    step="0.01"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="170.00"
                  />
                </div>
                <div class="flex items-end">
                  <button 
                    onclick="saveSewerCharge()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Save
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <p class="text-xs text-slate-500 dark:text-slate-400" id="sewerChargeStatus"></p>
              </div>
            </div>

            <!-- Late Fee Setting -->
            <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Late Fee</h4>
                  <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Set the default late fee charge amount</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Amount ($)</label>
                  <input 
                    type="number" 
                    id="lateFeeInput" 
                    min="0" 
                    step="0.01"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="20.00"
                  />
                </div>
                <div class="flex items-end">
                  <button 
                    onclick="saveLateFee()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Save
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <p class="text-xs text-slate-500 dark:text-slate-400" id="lateFeeStatus"></p>
              </div>
            </div>

            <!-- PUC Surcharge Setting -->
            <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">PUC Surcharge</h4>
                  <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Set the PUC surcharge percentage (applied to all customers)</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Percentage (%)</label>
                  <input 
                    type="number" 
                    id="pucSurchargeInput" 
                    min="0" 
                    max="100"
                    step="0.01"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0.00"
                  />
                </div>
                <div class="flex items-end">
                  <button 
                    onclick="savePucSurcharge()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Save
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <p class="text-xs text-slate-500 dark:text-slate-400" id="pucSurchargeStatus"></p>
              </div>
            </div>

            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Tax Codes</h4>
              <button 
                onclick="showAddCodeModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add Code
              </button>
            </div>

            <!-- Codes Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Code Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Requirements</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsCodesTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Code rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Users Section -->
          <div id="settingsUsersContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">System Users</h4>
              <button 
                onclick="showAddUserModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add User
              </button>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsUserSearch" 
                  type="text" 
                  placeholder="Search users..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchUsers()"
                />
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Full Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">User Code</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Title</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsUsersTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- User rows populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Data Cleanup Section -->
          <div id="settingsCleanupContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-2">Data Cleanup</h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">
                Tools to clean up and fix data issues in customer records
              </p>
            </div>

            <div class="space-y-4">
              <!-- Today's Date Input for Testing -->
              <div class="bg-slate-50 dark:bg-slate-900/20 p-4 rounded-xl border border-slate-200 dark:border-slate-700 mb-6">
                <h3 class="font-semibold text-slate-800 dark:text-slate-200 mb-2">Test Date</h3>
                <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">
                  Set a test date to simulate how the system behaves on different dates (e.g., when the month changes). Leave empty to use the real current date.
                </p>
                <div class="flex items-center gap-4">
                  <div class="flex-1">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Today's Date</label>
                    <input 
                      type="date" 
                      id="testDateInput" 
                      class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      onchange="setTestDate(this.value)"
                    />
                  </div>
                  <div class="flex items-end">
                    <button 
                      onclick="clearTestDate()" 
                      class="bg-slate-500 text-white px-4 py-2 rounded-lg hover:bg-slate-600 transition-colors font-medium"
                      title="Clear test date and use real current date"
                    >
                      Clear
                    </button>
                  </div>
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-2" id="testDateStatus">
                  Using real current date: <span id="currentDateDisplay"></span>
                </p>
              </div>

              <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-700">
                <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Data Synchronization</h3>
                <p class="text-sm text-blue-600 dark:text-blue-300 mb-4">
                  Re-sync past due amounts from imported Excel data
                </p>
                <button 
                  onclick="syncPastDueFromImportData()" 
                  class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                  title="Re-sync past due amounts from imported Excel data"
                >
                  Sync Past Due Amounts
                </button>
              </div>

              <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-200 dark:border-orange-700">
                <h3 class="font-semibold text-orange-800 dark:text-orange-200 mb-2">Date Fixes</h3>
                <p class="text-sm text-orange-600 dark:text-orange-300 mb-4">
                  Fix Excel serial dates that appear as numbers (like 46053) in customer data
                </p>
                <div class="flex flex-col gap-3">
                  <button 
                    onclick="fixBillDates()" 
                    class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors font-medium"
                    title="Fix Bill Date column in all customer records"
                  >
                    Fix Dates
                  </button>
                  <button 
                    onclick="fixExcelDates()" 
                    class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors font-medium"
                    title="Fix all Excel serial dates (like 46053) in customer importData"
                  >
                    Fix All Excel Dates
                  </button>
                </div>
              </div>

              <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-200 dark:border-green-700">
                <h3 class="font-semibold text-green-800 dark:text-green-200 mb-2">Cycle Number Assignment</h3>
                <p class="text-sm text-green-600 dark:text-green-300 mb-4">
                  Split all accounts evenly across cycles 1-10 (for testing purposes)
                </p>
                <button 
                  onclick="splitAccountsByCycle()" 
                  class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium"
                  title="Split all accounts evenly across cycles 1-10"
                >
                  Split Accounts by Cycle
                </button>
              </div>

              <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl border border-red-200 dark:border-red-700">
                <h3 class="font-semibold text-red-800 dark:text-red-200 mb-2">Credit Management</h3>
                <p class="text-sm text-red-600 dark:text-red-300 mb-4">
                  Reset all accounts with credits so that the credit is removed
                </p>
                <button 
                  onclick="resetCredits()" 
                  class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium"
                  title="Reset all accounts with credits (pastDue < 0) to have pastDue = 0"
                >
                  Reset Credits
                </button>
              </div>

              <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl border border-yellow-200 dark:border-yellow-700">
                <h3 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">Payment History</h3>
                <p class="text-sm text-yellow-600 dark:text-yellow-300 mb-4">
                  Reset all customers who have past payments so the data looks like they never paid any past payments
                </p>
                <button 
                  onclick="resetPayments()" 
                  class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition-colors font-medium"
                  title="Clear all payment history and reset lastPayment to 'Never' for all customers"
                >
                  Reset Payments
                </button>
              </div>

              <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl border border-red-200 dark:border-red-700">
                <h3 class="font-semibold text-red-800 dark:text-red-200 mb-2">Drawers</h3>
                <p class="text-sm text-red-600 dark:text-red-300 mb-4">
                  Reset all drawers by deleting and recreating them, clearing count history and requiring new SOD counts
                </p>
                <button 
                  onclick="resetAllDrawers()" 
                  class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium"
                  title="Reset all drawers and clear their count history"
                >
                  Reset Drawers
                </button>
              </div>

              <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-200 dark:border-indigo-700">
                <h3 class="font-semibold text-indigo-800 dark:text-indigo-200 mb-2">Add Past Due Amount</h3>
                <p class="text-sm text-indigo-600 dark:text-indigo-300 mb-4">
                  Add $50.00 past due amount to account CUS-3000500
                </p>
                <button 
                  onclick="addPastDueAmount()" 
                  class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                  title="Add $50.00 past due to account CUS-3000500"
                >
                  Add Past Due Amount
                </button>
              </div>
            </div>
          </div>

          <!-- Hierarchy Section -->
          <div id="settingsHierarchyContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-2">Payment Application Hierarchy</h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">
                Define the order in which partial payments are applied to different charges. Drag items to reorder.
              </p>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-700 mb-6">
              <p class="text-sm text-blue-600 dark:text-blue-300">
                <strong>How it works:</strong> When a customer makes a partial payment, the payment will be applied in the order shown below. For example, if the order is "Past Due, Late Fee, Tax Codes, PUC Surcharge, Current Due", the payment will first go towards Past Due, then Late Fee, and so on.
              </p>
            </div>

            <div id="hierarchyList" class="space-y-3 mb-6">
              <!-- Hierarchy items will be populated dynamically -->
            </div>

            <div class="flex justify-end gap-3">
              <button 
                onclick="saveHierarchyOrder()" 
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                Save Order
              </button>
            </div>
          </div>

          <!-- Drawers Section -->
          <div id="settingsDrawersContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-2">Drawer Management</h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">
                Manage cash register drawers. POS users will be prompted to select a drawer when they log in.
              </p>
            </div>

            <div class="mb-6">
              <div class="flex flex-col gap-4 mb-4">
                <div class="flex items-center gap-4">
                  <input 
                    type="text" 
                    id="newDrawerName" 
                    placeholder="Enter drawer name (e.g., Drawer 1, Main Register, etc.)"
                    class="flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <input 
                    type="number" 
                    id="newDrawerFund" 
                    step="0.01"
                    min="0"
                    placeholder="Drawer fund value ($)"
                    class="w-48 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <button 
                    onclick="addDrawer()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Add Drawer
                  </button>
                </div>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Drawer Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Fund Value</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsDrawersTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Drawer rows will be populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Toggles Section -->
          <div id="settingsTogglesContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-2">System Toggles</h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">
                Configure system behavior settings
              </p>
            </div>

            <div class="space-y-6">
              <div class="bg-slate-50 dark:bg-slate-900/20 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Ask for user code for each transaction</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-300">
                      When enabled, POS users will be prompted to enter their user code every time they process a payment.
                    </p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input 
                      type="checkbox" 
                      id="toggleUserCodePerTransaction" 
                      class="sr-only peer"
                      onchange="saveTogglesSettings()"
                    />
                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-blue-600"></div>
                  </label>
                </div>
              </div>

              <div class="bg-slate-50 dark:bg-slate-900/20 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Skip POS initial register count</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-300">
                      When enabled, POS users will skip the initial register count screen and go directly to payment processing. The initial count will be assumed to match the supervisor's start of day count.
                    </p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input 
                      type="checkbox" 
                      id="toggleSkipPOSInitialCount" 
                      class="sr-only peer"
                      onchange="saveTogglesSettings()"
                    />
                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-blue-600"></div>
                  </label>
                </div>
              </div>

              <div class="bg-slate-50 dark:bg-slate-900/20 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">After hours log out</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">
                      When enabled, POS users will not be able to log in during the specified time range. This helps enforce after-hours restrictions.
                    </p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input 
                      type="checkbox" 
                      id="toggleAfterHoursLogout" 
                      class="sr-only peer"
                      onchange="saveTogglesSettings(); updateAfterHoursTimeInputs()"
                    />
                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-blue-600"></div>
                  </label>
                </div>
                <div id="afterHoursTimeInputs" class="space-y-3 hidden">
                  <div>
                    <label for="afterHoursStartTime" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Start Time</label>
                    <input 
                      type="time" 
                      id="afterHoursStartTime" 
                      class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                      onchange="saveTogglesSettings()"
                    />
                  </div>
                  <div>
                    <label for="afterHoursEndTime" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">End Time</label>
                    <input 
                      type="time" 
                      id="afterHoursEndTime" 
                      class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                      onchange="saveTogglesSettings()"
                    />
                  </div>
                </div>
              </div>

              <div class="bg-slate-50 dark:bg-slate-900/20 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">POS Doesn't Close Out</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-300">
                      When enabled, the "Close Out Drawer" button will be hidden for POS users, preventing them from closing out their drawer.
                    </p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input 
                      type="checkbox" 
                      id="togglePOSDoesntCloseOut" 
                      class="sr-only peer"
                      onchange="saveTogglesSettings(); if (window.updateButtonVisibility) { window.updateButtonVisibility(window.getEffectiveUser ? window.getEffectiveUser() : null); }"
                    />
                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-blue-600"></div>
                  </label>
                </div>
              </div>

              <div class="bg-slate-50 dark:bg-slate-900/20 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Use username instead of user code</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-300">
                      When enabled, supervisors will not be asked to enter their user code when closing out a drawer. Instead, the system will use their logged-in username.
                    </p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input 
                      type="checkbox" 
                      id="toggleUseUsernameInsteadOfUserCode" 
                      class="sr-only peer"
                      onchange="saveTogglesSettings()"
                    />
                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-blue-600"></div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Action Buttons -->
      <br><br>
      <div class="flex flex-col items-center gap-4 mb-8 p-8 max-w-2xl mx-auto bg-white dark:bg-slate-800 rounded-3xl border border-blue-100 dark:border-slate-700 shadow-md hover:shadow-2xl hover:scale-[1.02] focus-within:shadow-2xl focus-within:scale-[1.02] transition-all duration-300 ease-out cursor-default">
        <button 
          id="addClientButton"
          onclick="showAddClientModule()" 
          class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
          </svg>
          <span class="text-base">Add Client</span>
        </button>

        <button 
          id="makePaymentButton"
          onclick="showPaymentModule()" 
          class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <span class="text-4xl font-black leading-none">$</span>
          <span class="text-base">Payments</span>
        </button>

        <button 
          id="sendBillButton"
          onclick="showBillModule()" 
          class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <span class="text-base">Send Bill</span>
        </button>

        <button 
          id="searchDatabaseButton"
          onclick="showSearchModule()" 
          class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span class="text-base">Search Clients</span>
        </button>

        <button 
          id="drawerCountButton"
          onclick="showDrawerCountSelection()" 
          class="w-full bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4 hidden"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
          </svg>
          <span class="text-base">Start Of Day Drawer Count</span>
        </button>

        <button 
          id="settingsButton"
          onclick="showSettingsModule()" 
          class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span class="text-base">Settings</span>
        </button>

        <button 
          id="logoutButton"
          onclick="logout()" 
          class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4 hidden"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          <span class="text-base">Log Out</span>
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex space-x-1 mb-6 hidden">
        <button 
          id="accountsTab"
          onclick="switchView('accounts')" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
        >
          Accounts
        </button>
        <button 
          id="locationsTab"
          onclick="switchView('locations')" 
          class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
        >
          Locations
        </button>
      </div>

      <!-- Accounts Section -->
      <div id="accountsContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Accounts</h2>
          <div class="flex flex-col gap-2">
            <button 
              onclick="showAddCustomerModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add New Customer
            </button>
            <button 
              onclick="showImportCustomerDataModal()" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm"
            >
              Import Customer Data
            </button>
            <button 
              onclick="syncPastDueFromImportData()" 
              class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm"
              title="Re-sync past due amounts from imported Excel data"
            >
              Sync Past Due Amounts
            </button>
                <button 
                  onclick="fixBillDates()" 
                  class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm"
                  title="Fix Bill Date column in all customer records"
                >
                  Fix Dates
                </button>
                <button 
                  onclick="fixExcelDates()" 
                  class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors text-sm"
                  title="Fix all Excel serial dates (like 46053) in customer importData"
                >
                  Fix All Excel Dates
            </button>
            <button 
              onclick="deleteAllUserData()" 
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
            >
              Delete User Data
            </button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <input 
              id="customerSearch" 
              type="text" 
              placeholder="Search customers..." 
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeyup="searchCustomers()"
            />
          </div>
          <div>
            <select 
              onchange="filterByStatus(this.value)" 
              class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="current">Current</option>
              <option value="overdue">Overdue</option>
              <option value="no-codes">No codes</option>
              <option value="has-codes">Has codes</option>
            </select>
          </div>
        </div>

        <!-- Customer Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Account</th>
                <th class="px-0 py-3 pr-0 -mr-2 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Customer</th>
                <th class="px-0 py-3 pl-0 -ml-2 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Property</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Due Date</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Last Payment</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="customerTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Customer rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Locations Section -->
      <div id="locationsContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Property Locations</h2>
          <div class="flex gap-3">
            <button 
              onclick="showAddLocationModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add Location
            </button>
            <button 
              onclick="showImportModal()" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
            >
              Import Locations
            </button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <input 
              id="locationSearch" 
              type="text" 
              placeholder="Search locations..." 
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeyup="searchLocations()"
            />
          </div>
          <div>
            <select 
              onchange="filterLocationsByStatus(this.value)" 
              class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="occupied">Occupied</option>
              <option value="available">Available</option>
            </select>
          </div>
        </div>

        <!-- Locations Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Premise ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Owner & Resident</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="locationsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Location rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Customer</h3>
          <button 
            onclick="hideAddCustomerModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addCustomerForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              id="newCustomerName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter customer's full name"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
            <input 
              id="newCustomerEmail" 
              type="email" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="customer@email.com"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <input 
              id="newCustomerPhone" 
              type="tel" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="(916) 555-0123"
              oninput="formatPhoneInput(this)"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <select 
              id="newCustomerLocation" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">Select a property location</option>
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <select 
              id="newCustomerEntityType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select Entity Type</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Farmer">Farmer</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
            <input 
              id="newCustomerSSN" 
              type="text" 
              oninput="formatSSNInput(this)"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="xxx-xx-xxxx"
              maxlength="11"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
            <select 
              id="newCustomerIDType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select ID Type</option>
              <option value="Drivers License">Drivers License</option>
              <option value="ID">ID</option>
              <option value="Passport">Passport</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
            <input 
              id="newCustomerIDNumber" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter ID number"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
            <input 
              id="newCustomerSecondaryContactName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter secondary contact name"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
            <input 
              id="newCustomerSecondaryContactPhone" 
              type="tel" 
              oninput="formatPhoneInput(this)"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="(xxx)-xxx-xxxx"
            />
          </div>

          <div class="mt-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
                <input 
                  id="newCustomerMailingStreet" 
                  type="text" 
                  class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter street address"
                />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
                  <input 
                    id="newCustomerMailingCity" 
                    type="text" 
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter city"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
                  <select 
                    id="newCustomerMailingState" 
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">Select State</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                <input 
                  id="newCustomerMailingZip" 
                  type="text" 
                  class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter ZIP code"
                  maxlength="10"
                />
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
            <div class="flex gap-2 mb-4">
              <select 
                id="newCustomerCodeSelect" 
                class="flex-1 px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select a code...</option>
              </select>
              <button 
                type="button"
                onclick="addCustomerCode()" 
                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors"
              >
                Add Code
              </button>
            </div>
            <div id="newCustomerCodesList" class="space-y-2">
              <!-- Selected codes will be displayed here -->
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <input 
                type="number" 
                id="newCustomerFactor" 
                step="any"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter factor"
              >
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Cycle Number</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cycle Number</label>
              <input 
              type="number" 
              id="newCustomerCycleNumber" 
              min="1"
              max="10"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter cycle number (1-10)"
              >
            </div>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Note:</strong> The customer will be able to log in using their email address and the temporary password "password".
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddCustomerModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addCustomer()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Customer
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Location Modal -->
    <div id="addLocationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Location</h3>
          <button 
            onclick="hideAddLocationModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addLocationForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Premise ID</label>
            <input 
              id="newLocationPremiseId" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-600 text-slate-800 dark:text-slate-200"
              readonly
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
            <input 
              id="newLocationStreet" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="123 Main Street"
              required
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <input 
                id="newLocationCity" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Sacramento"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <input 
                id="newLocationState" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="CA"
                required
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
            <input 
              id="newLocationZip" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="95814"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddLocationModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addLocation()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Location
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add System User</h3>
          <button 
            onclick="hideAddUserModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form class="space-y-4" onsubmit="event.preventDefault(); addUser();">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              id="newUserFullName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter full name"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">User Code</label>
            <input 
              id="newUserCode" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter user code (optional)"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Title</label>
            <select 
              id="newUserTitle" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">Select a title</option>
              <option value="Point Of Sale">Point Of Sale</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Admin">Admin</option>
            </select>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              Users are stored in the users collection in Firestore using their full name.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddUserModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="submit"
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add User
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Record Payment</h3>
          <button 
            onclick="hidePaymentModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="paymentCustomerName"></span></h4>
            <p class="text-sm text-blue-800 dark:text-blue-200">Current Balance: <span id="paymentCurrentAmount" class="font-bold"></span></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
            <input 
              id="paymentAmount" 
              type="number" 
              step="0.01"
              min="0.01"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter payment amount"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hidePaymentModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="processPayment()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Record Payment
            </button>
          </div>
        </div>

        <!-- Hidden input for tracking -->
        <input type="hidden" id="paymentCustomerId" />
      </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-4xl w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment History - <span id="historyCustomerName"></span></h3>
          <button 
            onclick="hidePaymentHistory()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Paid</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Remaining Balance</th>
              </tr>
            </thead>
            <tbody id="paymentHistoryBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Payment history rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <div class="mt-6">
          <button 
            type="button"
            onclick="hidePaymentHistory()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Amount Details Modal -->
    <div id="amountDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAmountDetails()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4 max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6 flex-shrink-0">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Amount Breakdown</h3>
          <button 
            onclick="hideAmountDetails()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4 overflow-y-auto flex-1 pr-2">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="amountDetailsCustomer"></span></h4>
            <div class="space-y-2 pt-2 border-t border-blue-200 dark:border-blue-700 mt-2">
              <div class="flex justify-between items-center" id="amountDetailsFactorRow" style="display: none;">
                <span class="text-sm text-blue-600 dark:text-blue-300">Factor</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsFactor">1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Due Date</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsDueDate">--/--/----</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Billing Cycle</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsBillingCycle">--/--/-- - --/--/--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Last Payment Date</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsLastPayment">Never</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Last Payment Amount</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsLastPaymentAmount">$0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Last Amount Due</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsLastAmountDue">$0.00</span>
              </div>
              <div class="flex justify-center mt-2">
                <button 
                  id="viewAllPaymentsBtn"
                  onclick="showAllPaymentsModal()" 
                  class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium underline"
                  style="display: none;"
                >
                  View All Previous Payments
                </button>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <!-- Sewer Charge Summary + Details -->
            <div id="amountDetailsSewerSummaryRow">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
                <div class="flex items-center gap-2">
                  <span class="text-slate-600 dark:text-slate-400">Sewer Charge</span>
                  <button
                    type="button"
                    id="amountDetailsSewerToggleBtn"
                    onclick="toggleAmountDetailsSection('sewer')"
                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
                  >
                    View details
                  </button>
            </div>
                <span class="font-medium" id="amountDetailsSewerTotal">$0.00</span>
              </div>
              <div id="amountDetailsSewerDetails" class="hidden mt-2 space-y-2 bg-slate-50 dark:bg-slate-700/40 rounded-xl p-3">
                <!-- Filled by showAmountDetails() -->
              </div>
            </div>

            <div id="amountDetailsFactorContainer"></div>

            <!-- Tax Codes Summary + Details -->
            <div id="amountDetailsTaxCodesSummaryRow" class="hidden">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
                <div class="flex items-center gap-2">
                  <span class="text-slate-600 dark:text-slate-400">Charge Codes</span>
                  <button
                    type="button"
                    id="amountDetailsTaxCodesToggleBtn"
                    onclick="toggleAmountDetailsTaxCodes()"
                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
                  >
                    View details
                  </button>
                </div>
                <span class="font-medium" id="amountDetailsTaxCodesTotal">$0.00</span>
              </div>
              <div id="amountDetailsTaxCodesDetails" class="hidden mt-2 space-y-2 bg-slate-50 dark:bg-slate-700/40 rounded-xl p-3">
                <!-- Filled by showAmountDetails() -->
              </div>
            </div>
            <!-- Legacy containers kept for compatibility; left empty -->
            <div id="amountDetailsCodesContainer" class="hidden"></div>
            <div id="amountDetailsPucSurchargeContainer" class="hidden"></div>

            <!-- Late Fee Summary + Details -->
            <div id="amountDetailsLateFeeSummaryRow" class="hidden">
              <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
                <div class="flex items-center gap-2">
                  <span class="text-slate-600 dark:text-slate-400">Late Fee</span>
                  <button
                    type="button"
                    id="amountDetailsLateFeeToggleBtn"
                    onclick="toggleAmountDetailsSection('latefee')"
                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
                  >
                    View details
                  </button>
                </div>
                <span class="font-medium" id="amountDetailsLateFeeTotal">$0.00</span>
              </div>
              <div id="amountDetailsLateFeeDetails" class="hidden mt-2 space-y-2 bg-slate-50 dark:bg-slate-700/40 rounded-xl p-3">
                <!-- Filled by showAmountDetails() -->
              </div>
            </div>

            <!-- Past Due Summary + Details -->
            <div id="amountDetailsPastDueSummaryRow" class="hidden">
              <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
                <div class="flex items-center gap-2">
              <span class="text-slate-600 dark:text-slate-400">Past Due</span>
                  <button
                    type="button"
                    id="amountDetailsPastDueToggleBtn"
                    onclick="toggleAmountDetailsSection('pastdue')"
                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
                  >
                    View details
                  </button>
                </div>
                <span class="font-medium" id="amountDetailsPastDueTotal">$0.00</span>
              </div>
              <div id="amountDetailsPastDueDetails" class="hidden mt-2 space-y-2 bg-slate-50 dark:bg-slate-700/40 rounded-xl p-3">
                <!-- Filled by showAmountDetails() -->
              </div>
            </div>

            <div style="height: 1rem;"></div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="font-bold text-slate-800 dark:text-slate-200">Current Due</span>
              <span class="font-bold text-slate-800 dark:text-slate-200" id="amountDetailsCurrentDue">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600" id="amountDetailsPastDueRow">
              <span class="font-bold text-slate-800 dark:text-slate-200">Past Due</span>
              <span class="font-bold text-slate-800 dark:text-slate-200 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 p-2 rounded" 
                    id="amountDetailsPastDue" 
                    ondblclick="editPastDueFromModal()"
                    title="Double-click to edit">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600" id="amountDetailsCreditRow" style="display: none;">
              <span class="font-bold text-green-600 dark:text-green-400">Credit</span>
              <span class="font-bold text-green-600 dark:text-green-400" id="amountDetailsCredit">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600" id="amountDetailsLateFeeRow" style="display: none;">
              <span class="font-bold text-slate-800 dark:text-slate-200">Late Fee</span>
              <span class="font-bold text-slate-800 dark:text-slate-200" id="amountDetailsLateFee">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-3 bg-slate-50 dark:bg-slate-700 rounded-lg px-4">
              <span class="font-semibold text-slate-800 dark:text-slate-200">Total Due</span>
              <span class="font-bold text-lg" id="amountDetailsTotal">$0.00</span>
            </div>
            </div>
          </div>

          <button 
            type="button"
            onclick="hideAmountDetails()" 
          class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 flex-shrink-0 mt-4"
          >
            Close
          </button>
      </div>
    </div>

    <!-- Edit Field Modal -->
    <div id="editFieldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Edit <span id="editFieldType">Field</span></h3>
          <button 
            onclick="cancelFieldEdit()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">New Value</label>
            <div id="editFieldInputContainer">
              <input 
                id="editFieldValue" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter new value"
                required
              />
            </div>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Tip:</strong> For status, use "available" or "occupied". For residents, use "Available" to make the property available.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="cancelFieldEdit()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="saveFieldEdit()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Save Changes
            </button>
          </div>
        </div>

        <!-- Hidden inputs for tracking -->
        <input type="hidden" id="editFieldLocationId" />
        <input type="hidden" id="editFieldFieldType" />
      </div>
    </div>

    <!-- Import Locations Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Import Locations</h3>
          <button 
            onclick="hideImportModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select JSON File</label>
            <input 
              id="locationFileInput" 
              type="file" 
              accept=".json"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">
            <p class="text-sm text-green-800 dark:text-green-200">
              <strong>JSON Format:</strong> Your file should contain a "locations" array with objects having properties like id, address, propertyType, bedrooms, bathrooms, squareFootage.
            </p>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Sample:</strong> You can use the provided locations.json file as a template.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideImportModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="importLocations()" 
              class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200"
            >
              Import Locations
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Customer Data Modal -->
    <div id="importCustomerDataModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Import Customer Data</h3>
          <button 
            onclick="hideImportCustomerDataModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Excel File (ImportData.xlsx)</label>
            <input 
              id="customerDataFileInput" 
              type="file" 
              accept=".xlsx,.xls"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Note:</strong> All data from the Excel file will be imported and saved to Firebase. The first row should contain column headers. The system will match customers by account number if they already exist, or create new ones.
            </p>
          </div>

          <div id="importPreview" class="hidden">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Preview (first 5 rows)</h4>
            <div class="overflow-x-auto border border-slate-300 dark:border-slate-600 rounded-lg">
              <table id="previewTable" class="min-w-full text-sm">
                <thead class="bg-slate-100 dark:bg-slate-700">
                  <!-- Headers will be populated by JavaScript -->
                </thead>
                <tbody class="bg-white dark:bg-slate-800">
                  <!-- Rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Import Progress Indicator -->
          <div id="importProgress" class="hidden">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl border-2 border-blue-500 mb-4">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-blue-800 dark:text-blue-200">Importing Customer Data...</h4>
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
              </div>
              <div class="space-y-2">
                <div class="flex justify-between text-sm text-blue-700 dark:text-blue-300">
                  <span>Progress:</span>
                  <span id="progressText" class="font-semibold">0 / 0</span>
                </div>
                <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-3">
                  <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="text-xs text-blue-600 dark:text-blue-400 mt-2">
                  <span id="progressStats">Processing...</span>
                </div>
              </div>
            </div>

            <!-- Firestore Upload Progress Indicator -->
            <div id="uploadProgress" class="hidden">
              <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-xl border-2 border-green-500 mb-4">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-lg font-semibold text-green-800 dark:text-green-200">Uploading customers to database</h4>
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                </div>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm text-green-700 dark:text-green-300">
                    <span>Progress:</span>
                    <span id="uploadProgressText" class="font-semibold">0 / 0</span>
                  </div>
                  <div class="w-full bg-green-200 dark:bg-green-800 rounded-full h-3">
                    <div id="uploadProgressBar" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-green-600 dark:text-green-400 mt-2">
                    <span id="uploadProgressStats">Uploading...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Locations Upload Progress Indicator -->
            <div id="locationsUploadProgress" class="hidden">
              <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-xl border-2 border-purple-500">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-lg font-semibold text-purple-800 dark:text-purple-200">Uploading locations to database</h4>
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                </div>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm text-purple-700 dark:text-purple-300">
                    <span>Progress:</span>
                    <span id="locationsUploadProgressText" class="font-semibold">0 / 0</span>
                  </div>
                  <div class="w-full bg-purple-200 dark:bg-purple-800 rounded-full h-3">
                    <div id="locationsUploadProgressBar" class="bg-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-purple-600 dark:text-purple-400 mt-2">
                    <span id="locationsUploadProgressStats">Uploading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideImportCustomerDataModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="importCustomerData()" 
              class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200"
            >
              Import Customer Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="paymentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Breakdown</h3>
          <button 
            onclick="hidePaymentDetailsModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="paymentDetailsCustomer"></span></h4>
          </div>

          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
              <span class="font-medium" id="paymentDetailsService">$150.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Late Fee</span>
              <span class="font-medium" id="paymentDetailsLateFee">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-3 bg-slate-50 dark:bg-slate-700 rounded-lg px-4">
              <span class="font-semibold text-slate-800 dark:text-slate-200">Total Due</span>
              <span class="font-bold text-lg" id="paymentDetailsTotal">$0.00</span>
            </div>
          </div>

          <button 
            type="button"
            onclick="hidePaymentDetailsModal()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Transfer Ownership Modal -->
    <div id="transferOwnershipModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Transfer Property Ownership</h3>
          <button 
            onclick="hideTransferOwnershipModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">⚠️ Location Already Occupied</h4>
            <p class="text-sm text-yellow-700 dark:text-yellow-300">
              This location is currently being used by <strong id="transferWarningName"></strong> at <strong id="transferLocation"></strong>.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <h5 class="font-semibold text-slate-800 dark:text-slate-200 mb-3">Current Resident</h5>
              <div class="space-y-2">
                <p><span class="text-slate-600 dark:text-slate-400">Name:</span> <span id="transferCurrentResident"></span></p>
                <p><span class="text-slate-600 dark:text-slate-400">Status:</span> <span id="transferCurrentStatus"></span></p>
                <p><span class="text-slate-600 dark:text-slate-400">Balance:</span> <span id="transferBalance"></span></p>
              </div>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
              <h5 class="font-semibold text-blue-800 dark:text-blue-200 mb-3">New Client</h5>
              <div class="space-y-2">
                <p><span class="text-blue-600 dark:text-blue-400">Name:</span> <span id="transferNewClient"></span></p>
                <p class="text-sm text-blue-600 dark:text-blue-400">Will be assigned to this location</p>
              </div>
            </div>
          </div>

          <div id="transferStatusMessage" class="p-4 rounded-xl">
            <!-- Status message will be populated by JavaScript -->
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              New Location for <span id="transferNewLocationLabel"></span>
            </label>
            <input 
              id="transferNewLocation" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter the new address where they're moving"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideTransferOwnershipModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="processTransferOwnership()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Transfer Ownership
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Code Modal -->
    <div id="addCodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Code</h3>
          <button 
            onclick="hideAddCodeModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addCodeForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Code Name</label>
            <input 
              id="newCodeName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter code name"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Type</label>
            <select 
              id="newCodeType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onchange="updateCodeAmountInput()"
              required
            >
              <option value="percentage">Percentage</option>
              <option value="flat">Flat Rate</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Amount</label>
            <input 
              id="newCodeAmount" 
              type="number" 
              step="0.01"
              min="0"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter amount"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Description</label>
            <textarea 
              id="newCodeDescription" 
              rows="3"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter description"
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Requirements</label>
            <div id="newCodeRequirementsList" class="mb-2 space-y-2">
              <!-- Selected requirements will be displayed here -->
            </div>
            <button 
              type="button"
              onclick="showAddRequirementModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
            >
              Add requirement
            </button>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddCodeModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addCode()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Code
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Code Field Modal -->
    <div id="editCodeFieldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Edit <span id="editCodeFieldType">Field</span></h3>
          <button 
            onclick="cancelEditCodeField()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">New Value</label>
            <div id="editCodeFieldInputContainer">
              <!-- Input will be dynamically inserted here -->
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="cancelEditCodeField()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="saveEditCodeField()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Save Changes
            </button>
          </div>
        </div>

        <!-- Hidden inputs for tracking -->
        <input type="hidden" id="editCodeFieldCodeId" />
        <input type="hidden" id="editCodeFieldFieldType" />
      </div>
    </div>

    <!-- Add Requirement Modal -->
    <div id="addRequirementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAddRequirementModal()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add Requirement</h3>
          <button 
            onclick="hideAddRequirementModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-4">Select Requirements</label>
            <div class="space-y-3">
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="requirementBusiness" 
                  class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementBusiness" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  Business
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="requirementIndividual" 
                  class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementIndividual" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  Individual
                </label>
              </div>
            </div>
          </div>

          <div class="border-t border-slate-200 dark:border-slate-600 pt-4">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">Logic Type</label>
            <div class="space-y-2">
              <div class="flex items-center">
                <input 
                  type="radio" 
                  id="requirementLogicAND" 
                  name="requirementLogic"
                  value="AND"
                  checked
                  class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementLogicAND" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  AND (both must be selected)
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="radio" 
                  id="requirementLogicOR" 
                  name="requirementLogic"
                  value="OR"
                  class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementLogicOR" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  OR (at least one must be selected)
                </label>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddRequirementModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addRequirement()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Full Info Modal -->
    <div id="customerFullInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideCustomerFullInfo()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Information</h3>
          <button 
            onclick="hideCustomerFullInfo()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="customerFullInfoContent" class="space-y-4">
          <!-- Content will be populated by JavaScript -->
        </div>

        <div class="mt-6">
          <button 
            type="button"
            onclick="hideCustomerFullInfo()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Customer Data Profile Modal (Excel Preview) -->
    <div id="customerDataProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideCustomerDataProfile()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Data Profile (Excel Preview)</h3>
          <button 
            onclick="hideCustomerDataProfile()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="customerDataProfileContent" class="space-y-4">
          <!-- Excel-like table will be populated by JavaScript -->
        </div>

        <div class="mt-6 space-y-3">
          <button 
            type="button"
            onclick="copyFullDataProfile()" 
            class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-purple-700 transition-colors duration-200"
          >
            Copy Full Data Profile
          </button>
          <button 
            type="button"
            onclick="hideCustomerDataProfile()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Customer Data Progress Modal -->
    <div id="deleteProgressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Deleting Customer Data</h3>
        </div>

        <div id="deleteProgress" class="hidden">
          <div class="bg-red-50 dark:bg-red-900/20 p-6 rounded-xl border-2 border-red-500 mb-4">
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-lg font-semibold text-red-800 dark:text-red-200">Deleting Customers...</h4>
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
            </div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm text-red-700 dark:text-red-300">
                <span>Progress:</span>
                <span id="deleteProgressText" class="font-semibold">0 / 0</span>
              </div>
              <div class="w-full bg-red-200 dark:bg-red-800 rounded-full h-3">
                <div id="deleteProgressBar" class="bg-red-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <div class="text-xs text-red-600 dark:text-red-400 mt-2">
                <span id="deleteProgressStats">Deleting...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
