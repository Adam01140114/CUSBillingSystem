<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>CUS Billing - Admin Portal</title>
  <!-- IMPORTANT: Include auth.js in <head> to check auth before page loads -->
  <script src="auth.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- JSZip for creating zip files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, getDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCxfnleg4jI9C3xPI_UabT81vIsnPjukSY",
      authDomain: "cus-billing-e84eb.firebaseapp.com",
      projectId: "cus-billing-e84eb",
      storageBucket: "cus-billing-e84eb.firebasestorage.app",
      messagingSenderId: "606152504829",
      appId: "1:606152504829:web:6d14518df4a56ecfe81594",
      measurementId: "G-FKLJNHMWHV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Firebase Authentication helper functions
    window.firebaseAuth = {
      // Sign in with Firebase Auth (called after password verification)
      signIn: async function(email, password) {
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          console.log('[FIREBASE AUTH] Successfully signed in:', userCredential.user.uid);
          return { success: true, user: userCredential.user };
        } catch (error) {
          console.error('[FIREBASE AUTH] Sign in error:', error);
          return { success: false, error: error.message };
        }
      },
      // Sign out
      signOut: async function() {
        try {
          await signOut(auth);
          console.log('[FIREBASE AUTH] Signed out successfully');
        } catch (error) {
          console.error('[FIREBASE AUTH] Sign out error:', error);
        }
      },
      // Get current user
      getCurrentUser: function() {
        return auth.currentUser;
      },
      // Wait for auth state
      waitForAuth: function() {
        return new Promise((resolve) => {
          const unsubscribe = onAuthStateChanged(auth, (user) => {
            unsubscribe();
            resolve(user);
          });
        });
      }
    };

    // Sample admin credentials
    const adminCredentials = {
      email: 'admin@cus.com',
      password: 'admin123'
    };

    // Customer data (starts empty, customers added through admin interface)
    let customers = [];

    // Locations data (starts empty, locations added through import or admin interface)
    let locations = [];

    // Users data (managed from the Settings module)
    let users = [];

    // Tax codes data (starts empty, codes added through admin interface)
    let codes = [];

    // Track deleted code names to prevent them from being recreated
    let deletedCodeNames = new Set();

    // Sewer charge setting (defaults to 170, loaded from Firebase)
    let sewerCharge = 170;

    // Late fee setting (defaults to 20, loaded from Firebase)
    let lateFee = 20;

    // PUC Surcharge setting (defaults to 0, loaded from Firebase, applied as percentage to all customers)
    let pucSurcharge = 0;

    // Payment batch tracking
    window.paymentBatches = [];
    window.currentPaymentBatch = null;

    function logBatch(message, data) {
      const payload = data !== undefined ? data : '';

    }

    // Format phone number as (xxx)-xxx-xxxx
    function formatPhoneNumber(phone) {
      // Handle null, undefined, or non-string values
      if (!phone) {
        return 'N/A';
      }
      
      // Convert to string if it's a number
      const phoneStr = String(phone);
      
      // Remove all non-digit characters
      const cleaned = phoneStr.replace(/\D/g, '');

      // Format as (xxx)-xxx-xxxx
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0, 3)})-${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
      }

      // Return original if not 10 digits
      return phone;
    }

    // Format phone number input as user types
    window.formatPhoneInput = function(input) {
      let value = input.value.replace(/\D/g, ''); // Remove all non-digits

      if (value.length >= 6) {
        // Format as (xxx)-xxx-xxxx
        value = `(${value.slice(0, 3)})-${value.slice(3, 6)}-${value.slice(6, 10)}`;
      } else if (value.length >= 3) {
        // Format as (xxx)-xxx
        value = `(${value.slice(0, 3)})-${value.slice(3)}`;
      } else if (value.length > 0) {
        // Format as (xxx
        value = `(${value}`;
      }

      input.value = value;
    };

    // Format SSN input as user types (xxx-xx-xxxx)
    window.formatSSNInput = function(input) {
      let value = input.value.replace(/\D/g, ''); // Remove all non-digits

      if (value.length >= 5) {
        // Format as xxx-xx-xxxx
        value = `${value.slice(0, 3)}-${value.slice(3, 5)}-${value.slice(5, 9)}`;
      } else if (value.length >= 3) {
        // Format as xxx-xx
        value = `${value.slice(0, 3)}-${value.slice(3)}`;
      }

      input.value = value;
    };

    // Format date as mm/dd/yyyy
    function formatDate(dateString) {
      if (!dateString || dateString === 'Never') {
        return 'Never';
      }

      // If already in mm/dd/yyyy format, return as is
      if (dateString.includes('/')) {
        return dateString;
      }

      // If in yyyy-mm-dd format, convert to mm/dd/yyyy
      if (dateString.includes('-')) {
        const parts = dateString.split('-');
        if (parts.length === 3) {
          return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
      }

      return dateString;
    }

    // Firestore functions
    async function saveLocationsToFirestore(progressCallback) {
      try {
        const locationsRef = collection(db, 'locations');
        // Clear existing locations first
        const existingLocations = await getDocs(locationsRef);
        const deletePromises = [];
        existingLocations.forEach(doc => {
          deletePromises.push(deleteDoc(doc.ref));
        });
        await Promise.all(deletePromises);

        // Add all current locations
        const totalLocations = locations.length;
        let savedCount = 0;
        for (const location of locations) {
          await addDoc(locationsRef, location);
          savedCount++;

          // Update progress every location (or every 10 for console)
          if (savedCount % 10 === 0 || savedCount === totalLocations) {

          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalLocations) * 100);
            progressCallback(savedCount, totalLocations, percent);
          }
        }

      } catch (error) {

        throw error; // Re-throw to be caught by caller
      }
    }

    async function loadLocationsFromFirestore() {
      try {
        const locationsRef = collection(db, 'locations');
        const snapshot = await getDocs(locationsRef);
        locations = [];
        snapshot.forEach(doc => {
          locations.push({ id: doc.id, ...doc.data() });
        });
        filteredLocations = [...locations];
        updateLocationsTable();

      } catch (error) {

      }
    }

    // Save all customers to Firestore (used for imports - replaces all customers)
    async function saveAllCustomersToFirestore(progressCallback) {
      try {
        console.log('[SAVE ALL CUSTOMERS] Starting save all customers to Firestore...');
        console.log('[SAVE ALL CUSTOMERS] Total customers to save:', customers.length);
        
        const customersRef = collection(db, 'customers');

        // Clear existing customers first (only for full imports) - use batches for deletion too
        console.log('[SAVE ALL CUSTOMERS] Deleting existing customers...');
        const existingCustomers = await getDocs(customersRef);
        const customerDocs = [];
        existingCustomers.forEach(doc => {
          customerDocs.push(doc);
        });

        // Delete in batches of 500 (Firestore batch limit)
        const deleteBatchSize = 500;
        for (let i = 0; i < customerDocs.length; i += deleteBatchSize) {
          const batch = writeBatch(db);
          const batchDocs = customerDocs.slice(i, Math.min(i + deleteBatchSize, customerDocs.length));
          batchDocs.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          // Small delay between batches to avoid rate limiting
          if (i + deleteBatchSize < customerDocs.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        console.log('[SAVE ALL CUSTOMERS] Deleted', customerDocs.length, 'existing customers');

        // Add all current customers using batch writes (500 operations per batch)
        const totalCustomers = customers.length;
        const batchSize = 500; // Firestore batch limit
        let savedCount = 0;

        for (let i = 0; i < customers.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchCustomers = customers.slice(i, Math.min(i + batchSize, customers.length));
          
          batchCustomers.forEach(customer => {
            const customerRef = doc(customersRef, customer.id);
            batch.set(customerRef, customer);
          });

          await batch.commit();
          savedCount += batchCustomers.length;

          // Update progress
          if (savedCount % 100 === 0 || savedCount === totalCustomers) {
            console.log(`[SAVE ALL CUSTOMERS] Saved ${savedCount} / ${totalCustomers} customers`);
          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalCustomers) * 100);
            progressCallback(savedCount, totalCustomers, percent);
          }

          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customers.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        
        console.log('[SAVE ALL CUSTOMERS] Successfully saved', savedCount, 'of', totalCustomers, 'customers to Firestore');
      } catch (error) {
        console.error('[SAVE ALL CUSTOMERS] Error saving all customers to Firestore:', error);
        throw error; // Re-throw to be caught by caller
      }
    }

    // Save/update customers to Firestore (used for regular updates - updates existing customers)
    async function saveCustomersToFirestore(progressCallback) {
      try {
        console.log('[SAVE CUSTOMERS] Starting save customers to Firestore (update mode)...');
        console.log('[SAVE CUSTOMERS] Total customers to save:', customers.length);
        
        const customersRef = collection(db, 'customers');
        const totalCustomers = customers.length;
        const batchSize = 500; // Firestore batch limit
        let savedCount = 0;
        
        // Use batch writes to reduce API calls
        for (let i = 0; i < customers.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchCustomers = customers.slice(i, Math.min(i + batchSize, customers.length));
          
          batchCustomers.forEach(customer => {
            try {
              const customerRef = doc(customersRef, customer.id);
              batch.set(customerRef, customer);
            } catch (customerError) {
              console.error(`[SAVE CUSTOMERS] Error preparing customer ${customer.id} (${customer.name}):`, customerError);
            }
          });

          await batch.commit();
          savedCount += batchCustomers.length;

          // Update progress every 100 customers
          if (savedCount % 100 === 0 || savedCount === totalCustomers) {
            console.log(`[SAVE CUSTOMERS] Saved ${savedCount} / ${totalCustomers} customers`);
          }

          // Call progress callback if provided
          if (progressCallback) {
            const percent = Math.round((savedCount / totalCustomers) * 100);
            progressCallback(savedCount, totalCustomers, percent);
          }

          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customers.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        
        console.log('[SAVE CUSTOMERS] Successfully saved', savedCount, 'of', totalCustomers, 'customers to Firestore');
      } catch (error) {
        console.error('[SAVE CUSTOMERS] Error saving customers to Firestore:', error);
        throw error; // Re-throw to be caught by caller
      }
    }

    // Save a single customer to Firestore (avoid updating all customers)
    async function saveSingleCustomerToFirestore(customer) {
      if (!customer || !customer.id) {
        throw new Error('Customer object with valid id is required');
      }
      const customersRef = collection(db, 'customers');
      const customerRef = doc(customersRef, customer.id);
      await setDoc(customerRef, customer);
    }

    async function loadCustomersFromFirestore() {
      try {
        const customersRef = collection(db, 'customers');
        const snapshot = await getDocs(customersRef);
        customers = [];
        snapshot.forEach(doc => {
          const customer = { id: doc.id, ...doc.data() };
          // Only populate codes from importData if customer doesn't already have codes saved
          // This preserves codes that were added via "Apply to All" or manually
          if (customer.importData && (!customer.codes || customer.codes.length === 0)) {
            populateCustomerCodesFromImportData(customer);
          }
          customers.push(customer);
        });
        filteredCustomers = [...customers];

        updateCustomerTable();
        populatePaymentCustomerSelect();

        // Save codes to Firestore if any new codes were added during customer load
        // NOTE: Since loadCodesFromFirestore() now runs FIRST, codes are already loaded.
        // This will only save if ensureCodeExists() created any NEW codes that weren't in Firestore.
        // If codes already existed, ensureCodeExists() will find them and return them, so no new codes are created.
        if (codes.length > 0) {

          // Only save if there might be new codes (codes that were just created by ensureCodeExists)
          // Since codes are loaded first, this should rarely happen, but we save to be safe
          await saveCodesToFirestore();

        } else {

        }
      } catch (error) {

      }
    }

    async function saveCodesToFirestore() {
      try {

        const codesRef = collection(db, 'codes');

        // Get existing codes to find ones that should be deleted
        const existingCodes = await getDocs(codesRef);
        const existingCodeIds = new Set(existingCodes.docs.map(doc => doc.id));
        const currentCodeIds = new Set(codes.map(code => code.id));

        // Delete codes that no longer exist
        const deletePromises = [];
        existingCodes.forEach(doc => {
          if (!currentCodeIds.has(doc.id)) {
            deletePromises.push(deleteDoc(doc.ref));
          }
        });
        if (deletePromises.length > 0) {

          await Promise.all(deletePromises);
        }

        // Save all current codes using their ID as the document ID
        for (const code of codes) {
          const codeRef = doc(codesRef, code.id);

          // Build the code object to save - preserve ALL fields from the code object
          // Use spread operator to copy all properties, then ensure amount/percentage are set correctly
          const codeToSave = {
            ...code,
            // Ensure amount is set - use code.amount if it exists (even if 0), otherwise fall back to percentage or 0
            amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
            // For percentage type, sync percentage with amount if amount is set, otherwise use percentage or 0
            percentage: code.type === 'percentage' && code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0)
          };

          await setDoc(codeRef, codeToSave);

          // Verify what was actually saved by reading it back immediately
          const verifyDoc = await getDoc(codeRef);
          const verifyData = verifyDoc.data();

        }

      } catch (error) {

        throw error; // Re-throw so caller can handle it
      }
    }

    async function loadCodesFromFirestore() {
      try {
        // First, load deleted code names to prevent recreation
        try {
          const deletedCodesRef = doc(db, 'settings', 'deletedCodeNames');
          const deletedCodesDoc = await getDoc(deletedCodesRef);
          if (deletedCodesDoc.exists()) {
            const data = deletedCodesDoc.data();
            if (data.names && Array.isArray(data.names)) {
              deletedCodeNames = new Set(data.names);
              console.log('[LOAD CODES] Loaded deleted code names:', Array.from(deletedCodeNames));
            }
          }
        } catch (error) {
          console.error('[LOAD CODES] Error loading deleted code names:', error);
        }

        const codesRef = collection(db, 'codes');
        const snapshot = await getDocs(codesRef);
        codes = [];
        snapshot.forEach(doc => {
          // Use document ID as the code ID (since we save with code.id as document ID)
          // Spread data first, then override id to ensure document ID takes precedence
          const codeData = doc.data();
          const loadedCode = { ...codeData, id: doc.id };
          codes.push(loadedCode);

          // Log each code as it's loaded

        });

        updateCodesTable();

      } catch (error) {

      }
    }

    async function saveUsersToFirestore() {
      try {
        const usersRef = collection(db, 'users');
        const existingUsers = await getDocs(usersRef);
        existingUsers.forEach(userDoc => {
          deleteDoc(userDoc.ref);
        });

        for (const user of users) {
          const userRef = doc(usersRef, user.id);
          await setDoc(userRef, user);
        }

      } catch (error) {

      }
    }

    async function loadUsersFromFirestore() {
      try {
        const usersRef = collection(db, 'users');
        const snapshot = await getDocs(usersRef);
        users = [];
        snapshot.forEach(docSnap => {
          users.push({ id: docSnap.id, ...docSnap.data() });
        });
        filteredUsers = [...users];
        updateSettingsUsersTable();
        populateBatchStartUserSelect();

      } catch (error) {

      }
    }

    // Hierarchy order management
    window.paymentHierarchyOrder = ['Past Due', 'Late Fee', 'Tax Codes', 'PUC Surcharge', 'Current Due'];
    let hierarchyLoaded = false;
    let hierarchyIsDirty = false;
    let hierarchyLoadVersion = 0;

    async function loadHierarchyOrder() {
      try {
        const loadVersion = ++hierarchyLoadVersion;
        const hierarchyRef = doc(db, 'settings', 'paymentHierarchy');
        const hierarchyDoc = await getDoc(hierarchyRef);
        
        if (loadVersion !== hierarchyLoadVersion) {
          return;
        }
        if (hierarchyIsDirty) {
          // Keep local changes if the user has already reordered
          return;
        }
        if (hierarchyDoc.exists()) {
          const data = hierarchyDoc.data();
          if (data.order && Array.isArray(data.order)) {
            window.paymentHierarchyOrder = data.order;
          }
        }
        
        renderHierarchyList();
        hierarchyLoaded = true;
      } catch (error) {
        console.error('Error loading hierarchy order:', error);
        renderHierarchyList(); // Render with default order even if load fails
      }
    }

    async function saveHierarchyOrder(options = {}) {
      try {
        const hierarchyRef = doc(db, 'settings', 'paymentHierarchy');
        await setDoc(hierarchyRef, {
          order: window.paymentHierarchyOrder,
          updatedAt: new Date().toISOString()
        });
        
        hierarchyIsDirty = false;
        if (!options.silent) {
          alert('Hierarchy order saved successfully!');
        }
      } catch (error) {
        console.error('Error saving hierarchy order:', error);
        if (!options.silent) {
          alert('Error saving hierarchy order. Please try again.');
        }
      }
    }

    function renderHierarchyList() {
      const hierarchyList = document.getElementById('hierarchyList');
      if (!hierarchyList) return;

      // Use DocumentFragment for faster DOM updates
      const fragment = document.createDocumentFragment();
      
      window.paymentHierarchyOrder.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 p-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg cursor-move hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors draggable-item';
        div.draggable = true;
        div.dataset.index = index;
        div.dataset.item = item;
        div.ondragstart = handleHierarchyDragStart;
        div.ondragenter = handleHierarchyDragEnter;
        div.ondragleave = handleHierarchyDragLeave;
        div.ondragover = handleHierarchyDragOver;
        div.ondrop = handleHierarchyDrop;
        div.ondragend = handleHierarchyDragEnd;
        
        div.innerHTML = `
          <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
          </svg>
          <span class="flex-1 text-slate-700 dark:text-slate-200 font-medium">${item}</span>
          <span class="text-sm text-slate-500 dark:text-slate-400">${index + 1}</span>
        `;
        
        fragment.appendChild(div);
      });
      
      // Clear and update in one operation
      hierarchyList.innerHTML = '';
      hierarchyList.appendChild(fragment);
    }

    let draggedHierarchyIndex = null;
    let draggedHierarchyElement = null;
    let lastHierarchyDragOverIndex = null;

    window.handleHierarchyDragStart = function(e) {
      draggedHierarchyElement = e.target.closest('.draggable-item');
      if (!draggedHierarchyElement) return;
      
      draggedHierarchyIndex = parseInt(draggedHierarchyElement.dataset.index);
      draggedHierarchyElement.classList.add('opacity-50');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', draggedHierarchyElement.innerHTML);
    };

    window.handleHierarchyDragOver = function(e) {
      e.preventDefault();
      if (e.dataTransfer) {
        e.dataTransfer.dropEffect = 'move';
      }

      const item = e.target.closest('.draggable-item');
      if (!item || item === draggedHierarchyElement) return;

      // Move the dragged element immediately on hover for instant visual feedback
      const hierarchyList = document.getElementById('hierarchyList');
      if (!hierarchyList) return;

      const overIndex = parseInt(item.dataset.index);
      if (Number.isNaN(overIndex) || overIndex === lastHierarchyDragOverIndex) return;

      if (draggedHierarchyIndex < overIndex) {
        hierarchyList.insertBefore(draggedHierarchyElement, item.nextSibling);
      } else {
        hierarchyList.insertBefore(draggedHierarchyElement, item);
      }

      // Update order array and indices based on current DOM
      const items = Array.from(hierarchyList.children);
      window.paymentHierarchyOrder = items.map(node => node.dataset.item);
      items.forEach((node, index) => {
        node.dataset.index = index;
        const orderLabel = node.querySelector('span:last-child');
        if (orderLabel) orderLabel.textContent = index + 1;
      });

      draggedHierarchyIndex = parseInt(draggedHierarchyElement.dataset.index);
      lastHierarchyDragOverIndex = overIndex;
      hierarchyIsDirty = true;

      // Highlight the current item
      document.querySelectorAll('.draggable-item').forEach(i => {
        i.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
      });
      item.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
    };

    window.handleHierarchyDragEnter = function(e) {
      e.preventDefault();
      const item = e.target.closest('.draggable-item');
      if (item && item !== draggedHierarchyElement) {
        // Remove highlight from all items first
        document.querySelectorAll('.draggable-item').forEach(i => {
          if (i !== item) {
            i.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
          }
        });
        item.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
      }
    };

    window.handleHierarchyDragLeave = function(e) {
      // Only remove highlight if we're actually leaving the item (not just moving to a child)
      const item = e.target.closest('.draggable-item');
      const relatedTarget = e.relatedTarget;
      if (item && (!relatedTarget || !item.contains(relatedTarget))) {
        item.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
      }
    };

    window.handleHierarchyDrop = function(e) {
      e.preventDefault();
      e.stopPropagation();

      if (hierarchyIsDirty) {
        // Save silently in the background so reloads preserve the order
        saveHierarchyOrder({ silent: true });
      }

      handleHierarchyDragEnd(e);
    };

    window.handleHierarchyDragEnd = function(e) {
      // Remove opacity from all items
      document.querySelectorAll('.draggable-item').forEach(item => {
        item.classList.remove('opacity-50', 'border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
      });
      draggedHierarchyIndex = null;
      draggedHierarchyElement = null;
      lastHierarchyDragOverIndex = null;
    };

    // Load sewer charge from Firestore
    async function loadSewerChargeFromFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'sewerCharge');
        const settingsDoc = await getDoc(settingsRef);
        
        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          sewerCharge = data.value !== undefined ? data.value : 170;
        } else {
          // If setting doesn't exist, create it with default value
          await setDoc(settingsRef, { value: 170 });
          sewerCharge = 170;
        }
        
        // Update UI if Codes screen is visible
        updateSewerChargeDisplay();
      } catch (error) {
        console.error('[LOAD SEWER CHARGE] Error loading sewer charge:', error);
        // Keep default value on error
        sewerCharge = 170;
      }
    }

    // Save sewer charge to Firestore
    async function saveSewerChargeToFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'sewerCharge');
        await setDoc(settingsRef, { value: sewerCharge });
      } catch (error) {
        console.error('[SAVE SEWER CHARGE] Error saving sewer charge:', error);
        throw error;
      }
    }

    // Load late fee from Firestore
    async function loadLateFeeFromFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'lateFee');
        const settingsDoc = await getDoc(settingsRef);
        
        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          lateFee = data.value !== undefined ? data.value : 20;
        } else {
          // If setting doesn't exist, create it with default value
          await setDoc(settingsRef, { value: 20 });
          lateFee = 20;
        }
        
        // Update UI if Codes screen is visible
        updateLateFeeDisplay();
      } catch (error) {
        console.error('[LOAD LATE FEE] Error loading late fee:', error);
        // Keep default value on error
        lateFee = 20;
      }
    }

    // Save late fee to Firestore
    async function saveLateFeeToFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'lateFee');
        await setDoc(settingsRef, { value: lateFee });
      } catch (error) {
        console.error('[SAVE LATE FEE] Error saving late fee:', error);
        throw error;
      }
    }

    // Load PUC Surcharge from Firestore
    async function loadPucSurchargeFromFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'pucSurcharge');
        const settingsDoc = await getDoc(settingsRef);
        
        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          pucSurcharge = data.value !== undefined ? data.value : 0;
        } else {
          // If setting doesn't exist, create it with default value
          await setDoc(settingsRef, { value: 0 });
          pucSurcharge = 0;
        }
        
        // Update UI if Codes screen is visible
        updatePucSurchargeDisplay();
      } catch (error) {
        console.error('[LOAD PUC SURCHARGE] Error loading PUC surcharge:', error);
        // Keep default value on error
        pucSurcharge = 0;
      }
    }

    // Save PUC Surcharge to Firestore
    async function savePucSurchargeToFirestore() {
      try {
        const settingsRef = doc(db, 'settings', 'pucSurcharge');
        await setDoc(settingsRef, { value: pucSurcharge });
      } catch (error) {
        console.error('[SAVE PUC SURCHARGE] Error saving PUC surcharge:', error);
        throw error;
      }
    }

    async function saveBatchToFirestore(batch) {
      try {
        console.log('[SAVE BATCH] Starting save to Firestore...');
        console.log('[SAVE BATCH] Batch ID:', batch.id);
        console.log('[SAVE BATCH] Batch data:', JSON.stringify(batch, null, 2));
        
        const batchesRef = collection(db, 'paymentBatches');
        const batchRef = doc(batchesRef, batch.id);
        await setDoc(batchRef, batch);
        
        console.log('[SAVE BATCH] Successfully saved batch to Firestore with ID:', batch.id);
        return true;
      } catch (error) {
        console.error('[SAVE BATCH] Error saving batch:', error);
        console.error('[SAVE BATCH] Error stack:', error.stack);
        throw error;
      }
    }

    async function loadPaymentBatchesFromFirestore() {
      try {
        console.log('[LOAD BATCHES] Starting load from Firestore...');
        const batchesRef = collection(db, 'paymentBatches');
        const snapshot = await getDocs(batchesRef);
        console.log('[LOAD BATCHES] Snapshot size:', snapshot.size);
        
        window.paymentBatches = [];
        snapshot.forEach(batchDoc => {
          const batchData = { id: batchDoc.id, ...batchDoc.data() };
          console.log('[LOAD BATCHES] Loaded batch:', batchDoc.id, 'Username:', batchData.username, 'Entries:', batchData.entries?.length || 0);
          window.paymentBatches.push(batchData);
        });

        console.log('[LOAD BATCHES] Total batches loaded:', window.paymentBatches.length);
        console.log('[LOAD BATCHES] All batch IDs:', window.paymentBatches.map(b => b.id));
        renderBatchesList();
      } catch (error) {
        console.error('[LOAD BATCHES] Error loading batches:', error);
        console.error('[LOAD BATCHES] Error stack:', error.stack);
      }
    }

    let currentUser = null;
    let filteredCustomers = [...customers];
    let filteredLocations = [...locations];
    let filteredUsers = [...users];
    let currentView = 'accounts'; // 'accounts' or 'locations'

    // Show dashboard immediately (no authentication required)
    function showDashboard() {
      updateDashboard();
    }

    // Reset bills on first of month
    function resetMonthlyBills() {
      const now = new Date();
      const isFirstOfMonth = now.getDate() === 1;

      if (isFirstOfMonth) {
        // Check if we've already reset this month by checking if there's a reset flag in localStorage
        const lastResetDate = localStorage.getItem('lastMonthlyBillReset');
        const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;
        
        // Only reset if we haven't reset this month yet
        if (lastResetDate !== currentMonthKey) {
          console.log('[RESET MONTHLY BILLS] Resetting bills for first of month');
          let needsSave = false;
          
          customers.forEach(customer => {
            // Only reset if currentBill is not already equal to sewer charge (avoid unnecessary saves)
            if (customer.currentBill !== sewerCharge) {
              // Reset current bill to full amount on first of month
              // Note: pastDue should NOT be reset - it carries over from previous months
              customer.currentBill = sewerCharge;
              // Update payment status based on past due amount
              updateCustomerPaymentStatus(customer);
              needsSave = true;
            }
          });

          // Only save if we actually made changes
          if (needsSave) {
            console.log('[RESET MONTHLY BILLS] Saving updated customers to Firestore');
            saveCustomersToFirestore().then(() => {
              // Mark that we've reset this month
              localStorage.setItem('lastMonthlyBillReset', currentMonthKey);
              console.log('[RESET MONTHLY BILLS] Monthly reset completed and saved');
            }).catch(error => {
              console.error('[RESET MONTHLY BILLS] Error saving customers:', error);
            });
          } else {
            // Mark as reset even if no changes (all customers already had currentBill = 170)
            localStorage.setItem('lastMonthlyBillReset', currentMonthKey);
            console.log('[RESET MONTHLY BILLS] No changes needed, all bills already reset');
          }
        } else {
          console.log('[RESET MONTHLY BILLS] Already reset this month, skipping');
        }
      }
    }

    // MutationObserver to track payment module changes
    let paymentModuleObserver = null;
    function setupPaymentModuleObserver() {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule || paymentModuleObserver) return;

      paymentModuleObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {

          }
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {

          }
        });
      });

      paymentModuleObserver.observe(paymentModule, {
        childList: true,
        subtree: true,
        characterData: true,
        attributes: true,
        attributeOldValue: true,
        attributeFilter: ['class']
      });

    }

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', async function() {

      // Ensure the payment module markup (with batch controls) is in place before data loads
      // Pass true to keepHidden to prevent showing payment batches on initial load
      resetPaymentForm(true);
      showDashboard();
      // Set up mutation observer after payment module is created
      setTimeout(setupPaymentModuleObserver, 100);

      // SECURITY: Check Firebase Authentication - show modal if not authenticated
      console.log('[INIT] Checking Firebase Authentication...');
      const ADMIN_UID = 'fQEVSsWI0DRca4h8K7uJgTwmjfv2'; // Admin user UID
      
      const currentUser = await window.firebaseAuth.waitForAuth();
      
      // Function to show Firebase Auth modal
      function showFirebaseAuthModal() {
        const modal = document.getElementById('firebaseAuthModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.getElementById('firebaseEmail').focus();
        }
      }
      
      // Function to hide Firebase Auth modal
      function hideFirebaseAuthModal() {
        const modal = document.getElementById('firebaseAuthModal');
        if (modal) {
          modal.classList.add('hidden');
        }
      }
      
      // Function to verify admin and log out if not admin
      async function verifyAdminAndLoad() {
        const user = window.firebaseAuth.getCurrentUser();
        if (!user) {
          console.log('[INIT] No Firebase user, showing auth modal');
          showFirebaseAuthModal();
          return false;
        }
        
        // Check if user is the admin
        if (user.uid !== ADMIN_UID) {
          console.error('[INIT] User is not admin. UID:', user.uid, 'Expected:', ADMIN_UID);
          // Sign out and clear auth
          await window.firebaseAuth.signOut();
          if (window.auth && window.auth.clearAuthentication) {
            window.auth.clearAuthentication();
          }
          alert('Access denied. Only admin users can access this system.');
          window.location.replace('login.html');
          return false;
        }
        
        console.log('[INIT] Firebase Authentication confirmed - Admin user:', user.uid);
        hideFirebaseAuthModal();
        return true;
      }
      
      // Set up Firebase Auth form handler
      const firebaseAuthForm = document.getElementById('firebaseAuthForm');
      if (firebaseAuthForm) {
        firebaseAuthForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const email = document.getElementById('firebaseEmail').value.trim();
          const password = document.getElementById('firebasePassword').value;
          const errorDiv = document.getElementById('firebaseAuthError');
          const submitBtn = document.getElementById('firebaseAuthSubmit');
          
          errorDiv.classList.add('hidden');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Signing in...';
          
          try {
            const result = await window.firebaseAuth.signIn(email, password);
            if (result.success) {
              // Verify admin after sign in
              const isAdmin = await verifyAdminAndLoad();
              if (isAdmin) {
                // Reload page to initialize with authenticated user
                window.location.reload();
              }
            } else {
              errorDiv.textContent = result.error || 'Invalid email or password';
              errorDiv.classList.remove('hidden');
              submitBtn.disabled = false;
              submitBtn.textContent = 'Sign In';
            }
          } catch (error) {
            console.error('[FIREBASE AUTH] Error:', error);
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign In';
          }
        });
      }
      
      // Check authentication status
      const isAdmin = await verifyAdminAndLoad();
      if (!isAdmin) {
        // Don't load data if not authenticated as admin
        return;
      }

      // CRITICAL: Load codes FIRST before customers!
      // This ensures that when populateCustomerCodesFromImportData() runs during customer load,
      // it will find existing codes in the array instead of creating new ones with default values

      await loadCodesFromFirestore();
      await loadSewerChargeFromFirestore();
      await loadLateFeeFromFirestore();
      await loadPucSurchargeFromFirestore();
      await loadHierarchyOrder();

      // Now load other data
      await loadLocationsFromFirestore();
      await loadCustomersFromFirestore();

      await loadUsersFromFirestore();
      await loadPaymentBatchesFromFirestore();
      // Update customer payment statuses based on past due amounts
      updateAllCustomerPaymentStatuses();
      // Reset bills if it's the first of the month
      resetMonthlyBills();
      // Update location statuses based on customers
      updateLocationStatuses();
      // Update stats after data is loaded

      updateStats();
    });

    // Switch between accounts and locations views
    window.switchView = function(view) {
      currentView = view;
      const accountsTab = document.getElementById('accountsTab');
      const locationsTab = document.getElementById('locationsTab');
      const accountsContent = document.getElementById('accountsContent');
      const locationsContent = document.getElementById('locationsContent');

      if (view === 'accounts') {
        accountsTab.classList.add('bg-blue-600', 'text-white');
        accountsTab.classList.remove('bg-slate-200', 'text-slate-700');
        locationsTab.classList.add('bg-slate-200', 'text-slate-700');
        locationsTab.classList.remove('bg-blue-600', 'text-white');
        accountsContent.classList.remove('hidden');
        locationsContent.classList.add('hidden');

        // Refresh customer codes from the global codes array to ensure latest amounts are used
        // This ensures that when showAmountDetails is called, it will have the latest code data
        customers.forEach(customer => {
          if (customer.codes && customer.codes.length > 0) {
            customer.codes = customer.codes.map(customerCode => {
              // Look up the latest code data from the global codes array
              let latestCode = codes.find(c => c.id === customerCode.id);
              if (!latestCode) {
                latestCode = codes.find(c => c.name.toLowerCase() === customerCode.name.toLowerCase());
              }
              // Use the latest code data if found, otherwise keep the customer code data
              if (latestCode) {
                return {
                  id: latestCode.id,
                  name: latestCode.name,
                  type: latestCode.type || 'percentage',
                  amount: latestCode.amount !== undefined ? latestCode.amount : (latestCode.percentage !== undefined ? latestCode.percentage : 0),
                  percentage: latestCode.type === 'percentage' && latestCode.amount !== undefined ? latestCode.amount : (latestCode.percentage !== undefined ? latestCode.percentage : 0)
                };
              }
              return customerCode;
            });
          }
        });
      } else {
        locationsTab.classList.add('bg-blue-600', 'text-white');
        locationsTab.classList.remove('bg-slate-200', 'text-slate-700');
        accountsTab.classList.add('bg-slate-200', 'text-slate-700');
        accountsTab.classList.remove('bg-blue-600', 'text-white');
        locationsContent.classList.remove('hidden');
        accountsContent.classList.add('hidden');
      }
      updateDashboard();
    };

    // Switch between settings accounts, locations, and codes views
    window.switchSettingsView = function(view) {
      const accountsTab = document.getElementById('settingsAccountsTab');
      const locationsTab = document.getElementById('settingsLocationsTab');
      const codesTab = document.getElementById('settingsCodesTab');
      const usersTab = document.getElementById('settingsUsersTab');
      const cleanupTab = document.getElementById('settingsCleanupTab');
      const hierarchyTab = document.getElementById('settingsHierarchyTab');
      const accountsContent = document.getElementById('settingsAccountsContent');
      const locationsContent = document.getElementById('settingsLocationsContent');
      const codesContent = document.getElementById('settingsCodesContent');
      const usersContent = document.getElementById('settingsUsersContent');
      const cleanupContent = document.getElementById('settingsCleanupContent');
      const hierarchyContent = document.getElementById('settingsHierarchyContent');

      // Reset all tabs and content
      [accountsTab, locationsTab, codesTab, usersTab, cleanupTab, hierarchyTab].forEach(tab => {
        if (!tab) return;
        tab.classList.remove('bg-blue-600', 'text-white');
        tab.classList.add('bg-slate-200', 'text-slate-700');
      });
      accountsContent.classList.add('hidden');
      locationsContent.classList.add('hidden');
      codesContent.classList.add('hidden');
      usersContent.classList.add('hidden');
      if (cleanupContent) cleanupContent.classList.add('hidden');
      if (hierarchyContent) hierarchyContent.classList.add('hidden');

      if (view === 'accounts') {
        accountsTab.classList.add('bg-blue-600', 'text-white');
        accountsTab.classList.remove('bg-slate-200', 'text-slate-700');
        accountsContent.classList.remove('hidden');
        updateSettingsCustomerTable();
      } else if (view === 'locations') {
        locationsTab.classList.add('bg-blue-600', 'text-white');
        locationsTab.classList.remove('bg-slate-200', 'text-slate-700');
        locationsContent.classList.remove('hidden');
        updateSettingsLocationsTable();
      } else if (view === 'codes') {
        codesTab.classList.add('bg-blue-600', 'text-white');
        codesTab.classList.remove('bg-slate-200', 'text-slate-700');
        codesContent.classList.remove('hidden');
        updateCodesTable();
        updateSewerChargeDisplay();
        updateLateFeeDisplay();
        updatePucSurchargeDisplay();
        updateLateFeeDisplay();
      } else if (view === 'users') {
        usersTab.classList.add('bg-blue-600', 'text-white');
        usersTab.classList.remove('bg-slate-200', 'text-slate-700');
        usersContent.classList.remove('hidden');
        updateSettingsUsersTable();
      } else if (view === 'cleanup') {
        if (cleanupTab) {
          cleanupTab.classList.add('bg-blue-600', 'text-white');
          cleanupTab.classList.remove('bg-slate-200', 'text-slate-700');
        }
        if (cleanupContent) cleanupContent.classList.remove('hidden');
      } else if (view === 'hierarchy') {
        if (hierarchyTab) {
          hierarchyTab.classList.add('bg-blue-600', 'text-white');
          hierarchyTab.classList.remove('bg-slate-200', 'text-slate-700');
        }
        if (hierarchyContent) {
          hierarchyContent.classList.remove('hidden');
          loadHierarchyOrder();
        }
      }
    };

    function updateDashboard() {

      const paymentModuleBefore = document.getElementById('paymentModule');

      updateStats();
      updateLocationStatuses(); // Update location statuses based on customers
      if (currentView === 'accounts') {
        updateCustomerTable();
      } else {
        updateLocationsTable();
      }

      const paymentModuleAfter = document.getElementById('paymentModule');

      if ((paymentModuleBefore?.innerHTML?.length || 0) !== (paymentModuleAfter?.innerHTML?.length || 0)) {

      }

    }

    // Update customer payment status based on past due amount
    function updateCustomerPaymentStatus(customer) {
      // Don't change status if it's inactive or pending closing (these are manually set)
      if (customer.paymentStatus === 'inactive' || customer.paymentStatus === 'pending closing') {
        return;
      }

      if (customer.pastDue > 0) {
        customer.paymentStatus = 'overdue';
      } else {
        customer.paymentStatus = 'current';
      }
    }

    // Update all customer payment statuses
    function updateAllCustomerPaymentStatuses() {
      customers.forEach(customer => {
        updateCustomerPaymentStatus(customer);
      });
    }

    // Update location statuses based on associated customers
    function updateLocationStatuses() {
      locations.forEach(location => {
        // Check if there's a customer associated with this location
        const associatedCustomer = customers.find(customer => 
          customer.address === location.address || 
          customer.name === location.currentResident
        );

        if (associatedCustomer) {
          // Location has an active customer
          location.status = 'occupied';
          location.currentResident = associatedCustomer.name;
          location.ownerFullName = associatedCustomer.name;
          // Split name into first and last
          const nameParts = associatedCustomer.name.split(' ');
          location.ownerFirstName = nameParts[0] || '';
          location.ownerLastName = nameParts.slice(1).join(' ') || '';
        } else {
          // No customer associated - set to inactive
          location.status = 'inactive';
          location.currentResident = null;
          location.ownerFullName = '';
          location.ownerFirstName = '';
          location.ownerLastName = '';
        }
      });

      // Update filtered locations
      filteredLocations = [...locations];
    }

    function updateStats() {

      const totalCustomers = customers.length;
      const overdueCustomers = customers.filter(c => c.paymentStatus === 'overdue').length;
      const currentCustomers = customers.filter(c => c.paymentStatus === 'current').length;

      // Calculate total revenue from payment history
      let totalRevenue = 0;
      customers.forEach(customer => {
        if (customer.paymentHistory && Array.isArray(customer.paymentHistory) && customer.paymentHistory.length > 0) {
          customer.paymentHistory.forEach(payment => {
            totalRevenue += payment.amountPaid;
          });
        }
      });

      // Only update stats if the elements exist (they were removed from the UI)
      const totalCustomersEl = document.getElementById('totalCustomers');
      const overdueCustomersEl = document.getElementById('overdueCustomers');
      const currentCustomersEl = document.getElementById('currentCustomers');
      const totalRevenueEl = document.getElementById('totalRevenue');

      if (totalCustomersEl) totalCustomersEl.textContent = totalCustomers;
      if (overdueCustomersEl) overdueCustomersEl.textContent = overdueCustomers;
      if (currentCustomersEl) currentCustomersEl.textContent = currentCustomers;
      if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
    }

    function updateCustomerTable() {
      const tbody = document.getElementById('customerTableBody');
      tbody.innerHTML = '';

      // Update the customer count display
      const countDisplay = document.getElementById('customerCountDisplay');
      const totalDisplay = document.getElementById('customerTotalDisplay');
      if (countDisplay) countDisplay.textContent = filteredCustomers.length;
      if (totalDisplay) totalDisplay.textContent = customers.length;

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early (before due date)
        const hasPaidEarly = customer.lastPayment && customer.lastPayment !== 'Never' && 
                            customer.lastPayment.includes('/') && 
                            new Date(customer.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount based on breakdown logic
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due
        
        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate code surcharges (applied to adjusted service cost after factor, affected by factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            let baseSurcharge;
            if (codeType === 'flat') {
              baseSurcharge = codeAmount;
            } else {
              baseSurcharge = adjustedServiceCost * (codeAmount / 100);
            }
            // Apply factor to tax codes
            totalSurcharge += baseSurcharge * factor;
          });
        }

        // Calculate subtotal: adjusted service cost + tax codes (both affected by factor)
        const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;

        // Calculate PUC Surcharge (applied to subtotal, NOT affected by factor)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = subtotalBeforePuc * (pucSurcharge / 100);
        }

        const totalAmount = hasPaidEarly ? 0 : (subtotalBeforePuc + pastDue + lateFeeAmount + pucSurchargeAmount);

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'accountNumber', '${customer.accountNumber}')" 
                 title="Double-click to edit">
              ${customer.accountNumber}
            </div>
          </td>
          <td class="px-0 py-4 pr-0 -mr-4 whitespace-nowrap text-center max-w-[180px]">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'name', '${customer.name}')" 
                 title="Double-click to edit">
              ${customer.name}
            </div>
            <div class="flex flex-col items-center gap-1 mt-2">
              <button 
                onclick="showCustomerFullInfo('${customer.id}')" 
                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium"
              >
                View Full Info
              </button>
              <button 
                onclick="showCustomerDataProfile('${customer.id}')" 
                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 text-xs font-medium"
              >
                View Data Profile
              </button>
            </div>
          </td>
          <td class="px-0 py-4 pl-0 -ml-4 text-center max-w-[180px]">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'address', '${getCustomerDisplayAddress(customer)}')" 
                 title="Double-click to edit">
              ${(() => {
                const displayAddress = getCustomerDisplayAddress(customer);
                if (typeof displayAddress === 'string' && displayAddress.includes(',')) {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress.split(',')[0].trim()}</div>
                  <div class="text-slate-500 dark:text-slate-400 whitespace-nowrap">${displayAddress.split(',').slice(1).join(',').trim()}</div>`;
                } else {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress}</div>`;
                }
              })()}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editCustomerField('${customer.id}', 'paymentStatus', '${customer.paymentStatus}')" 
                  title="Double-click to edit">
              ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-900 dark:text-slate-100">
            <div class="font-medium">$${totalAmount.toFixed(2)}</div>
            <button onclick="showAmountDetails('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
              View Details
            </button>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600 dark:text-slate-400">
            <div class="flex flex-wrap gap-1 justify-center">
              ${pucSurcharge > 0 ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">PUC SCHG SW (${pucSurcharge.toFixed(2)}%)</span>` : ''}
              ${customer.codes && customer.codes.length > 0 
                ? customer.codes.map(code => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.name}</span>`).join('')
                : (pucSurcharge > 0 ? '' : '<span class="text-slate-400 dark:text-slate-500"></span>')
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <div class="flex flex-col space-y-2">
              <button onclick="showPaymentModal('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Mark Paid
              </button>
              <button onclick="showPaymentHistory('${customer.id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                View History
              </button>
              <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Logout function (simply redirects to client page)
    window.logout = function() {
      window.location.href = 'billing.html';
    };

    // Module Management Functions
    window.showPaymentModule = function() {
      hideAllModules();
      // Reset payment module to original form
      resetPaymentForm();
      document.getElementById('paymentModule').classList.remove('hidden');
    };

    window.showBillModule = function() {
      hideAllModules();
      // Reset bill module to original form
      resetBillForm();
      document.getElementById('billModule').classList.remove('hidden');
    };

    window.showAddClientModule = function() {
      hideAllModules();
      // Reset add client module to original form
      resetAddClientForm();
      // Populate codes dropdown after form is reset
      setTimeout(() => {
        populateAddClientCodeSelect();
        window.selectedClientCodes = [];
        updateClientCodesList();
      }, 100);
      document.getElementById('addClientModule').classList.remove('hidden');
    };

    window.showSearchModule = function() {
      hideAllModules();
      // Clear search results and reset form
      document.getElementById('searchByName').value = '';
      document.getElementById('searchByStatus').value = '';
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('searchModule').classList.remove('hidden');
    };

    window.showSettingsModule = async function() {
      hideAllModules();
      const settingsModule = document.getElementById('settingsModule');
      const loadingOverlay = document.getElementById('settingsLoadingOverlay');
      
      // Show settings module immediately
      settingsModule.classList.remove('hidden');
      
      // Show loading overlay if data might not be ready
      // Check if customers array is empty or if we're still in initial load
      const needsLoading = customers.length === 0;
      
      if (needsLoading && loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }
      
      // Wait for data to be loaded if customers array is empty
      // This ensures data is ready before showing the tables
      if (needsLoading) {
        // Data might still be loading, wait a bit and check again
        let attempts = 0;
        const maxAttempts = 50; // 5 seconds max wait (50 * 100ms)
        
        while (customers.length === 0 && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }
      }
      
      // Small delay to ensure data is fully processed and UI is ready
      await new Promise(resolve => setTimeout(resolve, 50));
      
      // Populate the settings tables
      updateSettingsCustomerTable();
      updateSettingsLocationsTable();
      updateSettingsUsersTable();
      
      // Hide loading overlay once data is ready
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
    };

    window.hideAllModules = function() {
      document.getElementById('paymentModule').classList.add('hidden');
      document.getElementById('billModule').classList.add('hidden');
      document.getElementById('addClientModule').classList.add('hidden');
      document.getElementById('searchModule').classList.add('hidden');
      document.getElementById('settingsModule').classList.add('hidden');
    };

    // Payment Module Functions
    function populatePaymentCustomerSelect() {
      const select = document.getElementById('paymentCustomerSelect');
      if (!select) {

        return;
      }
      select.innerHTML = '<option value="">Choose a customer...</option>';

      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.name} (${customer.accountNumber})`;
        select.appendChild(option);
      });

      select.onchange = function() {
        const customerId = this.value;

        if (customerId) {
          showCustomerPaymentInfo(customerId);
        } else {
          hideCustomerPaymentInfo();
        }
      };

    }

    function populateBatchStartUserSelect() {
      const select = document.getElementById('batchStartUserSelect');
      if (!select) {

        return;
      }

      select.innerHTML = '<option value="">Select a user...</option><option value="Test User">Test User</option>';
      users.forEach(user => {
        const option = document.createElement('option');
        const fullName = user.fullName || user.id || 'Unnamed User';
        option.value = fullName;
        option.textContent = fullName;
        select.appendChild(option);
      });

    }

    function showCustomerPaymentInfo(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        // Calculate prorated service cost based on when customer was added
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due
        
        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate PUC Surcharge first (applied to adjusted service cost after factor, before other codes)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = adjustedServiceCost * (pucSurcharge / 100);
        }

        // Calculate code surcharges (applied to adjusted service cost after factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += adjustedServiceCost * (codeAmount / 100);
            }
          });
        }

        const totalAmount = adjustedServiceCost + pastDue + lateFeeAmount + pucSurchargeAmount + totalSurcharge;

        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Set up status indicator
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        document.getElementById('paymentAmountDue').textContent = `$${totalAmount.toFixed(2)}`;
        document.getElementById('paymentPastDue').textContent = `$${customer.pastDue.toFixed(2)}`;
        document.getElementById('paymentDueDate').textContent = dueDateStr;
        document.getElementById('paymentLateFee').textContent = `$${lateFeeAmount.toFixed(2)}`;
        document.getElementById('paymentAmount').value = (totalAmount + customer.pastDue).toFixed(2);

        // Update status indicator
        const statusIndicator = document.getElementById('paymentStatusIndicator');
        statusIndicator.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
        statusIndicator.textContent = customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1);

        // Update property location
        document.getElementById('paymentPropertyLocation').textContent = customer.address;

        document.getElementById('customerPaymentInfo').classList.remove('hidden');
      }
    }

    // Calculate prorated service cost based on when customer was added
    function calculateProratedServiceCost(customer) {
      const baseServiceCost = sewerCharge;

      // Imported customers should not be prorated - always charge full amount
      if (customer.importData) {
        return baseServiceCost;
      }

      // If customer was added this month, calculate proration
      const now = new Date();
      const customerAddedDate = new Date(customer.createdDate);

      // Check if customer was added in the current month
      if (customerAddedDate.getMonth() === now.getMonth() && 
          customerAddedDate.getFullYear() === now.getFullYear()) {

        // Calculate days remaining in the month from when they joined
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const totalDaysInMonth = lastDayOfMonth.getDate();

        // Days from when they joined to end of month
        const daysRemaining = lastDayOfMonth.getDate() - customerAddedDate.getDate() + 1;

        // Calculate prorated amount
        const proratedAmount = (baseServiceCost * daysRemaining) / totalDaysInMonth;

        return Math.round(proratedAmount * 100) / 100; // Round to 2 decimal places
      }

      // If customer was added in a previous month, charge full amount
      return baseServiceCost;
    }

    function hideCustomerPaymentInfo() {
      document.getElementById('customerPaymentInfo').classList.add('hidden');
    }

    // Bill Module Functions
    function populateBillCustomerSelect() {
      const select = document.getElementById('billCustomerSelect');
      select.innerHTML = '<option value="">Choose a customer...</option>';

      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.name} (${customer.accountNumber})`;
        select.appendChild(option);
      });

      // Add event listener for customer selection
      select.addEventListener('change', function() {
        const customerId = this.value;
        if (customerId) {
          // Clear cycle select when customer is selected
          const cycleSelect = document.getElementById('billCycleSelect');
          const produceBillingCycleContainer = document.getElementById('produceBillingCycleContainer');
          if (cycleSelect) {
            cycleSelect.value = '';
          }
          if (produceBillingCycleContainer) {
            produceBillingCycleContainer.classList.add('hidden');
          }
          showCustomerBillInfo(customerId);
        } else {
          hideCustomerBillInfo();
        }
      });
    }

    function showCustomerBillInfo(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        // Calculate prorated service cost based on when customer was added
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due
        
        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate PUC Surcharge first (applied to adjusted service cost after factor, before other codes)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = adjustedServiceCost * (pucSurcharge / 100);
        }

        // Calculate code surcharges (applied to adjusted service cost after factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += adjustedServiceCost * (codeAmount / 100);
            }
          });
        }

        const totalAmount = adjustedServiceCost + pastDue + lateFeeAmount + pucSurchargeAmount + totalSurcharge;

        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Set up status indicator
        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        document.getElementById('billAmountDue').textContent = `$${totalAmount.toFixed(2)}`;
        document.getElementById('billPastDue').textContent = `$${customer.pastDue.toFixed(2)}`;
        document.getElementById('billDueDate').textContent = dueDateStr;
        document.getElementById('billLateFee').textContent = `$${lateFeeAmount.toFixed(2)}`;

        // Update status indicator
        const statusIndicator = document.getElementById('billStatusIndicator');
        statusIndicator.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
        statusIndicator.textContent = customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1);

        // Update property location
        document.getElementById('billPropertyLocation').textContent = customer.address;

        document.getElementById('customerBillInfo').classList.remove('hidden');
      }
    }

    function hideCustomerBillInfo() {
      document.getElementById('customerBillInfo').classList.add('hidden');
    }

    window.resetBillForm = function() {
      const billModule = document.getElementById('billModule');
      billModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Or Select Cycle Number</label>
            <select id="billCycleSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" onchange="handleCycleSelectChange()">
              <option value="">Select cycle number...</option>
              <option value="1">Cycle 1</option>
              <option value="2">Cycle 2</option>
              <option value="3">Cycle 3</option>
              <option value="4">Cycle 4</option>
              <option value="5">Cycle 5</option>
              <option value="6">Cycle 6</option>
              <option value="7">Cycle 7</option>
              <option value="8">Cycle 8</option>
              <option value="9">Cycle 9</option>
              <option value="10">Cycle 10</option>
            </select>
          </div>

          <div id="produceBillingCycleContainer" class="hidden">
            <button 
              onclick="produceBillingCycle()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Billing Cycle
            </button>
          </div>

          <div class="mt-4">
            <button 
              onclick="showPastBillingCycles()" 
              class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              View Past Cycles
            </button>
          </div>

          <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>

            <br>
            <button 
              onclick="produceBill()" 
              class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Bill
            </button>

            <!-- PDF Display Container -->
            <div id="billPdfDisplay" class="hidden mt-4">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            </div>
          </div>
        </div>

      `;

      // Repopulate the customer dropdown
      populateBillCustomerSelect();
    };

    window.produceBill = async function() {
      const customerId = document.getElementById('billCustomerSelect').value;
      if (!customerId) {
        alert('Please select a customer');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      try {
        // Calculate all the amounts (same logic as showCustomerBillInfo)
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due
        
        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate PUC Surcharge first (applied to adjusted service cost after factor, before other codes)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = adjustedServiceCost * (pucSurcharge / 100);
        }

        // Calculate code surcharges (applied to adjusted service cost after factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            if (codeType === 'flat') {
              totalSurcharge += codeAmount;
            } else {
              totalSurcharge += adjustedServiceCost * (codeAmount / 100);
            }
          });
        }

        const totalAmount = adjustedServiceCost + pastDue + lateFeeAmount + pucSurchargeAmount + totalSurcharge;

        // Calculate dates
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const statementDate = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getFullYear();

        // Calculate billing cycle (first day of month to last day of month)
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayStr = (firstDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           firstDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                           String(firstDayOfMonth.getFullYear()).slice(-2);
        const lastDayStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          String(lastDayOfMonth.getFullYear()).slice(-2);
        const cyclePeriod = `${firstDayStr} to ${lastDayStr}`;

        // Due date is the last day of the billing cycle month (same as lastDayOfMonth)
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Create FormData with all the required fields
        const formData = new FormData();
        formData.append('account_no', customer.accountNumber || '');
        formData.append('account_name', customer.name || '');
        formData.append('account_address', customer.address || '');
        formData.append('statement_date', statementDate);
        formData.append('cycle_period', cyclePeriod);
        formData.append('current_charges', `$${adjustedServiceCost.toFixed(2)}`);
        formData.append('previous_charges', `$${customer.pastDue.toFixed(2)}`);
        // Calculate subtotal before PUC (adjusted service cost + tax codes)
        const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;
        
        // Recalculate PUC surcharge based on subtotal before PUC
        let pucSurchargeAmountRecalc = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmountRecalc = subtotalBeforePuc * (pucSurcharge / 100);
        }
        
        const currentDue = subtotalBeforePuc + pucSurchargeAmountRecalc + lateFeeAmount;
        const totalAmountRecalc = currentDue + pastDue;

        formData.append('taxes_charges', `$${totalSurcharge.toFixed(2)}`);
        formData.append('total_amount', `$${totalAmountRecalc.toFixed(2)}`);
        formData.append('due_date', dueDateStr);

        // Send to server
        const response = await fetch('/edit_pdf?pdf=bill', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Failed to generate PDF');
        }

        // Get the PDF blob
        const blob = await response.blob();

        // Create blob URL for download
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'bill.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        // Display the PDF below the button
        const displayUrl = URL.createObjectURL(blob);
        const pdfDisplay = document.getElementById('billPdfDisplay');
        const pdfViewer = document.getElementById('billPdfViewer');
        const billModule = document.getElementById('billModule');

        if (pdfDisplay && pdfViewer) {
          // Revoke any previous display URL to prevent memory leaks
          if (pdfViewer.src && pdfViewer.src.startsWith('blob:')) {
            URL.revokeObjectURL(pdfViewer.src);
          }

          pdfViewer.src = displayUrl;
          pdfDisplay.classList.remove('hidden');

          // Increase bill module height by 25% when PDF is displayed
          if (billModule) {
            // Wait a moment for the PDF display to render, then calculate height
            setTimeout(() => {
              const currentHeight = billModule.offsetHeight;
              billModule.style.minHeight = `${currentHeight * 1.25}px`;
              billModule.style.paddingBottom = '2rem';
            }, 50);
          }

          // Scroll to the PDF viewer smoothly
          setTimeout(() => {
            pdfDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 100);
        } else {
          // If elements don't exist, create them dynamically
          const customerBillInfo = document.getElementById('customerBillInfo');
          if (customerBillInfo) {
            const pdfContainer = document.createElement('div');
            pdfContainer.id = 'billPdfDisplay';
            pdfContainer.className = 'mt-4';
            pdfContainer.innerHTML = `
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            `;
            customerBillInfo.appendChild(pdfContainer);
            document.getElementById('billPdfViewer').src = displayUrl;

            // Increase bill module height by 25% when PDF is displayed
            if (billModule) {
              // Wait a moment for the PDF display to render, then calculate height
              setTimeout(() => {
                const currentHeight = billModule.offsetHeight;
                billModule.style.minHeight = `${currentHeight * 1.25}px`;
                billModule.style.paddingBottom = '2rem';
              }, 50);
            }

            setTimeout(() => {
              pdfContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
          }
        }

        alert('Bill PDF generated successfully!');
      } catch (error) {
        alert('Failed to generate bill PDF: ' + error.message);
      }
    };

    // Handle cycle select change - show/hide produce billing cycle button
    window.handleCycleSelectChange = function() {
      const cycleSelect = document.getElementById('billCycleSelect');
      const produceBillingCycleContainer = document.getElementById('produceBillingCycleContainer');
      const billCustomerSelect = document.getElementById('billCustomerSelect');
      
      if (cycleSelect && produceBillingCycleContainer) {
        if (cycleSelect.value) {
          produceBillingCycleContainer.classList.remove('hidden');
          // Clear customer selection when cycle is selected
          if (billCustomerSelect) {
            billCustomerSelect.value = '';
            const customerBillInfo = document.getElementById('customerBillInfo');
            if (customerBillInfo) {
              customerBillInfo.classList.add('hidden');
            }
          }
        } else {
          produceBillingCycleContainer.classList.add('hidden');
        }
      }
    };

    // Produce billing cycle - generate bills for all customers in a cycle and zip them
    window.produceBillingCycle = async function() {
      const cycleNumber = document.getElementById('billCycleSelect').value;
      if (!cycleNumber) {
        alert('Please select a cycle number');
        return;
      }

      // Get all customers with this cycle number
      const cycleCustomers = customers.filter(c => c.cycleNumber === cycleNumber);
      
      if (cycleCustomers.length === 0) {
        alert(`No customers found for Cycle ${cycleNumber}`);
        return;
      }

      if (!confirm(`This will generate bills for ${cycleCustomers.length} customer(s) in Cycle ${cycleNumber}. Continue?`)) {
        return;
      }

      try {
        // Show loading message
        const produceButton = document.querySelector('#produceBillingCycleContainer button');
        const originalButtonText = produceButton ? produceButton.textContent : '';
        if (produceButton) {
          produceButton.textContent = 'Generating bills...';
          produceButton.disabled = true;
        }

        // Create snapshot of data before generating bills
        const now = new Date();
        const snapshotDate = now.toISOString();
        const dateStr = (now.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                       now.getDate().toString().padStart(2, '0') + '-' + 
                       now.getFullYear();

        // Calculate dates for snapshot
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const statementDate = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                             lastDayOfMonth.getFullYear();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayStr = (firstDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           firstDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                           String(firstDayOfMonth.getFullYear()).slice(-2);
        const lastDayStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          String(lastDayOfMonth.getFullYear()).slice(-2);
        const cyclePeriod = `${firstDayStr} to ${lastDayStr}`;
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Create snapshot with all customer data and calculations
        const billingCycleSnapshot = {
          cycleNumber: cycleNumber,
          generatedDate: snapshotDate,
          generatedDateStr: dateStr,
          statementDate: statementDate,
          cyclePeriod: cyclePeriod,
          dueDateStr: dueDateStr,
          // Save all settings used
          settings: {
            sewerCharge: sewerCharge,
            lateFee: lateFee,
            pucSurcharge: pucSurcharge,
            codes: JSON.parse(JSON.stringify(codes)) // Deep copy
          },
          // Save complete customer snapshots with all calculations
          customerSnapshots: []
        };

        // Create JSZip instance
        const zip = new JSZip();

        // Generate bill for each customer
        let successCount = 0;
        let errorCount = 0;

        for (const customer of cycleCustomers) {
          try {
            // Calculate all the amounts (same logic as produceBill)
            const baseServiceCost = calculateProratedServiceCost(customer);
            const pastDue = parseFloat(customer.pastDue || 0);
            const lateFeeAmount = pastDue > 0 ? lateFee : 0;
            
            const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
            const adjustedServiceCost = baseServiceCost * factor;

            // Calculate tax codes
            let totalSurcharge = 0;
            if (customer.codes && customer.codes.length > 0) {
              customer.codes.forEach(code => {
                const codeType = code.type || 'percentage';
                const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
                if (codeType === 'flat') {
                  totalSurcharge += codeAmount;
                } else {
                  totalSurcharge += adjustedServiceCost * (codeAmount / 100);
                }
              });
            }

            // Calculate PUC Surcharge
            const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;
            let pucSurchargeAmount = 0;
            if (pucSurcharge > 0) {
              pucSurchargeAmount = subtotalBeforePuc * (pucSurcharge / 100);
            }

            const currentDue = subtotalBeforePuc + pucSurchargeAmount + lateFeeAmount;
            const totalAmount = currentDue + pastDue;

            // Save customer snapshot with all calculations
            const customerSnapshot = {
              customerId: customer.id,
              customerData: JSON.parse(JSON.stringify(customer)), // Deep copy of customer data
              calculations: {
                baseServiceCost: baseServiceCost,
                pastDue: pastDue,
                lateFeeAmount: lateFeeAmount,
                factor: factor,
                adjustedServiceCost: adjustedServiceCost,
                totalSurcharge: totalSurcharge,
                subtotalBeforePuc: subtotalBeforePuc,
                pucSurchargeAmount: pucSurchargeAmount,
                currentDue: currentDue,
                totalAmount: totalAmount
              },
              pdfData: {
                account_no: customer.accountNumber || '',
                account_name: customer.name || '',
                account_address: customer.address || '',
                statement_date: statementDate,
                cycle_period: cyclePeriod,
                current_charges: `$${adjustedServiceCost.toFixed(2)}`,
                previous_charges: `$${customer.pastDue.toFixed(2)}`,
                taxes_charges: `$${totalSurcharge.toFixed(2)}`,
                total_amount: `$${totalAmount.toFixed(2)}`,
                due_date: dueDateStr
              }
            };
            billingCycleSnapshot.customerSnapshots.push(customerSnapshot);

            // Create FormData
            const formData = new FormData();
            formData.append('account_no', customerSnapshot.pdfData.account_no);
            formData.append('account_name', customerSnapshot.pdfData.account_name);
            formData.append('account_address', customerSnapshot.pdfData.account_address);
            formData.append('statement_date', customerSnapshot.pdfData.statement_date);
            formData.append('cycle_period', customerSnapshot.pdfData.cycle_period);
            formData.append('current_charges', customerSnapshot.pdfData.current_charges);
            formData.append('previous_charges', customerSnapshot.pdfData.previous_charges);
            formData.append('taxes_charges', customerSnapshot.pdfData.taxes_charges);
            formData.append('total_amount', customerSnapshot.pdfData.total_amount);
            formData.append('due_date', customerSnapshot.pdfData.due_date);

            // Generate PDF
            const response = await fetch('/edit_pdf?pdf=bill', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              throw new Error(`Failed to generate PDF for ${customer.name}`);
            }

            // Get PDF blob
            const blob = await response.blob();
            
            // Sanitize customer name for filename (remove special characters)
            const sanitizedName = customer.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const filename = `${sanitizedName}-${dateStr}.pdf`;
            
            // Add to zip
            zip.file(filename, blob);
            successCount++;

          } catch (error) {
            console.error(`Error generating bill for ${customer.name}:`, error);
            errorCount++;
          }
        }

        // Generate zip file
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        
        // Save snapshot to Firestore before downloading
        try {
          const billingCyclesRef = collection(db, 'billingCycles');
          await addDoc(billingCyclesRef, billingCycleSnapshot);
          console.log('[BILLING CYCLE SNAPSHOT] Saved snapshot to Firestore');
        } catch (snapshotError) {
          console.error('[BILLING CYCLE SNAPSHOT] Error saving snapshot:', snapshotError);
          // Don't fail the whole operation if snapshot save fails
        }

        // Download zip file
        const downloadUrl = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `cycle-${cycleNumber}-bills-${dateStr}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        // Restore button
        if (produceButton) {
          produceButton.textContent = originalButtonText;
          produceButton.disabled = false;
        }

        // Show success message
        if (errorCount === 0) {
          alert(`Successfully generated ${successCount} bill(s) for Cycle ${cycleNumber}!\nSnapshot saved for future reference.`);
        } else {
          alert(`Generated ${successCount} bill(s) successfully, but ${errorCount} failed. Check console for details.\nSnapshot saved for future reference.`);
        }

      } catch (error) {
        console.error('Error producing billing cycle:', error);
        alert('Error producing billing cycle: ' + error.message);
        
        // Restore button
        const produceButton = document.querySelector('#produceBillingCycleContainer button');
        if (produceButton) {
          produceButton.textContent = 'Produce Billing Cycle';
          produceButton.disabled = false;
        }
      }
    };

    window.showBillDetailsModal = function() {
      // Placeholder function - can be implemented later if needed
      const customerId = document.getElementById('billCustomerSelect').value;
      if (customerId) {
        showAmountDetails(customerId);
      }
    };

    // Show past billing cycles modal
    window.showPastBillingCycles = async function() {
      try {
        // Load all billing cycle snapshots from Firestore
        const billingCyclesRef = collection(db, 'billingCycles');
        const snapshot = await getDocs(billingCyclesRef);
        
        const pastCycles = [];
        snapshot.forEach(doc => {
          pastCycles.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Sort by date (newest first)
        pastCycles.sort((a, b) => new Date(b.generatedDate) - new Date(a.generatedDate));

        // Create modal content
        const billModule = document.getElementById('billModule');
        billModule.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Past Billing Cycles</h3>
            <button onclick="showProcessBillModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="mb-4">
            <button 
              onclick="showProcessBillModal()" 
              class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-xl transition-colors duration-200 flex items-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              Back to Process Bill
            </button>
          </div>
          <br>

          <div class="space-y-4">
            ${pastCycles.length === 0 ? `
              <div class="text-center py-8">
                <p class="text-slate-600 dark:text-slate-400">No past billing cycles found.</p>
              </div>
            ` : `
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                  <thead class="bg-slate-50 dark:bg-slate-700">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Date</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Cycle</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Customers</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Period</th>
                      <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="pastBillingCyclesBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                    ${pastCycles.map(cycle => {
                      const date = new Date(cycle.generatedDate);
                      const dateStr = (date.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                     date.getDate().toString().padStart(2, '0') + '/' + 
                                     date.getFullYear();
                      const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                      const customerCount = cycle.customerSnapshots ? cycle.customerSnapshots.length : 0;
                      return `
                        <tr>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            ${dateStr}<br>
                            <span class="text-xs text-slate-500 dark:text-slate-400">${timeStr}</span>
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                              Cycle ${cycle.cycleNumber}
                            </span>
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            ${customerCount} customer(s)
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
                            ${cycle.cyclePeriod || 'N/A'}
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button 
                              onclick="reproduceBillingCycle('${cycle.id}')" 
                              class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-4"
                              title="Reproduce this billing cycle"
                            >
                              Reproduce
                            </button>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        `;

        billModule.classList.remove('hidden');
      } catch (error) {
        console.error('[SHOW PAST BILLING CYCLES] Error:', error);
        alert('Error loading past billing cycles: ' + error.message);
      }
    };

    // Reproduce a past billing cycle
    window.reproduceBillingCycle = async function(cycleId) {
      if (!confirm('This will reproduce the billing cycle using the exact same data from when it was generated. Continue?')) {
        return;
      }

      try {
        // Load the billing cycle snapshot from Firestore
        const billingCyclesRef = collection(db, 'billingCycles');
        const cycleDoc = await getDoc(doc(billingCyclesRef, cycleId));
        
        if (!cycleDoc.exists()) {
          alert('Billing cycle snapshot not found');
          return;
        }

        const cycleSnapshot = cycleDoc.data();

        // Show loading message
        const billModule = document.getElementById('billModule');
        billModule.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Reproducing Billing Cycle</h3>
          </div>
          <div class="text-center py-8">
            <p class="text-slate-600 dark:text-slate-400">Generating bills from snapshot...</p>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Cycle ${cycleSnapshot.cycleNumber} - ${cycleSnapshot.generatedDateStr}</p>
          </div>
        `;

        // Create JSZip instance
        const zip = new JSZip();

        // Generate bill for each customer using snapshot data
        let successCount = 0;
        let errorCount = 0;

        for (const customerSnapshot of cycleSnapshot.customerSnapshots) {
          try {
            // Use the exact PDF data from the snapshot
            const formData = new FormData();
            Object.keys(customerSnapshot.pdfData).forEach(key => {
              formData.append(key, customerSnapshot.pdfData[key]);
            });

            // Generate PDF
            const response = await fetch('/edit_pdf?pdf=bill', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              throw new Error(`Failed to generate PDF for ${customerSnapshot.pdfData.account_name}`);
            }

            // Get PDF blob
            const blob = await response.blob();
            
            // Use the original filename format
            const sanitizedName = customerSnapshot.pdfData.account_name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const filename = `${sanitizedName}-${cycleSnapshot.generatedDateStr}.pdf`;
            
            // Add to zip
            zip.file(filename, blob);
            successCount++;

          } catch (error) {
            console.error(`Error generating bill for ${customerSnapshot.pdfData.account_name}:`, error);
            errorCount++;
          }
        }

        // Generate zip file
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        
        // Download zip file with original naming
        const downloadUrl = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `cycle-${cycleSnapshot.cycleNumber}-bills-${cycleSnapshot.generatedDateStr}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        // Show success message and return to past cycles view
        if (errorCount === 0) {
          alert(`Successfully reproduced ${successCount} bill(s) from Cycle ${cycleSnapshot.cycleNumber} (${cycleSnapshot.generatedDateStr})!`);
        } else {
          alert(`Reproduced ${successCount} bill(s) successfully, but ${errorCount} failed. Check console for details.`);
        }

        // Return to past cycles view
        showPastBillingCycles();

      } catch (error) {
        console.error('[REPRODUCE BILLING CYCLE] Error:', error);
        alert('Error reproducing billing cycle: ' + error.message);
        showPastBillingCycles();
      }
    };

    // Helper function to show process bill modal
    window.showProcessBillModal = function() {
      const billModule = document.getElementById('billModule');
      billModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Or Select Cycle Number</label>
            <select id="billCycleSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" onchange="handleCycleSelectChange()">
              <option value="">Select cycle number...</option>
              <option value="1">Cycle 1</option>
              <option value="2">Cycle 2</option>
              <option value="3">Cycle 3</option>
              <option value="4">Cycle 4</option>
              <option value="5">Cycle 5</option>
              <option value="6">Cycle 6</option>
              <option value="7">Cycle 7</option>
              <option value="8">Cycle 8</option>
              <option value="9">Cycle 9</option>
              <option value="10">Cycle 10</option>
            </select>
          </div>

          <div id="produceBillingCycleContainer" class="hidden">
            <button 
              onclick="produceBillingCycle()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Billing Cycle
            </button>
          </div>

          <div class="mt-4">
            <button 
              onclick="showPastBillingCycles()" 
              class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              View Past Cycles
            </button>
          </div>

          <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>

            <br>
            <button 
              onclick="produceBill()" 
              class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Produce Bill
            </button>

            <!-- PDF Display Container -->
            <div id="billPdfDisplay" class="hidden mt-4">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
              <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
            </div>
          </div>
        </div>

      `;

      // Repopulate the customer dropdown
      populateBillCustomerSelect();
    };

    window.processPaymentFromModule = async function() {

      const paymentModule = document.getElementById('paymentModule');

      if (window.currentPaymentBatch) {

      }

      const customerId = document.getElementById('paymentCustomerSelect')?.value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount')?.value);
      const paymentType = document.getElementById('paymentType')?.value || '';
      const cashReceived = parseFloat(document.getElementById('cashReceivedInput')?.value);
      const changeDueInput = parseFloat(document.getElementById('cashChangeDisplay')?.value);
      const checkReceivedInput = parseFloat(document.getElementById('checkReceivedInput')?.value);
      const checkChangeInput = parseFloat(document.getElementById('checkChangeDisplay')?.value);
      const checkNumberInput = document.getElementById('checkNumberInput')?.value || '';

      if (!customerId) {

        alert('Please select a customer');
        return;
      }

      if (!paymentAmount || paymentAmount <= 0) {

        alert('Please enter a valid payment amount');
        return;
      }

      if (!paymentType) {

        alert('Please select a payment type');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (customer) {

        // Process payment (same logic as existing processPayment function)
        const today = new Date();
        const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();

        // Add to payment history
        if (!customer.paymentHistory) {
          customer.paymentHistory = [];
        }
        customer.paymentHistory.push({
          date: formattedDate,
          amountPaid: paymentAmount,
          amountDue: customer.pastDue + (customer.currentBill || 0)
        });

        // Update customer balance
        customer.pastDue = Math.max(0, customer.pastDue - paymentAmount);

        // If customer was pending closing and now has no balance, mark as inactive
        if (customer.paymentStatus === 'pending closing' && customer.pastDue === 0 && customer.currentBill === 0) {
          customer.paymentStatus = 'inactive';
        } else {
          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);
        }

        // Update last payment
        customer.lastPayment = formattedDate;

        // Save only this customer to Firestore
        await saveSingleCustomerToFirestore(customer);

        updateDashboard();

        if (window.currentPaymentBatch) {

          let cashIn = 0;
          let cashOut = 0;
          let checkIn = 0;
          if (paymentType === 'Cash') {
            const received = !isNaN(cashReceived) ? cashReceived : paymentAmount;
            const change = Math.max(0, !isNaN(changeDueInput) ? changeDueInput : received - paymentAmount);
            cashIn = received;
            cashOut = change;
          } else if (paymentType === 'Check') {
            const received = !isNaN(checkReceivedInput) ? checkReceivedInput : paymentAmount;
            const change = Math.max(0, !isNaN(checkChangeInput) ? checkChangeInput : received - paymentAmount);
            checkIn = received;
            cashOut = change; // change given comes out of cash drawer
          }
          if (window.currentPaymentBatch.register && window.currentPaymentBatch.register.runningTotals) {
            window.currentPaymentBatch.register.runningTotals.cashIn += cashIn;
            window.currentPaymentBatch.register.runningTotals.cashOut += cashOut;
            window.currentPaymentBatch.register.runningTotals.checkIn += checkIn;
          }

          addEntryToCurrentBatch(customer, paymentAmount, paymentType, formattedDate, {
            cashReceived: !isNaN(cashReceived) ? cashReceived : null,
            changeGiven: paymentType === 'Cash' ? Math.max(0, (!isNaN(cashReceived) ? cashReceived : paymentAmount) - paymentAmount) : 0,
            checkReceived: !isNaN(checkReceivedInput) ? checkReceivedInput : null,
            checkChangeGiven: paymentType === 'Check' ? Math.max(0, (!isNaN(checkReceivedInput) ? checkReceivedInput : paymentAmount) - paymentAmount) : 0,
            checkNumber: checkNumberInput || null
          });

        } else {

          showPaymentSuccessScreen(customer.name, paymentAmount);
        }

      } else {

      }
    };

    // Show payment success screen
    window.showPaymentSuccessScreen = function(customerName, amount) {
      const paymentModule = document.getElementById('paymentModule');
      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Processed Successfully!</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>

          <h4 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Payment Processed Successfully!</h4>
          <p class="text-slate-600 dark:text-slate-400 mb-4">Payment of <span class="font-semibold text-green-600">$${amount.toFixed(2)}</span> has been processed for <span class="font-semibold">${customerName}</span></p>
          <p class="text-sm text-slate-500 dark:text-slate-400 mb-8">The payment has been recorded and the customer's account has been updated.</p>

          <div class="flex flex-col gap-4 justify-center">
            <button 
              onclick="resetPaymentForm()" 
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Make Another Payment
            </button>
            <button 
              onclick="hideAllModules()" 
              class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Exit
            </button>
          </div>
        </div>

      `;
    };

    // Reset payment form
    window.resetPaymentForm = function(keepHidden = false) {

      console.trace('[FLOW][resetPaymentForm][STEP 1.1] Stack trace to see who called this:');
      const paymentModule = document.getElementById('paymentModule');

      if (window.currentPaymentBatch) {

      }

      window.currentPaymentBatch = null;

      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Batches</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="batchStartSection" class="space-y-6 py-8 px-6 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-center">
          <p class="text-slate-700 dark:text-slate-100 text-base font-semibold">Group multiple payments into a batch, tag it with your username, and submit everything at once.</p>
          <p class="text-sm text-slate-500 dark:text-slate-300">Select your username and click "Start Batch" to begin capturing payments.</p>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center md:text-left">Select User</label>
              <select 
                id="batchStartUserSelect" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-green-500"
              >
                <option value="">Select a user...</option>
              </select>
            </div>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
              <button 
                onclick="startPaymentBatch()" 
                class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow">
                Start Batch
              </button>
              <button 
                onclick="viewPaymentBatches()" 
                class="w-full md:w-auto bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-3 px-6 rounded-xl shadow">
                View Batches
              </button>
            </div>
          </div>
        </div>

        <!-- Initial cash register count -->
        <div id="registerCountSection" class="hidden space-y-6 py-6 px-6 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-100">Cash Register Counting</h4>
              <p class="text-sm text-slate-500 dark:text-slate-400">Enter quantities to establish the initial register balance.</p>
            </div>
            <button onclick="cancelCurrentBatch()" class="text-sm text-slate-500 hover:text-slate-700">Cancel</button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
              <div class="grid grid-cols-2 gap-3">
                ${[1,2,5,10,20,50,100].map(v => `
                  <div class="flex items-center gap-2">
                    <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
                      <!-- Bill background -->
                      <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
                      <!-- Decorative border lines -->
                      <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
                      <!-- Center denomination -->
                      <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
                      <!-- Decorative lines -->
                      <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                      <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                    </svg>
                    <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
                    <input type="number" min="0" id="init_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRegisterTotal('init')">
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="space-y-3">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
              <div class="grid grid-cols-2 gap-3">
                ${[['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0']].map(([k,val,label,color]) => `
                  <div class="flex items-center gap-2">
                    <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
                      <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
                      <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
                      <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${k === 'penny' ? '1' : k === 'nickel' ? '5' : k === 'dime' ? '10' : k === 'quarter' ? '25' : '50'}</text>
                    </svg>
                    <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
                    <input type="number" min="0" id="init_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRegisterTotal('init')">
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Checks in Drawer</h5>
              <button onclick="addCheckInput('init')" class="text-sm text-blue-600 hover:text-blue-800">Add Check</button>
            </div>
            <div id="init_checksContainer" class="space-y-2">
              <div class="flex items-center gap-3">
                <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #1</label>
                <input type="number" min="0" step="0.01" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Amount" oninput="calculateRegisterTotal('init')" />
                <button onclick="removeCheckInput(this)" class="text-xs text-red-500">Remove</button>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <p id="initRegisterTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">Total: $0.00</p>
            </div>
            <div class="flex gap-3">
              <button onclick="calculateRegisterTotal('init')" class="px-4 py-2 text-sm bg-slate-200 rounded-lg">Recalculate</button>
              <button onclick="saveInitialRegisterCount()" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Save Initial Count</button>
            </div>
          </div>
        </div>

        <!-- Final recount before submit -->
        <div id="registerRecountSection" class="hidden space-y-6 py-6 px-6 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-100">Closing Register Count</h4>
              <p class="text-sm text-slate-500 dark:text-slate-400">Recount the drawer to balance the batch.</p>
            </div>
            <button onclick="backToBatchEntryFromRecount()" class="text-sm text-slate-500 hover:text-slate-700">Back</button>
          </div>

          <!-- Step Indicator -->
          <div class="flex items-center gap-4 mb-6">
            <button id="recountStep1Btn" onclick="switchRecountStep(1)" class="px-4 py-2 text-sm font-semibold bg-green-600 text-white rounded-lg">Step 1: Count Payment Total</button>
            <button id="recountStep2Btn" onclick="switchRecountStep(2)" class="px-4 py-2 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg">Step 2: Count Initial Total</button>
          </div>

          <!-- Step 1: Payment Count -->
          <div id="recountStep1" class="space-y-6">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
              <p class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">Count the payment total (money received during this batch)</p>
              <p id="expectedPaymentTotal" class="text-xs text-blue-600 dark:text-blue-400"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${[1,2,5,10,20,50,100].map(v => `
                    <div class="flex items-center gap-2">
                      <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
                        <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
                        <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
                        <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
                        <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                        <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                      </svg>
                      <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
                      <input type="number" min="0" id="payment_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRecountTotal('payment')">
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${[['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0']].map(([k,val,label,color]) => `
                    <div class="flex items-center gap-2">
                      <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
                        <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
                        <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${k === 'penny' ? '1' : k === 'nickel' ? '5' : k === 'dime' ? '10' : k === 'quarter' ? '25' : '50'}</text>
                      </svg>
                      <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
                      <input type="number" min="0" id="payment_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRecountTotal('payment')">
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Checks</h5>
                <button onclick="addCheckInput('payment')" class="text-sm text-blue-600 hover:text-blue-800">Add Check</button>
              </div>
              <div id="payment_checksContainer" class="space-y-2">
                <div class="flex items-center gap-3">
                  <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #1</label>
                  <input type="number" min="0" step="0.01" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Amount" oninput="calculateRecountTotal('payment')" />
                  <button onclick="removeCheckInput(this)" class="text-xs text-red-500">Remove</button>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <p id="paymentRecountTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">Payment Total: $0.00</p>
              <button onclick="switchRecountStep(2)" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Continue to Step 2</button>
            </div>
          </div>

          <!-- Step 2: Initial Count -->
          <div id="recountStep2" class="hidden space-y-6">
            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
              <p class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2">Count the initial total (what was in the drawer at the start)</p>
              <p id="expectedInitialTotal" class="text-xs text-green-600 dark:text-green-400"></p>
              <p id="originalInitialCount" class="text-xs text-green-600 dark:text-green-400 mt-2"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${[1,2,5,10,20,50,100].map(v => `
                    <div class="flex items-center gap-2">
                      <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
                        <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
                        <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
                        <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
                        <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                        <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
                      </svg>
                      <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
                      <input type="number" min="0" id="initial_recount_bill_${v}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRecountTotal('initial')">
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${[['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0']].map(([k,val,label,color]) => `
                    <div class="flex items-center gap-2">
                      <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
                        <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
                        <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${k === 'penny' ? '1' : k === 'nickel' ? '5' : k === 'dime' ? '10' : k === 'quarter' ? '25' : '50'}</text>
                      </svg>
                      <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
                      <input type="number" min="0" id="initial_recount_coin_${k}" class="w-24 px-3 py-2 border rounded-lg text-right" value="0" oninput="calculateRecountTotal('initial')">
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Checks</h5>
                <button onclick="addCheckInput('initial_recount')" class="text-sm text-blue-600 hover:text-blue-800">Add Check</button>
              </div>
              <div id="initial_recount_checksContainer" class="space-y-2">
                <div class="flex items-center gap-3">
                  <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #1</label>
                  <input type="number" min="0" step="0.01" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Amount" oninput="calculateRecountTotal('initial')" />
                  <button onclick="removeCheckInput(this)" class="text-xs text-red-500">Remove</button>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <p id="initialRecountTotal" class="text-sm font-semibold text-slate-700 dark:text-slate-100">Initial Total: $0.00</p>
                <p id="registerVarianceText" class="text-xs text-slate-500 mt-1"></p>
              </div>
              <div class="flex gap-3">
                <button onclick="switchRecountStep(1)" class="px-4 py-2 text-sm bg-slate-200 rounded-lg">Back to Step 1</button>
                <button onclick="finalizeBatchWithRecount()" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Submit Batch</button>
              </div>
            </div>
          </div>
        </div>

        <div id="batchEntrySection" class="hidden space-y-6 mt-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <p class="text-sm text-slate-500">Active Batch</p>
              <p class="text-lg font-semibold text-slate-800 dark:text-slate-200" id="activeBatchUser">--</p>
            </div>
            <div class="flex gap-3">
              <button onclick="cancelCurrentBatch()" class="text-sm text-slate-500 hover:text-slate-700">End Batch</button>
            </div>
          </div>

          <div class="space-y-6">
            <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
            <select id="paymentCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Choose a customer...</option>
            </select>
          </div>

          <div id="customerPaymentInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                <p id="paymentAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                <button id="viewDetailsBtn" onclick="showPaymentDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                  View Details
                </button>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                <p id="paymentPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                <p id="paymentLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                <p id="paymentPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                <p id="paymentDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                <span id="paymentStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <!-- Status will be populated by JavaScript -->
                </span>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Type</label>
              <select 
                id="paymentType" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                onchange="togglePaymentInputs()"
              >
                <option value="">Select Payment Type</option>
                <option value="Check">Check</option>
                <option value="Cash">Cash</option>
              </select>
            </div>

            <div class="mb-4 hidden">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
              <input 
                type="number" 
                id="paymentAmount" 
                step="0.01" 
                min="0" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter payment amount"
                oninput="updateCashChangeDisplay(); updateCheckChangeDisplay();"
              >
            </div>

            <div id="cashInputsContainer" class="hidden mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cash Received</label>
                <input 
                  type="number" 
                  id="cashReceivedInput" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Amount given by customer"
                  oninput="updateCashChangeDisplay()"
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Change Due</label>
                <input 
                  type="number" 
                  id="cashChangeDisplay" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="$0.00" 
                  readonly
                >
              </div>
            </div>

            <div id="checkInputsContainer" class="hidden mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Check Number</label>
                <input 
                  type="text" 
                  id="checkNumberInput" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter check number"
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Check Received</label>
                <input 
                  type="number" 
                  id="checkReceivedInput" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Amount on check"
                  oninput="updateCheckChangeDisplay()"
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Change Due</label>
                <input 
                  type="number" 
                  id="checkChangeDisplay" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="$0.00" 
                  readonly
                >
              </div>
            </div>

            <button 
              onclick="processPaymentFromModule()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Process Payment
            </button>
          </div>
        </div>

        <div id="batchPreviewSection" data-batch-section="preview" class="hidden mt-8 batch-preview-custom">
          <div class="w-full rounded-xl border border-slate-200 bg-white shadow-md overflow-hidden">
            <!-- Header -->
            <div class="border-b px-6 py-4 bg-slate-50 flex items-center justify-between">
              <h2 class="text-lg font-semibold text-slate-800">Batch Preview</h2>
              <button onclick="submitCurrentBatch()" class="px-4 py-2 text-sm bg-green-600 text-white rounded-md shadow hover:bg-green-700 transition">
                Submit Batch
              </button>
            </div>

            <!-- Scrollable Table Wrapper -->
            <div class="overflow-x-auto">
              <div class="min-w-[1100px] text-sm">
                <div class="grid grid-cols-[110px_180px_140px_220px_90px_110px_140px_110px] bg-slate-100 text-xs uppercase text-slate-600">
                  <div class="px-4 py-3 text-left font-semibold">Date</div>
                  <div class="px-4 py-3 text-left font-semibold">Customer</div>
                  <div class="px-4 py-3 text-left font-semibold">Account #</div>
                  <div class="px-4 py-3 text-left font-semibold">Property</div>
                  <div class="px-4 py-3 text-left font-semibold">Type</div>
                  <div class="px-4 py-3 text-right font-semibold">Amount</div>
                  <div class="px-4 py-3 text-right font-semibold">Change Given</div>
                  <div class="px-4 py-3 text-right font-semibold">Total Paid</div>
                </div>

                <div id="batchPreviewTable" class="divide-y divide-slate-100">
                  <!-- Filled by renderBatchPreview() -->
                </div>

                <div class="grid grid-cols-[110px_180px_140px_220px_90px_110px_140px_110px] bg-slate-100">
                  <div class="col-span-6"></div>
                  <div class="px-4 py-3 text-right font-semibold text-slate-700">Total Paid</div>
                  <div id="batchPreviewTotal" class="px-4 py-3 text-right font-bold text-slate-900">$0.00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="batchesListSection" data-batch-section="list" class="hidden mt-8">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Submitted Batches</h4>
            <button onclick="closeBatchList()" class="text-sm text-slate-500 hover:text-slate-700">Close</button>
          </div>
          <div class="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-inner">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Batch ID</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">User</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Entries</th>
                  <th class="px-4 py-2 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Amount</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Submitted</th>
                  <th class="px-4 py-2 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="batchesListTable" class="bg-white divide-y divide-slate-200">
                <tr>
                  <td colspan="6" class="px-4 py-3 text-center text-sm text-slate-500">No batches submitted yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;

      // Repopulate dropdowns and ensure sections/logs are in sync

      populatePaymentCustomerSelect();
      populateBatchStartUserSelect();

      setBatchViewState('start');

      renderBatchPreview();

      renderBatchesList();
      // If keepHidden is true, ensure payment module stays hidden (for initial page load)
      if (keepHidden) {
        paymentModule.classList.add('hidden');
      }

      debugBatchDom('after-reset');

    };

    function debugBatchDom(label) {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule) {

        return;
      }
      const snapshot = {
        hasStart: !!paymentModule.querySelector('#batchStartSection'),
        hasEntry: !!paymentModule.querySelector('#batchEntrySection'),
        hasPreview: !!paymentModule.querySelector('#batchPreviewSection'),
        hasPreviewTable: !!paymentModule.querySelector('#batchPreviewTable'),
        hasList: !!paymentModule.querySelector('#batchesListSection'),
        hasListTable: !!paymentModule.querySelector('#batchesListTable')
      };

    }

    function setBatchViewState(view) {
      console.log('[SET VIEW STATE] Setting view state to:', view);

      // Ensure payment module is visible
      const paymentModule = document.getElementById('paymentModule');
      if (paymentModule) {
        const wasHidden = paymentModule.classList.contains('hidden');
        paymentModule.classList.remove('hidden');
        console.log('[SET VIEW STATE] Payment module was hidden?', wasHidden, 'Now visible:', !paymentModule.classList.contains('hidden'));
      } else {
        console.error('[SET VIEW STATE] Payment module not found!');
      }

      const sections = {
        start: document.getElementById('batchStartSection'),
        register: document.getElementById('registerCountSection'),
        entry: document.getElementById('batchEntrySection'),
        preview: document.getElementById('batchPreviewSection'),
        recount: document.getElementById('registerRecountSection'),
        list: document.getElementById('batchesListSection')
      };

      console.log('[SET VIEW STATE] Section elements found:', Object.entries(sections).map(([name, el]) => `${name}: ${!!el}`).join(', '));

      Object.entries(sections).forEach(([name, el]) => {
        if (!el) {
          if (view === name) {
            console.error(`[SET VIEW STATE] Section '${name}' not found but view state is '${view}'!`);
          }
          return;
        }
        const wasHidden = el.classList.contains('hidden');
        if (view === name) {
          el.classList.remove('hidden');
          console.log(`[SET VIEW STATE] Showing section '${name}', was hidden: ${wasHidden}`);
        } else {
          el.classList.add('hidden');
        }
      });

      // When viewing list, hide Active Batch and Select Customer sections
      const batchEntrySection = document.getElementById('batchEntrySection');
      if (view === 'list') {
        if (batchEntrySection) {
          batchEntrySection.classList.add('hidden');
          batchEntrySection.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
        }
      }

      debugBatchDom('view-' + view);

      const target = sections[view];
      if (target) {
        console.log('[SET VIEW STATE] Target section found, scrolling into view');
        requestAnimationFrame(() => {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      } else {
        console.error(`[SET VIEW STATE] Target section '${view}' not found!`);
      }

    }

    function showBatchEntryWithPreview() {
      const idsToHide = ['batchStartSection', 'registerCountSection', 'registerRecountSection', 'batchesListSection'];
      idsToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
      const entry = document.getElementById('batchEntrySection');
      const preview = document.getElementById('batchPreviewSection');
      if (entry) {
        entry.classList.remove('hidden');
        entry.style.cssText = '';
      }
      if (preview) {
        preview.classList.remove('hidden');
        preview.style.cssText = '';
      }
    }

    function resetBatchEntryForm() {
      const select = document.getElementById('paymentCustomerSelect');
      if (select) select.value = '';
      hideCustomerPaymentInfo();
      const paymentTypeField = document.getElementById('paymentType');
      if (paymentTypeField) paymentTypeField.value = '';
      const paymentAmountField = document.getElementById('paymentAmount');
      if (paymentAmountField) paymentAmountField.value = '';
      const cashReceived = document.getElementById('cashReceivedInput');
      if (cashReceived) cashReceived.value = '';
      const cashChange = document.getElementById('cashChangeDisplay');
      if (cashChange) cashChange.value = '';
      const checkNumber = document.getElementById('checkNumberInput');
      if (checkNumber) checkNumber.value = '';
      const checkReceived = document.getElementById('checkReceivedInput');
      if (checkReceived) checkReceived.value = '';
      const checkChange = document.getElementById('checkChangeDisplay');
      if (checkChange) checkChange.value = '';
      togglePaymentInputs();
    }

    // Helpers for register counting (prefix init|close)
    const billDenoms = [1, 2, 5, 10, 20, 50, 100];
    const coinDenoms = [
      { key: 'penny', value: 0.01 },
      { key: 'nickel', value: 0.05 },
      { key: 'dime', value: 0.10 },
      { key: 'quarter', value: 0.25 },
      { key: 'half', value: 0.50 }
    ];

    window.addCheckInput = function(prefix) {
      const container = document.getElementById(`${prefix}_checksContainer`);
      if (!container) return;
      const idx = container.children.length + 1;
      const row = document.createElement('div');
      row.className = 'flex items-center gap-3';
      const calcFunc = (prefix === 'payment' || prefix === 'initial_recount') ? 'calculateRecountTotal' : 'calculateRegisterTotal';
      const calcParam = prefix === 'payment' ? 'payment' : (prefix === 'initial_recount' ? 'initial' : prefix);
      row.innerHTML = `
        <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #${idx}</label>
        <input type="number" min="0" step="0.01" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Amount" oninput="${calcFunc}('${calcParam}')" />
        <button onclick="removeCheckInput(this)" class="text-xs text-red-500">Remove</button>
      `;
      container.appendChild(row);
    };

    window.removeCheckInput = function(btn) {
      const row = btn.closest('div');
      if (row && row.parentElement) {
        row.parentElement.removeChild(row);
      }
    };

    function readRegisterCounts(prefix) {
      const bills = {};
      const coins = {};
      let cashTotal = 0;
      billDenoms.forEach(v => {
        const el = document.getElementById(`${prefix}_bill_${v}`);
        const qty = el ? parseFloat(el.value) || 0 : 0;
        bills[v] = qty;
        cashTotal += qty * v;
      });
      coinDenoms.forEach(({ key, value }) => {
        const el = document.getElementById(`${prefix}_coin_${key}`);
        const qty = el ? parseFloat(el.value) || 0 : 0;
        coins[key] = qty;
        cashTotal += qty * value;
      });
      const checksContainer = document.getElementById(`${prefix}_checksContainer`);
      const checks = [];
      if (checksContainer) {
        checksContainer.querySelectorAll('input[type="number"]').forEach(input => {
          const amt = parseFloat(input.value);
          if (!isNaN(amt) && amt > 0) checks.push(amt);
        });
      }
      const checksTotal = checks.reduce((s, v) => s + v, 0);
      const total = cashTotal + checksTotal;
      return { bills, coins, checks, cashTotal, checksTotal, total };
    }

    window.calculateRegisterTotal = function(prefix) {
      const result = readRegisterCounts(prefix);
      const target = document.getElementById(prefix === 'init' ? 'initRegisterTotal' : 'closeRegisterTotal');
      if (target) {
        target.textContent = `Total: $${result.total.toFixed(2)}`;
      }
      return result;
    };

    window.startPaymentBatch = function() {
      const userSelect = document.getElementById('batchStartUserSelect');
      const username = userSelect ? userSelect.value.trim() : '';

      if (!username) {
        alert('Please select a user before starting a batch.');
        return;
      }

      // Calculate day of year (1-365/366)
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);

      // Generate batch ID: [username][dayOfYear]
      // Remove spaces from username for the ID
      const usernameForId = username.replace(/\s+/g, '');
      const batchId = `${usernameForId}${dayOfYear}-${Date.now()}`;

      window.currentPaymentBatch = {
        id: batchId,
        username: username,
        startedAt: new Date().toISOString(),
        entries: [],
        register: {
          initial: null,
          closing: null,
          runningTotals: { cashIn: 0, cashOut: 0, checkIn: 0 }
        }
      };

      const activeUserLabel = document.getElementById('activeBatchUser');
      if (activeUserLabel) activeUserLabel.textContent = username;

      // Move to register counting view
      setBatchViewState('register');
      calculateRegisterTotal('init');
    };

    window.cancelCurrentBatch = function() {
      if (!window.currentPaymentBatch) {
        setBatchViewState('start');
        return;
      }

      if (!confirm('End the current batch? Unsubmitted entries will be lost.')) {
        return;
      }

      window.currentPaymentBatch = null;
      renderBatchPreview();
      setBatchViewState('start');

    };

    window.saveInitialRegisterCount = function() {
      if (!window.currentPaymentBatch) {
        alert('Start a batch first.');
        return;
      }
      const initial = calculateRegisterTotal('init');
      window.currentPaymentBatch.register.initial = {
        ...initial,
        recordedAt: new Date().toISOString()
      };
      window.currentPaymentBatch.register.runningTotals = window.currentPaymentBatch.register.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };
      renderBatchPreview();
      setBatchViewState('entry');
      addAnotherBatchEntry();
    };

    window.addAnotherBatchEntry = function() {
      if (!window.currentPaymentBatch) {
        alert('Start a batch before adding entries.');
        return;
      }

      setBatchViewState('entry');
      debugBatchDom('add-entry');
      resetBatchEntryForm();

    };

    window.togglePaymentInputs = function() {
      const type = document.getElementById('paymentType')?.value;
      const cashContainer = document.getElementById('cashInputsContainer');
      const checkContainer = document.getElementById('checkInputsContainer');
      if (cashContainer) cashContainer.classList.add('hidden');
      if (checkContainer) checkContainer.classList.add('hidden');
      if (type === 'Cash') {
        if (cashContainer) cashContainer.classList.remove('hidden');
        updateCashChangeDisplay();
      } else if (type === 'Check') {
        if (checkContainer) {
          checkContainer.classList.remove('hidden');
          updateCheckChangeDisplay();
        }
      }
    };

    window.updateCashChangeDisplay = function() {
      const paymentAmount = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
      const cashReceived = parseFloat(document.getElementById('cashReceivedInput')?.value) || paymentAmount;
      const change = Math.max(0, cashReceived - paymentAmount);
      const display = document.getElementById('cashChangeDisplay');
      if (display) display.value = change.toFixed(2);
    };

    window.updateCheckChangeDisplay = function() {
      const paymentAmount = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
      const checkReceived = parseFloat(document.getElementById('checkReceivedInput')?.value) || paymentAmount;
      const change = Math.max(0, checkReceived - paymentAmount);
      const display = document.getElementById('checkChangeDisplay');
      if (display) display.value = change.toFixed(2);
    };

    function renderBatchesOnlyView() {
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule) {
        console.error('[BATCH LIST VIEW] Payment module not found');
        return;
      }

      paymentModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Batches</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="batchesListSection" data-batch-section="list" class="mt-4">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Submitted Batches</h4>
            <button onclick="closeBatchList()" class="text-sm text-slate-500 hover:text-slate-700">Close</button>
          </div>
          <div class="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-inner">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Batch ID</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">User</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Entries</th>
                  <th class="px-4 py-2 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Amount</th>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Submitted</th>
                  <th class="px-4 py-2 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="batchesListTable" class="bg-white divide-y divide-slate-200">
                <tr>
                  <td colspan="6" class="px-4 py-3 text-center text-sm text-slate-500">No batches submitted yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    window.viewPaymentBatches = async function() {
      console.log('[VIEW BATCHES] Starting viewPaymentBatches...');
      console.log('[VIEW BATCHES] Current batches in array before load:', window.paymentBatches?.length || 0);

      // Ensure payment module is visible
      const paymentModule = document.getElementById('paymentModule');
      if (!paymentModule) {
        console.error('[VIEW BATCHES] Payment module not found!');
        return;
      }

      paymentModule.classList.remove('hidden');
      paymentModule.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';

      // Rebuild the module UI to only show the batches list
      renderBatchesOnlyView();

      await loadPaymentBatchesFromFirestore();
      renderBatchesList();

      console.log('[VIEW BATCHES] viewPaymentBatches complete');
    };

    window.closeBatchList = function() {
      resetPaymentForm();

    };

    window.submitCurrentBatch = async function() {
      if (!window.currentPaymentBatch) {
        alert('Start a batch before submitting.');
        return;
      }

      if (window.currentPaymentBatch.entries.length === 0) {
        alert('Add at least one payment to the batch.');
        return;
      }

      if (!window.currentPaymentBatch.register || !window.currentPaymentBatch.register.initial) {
        alert('Please record the initial register count before submitting.');
        return;
      }

      const running = window.currentPaymentBatch.register.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };
      const initial = window.currentPaymentBatch.register.initial;
      const expectedCash = (initial.cashTotal || 0) + (running.cashIn || 0) - (running.cashOut || 0);
      const expectedChecks = (initial.checksTotal || 0) + (running.checkIn || 0);
      const expectedTotal = expectedCash + expectedChecks;
      const initialCash = initial.cashTotal || 0;
      const initialChecks = initial.checksTotal || 0;
      const receivedCash = (running.cashIn || 0) - (running.cashOut || 0);
      const receivedChecks = running.checkIn || 0;
      
      // Populate expected values for Step 1 (Payment Count)
      const expectedPaymentTotal = receivedCash + receivedChecks;
      const expectedPaymentTotalText = document.getElementById('expectedPaymentTotal');
      if (expectedPaymentTotalText) {
        expectedPaymentTotalText.innerHTML =
          `<strong>Expected Payment Total:</strong> $${expectedPaymentTotal.toFixed(2)} (received cash ${receivedCash.toFixed(2)}, received checks ${receivedChecks.toFixed(2)})`;
      }
      
      // Populate expected values for Step 2 (Initial Count)
      const expectedInitialTotal = initialCash + initialChecks;
      const expectedInitialTotalText = document.getElementById('expectedInitialTotal');
      if (expectedInitialTotalText) {
        expectedInitialTotalText.innerHTML =
          `<strong>Expected Initial Total:</strong> $${expectedInitialTotal.toFixed(2)} (initial cash ${initialCash.toFixed(2)}, initial checks ${initialChecks.toFixed(2)})`;
      }
      

      // Reset recount step to 1
      switchRecountStep(1);
      setBatchViewState('recount');
      // Force-hide entry/preview when moving to recount
      ['batchEntrySection','batchPreviewSection','batchStartSection','registerCountSection','batchesListSection'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.add('hidden');
          el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
        }
      });
      const recount = document.getElementById('registerRecountSection');
      if (recount) {
        recount.classList.remove('hidden');
        recount.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    window.backToBatchEntryFromRecount = function() {
      if (!window.currentPaymentBatch) {
        setBatchViewState('start');
        return;
      }
      showBatchEntryWithPreview();
    };

    window.switchRecountStep = function(step) {
      // Validate payment count before proceeding to step 2
      if (step === 2) {
        if (!window.currentPaymentBatch || !window.currentPaymentBatch.register) {
          alert('No batch data found.');
          return;
        }
        
        const running = window.currentPaymentBatch.register.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };
        const expectedPaymentCash = (running.cashIn || 0) - (running.cashOut || 0);
        const expectedPaymentChecks = running.checkIn || 0;
        const expectedPaymentTotal = expectedPaymentCash + expectedPaymentChecks;
        
        const paymentCountTotal = calculateRecountTotal('payment');
        const paymentVariance = paymentCountTotal - expectedPaymentTotal;
        
        if (Math.abs(paymentVariance) > 0.01) {
          const statusMsg = `Payment count ${paymentVariance > 0 ? 'over' : 'short'} by $${Math.abs(paymentVariance).toFixed(2)}. Please correct the count before continuing.`;
          alert(statusMsg);
          return;
        }
      }
      
      const step1 = document.getElementById('recountStep1');
      const step2 = document.getElementById('recountStep2');
      const btn1 = document.getElementById('recountStep1Btn');
      const btn2 = document.getElementById('recountStep2Btn');
      
      if (step === 1) {
        if (step1) step1.classList.remove('hidden');
        if (step2) step2.classList.add('hidden');
        if (btn1) {
          btn1.classList.remove('bg-slate-200', 'text-slate-700');
          btn1.classList.add('bg-green-600', 'text-white');
        }
        if (btn2) {
          btn2.classList.remove('bg-green-600', 'text-white');
          btn2.classList.add('bg-slate-200', 'text-slate-700');
        }
      } else if (step === 2) {
        if (step1) step1.classList.add('hidden');
        if (step2) step2.classList.remove('hidden');
        if (btn1) {
          btn1.classList.remove('bg-green-600', 'text-white');
          btn1.classList.add('bg-slate-200', 'text-slate-700');
        }
        if (btn2) {
          btn2.classList.remove('bg-slate-200', 'text-slate-700');
          btn2.classList.add('bg-green-600', 'text-white');
        }
      }
    };

    window.calculateRecountTotal = function(type) {
      let total = 0;
      const prefix = type === 'payment' ? 'payment' : 'initial_recount';
      
      // Calculate bills
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`${prefix}_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          total += count * v;
        }
      });
      
      // Calculate coins
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50]].forEach(([k,val]) => {
        const input = document.getElementById(`${prefix}_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          total += count * val;
        }
      });
      
      // Calculate checks
      const checksContainer = document.getElementById(`${prefix}_checksContainer`);
      if (checksContainer) {
        const checkInputs = checksContainer.querySelectorAll('input[type="number"]');
        checkInputs.forEach(input => {
          const amount = parseFloat(input.value) || 0;
          total += amount;
        });
      }
      
      // Update display
      const totalElement = document.getElementById(type === 'payment' ? 'paymentRecountTotal' : 'initialRecountTotal');
      if (totalElement) {
        totalElement.textContent = `${type === 'payment' ? 'Payment' : 'Initial'} Total: $${total.toFixed(2)}`;
      }
      
      return total;
    };

    window.finalizeBatchWithRecount = async function() {
      console.log('[FINALIZE BATCH] Starting batch finalization...');
      
      if (!window.currentPaymentBatch) {
        console.error('[FINALIZE BATCH] No current batch found!');
        alert('Start a batch before submitting.');
        return;
      }

      console.log('[FINALIZE BATCH] Current batch ID:', window.currentPaymentBatch.id);
      console.log('[FINALIZE BATCH] Current batch entries:', window.currentPaymentBatch.entries.length);

      const running = window.currentPaymentBatch.register.runningTotals || { cashIn: 0, cashOut: 0, checkIn: 0 };
      const initial = window.currentPaymentBatch.register.initial || { cashTotal: 0, checksTotal: 0, total: 0 };

      // Calculate expected values
      const expectedPaymentCash = (running.cashIn || 0) - (running.cashOut || 0);
      const expectedPaymentChecks = running.checkIn || 0;
      const expectedPaymentTotal = expectedPaymentCash + expectedPaymentChecks;
      
      const expectedInitialCash = initial.cashTotal || 0;
      const expectedInitialChecks = initial.checksTotal || 0;
      const expectedInitialTotal = expectedInitialCash + expectedInitialChecks;
      
      const expectedTotal = expectedInitialTotal + expectedPaymentTotal;

      // Get counted values
      const paymentCountTotal = calculateRecountTotal('payment');
      const initialCountTotal = calculateRecountTotal('initial');
      
      // Calculate variances
      const paymentVariance = paymentCountTotal - expectedPaymentTotal;
      const initialVariance = initialCountTotal - expectedInitialTotal;
      const totalVariance = (paymentCountTotal + initialCountTotal) - expectedTotal;

      console.log('[FINALIZE BATCH] Payment count:', paymentCountTotal, 'Expected:', expectedPaymentTotal, 'Variance:', paymentVariance);
      console.log('[FINALIZE BATCH] Initial count:', initialCountTotal, 'Expected:', expectedInitialTotal, 'Variance:', initialVariance);
      console.log('[FINALIZE BATCH] Total variance:', totalVariance);

      // Check payment count
      if (Math.abs(paymentVariance) > 0.01) {
        const statusMsg = `Payment count ${paymentVariance > 0 ? 'over' : 'short'} by $${Math.abs(paymentVariance).toFixed(2)}. Please try again.`;
        alert(statusMsg);
        return;
      }

      // Check initial count
      if (Math.abs(initialVariance) > 0.01) {
        const statusMsg = `Initial count ${initialVariance > 0 ? 'over' : 'short'} by $${Math.abs(initialVariance).toFixed(2)}. Please try again.`;
        alert(statusMsg);
        return;
      }

      // Collect payment count details
      const paymentCount = {
        bills: {},
        coins: {},
        checks: [],
        cashTotal: 0,
        checksTotal: 0,
        total: paymentCountTotal
      };
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`payment_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          paymentCount.bills[v] = count;
          paymentCount.cashTotal += count * v;
        }
      });
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50]].forEach(([k,val]) => {
        const input = document.getElementById(`payment_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          paymentCount.coins[k] = count;
          paymentCount.cashTotal += count * val;
        }
      });
      const paymentChecksContainer = document.getElementById('payment_checksContainer');
      if (paymentChecksContainer) {
        const checkInputs = paymentChecksContainer.querySelectorAll('input[type="number"]');
        checkInputs.forEach(input => {
          const amount = parseFloat(input.value) || 0;
          if (amount > 0) {
            paymentCount.checks.push(amount);
            paymentCount.checksTotal += amount;
          }
        });
      }

      // Collect initial count details
      const initialCount = {
        bills: {},
        coins: {},
        checks: [],
        cashTotal: 0,
        checksTotal: 0,
        total: initialCountTotal
      };
      [1,2,5,10,20,50,100].forEach(v => {
        const input = document.getElementById(`initial_recount_bill_${v}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          initialCount.bills[v] = count;
          initialCount.cashTotal += count * v;
        }
      });
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50]].forEach(([k,val]) => {
        const input = document.getElementById(`initial_recount_coin_${k}`);
        if (input) {
          const count = parseFloat(input.value) || 0;
          initialCount.coins[k] = count;
          initialCount.cashTotal += count * val;
        }
      });
      const initialChecksContainer = document.getElementById('initial_recount_checksContainer');
      if (initialChecksContainer) {
        const checkInputs = initialChecksContainer.querySelectorAll('input[type="number"]');
        checkInputs.forEach(input => {
          const amount = parseFloat(input.value) || 0;
          if (amount > 0) {
            initialCount.checks.push(amount);
            initialCount.checksTotal += amount;
          }
        });
      }

      window.currentPaymentBatch.register.closing = {
        paymentCount,
        initialCount,
        recordedAt: new Date().toISOString(),
        expectedPaymentTotal,
        expectedInitialTotal,
        expectedTotal,
        paymentVariance,
        initialVariance,
        variance: totalVariance
      };

      const totalAmount = window.currentPaymentBatch.entries.reduce((sum, entry) => sum + entry.amount, 0);
      const submittedBatch = {
        ...window.currentPaymentBatch,
        submittedAt: new Date().toISOString(),
        totalAmount
      };

      console.log('[FINALIZE BATCH] Prepared submitted batch:', submittedBatch.id);
      console.log('[FINALIZE BATCH] Batch total amount:', totalAmount);
      
      // Add to local array first
      window.paymentBatches.push(submittedBatch);
      console.log('[FINALIZE BATCH] Added to local array. Total batches in array:', window.paymentBatches.length);
      
      // Save to Firestore
      console.log('[FINALIZE BATCH] Saving to Firestore...');
      await saveBatchToFirestore(submittedBatch);
      console.log('[FINALIZE BATCH] Save complete, waiting 500ms before reload...');
      
      // Small delay to ensure Firestore write propagates
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Reload from Firestore to get fresh data
      console.log('[FINALIZE BATCH] Reloading from Firestore...');
      await loadPaymentBatchesFromFirestore();
      console.log('[FINALIZE BATCH] Reload complete. Batches in array:', window.paymentBatches.length);
      
      alert('Batch submitted. Register balanced.');

      window.currentPaymentBatch = null;
      renderBatchPreview();
      renderBatchesList();
      setBatchViewState('list');

      console.log('[FINALIZE BATCH] Calling viewPaymentBatches...');
      viewPaymentBatches();
      console.log('[FINALIZE BATCH] Batch finalization complete');
    };

    function addEntryToCurrentBatch(customer, paymentAmount, paymentType, paymentDate, extra = {}) {

      if (!window.currentPaymentBatch) {

        return;
      }

      const paymentModule = document.getElementById('paymentModule');

      const entry = {
        id: `ENTRY-${Date.now()}`,
        customerName: customer.name,
        accountNumber: customer.accountNumber || customer.id,
        property: customer.address || 'N/A',
        paymentType,
        amount: paymentAmount,
        date: paymentDate,
        cashReceived: extra.cashReceived || null,
        changeGiven: extra.changeGiven || 0,
        checkReceived: extra.checkReceived || null,
        checkChangeGiven: extra.checkChangeGiven || 0,
        checkNumber: extra.checkNumber || null
      };

      window.currentPaymentBatch.entries.push(entry);

      const previewSectionBefore = document.getElementById('batchPreviewSection');
      const previewTableBefore = document.getElementById('batchPreviewTable');

      // Render the preview table first

      renderBatchPreview();

      const previewSectionAfter = document.getElementById('batchPreviewSection');
      const previewTableAfter = document.getElementById('batchPreviewTable');

      // Then switch to preview view - ensure preview section exists and is visible

      const previewSection = document.getElementById('batchPreviewSection');
      if (!previewSection) {

        return;
      }

      setBatchViewState('preview');
      showBatchEntryWithPreview();

      // IMMEDIATE: Force preview section visible right after setBatchViewState
      const immediatePreviewSection = document.getElementById('batchPreviewSection');
      if (immediatePreviewSection) {
        // Remove hidden class
        immediatePreviewSection.classList.remove('hidden');

        // FORCE visibility with inline styles that override everything
        immediatePreviewSection.style.cssText = `
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          position: relative !important;
          width: 100% !important;
        `;

        // Check parent containers
        let parent = immediatePreviewSection.parentElement;
        let depth = 0;
        while (parent && depth < 5) {
          const parentStyle = window.getComputedStyle(parent);

          // Force parent visible if needed
          if (parent.classList.contains('hidden')) {
            parent.classList.remove('hidden');
            parent.style.display = 'block';
            parent.style.visibility = 'visible';
            parent.style.opacity = '1';

          }

          parent = parent.parentElement;
          depth++;
        }

        const immediateRect = immediatePreviewSection.getBoundingClientRect();

        // Force scroll into view immediately
        immediatePreviewSection.scrollIntoView({ behavior: 'auto', block: 'start', inline: 'nearest' });

        // Also ensure payment module is visible
        if (paymentModule) {
          paymentModule.classList.remove('hidden');
          paymentModule.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          `;

        }
      } else {

      }

      // Double-check preview section is visible

      // Force payment module visible
      if (paymentModule.classList.contains('hidden')) {

        paymentModule.classList.remove('hidden');
      }

      // Force preview section visible
      if (previewSection.classList.contains('hidden')) {

        previewSection.classList.remove('hidden');

      } else {

      }

      // Check computed styles to verify visibility
      const previewSectionStyle = window.getComputedStyle(previewSection);
      const paymentModuleStyle = window.getComputedStyle(paymentModule);

      // Final verification after a short delay
      setTimeout(() => {
        const finalPreviewSection = document.getElementById('batchPreviewSection');
        const finalPaymentModule = document.getElementById('paymentModule');
        const finalTable = document.getElementById('batchPreviewTable');

        // AGGRESSIVE: Force everything visible
        if (finalPaymentModule) {
          finalPaymentModule.classList.remove('hidden');
          finalPaymentModule.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          `;
        }

        if (finalPreviewSection) {
          finalPreviewSection.classList.remove('hidden');
          // FORCE visibility without breaking layout
          finalPreviewSection.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
          `;

          // Force the table inside to be visible too
          if (finalTable) {
            finalTable.style.cssText = `
              display: table !important;
              visibility: visible !important;
              width: 100% !important;
            `;
          }

          // Scroll preview section into view
          finalPreviewSection.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });

          // Check bounding rect to verify it's actually visible
          const rect = finalPreviewSection.getBoundingClientRect();

          // If still zero dimensions, try even more aggressive approach
          if (rect.width === 0 || rect.height === 0) {

            // Try appending to body temporarily to see if it's a parent issue
            const originalParent = finalPreviewSection.parentElement;
            document.body.appendChild(finalPreviewSection);
            const bodyRect = finalPreviewSection.getBoundingClientRect();

            // Put it back
            originalParent.appendChild(finalPreviewSection);
          }
        }

        if (finalTable) {
          const tableRect = finalTable.getBoundingClientRect();

        }
      }, 100);

      resetBatchEntryForm();
      debugBatchDom('after-add-entry');

    }

    function renderBatchPreview() {
      const tbody = document.getElementById("batchPreviewTable");
      const totalCell = document.getElementById("batchPreviewTotal");

      // If tbody doesn't exist, just return
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!window.currentPaymentBatch || !window.currentPaymentBatch.entries || window.currentPaymentBatch.entries.length === 0) {
        tbody.innerHTML = `
          <div class="grid grid-cols-[110px_180px_140px_220px_90px_110px_120px_110px]">
            <div class="col-span-8 px-4 py-3 text-center text-sm text-slate-500">
              No payments added yet.
            </div>
          </div>
        `;
        if (totalCell) totalCell.textContent = "$0.00";
        return;
      }

      window.currentPaymentBatch.entries.forEach(entry => {
        const row = document.createElement("div");
        row.className = "grid grid-cols-[110px_180px_140px_220px_90px_110px_140px_110px] hover:bg-slate-50 transition-colors";

        // Format property as multi-line (the KEY fix)
        const [street, cityStateZip] = entry.property.split(/,(.+)/);

        const receivedAmount = entry.paymentType === 'Cash'
          ? (entry.cashReceived ?? entry.amount)
          : (entry.checkReceived ?? entry.amount);
        const changeGiven = entry.paymentType === 'Cash'
          ? (entry.changeGiven || 0)
          : (entry.checkChangeGiven || 0);
        row.innerHTML = `
            <div class="px-4 py-4 align-top whitespace-nowrap">${entry.date || ''}</div>
            <div class="px-4 py-4 align-top whitespace-nowrap">${entry.customerName || ''}</div>
            <div class="px-4 py-4 align-top whitespace-nowrap">${entry.accountNumber || ''}</div>
            <div class="px-4 py-4 align-top leading-5">
                ${street || ''}${cityStateZip ? ',<br>' + cityStateZip.trim() : ''}
            </div>
            <div class="px-4 py-4 align-top whitespace-nowrap">${entry.paymentType || ''}</div>
            <div class="px-4 py-4 align-top text-right whitespace-nowrap">$${(receivedAmount || 0).toFixed(2)}</div>
            <div class="px-4 py-4 align-top text-right whitespace-nowrap">$${(changeGiven || 0).toFixed(2)}</div>
            <div class="px-4 py-4 align-top text-right whitespace-nowrap">$${(entry.amount || 0).toFixed(2)}</div>
        `;

        tbody.appendChild(row);
      });

      // Update total
      const total = window.currentPaymentBatch.entries.reduce((sum, e) => sum + (e.amount || 0), 0);
      if (totalCell) {
        totalCell.textContent = `$${total.toFixed(2)}`;
      }
    }

    function renderBatchesList() {
      console.log('[RENDER BATCHES] Starting render...');
      const tbody = document.getElementById('batchesListTable');
      if (!tbody) {
        console.error('[RENDER BATCHES] batchesListTable not found in DOM!');
        console.error('[RENDER BATCHES] Payment module exists?', !!document.getElementById('paymentModule'));
        console.error('[RENDER BATCHES] Batches list section exists?', !!document.getElementById('batchesListSection'));
        debugBatchDom('renderList-missing');
        return;
      }

      console.log('[RENDER BATCHES] Found tbody element:', tbody);
      console.log('[RENDER BATCHES] paymentBatches array:', window.paymentBatches);
      console.log('[RENDER BATCHES] paymentBatches length:', window.paymentBatches?.length || 0);

      if (!window.paymentBatches || window.paymentBatches.length === 0) {
        console.log('[RENDER BATCHES] No batches to display, showing empty message');
        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-3 text-center text-sm text-slate-500">No batches submitted yet.</td></tr>`;
        return;
      }

      console.log('[RENDER BATCHES] Rendering', window.paymentBatches.length, 'batches');
      let rows = '';
      window.paymentBatches.slice().reverse().forEach((batch, index) => {
        console.log(`[RENDER BATCHES] Processing batch ${index + 1}:`, batch.id, 'Username:', batch.username, 'Entries:', batch.entries?.length || 0);
        const submitted = batch.submittedAt ? new Date(batch.submittedAt).toLocaleString() : '';
        rows += `
          <tr>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.id}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.username}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${batch.entries?.length || 0}</td>
            <td class="px-4 py-2 text-sm text-slate-700 text-right">$${(batch.totalAmount || 0).toFixed(2)}</td>
            <td class="px-4 py-2 text-sm text-slate-700">${submitted}</td>
            <td class="px-4 py-2 text-sm text-slate-700 text-center">
              <button onclick="openBatchDetails('${batch.id.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 mr-2">Open</button>
              <button onclick="deleteBatch('${batch.id.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
            </td>
          </tr>
        `;
      });

      console.log('[RENDER BATCHES] Setting innerHTML with', rows.split('<tr>').length - 1, 'rows');
      console.log('[RENDER BATCHES] HTML content:', rows.substring(0, 200) + '...');
      tbody.innerHTML = rows;
      
      // Force table row visibility
      Array.from(tbody.children).forEach((row, idx) => {
        row.style.cssText = 'display: table-row !important; visibility: visible !important;';
        console.log(`[RENDER BATCHES] Row ${idx} set, display:`, window.getComputedStyle(row).display);
      });
      
      // Verify it was set
      setTimeout(() => {
        console.log('[RENDER BATCHES] Verification - tbody.innerHTML length:', tbody.innerHTML.length);
        console.log('[RENDER BATCHES] Verification - tbody.children.length:', tbody.children.length);
        console.log('[RENDER BATCHES] Verification - tbody computed display:', window.getComputedStyle(tbody).display);
        const listSection = document.getElementById('batchesListSection');
        if (listSection) {
          console.log('[RENDER BATCHES] batchesListSection hidden?', listSection.classList.contains('hidden'));
          console.log('[RENDER BATCHES] batchesListSection display style:', window.getComputedStyle(listSection).display);
          console.log('[RENDER BATCHES] batchesListSection computed visibility:', window.getComputedStyle(listSection).visibility);
          console.log('[RENDER BATCHES] batchesListSection computed opacity:', window.getComputedStyle(listSection).opacity);
          console.log('[RENDER BATCHES] batchesListSection bounding rect:', listSection.getBoundingClientRect());
        }
        const table = tbody.closest('table');
        if (table) {
          console.log('[RENDER BATCHES] Table computed display:', window.getComputedStyle(table).display);
          console.log('[RENDER BATCHES] Table computed visibility:', window.getComputedStyle(table).visibility);
        }
      }, 200);
      
      console.log('[RENDER BATCHES] Render complete');

    }

    window.openBatchDetails = function(batchId) {
      console.log('[BATCH DETAILS] Opening batch:', batchId);
      const batch = window.paymentBatches.find(b => b.id === batchId);
      if (!batch) {
        alert('Batch not found');
        return;
      }

      // Create modal HTML
      let entriesHtml = '';
      if (batch.entries && batch.entries.length > 0) {
        entriesHtml = batch.entries.map(entry => {
          const receivedAmount = entry.paymentType === 'Cash'
            ? (entry.cashReceived ?? entry.amount)
            : (entry.checkReceived ?? entry.amount);
          const changeGiven = entry.paymentType === 'Cash'
            ? (entry.changeGiven || 0)
            : (entry.checkChangeGiven || 0);
          
          return '<tr class="border-b border-slate-200">' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.date || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.customerName || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.accountNumber || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.property || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700">' + (entry.paymentType || '') + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700 text-right">$' + (receivedAmount || 0).toFixed(2) + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700 text-right">$' + (changeGiven || 0).toFixed(2) + '</td>' +
            '<td class="px-4 py-3 text-sm text-slate-700 text-right">$' + (entry.amount || 0).toFixed(2) + '</td>' +
            '</tr>';
        }).join('');
      }

      const submitted = batch.submittedAt ? new Date(batch.submittedAt).toLocaleString() : '';
      const started = batch.startedAt ? new Date(batch.startedAt).toLocaleString() : '';

      const modalHtml = `
        <div id="batchDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-slate-800">Batch Details</h2>
              <button onclick="closeBatchDetailsModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
              <div>
                <p class="text-sm text-slate-600">Batch ID</p>
                <p class="text-lg font-semibold text-slate-800">${batch.id}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">User</p>
                <p class="text-lg font-semibold text-slate-800">${batch.username || ''}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Started</p>
                <p class="text-sm text-slate-700">${started}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Submitted</p>
                <p class="text-sm text-slate-700">${submitted}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Total Amount</p>
                <p class="text-lg font-bold text-green-600">$${(batch.totalAmount || 0).toFixed(2)}</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">Entries</p>
                <p class="text-lg font-semibold text-slate-800">${batch.entries?.length || 0}</p>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full border-collapse text-sm">
                <thead class="bg-slate-100">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Date</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Customer</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Account #</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Property</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Type</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Amount</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Change Given</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase">Total Paid</th>
                  </tr>
                </thead>
                <tbody>
                  ${entriesHtml || '<tr><td colspan="8" class="px-4 py-3 text-center text-slate-500">No entries</td></tr>'}
                </tbody>
                <tfoot class="bg-slate-100">
                  <tr>
                    <td colspan="5" class="px-4 py-3 text-right font-semibold text-slate-700">Total Paid</td>
                    <td colspan="3" class="px-4 py-3 text-right font-bold text-slate-900">$${(batch.totalAmount || 0).toFixed(2)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="mt-6 space-y-4">
              <div class="flex flex-wrap gap-3">
                ${batch.register?.initial ? `<button onclick="viewDenominations('${batchId}', 'initial1')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">View Initial Count #1</button>` : ''}
                ${batch.register?.closing?.initialCount ? `<button onclick="viewDenominations('${batchId}', 'initial2')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">View Initial Count #2</button>` : ''}
                ${batch.register?.closing?.paymentCount ? `<button onclick="viewDenominations('${batchId}', 'payment')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">View Payment Count</button>` : ''}
              </div>
              <div class="flex justify-end">
                <button onclick="closeBatchDetailsModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('batchDetailsModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    window.closeBatchDetailsModal = function() {
      const modal = document.getElementById('batchDetailsModal');
      if (modal) {
        modal.remove();
      }
    };

    window.viewDenominations = function(batchId, type) {
      const batch = window.paymentBatches.find(b => b.id === batchId);
      if (!batch) {
        alert('Batch not found');
        return;
      }

      let countData = null;
      let title = '';
      
      if (type === 'initial1') {
        countData = batch.register?.initial;
        title = 'Initial Count #1 Denominations';
      } else if (type === 'initial2') {
        countData = batch.register?.closing?.initialCount;
        title = 'Initial Count #2 Denominations';
      } else if (type === 'payment') {
        countData = batch.register?.closing?.paymentCount;
        title = 'Payment Count Denominations';
      }

      if (!countData) {
        alert('Count data not available for this batch');
        return;
      }

      // Build bills HTML
      const billsHtml = [1,2,5,10,20,50,100].map(v => {
        const count = countData.bills?.[v] || 0;
        return `
          <div class="flex items-center gap-2">
            <svg class="w-10 h-6" viewBox="0 0 40 24" fill="none">
              <rect x="2" y="2" width="36" height="20" rx="1.5" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
              <rect x="4" y="4" width="32" height="16" rx="1" fill="none" stroke="#81C784" stroke-width="0.5" opacity="0.5"/>
              <text x="20" y="15" font-size="10" font-weight="bold" fill="#1B5E20" text-anchor="middle">$${v}</text>
              <line x1="6" y1="11" x2="12" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
              <line x1="28" y1="11" x2="34" y2="11" stroke="#66BB6A" stroke-width="0.5"/>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300">$${v}</label>
            <input type="number" class="w-24 px-3 py-2 border rounded-lg text-right bg-slate-100" value="${count}" readonly>
          </div>
        `;
      }).join('');

      // Build coins HTML
      const coinsHtml = [['penny',0.01,'Pennies','#CD7F32'],['nickel',0.05,'Nickels','#C0C0C0'],['dime',0.10,'Dimes','#C0C0C0'],['quarter',0.25,'Quarters','#C0C0C0'],['half',0.50,'Half Dollars','#C0C0C0']].map(([k,val,label,color]) => {
        const count = countData.coins?.[k] || 0;
        return `
          <div class="flex items-center gap-2">
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" fill="${color}" stroke="#333" stroke-width="1"/>
              <circle cx="12" cy="12" r="8" fill="none" stroke="#333" stroke-width="0.5" opacity="0.3"/>
              <text x="12" y="15" text-anchor="middle" font-size="6" font-weight="bold" fill="#333">${k === 'penny' ? '1' : k === 'nickel' ? '5' : k === 'dime' ? '10' : k === 'quarter' ? '25' : '50'}</text>
            </svg>
            <label class="text-sm text-slate-600 dark:text-slate-300">${label}</label>
            <input type="number" class="w-24 px-3 py-2 border rounded-lg text-right bg-slate-100" value="${count}" readonly>
          </div>
        `;
      }).join('');

      // Build checks HTML
      const checks = countData.checks || [];
      const checksHtml = checks.length > 0 
        ? checks.map((amount, idx) => `
            <div class="flex items-center gap-3">
              <label class="text-sm text-slate-600 dark:text-slate-300 w-24">Check #${idx + 1}</label>
              <input type="number" step="0.01" class="flex-1 px-3 py-2 border rounded-lg bg-slate-100" value="${amount.toFixed(2)}" readonly>
            </div>
          `).join('')
        : '<p class="text-sm text-slate-500">No checks</p>';

      // Calculate total
      let total = 0;
      // Bills
      [1,2,5,10,20,50,100].forEach(v => {
        const count = countData.bills?.[v] || 0;
        total += count * v;
      });
      // Coins
      [['penny',0.01],['nickel',0.05],['dime',0.10],['quarter',0.25],['half',0.50]].forEach(([k,val]) => {
        const count = countData.coins?.[k] || 0;
        total += count * val;
      });
      // Checks
      checks.forEach(amount => {
        total += amount;
      });

      const modalHtml = `
        <div id="denominationsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-slate-800">${title}</h2>
              <button onclick="closeDenominationsModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Bills</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${billsHtml}
                </div>
              </div>

              <div class="space-y-3">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Coins</h5>
                <div class="grid grid-cols-2 gap-3">
                  ${coinsHtml}
                </div>
              </div>
            </div>

            <div class="space-y-3 mt-6">
              <div class="flex items-center justify-between">
                <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Checks in Drawer</h5>
              </div>
              <div class="space-y-2">
                ${checksHtml}
              </div>
            </div>

            <div class="mt-6 flex items-center justify-between border-t border-slate-200 pt-4">
              <p class="text-lg font-semibold text-slate-700 dark:text-slate-100">Total: $${total.toFixed(2)}</p>
              <button onclick="closeDenominationsModal()" class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">Close</button>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('denominationsModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    window.closeDenominationsModal = function() {
      const modal = document.getElementById('denominationsModal');
      if (modal) {
        modal.remove();
      }
    };

    window.deleteBatch = async function(batchId) {
      if (!confirm('Are you sure you want to delete this batch? This action cannot be undone.')) {
        return;
      }

      console.log('[DELETE BATCH] Deleting batch:', batchId);
      
      try {
        // Delete from Firestore
        const batchesRef = collection(db, 'paymentBatches');
        const batchRef = doc(batchesRef, batchId);
        await deleteDoc(batchRef);
        console.log('[DELETE BATCH] Successfully deleted from Firestore');

        // Remove from local array
        window.paymentBatches = window.paymentBatches.filter(b => b.id !== batchId);
        console.log('[DELETE BATCH] Removed from local array. Remaining batches:', window.paymentBatches.length);

        // Re-render the list
        renderBatchesList();
        
        alert('Batch deleted successfully');
      } catch (error) {
        console.error('[DELETE BATCH] Error deleting batch:', error);
        alert('Error deleting batch: ' + error.message);
      }
    };

    // Add Client Module Functions
    function populateAddClientLocationSelect() {
      const select = document.getElementById('newClientLocation');
      select.innerHTML = '<option value="">Choose a location...</option><option value="add-new">+ Add New Location</option>';

      // Show all locations, not just available ones
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = `${location.address} (${location.status})`;
        select.appendChild(option);
      });

      // Add event listener for add new location
      select.addEventListener('change', function() {
        if (this.value === 'add-new') {
          showAddLocationModal();
        }
      });
    }

    window.addClientFromModule = async function() {
      const name = document.getElementById('newClientName').value.trim();
      const email = document.getElementById('newClientEmail').value.trim();
      const phone = document.getElementById('newClientPhone').value.replace(/\D/g, '');
      const locationId = document.getElementById('newClientLocation').value;

      // Get new fields
      const entityType = document.getElementById('newClientEntityType')?.value || '';
      const ssn = document.getElementById('newClientSSN')?.value.trim() || '';
      const idType = document.getElementById('newClientIDType')?.value || '';
      const idNumber = document.getElementById('newClientIDNumber')?.value.trim() || '';
      const secondaryContactName = document.getElementById('newClientSecondaryContactName')?.value.trim() || '';
      const secondaryContactPhone = document.getElementById('newClientSecondaryContactPhone')?.value.replace(/\D/g, '') || '';
      const mailingStreet = document.getElementById('newClientMailingStreet')?.value.trim() || '';
      const mailingCity = document.getElementById('newClientMailingCity')?.value.trim() || '';
      const mailingState = document.getElementById('newClientMailingState')?.value || '';
      const mailingZip = document.getElementById('newClientMailingZip')?.value.trim() || '';

      // Build mailing address
      let mailingAddress = '';
      if (mailingStreet || mailingCity || mailingState || mailingZip) {
        const parts = [];
        if (mailingStreet) parts.push(mailingStreet);
        if (mailingCity || mailingState || mailingZip) {
          const cityStateZip = [mailingCity, mailingState, mailingZip].filter(Boolean).join(', ');
          parts.push(cityStateZip);
        }
        mailingAddress = parts.join(', ');
      }

      // Get selected codes
      const selectedCodes = window.selectedClientCodes.map(code => ({
        id: code.id,
        name: code.name,
        type: code.type || 'percentage',
        amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
        percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
      }));

      // Get factor
      const factor = document.getElementById('newClientFactor')?.value.trim() || '';
      
      // Get cycle number
      const cycleNumber = document.getElementById('newClientCycleNumber')?.value.trim() || '';

      if (!name || !email || !phone || !locationId) {
        alert('Please fill in all required fields');
        return;
      }

      if (locationId === 'add-new') {
        alert('Please select a location or add a new one first');
        return;
      }

      const selectedLocation = locations.find(l => l.id === locationId);
      if (!selectedLocation) {
        alert('Selected location not found');
        return;
      }

      // Check if location is already occupied
      if (selectedLocation.status === 'occupied' && selectedLocation.currentResident) {
        const currentResident = customers.find(c => c.name === selectedLocation.currentResident);
        if (currentResident) {
          showTransferOwnershipModal(selectedLocation, currentResident, { 
            name, 
            email, 
            phone,
            entityType,
            ssn,
            idType,
            idNumber,
            secondaryContactName,
            secondaryContactPhone,
            mailingAddress,
            mailingStreet,
        mailingCity,
        mailingState,
        mailingZip,
        codes: selectedCodes,
        factor: factor,
        cycleNumber: cycleNumber || null
      });
          return;
        }
      }

      // Create new customer (same logic as existing addCustomer function)
      const newCustomer = {
        id: 'CUS-' + String(Date.now()).slice(-6), // Use accountNumber as ID
        name: name,
        email: email,
        phone: phone,
        address: selectedLocation.address,
        accountNumber: 'CUS-' + String(Date.now()).slice(-6),
        currentBill: sewerCharge,
        pastDue: 0,
        lastPayment: 'Never',
        paymentHistory: [],
        needsPasswordChange: true,
        createdDate: new Date().toISOString(),
        entityType: entityType,
        ssn: ssn,
        idType: idType,
        idNumber: idNumber,
        secondaryContactName: secondaryContactName,
        secondaryContactPhone: secondaryContactPhone,
        mailingAddress: mailingAddress,
        mailingStreet: mailingStreet,
        mailingCity: mailingCity,
        mailingState: mailingState,
        mailingZip: mailingZip,
        codes: selectedCodes,
        factor: factor
      };

      // Update payment status based on past due amount
      updateCustomerPaymentStatus(newCustomer);

      customers.push(newCustomer);
      filteredCustomers = [...customers];

      // Update location
      selectedLocation.currentResident = name;
      selectedLocation.status = 'occupied';
      selectedLocation.ownerFullName = name;
      const nameParts = name.split(' ');
      selectedLocation.ownerFirstName = nameParts[0] || '';
      selectedLocation.ownerLastName = nameParts.slice(1).join(' ') || '';

      // Clear selected codes after creation
      window.selectedClientCodes = [];
      updateClientCodesList();

      // Save only this customer to Firestore
      await saveSingleCustomerToFirestore(customer);
      await saveLocationsToFirestore();
      updateDashboard();

      // Show success screen instead of hiding module
      showClientSuccessScreen();
    };

    // Show client success screen
    window.showClientSuccessScreen = function() {
      const addClientModule = document.getElementById('addClientModule');
      addClientModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Client Successfully Added!</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>

          <h4 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Client Added Successfully!</h4>
          <p class="text-slate-600 dark:text-slate-400 mb-8">The client has been added to the system successfully</p>

          <div class="flex flex-col gap-4 justify-center">
            <button 
              onclick="resetAddClientForm()" 
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Add Another Client
            </button>
            <button 
              onclick="hideAllModules()" 
              class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-8 rounded-xl transition-colors duration-200"
            >
              Exit
            </button>
          </div>
        </div>
      `;
    };

    // Reset add client form
    window.resetAddClientForm = function() {
      const addClientModule = document.getElementById('addClientModule');
      addClientModule.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Client</h3>
          <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Account Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              type="text" 
              id="newClientName" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter full name"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
            <input 
              type="email" 
              id="newClientEmail" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter email address"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <input 
              type="tel" 
              id="newClientPhone" 
              oninput="formatPhoneInput(this)"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="(xxx)-xxx-xxxx"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <select id="newClientLocation" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" required>
              <option value="">Choose a location...</option>
              <option value="add-new">+ Add New Location</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <select id="newClientEntityType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              <option value="">Select Entity Type</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Farmer">Farmer</option>
            </select>
          </div>
        </div>
        </div>

        <!-- Identification Info Section -->
        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Identification Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
              <input 
                type="text" 
                id="newClientSSN" 
                oninput="formatSSNInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="xxx-xx-xxxx"
                maxlength="11"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
              <select id="newClientIDType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Select ID Type</option>
                <option value="Drivers License">Drivers License</option>
                <option value="ID">ID</option>
                <option value="Passport">Passport</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
              <input 
                type="text" 
                id="newClientIDNumber" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter ID number"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
              <input 
                type="text" 
                id="newClientSecondaryContactName" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter secondary contact name"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
              <input 
                type="tel" 
                id="newClientSecondaryContactPhone" 
                oninput="formatPhoneInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="(xxx)-xxx-xxxx"
              >
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
              <input 
                type="text" 
                id="newClientMailingStreet" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter street address"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <input 
                type="text" 
                id="newClientMailingCity" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter city"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <select id="newClientMailingState" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Select State</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
              <input 
                type="text" 
                id="newClientMailingZip" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter ZIP code"
                maxlength="10"
              >
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
          <div id="newClientCodesList" class="space-y-2">
            <!-- Selected codes will be displayed here -->
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
            <input 
              type="number" 
              id="newClientFactor" 
              step="any"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter factor"
            >
          </div>
        </div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Cycle Number</h4>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cycle Number</label>
            <input 
              type="number" 
              id="newClientCycleNumber" 
              min="1"
              max="10"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter cycle number (1-10)"
            >
          </div>
        </div>

        <div class="mt-6">
          <button 
            onclick="addClientFromModule()" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
          >
            Create Client Account
          </button>
        </div>
      `;

      // Repopulate the location dropdown
      populateAddClientLocationSelect();
      // Populate codes dropdown
      populateAddClientCodeSelect();
      // Clear selected codes
      window.selectedClientCodes = [];
      updateClientCodesList();

      // Add event listener to Entity Type dropdown for auto-adding codes
      const entityTypeSelect = document.getElementById('newClientEntityType');
      if (entityTypeSelect) {
        // Remove existing listeners by cloning the element
        const newEntityTypeSelect = entityTypeSelect.cloneNode(true);
        entityTypeSelect.parentNode.replaceChild(newEntityTypeSelect, entityTypeSelect);

        newEntityTypeSelect.addEventListener('change', function() {
          const selectedEntityType = this.value;
          // Auto-add matching codes based on Entity Type
          autoAddCodesForEntityType(selectedEntityType);
        });
      }
    };

    // Check if a code matches the selected Entity Type
    function codeMatchesEntityType(code, entityType) {
      if (!entityType || !code.requirements) {
        return false;
      }

      // Handle new requirements structure with AND/OR logic
      if (code.requirements && code.requirements.values && Array.isArray(code.requirements.values)) {
        const entityTypeInValues = code.requirements.values.includes(entityType);

        if (code.requirements.type === 'OR') {
          // OR logic: Entity Type must be in the values array
          return entityTypeInValues;
        } else if (code.requirements.type === 'AND') {
          // AND logic: For now, we'll check if Entity Type is in values
          // (Full AND logic would require Entity Type to match all values, which isn't possible with single selection)
          return entityTypeInValues;
        }
      }

      // Handle old array format (backward compatibility)
      if (Array.isArray(code.requirements)) {
        return code.requirements.includes(entityType);
      }

      return false;
    }

    // Automatically add codes based on Entity Type
    function autoAddCodesForEntityType(entityType) {
      if (!entityType) {
        return;
      }

      // Check each code to see if it matches the Entity Type
      codes.forEach(code => {
        if (codeMatchesEntityType(code, entityType)) {
          // Check if code is already added
          if (!window.selectedClientCodes.find(c => c.id === code.id)) {
            window.selectedClientCodes.push(code);
          }
        }
      });

      updateClientCodesList();
    }

    // Populate codes dropdown for Add Client form
    function populateAddClientCodeSelect() {
      const select = document.getElementById('newClientCodeSelect');
      if (!select) return;

      select.innerHTML = '<option value="">Select a code...</option>';
      codes.forEach(code => {
        const option = document.createElement('option');
        option.value = code.id;
        const codeType = code.type || 'percentage';
        const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
        const displayText = codeType === 'flat' 
          ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
          : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
        option.textContent = displayText;
        select.appendChild(option);
      });
    }

    // Initialize selected codes array
    window.selectedClientCodes = [];
    window.selectedCustomerCodes = [];

    // Add code to client
    window.addClientCode = function() {
      const select = document.getElementById('newClientCodeSelect');
      if (!select || !select.value) {
        alert('Please select a code first');
        return;
      }

      const codeId = select.value;
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      // Check if already added
      if (window.selectedClientCodes.find(c => c.id === codeId)) {
        alert('This code has already been added');
        select.value = '';
        return;
      }

      window.selectedClientCodes.push(code);
      select.value = '';
      updateClientCodesList();
    };

    // Remove code from client
    window.removeClientCode = function(codeId) {
      window.selectedClientCodes = window.selectedClientCodes.filter(c => c.id !== codeId);
      updateClientCodesList();
    };

    // Update codes list display
    function updateClientCodesList() {
      const listContainer = document.getElementById('newClientCodesList');
      if (!listContainer) return;

      if (window.selectedClientCodes.length === 0) {
        listContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400">No codes selected</p>';
        return;
      }

        listContainer.innerHTML = window.selectedClientCodes.map(code => {
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          return `
          <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
            <span class="text-sm text-slate-800 dark:text-slate-200">${displayText}</span>
          <button 
            type="button"
            onclick="removeClientCode('${code.id}')" 
            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-sm"
          >
            Remove
          </button>
        </div>
      `;
        }).join('');
    }

    // Add code to customer (for Add Customer modal)
    window.addCustomerCode = function() {
      const select = document.getElementById('newCustomerCodeSelect');
      if (!select || !select.value) {
        alert('Please select a code first');
        return;
      }

      const codeId = select.value;
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      // Check if already added
      if (window.selectedCustomerCodes.find(c => c.id === codeId)) {
        alert('This code has already been added');
        select.value = '';
        return;
      }

      window.selectedCustomerCodes.push(code);
      select.value = '';
      updateCustomerCodesList();
    };

    // Remove code from customer
    window.removeCustomerCode = function(codeId) {
      window.selectedCustomerCodes = window.selectedCustomerCodes.filter(c => c.id !== codeId);
      updateCustomerCodesList();
    };

    // Update customer codes list display
    function updateCustomerCodesList() {
      const listContainer = document.getElementById('newCustomerCodesList');
      if (!listContainer) return;

      if (window.selectedCustomerCodes.length === 0) {
        listContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400">No codes selected</p>';
        return;
      }

        listContainer.innerHTML = window.selectedCustomerCodes.map(code => {
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          return `
          <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
            <span class="text-sm text-slate-800 dark:text-slate-200">${displayText}</span>
          <button 
            type="button"
            onclick="removeCustomerCode('${code.id}')" 
            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-sm"
          >
            Remove
          </button>
        </div>
      `;
        }).join('');
    }

    // Search Module Functions
    window.performSearch = function() {
      const nameQuery = document.getElementById('searchByName').value.toLowerCase().trim();
      const statusFilter = document.getElementById('searchByStatus').value;

      let results = customers;

      // Filter by name
      if (nameQuery) {
        results = results.filter(customer => 
          customer.name.toLowerCase().includes(nameQuery)
        );
      }

      // Filter by status
      if (statusFilter) {
        results = results.filter(customer => 
          customer.paymentStatus === statusFilter
        );
      }

      displaySearchResults(results);
    };

    window.clearSearch = function() {
      document.getElementById('searchByName').value = '';
      document.getElementById('searchByStatus').value = '';
      document.getElementById('searchResults').innerHTML = '';
    };

    function displaySearchResults(results) {
      const container = document.getElementById('searchResults');

      if (results.length === 0) {
        container.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">No customers found matching your search criteria.</p>';
        return;
      }

      let html = '<div class="space-y-4">';
      results.forEach(customer => {
        const serviceCost = calculateProratedServiceCost(customer);
        const lateFeeAmount = customer.pastDue > 0 ? lateFee : 0;
        const totalAmount = serviceCost + lateFeeAmount;

        const statusClass = customer.paymentStatus === 'overdue' ? 
          'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
          customer.paymentStatus === 'inactive' ?
          'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200' :
          customer.paymentStatus === 'pending closing' ?
          'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
          'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';

        html += `
          <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-semibold text-slate-800 dark:text-slate-200">${customer.name}</h4>
                <p class="text-sm text-slate-600 dark:text-slate-400">${customer.email}</p>
                <p class="text-sm text-slate-600 dark:text-slate-400">${customer.accountNumber}</p>
              </div>
              <div class="text-right">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                  ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
                </span>
                <p class="text-lg font-semibold text-slate-800 dark:text-slate-200 mt-2">$${totalAmount.toFixed(2)}</p>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    // Add new customer
    window.showAddCustomerModal = function() {
      // Populate location dropdown with all locations
      const locationSelect = document.getElementById('newCustomerLocation');
      locationSelect.innerHTML = '<option value="">Select a property location</option>';

      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = `${location.address} (${location.status})`;
        locationSelect.appendChild(option);
      });

      // Populate codes dropdown
      const codeSelect = document.getElementById('newCustomerCodeSelect');
      if (codeSelect) {
        codeSelect.innerHTML = '<option value="">Select a code...</option>';
        codes.forEach(code => {
          const option = document.createElement('option');
          option.value = code.id;
          const codeType = code.type || 'percentage';
          const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
          const displayText = codeType === 'flat' 
            ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
            : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
          option.textContent = displayText;
          codeSelect.appendChild(option);
        });
      }

      // Clear selected codes
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();

      document.getElementById('addCustomerModal').classList.remove('hidden');
    };

    window.hideAddCustomerModal = function() {
      document.getElementById('addCustomerModal').classList.add('hidden');
      document.getElementById('addCustomerForm').reset();
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();
    };

    window.addCustomer = async function() {
      const name = document.getElementById('newCustomerName').value;
      const email = document.getElementById('newCustomerEmail').value;
      const locationId = document.getElementById('newCustomerLocation').value;
      const phone = document.getElementById('newCustomerPhone').value.replace(/\D/g, ''); // Store as digits only

      // Get new fields
      const entityType = document.getElementById('newCustomerEntityType')?.value || '';
      const ssn = document.getElementById('newCustomerSSN')?.value.trim() || '';
      const idType = document.getElementById('newCustomerIDType')?.value || '';
      const idNumber = document.getElementById('newCustomerIDNumber')?.value.trim() || '';
      const secondaryContactName = document.getElementById('newCustomerSecondaryContactName')?.value.trim() || '';
      const secondaryContactPhone = document.getElementById('newCustomerSecondaryContactPhone')?.value.replace(/\D/g, '') || '';
      const mailingStreet = document.getElementById('newCustomerMailingStreet')?.value.trim() || '';
      const mailingCity = document.getElementById('newCustomerMailingCity')?.value.trim() || '';
      const mailingState = document.getElementById('newCustomerMailingState')?.value || '';
      const mailingZip = document.getElementById('newCustomerMailingZip')?.value.trim() || '';

      // Build mailing address
      let mailingAddress = '';
      if (mailingStreet || mailingCity || mailingState || mailingZip) {
        const parts = [];
        if (mailingStreet) parts.push(mailingStreet);
        if (mailingCity || mailingState || mailingZip) {
          const cityStateZip = [mailingCity, mailingState, mailingZip].filter(Boolean).join(', ');
          parts.push(cityStateZip);
        }
        mailingAddress = parts.join(', ');
      }

      // Get selected codes
      const selectedCodes = window.selectedCustomerCodes.map(code => ({
        id: code.id,
        name: code.name,
        type: code.type || 'percentage',
        amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
        percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
      }));

      // Get factor
      const factor = document.getElementById('newCustomerFactor')?.value.trim() || '';
      
      // Get cycle number
      const cycleNumber = document.getElementById('newCustomerCycleNumber')?.value.trim() || '';

      if (!name || !email || !locationId || !phone) {
        alert('Please fill in all required fields');
        return;
      }

      // Find the selected location
      const selectedLocation = locations.find(l => l.id === locationId);
      if (!selectedLocation) {
        alert('Selected location not found');
        return;
      }

      if (selectedLocation.status === 'occupied') {
        alert('This location is already occupied. Please select an available location.');
        return;
      }

      // Calculate current month's bill
      const now = new Date();
      const isNewMonth = now.getDate() === 1; // Check if it's the first of the month

      const newCustomer = {
        id: `CUS-${String(customers.length + 1).padStart(6, '0')}`,
        name: name,
        email: email,
        locationId: locationId,
        address: selectedLocation.address,
        accountNumber: `CUS-${String(customers.length + 1).padStart(6, '0')}`,
        currentBill: isNewMonth ? sewerCharge : 0, // New bill on 1st of month, otherwise 0
        pastDue: 0,
        lastPayment: 'Never',
        needsPasswordChange: true,
        createdDate: (() => {
          const today = new Date();
          return (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                 today.getDate().toString().padStart(2, '0') + '/' + 
                 today.getFullYear();
        })(),
        phone: phone,
        paymentHistory: [], // Track payment history
        entityType: entityType,
        ssn: ssn,
        idType: idType,
        idNumber: idNumber,
        secondaryContactName: secondaryContactName,
        secondaryContactPhone: secondaryContactPhone,
        mailingAddress: mailingAddress,
        mailingStreet: mailingStreet,
        mailingCity: mailingCity,
        mailingState: mailingState,
        mailingZip: mailingZip,
        codes: selectedCodes,
        factor: factor,
        cycleNumber: cycleNumber || null
      };

      // Update payment status based on past due amount
      updateCustomerPaymentStatus(newCustomer);

      // Update location status and owner
      selectedLocation.currentResident = name;
      selectedLocation.status = 'occupied';
      selectedLocation.ownerFirstName = name.split(' ')[0];
      selectedLocation.ownerLastName = name.split(' ').slice(1).join(' ');
      selectedLocation.ownerFullName = name;

      customers.push(newCustomer);
      filteredCustomers = [...customers];

      // Clear selected codes after creation
      window.selectedCustomerCodes = [];
      updateCustomerCodesList();

      updateDashboard();
      await saveCustomersToFirestore();
      hideAddCustomerModal();

      alert('Customer added successfully!');
    };

    // Mark customer as paid
    window.markAsPaid = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        const today = new Date();
        const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();

        customer.pastDue = 0;
        customer.lastPayment = formattedDate;
        customer.currentBill = 0; // Reset current bill to 0 for early payment
        // Update payment status based on past due amount
        updateCustomerPaymentStatus(customer);
        updateDashboard();
        await saveCustomersToFirestore();
        alert('Payment recorded successfully! Amount due is now $0.00 until next month.');
      }
    };

    // Edit customer
    window.editCustomer = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        const newName = prompt('Enter new name:', customer.name);
        const newAddress = prompt('Enter new address:', customer.address);

        if (newName && newAddress) {
          customer.name = newName;
          customer.address = newAddress;
          updateDashboard();
          await saveCustomersToFirestore();
          alert('Customer updated successfully!');
        }
      }
    };

    // Delete customer
    window.deleteCustomer = async function(customerId) {
      if (confirm('Are you sure you want to delete this customer? This will permanently delete their account and all associated data.')) {
        const customer = customers.find(c => c.id === customerId);

        if (!customer) {
          alert('Customer not found');
          return;
        }

        try {
          // Delete customer document from Firestore
          const customerRef = doc(db, 'customers', customerId);
          await deleteDoc(customerRef);

          // Remove from local arrays FIRST
          customers = customers.filter(c => c.id !== customerId);
          filteredCustomers = [...customers];

          // Find and update the associated location
          const associatedLocation = locations.find(l => l.currentResident === customer.name);
          if (associatedLocation) {
            associatedLocation.currentResident = null;
            associatedLocation.status = 'available';
            associatedLocation.ownerFirstName = '';
            associatedLocation.ownerLastName = '';
            associatedLocation.ownerFullName = '';

            // Update filtered locations if needed
            const filteredLocationIndex = filteredLocations.findIndex(l => l.id === associatedLocation.id);
            if (filteredLocationIndex !== -1) {
              filteredLocations[filteredLocationIndex] = associatedLocation;
            }

            // Save location changes to Firestore
            await saveLocationsToFirestore();
          }

          // Reload data from Firestore to ensure UI is in sync
          await loadCustomersFromFirestore();

          // Update displays
          updateDashboard();
          updateSettingsCustomerTable();

          alert('Customer deleted successfully! Password will be reset to "password" on next login and all payment history has been cleared.');
        } catch (error) {

          alert('Error deleting customer: ' + error.message);
        }
      }
    };

    // Delete all user data
    window.deleteAllUserData = async function() {
      const confirmMessage = 'Are you sure you want to delete ALL customer data? This action cannot be undone and will permanently delete all customers from the database.';
      if (!confirm(confirmMessage)) {
        return;
      }

      // Double confirmation
      const doubleConfirm = confirm('This will delete ALL customer data. Type OK to confirm, or Cancel to abort.');
      if (!doubleConfirm) {
        return;
      }

      try {

        // Show progress modal
        const deleteProgressModal = document.getElementById('deleteProgressModal');
        const deleteProgress = document.getElementById('deleteProgress');
        const deleteProgressText = document.getElementById('deleteProgressText');
        const deleteProgressBar = document.getElementById('deleteProgressBar');
        const deleteProgressStats = document.getElementById('deleteProgressStats');

        if (deleteProgressModal) {
          deleteProgressModal.classList.remove('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.remove('hidden');
        }

        const customersRef = collection(db, 'customers');

        // Get all customers from Firestore
        const existingCustomers = await getDocs(customersRef);
        const totalCustomers = existingCustomers.size;
        const customerDocs = [];
        existingCustomers.forEach(doc => {
          customerDocs.push(doc);
        });

        // Process deletions in batches with progress updates (using Firestore batch writes)
        const batchSize = 500; // Firestore batch limit
        let deletedCount = 0;

        for (let i = 0; i < customerDocs.length; i += batchSize) {
          const batch = writeBatch(db);
          const batchDocs = customerDocs.slice(i, Math.min(i + batchSize, customerDocs.length));
          
          batchDocs.forEach(doc => {
            batch.delete(doc.ref);
          });

          await batch.commit();
          deletedCount += batchDocs.length;
          
          // Small delay between batches to avoid rate limiting
          if (i + batchSize < customerDocs.length) {
            await new Promise(resolve => setTimeout(resolve, 200));
          }

          // Update progress
          const percent = Math.round((deletedCount / totalCustomers) * 100);
          if (deleteProgressText) {
            deleteProgressText.textContent = `${deletedCount} / ${totalCustomers}`;
          }
          if (deleteProgressBar) {
            deleteProgressBar.style.width = percent + '%';
          }
          if (deleteProgressStats) {
            deleteProgressStats.textContent = `Deleted: ${deletedCount} of ${totalCustomers} customers`;
          }

          // Allow UI to update
          await new Promise(resolve => setTimeout(resolve, 0));
        }

        // Update progress to 100%
        if (deleteProgressText) {
          deleteProgressText.textContent = `${totalCustomers} / ${totalCustomers}`;
        }
        if (deleteProgressBar) {
          deleteProgressBar.style.width = '100%';
        }
        if (deleteProgressStats) {
          deleteProgressStats.textContent = `Deleted: ${totalCustomers} of ${totalCustomers} customers`;
        }

        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 100));

        // Clear local arrays
        customers = [];
        filteredCustomers = [];

        // Update status: Updating locations
        if (deleteProgressStats) {
          deleteProgressStats.textContent = 'Updating locations...';
        }
        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 50));

        // Update all locations to be available
        locations.forEach(location => {
          location.currentResident = null;
          location.status = 'available';
          location.ownerFirstName = '';
          location.ownerLastName = '';
          location.ownerFullName = '';
        });
        filteredLocations = [...locations];

        // Save location changes
        await saveLocationsToFirestore();

        // Update status: Finalizing
        if (deleteProgressStats) {
          deleteProgressStats.textContent = 'Finalizing...';
        }
        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 50));

        // Reload data from Firestore to ensure UI is in sync
        await loadCustomersFromFirestore();

        // Update displays
        updateDashboard();
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Hide progress modal
        if (deleteProgressModal) {
          deleteProgressModal.classList.add('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.add('hidden');
        }

        // Close settings module if it's open
        if (window.hideAllModules) {
          window.hideAllModules();
        }

        // Show success alert
        alert(`Successfully deleted ${totalCustomers} customer${totalCustomers !== 1 ? 's' : ''}!`);
      } catch (error) {

        // Hide progress modal on error
        const deleteProgressModal = document.getElementById('deleteProgressModal');
        const deleteProgress = document.getElementById('deleteProgress');
        if (deleteProgressModal) {
          deleteProgressModal.classList.add('hidden');
        }
        if (deleteProgress) {
          deleteProgress.classList.add('hidden');
        }

        alert('Error deleting customer data: ' + error.message);
      }
    };

    // Search customers
    window.searchCustomers = function() {
      // Check both search inputs (main table and settings table)
      const mainSearch = document.getElementById('customerSearch');
      const settingsSearch = document.getElementById('settingsCustomerSearch');
      const searchTerm = (mainSearch ? mainSearch.value : (settingsSearch ? settingsSearch.value : '')).toLowerCase();
      
      filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) ||
        customer.email.toLowerCase().includes(searchTerm) ||
        customer.accountNumber.toLowerCase().includes(searchTerm) ||
        customer.address.toLowerCase().includes(searchTerm)
      );
      updateCustomerTable();
      updateSettingsCustomerTable(); // Update settings table count as well
    };

    // Filter by status or codes
    window.filterByStatus = function(status) {
      if (status === 'all') {
        filteredCustomers = [...customers];
      } else if (status === 'no-codes') {
        filteredCustomers = customers.filter(c => !c.codes || c.codes.length === 0);
      } else if (status === 'has-codes') {
        filteredCustomers = customers.filter(c => c.codes && c.codes.length > 0);
      } else {
        filteredCustomers = customers.filter(c => c.paymentStatus === status);
      }
      updateCustomerTable();
      updateSettingsCustomerTable(); // Update settings table count as well
    };

    // Location management functions
    function updateLocationsTable() {
      const tbody = document.getElementById('locationsTableBody');
      tbody.innerHTML = '';

      filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = location.status === 'occupied' 
          ? 'bg-green-100 text-green-800' 
          : location.status === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : 'bg-blue-100 text-blue-800';

        const statusText = location.status === 'occupied' 
          ? 'Occupied' 
          : location.status === 'inactive'
          ? 'Inactive'
          : 'Available';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${location.premiseId || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'address', '${location.address}')" 
                 title="Double-click to edit">
              ${location.address}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${location.currentResident ? `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'currentResident', '${location.currentResident}')" 
                 title="Double-click to edit">
              ${location.currentResident}
            </div>
            ` : `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'ownerFullName', '${location.ownerFullName || 'No Owner'}')" 
                 title="Double-click to edit">
              ${location.ownerFullName || 'No Owner'}
            </div>
            `}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editField('${location.id}', 'status', '${location.status}')" 
                  title="Double-click to edit">
              ${statusText}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteLocation('${location.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Settings module table update functions
    function updateSettingsCustomerTable() {
      const tbody = document.getElementById('settingsCustomerTableBody');
      tbody.innerHTML = '';

      // Update the customer count display in settings
      const countDisplay = document.getElementById('settingsCustomerCountDisplay');
      const totalDisplay = document.getElementById('settingsCustomerTotalDisplay');
      if (countDisplay) countDisplay.textContent = filteredCustomers.length;
      if (totalDisplay) totalDisplay.textContent = customers.length;

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = customer.paymentStatus === 'overdue' 
          ? 'bg-red-100 text-red-800' 
          : customer.paymentStatus === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : customer.paymentStatus === 'pending closing'
          ? 'bg-yellow-100 text-yellow-800'
          : 'bg-green-100 text-green-800';

        // Calculate due date as last day of current month
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early (before due date)
        const hasPaidEarly = customer.lastPayment && customer.lastPayment !== 'Never' && 
                            customer.lastPayment.includes('/') && 
                            new Date(customer.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount based on breakdown logic
        const baseServiceCost = calculateProratedServiceCost(customer);
        const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
        const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due
        
        // Apply factor FIRST to get adjusted service cost
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;

        // Calculate code surcharges (applied to adjusted service cost after factor, affected by factor)
        let totalSurcharge = 0;
        if (customer.codes && customer.codes.length > 0) {
          customer.codes.forEach(code => {
            const codeType = code.type || 'percentage';
            const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
            let baseSurcharge;
            if (codeType === 'flat') {
              baseSurcharge = codeAmount;
            } else {
              baseSurcharge = adjustedServiceCost * (codeAmount / 100);
            }
            // Apply factor to tax codes
            totalSurcharge += baseSurcharge * factor;
          });
        }

        // Calculate subtotal: adjusted service cost + tax codes (both affected by factor)
        const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;

        // Calculate PUC Surcharge (applied to subtotal, NOT affected by factor)
        let pucSurchargeAmount = 0;
        if (pucSurcharge > 0) {
          pucSurchargeAmount = subtotalBeforePuc * (pucSurcharge / 100);
        }

        const totalAmount = hasPaidEarly ? 0 : (subtotalBeforePuc + pastDue + lateFeeAmount + pucSurchargeAmount);

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'accountNumber', '${customer.accountNumber}')" 
                 title="Double-click to edit">
              ${customer.accountNumber}
            </div>
          </td>
          <td class="px-0 py-4 pr-0 -mr-4 whitespace-nowrap text-center max-w-[180px]">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'name', '${customer.name}')" 
                 title="Double-click to edit">
              ${customer.name}
            </div>
            <div class="flex flex-col items-center gap-1 mt-2">
              <button 
                onclick="showCustomerFullInfo('${customer.id}')" 
                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium"
              >
                View Full Info
              </button>
              <button 
                onclick="showCustomerDataProfile('${customer.id}')" 
                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 text-xs font-medium"
              >
                View Data Profile
              </button>
            </div>
          </td>
          <td class="px-0 py-4 pl-0 -ml-4 text-center max-w-[180px]">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCustomerField('${customer.id}', 'address', '${getCustomerDisplayAddress(customer)}')" 
                 title="Double-click to edit">
              ${(() => {
                const displayAddress = getCustomerDisplayAddress(customer);
                if (typeof displayAddress === 'string' && displayAddress.includes(',')) {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress.split(',')[0].trim()}</div>
                  <div class="text-slate-500 dark:text-slate-400 whitespace-nowrap">${displayAddress.split(',').slice(1).join(',').trim()}</div>`;
                } else {
                  return `<div class="font-medium whitespace-nowrap">${displayAddress}</div>`;
                }
              })()}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editCustomerField('${customer.id}', 'paymentStatus', '${customer.paymentStatus}')" 
                  title="Double-click to edit">
              ${customer.paymentStatus.charAt(0).toUpperCase() + customer.paymentStatus.slice(1)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-900 dark:text-slate-100">
            <div class="font-medium">$${totalAmount.toFixed(2)}</div>
            <button onclick="showAmountDetails('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
              View Details
            </button>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600 dark:text-slate-400">
            <div class="flex flex-wrap gap-1 justify-center">
              ${pucSurcharge > 0 ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">PUC SCHG SW (${pucSurcharge.toFixed(2)}%)</span>` : ''}
              ${customer.codes && customer.codes.length > 0 
                ? customer.codes.map(code => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.name}</span>`).join('')
                : (pucSurcharge > 0 ? '' : '<span class="text-slate-400 dark:text-slate-500"></span>')
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <div class="flex flex-col space-y-2">
              <button onclick="showPaymentModal('${customer.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Mark Paid
              </button>
              <button onclick="showPaymentHistory('${customer.id}')" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                View History
              </button>
              <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateCodesTable() {

      const tbody = document.getElementById('settingsCodesTableBody');
      tbody.innerHTML = '';

      if (codes.length === 0) {

        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              You don't have any codes currently
            </td>
          </tr>
        `;
        return;
      }

      codes.forEach(code => {
        // Default to 'percentage' type for existing codes without type
        const codeType = code.type || 'percentage';
        const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);

        // Log each code when rendering the table

        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'name', '${(code.name || '').replace(/'/g, "\\'")}')" 
                 title="Double-click to edit">
              ${code.name || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'type', '${codeType}')" 
                 title="Double-click to edit">
              ${codeType === 'flat' ? 'Flat Rate' : 'Percentage'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'amount', '${codeAmount}')" 
                 title="Double-click to edit">
              ${codeType === 'flat' ? `$${parseFloat(codeAmount).toFixed(2)}` : `${parseFloat(codeAmount).toFixed(2)}%`}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'description', '${(code.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" 
                 title="Double-click to edit">
              ${code.description || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editCodeField('${code.id}', 'requirements', '${JSON.stringify(code.requirements || {}).replace(/'/g, "\\'")}')" 
                 title="Double-click to edit">
              ${code.requirements && code.requirements.values && code.requirements.values.length > 0 
                ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${code.requirements.values.join(` ${code.requirements.type} `)}</span>`
                : code.requirements && Array.isArray(code.requirements) && code.requirements.length > 0
                  ? code.requirements.map(req => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 mr-1">${req}</span>`).join('')
                  : '<span class="text-slate-400 dark:text-slate-500"></span>'
              }
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex flex-col space-y-2 items-end">
              <button onclick="applyCodeToAll('${code.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                Apply to All
              </button>
              <button onclick="deleteCode('${code.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                Delete
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateSettingsLocationsTable() {
      const tbody = document.getElementById('settingsLocationsTableBody');
      tbody.innerHTML = '';

      filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        const statusClass = location.status === 'occupied' 
          ? 'bg-green-100 text-green-800' 
          : location.status === 'inactive'
          ? 'bg-gray-100 text-gray-800'
          : 'bg-blue-100 text-blue-800';

        const statusText = location.status === 'occupied' 
          ? 'Occupied' 
          : location.status === 'inactive'
          ? 'Inactive'
          : 'Available';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${location.premiseId || 'N/A'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'address', '${location.address}')" 
                 title="Double-click to edit">
              ${location.address}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${location.currentResident ? `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'currentResident', '${location.currentResident}')" 
                 title="Double-click to edit">
              ${location.currentResident}
            </div>
            ` : `
            <div class="font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded" 
                 ondblclick="editField('${location.id}', 'ownerFullName', '${location.ownerFullName || 'No Owner'}')" 
                 title="Double-click to edit">
              ${location.ownerFullName || 'No Owner'}
            </div>
            `}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded ${statusClass}" 
                  ondblclick="editField('${location.id}', 'status', '${location.status}')" 
                  title="Double-click to edit">
              ${statusText}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteLocation('${location.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateSettingsUsersTable() {
      const tbody = document.getElementById('settingsUsersTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!filteredUsers || filteredUsers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              You don't have any users yet.
            </td>
          </tr>
        `;
        return;
      }

      filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800';

        let createdDate = '';
        if (user.createdAt) {
          try {
            createdDate = new Date(user.createdAt).toLocaleDateString('en-US');
          } catch (error) {
            createdDate = user.createdAt;
          }
        }

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-slate-100">
              ${user.fullName || 'Unnamed User'}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
            ${createdDate}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Search locations
    window.searchLocations = function() {
      const searchTerm = document.getElementById('locationSearch').value.toLowerCase();
      filteredLocations = locations.filter(location => 
        location.address.toLowerCase().includes(searchTerm) ||
        location.propertyType.toLowerCase().includes(searchTerm) ||
        (location.currentResident && location.currentResident.toLowerCase().includes(searchTerm))
      );
      updateLocationsTable();
    };

    window.searchUsers = function() {
      const searchInput = document.getElementById('settingsUserSearch');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      if (!searchTerm) {
        filteredUsers = [...users];
      } else {
        filteredUsers = users.filter(user => 
          (user.fullName || '').toLowerCase().includes(searchTerm)
        );
      }
      updateSettingsUsersTable();
    };

    // Filter locations by status
    window.filterLocationsByStatus = function(status) {
      if (status === 'all') {
        filteredLocations = [...locations];
      } else {
        filteredLocations = locations.filter(l => l.status === status);
      }
      updateLocationsTable();
    };

    // Import locations from JSON
    window.importLocations = async function() {
      const fileInput = document.getElementById('locationFileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a JSON file');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.locations && Array.isArray(data.locations)) {
            // Add new locations to existing ones
            data.locations.forEach(newLocation => {
              // Check if location already exists
              const exists = locations.find(l => l.id === newLocation.id);
              if (!exists) {
                locations.push({
                  ...newLocation,
                  currentResident: null,
                  status: 'available'
                });
              }
            });

            filteredLocations = [...locations];
            updateLocationsTable();
            await saveLocationsToFirestore();
            alert(`Successfully imported ${data.locations.length} locations!`);
            fileInput.value = ''; // Clear the input
          } else {
            alert('Invalid JSON format. Expected "locations" array.');
          }
        } catch (error) {
          alert('Error parsing JSON file: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    // Show transfer ownership modal
    window.showTransferOwnershipModal = function(location, currentResident, newClientData) {
      // Store the data for later use
      window.transferData = {
        location: location,
        currentResident: currentResident,
        newClientData: newClientData
      };

      // Calculate actual amount due (same logic as in table)
      const now = new Date();
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getFullYear();

      // Check if customer has paid early (before due date)
      const hasPaidEarly = currentResident.lastPayment && currentResident.lastPayment !== 'Never' && 
                          currentResident.lastPayment.includes('/') && 
                          new Date(currentResident.lastPayment) < new Date(dueDateStr);

      // Calculate actual amount based on breakdown logic
      const baseServiceCost = calculateProratedServiceCost(currentResident);
      const factor = currentResident.factor ? parseFloat(currentResident.factor) : 1.0;
      const adjustedServiceCost = baseServiceCost * factor;
      const lateFeeAmount = currentResident.pastDue > 0 ? lateFee : 0; // Late fee
      const totalAmount = hasPaidEarly ? 0 : (adjustedServiceCost + lateFeeAmount);

      // Populate the modal
      document.getElementById('transferWarningName').textContent = currentResident.name;
      document.getElementById('transferCurrentResident').textContent = currentResident.name;
      document.getElementById('transferNewLocationLabel').textContent = currentResident.name;
      document.getElementById('transferLocation').textContent = location.address;
      document.getElementById('transferNewClient').textContent = newClientData.name;
      document.getElementById('transferCurrentStatus').textContent = currentResident.paymentStatus.charAt(0).toUpperCase() + currentResident.paymentStatus.slice(1);
      document.getElementById('transferBalance').textContent = `$${totalAmount.toFixed(2)}`;

      // Show appropriate message based on balance
      const statusMessage = document.getElementById('transferStatusMessage');
      if (totalAmount === 0) {
        statusMessage.innerHTML = 'The current resident has a balance of $0.00 and will be marked as <strong>Inactive</strong> after transfer.';
        statusMessage.className = 'text-green-600 dark:text-green-400';
      } else {
        statusMessage.innerHTML = 'The current resident has an outstanding balance and will be marked as <strong>Pending Closing</strong> until their balance is paid.';
        statusMessage.className = 'text-red-600 dark:text-red-400';
      }

      document.getElementById('transferOwnershipModal').classList.remove('hidden');
    };

    // Hide transfer ownership modal
    window.hideTransferOwnershipModal = function() {
      document.getElementById('transferOwnershipModal').classList.add('hidden');
      document.getElementById('transferNewLocation').value = '';
    };

    // Process transfer ownership
    window.processTransferOwnership = async function() {
      const newLocation = document.getElementById('transferNewLocation').value.trim();

      if (!newLocation) {
        alert('Please enter the new location for the current resident');
        return;
      }

      const { location, currentResident, newClientData } = window.transferData;

      try {
        // Update current resident's location and status
        currentResident.address = newLocation;

        // Calculate actual balance to determine status
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                          lastDayOfMonth.getFullYear();

        // Check if customer has paid early
        const hasPaidEarly = currentResident.lastPayment && currentResident.lastPayment !== 'Never' && 
                            currentResident.lastPayment.includes('/') && 
                            new Date(currentResident.lastPayment) < new Date(dueDateStr);

        // Calculate actual amount due
        const baseServiceCost = calculateProratedServiceCost(currentResident);
        const factor = currentResident.factor ? parseFloat(currentResident.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;
        const lateFeeAmount = currentResident.pastDue > 0 ? lateFee : 0;
        const totalAmount = hasPaidEarly ? 0 : (adjustedServiceCost + lateFeeAmount);

        // Set status based on balance: inactive if balance is 0, pending closing if they owe money
        if (totalAmount === 0) {
          currentResident.paymentStatus = 'inactive';
        } else {
          currentResident.paymentStatus = 'pending closing';
        }

        // Update location to new resident
        location.currentResident = newClientData.name;
        location.ownerFullName = newClientData.name;
        const nameParts = newClientData.name.split(' ');
        location.ownerFirstName = nameParts[0] || '';
        location.ownerLastName = nameParts.slice(1).join(' ') || '';

        // Create new customer
        const newCustomer = {
          id: 'CUS-' + String(Date.now()).slice(-6),
          name: newClientData.name,
          email: newClientData.email,
          phone: newClientData.phone,
          address: location.address,
          accountNumber: 'CUS-' + String(Date.now()).slice(-6),
          currentBill: sewerCharge,
          pastDue: 0,
          lastPayment: 'Never',
          paymentHistory: [],
          needsPasswordChange: true,
          createdDate: new Date().toISOString(),
          entityType: newClientData.entityType || '',
          ssn: newClientData.ssn || '',
          idType: newClientData.idType || '',
          idNumber: newClientData.idNumber || '',
          secondaryContactName: newClientData.secondaryContactName || '',
          secondaryContactPhone: newClientData.secondaryContactPhone || '',
          mailingAddress: newClientData.mailingAddress || '',
          mailingStreet: newClientData.mailingStreet || '',
          mailingCity: newClientData.mailingCity || '',
          mailingState: newClientData.mailingState || '',
          mailingZip: newClientData.mailingZip || '',
          codes: newClientData.codes || [],
          factor: newClientData.factor || '',
          cycleNumber: newClientData.cycleNumber || null
        };

        // Update payment status for new customer
        updateCustomerPaymentStatus(newCustomer);

        // Add new customer
        customers.push(newCustomer);
        filteredCustomers = [...customers];

        // Save to Firestore
        await saveCustomersToFirestore();
        await saveLocationsToFirestore();

        // Update displays
        updateDashboard();
        updateSettingsCustomerTable();

        // Hide modal and show success
        hideTransferOwnershipModal();
        showClientSuccessScreen();

      } catch (error) {

        alert('Error processing transfer: ' + error.message);
      }
    };

    // Show add location modal
    window.showAddLocationModal = function() {
      // Generate a random 6-digit number for Premise ID
      const premiseId = Math.floor(100000 + Math.random() * 900000).toString();
      document.getElementById('newLocationPremiseId').value = premiseId;
      document.getElementById('addLocationModal').classList.remove('hidden');
    };

    // User management helpers
    window.showAddUserModal = function() {
      document.getElementById('newUserFullName').value = '';
      document.getElementById('addUserModal').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('newUserFullName').focus();
      }, 50);
    };

    window.hideAddUserModal = function() {
      document.getElementById('addUserModal').classList.add('hidden');
      document.getElementById('newUserFullName').value = '';
    };

    // Hide add location modal
    window.hideAddLocationModal = function() {
      document.getElementById('addLocationModal').classList.add('hidden');
      document.getElementById('addLocationForm').reset();
    };

    // Show add code modal
    window.showAddCodeModal = function() {
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
      document.getElementById('addCodeModal').classList.remove('hidden');
    };

    // Hide add code modal
    window.hideAddCodeModal = function() {
      document.getElementById('addCodeModal').classList.add('hidden');
      document.getElementById('addCodeForm').reset();
      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
    };

    // Global variable to store selected requirements for new code
    // Structure: { type: "AND" | "OR", values: ["Business", "Individual"] }
    window.selectedCodeRequirements = null;

    // Update requirements list display
    window.updateCodeRequirementsList = function() {
      const listContainer = document.getElementById('newCodeRequirementsList');
      if (!listContainer) return;

      listContainer.innerHTML = '';

      if (!window.selectedCodeRequirements || window.selectedCodeRequirements.values.length === 0) {
        return;
      }

      const requirementDiv = document.createElement('div');
      requirementDiv.className = 'flex items-center justify-between bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg';

      const valuesText = window.selectedCodeRequirements.values.join(` ${window.selectedCodeRequirements.type} `);
      requirementDiv.innerHTML = `
        <span class="text-sm text-slate-800 dark:text-slate-200">${valuesText}</span>
        <button 
          type="button"
          onclick="removeCodeRequirement()" 
          class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 ml-2"
        >
          
        </button>
      `;
      listContainer.appendChild(requirementDiv);
    };

    // Show add requirement modal
    window.showAddRequirementModal = function() {
      document.getElementById('addRequirementModal').classList.remove('hidden');
    };

    // Hide add requirement modal
    window.hideAddRequirementModal = function() {
      document.getElementById('addRequirementModal').classList.add('hidden');
      // Reset checkboxes and radio buttons
      document.getElementById('requirementBusiness').checked = false;
      document.getElementById('requirementIndividual').checked = false;
      document.getElementById('requirementLogicAND').checked = true; // Default to AND
      document.getElementById('requirementLogicOR').checked = false;
    };

    // Add requirement to list
    window.addRequirement = function() {
      const businessChecked = document.getElementById('requirementBusiness').checked;
      const individualChecked = document.getElementById('requirementIndividual').checked;
      const logicType = document.getElementById('requirementLogicAND').checked ? 'AND' : 'OR';

      if (!businessChecked && !individualChecked) {
        alert('Please select at least one requirement');
        return;
      }

      const selectedValues = [];
      if (businessChecked) {
        selectedValues.push('Business');
      }
      if (individualChecked) {
        selectedValues.push('Individual');
      }

      window.selectedCodeRequirements = {
        type: logicType,
        values: selectedValues
      };

      updateCodeRequirementsList();
      hideAddRequirementModal();
    };

    // Remove requirement from list
    window.removeCodeRequirement = function() {
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();
    };

    // Update code amount input based on type
    window.updateCodeAmountInput = function() {
      const type = document.getElementById('newCodeType').value;
      const amountInput = document.getElementById('newCodeAmount');

      if (type === 'percentage') {
        amountInput.max = '100';
        amountInput.placeholder = 'Enter percentage (0-100)';
      } else {
        amountInput.removeAttribute('max');
        amountInput.placeholder = 'Enter dollar amount';
      }
    };

    // Add new code
    window.addCode = async function() {
      const name = document.getElementById('newCodeName').value.trim();
      const type = document.getElementById('newCodeType').value;
      const amount = parseFloat(document.getElementById('newCodeAmount').value);
      const description = document.getElementById('newCodeDescription').value.trim() || '';

      if (!name || isNaN(amount) || amount < 0) {
        alert('Please enter a valid code name and amount');
        return;
      }

      if (type === 'percentage' && amount > 100) {
        alert('Percentage cannot exceed 100%');
        return;
      }

      const newCode = {
        id: `CODE-${String(Date.now()).slice(-6)}`,
        name: name,
        type: type,
        amount: amount,
        percentage: type === 'percentage' ? amount : undefined, // Keep for backward compatibility
        description: description,
        requirements: window.selectedCodeRequirements ? { ...window.selectedCodeRequirements } : null
      };

      codes.push(newCode);
      await saveCodesToFirestore();
      updateCodesTable();
      hideAddCodeModal();

      // Reset form
      document.getElementById('newCodeName').value = '';
      document.getElementById('newCodeType').value = 'percentage';
      document.getElementById('newCodeAmount').value = '';
      document.getElementById('newCodeDescription').value = '';
      updateCodeAmountInput();

      // Reset requirements
      window.selectedCodeRequirements = null;
      updateCodeRequirementsList();

      alert('Code added successfully!');
    };

    // Save edit code field
    window.saveEditCodeField = async function() {
      const codeId = document.getElementById('editCodeFieldCodeId').value;
      const fieldType = document.getElementById('editCodeFieldFieldType').value;
      const newValue = document.getElementById('editCodeFieldValue').value;

      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      if (fieldType === 'type') {
        const newType = newValue;
        code.type = newType;
        // If switching types, preserve amount value
        if (!code.amount && code.percentage !== undefined) {
          code.amount = code.percentage;
        }
        if (newType === 'percentage' && code.amount > 100) {
          code.amount = 100;
        }
      }

      await saveCodesToFirestore();
      updateCodesTable();
      cancelEditCodeField();
    };

    // Cancel edit code field
    window.cancelEditCodeField = function() {
      document.getElementById('editCodeFieldModal').classList.add('hidden');
      document.getElementById('editCodeFieldInputContainer').innerHTML = '';
    };

    // Apply code to all customers
    window.applyCodeToAll = async function(codeId) {
      const code = codes.find(c => c.id === codeId);
      if (!code) {
        alert('Code not found');
        return;
      }

      const codeType = code.type || 'percentage';
      const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
      const codeDisplay = codeType === 'flat' 
        ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
        : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;

      if (!confirm(`Are you sure you want to apply "${codeDisplay}" to ALL ${customers.length} customer accounts?\n\nThis will add this code to all customers who don't already have it.`)) {
        return;
      }

      try {
        let updatedCount = 0;
        let skippedCount = 0;

        // Apply code to all customers
        customers.forEach(customer => {
          // Initialize codes array if it doesn't exist
          if (!customer.codes) {
            customer.codes = [];
          }

          // Check if customer already has this code
          const hasCode = customer.codes.some(c => c.id === codeId);
          
          if (!hasCode) {
            // Add the code to the customer
            customer.codes.push({
              id: code.id,
              name: code.name,
              type: code.type || 'percentage',
              amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
              percentage: codeType === 'percentage' && code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0)
            });
            updatedCount++;
          } else {
            skippedCount++;
          }
        });

        // Save all customers to Firestore
        await saveCustomersToFirestore();
        
        // Update tables
        updateCustomerTable();
        updateSettingsCustomerTable();

        alert(`Successfully applied "${codeDisplay}" to ${updatedCount} customer(s).\n${skippedCount} customer(s) already had this code.`);
      } catch (error) {
        console.error('[APPLY CODE TO ALL] Error:', error);
        alert('Error applying code to all customers: ' + error.message);
      }
    };

    // Delete code
    window.deleteCode = async function(codeId) {
      const code = codes.find(c => c.id === codeId);
      if (!code) {
        alert('Code not found');
        return;
      }

      const codeType = code.type || 'percentage';
      const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
      const codeDisplay = codeType === 'flat' 
        ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
        : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`;

      // Count how many customers have this code
      let customersWithCode = 0;
      customers.forEach(customer => {
        if (customer.codes && customer.codes.some(c => c.id === codeId)) {
          customersWithCode++;
        }
      });

      const confirmMessage = customersWithCode > 0
        ? `Are you sure you want to delete "${codeDisplay}"?\n\nThis will remove it from ${customersWithCode} customer account(s) as well.`
        : `Are you sure you want to delete "${codeDisplay}"?`;

      if (confirm(confirmMessage)) {
        try {
          // First, explicitly delete the document from Firestore
          const codesRef = collection(db, 'codes');
          const codeRef = doc(codesRef, codeId);
          await deleteDoc(codeRef);
          
          // Add code name to deleted set to prevent recreation
          deletedCodeNames.add(code.name.toLowerCase());
          
          // Save deleted code names to Firestore for persistence across reloads
          const deletedCodesRef = doc(db, 'settings', 'deletedCodeNames');
          await setDoc(deletedCodesRef, { 
            names: Array.from(deletedCodeNames),
            lastUpdated: new Date().toISOString()
          });
          
          // Then remove it from the local array
          codes = codes.filter(c => c.id !== codeId);
          
          // Remove the code from all customers who have it
          let updatedCustomers = 0;
          customers.forEach(customer => {
            let customerUpdated = false;
            
            // Remove from customer.codes array
            if (customer.codes && customer.codes.length > 0) {
              const originalLength = customer.codes.length;
              customer.codes = customer.codes.filter(c => c.id !== codeId);
              if (customer.codes.length < originalLength) {
                customerUpdated = true;
              }
            }
            
            // Also remove from importData to prevent code from being recreated on reload
            if (customer.importData) {
              const codeName = code.name;
              // Check all possible tax code fields in importData
              const taxCodeFields = [
                'Tax Codes Per Person',
                'Tax Codes per Person',
                'Tax Codes',
                'Codes Per Person',
                'Codes per Person',
                'Codes'
              ];
              
              taxCodeFields.forEach(field => {
                if (customer.importData[field]) {
                  const codesStr = customer.importData[field];
                  // Parse codes (comma-separated)
                  const codeNames = codesStr.split(',').map(c => c.trim());
                  // Remove the deleted code name (case-insensitive)
                  const filteredCodes = codeNames.filter(c => c.toLowerCase() !== codeName.toLowerCase());
                  // Update the field if codes were removed
                  if (filteredCodes.length < codeNames.length) {
                    customer.importData[field] = filteredCodes.join(', ');
                    customerUpdated = true;
                  }
                }
              });
            }
            
            if (customerUpdated) {
              updatedCustomers++;
            }
          });

          // Save all updated customers to Firestore
          if (updatedCustomers > 0) {
            console.log(`[DELETE CODE] Saving ${updatedCustomers} customers with updated importData`);
            await saveCustomersToFirestore();
            console.log(`[DELETE CODE] Successfully saved ${updatedCustomers} customers to Firestore`);
          }
          
          // Update the UI
          updateCodesTable();
          updateCustomerTable();
          updateSettingsCustomerTable();
          
          const successMessage = updatedCustomers > 0
            ? `Code deleted successfully! Removed from ${updatedCustomers} customer account(s).`
            : 'Code deleted successfully!';
          alert(successMessage);
        } catch (error) {
          console.error('[DELETE CODE] Error deleting code:', error);
          alert('Error deleting code: ' + error.message);
        }
      }
    };

    // Update sewer charge display
    function updateSewerChargeDisplay() {
      const input = document.getElementById('sewerChargeInput');
      const status = document.getElementById('sewerChargeStatus');
      if (input) {
        input.value = sewerCharge.toFixed(2);
      }
      if (status) {
        status.textContent = `Current value: $${sewerCharge.toFixed(2)}`;
      }
    }

    // Update late fee display
    function updateLateFeeDisplay() {
      const input = document.getElementById('lateFeeInput');
      const status = document.getElementById('lateFeeStatus');
      if (input) {
        input.value = lateFee.toFixed(2);
      }
      if (status) {
        status.textContent = `Current value: $${lateFee.toFixed(2)}`;
      }
    }

    // Update PUC Surcharge display
    function updatePucSurchargeDisplay() {
      const input = document.getElementById('pucSurchargeInput');
      const status = document.getElementById('pucSurchargeStatus');
      if (input) {
        input.value = pucSurcharge.toFixed(2);
      }
      if (status) {
        status.textContent = `Current value: ${pucSurcharge.toFixed(2)}%`;
      }
    }

    // Save late fee
    window.saveLateFee = async function() {
      const input = document.getElementById('lateFeeInput');
      const status = document.getElementById('lateFeeStatus');
      
      if (!input) return;
      
      const newValue = parseFloat(input.value);
      
      if (isNaN(newValue) || newValue < 0) {
        if (status) {
          status.textContent = 'Please enter a valid amount (must be 0 or greater)';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
        return;
      }
      
      const oldValue = lateFee;
      lateFee = newValue;
      
      try {
        await saveLateFeeToFirestore();
        if (status) {
          status.textContent = 'Late fee saved successfully!';
          status.className = 'text-xs text-green-500 dark:text-green-400';
        }
        
        // Clear status message after 3 seconds
        setTimeout(() => {
          if (status) {
            status.textContent = `Current value: $${lateFee.toFixed(2)}`;
            status.className = 'text-xs text-slate-500 dark:text-slate-400';
          }
        }, 3000);
      } catch (error) {
        console.error('[SAVE LATE FEE] Error:', error);
        lateFee = oldValue; // Revert on error
        if (status) {
          status.textContent = 'Error saving late fee. Please try again.';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
      }
    };

    // Save PUC Surcharge
    window.savePucSurcharge = async function() {
      const input = document.getElementById('pucSurchargeInput');
      const status = document.getElementById('pucSurchargeStatus');
      
      if (!input) return;
      
      const newValue = parseFloat(input.value);
      
      if (isNaN(newValue) || newValue < 0 || newValue > 100) {
        if (status) {
          status.textContent = 'Please enter a valid percentage (must be between 0 and 100)';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
        return;
      }
      
      const oldValue = pucSurcharge;
      pucSurcharge = newValue;
      
      try {
        await savePucSurchargeToFirestore();
        if (status) {
          status.textContent = 'PUC Surcharge saved successfully!';
          status.className = 'text-xs text-green-500 dark:text-green-400';
        }
        
        // Update all customer tables to reflect the change
        updateCustomerTable();
        updateSettingsCustomerTable();
        
        // Clear status message after 3 seconds
        setTimeout(() => {
          if (status) {
            status.textContent = `Current value: ${pucSurcharge.toFixed(2)}%`;
            status.className = 'text-xs text-slate-500 dark:text-slate-400';
          }
        }, 3000);
      } catch (error) {
        console.error('[SAVE PUC SURCHARGE] Error:', error);
        pucSurcharge = oldValue; // Revert on error
        if (status) {
          status.textContent = 'Error saving PUC surcharge. Please try again.';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
      }
    };

    // Save sewer charge
    window.saveSewerCharge = async function() {
      const input = document.getElementById('sewerChargeInput');
      const status = document.getElementById('sewerChargeStatus');
      
      if (!input) return;
      
      const newValue = parseFloat(input.value);
      
      if (isNaN(newValue) || newValue < 0) {
        if (status) {
          status.textContent = 'Please enter a valid amount (must be 0 or greater)';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
        return;
      }
      
      const oldValue = sewerCharge;
      sewerCharge = newValue;
      
      try {
        await saveSewerChargeToFirestore();
        if (status) {
          status.textContent = 'Sewer charge saved successfully!';
          status.className = 'text-xs text-green-500 dark:text-green-400';
        }
        
        // Update all customers' currentBill if it was set to the old value
        let needsSave = false;
        customers.forEach(customer => {
          if (customer.currentBill === oldValue) {
            customer.currentBill = sewerCharge;
            needsSave = true;
          }
        });
        
        if (needsSave) {
          await saveCustomersToFirestore();
        }
        
        // Clear status message after 3 seconds
        setTimeout(() => {
          if (status) {
            status.textContent = `Current value: $${sewerCharge.toFixed(2)}`;
            status.className = 'text-xs text-slate-500 dark:text-slate-400';
          }
        }, 3000);
      } catch (error) {
        console.error('[SAVE SEWER CHARGE] Error:', error);
        sewerCharge = oldValue; // Revert on error
        if (status) {
          status.textContent = 'Error saving sewer charge. Please try again.';
          status.className = 'text-xs text-red-500 dark:text-red-400';
        }
      }
    };

    // Edit code field
    window.editCodeField = function(codeId, fieldType, currentValue) {
      const code = codes.find(c => c.id === codeId);
      if (!code) return;

      let newValue;

      // Special handling for type field - show dropdown modal
      if (fieldType === 'type') {
        // Set up the edit modal with dropdown
        document.getElementById('editCodeFieldType').textContent = 'Type';
        document.getElementById('editCodeFieldCodeId').value = codeId;
        document.getElementById('editCodeFieldFieldType').value = 'type';

        const container = document.getElementById('editCodeFieldInputContainer');
        const currentType = currentValue || 'percentage';
        container.innerHTML = `
          <select 
            id="editCodeFieldValue" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="percentage" ${currentType === 'percentage' ? 'selected' : ''}>Percentage</option>
            <option value="flat" ${currentType === 'flat' ? 'selected' : ''}>Flat Rate</option>
          </select>
        `;

        // Show the modal
        document.getElementById('editCodeFieldModal').classList.remove('hidden');
        return;
      }

      // Special handling for amount field
      if (fieldType === 'amount') {

        const codeType = code.type || 'percentage';
        const promptText = codeType === 'flat' 
          ? `Enter new flat rate amount (dollars):` 
          : `Enter new percentage (0-100):`;
        newValue = prompt(promptText, currentValue);

        if (newValue === null) {

          return; // User cancelled
        }

        newValue = newValue.trim();
        const amount = parseFloat(newValue);

        if (isNaN(amount) || amount < 0) {

          alert('Please enter a valid amount');
          return;
        }

        if (codeType === 'percentage' && amount > 100) {

          alert('Percentage cannot exceed 100%');
          return;
        }

        // Find the code in the array by index to ensure we're updating the right object
        const codeIndex = codes.findIndex(c => c.id === codeId);
        if (codeIndex === -1) {

          alert('Error: Code not found in array');
          return;
        }

        // Update the code object in the array directly
        codes[codeIndex].amount = amount;
        if (codeType === 'percentage') {
          codes[codeIndex].percentage = amount; // Keep for backward compatibility
        }

        // Also update the local code variable for consistency
        code.amount = amount;
        if (codeType === 'percentage') {
          code.percentage = amount;
        }

        // Update table immediately to show the change
        updateCodesTable();

        // Save to Firestore asynchronously

        saveCodesToFirestore()
          .then(() => {

          })
          .catch(error => {

            alert('Error saving code amount to database. The change may not persist after reload.');
            // Reload codes from Firestore to restore correct state
            loadCodesFromFirestore();
          });
        return;
      }

      // Standard prompt for other fields
      newValue = prompt(`Enter new ${fieldType}:`, currentValue);

      if (newValue === null) return; // User cancelled

      newValue = newValue.trim();

      // Validation
      if (fieldType === 'name') {
        if (!newValue) {
          alert('Code name cannot be empty');
          return;
        }
        code.name = newValue;
      } else if (fieldType === 'description') {
        code.description = newValue || '';
      }

      // Save to Firestore and update table
      saveCodesToFirestore().then(() => {
        updateCodesTable();

        // Update code references in all customers if name changed
        if (fieldType === 'name') {
          customers.forEach(customer => {
            if (customer.codes && customer.codes.length > 0) {
              customer.codes.forEach(c => {
                if (c.id === codeId) {
                  c.name = newValue;
                }
              });
            }
          });
          saveCustomersToFirestore();
          updateCustomerTable();
          updateSettingsCustomerTable();
        }
      });
    };

    // Add new location
    window.addLocation = async function() {
      const street = document.getElementById('newLocationStreet').value;
      const city = document.getElementById('newLocationCity').value;
      const state = document.getElementById('newLocationState').value;
      const zip = document.getElementById('newLocationZip').value;
      const premiseId = document.getElementById('newLocationPremiseId').value;

      if (!street || !city || !state || !zip || !premiseId) {
        alert('Please fill in all fields');
        return;
      }

      const fullAddress = `${street}, ${city}, ${state} ${zip}`;

      const newLocation = {
        id: `LOC-${String(locations.length + 1).padStart(3, '0')}`,
        address: fullAddress,
        street: street,
        city: city,
        state: state,
        zip: zip,
        premiseId: premiseId,
        ownerFirstName: '',
        ownerLastName: '',
        ownerFullName: '',
        currentResident: null,
        status: 'available'
      };

      locations.push(newLocation);
      filteredLocations = [...locations];
      updateLocationsTable();
      updateSettingsLocationsTable();
      await saveLocationsToFirestore();
      hideAddLocationModal();

      // Update the location dropdowns and select the new location
      updateLocationDropdowns(newLocation.id);

      alert('Location added successfully!');
    };

    window.addUser = async function() {
      const input = document.getElementById('newUserFullName');
      const fullName = input.value.trim();

      if (!fullName) {
        alert('Please enter the user\'s full name.');
        return;
      }

      const timestamp = Date.now();
      const newUser = {
        id: `USR-${String(timestamp).slice(-6)}`,
        fullName,
        createdAt: new Date(timestamp).toISOString()
      };

      users.push(newUser);
      filteredUsers = [...users];
      updateSettingsUsersTable();
      populateBatchUserSelect(fullName);
      populateBatchStartUserSelect();
      await saveUsersToFirestore();
      hideAddUserModal();
      alert('User added successfully!');
    };

    window.deleteUser = async function(userId) {
      if (!confirm('Are you sure you want to delete this user?')) {
        return;
      }

      users = users.filter(user => user.id !== userId);
      filteredUsers = [...users];
      updateSettingsUsersTable();
      populateBatchUserSelect();
      populateBatchStartUserSelect();
      await saveUsersToFirestore();
      alert('User deleted successfully!');
    };

    // Update location dropdowns and select the new location
    function updateLocationDropdowns(selectedLocationId) {
      // Update Add Client Module dropdown
      const addClientSelect = document.getElementById('newClientLocation');
      if (addClientSelect) {
        populateAddClientLocationSelect();
        addClientSelect.value = selectedLocationId;
      }

      // Update Add Customer Modal dropdown
      const addCustomerSelect = document.getElementById('newCustomerLocation');
      if (addCustomerSelect) {
        // Repopulate the dropdown
        addCustomerSelect.innerHTML = '<option value="">Select a property location</option>';
        locations.forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = `${location.address} (${location.status})`;
          addCustomerSelect.appendChild(option);
        });
        addCustomerSelect.value = selectedLocationId;
      }
    }

    // Show import modal
    window.showImportModal = function() {
      document.getElementById('importModal').classList.remove('hidden');
    };

    // Hide import modal
    window.hideImportModal = function() {
      document.getElementById('importModal').classList.add('hidden');
      document.getElementById('locationFileInput').value = '';
    };

    // Show import customer data modal
    window.showImportCustomerDataModal = function() {

      try {
        const modal = document.getElementById('importCustomerDataModal');
        if (!modal) {

          alert('Error: Import modal not found. Please refresh the page.');
          return;
        }

        modal.classList.remove('hidden');
        // Add file input listener for preview
        const fileInput = document.getElementById('customerDataFileInput');
        if (fileInput) {
          fileInput.onchange = function() {
            previewExcelFile(this.files[0]);
          };
        } else {

        }
      } catch (error) {

        alert('Error opening import dialog: ' + error.message);
      }
    };

    // Hide import customer data modal
    window.hideImportCustomerDataModal = function() {
      document.getElementById('importCustomerDataModal').classList.add('hidden');
      document.getElementById('customerDataFileInput').value = '';
      document.getElementById('importPreview').classList.add('hidden');
    };

    // Preview Excel file
    function previewExcelFile(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (jsonData.length === 0) {
            alert('Excel file is empty');
            return;
          }

          // Show preview
          const previewDiv = document.getElementById('importPreview');
          const previewTable = document.getElementById('previewTable');
          const thead = previewTable.querySelector('thead');
          const tbody = previewTable.querySelector('tbody');

          // Clear previous content
          thead.innerHTML = '';
          tbody.innerHTML = '';

          // Add headers
          const headerRow = document.createElement('tr');
          if (jsonData[0]) {
            jsonData[0].forEach(header => {
              const th = document.createElement('th');
              th.className = 'px-4 py-2 text-left border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300';
              th.textContent = header || '';
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
          }

          // Add first 5 data rows
          const previewRows = jsonData.slice(1, 6);
          previewRows.forEach(row => {
            const tr = document.createElement('tr');
            jsonData[0].forEach((_, colIndex) => {
              const td = document.createElement('td');
              td.className = 'px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-400';
              td.textContent = row[colIndex] || '';
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });

          previewDiv.classList.remove('hidden');
        } catch (error) {

          alert('Error reading Excel file: ' + error.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Import customer data from Excel
    // Helper function to combine PremiseAddress, PremiseStreet, and PremiseApt
    // Example: PremiseAddress="20120" + PremiseStreet="ANZA DR" = "20120 ANZA DR"
    function combinePropertyAddress(rowData) {
      const premiseAddress = String(rowData['PremiseAddress'] || '').trim();
      const premiseStreet = String(rowData['PremiseStreet'] || '').trim();
      const premiseApt = String(rowData['PremiseApt'] || '').trim();

      // Build address parts array
      const addressParts = [];

      // Add PremiseAddress if it exists
      if (premiseAddress) {
        addressParts.push(premiseAddress);
      }

      // Add PremiseStreet if it exists
      if (premiseStreet) {
        addressParts.push(premiseStreet);
      }

      // Combine the parts
      let address = addressParts.join(' ').trim();

      // Add apartment number if it exists (only if not blank)
      if (premiseApt) {
        address = `${address} ${premiseApt}`.trim();
      }

      return address || '';
    }

    // Helper function to get the display address for a customer
    // Uses importData if available, otherwise falls back to customer.address
    function getCustomerDisplayAddress(customer) {
      // If customer has importData, use combinePropertyAddress to build the address
      if (customer.importData) {
        const combinedAddress = combinePropertyAddress(customer.importData);
        if (combinedAddress) {
          return combinedAddress;
        }
      }

      // Fall back to customer.address if no importData or combined address is empty
      return customer.address || 'N/A';
    }

    // Helper function to parse tax codes from "tax codes per person" field
    function parseTaxCodesPerPerson(taxCodesStr) {
      if (!taxCodesStr || typeof taxCodesStr !== 'string') {
        return [];
      }
      // Split by comma and trim whitespace
      return taxCodesStr.split(',').map(code => code.trim()).filter(code => code.length > 0);
    }

    // Helper function to ensure a code exists in the codes array, creating it if it doesn't
    function ensureCodeExists(codeName) {
      if (!codeName || typeof codeName !== 'string') {
        return null;
      }

      // Check if this code name was intentionally deleted - if so, don't recreate it
      if (deletedCodeNames.has(codeName.toLowerCase())) {
        console.log(`[ENSURE CODE EXISTS] Skipping deleted code: ${codeName}`);
        return null;
      }

      // Check if code already exists (case-insensitive)
      let existingCode = codes.find(c => c.name.toLowerCase() === codeName.toLowerCase());
      if (existingCode) {
        return existingCode;
      }

      // Create new code with just the name (type, amount, description, requirements can be added later)
      // Use timestamp + random number for unique ID
      const uniqueId = `CODE-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      const newCode = {
        id: uniqueId,
        name: codeName,
        type: 'percentage', // Default to percentage
        amount: 0, // Default to 0, can be updated later
        percentage: 0, // Default to 0 for backward compatibility
        description: '', // Empty, can be added later
        requirements: null // No requirements, can be added later
      };

      codes.push(newCode);
      return newCode;
    }

    // Helper function to populate customer codes from importData
    function populateCustomerCodesFromImportData(customer) {
      if (!customer.importData) {
        return;
      }

      // Try various possible column names for "tax codes per person"
      const taxCodesStr = customer.importData['Tax Codes Per Person'] || 
                         customer.importData['Tax Codes per Person'] ||
                         customer.importData['Tax Codes'] ||
                         customer.importData['Codes Per Person'] ||
                         customer.importData['Codes per Person'] ||
                         customer.importData['Codes'] ||
                         '';

      if (!taxCodesStr) {
        return;
      }

      // Parse the tax codes
      const codeNames = parseTaxCodesPerPerson(taxCodesStr);

      // Ensure all codes exist and populate customer.codes
      customer.codes = codeNames.map(codeName => {
        const code = ensureCodeExists(codeName);
        if (code) {
          return {
            id: code.id,
            name: code.name,
            type: code.type || 'percentage',
            amount: code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0),
            percentage: code.percentage !== undefined ? code.percentage : (code.type === 'percentage' && code.amount !== undefined ? code.amount : 0)
          };
        }
        return null;
      }).filter(code => code !== null);
    }

    // Helper function to convert Excel serial date to readable date string
    function excelSerialToDate(serial) {
      // Excel serial dates start from January 1, 1900
      // But Excel incorrectly treats 1900 as a leap year, so we need to adjust
      if (typeof serial === 'number' && serial > 0 && serial < 1000000) {
        // Check if it's likely an Excel serial date (between 1 and 1,000,000)
        // Excel date range: 1 (Jan 1, 1900) to ~2958465 (Dec 31, 9999)
        // Common dates are in the 40000-50000 range for recent years
        const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899 (Excel's epoch)
        const date = new Date(excelEpoch.getTime() + (serial - 1) * 24 * 60 * 60 * 1000);
        
        // Check if the resulting date is reasonable (between 1900 and 2100)
        if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const day = date.getDate().toString().padStart(2, '0');
          const year = date.getFullYear().toString().slice(-2);
          return `${month}/${day}/${year}`;
        }
      }
      return serial; // Return original if not a valid date
    }

    // Fix Excel serial dates in existing customer data
    window.fixExcelDates = async function() {
      if (!confirm('This will fix Excel serial dates (like 46053) in all customers\' importData. Continue?')) {
        return;
      }

      let fixed = 0;
      let errors = 0;

      customers.forEach(customer => {
        if (!customer.importData) {
          return; // Skip customers without importData
        }

        try {
          let updated = false;
          const rowData = customer.importData;

          // Check each field in importData
          Object.keys(rowData).forEach(key => {
            const value = rowData[key];
            // Check if key contains "date" and value is a number (likely Excel serial date)
            const keyLower = String(key || '').toLowerCase();
            if ((keyLower.includes('date') || keyLower.includes('billdate')) && typeof value === 'number') {
              const convertedDate = excelSerialToDate(value);
              if (convertedDate !== value) {
                rowData[key] = convertedDate;
                updated = true;
              }
            }
          });

          if (updated) {
            customer.importData = rowData;
            fixed++;
          }
        } catch (error) {
          console.error(`[FIX EXCEL DATES] Error fixing dates for customer ${customer.id}:`, error);
          errors++;
        }
      });

      if (fixed > 0) {
        // Save all updated customers to Firestore
        await saveCustomersToFirestore();
        alert(`Fixed Excel dates for ${fixed} customer(s).${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
        // Refresh the display if customer data profile is open
        const modal = document.getElementById('customerDataProfileModal');
        if (modal && !modal.classList.contains('hidden')) {
          const customerId = modal.getAttribute('data-customer-id');
          if (customerId) {
            showCustomerDataProfile(customerId);
          }
        }
      } else {
        alert(`No dates needed fixing.${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
      }
    };

    // Split all accounts evenly between cycle 1 and cycle 2
    window.splitAccountsByCycle = async function() {
      if (!confirm('This will split all accounts evenly across cycles 1-10. This is for testing purposes. Continue?')) {
        return;
      }

      try {
        // Shuffle customers array to randomize assignment
        const shuffledCustomers = [...customers].sort(() => Math.random() - 0.5);
        const totalCustomers = shuffledCustomers.length;
        const cycles = 10;
        
        // Calculate how many customers per cycle (rounded)
        const customersPerCycle = Math.floor(totalCustomers / cycles);
        const remainder = totalCustomers % cycles;

        // Initialize cycle counters
        const cycleCounts = {};
        for (let i = 1; i <= cycles; i++) {
          cycleCounts[i] = 0;
        }

        // Assign customers evenly across cycles 1-10
        let currentIndex = 0;
        for (let cycleNum = 1; cycleNum <= cycles; cycleNum++) {
          // Calculate how many customers for this cycle
          // Distribute remainder customers across first few cycles
          const customersForThisCycle = customersPerCycle + (cycleNum <= remainder ? 1 : 0);
          
          // Assign customers to this cycle
          for (let i = 0; i < customersForThisCycle && currentIndex < totalCustomers; i++) {
            shuffledCustomers[currentIndex].cycleNumber = String(cycleNum);
            cycleCounts[cycleNum]++;
            currentIndex++;
          }
        }

        // Save all updated customers to Firestore
        await saveCustomersToFirestore();
        
        // Build success message showing distribution
        let message = `Successfully split ${totalCustomers} account(s) across 10 cycles:\n\n`;
        for (let i = 1; i <= cycles; i++) {
          message += `Cycle ${i}: ${cycleCounts[i]} account(s)\n`;
        }
        alert(message);
        
        // Refresh customer tables if they're visible
        updateCustomerTable();
        updateSettingsCustomerTable();
      } catch (error) {
        console.error('[SPLIT ACCOUNTS BY CYCLE] Error:', error);
        alert('Error splitting accounts by cycle: ' + error.message);
      }
    };

    // Fix Bill Date column specifically
    window.fixBillDates = async function() {
      if (!confirm('This will fix the "Bill Date" column in all customers\' importData. Continue?')) {
        return;
      }

      let fixed = 0;
      let errors = 0;

      customers.forEach(customer => {
        if (!customer.importData) {
          return; // Skip customers without importData
        }

        try {
          let updated = false;
          const rowData = customer.importData;

          // Look for "Bill Date" column specifically (case-insensitive)
          Object.keys(rowData).forEach(key => {
            const keyLower = String(key || '').toLowerCase().trim();
            // Match "Bill Date" exactly or variations like "BillDate", "bill date", etc.
            if ((keyLower === 'bill date' || keyLower === 'billdate' || keyLower === 'bill_date') && typeof rowData[key] === 'number') {
              const value = rowData[key];
              const convertedDate = excelSerialToDate(value);
              if (convertedDate !== value) {
                rowData[key] = convertedDate;
                updated = true;
              }
            }
          });

          if (updated) {
            customer.importData = rowData;
            fixed++;
          }
        } catch (error) {
          console.error(`[FIX BILL DATES] Error fixing Bill Date for customer ${customer.id}:`, error);
          errors++;
        }
      });

      if (fixed > 0) {
        // Save all updated customers to Firestore
        await saveCustomersToFirestore();
        alert(`Fixed Bill Date for ${fixed} customer(s).${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
        // Refresh the display if customer data profile is open
        const modal = document.getElementById('customerDataProfileModal');
        if (modal && !modal.classList.contains('hidden')) {
          const customerId = modal.getAttribute('data-customer-id');
          if (customerId) {
            showCustomerDataProfile(customerId);
          }
        }
      } else {
        alert(`No Bill Dates needed fixing.${errors > 0 ? `\n${errors} error(s) occurred.` : ''}`);
      }
    };

    // Re-sync pastDue amounts from stored importData
    window.syncPastDueFromImportData = async function() {
      if (!confirm('This will update all customers\' past due amounts from their imported Excel data. Continue?')) {
        return;
      }

      let updated = 0;
      let errors = 0;

      customers.forEach(customer => {
        if (!customer.importData) {
          return; // Skip customers without importData
        }

        try {
          const rowData = customer.importData;

          // Use the same logic as import to extract pastDue
          let pastDue = 0;
          const prevBal = rowData['PrevBal'];
          const pastDueAmount = rowData['Past Due'];
          const pastDueFlag = rowData['PastDue'];

          // Prioritize PrevBal (actual dollar amount)
          if (prevBal !== undefined && prevBal !== null && prevBal !== '') {
            const parsed = parseFloat(prevBal);
            if (!isNaN(parsed)) {
              pastDue = parsed;
            }
          } else if (pastDueAmount !== undefined && pastDueAmount !== null && pastDueAmount !== '') {
            const parsed = parseFloat(pastDueAmount);
            if (!isNaN(parsed)) {
              pastDue = parsed;
            }
          } else if (pastDueFlag !== undefined && pastDueFlag !== null && pastDueFlag !== '') {
            // Only use PastDue flag if it looks like a dollar amount (not just 1 or 0)
            const parsed = parseFloat(pastDueFlag);
            if (!isNaN(parsed) && parsed > 1) {
              pastDue = parsed;
            }
          }

          // Update customer's pastDue
          customer.pastDue = pastDue;

          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);

          updated++;
        } catch (error) {

          errors++;
        }
      });

      // Update filtered customers
      filteredCustomers = [...customers];

      // Refresh UI
      updateCustomerTable();
      updateSettingsCustomerTable();
      updateDashboard();

      // Save only this customer to Firestore
      await saveSingleCustomerToFirestore(customer);

      alert(`Sync complete! Updated ${updated} customers. ${errors > 0 ? errors + ' errors occurred.' : ''}`);
    };

    window.importCustomerData = async function() {

      const fileInput = document.getElementById('customerDataFileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select an Excel file');
        return;
      }

      // Show loading indicator
      const importButton = document.querySelector('button[onclick*="importCustomerData"]');
      const originalText = importButton?.textContent || 'Import Customer Data';
      if (importButton) {
        importButton.disabled = true;
        importButton.textContent = 'Importing...';
      }

      const reader = new FileReader();

      reader.onerror = function(error) {

        alert('Error reading file. Please try again.');
        if (importButton) {
          importButton.disabled = false;
          importButton.textContent = originalText;
        }
      };

      reader.onload = async function(e) {
        try {

          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (jsonData.length < 2) {
            alert('Excel file must have at least a header row and one data row');
            if (importButton) {
              importButton.disabled = false;
              importButton.textContent = originalText;
            }
            return;
          }

          // Get headers (first row)
          const headers = jsonData[0].map(h => String(h || '').trim());

          // Find account number column index (look for variations)
          const accountColIndex = headers.findIndex(h => {
            const header = String(h || '').toLowerCase().trim();
            return /account/i.test(header) || 
                   /acct/i.test(header) || 
                   /^id$/i.test(header) || 
                   /customer.*id/i.test(header) ||
                   /account.*number/i.test(header) ||
                   /account.*num/i.test(header);
          });

          if (accountColIndex === -1) {
            alert('Could not find account number column. Please ensure your Excel file has a column for account numbers.');
            if (importButton) {
              importButton.disabled = false;
              importButton.textContent = originalText;
            }
            return;
          }

          // Show progress indicator
          const progressDiv = document.getElementById('importProgress');
          const progressText = document.getElementById('progressText');
          const progressBar = document.getElementById('progressBar');
          const progressStats = document.getElementById('progressStats');
          const previewDiv = document.getElementById('importPreview');

          // Upload progress elements
          const uploadProgressDiv = document.getElementById('uploadProgress');
          const uploadProgressText = document.getElementById('uploadProgressText');
          const uploadProgressBar = document.getElementById('uploadProgressBar');
          const uploadProgressStats = document.getElementById('uploadProgressStats');

          if (previewDiv) previewDiv.classList.add('hidden');
          if (progressDiv) progressDiv.classList.remove('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');
          const locationsUploadProgressDiv = document.getElementById('locationsUploadProgress');
          if (locationsUploadProgressDiv) locationsUploadProgressDiv.classList.add('hidden');

          const totalRows = jsonData.length - 1; // Exclude header row

          // Process each row
          let imported = 0;
          let updated = 0;
          let errors = 0;

          // Process rows in batches to allow UI updates
          const processBatch = async (startIndex, batchSize = 50) => {
            const endIndex = Math.min(startIndex + batchSize, jsonData.length);

            for (let i = startIndex; i < endIndex; i++) {
              const row = jsonData[i];
              if (!row || row.length === 0) continue;

              try {
                // Helper function to convert Excel serial date to readable date string
                const excelSerialToDate = (serial) => {
                  // Excel serial dates start from January 1, 1900
                  // But Excel incorrectly treats 1900 as a leap year, so we need to adjust
                  if (typeof serial === 'number' && serial > 0 && serial < 1000000) {
                    // Check if it's likely an Excel serial date (between 1 and 1,000,000)
                    // Excel date range: 1 (Jan 1, 1900) to ~2958465 (Dec 31, 9999)
                    // Common dates are in the 40000-50000 range for recent years
                    const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899 (Excel's epoch)
                    const date = new Date(excelEpoch.getTime() + (serial - 1) * 24 * 60 * 60 * 1000);
                    
                    // Check if the resulting date is reasonable (between 1900 and 2100)
                    if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                      const month = (date.getMonth() + 1).toString().padStart(2, '0');
                      const day = date.getDate().toString().padStart(2, '0');
                      const year = date.getFullYear().toString().slice(-2);
                      return `${month}/${day}/${year}`;
                    }
                  }
                  return serial; // Return original if not a valid date
                };

                // Create object with all Excel data
                const rowData = {};
                headers.forEach((header, index) => {
                  const value = row[index] || '';
                  // Check if header contains "date" or "Date" and value is a number (likely Excel serial date)
                  const headerLower = String(header || '').toLowerCase();
                  if ((headerLower.includes('date') || headerLower.includes('billdate')) && typeof value === 'number') {
                    rowData[header] = excelSerialToDate(value);
                  } else {
                    rowData[header] = value;
                  }
                });

                // Get account number
                const accountNumber = String(row[accountColIndex] || '').trim();
                if (!accountNumber) {
                  errors++;
                  continue;
                }

                // Find existing customer or create new
                let customer = customers.find(c => 
                  c.accountNumber === accountNumber || c.id === accountNumber
                );

                // Build full name from FirstName/LastName or Name/Full Name
                let fullName = '';
                if (rowData['FirstName'] && rowData['LastName']) {
                  fullName = `${rowData['FirstName']} ${rowData['LastName']}`.trim();
                } else if (rowData['Name']) {
                  fullName = rowData['Name'];
                } else if (rowData['Full Name']) {
                  fullName = rowData['Full Name'];
                }

                // Get phone number from various possible columns
                const phone = rowData['HomePhone'] || rowData['WorkPhone'] || rowData['Phone'] || rowData['Phone Number'] || '';

                // Get address by combining PremiseAddress, PremiseStreet, and PremiseApt
                const address = combinePropertyAddress(rowData) || rowData['Address'] || rowData['Service Address'] || '';

                // Get amounts
                const totalDue = parseFloat(rowData['TotalDue'] || rowData['CurrDue'] || rowData['Current Bill'] || rowData['Amount Due'] || 0) || 0;
                // Handle PrevBal first (actual amount), then Past Due (amount), then PastDue (flag - ignore if it's just 1/0)
                // If PrevBal is empty/blank, treat as 0. Only use PastDue flag if it's actually a dollar amount
                let pastDue = 0;
                const prevBal = rowData['PrevBal'];
                const pastDueAmount = rowData['Past Due'];
                const pastDueFlag = rowData['PastDue'];

                // Prioritize PrevBal (actual dollar amount)
                if (prevBal !== undefined && prevBal !== null && prevBal !== '') {
                  const parsed = parseFloat(prevBal);
                  if (!isNaN(parsed)) {
                    pastDue = parsed;
                  }
                } else if (pastDueAmount !== undefined && pastDueAmount !== null && pastDueAmount !== '') {
                  const parsed = parseFloat(pastDueAmount);
                  if (!isNaN(parsed)) {
                    pastDue = parsed;
                  }
                } else if (pastDueFlag !== undefined && pastDueFlag !== null && pastDueFlag !== '') {
                  // Only use PastDue flag if it looks like a dollar amount (not just 1 or 0)
                  const parsed = parseFloat(pastDueFlag);
                  if (!isNaN(parsed) && parsed > 1) {
                    pastDue = parsed;
                  }
                  // If it's 1 or 0, treat as flag and ignore (pastDue stays 0)
                }

                if (customer) {
                  // Update existing customer - preserve existing fields, add/update importData
                  customer.importData = rowData;
                  // Update standard fields if they exist in Excel
                  if (fullName) {
                    customer.name = fullName;
                  }
                  if (rowData['Email']) {
                    customer.email = rowData['Email'] || customer.email;
                  }
                  if (phone) {
                    customer.phone = phone;
                  }
                  // Always update address with combined address from importData
                  if (address) {
                    customer.address = address;
                  }
                  if (totalDue > 0) {
                    customer.currentBill = totalDue;
                  }
                  // Always update pastDue (can be 0 to reset existing value)
                  customer.pastDue = pastDue;
                  // Populate codes from "tax codes per person" field
                  populateCustomerCodesFromImportData(customer);
                  updated++;
                } else {
                  // Create new customer
                  const customerId = accountNumber.startsWith('CUS-') ? accountNumber : 'CUS-' + accountNumber;
                  customer = {
                    id: customerId,
                    accountNumber: customerId,
                    name: fullName,
                    email: rowData['Email'] || '',
                    phone: phone,
                    address: address,
                    currentBill: totalDue,
                    pastDue: pastDue,
                    lastPayment: rowData['Last Payment'] || 'Never',
                    paymentHistory: [],
                    needsPasswordChange: true,
                    createdDate: new Date().toISOString(),
                    entityType: rowData['Entity Type'] || rowData['Type'] || '',
                    ssn: rowData['SSN'] || rowData['Social Security Number'] || '',
                    idType: rowData['ID Type'] || '',
                    idNumber: rowData['ID Number'] || '',
                    secondaryContactName: rowData['Secondary Contact Name'] || '',
                    secondaryContactPhone: rowData['Secondary Contact Number'] || '',
                    mailingAddress: rowData['Mailing Address'] || '',
                    mailingStreet: rowData['Mailing Street'] || '',
                    mailingCity: rowData['Mailing City'] || '',
                    mailingState: rowData['Mailing State'] || '',
                    mailingZip: rowData['Mailing ZIP'] || rowData['Mailing Zip'] || '',
                    codes: [],
                    factor: parseFloat(rowData['Factor'] || 1) || 1,
                    importData: rowData // Store all Excel data
                  };

                  // Populate codes from "tax codes per person" field
                  populateCustomerCodesFromImportData(customer);

                  updateCustomerPaymentStatus(customer);
                  customers.push(customer);
                  imported++;
                }

                // Create or update location from customer data
                if (address) {
                  // Get Premise ID (handle formats like "P3000500" or just "3000500")
                  let premiseId = rowData['Premise'] || rowData['PremiseId'] || rowData['Premise ID'] || '';
                  if (premiseId) {
                    premiseId = String(premiseId).trim();
                    // Remove "P" prefix if present
                    if (premiseId.startsWith('P') || premiseId.startsWith('p')) {
                      premiseId = premiseId.substring(1);
                    }
                  }

                  // Only create location if we have a premise ID
                  if (premiseId) {
                    // Check if location already exists by premiseId
                    let existingLocation = locations.find(l => l.premiseId === premiseId);

                    // Parse address into components (try to extract city, state, zip)
                    // Format is typically: "Street Address, City, State ZIP"
                    let street = address;
                    let city = '';
                    let state = '';
                    let zip = '';

                    // Try to parse address format: "123 Street, City, State ZIP"
                    const addressMatch = address.match(/^(.+?),\s*(.+?),\s*([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/i);
                    if (addressMatch) {
                      street = addressMatch[1].trim();
                      city = addressMatch[2].trim();
                      state = addressMatch[3].trim().toUpperCase();
                      zip = addressMatch[4].trim();
                    } else {
                      // Try simpler format: "Street, City, State ZIP"
                      const simpleMatch = address.match(/^(.+?),\s*(.+?),\s*(.+)$/);
                      if (simpleMatch) {
                        street = simpleMatch[1].trim();
                        const stateZip = simpleMatch[3].trim();
                        const stateZipMatch = stateZip.match(/^([A-Z]{2})\s+(.+)$/i);
                        if (stateZipMatch) {
                          city = simpleMatch[2].trim();
                          state = stateZipMatch[1].trim().toUpperCase();
                          zip = stateZipMatch[2].trim();
                        } else {
                          // Can't parse, use full address as street
                          street = address;
                        }
                      }
                    }

                    // Get owner name from FirstName/LastName
                    const ownerFirstName = rowData['FirstName'] || '';
                    const ownerLastName = rowData['LastName'] || '';
                    const ownerFullName = fullName || `${ownerFirstName} ${ownerLastName}`.trim() || 'No Owner';

                    if (existingLocation) {
                      // Update existing location
                      existingLocation.address = address;
                      existingLocation.street = street;
                      existingLocation.city = city;
                      existingLocation.state = state;
                      existingLocation.zip = zip;
                      existingLocation.ownerFirstName = ownerFirstName;
                      existingLocation.ownerLastName = ownerLastName;
                      existingLocation.ownerFullName = ownerFullName;
                      // Don't change status if it's already set, but set to "active" if it's empty or "inactive"
                      if (!existingLocation.status || existingLocation.status === 'inactive') {
                        existingLocation.status = 'active';
                      }
                    } else {
                      // Create new location
                      const newLocation = {
                        id: `LOC-${String(locations.length + 1).padStart(3, '0')}`,
                        address: address,
                        street: street,
                        city: city,
                        state: state,
                        zip: zip,
                        premiseId: premiseId,
                        ownerFirstName: ownerFirstName,
                        ownerLastName: ownerLastName,
                        ownerFullName: ownerFullName,
                        currentResident: null,
                        status: 'active'
                      };
                      locations.push(newLocation);
                    }
                  }
                }
              } catch (error) {

                errors++;
              }

              // Update progress every row (i is the current index, so processed = i - 1 to account for header)
              const processed = i; // i is the current row index (1-based for data rows)
              const percent = Math.min(Math.round((processed / totalRows) * 100), 100);

              if (progressText) {
                progressText.textContent = `${processed} / ${totalRows}`;
              }
              if (progressBar) {
                progressBar.style.width = percent + '%';
              }
              if (progressStats) {
                progressStats.textContent = `Imported: ${imported} | Updated: ${updated} | Errors: ${errors}`;
              }
            }

            // If there are more rows to process, continue with next batch
            if (endIndex < jsonData.length) {
              // Use setTimeout to allow UI to update
              await new Promise(resolve => setTimeout(resolve, 0));
              return processBatch(endIndex, batchSize);
            }

            // Final progress update to ensure 100%
            if (progressText) {
              progressText.textContent = `${totalRows} / ${totalRows}`;
            }
            if (progressBar) {
              progressBar.style.width = '100%';
            }
          };

          // Start processing batches

          await processBatch(1, 50);

          // Update filtered customers first to get accurate count

          filteredCustomers = [...customers];

          // Show upload progress bar with initial values
          if (uploadProgressDiv) {
            uploadProgressDiv.classList.remove('hidden');
          }
          const totalCustomers = customers.length;
          if (uploadProgressText) {
            uploadProgressText.textContent = `0 / ${totalCustomers}`;
          }
          if (uploadProgressBar) {
            uploadProgressBar.style.width = '0%';
          }
          if (uploadProgressStats) {
            uploadProgressStats.textContent = `Uploading... (0 of ${totalCustomers} customers)`;
          }

          // Create progress callback for Firestore upload
          const uploadProgressCallback = (saved, total, percent) => {
            if (uploadProgressText) {
              uploadProgressText.textContent = `${saved} / ${total}`;
            }
            if (uploadProgressBar) {
              uploadProgressBar.style.width = percent + '%';
            }
            if (uploadProgressStats) {
              uploadProgressStats.textContent = `Uploaded: ${saved} of ${total} customers`;
            }
          };

          await saveAllCustomersToFirestore(uploadProgressCallback);

          // Save codes to Firestore if any new codes were added
          if (codes.length > 0) {

            await saveCodesToFirestore();

          }

          // Save locations to Firestore if any locations were created/updated
          if (locations.length > 0) {

            // Show locations upload progress
            const locationsProgressDiv = document.getElementById('locationsUploadProgress');
            const locationsUploadProgressText = document.getElementById('locationsUploadProgressText');
            const locationsUploadProgressBar = document.getElementById('locationsUploadProgressBar');
            const locationsUploadProgressStats = document.getElementById('locationsUploadProgressStats');

            if (locationsProgressDiv) {
              locationsProgressDiv.classList.remove('hidden');
            }

            const totalLocations = locations.length;
            if (locationsUploadProgressText) {
              locationsUploadProgressText.textContent = `0 / ${totalLocations}`;
            }
            if (locationsUploadProgressBar) {
              locationsUploadProgressBar.style.width = '0%';
            }
            if (locationsUploadProgressStats) {
              locationsUploadProgressStats.textContent = `Uploading... (0 of ${totalLocations} locations)`;
            }

            // Create progress callback for locations upload
            const locationsUploadProgressCallback = (saved, total, percent) => {
              if (locationsUploadProgressText) {
                locationsUploadProgressText.textContent = `${saved} / ${total}`;
              }
              if (locationsUploadProgressBar) {
                locationsUploadProgressBar.style.width = percent + '%';
              }
              if (locationsUploadProgressStats) {
                locationsUploadProgressStats.textContent = `Uploaded: ${saved} of ${total} locations`;
              }
            };

            filteredLocations = [...locations];
            updateLocationsTable();
            updateSettingsLocationsTable();
            await saveLocationsToFirestore(locationsUploadProgressCallback);

            // Update progress to 100%
            if (locationsUploadProgressText) {
              locationsUploadProgressText.textContent = `${totalLocations} / ${totalLocations}`;
            }
            if (locationsUploadProgressBar) {
              locationsUploadProgressBar.style.width = '100%';
            }
            if (locationsUploadProgressStats) {
              locationsUploadProgressStats.textContent = `Uploaded: ${totalLocations} of ${totalLocations} locations`;
            }
          }

          updateCustomerTable();
          updateSettingsCustomerTable();
          updateCodesTable();
          updateDashboard();

          // Hide progress indicators
          if (progressDiv) progressDiv.classList.add('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');
          const locationsUploadProgressDivHide = document.getElementById('locationsUploadProgress');
          if (locationsUploadProgressDivHide) locationsUploadProgressDivHide.classList.add('hidden');

          // Show success message
          const totalProcessed = imported + updated;

          // Re-enable button
          if (importButton) {
            importButton.disabled = false;
            importButton.textContent = originalText;
          }

          // Close modal first
          hideImportCustomerDataModal();

          // Show completion alert
          alert('Import is all done');
        } catch (error) {

          alert('Error importing Excel file: ' + error.message);

          // Hide progress indicators on error
          const progressDiv = document.getElementById('importProgress');
          const uploadProgressDiv = document.getElementById('uploadProgress');
          if (progressDiv) progressDiv.classList.add('hidden');
          if (uploadProgressDiv) uploadProgressDiv.classList.add('hidden');

          // Re-enable button on error
          if (importButton) {
            importButton.disabled = false;
            importButton.textContent = originalText;
          }
        }
      };

      try {
        reader.readAsArrayBuffer(file);
      } catch (error) {

        alert('Error reading file: ' + error.message);
        if (importButton) {
          importButton.disabled = false;
          importButton.textContent = originalText;
        }
      }
    };

    // Show payment details modal
    window.showPaymentDetailsModal = function() {
      const selectedCustomerId = document.getElementById('paymentCustomerSelect').value;
      const customer = customers.find(c => c.id === selectedCustomerId);

      if (customer) {
        // Calculate amounts (same logic as in showCustomerPaymentInfo)
        const baseServiceCost = calculateProratedServiceCost(customer);
        const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
        const adjustedServiceCost = baseServiceCost * factor;
        const lateFeeAmount = customer.pastDue > 0 ? lateFee : 0;
        const totalAmount = adjustedServiceCost + lateFeeAmount;

        // Populate the modal
        document.getElementById('paymentDetailsCustomer').textContent = customer.name;
        document.getElementById('paymentDetailsService').textContent = `$${adjustedServiceCost.toFixed(2)}`;
        document.getElementById('paymentDetailsLateFee').textContent = `$${lateFeeAmount.toFixed(2)}`;
        document.getElementById('paymentDetailsTotal').textContent = `$${totalAmount.toFixed(2)}`;

        // Show the modal
        document.getElementById('paymentDetailsModal').classList.remove('hidden');
      }
    };

    // Hide payment details modal
    window.hidePaymentDetailsModal = function() {
      document.getElementById('paymentDetailsModal').classList.add('hidden');
    };

    // Edit location
    window.editLocation = function(locationId) {
      const location = locations.find(l => l.id === locationId);
      if (location) {
        const newAddress = prompt('Enter new address:', location.address);
        const newType = prompt('Enter property type:', location.propertyType);

        if (newAddress && newType) {
          location.address = newAddress;
          location.propertyType = newType;
          updateLocationsTable();
          alert('Location updated successfully!');
        }
      }
    };

    // Delete location
    window.deleteLocation = async function(locationId) {
      if (confirm('Are you sure you want to delete this location?')) {
        locations = locations.filter(l => l.id !== locationId);
        filteredLocations = [...locations];
        updateLocationsTable();
        updateSettingsLocationsTable(); // Update settings table as well
        await saveLocationsToFirestore();
        alert('Location deleted successfully!');
      }
    };

    // Inline editing functionality
    window.editField = function(locationId, fieldType, currentValue) {
      const location = locations.find(l => l.id === locationId);
      const customer = customers.find(c => c.id === locationId);
      if (!location && !customer) return;

      // Set up the edit modal
      document.getElementById('editFieldType').textContent = fieldType.charAt(0).toUpperCase() + fieldType.slice(1);
      document.getElementById('editFieldLocationId').value = locationId;
      document.getElementById('editFieldFieldType').value = fieldType;

      // Check if this is a status field that should use a dropdown
      const container = document.getElementById('editFieldInputContainer');
      if (fieldType === 'paymentStatus') {
        // Create dropdown for payment status
        container.innerHTML = `
          <select 
            id="editFieldValue" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="current" ${currentValue === 'current' ? 'selected' : ''}>Current</option>
            <option value="overdue" ${currentValue === 'overdue' ? 'selected' : ''}>Overdue</option>
            <option value="inactive" ${currentValue === 'inactive' ? 'selected' : ''}>Inactive</option>
            <option value="pending closing" ${currentValue === 'pending closing' ? 'selected' : ''}>Pending Closing</option>
          </select>
        `;
      } else {
        // Use regular input for other fields
        container.innerHTML = `
          <input 
            id="editFieldValue" 
            type="text" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Enter new value"
            value="${currentValue}"
            required
          />
        `;
      }

      // Show the modal
      document.getElementById('editFieldModal').classList.remove('hidden');
    };

    // Save field edit
    window.saveFieldEdit = async function() {
      const locationId = document.getElementById('editFieldLocationId').value;
      const fieldType = document.getElementById('editFieldFieldType').value;
      const newValue = document.getElementById('editFieldValue').value.trim();

      if (!newValue) {
        alert('Please enter a value');
        return;
      }

      // Check if this is a customer or location field
      const customer = customers.find(c => c.id === locationId);
      const location = locations.find(l => l.id === locationId);

      if (customer) {
        // Update customer field
        if (fieldType === 'accountNumber') {
          customer.accountNumber = newValue;
        } else if (fieldType === 'name') {
          customer.name = newValue;
        } else if (fieldType === 'email') {
          customer.email = newValue;
        } else if (fieldType === 'phone') {
          customer.phone = newValue;
        } else if (fieldType === 'address') {
          customer.address = newValue;
        } else if (fieldType === 'paymentStatus') {
          customer.paymentStatus = newValue;
          // Note: Status will be automatically updated based on pastDue amount
        } else if (fieldType === 'dueDate') {
          customer.dueDate = newValue;
        } else if (fieldType === 'lastPayment') {
          customer.lastPayment = newValue;
        } else if (fieldType === 'factor') {
          // Validate factor is a valid number
          const factorValue = parseFloat(newValue);
          if (isNaN(factorValue) || factorValue < 0) {
            alert('Please enter a valid factor (must be a positive number)');
            return;
          }
          customer.factor = newValue;
        } else if (fieldType === 'pastDue') {
          // Validate pastDue is a valid number
          const pastDueValue = parseFloat(newValue);
          if (isNaN(pastDueValue) || pastDueValue < 0) {
            alert('Please enter a valid past due amount (must be a positive number)');
            return;
          }
          customer.pastDue = pastDueValue;
          // Update payment status based on past due amount
          updateCustomerPaymentStatus(customer);
        }

        // Update filtered customers
        const filteredIndex = filteredCustomers.findIndex(c => c.id === locationId);
        if (filteredIndex !== -1) {
          filteredCustomers[filteredIndex] = customer;
        }

        // Refresh customer table
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Refresh Customer Information modal if it's open for this customer
        const customerFullInfoModal = document.getElementById('customerFullInfoModal');
        if (!customerFullInfoModal.classList.contains('hidden')) {
          // Check if the modal is showing this customer
          const content = document.getElementById('customerFullInfoContent');
          if (content && content.innerHTML.includes(customer.id)) {
            showCustomerFullInfo(locationId);
          }
        }

        // Refresh Amount Breakdown modal if it's open for this customer
        const amountDetailsModal = document.getElementById('amountDetailsModal');
        if (!amountDetailsModal.classList.contains('hidden')) {
          // Check if the modal is showing this customer
          const customerName = document.getElementById('amountDetailsCustomer');
          if (customerName && customerName.textContent === customer.name) {
            showAmountDetails(locationId);
          }
        }

        // Save to Firestore
        await saveCustomersToFirestore();
      } else if (location) {
        // Update location field
        if (fieldType === 'address') {
          location.address = newValue;
        } else if (fieldType === 'ownerFullName') {
          location.ownerFullName = newValue;
          // Split the name into first and last name
          const nameParts = newValue.split(' ');
          location.ownerFirstName = nameParts[0] || '';
          location.ownerLastName = nameParts.slice(1).join(' ') || '';
        } else if (fieldType === 'currentResident') {
          location.currentResident = newValue === 'Available' ? null : newValue;
          location.status = newValue === 'Available' ? 'available' : 'occupied';
        } else if (fieldType === 'status') {
          location.status = newValue;
        }

        // Update filtered locations
        const filteredIndex = filteredLocations.findIndex(l => l.id === locationId);
        if (filteredIndex !== -1) {
          filteredLocations[filteredIndex] = location;
        }

        // Refresh locations table
        updateLocationsTable();

        // Save to Firestore
        await saveLocationsToFirestore();
      }

      // Hide the modal
      document.getElementById('editFieldModal').classList.add('hidden');
    };

    // Cancel field edit
    window.cancelFieldEdit = function() {
      document.getElementById('editFieldModal').classList.add('hidden');
    };

    // Customer field editing functionality
    window.editCustomerField = function(customerId, fieldType, currentValue) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      // Set up the edit modal
      document.getElementById('editFieldType').textContent = fieldType.charAt(0).toUpperCase() + fieldType.slice(1);
      document.getElementById('editFieldValue').value = currentValue;
      document.getElementById('editFieldLocationId').value = customerId;
      document.getElementById('editFieldFieldType').value = fieldType;

      // Show the modal
      document.getElementById('editFieldModal').classList.remove('hidden');
    };

    // Show amount details modal
    window.showAmountDetails = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const baseServiceCost = calculateProratedServiceCost(customer);
      const pastDue = parseFloat(customer.pastDue || 0); // Previous unpaid balance
      const lateFeeAmount = pastDue > 0 ? lateFee : 0; // Late fee if there's past due
      
      // Apply factor FIRST to get adjusted service cost
      const factor = customer.factor ? parseFloat(customer.factor) : 1.0;
      const adjustedServiceCost = baseServiceCost * factor;

      // Calculate code surcharges (applied to adjusted service cost after factor)
      // IMPORTANT: Refresh customer codes from the global codes array to get latest amounts
      // Tax codes are affected by the factor
      let totalSurcharge = 0;
      const codesContainer = document.getElementById('amountDetailsCodesContainer');
      codesContainer.innerHTML = '';

      // Collect all codes with their amounts for sorting
      const codeRows = [];
      
      if (customer.codes && customer.codes.length > 0) {
        customer.codes.forEach(customerCode => {
          // Look up the latest code data from the global codes array
          // Try to find by ID first, then by name (case-insensitive)
          let latestCode = codes.find(c => c.id === customerCode.id);
          if (!latestCode) {
            latestCode = codes.find(c => c.name.toLowerCase() === customerCode.name.toLowerCase());
          }

          // Use the latest code data if found, otherwise fall back to customer code data
          const codeToUse = latestCode || customerCode;

          const codeType = codeToUse.type || 'percentage';
          const codeAmount = codeToUse.amount !== undefined ? codeToUse.amount : (codeToUse.percentage !== undefined ? codeToUse.percentage : 0);
          
          // Calculate base surcharge amount (before factor)
          let baseSurchargeAmount;
          if (codeType === 'flat') {
            baseSurchargeAmount = codeAmount;
          } else {
            baseSurchargeAmount = adjustedServiceCost * (codeAmount / 100);
          }
          
          // Apply factor to the surcharge amount
          const surchargeAmount = baseSurchargeAmount * factor;
          totalSurcharge += surchargeAmount;

          // Build display text with factor if factor is not 1.0
          let displayText;
          if (factor !== 1.0) {
            if (codeType === 'flat') {
              displayText = `${codeToUse.name} ($${parseFloat(codeAmount).toFixed(2)} x ${factor})`;
            } else {
              // Show full calculation: percentage% x factor x adjustedServiceCost
              displayText = `${codeToUse.name} (${parseFloat(codeAmount).toFixed(2)}% x ${factor} x ${adjustedServiceCost.toFixed(2)})`;
            }
          } else {
            if (codeType === 'flat') {
              displayText = `${codeToUse.name} ($${parseFloat(codeAmount).toFixed(2)})`;
            } else {
              displayText = `${codeToUse.name} (${parseFloat(codeAmount).toFixed(2)}%)`;
            }
          }
          
          codeRows.push({
            name: codeToUse.name,
            displayText: displayText,
            surchargeAmount: surchargeAmount
          });
        });
      }

      // Sort codes alphabetically by name
      codeRows.sort((a, b) => a.name.localeCompare(b.name));

      // Add sorted codes to container
      codeRows.forEach(codeRow => {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600';
        row.innerHTML = `
          <span class="text-slate-600 dark:text-slate-400">${codeRow.displayText}</span>
          <span class="font-medium">$${codeRow.surchargeAmount.toFixed(2)}</span>
        `;
        codesContainer.appendChild(row);
      });

      // Calculate subtotal: adjusted service cost + tax codes (both affected by factor)
      const subtotalBeforePuc = adjustedServiceCost + totalSurcharge;

      // PUC Surcharge is applied to the subtotal (NOT affected by factor)
      // PUC Surcharge container (displayed after tax codes, before Past Due)
      const pucSurchargeContainer = document.getElementById('amountDetailsPucSurchargeContainer');
      let pucSurchargeAmount = 0;
      if (pucSurchargeContainer) {
        pucSurchargeContainer.innerHTML = '';
        if (pucSurcharge > 0) {
          // PUC Surcharge is applied to subtotal (sewage service + tax codes), NOT affected by factor
          pucSurchargeAmount = subtotalBeforePuc * (pucSurcharge / 100);
          const pucRow = document.createElement('div');
          pucRow.className = 'flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600';
          
          // Display: "PUC SCHG SW (1.00% x [subtotal])"
          const pucDisplayText = `PUC SCHG SW (${pucSurcharge.toFixed(2)}% x $${subtotalBeforePuc.toFixed(2)})`;
          
          pucRow.innerHTML = `
            <span class="text-slate-600 dark:text-slate-400">${pucDisplayText}</span>
            <span class="font-medium">$${pucSurchargeAmount.toFixed(2)}</span>
          `;
          pucSurchargeContainer.appendChild(pucRow);
        }
      }

      // Calculate current due (everything except past due)
      const currentDue = subtotalBeforePuc + pucSurchargeAmount + lateFeeAmount;
      
      // Calculate total - PUC surcharge is NOT affected by factor, applied to subtotal
      const total = pastDue + currentDue;

      // Calculate due date as last day of current month
      const now = new Date();
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const dueDateStr = (lastDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getDate().toString().padStart(2, '0') + '/' + 
                        lastDayOfMonth.getFullYear();

      // Calculate billing cycle (month after due date)
      const billingCycleStart = new Date(lastDayOfMonth.getFullYear(), lastDayOfMonth.getMonth() + 1, 1);
      const billingCycleEnd = new Date(billingCycleStart.getFullYear(), billingCycleStart.getMonth() + 1, 0);

      const formatShortDate = (date) => {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const year = date.getFullYear().toString().slice(-2);
        return `${month}/${day}/${year}`;
      };

      const billingCycleStr = `${formatShortDate(billingCycleStart)} to ${formatShortDate(billingCycleEnd)}`;

      // Hide factor container since it's now shown inline with service cost
      const factorContainer = document.getElementById('amountDetailsFactorContainer');
      if (factorContainer) {
        factorContainer.innerHTML = ''; // Clear it since factor is now shown inline
        factorContainer.style.display = 'none'; // Hide it
      }

      document.getElementById('amountDetailsCustomer').textContent = customer.name;
      
      // Display factor if it's not 1.0
      const factorRow = document.getElementById('amountDetailsFactorRow');
      const factorElement = document.getElementById('amountDetailsFactor');
      if (factorRow && factorElement) {
        if (factor !== 1.0) {
          factorRow.style.display = 'flex';
          factorElement.textContent = factor.toFixed(1);
        } else {
          factorRow.style.display = 'none';
        }
      }
      
      // Show service cost with factor calculation inline
      const serviceRow = document.getElementById('amountDetailsServiceRow');
      if (serviceRow) {
        if (factor !== 1.0) {
          // Show: "Sewage Service (168.36 x 2) $336.72"
          serviceRow.innerHTML = `
            <span class="text-slate-600 dark:text-slate-400">Sewage Service (${baseServiceCost.toFixed(2)} x ${factor})</span>
            <span class="font-medium" id="amountDetailsService">$${adjustedServiceCost.toFixed(2)}</span>
          `;
        } else {
          // Show: "Sewage Service $168.36" (no factor)
          serviceRow.innerHTML = `
            <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
            <span class="font-medium" id="amountDetailsService">$${adjustedServiceCost.toFixed(2)}</span>
          `;
        }
      } else {
        // Fallback if row not found
        const serviceElement = document.getElementById('amountDetailsService');
        if (serviceElement) {
          serviceElement.textContent = `$${adjustedServiceCost.toFixed(2)}`;
        }
      }
      const pastDueElement = document.getElementById('amountDetailsPastDue');
      pastDueElement.textContent = `$${pastDue.toFixed(2)}`;
      pastDueElement.setAttribute('data-customer-id', customerId);
      pastDueElement.setAttribute('data-past-due', pastDue.toFixed(2));
      
      // Display current due
      const currentDueElement = document.getElementById('amountDetailsCurrentDue');
      if (currentDueElement) {
        currentDueElement.textContent = `$${currentDue.toFixed(2)}`;
      }
      
      // Show/hide Late Fee based on amount
      const lateFeeRow = document.getElementById('amountDetailsLateFeeRow');
      const lateFeeElement = document.getElementById('amountDetailsLateFee');
      if (lateFeeRow && lateFeeElement) {
        if (lateFeeAmount > 0) {
          lateFeeRow.style.display = 'flex';
          lateFeeElement.textContent = `$${lateFeeAmount.toFixed(2)}`;
        } else {
          lateFeeRow.style.display = 'none';
        }
      }
      document.getElementById('amountDetailsTotal').textContent = `$${total.toFixed(2)}`;
      document.getElementById('amountDetailsDueDate').textContent = dueDateStr;
      document.getElementById('amountDetailsBillingCycle').textContent = billingCycleStr;
      document.getElementById('amountDetailsLastPayment').textContent = formatDate(customer.lastPayment);

      document.getElementById('amountDetailsModal').classList.remove('hidden');
    };

    // Hide amount details modal
    window.hideAmountDetails = function() {
      document.getElementById('amountDetailsModal').classList.add('hidden');
    };

    // Edit past due from amount details modal
    window.editPastDueFromModal = function() {
      const pastDueElement = document.getElementById('amountDetailsPastDue');
      const customerId = pastDueElement.getAttribute('data-customer-id');
      const currentPastDue = pastDueElement.getAttribute('data-past-due') || '0.00';

      // Remove $ sign and parse
      const numericValue = currentPastDue.replace('$', '');
      editCustomerField(customerId, 'pastDue', numericValue);
    };

    // Show customer full info modal
    window.showCustomerFullInfo = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const content = document.getElementById('customerFullInfoContent');
      content.innerHTML = `
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Personal Info</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.name || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.email || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.phone ? formatPhoneNumber(customer.phone) : 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.address || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cycle Number</label>
            <div class="flex items-center gap-2">
              <input 
                type="number" 
                id="customerCycleNumberInput_${customer.id}" 
                value="${customer.cycleNumber || ''}" 
                min="1"
                max="10"
                class="flex-1 px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter cycle number (1-10)"
              />
              <button 
                onclick="saveCustomerCycleNumber('${customer.id}')" 
                class="bg-blue-600 text-white px-4 py-3 rounded-xl hover:bg-blue-700 transition-colors font-medium"
              >
                Save
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.entityType || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.ssn || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.idType || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.idNumber || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.secondaryContactName || 'N/A'}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
              ${customer.secondaryContactPhone ? formatPhoneNumber(customer.secondaryContactPhone) : 'N/A'}
            </div>
          </div>
          </div>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-600 my-6"></div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingStreet || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingCity || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingState || 'N/A'}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${customer.mailingZip || 'N/A'}
              </div>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-600 my-6"></div>

        <div class="mt-6">
          <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor & Codes</h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <div class="flex items-center gap-2">
                <input 
                  type="number" 
                  id="customerFactorInput_${customer.id}" 
                  value="${customer.factor || '1'}" 
                  step="0.01" 
                  min="0"
                  class="flex-1 px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="1.00"
                />
                <button 
                  onclick="saveCustomerFactor('${customer.id}')" 
                  class="bg-blue-600 text-white px-4 py-3 rounded-xl hover:bg-blue-700 transition-colors font-medium"
                >
                  Save
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tax Codes</label>
              <div class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                ${(() => {
                  const codesList = [];
                  if (pucSurcharge > 0) {
                    codesList.push(`PUC SCHG SW (${pucSurcharge.toFixed(2)}%)`);
                  }
                  if (customer.codes && customer.codes.length > 0) {
                    customer.codes.forEach(code => {
                      const codeType = code.type || 'percentage';
                      const codeAmount = code.amount !== undefined ? code.amount : (code.percentage !== undefined ? code.percentage : 0);
                      codesList.push(codeType === 'flat' 
                        ? `${code.name} ($${parseFloat(codeAmount).toFixed(2)})` 
                        : `${code.name} (${parseFloat(codeAmount).toFixed(2)}%)`);
                    });
                  }
                  return codesList.length > 0 ? codesList.join(', ') : 'N/A';
                })()}
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('customerFullInfoModal').classList.remove('hidden');
    };

    // Hide customer full info modal
    window.hideCustomerFullInfo = function() {
      document.getElementById('customerFullInfoModal').classList.add('hidden');
    };

    // Save customer factor (only saves that one customer)
    window.saveCustomerFactor = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      const input = document.getElementById(`customerFactorInput_${customerId}`);
      if (!input) {
        alert('Factor input not found');
        return;
      }

      const newFactor = parseFloat(input.value);
      
      if (isNaN(newFactor) || newFactor < 0) {
        alert('Please enter a valid factor (must be 0 or greater)');
        input.value = customer.factor || '1';
        return;
      }

      try {
        // Update the customer's factor
        customer.factor = newFactor;

        // Save only this customer to Firestore
        const customersRef = collection(db, 'customers');
        const customerRef = doc(customersRef, customerId);
        await setDoc(customerRef, customer);

        // Update the UI
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Show success message
        const button = input.nextElementSibling;
        const originalText = button.textContent;
        button.textContent = 'Saved!';
        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        button.classList.add('bg-green-600');
        
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('bg-green-600');
          button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);

      } catch (error) {
        console.error('[SAVE CUSTOMER FACTOR] Error:', error);
        alert('Error saving factor: ' + error.message);
        // Revert input value on error
        input.value = customer.factor || '1';
      }
    };

    // Save customer cycle number (only saves that one customer)
    window.saveCustomerCycleNumber = async function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      const input = document.getElementById(`customerCycleNumberInput_${customerId}`);
      if (!input) {
        alert('Cycle number input not found');
        return;
      }

      const newCycleNumber = input.value.trim();
      
      // Allow empty value (null) or valid number between 1 and 10
      let cycleNumberValue = null;
      if (newCycleNumber !== '') {
        const parsed = parseInt(newCycleNumber);
        if (isNaN(parsed) || parsed < 1 || parsed > 10) {
          alert('Please enter a valid cycle number (must be between 1 and 10)');
          input.value = customer.cycleNumber || '';
          return;
        }
        cycleNumberValue = String(parsed);
      }

      try {
        // Update the customer's cycle number
        customer.cycleNumber = cycleNumberValue;

        // Save only this customer to Firestore
        const customersRef = collection(db, 'customers');
        const customerRef = doc(customersRef, customerId);
        await setDoc(customerRef, customer);

        // Update the UI
        updateCustomerTable();
        updateSettingsCustomerTable();

        // Show success message
        const button = input.nextElementSibling;
        const originalText = button.textContent;
        button.textContent = 'Saved!';
        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        button.classList.add('bg-green-600');
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('bg-green-600');
          button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);
      } catch (error) {
        console.error('[SAVE CUSTOMER CYCLE NUMBER] Error:', error);
        alert('Error saving cycle number: ' + error.message);
        // Revert input value on error
        input.value = customer.cycleNumber || '';
      }
    };

    // Show customer data profile modal (Excel preview)
    window.showCustomerDataProfile = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      // Check if customer has importData
      if (!customer.importData) {
        alert('No imported data available for this customer. Please import customer data first.');
        return;
      }

      const modalContent = document.getElementById('customerDataProfileContent');
      const headers = Object.keys(customer.importData);

      // Build Excel-like table
      let tableHTML = `
        <div class="overflow-x-auto border border-slate-300 dark:border-slate-600 rounded-lg">
          <table class="min-w-full text-sm border-collapse">
            <thead>
              <tr class="bg-slate-100 dark:bg-slate-700">
      `;

      // Add header row
      headers.forEach(header => {
        tableHTML += `<th class="px-4 py-2 text-left border border-slate-300 dark:border-slate-600 font-semibold text-slate-700 dark:text-slate-300 whitespace-nowrap">${header || ''}</th>`;
      });

      tableHTML += `
              </tr>
            </thead>
            <tbody>
              <tr class="bg-white dark:bg-slate-800">
      `;

      // Helper function to convert Excel serial date to readable date string
      const excelSerialToDate = (serial) => {
        if (typeof serial === 'number' && serial > 0 && serial < 1000000) {
          const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899 (Excel's epoch)
          const date = new Date(excelEpoch.getTime() + (serial - 1) * 24 * 60 * 60 * 1000);
          if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            return `${month}/${day}/${year}`;
          }
        }
        return serial;
      };

      // Add data row
      headers.forEach(header => {
        let value = customer.importData[header];
        // Check if it's a date field and value is a number (Excel serial date)
        const headerLower = String(header || '').toLowerCase();
        if ((headerLower.includes('date') || headerLower.includes('billdate')) && typeof value === 'number') {
          value = excelSerialToDate(value);
        }
        tableHTML += `<td class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-400">${value || ''}</td>`;
      });

      tableHTML += `
              </tr>
            </tbody>
          </table>
        </div>
      `;

      modalContent.innerHTML = tableHTML;
      const modal = document.getElementById('customerDataProfileModal');
      modal.setAttribute('data-customer-id', customerId);
      modal.classList.remove('hidden');
    };

    // Hide customer data profile modal
    window.hideCustomerDataProfile = function() {
      document.getElementById('customerDataProfileModal').classList.add('hidden');
    };

    // Copy full data profile to clipboard
    window.copyFullDataProfile = function() {
      const customerId = document.getElementById('customerDataProfileModal').getAttribute('data-customer-id');
      const customer = customers.find(c => c.id === customerId);

      if (!customer || !customer.importData) {
        alert('No data available to copy');
        return;
      }

      // Build a readable text format of all the data
      let textToCopy = 'Customer Data Profile (Excel Preview)\n\n';

      const headers = Object.keys(customer.importData);

      // Add header row
      textToCopy += headers.join('\t') + '\n';

      // Add data row
      const values = headers.map(header => customer.importData[header] || '');
      textToCopy += values.join('\t') + '\n';

      // Copy to clipboard
      navigator.clipboard.writeText(textToCopy).then(() => {
        alert('Full data profile copied to clipboard!');
      }).catch(err => {

        // Fallback: select text and show message
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          alert('Full data profile copied to clipboard!');
        } catch (err) {
          alert('Failed to copy. Please select and copy manually.');
        }
        document.body.removeChild(textArea);
      });
    };

    // Show payment modal
    window.showPaymentModal = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const currentAmount = customer.currentBill + customer.pastDue;
      document.getElementById('paymentCustomerName').textContent = customer.name;
      document.getElementById('paymentCurrentAmount').textContent = `$${currentAmount.toFixed(2)}`;
      document.getElementById('paymentAmount').value = '';
      document.getElementById('paymentAmount').max = currentAmount;
      document.getElementById('paymentCustomerId').value = customerId;

      document.getElementById('paymentModal').classList.remove('hidden');
    };

    // Hide payment modal
    window.hidePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };

    // Process payment
    window.processPayment = async function() {
      const customerId = document.getElementById('paymentCustomerId').value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);

      if (!paymentAmount || paymentAmount <= 0) {
        alert('Please enter a valid payment amount');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const currentAmount = customer.currentBill + customer.pastDue;
      if (paymentAmount > currentAmount) {
        alert(`Payment amount cannot exceed current balance of $${currentAmount.toFixed(2)}`);
        return;
      }

      // Record payment in history
      const today = new Date();
      const paymentDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                         today.getDate().toString().padStart(2, '0') + '/' + 
                         today.getFullYear();

      const paymentRecord = {
        date: paymentDate,
        amountDue: currentAmount,
        amountPaid: paymentAmount,
        remainingBalance: currentAmount - paymentAmount
      };

      customer.paymentHistory.push(paymentRecord);

      // Update customer balance
      if (paymentAmount >= customer.currentBill) {
        const remaining = paymentAmount - customer.currentBill;
        customer.currentBill = 0;
        customer.pastDue = Math.max(0, customer.pastDue - remaining);
      } else {
        customer.currentBill -= paymentAmount;
      }

      // Update last payment date
      customer.lastPayment = paymentDate;

      // If customer was pending closing and now has no balance, mark as inactive
      if (customer.paymentStatus === 'pending closing' && customer.pastDue === 0 && customer.currentBill === 0) {
        customer.paymentStatus = 'inactive';
      } else {
        // Update payment status based on past due amount
        updateCustomerPaymentStatus(customer);
      }

      // Save to Firestore
      await saveCustomersToFirestore();

      // Update display
      updateDashboard();
      hidePaymentModal();

      alert(`Payment of $${paymentAmount.toFixed(2)} recorded successfully!`);
    };

    // Show payment history
    window.showPaymentHistory = function(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      document.getElementById('historyCustomerName').textContent = customer.name;

      const historyBody = document.getElementById('paymentHistoryBody');
      historyBody.innerHTML = '';

      // Check if paymentHistory exists and has items
      if (!customer.paymentHistory || customer.paymentHistory.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 dark:text-slate-400 py-4">No payment history available</td></tr>';
      } else {
        customer.paymentHistory.forEach(payment => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">${payment.date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.amountDue.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.amountPaid.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">$${payment.remainingBalance.toFixed(2)}</td>
          `;
          historyBody.appendChild(row);
        });
      }

      document.getElementById('paymentHistoryModal').classList.remove('hidden');
    };

    // Hide payment history modal
    window.hidePaymentHistory = function() {
      document.getElementById('paymentHistoryModal').classList.add('hidden');
    };

    // Keyboard shortcut to switch to client page
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey) {
        event.preventDefault();
        window.location.href = 'billing.html';
      }
    });
  </script>
  <style>
    :root { color-scheme: light dark; }
    body { background: radial-gradient(1200px 800px at 30% -10%, #e6f0ff 0%, #ffffff 45%) no-repeat; }
    @media (prefers-color-scheme: dark) {
      body { background: radial-gradient(1200px 800px at 30% -10%, #0b1220 0%, #0e1628 45%) no-repeat; }
    }
    .card { backdrop-filter: saturate(1.2) blur(8px); }
    .modal-show { display: flex !important; }
    .safe-pad { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .tap { -webkit-tap-highlight-color: transparent; }

  </style>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 tap">
  <!-- Firebase Auth Modal -->
  <div id="firebaseAuthModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Admin Authentication</h2>
      <p class="text-slate-600 dark:text-slate-400 mb-6">Please enter your admin credentials to continue</p>
      
      <form id="firebaseAuthForm" class="space-y-4">
        <div>
          <label for="firebaseEmail" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
          <input 
            type="email" 
            id="firebaseEmail" 
            required
            autocomplete="email"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
            placeholder="admin@cus.com"
          >
        </div>
        
        <div>
          <label for="firebasePassword" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Password</label>
          <input 
            type="password" 
            id="firebasePassword" 
            required
            autocomplete="current-password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
            placeholder="Enter password"
          >
        </div>
        
        <div id="firebaseAuthError" class="text-red-600 dark:text-red-400 text-sm hidden"></div>
        
        <button 
          type="submit" 
          id="firebaseAuthSubmit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors"
        >
          Sign In
        </button>
      </form>
    </div>
  </div>

  <div class="mx-auto max-w-7xl px-4 pt-6 pb-24 safe-pad">

    <!-- Dashboard Screen -->
    <div id="dashboardScreen">
      <!-- Header -->
      <header class="mb-8">
        <div class="text-center">
          <br><br>
          <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200">CUS Admin Dashboard</h1>
          <p class="text-slate-600 dark:text-slate-400">Manage customer accounts and billing</p>
        </div>
      </header>

      <!-- Action Modules -->
      <div id="actionModules" class="mb-8">
        <!-- Payment Module -->
        <div id="paymentModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Payment</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
              <select id="paymentCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Choose a customer...</option>
              </select>
            </div>

            <div id="customerPaymentInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                  <p id="paymentAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                  <button id="viewDetailsBtn" onclick="showPaymentDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                    View Details
                  </button>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                  <p id="paymentPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                  <p id="paymentLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                  <p id="paymentPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                  <p id="paymentDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                  <span id="paymentStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be populated by JavaScript -->
                  </span>
                </div>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Type</label>
                <select 
                  id="paymentType" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                >
                  <option value="">Select Payment Type</option>
                  <option value="Check">Check</option>
                  <option value="Cash">Cash</option>
                </select>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
                <input 
                  type="number" 
                  id="paymentAmount" 
                  step="0.01" 
                  min="0" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter payment amount"
                >
              </div>

              <button 
                onclick="processPaymentFromModule()" 
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Process Payment
              </button>
            </div>
          </div>
        </div>

        <!-- Bill Module -->
        <div id="billModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Process Bill</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Customer</label>
              <select id="billCustomerSelect" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <option value="">Choose a customer...</option>
              </select>
            </div>

            <div id="customerBillInfo" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Current Amount Due</p>
                  <p id="billAmountDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                  <button id="viewBillDetailsBtn" onclick="showBillDetailsModal()" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs mt-1">
                    View Details
                  </button>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Past Due</p>
                  <p id="billPastDue" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Late Fee</p>
                  <p id="billLateFee" class="text-lg font-semibold text-slate-800 dark:text-slate-200">$0.00</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Property Location</p>
                  <p id="billPropertyLocation" class="text-sm font-medium text-slate-800 dark:text-slate-200">--</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Due Date</p>
                  <p id="billDueDate" class="text-lg font-semibold text-slate-800 dark:text-slate-200">--/--/----</p>
                </div>
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Account Status</p>
                  <span id="billStatusIndicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be populated by JavaScript -->
                  </span>
                </div>
              </div>

              <!-- Bill Preview -->
              <div id="billPreview" class="mb-4 p-4 bg-white dark:bg-slate-600 rounded-lg border-2 border-slate-300 dark:border-slate-500">
                <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-3">Bill Preview</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Service Cost:</span>
                    <span id="previewServiceCost" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Late Fee:</span>
                    <span id="previewLateFee" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Surcharges:</span>
                    <span id="previewSurcharges" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-600 dark:text-slate-400">Factor Adjustment:</span>
                    <span id="previewFactorAdjustment" class="font-medium text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                  <div class="flex justify-between pt-2 border-t border-slate-300 dark:border-slate-500">
                    <span class="font-semibold text-slate-800 dark:text-slate-200">Total Amount:</span>
                    <span id="previewTotalAmount" class="font-bold text-lg text-slate-800 dark:text-slate-200">$0.00</span>
                  </div>
                </div>
              </div>

              <button 
                onclick="produceBill()" 
                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Produce Bill
              </button>

              <!-- PDF Display Container -->
              <div id="billPdfDisplay" class="hidden mt-4">
                <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Generated Bill PDF</h4>
                <iframe id="billPdfViewer" class="w-full border-2 border-slate-300 dark:border-slate-600 rounded-lg" style="height: 600px;" title="Bill PDF Preview"></iframe>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Client Module -->
        <div id="addClientModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Client</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Account Info</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
              <input 
                type="text" 
                id="newClientName" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter full name"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
              <input 
                type="email" 
                id="newClientEmail" 
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter email address"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
              <input 
                type="tel" 
                id="newClientPhone" 
                oninput="formatPhoneInput(this)"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="(xxx)-xxx-xxxx"
                required
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
              <select id="newClientLocation" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200" required>
                <option value="">Choose a location...</option>
                <option value="add-new">+ Add New Location</option>
              </select>
            </div>
            </div>
          </div>

          <!-- Identification Info Section -->
          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Identification Info</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
                <input 
                  type="text" 
                  id="newClientSSN" 
                  oninput="formatSSNInput(this)"
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="xxx-xx-xxxx"
                  maxlength="11"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
                <select id="newClientIDType" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">Select ID Type</option>
                  <option value="Drivers License">Drivers License</option>
                  <option value="ID">ID</option>
                  <option value="Passport">Passport</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
                <input 
                  type="text" 
                  id="newClientIDNumber" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter ID number"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
                <input 
                  type="text" 
                  id="newClientSecondaryContactName" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter secondary contact name"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
                <input 
                  type="tel" 
                  id="newClientSecondaryContactPhone" 
                  oninput="formatPhoneInput(this)"
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="(xxx)-xxx-xxxx"
                >
              </div>
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
                <input 
                  type="text" 
                  id="newClientMailingStreet" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter street address"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
                <input 
                  type="text" 
                  id="newClientMailingCity" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter city"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
                <select id="newClientMailingState" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">Select State</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                <input 
                  type="text" 
                  id="newClientMailingZip" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter ZIP code"
                  maxlength="10"
                >
              </div>
            </div>
          </div>

            <div class="mt-6">
              <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
              <div id="newClientCodesList" class="space-y-2">
                <!-- Selected codes will be displayed here -->
              </div>
            </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <input 
                type="number" 
                id="newClientFactor" 
                step="any"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter factor"
              >
            </div>
          </div>

          <div class="mt-6">
            <button 
              onclick="addClientFromModule()" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
            >
              Create Client Account
            </button>
          </div>
        </div>

        <!-- Search Module -->
        <div id="searchModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Search Accounts</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Search by Name</label>
                <input 
                  type="text" 
                  id="searchByName" 
                  class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                  placeholder="Enter customer name..."
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Filter by Status</label>
                <select id="searchByStatus" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                  <option value="">All Status</option>
                  <option value="current">Current</option>
                  <option value="overdue">Overdue</option>
                </select>
              </div>
            </div>

            <div class="flex space-x-4">
              <button 
                onclick="performSearch()" 
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Search
              </button>
              <button 
                onclick="clearSearch()" 
                class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
              >
                Clear
              </button>
            </div>

            <div id="searchResults" class="mt-6">
              <!-- Search results will be displayed here -->
            </div>
          </div>
        </div>

        <!-- Settings Module -->
        <div id="settingsModule" class="hidden card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 relative">
          <!-- Loading Overlay -->
          <div id="settingsLoadingOverlay" class="absolute inset-0 bg-white dark:bg-slate-800 bg-opacity-90 dark:bg-opacity-90 flex items-center justify-center z-50 rounded-3xl hidden">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p class="text-slate-700 dark:text-slate-300 font-medium">Loading settings data...</p>
            </div>
          </div>

          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Settings & Management</h3>
            <button onclick="hideAllModules()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex space-x-1 mb-6">
            <button 
              id="settingsAccountsTab"
              onclick="switchSettingsView('accounts')" 
              class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
            >
              Accounts
            </button>
            <button 
              id="settingsLocationsTab"
              onclick="switchSettingsView('locations')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Locations
            </button>
            <button 
              id="settingsCodesTab"
              onclick="switchSettingsView('codes')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Codes
            </button>
            <button 
              id="settingsUsersTab"
              onclick="switchSettingsView('users')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Users
            </button>
            <button 
              id="settingsCleanupTab"
              onclick="switchSettingsView('cleanup')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Data Cleanup
            </button>
            <button 
              id="settingsHierarchyTab"
              onclick="switchSettingsView('hierarchy')" 
              class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
            >
              Hierarchy
            </button>
          </div>

          <!-- Accounts Section -->
          <div id="settingsAccountsContent">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Customer Accounts</h4>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                  Showing <span id="settingsCustomerCountDisplay" class="font-semibold">0</span> of <span id="settingsCustomerTotalDisplay" class="font-semibold">0</span> customers
                </p>
              </div>
              <div class="flex flex-col gap-2">
                <button 
                  onclick="showAddCustomerModal()" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Add New Customer
                </button>
                <button 
                  onclick="showImportCustomerDataModal()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm"
                >
                  Import Customer Data
                </button>
                <button 
                  onclick="deleteAllUserData()" 
                  class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
                >
                  Delete User Data
                </button>
              </div>
            </div>

            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsCustomerSearch" 
                  type="text" 
                  placeholder="Search customers..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchCustomers()"
                />
              </div>
              <div>
                <select 
                  onchange="filterByStatus(this.value)" 
                  class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Status</option>
                  <option value="current">Current</option>
                  <option value="overdue">Overdue</option>
                  <option value="no-codes">No codes</option>
                  <option value="has-codes">Has codes</option>
                </select>
              </div>
            </div>

            <!-- Customer Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Account</th>
                    <th class="px-0 py-3 pr-0 -mr-4 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Customer</th>
                    <th class="px-0 py-3 pl-0 -ml-4 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Property</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Codes</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsCustomerTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Customer rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Locations Section -->
          <div id="settingsLocationsContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Property Locations</h4>
              <div class="flex gap-3">
                <button 
                  onclick="showAddLocationModal()" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Add Location
                </button>
                <button 
                  onclick="showImportModal()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                >
                  Import Locations
                </button>
              </div>
            </div>

            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsLocationSearch" 
                  type="text" 
                  placeholder="Search locations..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchLocations()"
                />
              </div>
              <div>
                <select 
                  onchange="filterLocationsByStatus(this.value)" 
                  class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Status</option>
                  <option value="occupied">Occupied</option>
                  <option value="available">Available</option>
                </select>
              </div>
            </div>

            <!-- Locations Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Premise ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Owner & Resident</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsLocationsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Location rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Codes Section -->
          <div id="settingsCodesContent" class="hidden">
            <!-- Sewer Charge Setting -->
            <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Sewer Charge</h4>
                  <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Set the default sewer service charge amount</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Amount ($)</label>
                  <input 
                    type="number" 
                    id="sewerChargeInput" 
                    min="0" 
                    step="0.01"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="170.00"
                  />
                </div>
                <div class="flex items-end">
                  <button 
                    onclick="saveSewerCharge()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Save
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <p class="text-xs text-slate-500 dark:text-slate-400" id="sewerChargeStatus"></p>
              </div>
            </div>

            <!-- Late Fee Setting -->
            <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Late Fee</h4>
                  <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Set the default late fee charge amount</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Amount ($)</label>
                  <input 
                    type="number" 
                    id="lateFeeInput" 
                    min="0" 
                    step="0.01"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="20.00"
                  />
                </div>
                <div class="flex items-end">
                  <button 
                    onclick="saveLateFee()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Save
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <p class="text-xs text-slate-500 dark:text-slate-400" id="lateFeeStatus"></p>
              </div>
            </div>

            <!-- PUC Surcharge Setting -->
            <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200">PUC Surcharge</h4>
                  <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Set the PUC surcharge percentage (applied to all customers)</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Percentage (%)</label>
                  <input 
                    type="number" 
                    id="pucSurchargeInput" 
                    min="0" 
                    max="100"
                    step="0.01"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0.00"
                  />
                </div>
                <div class="flex items-end">
                  <button 
                    onclick="savePucSurcharge()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Save
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <p class="text-xs text-slate-500 dark:text-slate-400" id="pucSurchargeStatus"></p>
              </div>
            </div>

            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">Tax Codes</h4>
              <button 
                onclick="showAddCodeModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add Code
              </button>
            </div>

            <!-- Codes Table -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Code Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Requirements</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsCodesTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- Code rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Users Section -->
          <div id="settingsUsersContent" class="hidden">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-bold text-slate-800 dark:text-slate-200">System Users</h4>
              <button 
                onclick="showAddUserModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add User
              </button>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <div class="flex-1">
                <input 
                  id="settingsUserSearch" 
                  type="text" 
                  placeholder="Search users..." 
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onkeyup="searchUsers()"
                />
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Full Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="settingsUsersTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                  <!-- User rows populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Data Cleanup Section -->
          <div id="settingsCleanupContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-2">Data Cleanup</h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">
                Tools to clean up and fix data issues in customer records
              </p>
            </div>

            <div class="space-y-4">
              <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-700">
                <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Data Synchronization</h3>
                <p class="text-sm text-blue-600 dark:text-blue-300 mb-4">
                  Re-sync past due amounts from imported Excel data
                </p>
                <button 
                  onclick="syncPastDueFromImportData()" 
                  class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium"
                  title="Re-sync past due amounts from imported Excel data"
                >
                  Sync Past Due Amounts
                </button>
              </div>

              <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-200 dark:border-orange-700">
                <h3 class="font-semibold text-orange-800 dark:text-orange-200 mb-2">Date Fixes</h3>
                <p class="text-sm text-orange-600 dark:text-orange-300 mb-4">
                  Fix Excel serial dates that appear as numbers (like 46053) in customer data
                </p>
                <div class="flex flex-col gap-3">
                  <button 
                    onclick="fixBillDates()" 
                    class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors font-medium"
                    title="Fix Bill Date column in all customer records"
                  >
                    Fix Dates
                  </button>
                  <button 
                    onclick="fixExcelDates()" 
                    class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors font-medium"
                    title="Fix all Excel serial dates (like 46053) in customer importData"
                  >
                    Fix All Excel Dates
                  </button>
                </div>
              </div>

              <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-200 dark:border-green-700">
                <h3 class="font-semibold text-green-800 dark:text-green-200 mb-2">Cycle Number Assignment</h3>
                <p class="text-sm text-green-600 dark:text-green-300 mb-4">
                  Split all accounts evenly across cycles 1-10 (for testing purposes)
                </p>
                <button 
                  onclick="splitAccountsByCycle()" 
                  class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium"
                  title="Split all accounts evenly across cycles 1-10"
                >
                  Split Accounts by Cycle
                </button>
              </div>
            </div>
          </div>

          <!-- Hierarchy Section -->
          <div id="settingsHierarchyContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-2">Payment Application Hierarchy</h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">
                Define the order in which partial payments are applied to different charges. Drag items to reorder.
              </p>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-700 mb-6">
              <p class="text-sm text-blue-600 dark:text-blue-300">
                <strong>How it works:</strong> When a customer makes a partial payment, the payment will be applied in the order shown below. For example, if the order is "Past Due, Late Fee, Tax Codes, PUC Surcharge, Current Due", the payment will first go towards Past Due, then Late Fee, and so on.
              </p>
            </div>

            <div id="hierarchyList" class="space-y-3 mb-6">
              <!-- Hierarchy items will be populated dynamically -->
            </div>

            <div class="flex justify-end gap-3">
              <button 
                onclick="saveHierarchyOrder()" 
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                Save Order
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Action Buttons -->
      <br><br>
      <div class="flex flex-col items-center gap-4 mb-8 p-8 max-w-2xl mx-auto bg-white dark:bg-slate-800 rounded-3xl border border-blue-100 dark:border-slate-700 shadow-md hover:shadow-2xl hover:scale-[1.02] focus-within:shadow-2xl focus-within:scale-[1.02] transition-all duration-300 ease-out cursor-default">
        <button 
          onclick="showAddClientModule()" 
          class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
          </svg>
          <span class="text-base">Add Client</span>
        </button>

        <button 
          onclick="showPaymentModule()" 
          class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <span class="text-4xl font-black leading-none">$</span>
          <span class="text-base">Make Payment</span>
        </button>

        <button 
          onclick="showBillModule()" 
          class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <span class="text-base">Send Bill</span>
        </button>

        <button 
          onclick="showSearchModule()" 
          class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span class="text-base">Search Database</span>
        </button>

        <button 
          onclick="showSettingsModule()" 
          class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 px-12 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-4"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span class="text-base">Settings</span>
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex space-x-1 mb-6 hidden">
        <button 
          id="accountsTab"
          onclick="switchView('accounts')" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
        >
          Accounts
        </button>
        <button 
          id="locationsTab"
          onclick="switchView('locations')" 
          class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium"
        >
          Locations
        </button>
      </div>

      <!-- Accounts Section -->
      <div id="accountsContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Accounts</h2>
          <div class="flex flex-col gap-2">
            <button 
              onclick="showAddCustomerModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add New Customer
            </button>
            <button 
              onclick="showImportCustomerDataModal()" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm"
            >
              Import Customer Data
            </button>
                <button 
                  onclick="syncPastDueFromImportData()" 
                  class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm"
                  title="Re-sync past due amounts from imported Excel data"
                >
                  Sync Past Due Amounts
                </button>
                <button 
                  onclick="fixBillDates()" 
                  class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm"
                  title="Fix Bill Date column in all customer records"
                >
                  Fix Dates
                </button>
                <button 
                  onclick="fixExcelDates()" 
                  class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors text-sm"
                  title="Fix all Excel serial dates (like 46053) in customer importData"
                >
                  Fix All Excel Dates
                </button>
                <button 
                  onclick="deleteAllUserData()"
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
            >
              Delete User Data
            </button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <input 
              id="customerSearch" 
              type="text" 
              placeholder="Search customers..." 
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeyup="searchCustomers()"
            />
          </div>
          <div>
            <select 
              onchange="filterByStatus(this.value)" 
              class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="current">Current</option>
              <option value="overdue">Overdue</option>
              <option value="no-codes">No codes</option>
              <option value="has-codes">Has codes</option>
            </select>
          </div>
        </div>

        <!-- Customer Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Account</th>
                <th class="px-0 py-3 pr-0 -mr-2 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Customer</th>
                <th class="px-0 py-3 pl-0 -ml-2 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider max-w-[180px]">Property</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Due Date</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Last Payment</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="customerTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Customer rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Locations Section -->
      <div id="locationsContent" class="card rounded-3xl bg-white dark:bg-slate-800 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Property Locations</h2>
          <div class="flex gap-3">
            <button 
              onclick="showAddLocationModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add Location
            </button>
            <button 
              onclick="showImportModal()" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
            >
              Import Locations
            </button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <input 
              id="locationSearch" 
              type="text" 
              placeholder="Search locations..." 
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeyup="searchLocations()"
            />
          </div>
          <div>
            <select 
              onchange="filterLocationsByStatus(this.value)" 
              class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="occupied">Occupied</option>
              <option value="available">Available</option>
            </select>
          </div>
        </div>

        <!-- Locations Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Premise ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Property</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Owner & Resident</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="locationsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Location rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Customer</h3>
          <button 
            onclick="hideAddCustomerModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addCustomerForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              id="newCustomerName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter customer's full name"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
            <input 
              id="newCustomerEmail" 
              type="email" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="customer@email.com"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
            <input 
              id="newCustomerPhone" 
              type="tel" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="(916) 555-0123"
              oninput="formatPhoneInput(this)"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Property Location</label>
            <select 
              id="newCustomerLocation" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">Select a property location</option>
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Entity Type</label>
            <select 
              id="newCustomerEntityType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select Entity Type</option>
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Farmer">Farmer</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Social Security Number</label>
            <input 
              id="newCustomerSSN" 
              type="text" 
              oninput="formatSSNInput(this)"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="xxx-xx-xxxx"
              maxlength="11"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Type</label>
            <select 
              id="newCustomerIDType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select ID Type</option>
              <option value="Drivers License">Drivers License</option>
              <option value="ID">ID</option>
              <option value="Passport">Passport</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ID Number</label>
            <input 
              id="newCustomerIDNumber" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter ID number"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Name</label>
            <input 
              id="newCustomerSecondaryContactName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter secondary contact name"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Secondary Contact Number</label>
            <input 
              id="newCustomerSecondaryContactPhone" 
              type="tel" 
              oninput="formatPhoneInput(this)"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="(xxx)-xxx-xxxx"
            />
          </div>

          <div class="mt-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Mailing Address</h4>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
                <input 
                  id="newCustomerMailingStreet" 
                  type="text" 
                  class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter street address"
                />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
                  <input 
                    id="newCustomerMailingCity" 
                    type="text" 
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter city"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
                  <select 
                    id="newCustomerMailingState" 
                    class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">Select State</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                <input 
                  id="newCustomerMailingZip" 
                  type="text" 
                  class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter ZIP code"
                  maxlength="10"
                />
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Tax Codes</h4>
            <div class="flex gap-2 mb-4">
              <select 
                id="newCustomerCodeSelect" 
                class="flex-1 px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select a code...</option>
              </select>
              <button 
                type="button"
                onclick="addCustomerCode()" 
                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors"
              >
                Add Code
              </button>
            </div>
            <div id="newCustomerCodesList" class="space-y-2">
              <!-- Selected codes will be displayed here -->
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Factor</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Factor</label>
              <input 
                type="number" 
                id="newCustomerFactor" 
                step="any"
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
                placeholder="Enter factor"
              >
            </div>
          </div>

          <div class="mt-6">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Cycle Number</h4>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cycle Number</label>
              <input 
              type="number" 
              id="newCustomerCycleNumber" 
              min="1"
              max="10"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200"
              placeholder="Enter cycle number (1-10)"
              >
            </div>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Note:</strong> The customer will be able to log in using their email address and the temporary password "password".
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddCustomerModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addCustomer()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Customer
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Location Modal -->
    <div id="addLocationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Location</h3>
          <button 
            onclick="hideAddLocationModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addLocationForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Premise ID</label>
            <input 
              id="newLocationPremiseId" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-600 text-slate-800 dark:text-slate-200"
              readonly
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Street Address</label>
            <input 
              id="newLocationStreet" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="123 Main Street"
              required
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">City</label>
              <input 
                id="newLocationCity" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Sacramento"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">State</label>
              <input 
                id="newLocationState" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="CA"
                required
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
            <input 
              id="newLocationZip" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="95814"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddLocationModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addLocation()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Location
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add System User</h3>
          <button 
            onclick="hideAddUserModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form class="space-y-4" onsubmit="event.preventDefault(); addUser();">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
            <input 
              id="newUserFullName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter full name"
              required
            />
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              Users are stored in the users collection in Firestore using their full name.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddUserModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="submit"
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add User
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Record Payment</h3>
          <button 
            onclick="hidePaymentModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="paymentCustomerName"></span></h4>
            <p class="text-sm text-blue-800 dark:text-blue-200">Current Balance: <span id="paymentCurrentAmount" class="font-bold"></span></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount</label>
            <input 
              id="paymentAmount" 
              type="number" 
              step="0.01"
              min="0.01"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter payment amount"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hidePaymentModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="processPayment()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Record Payment
            </button>
          </div>
        </div>

        <!-- Hidden input for tracking -->
        <input type="hidden" id="paymentCustomerId" />
      </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-4xl w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment History - <span id="historyCustomerName"></span></h3>
          <button 
            onclick="hidePaymentHistory()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Due</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Amount Paid</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Remaining Balance</th>
              </tr>
            </thead>
            <tbody id="paymentHistoryBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Payment history rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <div class="mt-6">
          <button 
            type="button"
            onclick="hidePaymentHistory()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Amount Details Modal -->
    <div id="amountDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAmountDetails()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Amount Breakdown</h3>
          <button 
            onclick="hideAmountDetails()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="amountDetailsCustomer"></span></h4>
            <div class="space-y-2 pt-2 border-t border-blue-200 dark:border-blue-700 mt-2">
              <div class="flex justify-between items-center" id="amountDetailsFactorRow" style="display: none;">
                <span class="text-sm text-blue-600 dark:text-blue-300">Factor</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsFactor">1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Due Date</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsDueDate">--/--/----</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Billing Cycle</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsBillingCycle">--/--/-- - --/--/--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-blue-600 dark:text-blue-300">Last Payment</span>
                <span class="text-sm font-medium text-blue-800 dark:text-blue-200" id="amountDetailsLastPayment">Never</span>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600" id="amountDetailsServiceRow">
              <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
              <span class="font-medium" id="amountDetailsService">$150.00</span>
            </div>
            <div id="amountDetailsFactorContainer"></div>
            <div id="amountDetailsCodesContainer"></div>
            <div id="amountDetailsPucSurchargeContainer"></div>
            <div style="height: 1rem;"></div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="font-bold text-slate-800 dark:text-slate-200">Current Due</span>
              <span class="font-bold text-slate-800 dark:text-slate-200" id="amountDetailsCurrentDue">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="font-bold text-slate-800 dark:text-slate-200">Past Due</span>
              <span class="font-bold text-slate-800 dark:text-slate-200 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 p-2 rounded" 
                    id="amountDetailsPastDue" 
                    ondblclick="editPastDueFromModal()"
                    title="Double-click to edit">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600" id="amountDetailsLateFeeRow" style="display: none;">
              <span class="text-slate-600 dark:text-slate-400">Late Fee</span>
              <span class="font-medium" id="amountDetailsLateFee">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-3 bg-slate-50 dark:bg-slate-700 rounded-lg px-4">
              <span class="font-semibold text-slate-800 dark:text-slate-200">Total Due</span>
              <span class="font-bold text-lg" id="amountDetailsTotal">$0.00</span>
            </div>
          </div>

          <button 
            type="button"
            onclick="hideAmountDetails()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Field Modal -->
    <div id="editFieldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Edit <span id="editFieldType">Field</span></h3>
          <button 
            onclick="cancelFieldEdit()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">New Value</label>
            <div id="editFieldInputContainer">
              <input 
                id="editFieldValue" 
                type="text" 
                class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter new value"
                required
              />
            </div>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Tip:</strong> For status, use "available" or "occupied". For residents, use "Available" to make the property available.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="cancelFieldEdit()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="saveFieldEdit()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Save Changes
            </button>
          </div>
        </div>

        <!-- Hidden inputs for tracking -->
        <input type="hidden" id="editFieldLocationId" />
        <input type="hidden" id="editFieldFieldType" />
      </div>
    </div>

    <!-- Import Locations Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Import Locations</h3>
          <button 
            onclick="hideImportModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select JSON File</label>
            <input 
              id="locationFileInput" 
              type="file" 
              accept=".json"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">
            <p class="text-sm text-green-800 dark:text-green-200">
              <strong>JSON Format:</strong> Your file should contain a "locations" array with objects having properties like id, address, propertyType, bedrooms, bathrooms, squareFootage.
            </p>
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Sample:</strong> You can use the provided locations.json file as a template.
            </p>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideImportModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="importLocations()" 
              class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200"
            >
              Import Locations
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Customer Data Modal -->
    <div id="importCustomerDataModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Import Customer Data</h3>
          <button 
            onclick="hideImportCustomerDataModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Excel File (ImportData.xlsx)</label>
            <input 
              id="customerDataFileInput" 
              type="file" 
              accept=".xlsx,.xls"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Note:</strong> All data from the Excel file will be imported and saved to Firebase. The first row should contain column headers. The system will match customers by account number if they already exist, or create new ones.
            </p>
          </div>

          <div id="importPreview" class="hidden">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Preview (first 5 rows)</h4>
            <div class="overflow-x-auto border border-slate-300 dark:border-slate-600 rounded-lg">
              <table id="previewTable" class="min-w-full text-sm">
                <thead class="bg-slate-100 dark:bg-slate-700">
                  <!-- Headers will be populated by JavaScript -->
                </thead>
                <tbody class="bg-white dark:bg-slate-800">
                  <!-- Rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Import Progress Indicator -->
          <div id="importProgress" class="hidden">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl border-2 border-blue-500 mb-4">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-blue-800 dark:text-blue-200">Importing Customer Data...</h4>
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
              </div>
              <div class="space-y-2">
                <div class="flex justify-between text-sm text-blue-700 dark:text-blue-300">
                  <span>Progress:</span>
                  <span id="progressText" class="font-semibold">0 / 0</span>
                </div>
                <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-3">
                  <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="text-xs text-blue-600 dark:text-blue-400 mt-2">
                  <span id="progressStats">Processing...</span>
                </div>
              </div>
            </div>

            <!-- Firestore Upload Progress Indicator -->
            <div id="uploadProgress" class="hidden">
              <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-xl border-2 border-green-500 mb-4">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-lg font-semibold text-green-800 dark:text-green-200">Uploading customers to database</h4>
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                </div>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm text-green-700 dark:text-green-300">
                    <span>Progress:</span>
                    <span id="uploadProgressText" class="font-semibold">0 / 0</span>
                  </div>
                  <div class="w-full bg-green-200 dark:bg-green-800 rounded-full h-3">
                    <div id="uploadProgressBar" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-green-600 dark:text-green-400 mt-2">
                    <span id="uploadProgressStats">Uploading...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Locations Upload Progress Indicator -->
            <div id="locationsUploadProgress" class="hidden">
              <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-xl border-2 border-purple-500">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-lg font-semibold text-purple-800 dark:text-purple-200">Uploading locations to database</h4>
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                </div>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm text-purple-700 dark:text-purple-300">
                    <span>Progress:</span>
                    <span id="locationsUploadProgressText" class="font-semibold">0 / 0</span>
                  </div>
                  <div class="w-full bg-purple-200 dark:bg-purple-800 rounded-full h-3">
                    <div id="locationsUploadProgressBar" class="bg-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-purple-600 dark:text-purple-400 mt-2">
                    <span id="locationsUploadProgressStats">Uploading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideImportCustomerDataModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="importCustomerData()" 
              class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200"
            >
              Import Customer Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="paymentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Payment Breakdown</h3>
          <button 
            onclick="hidePaymentDetailsModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Customer: <span id="paymentDetailsCustomer"></span></h4>
          </div>

          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Sewage Service</span>
              <span class="font-medium" id="paymentDetailsService">$150.00</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-600">
              <span class="text-slate-600 dark:text-slate-400">Late Fee</span>
              <span class="font-medium" id="paymentDetailsLateFee">$0.00</span>
            </div>
            <div class="flex justify-between items-center py-3 bg-slate-50 dark:bg-slate-700 rounded-lg px-4">
              <span class="font-semibold text-slate-800 dark:text-slate-200">Total Due</span>
              <span class="font-bold text-lg" id="paymentDetailsTotal">$0.00</span>
            </div>
          </div>

          <button 
            type="button"
            onclick="hidePaymentDetailsModal()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Transfer Ownership Modal -->
    <div id="transferOwnershipModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Transfer Property Ownership</h3>
          <button 
            onclick="hideTransferOwnershipModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl">
            <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2"> Location Already Occupied</h4>
            <p class="text-sm text-yellow-700 dark:text-yellow-300">
              This location is currently being used by <strong id="transferWarningName"></strong> at <strong id="transferLocation"></strong>.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl">
              <h5 class="font-semibold text-slate-800 dark:text-slate-200 mb-3">Current Resident</h5>
              <div class="space-y-2">
                <p><span class="text-slate-600 dark:text-slate-400">Name:</span> <span id="transferCurrentResident"></span></p>
                <p><span class="text-slate-600 dark:text-slate-400">Status:</span> <span id="transferCurrentStatus"></span></p>
                <p><span class="text-slate-600 dark:text-slate-400">Balance:</span> <span id="transferBalance"></span></p>
              </div>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
              <h5 class="font-semibold text-blue-800 dark:text-blue-200 mb-3">New Client</h5>
              <div class="space-y-2">
                <p><span class="text-blue-600 dark:text-blue-400">Name:</span> <span id="transferNewClient"></span></p>
                <p class="text-sm text-blue-600 dark:text-blue-400">Will be assigned to this location</p>
              </div>
            </div>
          </div>

          <div id="transferStatusMessage" class="p-4 rounded-xl">
            <!-- Status message will be populated by JavaScript -->
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              New Location for <span id="transferNewLocationLabel"></span>
            </label>
            <input 
              id="transferNewLocation" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter the new address where they're moving"
              required
            />
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideTransferOwnershipModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="processTransferOwnership()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Transfer Ownership
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Code Modal -->
    <div id="addCodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add New Code</h3>
          <button 
            onclick="hideAddCodeModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form id="addCodeForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Code Name</label>
            <input 
              id="newCodeName" 
              type="text" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter code name"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Type</label>
            <select 
              id="newCodeType" 
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onchange="updateCodeAmountInput()"
              required
            >
              <option value="percentage">Percentage</option>
              <option value="flat">Flat Rate</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Amount</label>
            <input 
              id="newCodeAmount" 
              type="number" 
              step="0.01"
              min="0"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter amount"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Description</label>
            <textarea 
              id="newCodeDescription" 
              rows="3"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter description"
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Requirements</label>
            <div id="newCodeRequirementsList" class="mb-2 space-y-2">
              <!-- Selected requirements will be displayed here -->
            </div>
            <button 
              type="button"
              onclick="showAddRequirementModal()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
            >
              Add requirement
            </button>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddCodeModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addCode()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add Code
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Code Field Modal -->
    <div id="editCodeFieldModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Edit <span id="editCodeFieldType">Field</span></h3>
          <button 
            onclick="cancelEditCodeField()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">New Value</label>
            <div id="editCodeFieldInputContainer">
              <!-- Input will be dynamically inserted here -->
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="cancelEditCodeField()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="saveEditCodeField()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Save Changes
            </button>
          </div>
        </div>

        <!-- Hidden inputs for tracking -->
        <input type="hidden" id="editCodeFieldCodeId" />
        <input type="hidden" id="editCodeFieldFieldType" />
      </div>
    </div>

    <!-- Add Requirement Modal -->
    <div id="addRequirementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAddRequirementModal()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add Requirement</h3>
          <button 
            onclick="hideAddRequirementModal()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-4">Select Requirements</label>
            <div class="space-y-3">
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="requirementBusiness" 
                  class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementBusiness" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  Business
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="requirementIndividual" 
                  class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementIndividual" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  Individual
                </label>
              </div>
            </div>
          </div>

          <div class="border-t border-slate-200 dark:border-slate-600 pt-4">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">Logic Type</label>
            <div class="space-y-2">
              <div class="flex items-center">
                <input 
                  type="radio" 
                  id="requirementLogicAND" 
                  name="requirementLogic"
                  value="AND"
                  checked
                  class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementLogicAND" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  AND (both must be selected)
                </label>
              </div>
              <div class="flex items-center">
                <input 
                  type="radio" 
                  id="requirementLogicOR" 
                  name="requirementLogic"
                  value="OR"
                  class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700"
                />
                <label for="requirementLogicOR" class="ml-3 text-sm text-slate-700 dark:text-slate-300">
                  OR (at least one must be selected)
                </label>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button 
              type="button"
              onclick="hideAddRequirementModal()" 
              class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button"
              onclick="addRequirement()" 
              class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Full Info Modal -->
    <div id="customerFullInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideCustomerFullInfo()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Information</h3>
          <button 
            onclick="hideCustomerFullInfo()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="customerFullInfoContent" class="space-y-4">
          <!-- Content will be populated by JavaScript -->
        </div>

        <div class="mt-6">
          <button 
            type="button"
            onclick="hideCustomerFullInfo()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Customer Data Profile Modal (Excel Preview) -->
    <div id="customerDataProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideCustomerDataProfile()">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Customer Data Profile (Excel Preview)</h3>
          <button 
            onclick="hideCustomerDataProfile()" 
            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="customerDataProfileContent" class="space-y-4">
          <!-- Excel-like table will be populated by JavaScript -->
        </div>

        <div class="mt-6 space-y-3">
          <button 
            type="button"
            onclick="copyFullDataProfile()" 
            class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-purple-700 transition-colors duration-200"
          >
            Copy Full Data Profile
          </button>
          <button 
            type="button"
            onclick="hideCustomerDataProfile()" 
            class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Customer Data Progress Modal -->
    <div id="deleteProgressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="card rounded-3xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5 dark:ring-white/10 p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Deleting Customer Data</h3>
        </div>

        <div id="deleteProgress" class="hidden">
          <div class="bg-red-50 dark:bg-red-900/20 p-6 rounded-xl border-2 border-red-500 mb-4">
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-lg font-semibold text-red-800 dark:text-red-200">Deleting Customers...</h4>
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
            </div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm text-red-700 dark:text-red-300">
                <span>Progress:</span>
                <span id="deleteProgressText" class="font-semibold">0 / 0</span>
              </div>
              <div class="w-full bg-red-200 dark:bg-red-800 rounded-full h-3">
                <div id="deleteProgressBar" class="bg-red-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <div class="text-xs text-red-600 dark:text-red-400 mt-2">
                <span id="deleteProgressStats">Deleting...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
